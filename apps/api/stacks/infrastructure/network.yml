# Infrastructure Stack: Network
# Deploys: VPC, Subnets, Internet Gateway, NAT Gateway, Route Tables
#
# This is the foundation stack - deploy first!
#
# Deploy:
#   pnpm serverless deploy --config stacks/infrastructure/network.yml --stage dev
#
# Dependencies: None
# Dependents: security, database, search, functions-*

service: lego-network

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  deploymentMethod: direct
  tags:
    Project: lego-api
    Environment: ${self:provider.stage}
    ManagedBy: Serverless
    Stack: network

custom:
  shared: ${file(../shared-config.yml)}
  stage: ${self:provider.stage}

resources:
  Description: LEGO API Network Infrastructure (VPC, Subnets, NAT Gateway)

  Resources:
    # VPC with /24 CIDR block (256 IP addresses)
    VPC:
      Type: AWS::EC2::VPC
      Properties:
        CidrBlock: ${self:custom.shared.vpc.cidrBlock}
        EnableDnsHostnames: true
        EnableDnsSupport: true
        Tags:
          - Key: Name
            Value: lego-api-vpc-${self:custom.stage}
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # Internet Gateway for public subnet internet access
    InternetGateway:
      Type: AWS::EC2::InternetGateway
      Properties:
        Tags:
          - Key: Name
            Value: lego-api-igw-${self:custom.stage}
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # Attach Internet Gateway to VPC
    InternetGatewayAttachment:
      Type: AWS::EC2::VPCGatewayAttachment
      Properties:
        InternetGatewayId: !Ref InternetGateway
        VpcId: !Ref VPC

    # ===========================================
    # Public Subnets (for NAT Gateway, ALB)
    # ===========================================

    # Public Subnet 1 - /27 (32 IPs) in AZ-a
    PublicSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: !Select [0, !GetAZs '']
        CidrBlock: ${self:custom.shared.vpc.publicSubnet1Cidr}
        MapPublicIpOnLaunch: true
        Tags:
          - Key: Name
            Value: lego-api-public-subnet-1-${self:custom.stage}
          - Key: SubnetType
            Value: PublicSubnet
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # Public Subnet 2 - /27 (32 IPs) in AZ-b
    PublicSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: !Select [1, !GetAZs '']
        CidrBlock: ${self:custom.shared.vpc.publicSubnet2Cidr}
        MapPublicIpOnLaunch: true
        Tags:
          - Key: Name
            Value: lego-api-public-subnet-2-${self:custom.stage}
          - Key: SubnetType
            Value: PublicSubnet
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # ===========================================
    # Private Subnets (for Lambda, RDS, OpenSearch)
    # ===========================================

    # Private Subnet 1 - /26 (64 IPs) in AZ-a
    PrivateSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: !Select [0, !GetAZs '']
        CidrBlock: ${self:custom.shared.vpc.privateSubnet1Cidr}
        MapPublicIpOnLaunch: false
        Tags:
          - Key: Name
            Value: lego-api-private-subnet-1-${self:custom.stage}
          - Key: SubnetType
            Value: PrivateSubnet
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # Private Subnet 2 - /26 (64 IPs) in AZ-b
    PrivateSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: !Select [1, !GetAZs '']
        CidrBlock: ${self:custom.shared.vpc.privateSubnet2Cidr}
        MapPublicIpOnLaunch: false
        Tags:
          - Key: Name
            Value: lego-api-private-subnet-2-${self:custom.stage}
          - Key: SubnetType
            Value: PrivateSubnet
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # ===========================================
    # NAT Gateway (single for cost optimization - $32/month)
    # ===========================================

    # Elastic IP for NAT Gateway
    NatEIP:
      Type: AWS::EC2::EIP
      DependsOn: InternetGatewayAttachment
      Properties:
        Domain: vpc
        Tags:
          - Key: Name
            Value: lego-api-nat-eip-${self:custom.stage}
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # NAT Gateway in Public Subnet 1
    NatGateway:
      Type: AWS::EC2::NatGateway
      Properties:
        AllocationId: !GetAtt NatEIP.AllocationId
        SubnetId: !Ref PublicSubnet1
        Tags:
          - Key: Name
            Value: lego-api-nat-gateway-${self:custom.stage}
          - Key: Purpose
            Value: InternetAccess
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # ===========================================
    # Route Tables
    # ===========================================

    # Public Route Table
    PublicRouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: lego-api-public-rt-${self:custom.stage}
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # Public Route to Internet Gateway
    PublicRoute:
      Type: AWS::EC2::Route
      DependsOn: InternetGatewayAttachment
      Properties:
        RouteTableId: !Ref PublicRouteTable
        DestinationCidrBlock: 0.0.0.0/0
        GatewayId: !Ref InternetGateway

    # Associate Public Subnet 1 with Public Route Table
    PublicSubnet1RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnet1

    # Associate Public Subnet 2 with Public Route Table
    PublicSubnet2RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnet2

    # Private Route Table
    PrivateRouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: lego-api-private-rt-${self:custom.stage}
          - Key: Project
            Value: lego-api
          - Key: Environment
            Value: ${self:custom.stage}

    # Private Route to NAT Gateway
    PrivateRoute:
      Type: AWS::EC2::Route
      Properties:
        RouteTableId: !Ref PrivateRouteTable
        DestinationCidrBlock: 0.0.0.0/0
        NatGatewayId: !Ref NatGateway

    # Associate Private Subnet 1 with Private Route Table
    PrivateSubnet1RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PrivateRouteTable
        SubnetId: !Ref PrivateSubnet1

    # Associate Private Subnet 2 with Private Route Table
    PrivateSubnet2RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PrivateRouteTable
        SubnetId: !Ref PrivateSubnet2

  Outputs:
    VpcId:
      Description: VPC ID
      Value: !Ref VPC
      Export:
        Name: lego-network-${self:custom.stage}-VpcId

    VpcCidrBlock:
      Description: VPC CIDR Block
      Value: !GetAtt VPC.CidrBlock
      Export:
        Name: lego-network-${self:custom.stage}-VpcCidrBlock

    PublicSubnet1Id:
      Description: Public Subnet 1 ID
      Value: !Ref PublicSubnet1
      Export:
        Name: lego-network-${self:custom.stage}-PublicSubnet1Id

    PublicSubnet2Id:
      Description: Public Subnet 2 ID
      Value: !Ref PublicSubnet2
      Export:
        Name: lego-network-${self:custom.stage}-PublicSubnet2Id

    PrivateSubnet1Id:
      Description: Private Subnet 1 ID
      Value: !Ref PrivateSubnet1
      Export:
        Name: lego-network-${self:custom.stage}-PrivateSubnet1Id

    PrivateSubnet2Id:
      Description: Private Subnet 2 ID
      Value: !Ref PrivateSubnet2
      Export:
        Name: lego-network-${self:custom.stage}-PrivateSubnet2Id

    InternetGatewayId:
      Description: Internet Gateway ID
      Value: !Ref InternetGateway
      Export:
        Name: lego-network-${self:custom.stage}-InternetGatewayId

    NatGatewayId:
      Description: NAT Gateway ID
      Value: !Ref NatGateway
      Export:
        Name: lego-network-${self:custom.stage}-NatGatewayId

    PublicRouteTableId:
      Description: Public Route Table ID
      Value: !Ref PublicRouteTable
      Export:
        Name: lego-network-${self:custom.stage}-PublicRouteTableId

    PrivateRouteTableId:
      Description: Private Route Table ID
      Value: !Ref PrivateRouteTable
      Export:
        Name: lego-network-${self:custom.stage}-PrivateRouteTableId
