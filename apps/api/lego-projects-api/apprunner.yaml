version: 1.0
runtime: nodejs20
build:
  commands:
    build:
      # Install pnpm globally
      - npm install -g pnpm@9
      # Install dependencies
      - pnpm install --frozen-lockfile
      # Build shared packages first
      - pnpm turbo build --filter="./packages/*"
      # Build the LEGO API
      - cd apps/api/lego-projects-api && npm run build
run:
  runtime-version: 20
  command: cd apps/api/lego-projects-api && npm start
  network:
    port: 3000
    env: PORT
  env:
    - name: NODE_ENV
      value: production
    - name: PORT
      value: "3000"
    - name: LOG_LEVEL
      value: "info"
    # Database configuration (PostgreSQL)
    - name: DATABASE_URL
      value: "postgresql://legouser:LegoPass123!@postgres-cluster-dev.cluster-cjyuq5qhkzpx.us-east-1.rds.amazonaws.com:5432/lego_projects"
    # Redis configuration
    - name: REDIS_HOST
      value: "redis-cluster-dev.cache.amazonaws.com"
    - name: REDIS_PORT
      value: "6379"
    # Elasticsearch configuration
    - name: ELASTICSEARCH_URL
      value: "https://search-elasticsearch-dev.us-east-1.es.amazonaws.com"
    # Auth service integration
    - name: AUTH_API
      value: "http://AuthSe-LoadB-UB7VYf7Vx7tO-1237477373.us-east-1.elb.amazonaws.com"
    - name: JWT_SECRET
      value: "your-super-secret-jwt-key-change-in-production"
    # File storage configuration
    - name: UPLOAD_DIR
      value: "/tmp/uploads"
    - name: MAX_FILE_SIZE
      value: "10485760"
    # AWS S3 configuration (for production file storage)
    - name: AWS_REGION
      value: "us-east-1"
    - name: S3_BUCKET
      value: "lego-moc-files-dev"
    # CORS configuration
    - name: CORS_ORIGINS
      value: "http://localhost:3002,https://yourdomain.com"
    # Rate limiting
    - name: RATE_LIMIT_WINDOW_MS
      value: "900000"
    - name: RATE_LIMIT_MAX_REQUESTS
      value: "100"
