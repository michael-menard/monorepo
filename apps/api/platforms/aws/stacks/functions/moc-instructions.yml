# Functions Stack: MOC Instructions
# Deploys: MOC instructions Lambda functions
#
# Deploy:
#   pnpm serverless deploy --config stacks/functions/moc-instructions.yml --stage dev
#
# Dependencies: network, security, database, search, storage, auth
# Dependents: monitoring

service: lego-api-moc

frameworkVersion: '3'

plugins:
  - serverless-esbuild
  - serverless-iam-roles-per-function

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: ${self:custom.stageConfig.memorySize}
  timeout: 29
  deploymentMethod: direct

  environment:
    STAGE: ${self:provider.stage}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    NODE_OPTIONS: '--enable-source-maps'
    LOG_LEVEL: ${self:custom.stageConfig.logLevel}
    # Database
    POSTGRES_HOST: ${cf:lego-database-${self:provider.stage}.ClusterEndpoint}
    POSTGRES_PORT: ${cf:lego-database-${self:provider.stage}.ClusterPort}
    POSTGRES_DATABASE: ${cf:lego-database-${self:provider.stage}.DatabaseName}
    DB_SECRET_ARN: ${cf:lego-database-${self:provider.stage}.SecretArn}
    # OpenSearch
    OPENSEARCH_ENDPOINT: ${cf:lego-search-${self:provider.stage}.EndpointUrl}
    # S3
    S3_BUCKET: ${cf:lego-storage-${self:provider.stage}.BucketName}
    # Cognito
    COGNITO_USER_POOL_ID: ${cf:lego-auth-${self:provider.stage}.UserPoolId}
    COGNITO_CLIENT_ID: ${cf:lego-auth-${self:provider.stage}.UserPoolClientId}

  vpc:
    securityGroupIds:
      - ${cf:lego-security-${self:provider.stage}.LambdaSecurityGroupId}
    subnetIds:
      - ${cf:lego-network-${self:provider.stage}.PrivateSubnet1Id}
      - ${cf:lego-network-${self:provider.stage}.PrivateSubnet2Id}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 'arn:aws:logs:${self:provider.region}:*:*'
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: '*'
        - Effect: Allow
          Action:
            - ec2:CreateNetworkInterface
            - ec2:DescribeNetworkInterfaces
            - ec2:DeleteNetworkInterface
            - ec2:AssignPrivateIpAddresses
            - ec2:UnassignPrivateIpAddresses
          Resource: '*'
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: ${cf:lego-database-${self:provider.stage}.SecretArn}
        - Effect: Allow
          Action:
            - es:ESHttpGet
            - es:ESHttpPost
            - es:ESHttpPut
            - es:ESHttpDelete
            - es:ESHttpHead
          Resource: !Sub '${cf:lego-search-${self:provider.stage}.DomainArn}/*'
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
            - s3:GetObjectTagging
            - s3:PutObjectTagging
          Resource:
            - ${cf:lego-storage-${self:provider.stage}.BucketArn}
            - !Sub '${cf:lego-storage-${self:provider.stage}.BucketArn}/*'

  httpApi:
    name: lego-api-moc-${self:provider.stage}
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:5173
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
        - X-Request-Id
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      allowCredentials: true
      maxAge: 86400
    authorizers:
      cognitoJwtAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: ${cf:lego-auth-${self:provider.stage}.IssuerUrl}
        audience:
          - ${cf:lego-auth-${self:provider.stage}.UserPoolClientId}

  tags:
    Project: lego-api
    Environment: ${self:provider.stage}
    ManagedBy: Serverless
    Stack: functions-moc

custom:
  shared: ${file(../shared-config.yml)}
  stage: ${self:provider.stage}
  stageConfig: ${self:custom.shared.stages.${self:custom.stage}, self:custom.shared.stages.dev}

  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    target: node20
    platform: node
    concurrency: 10
    exclude:
      - '@aws-sdk/*'
    plugins: ../../esbuild-plugins.js

package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!.git/**'
    - '!.sst/**'
    - '!.turbo/**'
    - '!docs/**'
    - '!**/*.test.ts'
    - '!**/*.spec.ts'
    - '!**/__tests__/**'
    - '!coverage/**'

functions:
  # List MOC instructions
  list:
    handler: ../../endpoints/moc-instructions/list/handler.handler
    description: List MOC instructions
    events:
      - httpApi:
          path: /api/mocs
          method: GET
          authorizer:
            name: cognitoJwtAuthorizer

  # Initialize MOC with files
  initializeWithFiles:
    handler: ../../endpoints/moc-instructions/initialize-with-files/handler.handler
    description: Initialize MOC instruction with files
    memorySize: 512
    events:
      - httpApi:
          path: /api/mocs
          method: POST
          authorizer:
            name: cognitoJwtAuthorizer

  # Finalize MOC with files
  finalizeWithFiles:
    handler: ../../endpoints/moc-instructions/finalize-with-files/handler.handler
    description: Finalize MOC instruction with files
    memorySize: 512
    events:
      - httpApi:
          path: /api/mocs/{id}/finalize
          method: POST
          authorizer:
            name: cognitoJwtAuthorizer

  # Upload file to MOC
  uploadFile:
    handler: ../../endpoints/moc-instructions/upload-file/handler.handler
    description: Upload file to MOC instruction
    memorySize: 512
    events:
      - httpApi:
          path: /api/mocs/{id}/files
          method: POST
          authorizer:
            name: cognitoJwtAuthorizer

  # Download file from MOC
  downloadFile:
    handler: ../../endpoints/moc-instructions/download-file/handler.handler
    description: Download file from MOC instruction
    events:
      - httpApi:
          path: /api/mocs/{mocId}/files/{fileId}/download
          method: GET
          authorizer:
            name: cognitoJwtAuthorizer

  # Delete file from MOC
  deleteFile:
    handler: ../../endpoints/moc-instructions/delete-file/handler.handler
    description: Delete file from MOC instruction
    events:
      - httpApi:
          path: /api/mocs/{id}/files/{fileId}
          method: DELETE
          authorizer:
            name: cognitoJwtAuthorizer

  # Get MOC stats
  getStats:
    handler: ../../endpoints/moc-instructions/get-stats/handler.handler
    description: Get MOC instruction stats
    events:
      - httpApi:
          path: /api/mocs/stats
          method: GET
          authorizer:
            name: cognitoJwtAuthorizer

  # Get uploads over time
  getUploadsOverTime:
    handler: ../../endpoints/moc-instructions/get-uploads-over-time/handler.handler
    description: Get MOC uploads over time
    events:
      - httpApi:
          path: /api/mocs/uploads-over-time
          method: GET
          authorizer:
            name: cognitoJwtAuthorizer

  # Get gallery images for MOC
  getGalleryImages:
    handler: ../../endpoints/moc-instructions/get-gallery-images/handler.handler
    description: Get gallery images for MOC
    events:
      - httpApi:
          path: /api/mocs/{id}/gallery-images
          method: GET
          authorizer:
            name: cognitoJwtAuthorizer

  # Link gallery image to MOC
  linkGalleryImage:
    handler: ../../endpoints/moc-instructions/link-gallery-image/handler.handler
    description: Link gallery image to MOC
    events:
      - httpApi:
          path: /api/mocs/{id}/gallery-images
          method: POST
          authorizer:
            name: cognitoJwtAuthorizer

  # Unlink gallery image from MOC
  unlinkGalleryImage:
    handler: ../../endpoints/moc-instructions/unlink-gallery-image/handler.handler
    description: Unlink gallery image from MOC
    events:
      - httpApi:
          path: /api/mocs/{id}/gallery-images/{imageId}
          method: DELETE
          authorizer:
            name: cognitoJwtAuthorizer

  # Upload parts list to MOC
  uploadPartsList:
    handler: ../../endpoints/moc-instructions/upload-parts-list/handler.handler
    description: Upload parts list to MOC
    memorySize: 512
    events:
      - httpApi:
          path: /api/mocs/{id}/parts-list
          method: POST
          authorizer:
            name: cognitoJwtAuthorizer

resources:
  Outputs:
    HttpApiUrl:
      Description: MOC Instructions API URL
      Value: !Sub 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
      Export:
        Name: lego-api-moc-${self:provider.stage}-ApiUrl

    HttpApiId:
      Description: MOC Instructions API Gateway ID
      Value: !Ref HttpApi
      Export:
        Name: lego-api-moc-${self:provider.stage}-ApiId
