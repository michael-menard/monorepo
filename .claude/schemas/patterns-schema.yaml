# PATTERNS-{month}.yaml Schema
# Output format for cross-story pattern mining
# Generated by: pattern-miner agent
# Consumer: Dev agents, human reviewers, calibration agent

---

## Core Structure

```yaml
schema: 1
generated_at: "{ISO timestamp}"
analysis_period:
  start: "{ISO date}"
  end: "{ISO date}"
  days: {N}
stories_analyzed: {N}
data_sources: [outcome, verification]  # Which files were analyzed

file_patterns: []
ac_patterns: []
agent_correlations: []
metadata: {}
```

---

## File Patterns Section

Detects correlation between specific file paths and review outcomes.

```yaml
file_patterns:
  - pattern: "{file path or glob pattern}"
    occurrences: {N}
    stories: ["{STORY_ID}", ...]

    correlation_metrics:
      lint_failures: {N}
      typecheck_failures: {N}
      security_issues: {N}
      build_failures: {N}
      correlation_score: {0.0-1.0}  # Probability this file triggers issues

    severity: high | medium | low

    recommendation: "{actionable improvement}"

    evidence:
      - story_id: "{STORY_ID}"
        failure_type: lint | typecheck | security | build
        description: "{specific issue}"
```

### Thresholds

- **Significance**: Pattern must appear in 3+ stories
- **Correlation**: correlation_score >= 0.60 to report
- **Severity**:
  - high: correlation_score >= 0.80
  - medium: correlation_score >= 0.60
  - low: correlation_score < 0.60 (excluded)

---

## AC Patterns Section

Detects vague or problematic phrasing in Acceptance Criteria.

```yaml
ac_patterns:
  - vague_phrase: "{phrase detected}"
    occurrences: {N}
    stories: ["{STORY_ID}", ...]

    impact_metrics:
      review_cycles_avg: {float}
      failure_rate: {0.0-1.0}

    severity: high | medium | low

    improved_phrasing: "{suggested alternative}"

    evidence:
      - story_id: "{STORY_ID}"
        ac_id: "{AC_ID}"
        original_text: "{AC text}"
        failure_type: "{description}"
```

### Vague Phrase Detection

Common patterns to detect:
- "properly", "correctly", "appropriate", "reasonable"
- "fast", "efficient", "optimized"
- "good", "bad", "better"
- "should work", "must handle"
- "etc.", "and so on"

### Thresholds

- **Significance**: Phrase must appear in 3+ stories
- **Impact**: failure_rate >= 0.40 or review_cycles_avg >= 2.5
- **Severity**:
  - high: failure_rate >= 0.60 or review_cycles_avg >= 3.0
  - medium: failure_rate >= 0.40 or review_cycles_avg >= 2.5
  - low: below medium thresholds (excluded)

---

## Agent Correlations Section

Detects patterns in agent behavior and inter-agent dependencies.

```yaml
agent_correlations:
  - correlation_type: coder_to_reviewer | phase_to_phase | ac_type_to_failure

    primary_agent: "{agent name or phase}"
    secondary_agent: "{agent name or phase}"

    occurrences: {N}
    stories: ["{STORY_ID}", ...]

    correlation_score: {0.0-1.0}
    severity: high | medium | low

    description: "{pattern description}"
    recommendation: "{actionable improvement}"

    evidence:
      - story_id: "{STORY_ID}"
        observation: "{specific finding}"
```

### Thresholds

- **Significance**: Pattern must appear in 3+ stories
- **Correlation**: correlation_score >= 0.60
- **Severity**:
  - high: correlation_score >= 0.80
  - medium: correlation_score >= 0.60
  - low: below 0.60 (excluded)

---

## Metadata Section

```yaml
metadata:
  min_sample_size: 3
  min_correlation: 0.60
  clustering_threshold: 0.70  # Text similarity threshold
  clustering_method: levenshtein  # MVP: text similarity

  warnings:
    - "{warning message}"

  data_quality:
    outcome_files: {N}
    verification_files: {N}
    fallback_mode: true | false

  processing:
    stories_skipped: {N}
    skip_reasons:
      - story_id: "{STORY_ID}"
        reason: "{reason}"
```

---

## Example

```yaml
schema: 1
generated_at: "2026-02-07T10:00:00Z"
analysis_period:
  start: "2026-01-08"
  end: "2026-02-07"
  days: 30
stories_analyzed: 15
data_sources: [verification]

file_patterns:
  - pattern: "apps/api/*/routes.ts"
    occurrences: 8
    stories: ["WISH-001", "WISH-003", "WISH-007", "WISH-010"]

    correlation_metrics:
      lint_failures: 6
      typecheck_failures: 2
      security_issues: 0
      build_failures: 0
      correlation_score: 0.75

    severity: medium

    recommendation: "Add lint pre-check to backend-coder for route handlers. Consider type annotation template for handler params."

    evidence:
      - story_id: "WISH-001"
        failure_type: lint
        description: "Missing type annotations on handler params"
      - story_id: "WISH-003"
        failure_type: typecheck
        description: "Implicit any on request object"

ac_patterns:
  - vague_phrase: "properly"
    occurrences: 5
    stories: ["WISH-002", "WISH-005", "WISH-009"]

    impact_metrics:
      review_cycles_avg: 2.8
      failure_rate: 0.60

    severity: medium

    improved_phrasing: "Replace 'properly' with specific criteria (e.g., 'validated with Zod schema', 'authenticated via JWT')"

    evidence:
      - story_id: "WISH-002"
        ac_id: "AC-3"
        original_text: "Request must be properly validated"
        failure_type: "Vague - no test criteria"

agent_correlations:
  - correlation_type: coder_to_reviewer
    primary_agent: "backend-coder"
    secondary_agent: "code-review-security"
    occurrences: 6
    stories: ["WISH-002", "WISH-004", "WISH-006"]
    correlation_score: 0.85
    severity: high
    description: "When backend-coder implements auth routes, security review finds issues 85% of time"
    recommendation: "Add security checklist to backend-coder agent for auth-related work"
    evidence:
      - story_id: "WISH-002"
        observation: "Missing input sanitization in auth handler"

metadata:
  min_sample_size: 3
  min_correlation: 0.60
  clustering_threshold: 0.70
  clustering_method: levenshtein
  warnings:
    - "OUTCOME.yaml unavailable - used VERIFICATION.yaml fallback"
  data_quality:
    outcome_files: 0
    verification_files: 37
    fallback_mode: true
  processing:
    stories_skipped: 2
    skip_reasons:
      - story_id: "WISH-999"
        reason: "No VERIFICATION.yaml or OUTCOME.yaml found"
```
