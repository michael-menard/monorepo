# Story 3.0.7: Gallery Pagination & Infinite Scroll

## Status

Done

## Story

**As a** user,
**I want** galleries to load more items as I scroll,
**so that** I can browse large collections smoothly without page reloads.

## Acceptance Criteria

1. ✅ GalleryPagination component for traditional pagination
2. ✅ useInfiniteScroll hook for scroll-based loading
3. ✅ Loading indicator when fetching more items
4. ✅ "Load More" button as fallback/alternative
5. ✅ Configurable page size (default: 20)
6. ✅ End of results indicator
7. ⬜ Scroll restoration on navigation back (deferred to routing integration)

## Tasks / Subtasks

- [x] **Task 1: useInfiniteScroll Hook**
  - [x] Create `src/hooks/useInfiniteScroll.ts`
  - [x] Use Intersection Observer API
  - [x] Return loading state and trigger ref

- [x] **Task 2: Load More Button**
  - [x] Create `src/components/GalleryLoadMore.tsx`
  - [x] Show when more items available
  - [x] Loading spinner state

- [x] **Task 3: Pagination Component**
  - [x] Create `src/components/GalleryPagination.tsx`
  - [x] Page numbers with ellipsis
  - [x] Previous/Next buttons
  - [x] Items per page selector

- [x] **Task 4: End State**
  - [x] Create end-of-results indicator
  - [x] Show total count if available

## Dev Notes

### useInfiniteScroll Hook

```typescript
interface UseInfiniteScrollOptions {
  hasMore: boolean
  isLoading: boolean
  onLoadMore: () => void
  threshold?: number  // pixels before bottom, default: 200
  enabled?: boolean   // default: true
}

interface UseInfiniteScrollReturn {
  sentinelRef: React.RefObject<HTMLDivElement>
  isNearBottom: boolean
}

function useInfiniteScroll(options: UseInfiniteScrollOptions): UseInfiniteScrollReturn {
  const sentinelRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    if (!options.enabled || options.isLoading || !options.hasMore) return

    const observer = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting) {
          options.onLoadMore()
        }
      },
      { rootMargin: `${options.threshold ?? 200}px` }
    )

    if (sentinelRef.current) {
      observer.observe(sentinelRef.current)
    }

    return () => observer.disconnect()
  }, [options])

  return { sentinelRef, isNearBottom: false }
}

// Usage
const { sentinelRef } = useInfiniteScroll({
  hasMore,
  isLoading,
  onLoadMore: () => fetchNextPage(),
})

return (
  <>
    <GalleryGrid>{items}</GalleryGrid>
    <div ref={sentinelRef} />
    {isLoading && <LoadingSpinner />}
  </>
)
```

### Pagination Component

```typescript
interface GalleryPaginationProps {
  currentPage: number
  totalPages: number
  onPageChange: (page: number) => void
  pageSize: number
  onPageSizeChange?: (size: number) => void
  pageSizeOptions?: number[]  // default: [10, 20, 50]
}

<GalleryPagination
  currentPage={page}
  totalPages={totalPages}
  onPageChange={setPage}
  pageSize={pageSize}
  onPageSizeChange={setPageSize}
/>
```

### RTK Query Integration

```typescript
// With RTK Query's infinite query pattern
const { data, fetchNextPage, hasNextPage, isFetchingNextPage } =
  useGetItemsInfiniteQuery({ search, tags, theme, sort })
```

## Testing

- [x] Unit test: useInfiniteScroll calls onLoadMore at threshold
- [x] Unit test: pagination shows correct page numbers
- [x] Unit test: load more button triggers fetch
- [x] Unit test: end state shows when no more items
- [x] Integration test: scroll triggers load

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

| File                                                                     | Action   |
| ------------------------------------------------------------------------ | -------- |
| packages/core/gallery/src/hooks/useInfiniteScroll.ts                     | Created  |
| packages/core/gallery/src/components/GalleryLoadMore.tsx                 | Created  |
| packages/core/gallery/src/components/GalleryPagination.tsx               | Created  |
| packages/core/gallery/src/components/GalleryEndOfResults.tsx             | Created  |
| packages/core/gallery/src/__tests__/GalleryPaginationInfiniteScroll.test.tsx | Created  |
| packages/core/gallery/src/index.ts                                       | Modified |

### Debug Log References

None

### Completion Notes

- useInfiniteScroll: Hook using Intersection Observer API with configurable threshold
- GalleryLoadMore: "Load More" button with loading spinner state
- GalleryPagination: Full pagination with page numbers, ellipsis, prev/next, and optional page size selector
- GalleryEndOfResults: End-of-results indicator with optional total count display
- All components follow controlled pattern
- 42 unit tests passing for pagination/infinite scroll (178 total in package)
- Build and lint verified
- Scroll restoration deferred to routing integration story

## Change Log

| Date       | Version | Description             | Author      |
| ---------- | ------- | ----------------------- | ----------- |
| 2025-11-30 | 0.1     | Initial draft           | SM Agent    |
| 2025-12-05 | 1.0     | Implementation complete | Dev (James) |
