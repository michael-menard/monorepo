# Story 3.1.5: Config and Validation Foundations

## Status

Done

## Story

**As a** backend developer,
**I want** upload limits and allowed formats to be defined via environment config and validated at startup,
**so that** size/type rules are consistent across presign/finalize and failures are caught early with clear diagnostics.

## Acceptance Criteria

1. Startup validation: API process validates upload-related env on boot; missing/invalid values cause fast-fail with a structured ERROR log and non-zero exit.
2. Env keys present (documented and enforced):
   - UPLOAD_PDF_MAX_MB, UPLOAD_IMAGE_MAX_MB, UPLOAD_IMAGE_MAX_COUNT,
   - UPLOAD_PARTSLIST_MAX_MB, UPLOAD_PARTSLIST_MAX_COUNT,
   - UPLOAD_ALLOWED_IMAGE_FORMATS (e.g., jpeg,png,webp,heic),
   - UPLOAD_ALLOWED_PARTS_FORMATS (e.g., txt,csv,json,xml),
   - UPLOAD_RATE_LIMIT_PER_DAY,
   - PRESIGN_TTL_MINUTES.
3. Zod-first env schema: strict numeric bounds (positive integers), list parsing (CSV → normalized lowercase array, trimmed), and derived bytes from MB. Validation error messages identify the offending key and reason.
4. Single source of truth: A typed config module exposes validated values for use by both presign and finalize handlers; file validation config (size/type) is wired to @repo/file-validator builders.
5. Observability: All successes at INFO, validation failures at WARN/ERROR, including correlationId/requestId (if present in request context) and ownerId when applicable; no PII beyond ownerId.
6. Unit tests (Vitest): happy path parse, invalid values (non-numeric, negative, zero), CSV normalization (case/whitespace), unknown format rejected, TTL boundaries, and that presign/finalize read the validated config.
7. Developer docs: Add/update a short section listing these env keys and defaults to the API README or env example file referenced by devs.

## Tasks / Subtasks

- [x] Create env config schema (AC: 1–4)
  - [x] Implement `apps/api/core/config/upload.ts` with Zod schema and parser
  - [x] Normalize CSV lists (lowercase, trim, dedupe)
  - [x] Convert MB → bytes and export typed fields
- [x] Startup validation hook (AC: 1,5)
  - [x] Initialize config during API bootstrap; on error: log structured ERROR and exit non-zero
  - [x] Ensure logger uses existing `createLogger` from `@/core/observability/logger`
- [x] Integrate with upload endpoints (AC: 4,5)
  - [x] Wire presign/finalize handlers to consume config (sizes, counts, formats, TTL)
  - [x] Pass allowed formats/limits into `@repo/file-validator` config builders
- [x] Unit tests (AC: 6)
  - [x] Tests for parser success/failure cases and normalization
  - [x] Tests that handlers access config (mock and assert)
- [x] Docs (AC: 2,7)
  - [x] Update `apps/api/README.md` with env keys and brief defaults/examples

## Dev Notes

- Relevant code paths (from repo):
  - Upload endpoints live under `apps/api/endpoints/moc-instructions/*`.
  - File validation currently uses `@repo/file-validator` via `_shared/moc-file-service.ts`.
  - Logging uses `@/core/observability/logger` (`createLogger`). Avoid console.
- Implementation guidance:
  - Keep config module pure and side-effect free except for a top-level `getUploadConfig()` that caches validated values.
  - Use Zod for schema: positive integers for sizes/counts/rate limits; refine TTL to a reasonable range (e.g., 1–60 minutes).
  - CSV parsing: split on comma, trim, lowercase, filter empty, dedupe; reject unknown entries with a precise error message.
  - Expose both MB and bytes where relevant; validators typically need bytes.
  - Ensure presign URL TTL uses `PRESIGN_TTL_MINUTES` and is consistent between presign and download as applicable.
- Observability:
  - Structured logs at INFO for success and WARN/ERROR for failures; include keys: `correlationId`, `requestId`, and `ownerId` when available.
  - Do not leak file names or raw tokens in errors.
- Source references:
  - docs/prd/upload-moc-instructions-prd.md (env keys; TTL assumption)
  - docs/architecture/api-design-and-integration.md#Integration-Guidelines (error handling/logging consistency)

### Testing

- Frameworks: Vitest for unit tests; target ≥45% global coverage remains; follow Testing Library patterns for any handler-level tests.
- Location: Co-locate tests under `apps/api/tests` or `apps/api/endpoints/**/__tests__` consistent with existing patterns.
- Scenarios to cover:
  - Valid env set parses into expected types/values
  - Missing/invalid keys produce specific Zod errors (key + reason)
  - CSV normalization: spaces, case, duplicates
  - TTL min/max boundaries enforced
  - Handlers obtain config once and use derived byte sizes in validator builders
  - Logger called with ERROR on startup failure (spy/assert)

## Change Log

| Date       | Version | Description                                                              | Author |
| ---------- | ------- | ------------------------------------------------------------------------ | ------ |
| 2025-12-06 | 0.1     | Initial draft created from PRD (3.1.5)                                   | SM     |
| 2025-12-06 | 1.0     | Implemented: config module, bootstrap, endpoint integration, tests, docs | AI     |
