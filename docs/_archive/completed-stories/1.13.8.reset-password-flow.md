# Story 1.13.8: Reset Password Flow

## Status

Ready for Review

## Story

**As a** user who received a password reset code,
**I want** to enter the code and set a new password,
**so that** I can regain access to my account with a new password.

## Acceptance Criteria

1. ✅ Reset password page at /reset-password route
2. ✅ Email input (pre-filled if passed from forgot password)
3. ✅ 6-digit code input using OTPInput component
4. ✅ New password input with validation
5. ✅ Confirm password input with match validation
6. ✅ Password strength indicator
7. ✅ Submit calls Amplify confirmResetPassword
8. ✅ Success message and redirect to login
9. ✅ Error handling for invalid/expired codes
10. ✅ Link to resend code (back to forgot password)
11. ✅ Accessible with ARIA labels
12. ✅ Unit tests (38 tests)

## Tasks / Subtasks

- [x] **Task 1: Page Setup** (AC: 1)
  - [x] Create ResetPasswordPage component
  - [x] Route at /reset-password
  - [x] Use AuthLayout wrapper
  - [x] Receive email from sessionStorage (set by ForgotPasswordPage)

- [x] **Task 2: Form Fields** (AC: 2, 3, 4, 5)
  - [x] Email input (editable, pre-filled from sessionStorage)
  - [x] OTPInput for 6-digit code
  - [x] New password input with show/hide toggle
  - [x] Confirm password input with show/hide toggle
  - [x] Zod validation schema with password match refinement

- [x] **Task 3: Password Validation** (AC: 6)
  - [x] Minimum 8 characters
  - [x] At least one uppercase letter
  - [x] At least one lowercase letter
  - [x] At least one number
  - [x] At least one special character
  - [x] Visual 5-segment strength indicator

- [x] **Task 4: Amplify Integration** (AC: 7)
  - [x] Call confirmResetPassword via AuthProvider
  - [x] Handle success response
  - [x] Clear sessionStorage on success

- [x] **Task 5: Success Flow** (AC: 8)
  - [x] Display success message with checkmark icon
  - [x] Show "Password Reset Complete!" confirmation
  - [x] Auto-redirect to login after 3 seconds
  - [x] "Go to Login Now" manual button

- [x] **Task 6: Error Handling** (AC: 9)
  - [x] Handle CodeMismatchException
  - [x] Handle ExpiredCodeException
  - [x] Handle InvalidPasswordException
  - [x] Handle LimitExceededException
  - [x] Display appropriate error messages in Alert component

- [x] **Task 7: Resend Code** (AC: 10)
  - [x] Inline resend button calling forgotPassword
  - [x] Success message for resend
  - [x] Link to forgot password page for new code request

- [x] **Task 8: Accessibility** (AC: 11)
  - [x] ARIA labels on all inputs
  - [x] aria-invalid on error state
  - [x] aria-describedby for error messages
  - [x] Live region for screen reader announcements
  - [x] role="alert" on error messages
  - [x] role="status" on success messages

- [x] **Task 9: Testing** (AC: 12)
  - [x] 38 unit tests covering all scenarios
  - [x] Tests for form validation (5 tests)
  - [x] Tests for password strength (2 tests)
  - [x] Tests for success flow (4 tests)
  - [x] Tests for error scenarios (4 tests)
  - [x] Tests for resend code (4 tests)
  - [x] Tests for password visibility toggle (2 tests)
  - [x] Tests for accessibility (5 tests)
  - [x] Tests for navigation tracking (4 tests)

## Dev Notes

### Amplify v6 Confirm Reset Password

```typescript
import { confirmResetPassword } from 'aws-amplify/auth'

async function handleResetPassword(email: string, code: string, newPassword: string) {
  try {
    await confirmResetPassword({
      username: email,
      confirmationCode: code,
      newPassword,
    })

    // Success - redirect to login
    navigate('/login', {
      state: { message: 'Password reset successful. Please sign in.' },
    })

    return { success: true }
  } catch (error) {
    if (error.name === 'CodeMismatchException') {
      return { success: false, error: 'Invalid verification code.' }
    }
    if (error.name === 'ExpiredCodeException') {
      return { success: false, error: 'Code has expired. Please request a new one.' }
    }
    if (error.name === 'InvalidPasswordException') {
      return { success: false, error: error.message }
    }
    throw error
  }
}
```

### Zod Validation Schema

```typescript
const resetPasswordSchema = z
  .object({
    email: z.string().email('Please enter a valid email address'),
    code: z.string().length(6, 'Code must be 6 digits'),
    newPassword: z
      .string()
      .min(8, 'Password must be at least 8 characters')
      .regex(/[A-Z]/, 'Password must contain an uppercase letter')
      .regex(/[a-z]/, 'Password must contain a lowercase letter')
      .regex(/[0-9]/, 'Password must contain a number')
      .regex(/[^A-Za-z0-9]/, 'Password must contain a special character'),
    confirmPassword: z.string(),
  })
  .refine(data => data.newPassword === data.confirmPassword, {
    message: 'Passwords do not match',
    path: ['confirmPassword'],
  })
```

### Password Strength Indicator

```typescript
function getPasswordStrength(password: string): {
  score: number  // 0-4
  label: string
  color: string
} {
  let score = 0

  if (password.length >= 8) score++
  if (password.length >= 12) score++
  if (/[A-Z]/.test(password) && /[a-z]/.test(password)) score++
  if (/[0-9]/.test(password)) score++
  if (/[^A-Za-z0-9]/.test(password)) score++

  const labels = ['Weak', 'Fair', 'Good', 'Strong', 'Very Strong']
  const colors = ['red', 'orange', 'yellow', 'lime', 'green']

  return {
    score: Math.min(score, 4),
    label: labels[Math.min(score, 4)],
    color: colors[Math.min(score, 4)],
  }
}

// Usage in component
function PasswordStrengthIndicator({ password }: { password: string }) {
  const strength = getPasswordStrength(password)

  return (
    <div className="space-y-1">
      <div className="flex gap-1">
        {[0, 1, 2, 3, 4].map(i => (
          <div
            key={i}
            className={cn(
              'h-1 flex-1 rounded',
              i <= strength.score ? `bg-${strength.color}-500` : 'bg-gray-200'
            )}
          />
        ))}
      </div>
      <p className="text-xs text-muted-foreground">
        Password strength: {strength.label}
      </p>
    </div>
  )
}
```

### Page Component Structure

```typescript
export function ResetPasswordPage() {
  const location = useLocation()
  const navigate = useNavigate()
  const prefillEmail = location.state?.email || ''

  const [isSuccess, setIsSuccess] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const form = useForm({
    resolver: zodResolver(resetPasswordSchema),
    defaultValues: {
      email: prefillEmail,
      code: '',
      newPassword: '',
      confirmPassword: '',
    },
  })

  const onSubmit = async (data) => {
    try {
      await confirmResetPassword({
        username: data.email,
        confirmationCode: data.code,
        newPassword: data.newPassword,
      })
      setIsSuccess(true)
      setTimeout(() => navigate('/login'), 3000)
    } catch (err) {
      setError(err.message)
    }
  }

  if (isSuccess) {
    return (
      <AuthLayout>
        <SuccessCard
          title="Password Reset Complete"
          message="Your password has been changed. Redirecting to login..."
        />
      </AuthLayout>
    )
  }

  return (
    <AuthLayout>
      <Card>
        <CardHeader>
          <CardTitle>Reset Your Password</CardTitle>
          <CardDescription>
            Enter the code from your email and choose a new password.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            {/* Email input */}
            {/* OTP code input */}
            {/* New password input */}
            {/* Password strength indicator */}
            {/* Confirm password input */}
            {/* Error message */}
            {/* Submit button */}
            {/* Resend code link */}
          </form>
        </CardContent>
      </Card>
    </AuthLayout>
  )
}
```

### Cognito Password Requirements

Default Cognito password policy:

- Minimum 8 characters
- At least 1 number
- At least 1 special character
- At least 1 uppercase letter
- At least 1 lowercase letter

These can be customized in the User Pool settings.

### Error Messages

| Amplify Error            | User Message                                           |
| ------------------------ | ------------------------------------------------------ |
| CodeMismatchException    | Invalid verification code. Please check and try again. |
| ExpiredCodeException     | This code has expired. Please request a new one.       |
| InvalidPasswordException | Password does not meet requirements: [details]         |
| LimitExceededException   | Too many attempts. Please try again later.             |

## Dependencies

- Story 1.13.1: OTP Input Component (Complete)
- Story 1.13.7: Forgot Password Flow (Precedes this)
- Story 1.14: Login Page (Redirect destination)

## QA Results

### Review Summary

| Attribute         | Value                      |
| ----------------- | -------------------------- |
| **Gate**          | PASS                       |
| **Quality Score** | 100/100                    |
| **Review Depth**  | DEEP (auth/security story) |
| **Reviewer**      | Quinn (Test Architect)     |
| **Review Date**   | 2025-11-29                 |

### Requirements Traceability

| AC  | Description                                             | Status  | Evidence                                                                                                        |
| --- | ------------------------------------------------------- | ------- | --------------------------------------------------------------------------------------------------------------- |
| 1   | Reset password page at /reset-password route            | ✅ PASS | ResetPasswordPage.tsx:119-651 with AuthLayout wrapper                                                           |
| 2   | Email input (pre-filled if passed from forgot password) | ✅ PASS | sessionStorage.getItem('pendingResetEmail') at lines 131-132; test: line 222-228                                |
| 3   | 6-digit code input using OTPInput component             | ✅ PASS | Controller + OTPInput at lines 413-426; tests: lines 249-271                                                    |
| 4   | New password input with validation                      | ✅ PASS | Zod schema lines 33-39 with uppercase/lowercase/number/special; tests: lines 274-348                            |
| 5   | Confirm password input with match validation            | ✅ PASS | Zod refine at lines 42-45; test: lines 299-322                                                                  |
| 6   | Password strength indicator                             | ✅ PASS | getPasswordStrength + PasswordStrengthIndicator lines 50-101; tests: lines 351-368                              |
| 7   | Submit calls Amplify confirmResetPassword               | ✅ PASS | confirmResetPassword via useAuth at line 162; tests: lines 372-403                                              |
| 8   | Success message and redirect to login                   | ✅ PASS | Success view lines 222-267 with 3-second auto-redirect; tests: lines 427-453                                    |
| 9   | Error handling for invalid/expired codes                | ✅ PASS | Error handling at lines 175-188; tests: lines 483-593                                                           |
| 10  | Link to resend code (back to forgot password)           | ✅ PASS | handleResendCode at lines 191-219, link at 619-627; tests: lines 596-670                                        |
| 11  | Accessible with ARIA labels                             | ✅ PASS | aria-live (325-328), aria-invalid (389, 463, 524), role="alert" (354, 400, 434, 490, 549); tests: lines 730-788 |
| 12  | Unit tests (38 tests)                                   | ✅ PASS | ResetPasswordPage.test.tsx: 853 lines, 38 comprehensive tests                                                   |

### Code Quality Assessment

| Dimension            | Rating    | Notes                                                                     |
| -------------------- | --------- | ------------------------------------------------------------------------- |
| **Architecture**     | Excellent | Clean functional component with reusable PasswordStrengthIndicator        |
| **Type Safety**      | Excellent | Full TypeScript with Zod schema inference                                 |
| **Error Handling**   | Excellent | Handles CodeMismatch, ExpiredCode, InvalidPassword, and thrown exceptions |
| **State Management** | Excellent | useState for UI state, sessionStorage cleared on success                  |
| **Testability**      | Excellent | data-testid attributes throughout, comprehensive mock setup               |

### Test Coverage Analysis

| Test Suite                 | Tests | Coverage                                                                                |
| -------------------------- | ----- | --------------------------------------------------------------------------------------- |
| Rendering                  | 7     | AuthLayout, form fields, branding, nav links, back button, resend button, email prefill |
| Form Validation            | 5     | Email, code length, weak password, password mismatch, password requirements             |
| Password Strength          | 2     | Indicator visibility when password entered/empty                                        |
| Successful Submission      | 4     | Success flow, sessionStorage cleared, navigation, tracking                              |
| Error Handling             | 4     | CodeMismatch, ExpiredCode, generic errors, error tracking                               |
| Resend Code                | 4     | Success, empty email, failure, tracking                                                 |
| Password Visibility Toggle | 2     | New password and confirm password toggles                                               |
| Loading State              | 1     | Button disabled during submission                                                       |
| Accessibility              | 5     | ARIA attributes, live regions, role attributes, toggle labels                           |
| Navigation Tracking        | 4     | Reset attempt, signin link, forgot password link, back to home                          |

### NFR Validation

| NFR                 | Status  | Evidence                                                                                                                                     |
| ------------------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| **Security**        | ✅ PASS | Strong password validation (8+ chars, uppercase, lowercase, number, special). sessionStorage cleared on success. No sensitive data exposure. |
| **Performance**     | ✅ PASS | Framer Motion animations, react-hook-form with onChange validation, password strength calculation optimized                                  |
| **Reliability**     | ✅ PASS | Handles both returned errors and thrown exceptions. Auto-redirect with 3-second delay. Resend success timeout.                               |
| **Accessibility**   | ✅ PASS | Full ARIA compliance: aria-live="polite", aria-invalid, aria-describedby, role="status"/"alert", autoComplete="new-password"                 |
| **Maintainability** | ✅ PASS | TypeScript interfaces, reusable PasswordStrengthIndicator component, consistent data-testid usage                                            |

### Risks Identified

None.

### Recommendations

**Future Improvements:**

1. Consider adding E2E Gherkin tests for complete forgot → reset password flow
2. Add monitoring/analytics for password reset completion rates in production

## Change Log

| Date       | Version | Description                                | Author      |
| ---------- | ------- | ------------------------------------------ | ----------- |
| 2025-11-28 | 0.1     | Initial draft                              | Claude Code |
| 2025-11-29 | 1.0     | Implementation complete with 38 unit tests | Dev Agent   |
