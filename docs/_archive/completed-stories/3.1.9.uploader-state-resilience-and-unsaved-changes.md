# Story 3.1.9: Uploader State Resilience & Unsaved‑Changes Guard

## Status

Implemented

## Story

As a creator,
I want my uploader progress to persist across auth redirects and accidental navigations,
so I don’t lose work and can safely resume where I left off.

## Acceptance Criteria

1. Local session persistence (NFR10, FR23)

- Uploader state (title, description, tags, theme, per‑file metadata, step) auto‑saves to local storage on change.
- Keyed by `userId` + route (e.g., `/instructions/new`) + `uploadToken` if available; if not authenticated, use a temporary `anonSessionId`.
- Restores on mount; shows non‑blocking toast: “We restored your uploader progress.”
- Never persist file blobs; only minimal metadata: `{ name, size, type, lastModified }`.
- Clears on successful finalize or when user clicks “Reset”.

2. Unsaved‑changes guard (NFR10)

- If there are unsaved changes, SPA navigation triggers a custom confirmation dialog using @repo/ui; browser tab close/refresh shows native `beforeunload` prompt.
- Dialog is accessible (focus trap, aria‑labelledby, keyboard‑navigable) and uses semantic copy.
- Opting to stay keeps state intact; opting to leave proceeds and cleans up `anonSessionId` data.

3. Auth redirect restore (FR2, FR23)

- Visiting uploader unauthenticated redirects to login with `redirect=/instructions/new` (or `/dashboard/mocs/upload` alias).
- After sign‑in, returns to the uploader route and restores locally persisted state.
- If persisted state belongs to a different `userId`, ignore it and start fresh.

4. Error/resume behavior (FR15, FR16, FR17 – scoped to state)

- Restored files are listed from metadata; if presigned URLs expired, UI surfaces “Retry upload” actions rather than silently failing.
- State restoration never re‑uploads automatically; user must confirm per‑file retries.

5. Logging & A11y (NFR2, NFR7)

- Client logs via @repo/logger at INFO on save/restore and WARN on guard blocks; include `sessionId`, `userId` (if any), and route.
- Use aria‑live (polite) for “restored progress” announcement.

6. Tests (Vitest + RTL)

- Hook unit tests: serialize/deserialize via Zod; ignore blobs; keying by userId/route; clear on finalize/reset.
- Route integration: unauthenticated → redirect → return restores; mismatched userId → no restore.
- Unsaved‑changes: SPA nav shows dialog; beforeunload triggers native prompt (mock `window.onbeforeunload`).

## Tasks / Subtasks

- [x] Types & schema (Zod)
  - [x] Create `apps/web/main-app/src/types/uploader-session.ts` with `UploaderSessionSchema` and type `UploaderSession`:
    - fields: `title, description, tags[], theme, step, files: { name, size, type, lastModified }[]`, `uploadToken?`.
  - [x] Export parsing helpers: `parseSession(json)`, `serializeSession(state)`.

- [x] Session hook & provider
  - [x] Add `apps/web/main-app/src/hooks/useUploaderSession.ts` that:
    - [x] Persists state to `localStorage` under key: `uploader:${route}:${userId||anon}`; debounce writes; version entries.
    - [x] Restores on mount; exposes `reset()`, `clear()`, `markFinalized()`.
    - [x] Emits toasts via @repo/ui; logs via @repo/logger.
  - [x] Add context/provider in `apps/web/main-app/src/components/Uploader/SessionProvider/index.tsx` (Zod‑first props).

- [x] Unsaved‑changes guard
  - [x] Implement `apps/web/main-app/src/hooks/useUnsavedChangesPrompt.ts` using TanStack Router navigation blocking (or `router.history.block`) + `beforeunload`.
  - [x] Accessible confirmation dialog component in `apps/web/main-app/src/components/Uploader/UnsavedChangesDialog/index.tsx` using @repo/ui.

- [x] Route integration
  - [x] Apply guard + provider in the Uploader page route component (target `/instructions/new`).
  - [x] If /dashboard/mocs/upload`route doesn’t exist, add route alias that renders the same page or redirects to`/instructions/new`.
  - [x] Ensure route guard uses `RouteGuards.protected` with `search.redirect` param for auth.

- [x] Tests (Vitest + RTL)
  - [x] `useUploaderSession` unit tests under `apps/web/main-app/src/hooks/__tests__/useUploaderSession.test.tsx`.
  - [ ] Route integration tests under `apps/web/main-app/src/routes/__tests__/uploader-state.integration.test.tsx`.
  - [x] Dialog a11y tests (focus trap, keyboard) under `apps/web/main-app/src/components/Uploader/UnsavedChangesDialog/__tests__/`.

- [ ] Docs
  - [ ] Update `docs/architecture/api-design-and-integration.md#Integration-Guidelines` with state‑resilience notes and UX copy for confirmation/restore toasts.

## Dev Notes

- Follow CLAUDE.md: Zod‑first types; functional components; no barrel files; use @repo/ui (if current alias is @repo/app-component-library in module code, align alias during implementation or follow existing import path in that module).
- Do not store File/Blob objects in localStorage. Only minimal metadata.
- Use a short debounce (e.g., 300ms) to reduce writes; wrap `localStorage` access in try/catch.
- Provide a simple `migrate(oldVersion)` for future schema changes; include a `version` field in persisted payload.

## Change Log

| Date       | Version | Description                            | Author |
| ---------- | ------- | -------------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft created from PRD (3.1.9) | SM     |
