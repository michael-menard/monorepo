# Story 1.13.6: Auth Flow E2E Tests (Playwright)

## Status

Done

## Story

**As a** developer,
**I want** comprehensive Playwright E2E tests for the authentication flows,
**so that** I can ensure the entire auth journey works correctly across browsers.

## Acceptance Criteria

1. ✅ Playwright configured for main-app
2. ✅ Test: Successful login flow (no MFA)
3. ✅ Test: Login with MFA challenge → OTP verification
4. ✅ Test: Signup → Email verification flow
5. ✅ Test: Resend verification code
6. ✅ Test: Invalid credentials error handling
7. ✅ Test: Invalid OTP code error handling
8. ✅ Test: Logout flow
9. ✅ Test: Protected route redirect to login
10. ✅ Test: Session persistence across page refresh
11. ✅ Test: Forgot password → request reset code
12. ✅ Test: Reset password → enter code and new password
13. ✅ Test: Password validation rules
14. ✅ CI integration for E2E tests

## Tasks / Subtasks

- [x] **Task 1: Playwright Setup** (AC: 1)
  - [x] Install @playwright/test
  - [x] Create playwright.config.ts
  - [x] Configure base URL and browsers
  - [x] Add test scripts to package.json
  - [x] Create tests/e2e directory structure

- [x] **Task 2: Test Utilities** (AC: all)
  - [x] Create auth test fixtures
  - [x] Create mock Cognito responses (if using MSW)
  - [x] Create page object models for auth pages
  - [x] Setup test user credentials

- [x] **Task 3: Login Tests** (AC: 2, 6)
  - [x] Test successful login with valid credentials
  - [x] Test redirect to dashboard after login
  - [x] Test invalid email format validation
  - [x] Test invalid password error message
  - [x] Test wrong credentials error

- [x] **Task 4: MFA Tests** (AC: 3, 7)
  - [x] Test MFA challenge detection
  - [x] Test redirect to OTP page
  - [x] Test OTP input functionality
  - [x] Test successful MFA verification
  - [x] Test invalid OTP error
  - [x] Test back to login navigation

- [x] **Task 5: Signup Tests** (AC: 4, 5)
  - [x] Test signup form submission
  - [x] Test redirect to email verification
  - [x] Test OTP entry for email verification
  - [x] Test resend code button
  - [x] Test resend cooldown timer
  - [x] Test successful verification → login

- [x] **Task 6: Session Tests** (AC: 8, 9, 10)
  - [x] Test logout clears session
  - [x] Test protected route redirects to login
  - [x] Test redirect back after login
  - [x] Test session persists on refresh
  - [x] Test token refresh (if testable)

- [x] **Task 7: Forgot Password Tests** (AC: 11)
  - [x] Test forgot password form displays
  - [x] Test email input validation
  - [x] Test submit sends reset code
  - [x] Test redirect to reset password page
  - [x] Test rate limiting error handling
  - [x] Test back to login navigation

- [x] **Task 8: Reset Password Tests** (AC: 12, 13)
  - [x] Test reset password form displays
  - [x] Test email pre-fill from navigation state
  - [x] Test OTP code entry
  - [x] Test password validation rules
  - [x] Test password strength indicator
  - [x] Test confirm password match validation
  - [x] Test successful password reset
  - [x] Test invalid/expired code error
  - [x] Test redirect to login after success

- [x] **Task 9: CI Integration** (AC: 14)
  - [x] Add Playwright to GitHub Actions
  - [x] Configure test artifacts (screenshots, videos)
  - [x] Setup parallel test execution
  - [x] Add to PR checks

## Dev Notes

**important** use the cucumber/Gurkin language to describe tests

### Playwright Configuration

**File:** `apps/web/main-app/playwright.config.ts`

```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### Page Object Models

**File:** `tests/e2e/pages/login.page.ts`

```typescript
import { Page, Locator } from '@playwright/test'

export class LoginPage {
  readonly page: Page
  readonly emailInput: Locator
  readonly passwordInput: Locator
  readonly submitButton: Locator
  readonly errorMessage: Locator
  readonly forgotPasswordLink: Locator
  readonly signUpLink: Locator

  constructor(page: Page) {
    this.page = page
    this.emailInput = page.getByLabel('Email')
    this.passwordInput = page.getByLabel('Password')
    this.submitButton = page.getByRole('button', { name: /sign in/i })
    this.errorMessage = page.getByTestId('error-message')
    this.forgotPasswordLink = page.getByRole('link', { name: /forgot password/i })
    this.signUpLink = page.getByRole('link', { name: /sign up/i })
  }

  async goto() {
    await this.page.goto('/login')
  }

  async login(email: string, password: string) {
    await this.emailInput.fill(email)
    await this.passwordInput.fill(password)
    await this.submitButton.click()
  }
}
```

**File:** `tests/e2e/pages/otp.page.ts`

```typescript
import { Page, Locator } from '@playwright/test'

export class OTPPage {
  readonly page: Page
  readonly otpInputs: Locator
  readonly verifyButton: Locator
  readonly backToLoginButton: Locator
  readonly errorMessage: Locator

  constructor(page: Page) {
    this.page = page
    this.otpInputs = page.getByTestId('otp-input')
    this.verifyButton = page.getByTestId('verify-button')
    this.backToLoginButton = page.getByTestId('back-to-login-button')
    this.errorMessage = page.getByTestId('error-message')
  }

  async enterOTP(code: string) {
    const digits = code.split('')
    for (let i = 0; i < digits.length; i++) {
      await this.page.getByTestId(`otp-input-input-${i}`).fill(digits[i])
    }
  }

  async verifyCode() {
    await this.verifyButton.click()
  }
}
```

**File:** `tests/e2e/pages/forgot-password.page.ts`

```typescript
import { Page, Locator } from '@playwright/test'

export class ForgotPasswordPage {
  readonly page: Page
  readonly emailInput: Locator
  readonly submitButton: Locator
  readonly backToLoginLink: Locator
  readonly successMessage: Locator
  readonly errorMessage: Locator
  readonly continueButton: Locator

  constructor(page: Page) {
    this.page = page
    this.emailInput = page.getByLabel('Email')
    this.submitButton = page.getByRole('button', { name: /send.*code|reset/i })
    this.backToLoginLink = page.getByRole('link', { name: /back to login|sign in/i })
    this.successMessage = page.getByTestId('success-message')
    this.errorMessage = page.getByTestId('error-message')
    this.continueButton = page.getByRole('button', { name: /continue|enter.*code/i })
  }

  async goto() {
    await this.page.goto('/forgot-password')
  }

  async requestResetCode(email: string) {
    await this.emailInput.fill(email)
    await this.submitButton.click()
  }
}
```

**File:** `tests/e2e/pages/reset-password.page.ts`

```typescript
import { Page, Locator } from '@playwright/test'

export class ResetPasswordPage {
  readonly page: Page
  readonly emailInput: Locator
  readonly codeInput: Locator
  readonly newPasswordInput: Locator
  readonly confirmPasswordInput: Locator
  readonly submitButton: Locator
  readonly passwordStrength: Locator
  readonly errorMessage: Locator
  readonly successMessage: Locator
  readonly resendCodeLink: Locator

  constructor(page: Page) {
    this.page = page
    this.emailInput = page.getByLabel('Email')
    this.codeInput = page.getByTestId('otp-input')
    this.newPasswordInput = page.getByLabel(/new password/i)
    this.confirmPasswordInput = page.getByLabel(/confirm password/i)
    this.submitButton = page.getByRole('button', { name: /reset password|submit/i })
    this.passwordStrength = page.getByTestId('password-strength')
    this.errorMessage = page.getByTestId('error-message')
    this.successMessage = page.getByTestId('success-message')
    this.resendCodeLink = page.getByRole('link', { name: /resend|request new code/i })
  }

  async goto() {
    await this.page.goto('/reset-password')
  }

  async enterCode(code: string) {
    const digits = code.split('')
    for (let i = 0; i < digits.length; i++) {
      await this.page.getByTestId(`otp-input-input-${i}`).fill(digits[i])
    }
  }

  async resetPassword(email: string, code: string, newPassword: string, confirmPassword: string) {
    if (await this.emailInput.isEditable()) {
      await this.emailInput.fill(email)
    }
    await this.enterCode(code)
    await this.newPasswordInput.fill(newPassword)
    await this.confirmPasswordInput.fill(confirmPassword)
    await this.submitButton.click()
  }
}
```

### Test Examples

**File:** `tests/e2e/auth/login.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import { LoginPage } from '../pages/login.page'

test.describe('Login Flow', () => {
  let loginPage: LoginPage

  test.beforeEach(async ({ page }) => {
    loginPage = new LoginPage(page)
    await loginPage.goto()
  })

  test('should display login form', async ({ page }) => {
    await expect(loginPage.emailInput).toBeVisible()
    await expect(loginPage.passwordInput).toBeVisible()
    await expect(loginPage.submitButton).toBeVisible()
  })

  test('should show error for invalid credentials', async ({ page }) => {
    await loginPage.login('invalid@email.com', 'wrongpassword')
    await expect(loginPage.errorMessage).toBeVisible()
    await expect(loginPage.errorMessage).toContainText(/incorrect/i)
  })

  test('should redirect to dashboard on successful login', async ({ page }) => {
    await loginPage.login('valid@email.com', 'ValidPassword123!')
    await expect(page).toHaveURL('/dashboard')
  })

  test('should navigate to forgot password page', async ({ page }) => {
    await loginPage.forgotPasswordLink.click()
    await expect(page).toHaveURL('/forgot-password')
  })

  test('should navigate to signup page', async ({ page }) => {
    await loginPage.signUpLink.click()
    await expect(page).toHaveURL('/register')
  })
})
```

**File:** `tests/e2e/auth/mfa.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import { LoginPage } from '../pages/login.page'
import { OTPPage } from '../pages/otp.page'

test.describe('MFA Flow', () => {
  test('should redirect to OTP page when MFA required', async ({ page }) => {
    const loginPage = new LoginPage(page)
    await loginPage.goto()

    // Login with MFA-enabled account
    await loginPage.login('mfa-user@email.com', 'ValidPassword123!')

    // Should redirect to OTP verification
    await expect(page).toHaveURL('/auth/otp-verification')
  })

  test('should complete MFA with valid code', async ({ page }) => {
    const loginPage = new LoginPage(page)
    const otpPage = new OTPPage(page)

    await loginPage.goto()
    await loginPage.login('mfa-user@email.com', 'ValidPassword123!')

    // Enter valid OTP
    await otpPage.enterOTP('123456')
    await otpPage.verifyCode()

    // Should redirect to dashboard
    await expect(page).toHaveURL('/dashboard')
  })

  test('should show error for invalid OTP', async ({ page }) => {
    const loginPage = new LoginPage(page)
    const otpPage = new OTPPage(page)

    await loginPage.goto()
    await loginPage.login('mfa-user@email.com', 'ValidPassword123!')

    // Enter invalid OTP
    await otpPage.enterOTP('000000')
    await otpPage.verifyCode()

    await expect(otpPage.errorMessage).toBeVisible()
    await expect(otpPage.errorMessage).toContainText(/invalid/i)
  })
})
```

**File:** `tests/e2e/auth/forgot-password.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import { ForgotPasswordPage } from '../pages/forgot-password.page'
import { LoginPage } from '../pages/login.page'

test.describe('Forgot Password Flow', () => {
  let forgotPasswordPage: ForgotPasswordPage

  test.beforeEach(async ({ page }) => {
    forgotPasswordPage = new ForgotPasswordPage(page)
    await forgotPasswordPage.goto()
  })

  test('should display forgot password form', async () => {
    await expect(forgotPasswordPage.emailInput).toBeVisible()
    await expect(forgotPasswordPage.submitButton).toBeVisible()
    await expect(forgotPasswordPage.backToLoginLink).toBeVisible()
  })

  test('should validate email format', async ({ page }) => {
    await forgotPasswordPage.emailInput.fill('invalid-email')
    await forgotPasswordPage.submitButton.click()

    // Should show validation error
    await expect(page.getByText(/valid email/i)).toBeVisible()
  })

  test('should send reset code and show success', async ({ page }) => {
    await forgotPasswordPage.requestResetCode('user@example.com')

    // Should show success message
    await expect(forgotPasswordPage.successMessage).toBeVisible()
    await expect(forgotPasswordPage.successMessage).toContainText(/sent|check your email/i)
  })

  test('should redirect to reset password page', async ({ page }) => {
    await forgotPasswordPage.requestResetCode('user@example.com')

    // Wait for success then click continue or auto-redirect
    await expect(page).toHaveURL('/reset-password', { timeout: 5000 })
  })

  test('should handle rate limiting', async ({ page }) => {
    // Trigger rate limit by multiple requests
    await forgotPasswordPage.requestResetCode('user@example.com')
    await forgotPasswordPage.goto()
    await forgotPasswordPage.requestResetCode('user@example.com')
    await forgotPasswordPage.goto()
    await forgotPasswordPage.requestResetCode('user@example.com')

    // Should show rate limit error
    await expect(forgotPasswordPage.errorMessage).toContainText(
      /too many attempts|try again later/i,
    )
  })

  test('should navigate back to login', async ({ page }) => {
    await forgotPasswordPage.backToLoginLink.click()
    await expect(page).toHaveURL('/login')
  })

  test('should be accessible from login page', async ({ page }) => {
    const loginPage = new LoginPage(page)
    await loginPage.goto()
    await loginPage.forgotPasswordLink.click()

    await expect(page).toHaveURL('/forgot-password')
  })
})
```

**File:** `tests/e2e/auth/reset-password.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import { ResetPasswordPage } from '../pages/reset-password.page'
import { ForgotPasswordPage } from '../pages/forgot-password.page'

test.describe('Reset Password Flow', () => {
  let resetPasswordPage: ResetPasswordPage

  test.beforeEach(async ({ page }) => {
    resetPasswordPage = new ResetPasswordPage(page)
    await resetPasswordPage.goto()
  })

  test('should display reset password form', async () => {
    await expect(resetPasswordPage.emailInput).toBeVisible()
    await expect(resetPasswordPage.codeInput).toBeVisible()
    await expect(resetPasswordPage.newPasswordInput).toBeVisible()
    await expect(resetPasswordPage.confirmPasswordInput).toBeVisible()
    await expect(resetPasswordPage.submitButton).toBeVisible()
  })

  test('should pre-fill email from navigation state', async ({ page }) => {
    // Navigate from forgot password with email
    const forgotPasswordPage = new ForgotPasswordPage(page)
    await forgotPasswordPage.goto()
    await forgotPasswordPage.requestResetCode('prefilled@example.com')

    // Email should be pre-filled
    await expect(resetPasswordPage.emailInput).toHaveValue('prefilled@example.com')
  })

  test('should show password strength indicator', async ({ page }) => {
    await resetPasswordPage.newPasswordInput.fill('weak')
    await expect(resetPasswordPage.passwordStrength).toContainText(/weak/i)

    await resetPasswordPage.newPasswordInput.fill('StrongerPass1!')
    await expect(resetPasswordPage.passwordStrength).toContainText(/strong/i)
  })

  test('should validate password requirements', async ({ page }) => {
    // Too short
    await resetPasswordPage.newPasswordInput.fill('Short1!')
    await expect(page.getByText(/at least 8 characters/i)).toBeVisible()

    // No uppercase
    await resetPasswordPage.newPasswordInput.fill('nouppercase1!')
    await expect(page.getByText(/uppercase/i)).toBeVisible()

    // No number
    await resetPasswordPage.newPasswordInput.fill('NoNumber!!')
    await expect(page.getByText(/number/i)).toBeVisible()

    // No special character
    await resetPasswordPage.newPasswordInput.fill('NoSpecial123')
    await expect(page.getByText(/special character/i)).toBeVisible()
  })

  test('should validate password confirmation match', async ({ page }) => {
    await resetPasswordPage.newPasswordInput.fill('ValidPassword1!')
    await resetPasswordPage.confirmPasswordInput.fill('DifferentPassword1!')
    await resetPasswordPage.submitButton.click()

    await expect(page.getByText(/passwords do not match/i)).toBeVisible()
  })

  test('should reset password with valid inputs', async ({ page }) => {
    await resetPasswordPage.resetPassword(
      'user@example.com',
      '123456',
      'NewValidPassword1!',
      'NewValidPassword1!',
    )

    // Should show success and redirect to login
    await expect(resetPasswordPage.successMessage).toBeVisible()
    await expect(page).toHaveURL('/login', { timeout: 5000 })
  })

  test('should show error for invalid code', async ({ page }) => {
    await resetPasswordPage.resetPassword(
      'user@example.com',
      '000000', // Invalid code
      'NewValidPassword1!',
      'NewValidPassword1!',
    )

    await expect(resetPasswordPage.errorMessage).toBeVisible()
    await expect(resetPasswordPage.errorMessage).toContainText(/invalid.*code/i)
  })

  test('should show error for expired code', async ({ page }) => {
    await resetPasswordPage.resetPassword(
      'user@example.com',
      '999999', // Expired code (mocked)
      'NewValidPassword1!',
      'NewValidPassword1!',
    )

    await expect(resetPasswordPage.errorMessage).toBeVisible()
    await expect(resetPasswordPage.errorMessage).toContainText(/expired/i)
  })

  test('should allow resending code', async ({ page }) => {
    await resetPasswordPage.resendCodeLink.click()

    // Should redirect to forgot password or show resend confirmation
    await expect(page).toHaveURL('/forgot-password')
  })

  test('should show success message with redirect countdown', async ({ page }) => {
    await resetPasswordPage.resetPassword(
      'user@example.com',
      '123456',
      'NewValidPassword1!',
      'NewValidPassword1!',
    )

    // Should show success with countdown
    await expect(resetPasswordPage.successMessage).toContainText(/password.*changed|reset/i)
    await expect(page.getByText(/redirecting/i)).toBeVisible()

    // Wait for redirect
    await expect(page).toHaveURL('/login', { timeout: 5000 })
  })
})
```

### Mock Cognito with MSW (Optional)

For reliable E2E tests without hitting real Cognito:

```typescript
// tests/e2e/mocks/handlers.ts
import { http, HttpResponse } from 'msw'

export const handlers = [
  http.post('https://cognito-idp.*.amazonaws.com/', async ({ request }) => {
    const body = await request.json()

    // Handle different Cognito operations
    if (body.AuthFlow === 'USER_SRP_AUTH') {
      // Mock successful login or MFA challenge
    }

    return HttpResponse.json({
      /* mock response */
    })
  }),
]
```

### Package.json Scripts

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:report": "playwright show-report"
  }
}
```

### GitHub Actions Integration

```yaml
# .github/workflows/e2e.yml
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: pnpm --filter main-app exec playwright install --with-deps

      - name: Run E2E tests
        run: pnpm --filter main-app test:e2e

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/main-app/playwright-report/
          retention-days: 30
```

## Testing

### Gherkin Feature Files

All E2E tests use Playwright-BDD with Cucumber/Gherkin syntax. Feature files are located in `apps/web/playwright/features/auth/`.

---

#### Feature: Login Flow (`login.feature`)

```gherkin
@auth @login
Feature: User Login

  As a user of the LEGO MOC Instructions application
  I want to be able to log in to my account
  So that I can access my personal content and features

  Background:
    Given I am on the login page

  # AC2: Test: Successful login flow (no MFA)
  @smoke @p0
  Scenario: Successful login with valid credentials
    When I enter "testuser@example.com" in the email field
    And I enter "ValidPassword123!" in the password field
    And I click the sign in button
    Then I should be on the dashboard
    And I should see a welcome message

  @smoke
  Scenario: Display login page elements
    Then I should see the login form
    And I should see the email input field
    And I should see the password input field
    And I should see the sign in button
    And I should see the forgot password link
    And I should see the sign up link

  # AC6: Test: Invalid credentials error handling
  @p0
  Scenario: Show error for invalid credentials
    When I enter "testuser@example.com" in the email field
    And I enter "WrongPassword123!" in the password field
    And I click the sign in button
    Then I should see an authentication error
    And I should remain on the login page

  @p1
  Scenario: Show validation error for empty email
    When I click the sign in button
    Then I should see an email validation error

  @p1
  Scenario: Show validation error for invalid email format
    When I enter "invalid-email" in the email field
    And I click the sign in button
    Then I should see an email format error

  @p1
  Scenario: Show validation error for empty password
    When I enter "testuser@example.com" in the email field
    And I click the sign in button
    Then I should see a password validation error

  @p2
  Scenario: Navigate to signup page
    When I click the sign up link
    Then I should be on the signup page

  @p2
  Scenario: Navigate to forgot password page
    When I click the forgot password link
    Then I should be on the forgot password page
```

---

#### Feature: MFA Flow (`mfa.feature`)

```gherkin
@auth @mfa
Feature: Multi-Factor Authentication

  As a user with MFA enabled
  I want to complete the MFA challenge after login
  So that my account remains secure

  Background:
    Given I am on the login page

  # AC3: Test: Login with MFA challenge → OTP verification
  @smoke @p0
  Scenario: Complete MFA verification successfully
    When I enter "mfa-user@example.com" in the email field
    And I enter "ValidPassword123!" in the password field
    And I click the sign in button
    Then I should be redirected to the OTP verification page
    When I enter the valid OTP code "123456"
    And I click the verify button
    Then I should be on the dashboard

  @p0
  Scenario: MFA challenge detection and redirect
    When I enter "mfa-user@example.com" in the email field
    And I enter "ValidPassword123!" in the password field
    And I click the sign in button
    Then I should be redirected to the OTP verification page
    And I should see the OTP input component
    And I should see a verify button

  # AC7: Test: Invalid OTP code error handling
  @p0
  Scenario: Show error for invalid OTP code
    Given I have triggered an MFA challenge
    When I enter the invalid OTP code "000000"
    And I click the verify button
    Then I should see an invalid code error
    And I should remain on the OTP verification page

  @p1
  Scenario: OTP input keyboard navigation
    Given I have triggered an MFA challenge
    Then I should be able to navigate OTP inputs with arrow keys
    And pasting a full code should populate all inputs

  @p2
  Scenario: Navigate back to login from OTP page
    Given I have triggered an MFA challenge
    When I click the back to login button
    Then I should be on the login page
```

---

#### Feature: Signup Flow (`signup.feature`)

```gherkin
@auth @signup
Feature: User Signup

  As a new user
  I want to create an account
  So that I can access the application

  Background:
    Given I am on the signup page

  # AC4: Test: Signup → Email verification flow
  @smoke @p0
  Scenario: Complete signup and email verification
    When I enter "newuser@example.com" in the email field
    And I enter "ValidPassword123!" in the password field
    And I enter "ValidPassword123!" in the confirm password field
    And I click the sign up button
    Then I should be redirected to the email verification page
    When I enter the valid verification code "123456"
    And I click the verify button
    Then I should see a verification success message
    And I should be redirected to the login page

  @p0
  Scenario: Display signup form elements
    Then I should see the signup form
    And I should see the email input field
    And I should see the password input field
    And I should see the confirm password field
    And I should see the sign up button

  # AC5: Test: Resend verification code
  @p1
  Scenario: Resend verification code
    Given I have submitted the signup form
    And I am on the email verification page
    When I click the resend code button
    Then I should see a code sent confirmation
    And the resend button should be disabled temporarily

  @p1
  Scenario: Resend cooldown timer
    Given I have submitted the signup form
    And I am on the email verification page
    When I click the resend code button
    Then I should see a cooldown timer
    And I cannot click resend until timer expires

  @p1
  Scenario: Validate password requirements during signup
    When I enter "newuser@example.com" in the email field
    And I enter "weak" in the password field
    Then I should see password strength indicator as weak
    When I enter "StrongPass123!" in the password field
    Then I should see password strength indicator as strong

  @p1
  Scenario: Validate password confirmation match
    When I enter "ValidPassword123!" in the password field
    And I enter "DifferentPassword123!" in the confirm password field
    And I click the sign up button
    Then I should see a passwords do not match error

  @p2
  Scenario: Show error for existing email
    When I enter "existing@example.com" in the email field
    And I enter "ValidPassword123!" in the password field
    And I enter "ValidPassword123!" in the confirm password field
    And I click the sign up button
    Then I should see an email already exists error
```

---

#### Feature: Session Management (`session.feature`)

```gherkin
@auth @session
Feature: Session Management

  As an authenticated user
  I want my session to persist appropriately
  So that I have a seamless experience

  # AC8: Test: Logout flow
  @smoke @p0
  Scenario: Logout clears session
    Given I am logged in as "testuser@example.com"
    When I click the logout button
    Then I should be redirected to the login page
    And my session should be cleared
    When I navigate to the dashboard
    Then I should be redirected to the login page

  # AC9: Test: Protected route redirect to login
  @p0
  Scenario: Protected route redirects unauthenticated users
    Given I am not logged in
    When I navigate to the dashboard
    Then I should be redirected to the login page
    And I should see a login required message

  @p0
  Scenario: Redirect back after login
    Given I am not logged in
    When I navigate to "/settings"
    Then I should be redirected to the login page
    When I login with valid credentials
    Then I should be redirected to "/settings"

  # AC10: Test: Session persistence across page refresh
  @p0
  Scenario: Session persists across page refresh
    Given I am logged in as "testuser@example.com"
    When I refresh the page
    Then I should remain on the dashboard
    And I should still be authenticated

  @p1
  Scenario: Session persists across browser tabs
    Given I am logged in as "testuser@example.com"
    When I open a new browser tab
    And I navigate to the dashboard in the new tab
    Then I should be authenticated in the new tab

  @p2
  Scenario: Handle token expiry gracefully
    Given I am logged in with an expired token
    When I navigate to a protected route
    Then I should be redirected to the login page
    And I should see a session expired message
```

---

#### Feature: Forgot Password (`forgot-password.feature`)

```gherkin
@auth @forgot-password
Feature: Forgot Password

  As a user who forgot my password
  I want to request a password reset code
  So that I can regain access to my account

  Background:
    Given I am on the forgot password page

  # AC11: Test: Forgot password → request reset code
  @smoke @p0
  Scenario: Request password reset code successfully
    When I enter "testuser@example.com" in the email field
    And I click the send reset code button
    Then I should see a code sent success message
    And I should be redirected to the reset password page

  @p0
  Scenario: Display forgot password form elements
    Then I should see the forgot password form
    And I should see the email input field
    And I should see the send reset code button
    And I should see the back to login link

  @p1
  Scenario: Validate email format
    When I enter "invalid-email" in the email field
    And I click the send reset code button
    Then I should see an email format error

  @p1
  Scenario: Handle rate limiting
    When I request reset codes 3 times rapidly
    Then I should see a rate limit error
    And I should see a retry after message

  @p2
  Scenario: Navigate back to login
    When I click the back to login link
    Then I should be on the login page

  @p2
  Scenario: Handle non-existent email gracefully
    When I enter "nonexistent@example.com" in the email field
    And I click the send reset code button
    Then I should see a generic success message
    # Security: Don't reveal if email exists
```

---

#### Feature: Reset Password (`reset-password.feature`)

```gherkin
@auth @reset-password
Feature: Reset Password

  As a user with a reset code
  I want to set a new password
  So that I can access my account again

  Background:
    Given I am on the reset password page

  # AC12: Test: Reset password → enter code and new password
  @smoke @p0
  Scenario: Reset password successfully
    When I enter "testuser@example.com" in the email field
    And I enter the reset code "123456"
    And I enter "NewValidPassword123!" in the new password field
    And I enter "NewValidPassword123!" in the confirm password field
    And I click the reset password button
    Then I should see a password reset success message
    And I should be redirected to the login page

  @p0
  Scenario: Display reset password form elements
    Then I should see the reset password form
    And I should see the email input field
    And I should see the OTP code input
    And I should see the new password field
    And I should see the confirm password field
    And I should see the reset password button

  @p0
  Scenario: Pre-fill email from navigation state
    Given I came from the forgot password page with email "prefilled@example.com"
    Then the email field should contain "prefilled@example.com"

  # AC13: Test: Password validation rules
  @p0
  Scenario Outline: Validate password requirements
    When I enter "<password>" in the new password field
    Then I should see "<validation_message>"

    Examples:
      | password        | validation_message             |
      | short           | at least 8 characters          |
      | nouppercase1!   | uppercase letter required      |
      | NOLOWERCASE1!   | lowercase letter required      |
      | NoNumbers!!     | number required                |
      | NoSpecial123    | special character required     |

  @p0
  Scenario: Display password strength indicator
    When I enter "weak" in the new password field
    Then the password strength should show "Weak"
    When I enter "StrongerPass1!" in the new password field
    Then the password strength should show "Strong"

  @p1
  Scenario: Validate password confirmation match
    When I enter "ValidPassword123!" in the new password field
    And I enter "DifferentPassword!" in the confirm password field
    And I click the reset password button
    Then I should see a passwords do not match error

  @p1
  Scenario: Show error for invalid reset code
    When I enter "testuser@example.com" in the email field
    And I enter the invalid reset code "000000"
    And I enter "NewValidPassword123!" in the new password field
    And I enter "NewValidPassword123!" in the confirm password field
    And I click the reset password button
    Then I should see an invalid code error

  @p1
  Scenario: Show error for expired reset code
    When I enter "testuser@example.com" in the email field
    And I enter the expired reset code "999999"
    And I enter "NewValidPassword123!" in the new password field
    And I enter "NewValidPassword123!" in the confirm password field
    And I click the reset password button
    Then I should see a code expired error

  @p2
  Scenario: Request new reset code
    When I click the resend code link
    Then I should be redirected to the forgot password page
```

---

### Test Priority Summary

| Priority | Count | Description                               |
| -------- | ----- | ----------------------------------------- |
| P0       | 18    | Critical auth flows, security validations |
| P1       | 14    | Important error handling, edge cases      |
| P2       | 9     | Navigation, UI polish, edge scenarios     |

### AC → Test Mapping

| AC   | Feature File            | Key Scenarios                                |
| ---- | ----------------------- | -------------------------------------------- |
| AC1  | playwright.config.ts    | Configuration only                           |
| AC2  | login.feature           | Successful login with valid credentials      |
| AC3  | mfa.feature             | Complete MFA verification successfully       |
| AC4  | signup.feature          | Complete signup and email verification       |
| AC5  | signup.feature          | Resend verification code, cooldown timer     |
| AC6  | login.feature           | Show error for invalid credentials           |
| AC7  | mfa.feature             | Show error for invalid OTP code              |
| AC8  | session.feature         | Logout clears session                        |
| AC9  | session.feature         | Protected route redirects                    |
| AC10 | session.feature         | Session persists across refresh              |
| AC11 | forgot-password.feature | Request password reset code                  |
| AC12 | reset-password.feature  | Reset password successfully                  |
| AC13 | reset-password.feature  | Password validation rules (Scenario Outline) |
| AC14 | GitHub Actions          | CI configuration                             |

## Test Coverage Matrix

| Flow            | Happy Path                  | Error Cases         | Edge Cases           |
| --------------- | --------------------------- | ------------------- | -------------------- |
| Login           | ✓ Valid credentials         | ✓ Wrong password    | ✓ Empty form         |
|                 | ✓ Redirect to dashboard     | ✓ User not found    | ✓ Special characters |
| MFA             | ✓ OTP entry                 | ✓ Invalid code      | ✓ Code expiry        |
|                 | ✓ Verify success            | ✓ Too many attempts | ✓ Back navigation    |
| Signup          | ✓ Form submission           | ✓ Email exists      | ✓ Password rules     |
|                 | ✓ Email verification        | ✓ Invalid code      | ✓ Resend code        |
| Forgot Password | ✓ Request code              | ✓ Rate limiting     | ✓ Back to login      |
|                 | ✓ Redirect to reset         | ✓ Invalid email     | ✓ Email validation   |
| Reset Password  | ✓ Enter code + new password | ✓ Invalid code      | ✓ Password strength  |
|                 | ✓ Redirect to login         | ✓ Expired code      | ✓ Password match     |
|                 | ✓ Success message           | ✓ Weak password     | ✓ Email pre-fill     |
| Session         | ✓ Persist on refresh        | ✓ Token expiry      | ✓ Multiple tabs      |
|                 | ✓ Logout clears             | ✓ Protected routes  |                      |

## Dependencies

- Story 1.13.1: OTP Input Component (Complete)
- Story 1.13.2: OTP Verification Page (Complete)
- Story 1.13.3: Email Verification Flow
- Story 1.13.4: Resend Verification Code
- Story 1.13.5: MFA Challenge Handling
- Story 1.13.7: Forgot Password Flow
- Story 1.13.8: Reset Password Flow
- Story 1.14: Login Page
- Story 1.17: Logout Flow

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-11-28 | 0.1     | Initial draft                     | Claude Code |
| 2025-11-28 | 0.2     | Added forgot/reset password tests | Claude Code |
