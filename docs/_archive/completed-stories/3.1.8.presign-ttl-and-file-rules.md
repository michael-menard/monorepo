# Story 3.1.8: Upload Session TTL + Env‑Driven File Rules (types/sizes/counts)

## Status

Done

## Story

As a developer,
I want upload session TTL and file validation (type/size/count) to be driven by validated env config,
so that limits are consistent across environments and replace all hardcoded values.

## Acceptance Criteria

1. Upload session TTL

- Session endpoints replace any hardcoded TTL with `getUploadConfig().sessionTtlMinutes` (min/max bounds validated in 3.1.5).
- Response includes `sessionTtlSeconds` that matches the session TTL used.

2. File type allowlist

- Instruction files must be PDF only (MIME `application/pdf`).
- Parts lists allow CSV and Excel (`text/csv`, `application/vnd.ms-excel`, `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`).
- Images allow JPEG/PNG/WebP (`image/jpeg`, `image/png`, `image/webp`).
- Allowed types sourced from config: `upload.allowedMimeTypes.{instruction,partsList,image}`.

3. Size limits (bytes) and per‑type counts

- Replace all hardcoded limits with config values: `upload.maxSizeBytes.{instruction,partsList,thumbnail,image}` and `upload.maxCount.{instruction,partsList,image}`.
- Initialize rejects payload when any file exceeds max size or count per type with a clear 400.

4. Finalize enforcement

- Size: verify each object’s `ContentLength` via S3 HeadObject against config limits.
- Type: fetch a small byte range (e.g., `Range: bytes=0-511`) via S3 GetObject and validate magic bytes/signature; treat `ContentType` as advisory only. Reject 400 on mismatch; include filename and reason.

5. Logging

- INFO on session creation with `sessionTtlSeconds` from config; WARN on validation failures; all logs include `requestId` and `ownerId`.

6. Tests

- Unit tests cover TTL mapping, reject invalid MIME, reject oversize, reject too many images, and finalize’s S3 `HeadObject` validations.

## Tasks / Subtasks

- [x] Config usage
  - [x] Create/confirm `apps/api/core/config/upload.ts` exposing `getUploadConfig()` from Story 3.1.5 with:
    - `sessionTtlMinutes: number`
    - `allowedMimeTypes: { instruction: string[]; partsList: string[]; image: string[] }`
    - `maxSizeBytes: { instruction: number; partsList: number; thumbnail: number; image: number }`
    - `maxCount: { instruction: number; partsList: number; image: number }`

- [x] Upload session endpoints wiring (apps/api/endpoints/moc-instructions/initialize-with-files/handler.ts)
  - [x] Replace hardcoded FILE_SIZE_LIMITS and count checks with config.
  - [x] Validate MIME against allowlist per fileType.
  - [x] Ensure upload session TTL uses `getUploadConfig().sessionTtlMinutes * 60` and surface it in response.
  - [x] Include `sessionTtlSeconds` in response from config.

- [x] Finalize handler wiring (apps/api/endpoints/moc-instructions/finalize-with-files/handler.ts)
  - [x] For each referenced object: call S3 `HeadObject` and verify `ContentLength` against config; then call S3 `GetObject` with `Range: bytes=0-511` and validate magic bytes against the allowlist for types with known signatures (PDF, JPEG, PNG, WebP). Treat `ContentType` as advisory.
  - [x] On failure: 400 with descriptive error message and WARN log; do not create partial records.

- [x] Consistency with shared service
  - [x] Limits/allowlists in `apps/api/endpoints/moc-instructions/_shared/moc-file-service.ts` already sourced from config via `getUploadConfig()`.

- [x] Tests (Vitest)
  - [x] Session: TTL equals config; invalid MIME rejected; oversize rejected; too many images rejected.
  - [x] Config tests: 36 tests covering TTL mapping, MIME validation, size limits.

- [x] Docs
  - [x] Update docs with env keys and defaults: session TTL minutes, allowed MIME arrays, max size bytes, max counts; examples and rationale.

## Dev Notes

- Use Zod‑validated config from 3.1.5; do not introduce silent fallbacks.
- Do not trust S3 ContentType; clients may set Content-Type when uploading via API, but enforce type at finalize via magic bytes with a small Range GET. Use HeadObject only for size checks. For CSV/plain text, treat as text by ensuring initial bytes are printable ASCII and rely on extension allowlist.
- Keep TTL bounds sane (e.g., 5–120 minutes) in the config schema; clients use the echoed `sessionTtlSeconds`.
- Prefer messages referencing the specific file and rule violated (type/size/count) to aid UX.

## Change Log

| Date       | Version | Description                            | Author |
| ---------- | ------- | -------------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft created from PRD (3.1.8) | SM     |
