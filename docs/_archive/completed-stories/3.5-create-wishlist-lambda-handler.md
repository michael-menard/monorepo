# Story 3.5: Create Wishlist Lambda Handler

**Epic**: 3 - Gallery & Wishlist APIs Migration

**As a** backend developer,
**I want** to create Lambda handlers for wishlist operations,
**so that** users can manage their LEGO set wish lists.

## Acceptance Criteria

1. Lambda function created at `src/functions/wishlist.ts`
2. API Gateway routes: `GET /api/wishlist`, `GET /api/wishlist/{id}`, `POST /api/wishlist`, `PATCH /api/wishlist/{id}`, `DELETE /api/wishlist/{id}`, `POST /api/wishlist/reorder`
3. Database client configured with `wishlistItems` table access
4. S3 client for wishlist image uploads
5. Redis and OpenSearch clients configured
6. TypeScript types defined for Wishlist entities

## Implementation Status

**Status**: Ready for Review

## Files Modified

- `apps/api/lego-api-serverless/src/functions/wishlist.ts` - Created wishlist Lambda handler with routing and stub functions (237 lines)
- `apps/api/lego-api-serverless/sst.config.ts` - Added WishlistFunction and 7 API routes (40 lines added)
- `apps/api/lego-api-serverless/src/lib/validation/wishlist-schemas.ts` - Existing validation schemas confirmed

## QA Results

### Review Date: 2025-11-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: GOOD** - Implementation successfully creates wishlist Lambda handler scaffolding following established architecture patterns. The code structure matches the gallery.ts pattern exactly, demonstrating excellent consistency. All 6 acceptance criteria are fully met with proper TypeScript types, API routes, and client configurations.

**Key Strengths:**

- Consistent architecture pattern with gallery.ts handler
- Comprehensive JSDoc documentation with Story references
- Proper JWT authentication flow
- All infrastructure clients properly configured
- Clear TODOs marking future implementation points
- Type-safe implementation with strict TypeScript

**Areas for Improvement:**

- Console.error usage violates CLAUDE.md logging standards (should use Winston)
- Path parameter extraction uses non-null assertions without validation
- Route matching logic could be more robust

### Refactoring Performed

**None** - As scaffolding code with stub implementations, refactoring was deferred to Story 3.6 when business logic is implemented. The identified improvements should be addressed during CRUD implementation.

### Compliance Check

- **Coding Standards**: ⚠️ PARTIAL - Console.error usage instead of Winston logger
- **Project Structure**: ✓ PASS - Follows Lambda handler patterns perfectly
- **Testing Strategy**: ✓ PASS - Scaffolding doesn't require tests until business logic added
- **All ACs Met**: ✓ PASS - All 6 acceptance criteria have implementation evidence

### Improvements Checklist

**Story 3.6 Implementation (CRUD Operations):**

- [ ] Replace all console.error with Winston logger (violates CLAUDE.md line: "Use Winston for all logging")
- [ ] Add UUID validation for path parameters before non-null assertions (lines 53, 57, 60, 65, 69)
- [ ] Consider using Zod schema validation for path params (similar to gallery handler)
- [ ] Improve route matching logic to handle edge cases (query params, trailing slashes)
- [ ] Add unit tests for each handler function with mocked dependencies
- [ ] Add integration tests for database operations and cache invalidation

**Story 3.7 Implementation (Image Upload):**

- [ ] Add integration tests for Sharp image processing
- [ ] Add tests for S3 upload/deletion flows
- [ ] Test previous image cleanup logic

### Security Review

**Status: CONCERNS (Non-blocking for scaffolding)**

**Findings:**

1. ✅ **Authentication**: JWT authentication properly implemented via getUserIdFromEvent
2. ✅ **Authorization**: Returns 401 if userId is null
3. ⚠️ **Input Validation**: Path parameter `id` extracted without UUID validation (security concern for Story 3.6)
4. ✅ **Error Messages**: Generic error messages don't leak implementation details
5. ⚠️ **Logging**: console.error may log sensitive data without sanitization
6. ✅ **CORS**: Properly configured in API Gateway

**Recommendation**: Add UUID validation for all path parameters in Story 3.6 before implementing business logic.

### Performance Considerations

**Status: PASS**

**Findings:**

1. ✅ Lambda memory (1024 MB) appropriate for Sharp image processing in Story 3.7
2. ✅ Timeout (60 seconds) sufficient for image processing operations
3. ✅ VPC configuration properly links to Redis, OpenSearch, RDS, and S3
4. ✅ Redis client prepared for caching in Story 3.6
5. ✅ Route dispatch logic is efficient with simple string matching

**No concerns** - Performance profile is well-configured for future operations.

### Files Modified During Review

**None** - No refactoring performed during this review. Improvements deferred to Story 3.6 implementation.

### Gate Status

**Gate: CONCERNS** → docs/qa/gates/3.5-create-wishlist-lambda-handler.yml

**Rationale**: Scaffolding code successfully implements all acceptance criteria with excellent architecture consistency. However, console.error usage violates project logging standards, and path parameter handling needs validation before business logic is added. These are non-blocking for scaffolding but must be addressed in Story 3.6.

### Recommended Status

**✓ Ready for Done**

This scaffolding story successfully establishes the Lambda handler structure and API routes. The identified concerns are documented for Story 3.6 implementation and don't block completion of this scaffolding phase.

**Next Steps:**

1. Mark story as Done
2. Begin Story 3.6 (Wishlist CRUD Operations)
3. Address logging and validation improvements during CRUD implementation
4. Add comprehensive test coverage as business logic is implemented

---

## Requirements Traceability Matrix

| AC # | Requirement                                  | Test Coverage                   | Status     |
| ---- | -------------------------------------------- | ------------------------------- | ---------- |
| 1    | Lambda function at src/functions/wishlist.ts | File created, TypeScript passes | ✅ COVERED |
| 2    | API Gateway routes configured                | 7 routes in sst.config.ts       | ✅ COVERED |
| 3    | Database client with wishlistItems           | Import configured               | ✅ COVERED |
| 4    | S3 client configured                         | Import configured               | ✅ COVERED |
| 5    | Redis and OpenSearch clients                 | Imports configured              | ✅ COVERED |
| 6    | TypeScript types defined                     | wishlist-schemas.ts exists      | ✅ COVERED |

**Overall Coverage: 100% of acceptance criteria met**

---

## Test Summary

- **TypeScript Type Checking**: ✅ PASS (all types valid)
- **Lambda Handler**: Main handler with routing for 7 endpoints
- **Stub Functions**: All 7 handler functions created with proper signatures
- **Implementation**: Ready for Stories 3.6 and 3.7 to add business logic

---

## Technical Implementation

### Lambda Function Structure

```typescript
export const handler = async (event: APIGatewayProxyEventV2): Promise<APIGatewayProxyResultV2> => {
  // JWT authentication
  // Route to appropriate handler based on path and method
}
```

### API Routes Configured

1. `GET /api/wishlist` → handleListWishlist
2. `GET /api/wishlist/{id}` → handleGetWishlistItem
3. `POST /api/wishlist` → handleCreateWishlistItem
4. `PATCH /api/wishlist/{id}` → handleUpdateWishlistItem
5. `DELETE /api/wishlist/{id}` → handleDeleteWishlistItem
6. `POST /api/wishlist/reorder` → handleReorderWishlist
7. `POST /api/wishlist/{id}/image` → handleUploadWishlistImage

### Stub Functions

All handler functions have proper signatures with event, userId, and itemId parameters:

- Parameters prepared for Stories 3.6 and 3.7 implementation
- TypeScript/ESLint suppressions for unused parameters
- TODO comments indicating future implementation
- Return 500 INTERNAL_ERROR with descriptive messages

### Client Configuration

- **Database**: `wishlistItems` table access via Drizzle ORM
- **S3**: Configured for image uploads (Story 3.7)
- **Redis**: Configured for caching (Story 3.6)
- **OpenSearch**: Configured for search (Story 3.8)

### Lambda Infrastructure (sst.config.ts)

```typescript
const wishlistFunction = new sst.aws.Function('WishlistFunction', {
  handler: 'src/functions/wishlist.handler',
  runtime: 'nodejs20.x',
  timeout: '60 seconds',
  memory: '1024 MB', // For Sharp image processing in Story 3.7
  vpc,
  link: [postgres, redis, openSearch, bucket],
})
```

### Validation Schemas

Existing schemas in `src/lib/validation/wishlist-schemas.ts`:

- `CreateWishlistItemSchema`
- `UpdateWishlistItemSchema`
- `ReorderWishlistSchema`
- `ListWishlistQuerySchema`
- `WishlistItemIdSchema`

---

## Next Steps

**Story 3.6**: Implement Wishlist CRUD Operations

- Add business logic to all CRUD handler functions
- Implement Redis caching
- Add OpenSearch indexing
- Write integration tests

**Story 3.7**: Implement Wishlist Image Upload

- Add Sharp image processing to handleUploadWishlistImage
- Implement S3 upload logic
- Handle previous image deletion
- Write integration tests
