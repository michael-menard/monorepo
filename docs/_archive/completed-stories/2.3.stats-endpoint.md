# Story 2.3: Stats Endpoint Integration

## Status

Ready for Review

## Story

**As a** user,
**I want** to see my collection statistics,
**so that** I know how many MOCs and items I have.

## Acceptance Criteria

1. âœ… `useGetStatsQuery` hook available
2. âœ… Fetches GET /dashboard/stats
3. âœ… Returns: totalMocs, wishlistCount, themeCount
4. âœ… Handles loading and error states (RTK Query built-in)
5. ðŸ”„ Backend: /dashboard/stats endpoint required

## Tasks / Subtasks

- [x] **Task 1: Define Endpoint**
  - [x] Add getStats query to dashboardApi
  - [x] Define response type with Zod

- [x] **Task 2: Response Types**
  - [x] Create DashboardStats interface
  - [x] Create Zod schema for validation

## Dev Notes

### Endpoint Definition

```typescript
getStats: builder.query<DashboardStats, void>({
  query: () => '/dashboard/stats',
  providesTags: ['DashboardStats'],
}),

export interface DashboardStats {
  totalMocs: number
  wishlistCount: number
  themeCount: number
  lastUpdated: string
}
```

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via James - Full Stack Developer)

### Debug Log References
- `pnpm --filter @repo/api-client test` - 181 tests passing (34 new schema tests)
- `pnpm --filter @repo/api-client exec tsc --noEmit` - Type checking passed

### Completion Notes
- Converted TypeScript interfaces to Zod schemas per coding standards
- Added runtime validation in transformResponse functions
- All tests passing (147 tests in api-client package)
- Type checking successful
- Endpoint was previously implemented, enhanced with Zod validation

**QA Fixes Applied (2025-12-25):**
- **TEST-001 (Medium)**: Added 34 comprehensive unit tests for DashboardStatsSchema and RecentMocSchema validation
  - Tests cover valid data, boundary cases, invalid types, missing fields, and malformed data
  - Validates all constraint enforcement (int, nonnegative, uuid, datetime, url)
- **PERF-001 (Low)**: Removed hardcoded performance metrics from transformResponse
  - Performance field now omitted (optional) as real metrics unavailable in transformResponse
  - Actual performance tracking handled by baseQuery performanceMonitor
- **ERROR-001 (Low)**: Documented decision to keep .parse() for fail-fast validation
  - Added inline comments explaining rationale: API contract violations should fail immediately
  - RTK Query handles errors gracefully in consuming components

### File List
- `packages/core/api-client/src/rtk/dashboard-api.ts` - Modified: Added Zod schemas, runtime validation, removed hardcoded performance metrics, documented validation strategy
- `packages/core/api-client/src/rtk/__tests__/dashboard-api-schemas.test.ts` - Added: 34 comprehensive schema validation unit tests

## Change Log

| Date       | Version | Description                          | Author   |
| ---------- | ------- | ------------------------------------ | -------- |
| 2025-11-28 | 0.1     | Initial draft                        | SM Agent |
| 2025-12-25 | 1.0     | Implemented with Zod validation      | James    |
| 2025-12-25 | 1.1     | Applied QA fixes: Added 34 schema validation tests, removed hardcoded performance metrics, documented validation strategy | James    |
