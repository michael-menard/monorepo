# Story 3.1.4: Instructions Detail Page

## Status

Ready for Review

## Story

**As a** user,
**I want** to view full details of an instruction,
**so that** I can see all images, metadata, and information about a MOC.

## Acceptance Criteria

1. ✅ Route `/instructions/:instructionId` configured
2. ✅ Displays all instruction images in gallery view
3. ✅ Shows instruction metadata (name, pieces, theme, tags)
4. ✅ Lightbox opens on image click
5. ✅ Back button returns to gallery
6. ✅ Edit button navigates to edit page
7. ⏸️ Linked inspiration images section (if any) - Deferred to API integration
8. [ ] Display extended metadata (designer, dimensions, features, build info)
9. [ ] Show alternate build information when applicable
10. [ ] Display rich HTML description with proper sanitization

## UI Sections

### Header Section

| Element       | Field                      | Notes                                   |
| ------------- | -------------------------- | --------------------------------------- |
| Title         | `title`                    | H1, main page heading                   |
| Subtitle      | `shortDescription`         | Brief summary below title               |
| MOC ID Badge  | `mocId`                    | e.g., "MOC-243400"                      |
| Type Badge    | `type`                     | "MOC" or "Set"                          |
| Status Badges | `isFeatured`, `isVerified` | Star icon, checkmark icon               |
| Author        | `author`                   | With link if designer.profileUrl exists |

### Image Gallery Section

| Element      | Field                                 | Notes                    |
| ------------ | ------------------------------------- | ------------------------ |
| Main Image   | `thumbnailUrl` or first gallery image | Hero image, large        |
| Gallery Grid | `galleryImages[]`                     | Clickable thumbnails     |
| Lightbox     | -                                     | Full-screen image viewer |

### Quick Stats Bar

| Element     | Field                | Notes                                       |
| ----------- | -------------------- | ------------------------------------------- |
| Parts Count | `partsCount`         | Brick icon + number                         |
| Minifigs    | `minifigCount`       | Minifig icon + number                       |
| Theme       | `theme` / `subtheme` | Category badge                              |
| Difficulty  | `difficulty`         | Beginner/Intermediate/Advanced/Expert badge |
| Build Time  | `buildTimeHours`     | Clock icon + "~X hours"                     |
| Age         | `ageRecommendation`  | e.g., "16+"                                 |

### Designer Card

| Element      | Field                                         | Notes                                      |
| ------------ | --------------------------------------------- | ------------------------------------------ |
| Avatar       | `designer.avatarUrl`                          | Circular image, fallback to initials       |
| Name         | `designer.displayName` or `designer.username` | Link to profile                            |
| Username     | `designer.username`                           | @username format                           |
| Social Links | `designer.socialLinks.*`                      | Instagram, Twitter, YouTube, Website icons |

### Description Section

| Element           | Field             | Notes                            |
| ----------------- | ----------------- | -------------------------------- |
| Rich Description  | `descriptionHtml` | Sanitized HTML rendering         |
| Plain Description | `description`     | Fallback if no HTML              |
| Features List     | `features[]`      | Icon + title + description cards |

### Dimensions Card

| Element   | Field                                             | Notes                             |
| --------- | ------------------------------------------------- | --------------------------------- |
| Height    | `dimensions.height.cm` / `.inches`                | Toggle metric/imperial            |
| Width     | `dimensions.width.cm` / `.inches`                 | Show open dimensions if available |
| Depth     | `dimensions.depth.cm` / `.inches`                 | Show open dimensions if available |
| Weight    | `dimensions.weight.kg` / `.lbs`                   | Toggle metric/imperial            |
| Baseplate | `dimensions.studsWidth` x `dimensions.studsDepth` | "32x32 studs" format              |

### Alternate Build Section (conditional)

| Element       | Field                                                | Notes                         |
| ------------- | ---------------------------------------------------- | ----------------------------- |
| Banner        | `alternateBuild.isAlternateBuild`                    | Show only if true             |
| Source Sets   | `alternateBuild.sourceSetNumbers` + `sourceSetNames` | Clickable set links           |
| Sets Required | `alternateBuild.setsRequired`                        | "Requires 3x Set 31168"       |
| Extra Parts   | `alternateBuild.additionalPartsNeeded`               | "+42 additional parts needed" |

### Instructions Card

| Element         | Field                                  | Notes                   |
| --------------- | -------------------------------------- | ----------------------- |
| Format          | `instructionsMetadata.instructionType` | PDF, Studio, LDraw icon |
| Page Count      | `instructionsMetadata.pageCount`       | "148 pages"             |
| File Size       | `instructionsMetadata.fileSize`        | Format as "50 MB"       |
| Download Button | -                                      | Primary CTA             |
| Preview Images  | `instructionsMetadata.previewImages`   | Thumbnail carousel      |

### Metadata Sidebar

| Element      | Field                           | Notes                              |
| ------------ | ------------------------------- | ---------------------------------- |
| Theme        | `theme`                         | Badge with link to theme filter    |
| Subtheme     | `subtheme`                      | Secondary badge                    |
| Tags         | `tags[]`                        | Clickable tag badges               |
| Year         | `releaseYear` or `uploadedDate` | Publication year                   |
| Last Updated | `updatedAt`                     | Relative time "Updated 3 days ago" |

### Set-Specific Section (when type='set')

| Element        | Field         | Notes                          |
| -------------- | ------------- | ------------------------------ |
| Brand          | `brand`       | LEGO logo if LEGO              |
| Set Number     | `setNumber`   | Official number                |
| Release Year   | `releaseYear` | Year badge                     |
| Retired Status | `retired`     | "Retired" or "Available" badge |

## Tasks / Subtasks

- [x] **Task 1: Create Detail Route**
  - [x] Create route `/instructions/$instructionId` in main-app router
  - [x] Configure route params with TanStack Router
  - [x] Create InstructionsDetailModule wrapper in main-app

- [x] **Task 2: Basic Detail Page Layout**
  - [x] Header with back button and title
  - [x] Image gallery section with thumbnails
  - [x] Basic metadata sidebar with piece count, theme, tags
  - [x] Actions (edit, favorite)
  - [x] PDF download button when available

- [x] **Task 3: Image Gallery**
  - [x] Grid of all instruction images using GalleryGrid
  - [x] Click to open lightbox with GalleryLightbox
  - [x] Navigate between images with useLightbox hook

- [ ] **Task 4: Extended Metadata Display**
  - [ ] Designer card with avatar, name, social links
  - [ ] Quick stats bar (parts, minifigs, difficulty, time)
  - [ ] Dimensions card with metric/imperial toggle
  - [ ] Features list with icons

- [ ] **Task 5: Rich Description**
  - [ ] Render sanitized HTML description
  - [ ] Fallback to plain text description
  - [ ] Expandable "Read more" for long descriptions

- [ ] **Task 6: Alternate Build Section**
  - [ ] Conditional display when `isAlternateBuild` is true
  - [ ] Source sets list with links
  - [ ] Parts requirement summary

- [ ] **Task 7: Instructions Download Card**
  - [ ] Format indicator (PDF, Studio, etc.)
  - [ ] File metadata (pages, size)
  - [ ] Preview image carousel
  - [ ] Download button

- [ ] **Task 8: Linked Content** - Deferred
  - [ ] Show linked inspiration images (requires API)
  - [ ] Show if part of any sets (requires API)

## Dev Notes

### Route Structure

```typescript
// routes/instructions/$instructionId.tsx
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/instructions/$instructionId')({
  component: InstructionDetailPage,
  loader: ({ params }) => ({
    instructionId: params.instructionId,
  }),
})
```

### Component Structure

```
InstructionDetailPage/
├── index.tsx                    # Main page layout
├── components/
│   ├── HeaderSection.tsx        # Title, badges, author
│   ├── QuickStatsBar.tsx        # Parts, minifigs, difficulty
│   ├── DesignerCard.tsx         # Designer info + social links
│   ├── DescriptionSection.tsx   # Rich HTML + features
│   ├── DimensionsCard.tsx       # Physical dimensions
│   ├── AlternateBuildBanner.tsx # Source sets info
│   ├── InstructionsCard.tsx     # Download + preview
│   └── MetadataSidebar.tsx      # Tags, theme, dates
└── __tests__/
    └── InstructionDetailPage.test.tsx
```

### HTML Sanitization

```typescript
import DOMPurify from 'dompurify'

function SafeHtml({ html }: { html: string }) {
  const clean = DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li', 'a', 'h2', 'h3'],
    ALLOWED_ATTR: ['href', 'target', 'rel'],
  })
  return <div dangerouslySetInnerHTML={{ __html: clean }} />
}
```

### Unit Toggle Hook

```typescript
function useUnitPreference() {
  const [unit, setUnit] = useState<'metric' | 'imperial'>('metric')

  const formatDimension = (cm?: number, inches?: number) => {
    if (unit === 'metric' && cm) return `${cm} cm`
    if (unit === 'imperial' && inches) return `${inches}"`
    return cm ? `${cm} cm` : inches ? `${inches}"` : null
  }

  return { unit, setUnit, formatDimension }
}
```

### File Size Formatting

```typescript
function formatFileSize(bytes?: number): string {
  if (!bytes) return ''
  if (bytes < 1024) return `${bytes} B`
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
}
```

## Testing

- [x] Route renders with valid ID (29 unit tests)
- [x] Not found state shown for invalid ID
- [x] Lightbox integrates with useLightbox hook
- [x] Back button triggers onBack callback
- [x] Edit button triggers onEdit callback with instruction ID
- [x] Favorite button triggers onFavorite callback
- [x] Loading skeleton displays during fetch
- [x] Error state displays with error message
- [ ] Designer card renders with social links
- [ ] Dimensions toggle between metric/imperial
- [ ] Features list renders correctly
- [ ] Alternate build section shows when applicable
- [ ] Rich HTML description sanitized properly
- [ ] Linked content displays when present (deferred)

## Change Log

| Date       | Version | Description                         | Author    |
| ---------- | ------- | ----------------------------------- | --------- |
| 2025-11-30 | 0.1     | Initial draft                       | SM Agent  |
| 2025-12-05 | 0.2     | Implementation complete             | Dev Agent |
| 2025-12-06 | 0.3     | Added extended metadata UI sections | Claude    |

## Dev Agent Record

### Implementation Summary

Implemented the Instructions Detail Page with full image gallery, metadata display, and lightbox functionality.

### Files Created

- `apps/web/app-instructions-gallery/src/pages/detail-page.tsx` - Main detail page component with loading, error, and not found states
- `apps/web/app-instructions-gallery/src/DetailModule.tsx` - Module wrapper for main-app integration
- `apps/web/app-instructions-gallery/src/pages/__tests__/detail-page.test.tsx` - 29 unit tests
- `apps/web/main-app/src/routes/modules/InstructionsDetailModule.tsx` - Main-app routing wrapper

### Files Modified

- `apps/web/app-instructions-gallery/src/__types__/index.ts` - Added description, images, pdfUrl, updatedAt fields
- `apps/web/app-instructions-gallery/src/index.ts` - Added exports for DetailModule and DetailPage
- `apps/web/app-instructions-gallery/src/pages/main-page.tsx` - Fixed icon prop type, added navigation
- `apps/web/main-app/src/routes/index.ts` - Added instructionDetailRoute
- `packages/core/gallery/src/index.ts` - Fixed duplicate GallerySortOption export

### Architecture Decisions

1. **Module Pattern**: Created DetailModule wrapper in micro-app for ThemeProvider and default handlers, with InstructionsDetailModule in main-app for routing integration
2. **Cross-Module Navigation**: Using `window.location.href` for navigation from gallery to detail page since micro-apps don't have internal routing
3. **Lightbox Integration**: Leveraged existing `useLightbox` hook and `GalleryLightbox` component from @repo/gallery
4. **Data Flow**: Props-based data flow from main-app to micro-app module, preparing for RTK Query integration

### Test Coverage

- 29 unit tests covering all states and interactions
- All tests passing
- Tests cover loading, error, not found, successful render, navigation, edit, favorite actions
