# Story 3.1.28: Database Schema Migration for Edit Support

## Status

Done

## Story

**As a** developer,
**I want** the database schema updated to support edit operations,
**so that** files can be soft-deleted and queries can filter active files.

## Epic Context

This is **Story 0.1 of Epic 0: Package Extraction & Reuse Foundation**.

**EXECUTE FIRST** â€” All other Epic 0 stories and all Epic 1/2 stories depend on this migration being complete.

## Acceptance Criteria

1. Add `deleted_at` column to `moc_files` table (nullable timestamp)
2. Add `updated_at` column to `moc_files` table (default NOW())
3. Create partial index on `deleted_at` for efficient filtering of soft-deleted files
4. Update Drizzle schema in `packages/backend/db/src/schema.ts` to include new columns
5. Migration is backward-compatible (nullable columns, no data changes to existing records)
6. Update existing list/get queries to filter `WHERE deleted_at IS NULL`
7. All existing upload/list tests pass after migration

## Tasks / Subtasks

- [x] **Task 1: Create Drizzle Migration** (AC: 1, 2, 3)
  - [x] Generate migration file in `apps/api/core/database/migrations/app/`
  - [x] Add `deleted_at TIMESTAMP WITH TIME ZONE` (nullable) to `moc_files`
  - [x] Add `updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()` to `moc_files`
  - [x] Create partial index: `CREATE INDEX idx_moc_files_deleted_at ON moc_files (deleted_at) WHERE deleted_at IS NOT NULL`

- [x] **Task 2: Update Drizzle Schema** (AC: 4)
  - [x] Add `deletedAt` column definition to `mocFiles` table in `packages/backend/db/src/schema.ts`
  - [x] Add `updatedAt` column definition with `defaultNow()`
  - [x] Regenerate Drizzle types

- [x] **Task 3: Update Existing Queries** (AC: 5, 6)
  - [x] Update `apps/api/endpoints/moc-instructions/_shared/moc-service.ts` `getMocDetail()` (line ~154) to filter `deletedAt IS NULL` when fetching files
  - [x] Update `apps/api/endpoints/moc-instructions/_shared/moc-file-service.ts` `generateFileDownloadUrl()` (line ~257) to filter `deletedAt IS NULL`
  - [x] Import `isNull` from `drizzle-orm` in updated files
  - Note: `deleteMoc()` intentionally NOT updated - hard deletes should clean up ALL files including soft-deleted ones

- [x] **Task 4: Run Regression Tests** (AC: 7)
  - [x] Run existing upload endpoint tests
  - [x] Run existing list endpoint tests
  - [x] Verify no breaking changes to response shapes

## Dev Notes

### Migration Script

```sql
-- Migration: Add soft-delete and updated_at columns to moc_files
ALTER TABLE moc_files ADD COLUMN deleted_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE moc_files ADD COLUMN updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- Partial index for efficient filtering of soft-deleted files
CREATE INDEX idx_moc_files_deleted_at ON moc_files (deleted_at) WHERE deleted_at IS NOT NULL;

-- NOTE: Slug uniqueness already enforced by existing index:
-- moc_instructions_user_slug_unique ON (user_id, slug)
-- No additional migration needed for slug constraint.
```

### Drizzle Schema Changes

```typescript
// packages/backend/db/src/schema.ts
export const mocFiles = pgTable('moc_files', {
  // ... existing columns
  deletedAt: timestamp('deleted_at', { withTimezone: true }),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow(),
})
```

### Relevant Source Files

| File                                                              | Purpose                                                          |
| ----------------------------------------------------------------- | ---------------------------------------------------------------- |
| `packages/backend/db/src/schema.ts`                               | Drizzle schema definitions                                       |
| `apps/api/core/database/migrations/app/`                          | Migration files                                                  |
| `apps/api/endpoints/moc-instructions/_shared/moc-service.ts`      | MOC service with `getMocDetail()` and `deleteMoc()` file queries |
| `apps/api/endpoints/moc-instructions/_shared/moc-file-service.ts` | File service with `generateFileDownloadUrl()` query              |

### Query Update Pattern

```typescript
// Import isNull from drizzle-orm
import { eq, and, isNull } from 'drizzle-orm'

// Before
const files = await db.select().from(mocFiles).where(eq(mocFiles.mocId, mocId))

// After
const files = await db
  .select()
  .from(mocFiles)
  .where(and(eq(mocFiles.mocId, mocId), isNull(mocFiles.deletedAt)))
```

## Testing

### Test Location

- `apps/api/endpoints/moc-instructions/__tests__/`

### Test Requirements

- Unit: Verify Drizzle schema includes new columns
- Integration: Run existing list/get endpoint tests
- Integration: Verify soft-deleted files are excluded from queries
- Regression: All existing upload tests must pass

## Change Log

| Date       | Version | Description                                                | Author                 |
| ---------- | ------- | ---------------------------------------------------------- | ---------------------- |
| 2025-12-08 | 0.1     | Initial draft from Edit MOC PRD                            | SM Agent               |
| 2025-12-09 | 0.2     | Fixed Task 3 file paths to reference correct service files | Dev Agent (Validation) |
| 2025-12-09 | 1.0     | Implementation complete, all tests pass                    | Dev Agent (James)      |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes

- All 4 tasks completed successfully
- 435 tests pass across 32 test files
- Type checking passes
- Linting passes
- **Important Discovery**: The project has TWO schema files that must be kept in sync:
  1. `packages/backend/db/src/schema.ts` - Shared DB package schema
  2. `apps/api/core/database/schema/index.ts` - API-local schema copy (used by TypeScript)
- **Design Decision**: `deleteMoc()` was intentionally NOT updated to filter soft-deleted files. When hard-deleting a MOC, we want to clean up ALL associated S3 files including any that were soft-deleted during editing. The AC 6 specifies "list/get queries" which are for user-facing operations, not cleanup operations.

### File List

- `apps/api/core/database/migrations/app/0004_edit_support.sql` - **New** migration file
- `packages/backend/db/src/schema.ts` - **Modified** (add deletedAt, updatedAt columns to mocFiles)
- `apps/api/core/database/schema/index.ts` - **Modified** (add deletedAt, updatedAt columns to mocFiles - API local schema)
- `apps/api/endpoints/moc-instructions/_shared/moc-service.ts` - **Modified** (add isNull import, filter deletedAt in getMocDetail)
- `apps/api/endpoints/moc-instructions/_shared/moc-file-service.ts` - **Modified** (add isNull import, filter deletedAt in generateFileDownloadUrl)

## Definition of Done Checklist

### 1. Requirements Met

- [x] All functional requirements specified in the story are implemented
- [x] All acceptance criteria defined in the story are met (AC 1-7)

### 2. Coding Standards & Project Structure

- [x] All new/modified code strictly adheres to Operational Guidelines
- [x] All new/modified code aligns with Project Structure
- [x] Adherence to Tech Stack (Drizzle ORM, PostgreSQL)
- [x] Adherence to Data Models (schema changes follow existing patterns)
- [x] Basic security best practices applied (nullable columns, no hardcoded values)
- [x] No new linter errors or warnings introduced
- [x] Code is well-commented where necessary

### 3. Testing

- [x] All required unit tests pass (435 tests across 32 files)
- [x] All required integration tests pass
- [x] All tests pass successfully
- [N/A] Test coverage meets project standards (no new tests required - regression only)

### 4. Functionality & Verification

- [x] Functionality verified via type checking and test execution
- [x] Edge cases considered (soft-delete filtering, hard-delete cleanup)

### 5. Story Administration

- [x] All tasks within the story file are marked as complete
- [x] Clarifications documented (deleteMoc design decision)
- [x] Story wrap up section completed

### 6. Dependencies, Build & Configuration

- [x] Project builds successfully without errors
- [x] Project linting passes
- [N/A] No new dependencies added
- [N/A] No new environment variables introduced

### 7. Documentation

- [x] Inline code comments added for query changes
- [N/A] No user-facing documentation needed
- [x] Technical note added about dual schema files

### Final Confirmation

- [x] I, the Developer Agent, confirm that all applicable items above have been addressed
