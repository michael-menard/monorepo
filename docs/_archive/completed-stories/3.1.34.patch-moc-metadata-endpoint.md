# Story 3.1.34: PATCH MOC Metadata Endpoint

## GitHub Issue
- Issue: #255
- URL: https://github.com/michael-menard/monorepo/issues/255
- Status: Todo

## Status

Done

## Story

**As an** owner,
**I want** to update my MOC metadata without re-uploading files,
**so that** I can quickly fix titles, descriptions, or tags.

## Epic Context

This is **Story 1.2 of Epic 1: Backend Edit Pipeline**.

## Blocked By

- All Epic 0 stories (3.1.28-3.1.32)
- Story 3.1.33: GET MOC for Edit Endpoint (for consistent patterns)

## Acceptance Criteria

1. PATCH `/mocs/:mocId` accepts partial metadata updates
2. Validates: title (required if provided), description, tags, theme
3. Slug update triggers uniqueness check (owner scope); 409 with suggestion on conflict
4. Returns 401/403/404 appropriately
5. Updates `updatedAt` timestamp
6. Re-indexes in OpenSearch (synchronous, fail-open with warning log)

## Tasks / Subtasks

- [x] **Task 1: Create Handler Structure** (AC: 1)
  - [x] Create `apps/api/endpoints/moc-instructions/edit/handler.ts`
  - [x] Create Zod request schema for partial metadata
  - [x] Create Zod response schema

- [x] **Task 2: Implement Validation** (AC: 2)
  - [x] Validate title min/max length if provided
  - [x] Validate description max length
  - [x] Validate tags array (max count, valid strings)
  - [x] Validate theme enum if provided

- [x] **Task 3: Implement Slug Conflict Handling** (AC: 3)
  - [x] If slug in request, check uniqueness within owner's MOCs
  - [x] Exclude current MOC from uniqueness check
  - [x] On conflict: return 409 with suggested alternative
  - [x] Use `findAvailableSlug` from `@/core/utils/slug`

- [x] **Task 4: Implement Auth/Owner Checks** (AC: 4)
  - [x] Verify JWT token (401)
  - [x] Verify ownership (403 with no existence leak)
  - [x] Verify MOC exists (404)

- [x] **Task 5: Update Database** (AC: 5)
  - [x] Update only provided fields
  - [x] Always update `updatedAt` to now
  - [x] Use single UPDATE query

- [x] **Task 6: OpenSearch Re-indexing** (AC: 6)
  - [x] After DB commit, update OpenSearch document
  - [x] Update: title, description, tags, theme, slug, updatedAt
  - [x] On failure: log warning, return success (fail-open)

- [x] **Task 7: Add Observability**
  - [x] Log request with correlationId, ownerId, mocId
  - [x] Log fields being updated
  - [x] Log OpenSearch failures as warnings

## Dev Notes

### Request Schema

```typescript
const PatchMocRequestSchema = z.object({
  title: z.string().min(1).max(100).optional(),
  description: z.string().max(2000).optional(),
  tags: z.array(z.string().max(30)).max(10).optional(),
  theme: z.string().max(50).nullable().optional(),
  slug: z.string().regex(/^[a-z0-9-]+$/).max(100).optional(),
})
```

### Slug Conflict Response

```typescript
const SlugConflictResponseSchema = z.object({
  code: z.literal('SLUG_CONFLICT'),
  message: z.string(),
  suggestedSlug: z.string(),
  correlationId: z.string(),
})

// Example response
{
  "code": "SLUG_CONFLICT",
  "message": "The slug 'king-mearas-castle' is already used by another of your MOCs",
  "suggestedSlug": "king-mearas-castle-2",
  "correlationId": "req-abc123"
}
```

### OpenSearch Update Pattern

```typescript
// After successful DB update
try {
  await opensearch.update({
    index: 'moc-instructions',
    id: mocId,
    body: {
      doc: {
        title: updatedMoc.title,
        description: updatedMoc.description,
        tags: updatedMoc.tags,
        theme: updatedMoc.theme,
        slug: updatedMoc.slug,
        updatedAt: updatedMoc.updatedAt,
      },
    },
  })
} catch (error) {
  logger.warn('OpenSearch update failed, reconciliation job will catch up', {
    mocId,
    error: error instanceof Error ? error.message : 'Unknown error',
    correlationId,
  })
  // Continue - don't fail the edit operation
}
```

### Handler Pattern

```typescript
export const handler = async (event: APIGatewayEvent) => {
  const { mocId } = event.pathParameters
  const userId = event.requestContext.authorizer?.userId
  const body = PatchMocRequestSchema.parse(JSON.parse(event.body))

  // Auth checks...

  // Slug uniqueness check
  if (body.slug) {
    const existingWithSlug = await db
      .select({ id: mocInstructions.id })
      .from(mocInstructions)
      .where(
        and(
          eq(mocInstructions.userId, userId),
          eq(mocInstructions.slug, body.slug),
          ne(mocInstructions.id, mocId) // Exclude current MOC
        )
      )
      .limit(1)

    if (existingWithSlug.length > 0) {
      const suggestion = findAvailableSlug(body.slug, existingSlugs)
      return response409({
        code: 'SLUG_CONFLICT',
        message: `The slug '${body.slug}' is already used`,
        suggestedSlug: suggestion,
      })
    }
  }

  // Update database
  const updated = await db
    .update(mocInstructions)
    .set({
      ...body,
      updatedAt: new Date(),
    })
    .where(eq(mocInstructions.id, mocId))
    .returning()

  // Re-index in OpenSearch (fail-open)
  await reindexMoc(updated[0])

  return response200(updated[0])
}
```

### Existing Patterns

- `apps/api/endpoints/moc-instructions/_shared/moc-service.ts` - MOC operations
- `apps/api/endpoints/moc-instructions/_shared/opensearch-moc.ts` - OpenSearch indexing

## Testing

### Test Location
- `apps/api/endpoints/moc-instructions/edit/__tests__/handler.test.ts`

### Test Requirements
- Unit: Zod schema validation for all field combinations
- Integration: 401 for unauthenticated
- Integration: 403 for non-owner
- Integration: 404 for non-existent MOC
- Integration: 409 for slug conflict with suggestion
- Integration: 200 with updated data
- Integration: OpenSearch receives update (mock OpenSearch)
- Unit: OpenSearch failure doesn't fail request

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 0.1 | Initial draft from Edit MOC PRD | SM Agent |
| 2025-12-09 | 1.0 | Implementation complete - all tests passing | Claude Opus 4.5 |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

N/A

### Completion Notes

Implementation completed with all 17 unit tests passing. Key implementation details:

1. **Zod v4 Compatibility**: Handler uses `bodyResult.error.issues` with fallback to `.errors` for backwards compatibility
2. **Strict Schema Validation**: Uses `.strict()` on request schema to reject unknown fields
3. **Slug Conflict Detection**: Checks uniqueness within owner's MOCs (excluding current MOC) before update
4. **Fail-Open OpenSearch**: Errors are logged as warnings but don't fail the request
5. **Response Structure**: Uses `@/core/utils/responses` for consistent error/success responses
6. **Auth Pattern**: JWT via Cognito authorizer with manual userId extraction from claims

Test coverage includes:
- Authentication (401 for unauthenticated)
- Authorization (403 for non-owner, 404 for non-existent/invalid UUID)
- Validation (empty body, title/description length, tags count, slug format, unknown fields)
- Slug conflict (409 with suggested alternative)
- Successful updates (title, multiple fields, null values, slug without conflict)
- OpenSearch fail-open behavior
- Response structure validation

### File List

- `apps/api/endpoints/moc-instructions/edit/handler.ts` - New (334 lines)
- `apps/api/endpoints/moc-instructions/__tests__/edit.handler.test.ts` - New (465 lines, 17 tests)
- `apps/api/stacks/functions/moc-instructions.yml` - Modified (added patchMetadata function)
