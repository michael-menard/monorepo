# Story 1.35: Page Transition Tests

## Status

Ready for Review

## Story

**As a** developer,
**I want** tests for page transition functionality,
**so that** loading states work correctly.

## Acceptance Criteria

1. ⬜ Tests for PageTransitionSpinner component
2. ⬜ Tests for useDelayedShow hook
3. ⬜ Tests for navigation state tracking
4. ⬜ Tests for router integration
5. ⬜ Integration tests for full transition flow

## Tasks / Subtasks

- [x] **Task 1: Spinner Component Tests** (AC: 1)
  - [x] Test renders when isNavigating true
  - [x] Test hidden when isNavigating false
  - [x] Test animation classes applied

- [x] **Task 2: Delayed Show Hook Tests** (AC: 2)
  - [x] Test doesn't show before delay
  - [x] Test shows after delay
  - [x] Test hides when condition becomes false
  - [x] Test cleans up timeout

- [x] **Task 3: Navigation State Tests** (AC: 3)
  - [x] Test setNavigating action
  - [x] Test selectIsNavigating selector
  - [x] Test state updates correctly

- [x] **Task 4: Router Integration Tests** (AC: 4)
  - [x] Test router state subscription
  - [x] Test loading state detection
  - [x] Mock router for tests

- [x] **Task 5: E2E Tests** (AC: 5)
  - [x] Test spinner appears during navigation
  - [x] Test spinner disappears after load
  - [x] Test delay threshold works

## Dev Notes

### Test File Locations

- `components/__tests__/PageTransitionSpinner.test.tsx`
- `hooks/__tests__/useDelayedShow.test.ts`
- `store/slices/__tests__/globalUISlice.test.ts`

### Spinner Component Test

```typescript
import { render, screen } from '@testing-library/react'
import { PageTransitionSpinner } from '../PageTransitionSpinner'

// Mock useRouterState
vi.mock('@tanstack/react-router', () => ({
  useRouterState: vi.fn(),
}))

describe('PageTransitionSpinner', () => {
  it('renders when navigating', () => {
    vi.mocked(useRouterState).mockReturnValue({ isLoading: true })

    render(<PageTransitionSpinner />)
    expect(screen.getByRole('progressbar')).toBeInTheDocument()
  })

  it('hidden when not navigating', () => {
    vi.mocked(useRouterState).mockReturnValue({ isLoading: false })

    render(<PageTransitionSpinner />)
    expect(screen.queryByRole('progressbar')).not.toBeInTheDocument()
  })
})
```

### Delayed Show Hook Test

```typescript
import { renderHook, act } from '@testing-library/react'
import { useDelayedShow } from '../useDelayedShow'

describe('useDelayedShow', () => {
  beforeEach(() => {
    vi.useFakeTimers()
  })

  afterEach(() => {
    vi.useRealTimers()
  })

  it('shows after delay', () => {
    const { result } = renderHook(() => useDelayedShow(true, 300))

    expect(result.current).toBe(false)

    act(() => {
      vi.advanceTimersByTime(300)
    })

    expect(result.current).toBe(true)
  })

  it('does not show if condition clears before delay', () => {
    const { result, rerender } = renderHook(({ active }) => useDelayedShow(active, 300), {
      initialProps: { active: true },
    })

    act(() => {
      vi.advanceTimersByTime(200)
    })

    rerender({ active: false })

    act(() => {
      vi.advanceTimersByTime(200)
    })

    expect(result.current).toBe(false)
  })
})
```

### Integration Test

```typescript
describe('Page Transition Flow', () => {
  it('shows spinner during slow navigation', async () => {
    render(<App />, { wrapper: TestProviders })

    // Trigger navigation to slow route
    fireEvent.click(screen.getByText('Heavy Page'))

    // Wait for delay threshold
    await waitFor(() => {
      expect(screen.getByRole('progressbar')).toBeVisible()
    }, { timeout: 400 })

    // Wait for navigation complete
    await waitFor(() => {
      expect(screen.queryByRole('progressbar')).not.toBeInTheDocument()
    })
  })
})
```

### Testing

Meta: This story is about testing!

- Run all transition-related tests
- Verify coverage
- All tests pass

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20250929

### File List

| File | Action |
| ---- | ------ |
| src/components/PageTransitionSpinner/__tests__/PageTransitionSpinner.test.tsx | Pre-existing (21 tests) |
| src/hooks/__tests__/useDelayedShow.test.ts | Pre-existing (12 tests) |
| src/store/slices/__tests__/globalUISlice.test.ts | Pre-existing (28 tests) |
| src/hooks/__tests__/useNavigationSync.test.tsx | Created (10 tests) |
| apps/web/playwright/features/navigation/page-transitions.feature | Created |
| apps/web/playwright/steps/navigation.steps.ts | Created |

### Debug Log References

None

### Completion Notes

- Tasks 1-3 had pre-existing tests that all pass (61 tests total)
- Task 4: Created new useNavigationSync.test.tsx with 10 tests for router integration
- Task 5: Created E2E test feature file and step definitions for page transitions
- All 71 unit tests pass
- Lint passes

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
| 2025-11-30 | 0.2     | Implementation complete | Dev Agent |
