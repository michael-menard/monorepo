# Story 3.1.32: Extract Upload Client Package

## GitHub Issue
- Issue: #253
- URL: https://github.com/michael-menard/monorepo/issues/253
- Status: Todo

## Status

Done

## Story

**As a** developer,
**I want** browser upload utilities in `@repo/upload-client`,
**so that** all frontend upload features share XHR/progress logic.

## Epic Context

This is **Story 0.5 of Epic 0: Package Extraction & Reuse Foundation**.

**Depends on:** Story 3.1.28 (DB Schema Migration)

This is the final story in Epic 0. Upon completion, Epic 1 (Backend Edit Pipeline) and Epic 2 (Edit UX & Frontend) can begin.

## Acceptance Criteria

1. Create `packages/core/upload-client` package (browser-only)
2. Move logic from `apps/web/main-app/src/services/api/uploadClient.ts`
3. Export: `uploadFile`, `uploadToPresignedUrl`, `createUploadManager`, related types
4. Include AbortController and progress event handling
5. Update main-app imports to use `@repo/upload-client`

## Tasks / Subtasks

- [x] **Task 1: Create Package Structure** (AC: 1)
  - [x] Create `packages/core/upload-client/` directory
  - [x] Create `package.json` with name `@repo/upload-client`
  - [x] Create `tsconfig.json` with browser target
  - [x] Add package to `pnpm-workspace.yaml` (already included via `packages/core/*`)

- [x] **Task 2: Move Upload Functions** (AC: 2, 3)
  - [x] Move `uploadToPresignedUrl` function
  - [x] Move `uploadFile` function (full session flow)
  - [x] Move `createUploadManager` for concurrent uploads
  - [x] Move related types (`UploadProgress`, `UploadOptions`, etc.)

- [x] **Task 3: Implement Progress/Abort** (AC: 4)
  - [x] Ensure `AbortController` support for cancellation
  - [x] Ensure `onProgress` callback with `{ loaded, total, percent }`
  - [x] Ensure `onComplete`, `onError` callbacks
  - [x] XHR-based (not fetch) for progress event support

- [x] **Task 4: Export Package API** (AC: 3)
  - [x] Create `src/index.ts` with all exports
  - [x] Export `uploadToPresignedUrl(url: string, file: File, options?: UploadOptions)`
  - [x] Export `uploadFile(sessionConfig, fileConfig)` for full flow
  - [x] Export `createUploadManager(options)` for batch uploads
  - [x] Export types: `UploadProgress`, `UploadResult`, `UploadOptions`, `UploadManagerOptions`

- [x] **Task 5: Update Consumer Imports** (AC: 5)
  - [x] Update `apps/web/main-app/src/hooks/useUploadManager.ts`
  - [x] Update test files to use new package
  - [x] Deprecate old uploadClient.ts (re-exports from package)

- [x] **Task 6: Verify Regression**
  - [x] Run `pnpm --filter main-app build`
  - [x] Run upload-related component tests (38 tests passing)
  - [x] Run upload-client package tests (28 tests passing)

## Dev Notes

### Package Structure

```
packages/core/upload-client/
├── src/
│   ├── index.ts           # Package exports
│   ├── xhr.ts             # XHR-based upload with progress
│   ├── manager.ts         # Concurrent upload manager
│   └── types.ts           # Type definitions
├── package.json
├── tsconfig.json
└── tsconfig.build.json
```

### Core Types

```typescript
// packages/core/upload-client/src/types.ts
export interface UploadProgress {
  loaded: number
  total: number
  percent: number
}

export interface UploadOptions {
  onProgress?: (progress: UploadProgress) => void
  onComplete?: (result: UploadResult) => void
  onError?: (error: Error) => void
  signal?: AbortSignal
  headers?: Record<string, string>
}

export interface UploadResult {
  success: boolean
  etag?: string
  error?: string
}

export interface UploadManagerOptions {
  maxConcurrent: number
  onFileProgress?: (fileId: string, progress: UploadProgress) => void
  onFileComplete?: (fileId: string, result: UploadResult) => void
  onAllComplete?: () => void
}
```

### XHR Upload Function

```typescript
// packages/core/upload-client/src/xhr.ts
export const uploadToPresignedUrl = (
  url: string,
  file: File,
  options: UploadOptions = {}
): Promise<UploadResult> => {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest()

    // Progress handler
    xhr.upload.onprogress = event => {
      if (event.lengthComputable && options.onProgress) {
        options.onProgress({
          loaded: event.loaded,
          total: event.total,
          percent: Math.round((event.loaded / event.total) * 100),
        })
      }
    }

    // Completion handler
    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        const etag = xhr.getResponseHeader('ETag')
        resolve({ success: true, etag: etag ?? undefined })
      } else {
        reject(new Error(`Upload failed: ${xhr.status}`))
      }
    }

    xhr.onerror = () => reject(new Error('Network error'))

    // Abort support
    if (options.signal) {
      options.signal.addEventListener('abort', () => xhr.abort())
    }

    xhr.open('PUT', url)
    xhr.setRequestHeader('Content-Type', file.type)

    if (options.headers) {
      Object.entries(options.headers).forEach(([key, value]) => {
        xhr.setRequestHeader(key, value)
      })
    }

    xhr.send(file)
  })
}
```

### Upload Manager

```typescript
// packages/core/upload-client/src/manager.ts
export const createUploadManager = (options: UploadManagerOptions) => {
  const queue: UploadTask[] = []
  const active = new Map<string, AbortController>()
  let inProgress = 0

  const processQueue = async () => {
    while (queue.length > 0 && inProgress < options.maxConcurrent) {
      const task = queue.shift()!
      inProgress++
      // ... process task
    }
  }

  return {
    addFile: (fileId: string, url: string, file: File) => {
      queue.push({ fileId, url, file })
      processQueue()
    },
    cancelFile: (fileId: string) => {
      active.get(fileId)?.abort()
      active.delete(fileId)
    },
    cancelAll: () => {
      active.forEach(controller => controller.abort())
      active.clear()
      queue.length = 0
    },
  }
}
```

### Why XHR (not Fetch)

- **Progress events**: `fetch` doesn't support upload progress
- **Abort support**: Both support AbortController, but XHR progress is critical
- **Browser compatibility**: XHR is universally supported

### Existing Upload Client Location

- `apps/web/main-app/src/services/api/uploadClient.ts`
- `apps/web/main-app/src/hooks/useUploadManager.ts`

## Testing

### Test Location
- `packages/core/upload-client/src/__tests__/` (new)

### Test Requirements
- Unit: Mock XHR for upload functions
- Unit: Upload manager queue/concurrency logic
- Unit: Abort signal handling
- Regression: Upload components work with extracted package

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 0.1 | Initial draft from Edit MOC PRD | SM Agent |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

N/A

### Completion Notes

- Created `@repo/upload-client` package with XHR-based upload utilities
- Implemented `uploadFile` and `uploadToPresignedUrl` with progress events
- Implemented `createUploadManager` for concurrent batch uploads
- Changed `onProgress` callback signature from `(loaded, total)` to `{ loaded, total, percent }`
- Used `||` instead of `??` for content type fallback to handle empty string `file.type`
- Updated consumers to use new package (useUploadManager.ts)
- Created deprecated re-export wrapper in old location for backwards compatibility
- All 66 tests passing (28 package + 38 consumer)
- Build succeeds

### File List

- `packages/core/upload-client/package.json` - New
- `packages/core/upload-client/tsconfig.json` - New
- `packages/core/upload-client/vitest.config.ts` - New
- `packages/core/upload-client/src/index.ts` - New
- `packages/core/upload-client/src/types.ts` - New
- `packages/core/upload-client/src/xhr.ts` - New
- `packages/core/upload-client/src/manager.ts` - New
- `packages/core/upload-client/src/__tests__/xhr.test.ts` - New
- `packages/core/upload-client/src/__tests__/manager.test.ts` - New
- `apps/web/main-app/package.json` - Modified (added @repo/upload-client dependency)
- `apps/web/main-app/src/services/api/uploadClient.ts` - Modified (deprecated re-export)
- `apps/web/main-app/src/hooks/useUploadManager.ts` - Modified (imports from @repo/upload-client)
- `apps/web/main-app/src/hooks/__tests__/useUploadManager.test.tsx` - Modified (updated mock)
- `apps/web/main-app/src/services/api/__tests__/uploadClient.test.ts` - Modified (updated assertions)
