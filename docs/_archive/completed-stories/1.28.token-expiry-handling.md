# Story 1.28: Token Expiry Handling

## Status

Ready for Review

## Story

**As a** user,
**I want** my session to refresh automatically,
**so that** I don't get logged out unexpectedly.

## Acceptance Criteria

1. ✅ Detect token expiring soon (5 min before expiry)
2. ✅ Trigger Amplify token refresh
3. ✅ Update Redux with new tokens
4. ✅ Handle refresh failure gracefully
5. ✅ Show notification if refresh fails

## Tasks / Subtasks

- [x] **Task 1: Analyze existing infrastructure** (AC: All)
  - [x] Review AuthProvider Hub listeners
  - [x] Review CognitoTokenManager capabilities
  - [x] Identify what's missing

- [x] **Task 2: Create useTokenRefresh hook** (AC: 1, 2, 3)
  - [x] Create hook to check expiry every minute
  - [x] Use isTokenExpired() with 5-minute threshold
  - [x] Call refreshTokens() from AuthContext
  - [x] Leverage existing Hub listener for Redux updates

- [x] **Task 3: Integrate hook into App** (AC: All)
  - [x] Add useTokenRefresh() to InnerApp component
  - [x] Hook runs for all authenticated users

- [x] **Task 4: Add comprehensive tests** (AC: All)
  - [x] Test expiry detection at threshold
  - [x] Test interval checking every minute
  - [x] Test successful refresh
  - [x] Test failed refresh with toast notification
  - [x] Test cleanup on unmount

- [x] **Task 5: Update story documentation**
  - [x] Mark ACs complete
  - [x] Add Dev Agent Record
  - [x] Add Change Log

## Dev Notes

### Token Expiry Watcher

**File:** `apps/web/main-app/src/hooks/useTokenRefresh.ts`

```typescript
import { useEffect } from 'react'
import { fetchAuthSession } from '@aws-amplify/auth'
import { useAppDispatch, useAppSelector } from '@/store/hooks'
import { updateTokens, setUnauthenticated, selectAuth } from '@/store/slices/authSlice'
import { isTokenExpired, getTokenExpiration } from '@/lib/jwt'
import { useToast } from '@repo/ui'

const REFRESH_THRESHOLD_SECONDS = 5 * 60 // 5 minutes

export function useTokenRefresh() {
  const dispatch = useAppDispatch()
  const { isAuthenticated, tokens } = useAppSelector(selectAuth)
  const { toast } = useToast()

  useEffect(() => {
    if (!isAuthenticated || !tokens?.accessToken) return

    const checkAndRefresh = async () => {
      // Check if token expires within threshold
      if (isTokenExpired(tokens.accessToken!, REFRESH_THRESHOLD_SECONDS)) {
        try {
          const session = await fetchAuthSession({ forceRefresh: true })

          dispatch(
            updateTokens({
              accessToken: session.tokens?.accessToken?.toString(),
              idToken: session.tokens?.idToken?.toString(),
            }),
          )
        } catch (error) {
          logger.error('Token refresh failed', { error })
          toast({
            title: 'Session Expired',
            description: 'Please sign in again.',
            variant: 'destructive',
          })
          dispatch(setUnauthenticated())
        }
      }
    }

    // Check immediately
    checkAndRefresh()

    // Check every minute
    const interval = setInterval(checkAndRefresh, 60 * 1000)
    return () => clearInterval(interval)
  }, [isAuthenticated, tokens?.accessToken, dispatch, toast])
}
```

### Usage in App

```typescript
function App() {
  useTokenRefresh() // Hook at app level
  return <RouterProvider router={router} />
}
```

### Amplify Hub Listener Alternative

```typescript
Hub.listen('auth', ({ payload }) => {
  if (payload.event === 'tokenRefresh') {
    // Tokens were refreshed automatically
    const tokens = payload.data.tokens
    dispatch(
      updateTokens({
        accessToken: tokens.accessToken.toString(),
        idToken: tokens.idToken.toString(),
      }),
    )
  }
  if (payload.event === 'tokenRefresh_failure') {
    // Refresh failed
    dispatch(setUnauthenticated())
  }
})
```

### Testing

- Test expiry detection at threshold
- Test successful refresh updates state
- Test failed refresh logs out user
- Test notification shows on failure

## Dev Agent Record

### Implementation Approach

Leveraged existing token refresh infrastructure instead of building from scratch:
- **AuthProvider Hub listener** already handles `tokenRefresh` and `tokenRefresh_failure` events
- **CognitoTokenManager** already has expiry detection and automatic refresh on API calls
- **Missing piece:** Proactive checking to refresh BEFORE user makes API call

Created lightweight `useTokenRefresh` hook that:
- Checks token expiry every minute using existing `isTokenExpired()` from `jwt.ts`
- Triggers refresh when token expires within 5 minutes (300 seconds)
- Calls existing `refreshTokens()` from AuthContext
- Shows toast notification on failure
- Leverages existing Hub listener to update Redux automatically

### Key Changes

1. **Created `useTokenRefresh` hook** (`apps/web/main-app/src/hooks/useTokenRefresh.ts`):
   - Checks `isTokenExpired(accessToken, 300)` every 60 seconds
   - Calls `refreshTokens()` from AuthContext when threshold reached
   - Shows toast with "Session Expired" message on failure
   - Cleans up interval on unmount or logout
   - Comprehensive JSDoc documentation

2. **Integrated hook into App** (`apps/web/main-app/src/App.tsx`):
   - Added `useTokenRefresh()` call to `InnerApp` component
   - Runs at app level for all authenticated users
   - Automatic cleanup when user logs out

3. **Added comprehensive tests** (`apps/web/main-app/src/hooks/__tests__/useTokenRefresh.test.tsx`):
   - 11 tests covering all scenarios
   - Tests initialization, expiry detection, interval checking, error handling, cleanup
   - Uses fake timers to test interval behavior
   - All tests passing

### How It Works

**Token Refresh Flow:**
1. `useTokenRefresh` hook checks expiry every minute
2. When token expires within 5 minutes, calls `refreshTokens()`
3. `refreshTokens()` calls Amplify `fetchAuthSession({ forceRefresh: true })`
4. Amplify refreshes tokens and emits `tokenRefresh` Hub event
5. AuthProvider Hub listener catches event and updates Redux with new tokens
6. CognitoTokenManager also gets updated with new tokens

**Error Handling:**
1. If refresh fails, Amplify emits `tokenRefresh_failure` Hub event
2. AuthProvider Hub listener catches event and logs out user
3. `useTokenRefresh` hook also shows toast notification to user

### Test Coverage

- **11 tests, all passing**
- Initialization tests (unauthenticated users, missing tokens)
- Expiry detection tests (immediate check, threshold detection)
- Interval checking tests (every minute, trigger on interval)
- Error handling tests (toast notification, graceful handling)
- Cleanup tests (unmount, logout)

### Files Modified

- `apps/web/main-app/src/App.tsx` - Added `useTokenRefresh()` call

### Files Created

- `apps/web/main-app/src/hooks/useTokenRefresh.ts` - Token refresh hook
- `apps/web/main-app/src/hooks/__tests__/useTokenRefresh.test.tsx` - Comprehensive tests

## Change Log

| Date       | Version | Description                                | Author   |
| ---------- | ------- | ------------------------------------------ | -------- |
| 2025-12-01 | 1.0     | Implemented token expiry handling (1.28)   | AI Agent |
| 2025-11-28 | 0.1     | Initial draft                              | SM Agent |
