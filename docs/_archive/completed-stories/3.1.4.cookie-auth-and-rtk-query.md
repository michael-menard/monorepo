# Story 3.1.4: Cookie-Based Auth for API Client (RTK Query + XHR)

## Status

Done

## Story

As a platform,
I want all frontend API calls to use HttpOnly cookie-based auth,
so tokens are never exposed to JavaScript and requests carry the correct credentials and headers by default.

## Acceptance Criteria

1. RTK Query base configuration

- All requests send credentials (cookies) via `credentials: 'include'`.
- Do NOT set `Authorization` headers (no Bearer tokens in JS).
- Default headers: `Accept: application/json`. Only set `Content-Type: application/json` for JSON bodies; allow endpoints to override for non-JSON (e.g., uploads).

2. Upload XHR configuration

- All uploader XHR requests MUST set `withCredentials = true`.
- For part PUTs to API: set `Content-Type: application/octet-stream` and `Accept: application/json`.

3. CSRF readiness (optional; feature-flagged)

- If backend enables CSRF, propagate `X-CSRF-Token` for unsafe methods (POST/PUT/PATCH/DELETE) from a trusted source (cookie or meta tag).
- Tests cover presence/omission when the flag is enabled/disabled.

4. CORS & cookie attributes (coordination note)

- Document backend requirements: `Set-Cookie` with HttpOnly, Secure, and SameSite (Lax for same-site or None+Secure for cross-site). CORS must allow credentials for permitted origins.

5. Tests

- Unit: RTK base query sends `credentials: 'include'` and does not add `Authorization`.
- Unit: Upload client sets `withCredentials` and expected headers for binary PUTs.
- Integration (mock server): without cookie → 401; with cookie → 200.

6. Error handling semantics

- 401 Unauthorized: prompt re-auth (login), do not retry blindly.
- 403 Forbidden (non-owner): show permission error UI.
- 404 Not Found: show not-found UI.
- Tests (MSW): assert 401→reauth, 403→permission, 404→not-found.

## Tasks / Subtasks

- [x] Update RTK base query in `packages/core/api-client/src/rtk/base-query.ts`:
  - [x] Set `credentials: 'include'` globally.
  - [x] Remove token injection (`Authorization: Bearer ...`); support optional custom headers without auth.
  - [x] Keep `Accept: application/json`; avoid setting `Content-Type` unless JSON.
  - [x] Add optional CSRF token support (feature-flagged via `enableCsrf` and `getCsrfToken`).
- [x] Update authenticated helpers in `packages/core/api-client/src/auth/rtk-auth-integration.ts` and any `create*Api` wrappers to use cookie-based auth only.
- [x] Update uploader client (3.1.10/3.1.18) to use `xhr.withCredentials = true` and binary headers for part uploads.
- [ ] Update docs (README/MIGRATION) to reflect cookie-based auth pattern and remove Bearer examples.
- [x] Ensure baseQuery/error transforms surface 401/403/404 distinctly; map to login/permission/not-found UI.
  - [x] Updated `packages/core/api-client/src/retry/error-handling.ts` with `isNonRetryableStatus()` helper.
  - [x] Updated `packages/core/api-client/src/retry/retry-logic.ts` to never retry 401/403/404.
- [x] Tests: unit + integration per AC (see `packages/core/api-client/src/test/cookie-auth-and-rtk-query.test.ts`).

## Dev Notes

- No tokens in localStorage/sessionStorage. Use cookie-based session with short TTL + refresh.
- Logging via `@repo/logger`; Zod-first schemas for client configs where applicable.
- Coordinate with backend to ensure `Access-Control-Allow-Credentials: true` and exact `Access-Control-Allow-Origin` (no `*`).

## Change Log

| Date       | Version | Description                                                        | Author |
| ---------- | ------- | ------------------------------------------------------------------ | ------ |
| 2025-12-06 | 0.1     | Initial draft (cookie auth + RTK Query setup)                      | SM     |
| 2025-12-06 | 1.0     | Implemented: cookie-based auth, CSRF support, 401/403/404 handling | AI     |
