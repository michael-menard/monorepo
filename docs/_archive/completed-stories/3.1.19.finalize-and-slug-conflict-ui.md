# Story 3.1.19: Finalize & Slug Conflict (UI)

## Status

Ready for Review

## Story

As a creator,
I want to resolve finalize errors in-place,
so I can complete publishing without re-uploading.

## Acceptance Criteria

1. Finalize gating

- Disable until required PDF success and form valid; button shows busy; idempotent double-click (3.1.7).

2. 409 Conflict (duplicate slug)

- Show modal with suggested slug (from API 3.1.14); allow edit and re-finalize without re-uploads.

3. 429 Rate limit

- Banner with countdown using retryAfterSeconds; disable finalize during countdown (3.1.6).

4. Per-file validation errors (3.1.8)

- Highlight affected files; show reason (magic-bytes/type); allow selective retry.

5. Tests

- Integration: 409 flow; 429 countdown; per-file error mapping.

## Tasks / Subtasks

- [x] Finalize action wiring and UI states
- [x] Conflict modal; rate-limit banner; per-file error rendering
- [x] Tests (integration)

## Dev Notes

- Map server error contract (3.1.21) to friendly UI copy.

### Auth, Cookies, and CSRF

- Cookie-based (HttpOnly) session auth.
- Frontend MUST send `credentials: 'include'` and MUST NOT send `Authorization` headers.
- Cookie attributes: `HttpOnly`; `Secure`; `SameSite=Lax` (recommended) or `SameSite=None; Secure` when API is on a different site/domain.
- CORS: `Access-Control-Allow-Credentials: true`; `Access-Control-Allow-Origin` must be the exact client origin (no `*`). Include `Vary: Origin`.
- Responses are JSON; clients send `Accept: application/json`.
- CSRF for unsafe methods (POST/PUT/PATCH/DELETE): require `X-CSRF-Token` and verify server-side (double-submit cookie or session-bound token). GET endpoints do not require CSRF.

Ensure:

- RTK Query uses `credentials: 'include'` and does not set `Authorization`.
- XHR uploads use `withCredentials = true` and appropriate `Content-Type` (e.g., `application/octet-stream` for binary part uploads).
- Backend sets cookies with `HttpOnly`; `Secure`; `SameSite` (Lax or None+Secure) and CORS allows credentials for the exact origin.
- Optional `X-CSRF-Token` header is included on unsafe methods when CSRF is enabled.

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

| File                                                                                  | Action   | Description                                             |
| ------------------------------------------------------------------------------------- | -------- | ------------------------------------------------------- |
| apps/web/main-app/src/services/api/finalizeClient.ts                                  | Created  | Finalize API client with 409/429/file error handling    |
| apps/web/main-app/src/components/Uploader/ConflictModal/index.tsx                     | Modified | Added suggestedSlug and onUseSuggested props            |
| apps/web/main-app/src/routes/pages/InstructionsNewPage.tsx                            | Modified | Wired up finalize flow with error handling              |
| apps/web/main-app/src/components/Uploader/**tests**/FinalizeFlow.integration.test.tsx | Created  | Integration tests for ConflictModal and RateLimitBanner |
| apps/web/main-app/src/services/api/**tests**/finalizeClient.test.ts                   | Created  | Unit tests for finalizeClient                           |

### Debug Log References

N/A - No issues requiring debugging

### Completion Notes

- Created `finalizeClient.ts` with `FinalizeError` class that provides `.isConflict`, `.isRateLimit`, and `.hasFileErrors` getters for clean error handling
- Updated `ConflictModal` to display suggested slugs from API 409 responses with "Use This" button
- Wired up finalize button with idempotent double-click protection via `finalizingRef`
- Rate limit countdown properly disables finalize button until countdown expires
- Per-file validation errors displayed in an Alert with reason-specific messaging
- All 38 tests passing

## Change Log

| Date       | Version | Description                 | Author |
| ---------- | ------- | --------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft (finalize UI) | SM     |
| 2025-12-08 | 0.2     | Implementation complete     | Dev    |
