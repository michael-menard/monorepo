# Story 3.1.11: Upload Session Endpoint — Validation, Owner Keys, TTL

## Status

Implemented

## Story

As a creator,
I want API‑managed upload sessions with clear validation,
so I can upload allowed files reliably.

## Acceptance Criteria

1. Validate request

- Auth required (401→login redirect on client). Rate limit integrated per 3.1.6 (429 shape with retryAfterSeconds).
- Payload Zod-validated: files[] with { category, name, size, type, ext }.
- Allowed categories: instruction (PDF, required), image, parts-list, thumbnail.

2. Enforce env-driven rules (3.1.5, 3.1.8)

- Size, count, and allowed types/extensions from config; no hardcoded values.
- 413 when size exceeds per-type limit; 415/400 for disallowed type/ext; response includes allowed values.

3. Owner-scoped S3 keying and upload session

- Key format: {env}/moc-instructions/{ownerId}/{sessionId}/{category}/{uuid.ext}.
- Return session metadata { sessionId, partSizeBytes, expiresAt } (TTL from UPLOAD_SESSION_TTL_MINUTES); when registering a file return { fileId, uploadId }.

4. Observability & errors

- Log with @repo/logger: requestId, ownerId, counts, categories; warn on validation failures with details size/type.
- Error contract per 3.1.21: { code, message, details?, correlationId }.

5. Tests

- Unit: Zod schema, config limits, key generation.
- Integration: happy path (multi-file), 413, 415, 429; structured logs present.

## Tasks / Subtasks

- [x] Zod request/response schemas in apps/api
- [x] Implement handlers:
  - [x] POST /mocs/uploads/sessions (create session; returns sessionId, partSizeBytes, expiresAt)
  - [x] POST /mocs/uploads/sessions/:sid/files (createMultipart; returns fileId, uploadId)
  - [x] PUT /mocs/uploads/sessions/:sid/files/:fid/parts/:partNumber (binary up to partSizeBytes) - API streams to S3 UploadPart
  - [x] POST /mocs/uploads/sessions/:sid/files/:fid/complete (completeMultipartUpload)
- [x] Logging and error mapping
- [x] Tests (unit + integration)

## Dev Notes

- Do not trust client-provided Content-Type; use as hint only; enforce again at finalize (3.1.8).
- Prefer stable `uploadSessionId` per session; generate server-side if not provided.

### Auth, Cookies, and CSRF

- Cookie-based (HttpOnly) session auth.
- Frontend MUST send `credentials: 'include'` and MUST NOT send `Authorization` headers.
- Cookie attributes: `HttpOnly`; `Secure`; `SameSite=Lax` (recommended) or `SameSite=None; Secure` when API is on a different site/domain.
- CORS: `Access-Control-Allow-Credentials: true`; `Access-Control-Allow-Origin` must be the exact client origin (no `*`). Include `Vary: Origin`.
- Responses are JSON; clients send `Accept: application/json`.
- CSRF for unsafe methods (POST/PUT/PATCH/DELETE): require `X-CSRF-Token` and verify server-side (double-submit cookie or session-bound token). GET endpoints do not require CSRF.

Ensure:

- RTK Query uses `credentials: 'include'` and does not set `Authorization`.
- XHR uploads use `withCredentials = true` and appropriate `Content-Type` (e.g., `application/octet-stream` for binary part uploads).
- Backend sets cookies with `HttpOnly`; `Secure`; `SameSite` (Lax or None+Secure) and CORS allows credentials for the exact origin.
- Optional `X-CSRF-Token` header is included on unsafe methods when CSRF is enabled.

## Change Log

| Date       | Version | Description                             | Author |
| ---------- | ------- | --------------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft (upload session endpoint) | SM     |
| 2025-12-07 | 1.0     | Implemented all endpoints and tests     | AI     |

## Implementation Notes

### Files Created

**Database Schema:**

- `apps/api/core/database/schema/index.ts` - Added `uploadSessions`, `uploadSessionFiles`, `uploadSessionParts` tables

**Zod Schemas:**

- `apps/api/endpoints/moc-uploads/sessions/_shared/schemas.ts` - Request/response schemas for all endpoints

**Handlers:**

- `apps/api/endpoints/moc-uploads/sessions/create/handler.ts` - POST /mocs/uploads/sessions
- `apps/api/endpoints/moc-uploads/sessions/register-file/handler.ts` - POST /mocs/uploads/sessions/:sid/files
- `apps/api/endpoints/moc-uploads/sessions/upload-part/handler.ts` - PUT /mocs/uploads/sessions/:sid/files/:fid/parts/:partNumber
- `apps/api/endpoints/moc-uploads/sessions/complete-file/handler.ts` - POST /mocs/uploads/sessions/:sid/files/:fid/complete

**Tests:**

- `apps/api/endpoints/moc-uploads/sessions/_shared/__tests__/schemas.test.ts` - 17 unit tests for Zod schemas

### Key Implementation Details

- **S3 Key Format:** `{env}/moc-instructions/{ownerId}/{sessionId}/{category}/{uuid.ext}`
- **Part Size:** 5MB (S3 minimum for multipart uploads)
- **Session TTL:** From `UPLOAD_SESSION_TTL_MINUTES` config (defaults to 15 minutes)
- **Rate Limiting:** Integrated per Story 3.1.6 with 429 response including `retryAfterSeconds`
- **Auth:** JWT via AWS Cognito (cookie-based session auth)
- **Logging:** Structured logging with `@repo/logger` including requestId, ownerId, sessionId
- **Error Contract:** Per Story 3.1.21 with code, message, details, correlationId
