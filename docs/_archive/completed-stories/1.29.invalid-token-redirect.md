# Story 1.29: Invalid Token Redirect

## Status

Ready for Review

## Story

**As a** user,
**I want** to be redirected to login when my token is invalid,
**so that** I can re-authenticate and continue using the app.

## Acceptance Criteria

1. ✅ Detect invalid token response from API (401)
2. ✅ Clear local auth state
3. ✅ Redirect to login with return URL
4. ✅ Show notification explaining session expired
5. ✅ Don't redirect during login/signup flows

## Tasks / Subtasks

- [x] **Task 1: Create Global Auth Failure Handler** (AC: 1, 2, 3, 5)
  - [x] Create `authFailureHandler.ts` with handler logic
  - [x] Initialize handler in App.tsx with store reference
  - [x] Detect 401 errors and skip auth pages
  - [x] Clear auth state and RTK Query cache
  - [x] Redirect to login with return URL and expired flag

- [x] **Task 2: Update API Configurations** (AC: 1)
  - [x] Modify `createGalleryApi` to accept `onAuthFailure` callback
  - [x] Modify `createWishlistApi` to accept `onAuthFailure` callback
  - [x] Update store to create API instances with global handler

- [x] **Task 3: Handle Expired Param on Login Page** (AC: 4)
  - [x] Add `useToast` hook to LoginPage
  - [x] Show toast notification when `expired=true` param present
  - [x] Use destructive variant for session expired message

- [x] **Task 4: Add Comprehensive Tests**
  - [x] Test 401 triggers logout and redirect
  - [x] Test redirect includes return URL
  - [x] Test auth pages don't redirect
  - [x] Test all auth page paths are detected
  - [x] Test non-401 errors are ignored
  - [x] 21 tests added, all passing

## Dev Agent Record

### Implementation Approach

Instead of creating a new baseQuery wrapper as suggested in the Dev Notes, I enhanced the existing RTK Query infrastructure:

1. **Global Auth Failure Handler** - Created `authFailureHandler.ts` that:
   - Detects 401 errors after token refresh has failed
   - Checks if current path is an auth page (skips redirect if yes)
   - Clears auth state from Redux using `setUnauthenticated()`
   - Clears RTK Query cache for all API slices
   - Redirects to `/login?redirect={currentPath}&expired=true`

2. **API Configuration Enhancement** - Modified API creation functions:
   - Added `onAuthFailure` parameter to `createGalleryApi()` and `createWishlistApi()`
   - Updated store to create API instances with global handler
   - Leverages existing `createAuthenticatedBaseQuery()` which already handles 401 detection and token refresh

3. **Login Page Enhancement** - Added expired param handling:
   - Shows toast notification when `expired=true` param is present
   - Uses `useToast` hook with destructive variant
   - Message: "Session Expired - Please sign in again to continue"

### Key Design Decisions

- **Singleton Handler Pattern**: Handler is initialized once in App.tsx and shared across all API slices
- **Async Cache Clearing**: RTK Query cache is cleared asynchronously to avoid circular dependencies
- **Hard Redirect**: Uses `window.location.href` instead of router navigation to ensure clean state
- **Auth Page Detection**: Comprehensive list of auth pages to prevent redirect loops

### Test Coverage

Added 21 comprehensive tests covering:
- 401 error handling and redirect
- Non-401 errors are ignored
- Auth page detection (8 different auth pages)
- Redirect URL encoding
- State cleanup
- Handler initialization

Total test count: **107 tests** (29 JWT + 46 route guards + 11 token refresh + 21 auth failure)

## File List

### Files Created
- `apps/web/main-app/src/services/api/authFailureHandler.ts` - Global auth failure handler (120 lines)
- `apps/web/main-app/src/services/api/__tests__/authFailureHandler.test.ts` - Tests (243 lines, 21 tests)

### Files Modified
- `apps/web/main-app/src/App.tsx` - Initialize auth failure handler
- `apps/web/main-app/src/store/index.ts` - Create API instances with handler
- `apps/web/main-app/src/routes/pages/LoginPage.tsx` - Handle expired param
- `packages/core/api-client/src/rtk/gallery-api.ts` - Add onAuthFailure config option
- `packages/core/api-client/src/rtk/wishlist-api.ts` - Add onAuthFailure config option

## Dev Notes

### RTK Query Base Query Wrapper

**File:** `apps/web/main-app/src/services/api/baseQuery.ts`

```typescript
import { fetchBaseQuery } from '@reduxjs/toolkit/query/react'
import type { RootState } from '@/store'

const rawBaseQuery = fetchBaseQuery({
  baseUrl: import.meta.env.VITE_API_URL,
  prepareHeaders: (headers, { getState }) => {
    const token = (getState() as RootState).auth.tokens?.accessToken
    if (token) {
      headers.set('Authorization', `Bearer ${token}`)
    }
    return headers
  },
})

export const baseQueryWithReauth: typeof rawBaseQuery = async (args, api, extraOptions) => {
  let result = await rawBaseQuery(args, api, extraOptions)

  if (result.error && result.error.status === 401) {
    // Check if not on auth pages
    const currentPath = window.location.pathname
    const authPaths = ['/login', '/signup', '/forgot-password']

    if (!authPaths.some(path => currentPath.startsWith(path))) {
      // Clear auth state
      api.dispatch(setUnauthenticated())

      // Show notification
      // Note: Toast needs to be called differently in non-component context

      // Redirect
      window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}&expired=true`
    }
  }

  return result
}
```

### Handle Expired Param on Login Page

```typescript
// In LoginPage.tsx
const { expired } = useSearch({ from: '/login' })

useEffect(() => {
  if (expired) {
    toast({
      title: 'Session Expired',
      description: 'Please sign in again to continue.',
      variant: 'warning',
    })
  }
}, [expired])
```

### Global Error Handler Alternative

```typescript
// In App.tsx or a dedicated hook
useEffect(() => {
  const handleUnauthorized = (event: CustomEvent) => {
    dispatch(setUnauthenticated())
    toast({ title: 'Session expired', variant: 'warning' })
    navigate('/login')
  }

  window.addEventListener('auth:unauthorized', handleUnauthorized)
  return () => window.removeEventListener('auth:unauthorized', handleUnauthorized)
}, [])
```

### Testing

- Test 401 response triggers logout
- Test redirect includes return URL
- Test notification shows
- Test auth pages don't redirect

## Change Log

| Date       | Version | Description                                      | Author   |
| ---------- | ------- | ------------------------------------------------ | -------- |
| 2025-11-28 | 0.1     | Initial draft                                    | SM Agent |
| 2025-12-01 | 1.0     | Implementation complete - all ACs met, 21 tests  | James    |
