# Story 3.1.35: Edit Presign Endpoint

## GitHub Issue
- Issue: #256
- URL: https://github.com/michael-menard/monorepo/issues/256
- Status: Todo

## Status

Done

## Story

**As an** owner,
**I want** to get presigned URLs for replacement files during edit,
**so that** I can upload new files directly to S3.

## Epic Context

This is **Story 1.3 of Epic 1: Backend Edit Pipeline**.

## Blocked By

- All Epic 0 stories (3.1.28-3.1.32)
- Story 3.1.33: GET MOC for Edit Endpoint

## Acceptance Criteria

1. POST `/mocs/:mocId/edit/presign` accepts file metadata array
2. Validates file types/sizes against `@repo/upload-config`
3. Generates S3 keys with edit context: `{env}/moc-instructions/{ownerId}/{mocId}/edit/{category}/{uuid.ext}`
4. Returns signed URLs with TTL from config
5. Applies rate limiting via `@repo/rate-limit`
6. Returns 401/403/404/429 appropriately

## Tasks / Subtasks

- [x] **Task 1: Create Handler Structure** (AC: 1)
  - [x] Create `apps/api/endpoints/moc-instructions/edit-presign/handler.ts`
  - [x] Create Zod request schema for file metadata array
  - [x] Create Zod response schema with presigned URLs

- [x] **Task 2: Implement File Validation** (AC: 2)
  - [x] Validate file count per category
  - [x] Validate file size per category using `@repo/upload-config`
  - [x] Validate MIME type per category
  - [x] Return 413 for size exceeded, 415 for invalid type

- [x] **Task 3: Generate S3 Keys** (AC: 3)
  - [x] Use edit-specific path: `{env}/moc-instructions/{ownerId}/{mocId}/edit/{category}/{uuid.ext}`
  - [x] Generate UUID for each file
  - [x] Preserve original extension

- [x] **Task 4: Generate Presigned URLs** (AC: 4)
  - [x] Use `@aws-sdk/s3-request-presigner`
  - [x] Set TTL from `@repo/upload-config`
  - [x] Include Content-Type in signed headers

- [x] **Task 5: Apply Rate Limiting** (AC: 5)
  - [x] Use `@repo/rate-limit` with PostgreSQL store
  - [x] Share quota with upload (`moc-upload:{userId}:{date}`)
  - [x] Return 429 with `retryAfterSeconds` on limit

- [x] **Task 6: Implement Auth/Owner Checks** (AC: 6)
  - [x] Verify JWT token (401)
  - [x] Verify MOC exists (404)
  - [x] Verify ownership (403)

- [x] **Task 7: Add Observability**
  - [x] Log presign request with file counts by category
  - [x] Log rate limit checks
  - [x] Warn on validation failures

## Dev Notes

### Request Schema

```typescript
const EditPresignRequestSchema = z.object({
  files: z.array(z.object({
    category: z.enum(['instruction', 'image', 'parts-list', 'thumbnail']),
    filename: z.string(),
    size: z.number().positive(),
    mimeType: z.string(),
  })).min(1).max(20),
})
```

### Response Schema

```typescript
const EditPresignResponseSchema = z.object({
  files: z.array(z.object({
    id: z.string().uuid(), // Client-side tracking ID
    category: z.string(),
    filename: z.string(),
    uploadUrl: z.string().url(),
    s3Key: z.string(),
    expiresAt: z.string().datetime(),
  })),
  sessionExpiresAt: z.string().datetime(),
})
```

### S3 Key Format

```
# Production example
production/moc-instructions/user-123/moc-456/edit/instruction/abc-def.pdf
production/moc-instructions/user-123/moc-456/edit/image/123-456.jpg

# Key structure
{env}/moc-instructions/{ownerId}/{mocId}/edit/{category}/{uuid}.{ext}
```

### Alternative: Session-Based Presign (Recommended by PRD)

The PRD suggests extending the existing upload session infrastructure:

```typescript
// Extend POST /api/mocs/uploads/sessions/create
const CreateSessionRequestSchema = z.object({
  mode: z.enum(['create', 'edit']).default('create'),
  mocId: z.string().uuid().optional(), // Required when mode="edit"
  files: z.array(FileMetadataSchema),
})
```

**Benefits:**
- Reuses existing multipart upload infrastructure
- Session management, parts tracking, expiry already implemented
- Finalize handler already supports idempotency

**Trade-off:** If using session pattern, this story may merge with existing session endpoints.

### Validation Using Extracted Packages

```typescript
import { getFileSizeLimit, isMimeTypeAllowed } from '@repo/upload-config'
import { loadEnvConfig } from '@/core/config/env-loader'

const config = loadEnvConfig()

files.forEach(file => {
  const maxSize = getFileSizeLimit(config, file.category)
  if (file.size > maxSize) {
    throw new ValidationError('FILE_TOO_LARGE', {
      category: file.category,
      maxBytes: maxSize,
      providedBytes: file.size,
    })
  }

  if (!isMimeTypeAllowed(config, file.category, file.mimeType)) {
    throw new ValidationError('INVALID_MIME_TYPE', {
      category: file.category,
      allowedTypes: getAllowedMimeTypes(config, file.category),
      providedType: file.mimeType,
    })
  }
})
```

### Rate Limiting

```typescript
import { createRateLimiter } from '@repo/rate-limit'
import { PostgresRateLimitStore } from '@/core/rate-limit/postgres-store'

const rateLimiter = createRateLimiter(new PostgresRateLimitStore(db))

const result = await rateLimiter.checkLimit(
  `moc-upload:${userId}:${todayDate}`, // Shared with create uploads
  { maxRequests: 100, windowMs: 24 * 60 * 60 * 1000 }
)

if (!result.allowed) {
  return response429({
    code: 'RATE_LIMIT_EXCEEDED',
    message: 'Daily upload limit reached',
    retryAfterSeconds: result.retryAfterSeconds,
  })
}
```

## Testing

### Test Location
- `apps/api/endpoints/moc-instructions/edit-presign/__tests__/handler.test.ts`

### Test Requirements
- Unit: File validation (size, type, count)
- Integration: 401 for unauthenticated
- Integration: 403 for non-owner
- Integration: 404 for non-existent MOC
- Integration: 413 for file too large
- Integration: 415 for invalid MIME type
- Integration: 429 for rate limit exceeded
- Integration: 200 with valid presigned URLs
- Unit: S3 key format matches expected pattern

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 0.1 | Initial draft from Edit MOC PRD | SM Agent |
| 2025-12-09 | 1.0 | Implementation complete - all tests passing | Claude Opus 4.5 |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

N/A

### Completion Notes

Implementation completed with all 16 unit tests passing. Key implementation details:

1. **S3 Key Format**: Uses edit-specific path `{env}/moc-instructions/{ownerId}/{mocId}/edit/{category}/{uuid}.{ext}`
2. **Rate Limiting**: Shares quota with create uploads using `moc-upload:{userId}:{date}` key pattern
3. **File Validation**: Validates size (413), MIME type (415), and count per category
4. **Auth/Owner Checks**: Returns 401 for unauthenticated, 404 for non-existent MOC, 403 for non-owner
5. **Category Mapping**: Maps API categories (instruction, image, parts-list, thumbnail) to internal file types
6. **Response Schema**: Returns presigned URLs with file IDs, S3 keys, and expiry timestamps

Test coverage includes:
- Authentication (401 for unauthenticated)
- Authorization (403 for non-owner, 404 for non-existent/invalid UUID)
- Validation (empty body, empty files, too many files, invalid category, missing filename)
- File size validation (413 for oversized files)
- MIME type validation (415 for invalid types)
- Rate limiting (429 with retryAfterSeconds)
- Successful presign (single and multiple files)
- S3 key format verification
- Response structure validation

### File List

- `apps/api/endpoints/moc-instructions/edit-presign/handler.ts` - New (380 lines)
- `apps/api/endpoints/moc-instructions/__tests__/edit-presign.handler.test.ts` - New (380 lines, 16 tests)
- `apps/api/stacks/functions/moc-instructions.yml` - Modified (added editPresign function)
