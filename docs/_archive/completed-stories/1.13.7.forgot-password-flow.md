# Story 1.13.7: Forgot Password Flow

## Status

Ready for Review

## Story

**As a** user who has forgotten my password,
**I want** to request a password reset code via email,
**so that** I can regain access to my account.

## Acceptance Criteria

1. ✅ Forgot password page at /forgot-password route
2. ✅ Email input with validation
3. ✅ Submit button calls Amplify resetPassword
4. ✅ Success message shows code was sent
5. ✅ Redirect to reset password page with email
6. ✅ Error handling for non-existent accounts (security-aware)
7. ✅ Rate limiting feedback (LimitExceededException)
8. ✅ Link back to login page
9. ✅ Accessible form with ARIA labels
10. ✅ Unit tests (33 tests passing)

## Tasks / Subtasks

- [x] **Task 1: Page Setup** (AC: 1, 8)
  - [x] Create/verify ForgotPasswordPage component
  - [x] Route at /forgot-password
  - [x] Use AuthLayout wrapper
  - [x] Back to login link

- [x] **Task 2: Form Implementation** (AC: 2)
  - [x] Email input field
  - [x] Zod validation schema
  - [x] Form state management

- [x] **Task 3: Amplify Integration** (AC: 3)
  - [x] Call forgotPassword from AuthProvider (uses Amplify resetPassword)
  - [x] Handle success response
  - [x] Pass email to reset password page via sessionStorage

- [x] **Task 4: Success Flow** (AC: 4, 5)
  - [x] Display success message and alert
  - [x] Show email where code was sent
  - [x] "Continue to Reset Password" button
  - [x] "Try a different email" button to reset form
  - [x] Pass email via sessionStorage (pendingResetEmail)

- [x] **Task 5: Error Handling** (AC: 6, 7)
  - [x] Handle UserNotFoundException - show success message (security)
  - [x] Handle LimitExceededException - show rate limit error
  - [x] Handle InvalidParameterException - show email validation error
  - [x] Handle both returned errors and thrown exceptions

- [x] **Task 6: Accessibility** (AC: 9)
  - [x] ARIA labels on inputs (aria-invalid, aria-describedby)
  - [x] Live region for screen reader announcements (aria-live="polite")
  - [x] role="status" for success alerts
  - [x] role="alert" for error alerts
  - [x] aria-hidden="true" on decorative icons
  - [x] autoComplete="email" on email input

- [x] **Task 7: Testing** (AC: 10)
  - [x] Unit tests for form validation (3 tests)
  - [x] Tests for success flow (7 tests)
  - [x] Tests for security/account enumeration prevention (2 tests)
  - [x] Tests for error scenarios (6 tests)
  - [x] Tests for loading state (1 test)
  - [x] Tests for accessibility (5 tests)
  - [x] Tests for navigation tracking (5 tests)
  - [x] Tests for rendering (5 tests)

## Dev Notes

### Amplify v6 Reset Password

```typescript
import { resetPassword } from 'aws-amplify/auth'

async function handleForgotPassword(email: string) {
  try {
    const result = await resetPassword({ username: email })

    // result.nextStep contains delivery details
    const { codeDeliveryDetails } = result.nextStep

    // Navigate to reset password page with email
    navigate('/reset-password', { state: { email } })

    return { success: true, deliveryDetails: codeDeliveryDetails }
  } catch (error) {
    if (error.name === 'UserNotFoundException') {
      // Don't reveal if user exists - show generic message
      return { success: true } // Still show "code sent" for security
    }
    if (error.name === 'LimitExceededException') {
      return { success: false, error: 'Too many attempts. Please try again later.' }
    }
    throw error
  }
}
```

### Implementation Details

The ForgotPasswordPage component is located at `apps/web/main-app/src/routes/pages/ForgotPasswordPage.tsx` with tests at `apps/web/main-app/src/routes/pages/__tests__/ForgotPasswordPage.test.tsx`.

Key features:

- Uses `useAuth().forgotPassword` which wraps Amplify's `resetPassword`
- Stores email in `sessionStorage.setItem('pendingResetEmail', email)` for reset password page
- Security-aware error handling: UserNotFoundException always shows success
- LEGO-themed branding consistent with other auth pages
- Framer Motion animations for smooth UX

### Error Messages

| Amplify Error             | User Message                               |
| ------------------------- | ------------------------------------------ |
| UserNotFoundException     | (Show success anyway for security)         |
| LimitExceededException    | Too many attempts. Please try again later. |
| InvalidParameterException | Please enter a valid email address.        |

### Security Note

For security, always show the same success message whether the email exists or not. This prevents account enumeration attacks.

## Dependencies

- Story 1.13.8: Reset Password Flow (Next step in flow)
- Story 1.14: Login Page (Link from login)

## QA Results

### Review Summary

| Attribute         | Value                      |
| ----------------- | -------------------------- |
| **Gate**          | PASS                       |
| **Quality Score** | 100/100                    |
| **Review Depth**  | DEEP (auth/security story) |
| **Reviewer**      | Quinn (Test Architect)     |
| **Review Date**   | 2025-11-29                 |

### Requirements Traceability

| AC  | Description                                               | Status  | Evidence                                                                                                                      |
| --- | --------------------------------------------------------- | ------- | ----------------------------------------------------------------------------------------------------------------------------- |
| 1   | Forgot password page at /forgot-password route            | ✅ PASS | ForgotPasswordPage.tsx:134-398 with AuthLayout wrapper                                                                        |
| 2   | Email input with validation                               | ✅ PASS | Zod schema lines 19-21, tests: "Form Validation" suite (3 tests)                                                              |
| 3   | Submit button calls Amplify resetPassword                 | ✅ PASS | forgotPassword via useAuth at line 68, tests: lines 214-226                                                                   |
| 4   | Success message shows code was sent                       | ✅ PASS | Lines 73-74, 105-106; tests: lines 228-234                                                                                    |
| 5   | Redirect to reset password page with email                | ✅ PASS | sessionStorage + navigate at lines 77, 127-131; tests: lines 254-286                                                          |
| 6   | Error handling for non-existent accounts (security-aware) | ✅ PASS | UserNotFoundException → success at lines 72, 104-112; tests: "Security - Account Enumeration Prevention" suite (2 tests)      |
| 7   | Rate limiting feedback (LimitExceededException)           | ✅ PASS | Lines 81-86, 115-116; tests: lines 372-392, 434-452                                                                           |
| 8   | Link back to login page                                   | ✅ PASS | Lines 356-362 with /login href; tests: lines 157-161                                                                          |
| 9   | Accessible form with ARIA labels                          | ✅ PASS | aria-live (194-197), aria-invalid (257), role="status" (205), role="alert" (221, 268); tests: "Accessibility" suite (5 tests) |
| 10  | Unit tests (33 tests passing)                             | ✅ PASS | ForgotPasswordPage.test.tsx: 643 lines, 33 comprehensive tests                                                                |

### Code Quality Assessment

| Dimension            | Rating    | Notes                                                              |
| -------------------- | --------- | ------------------------------------------------------------------ |
| **Architecture**     | Excellent | Clean functional component with proper separation of concerns      |
| **Type Safety**      | Excellent | Full TypeScript with Zod schema inference                          |
| **Error Handling**   | Excellent | Handles both returned errors and thrown exceptions; security-aware |
| **State Management** | Excellent | useState for UI state, sessionStorage for cross-page persistence   |
| **Testability**      | Excellent | data-testid attributes throughout, comprehensive mock setup        |

### Test Coverage Analysis

| Test Suite                                | Tests | Coverage                                                          |
| ----------------------------------------- | ----- | ----------------------------------------------------------------- |
| Rendering                                 | 5     | AuthLayout, form, branding, nav links, back button                |
| Form Validation                           | 3     | Invalid email, empty email, form not submitted on invalid         |
| Successful Submission                     | 7     | Success flow, sessionStorage, navigation, try different email     |
| Security - Account Enumeration Prevention | 2     | UserNotFoundException as returned error and thrown exception      |
| Error Handling                            | 6     | LimitExceededException, InvalidParameterException, generic errors |
| Loading State                             | 1     | Button disabled during submission                                 |
| Accessibility                             | 5     | ARIA attributes, live regions, role attributes                    |
| Navigation Tracking                       | 5     | All navigation events tracked                                     |

### NFR Validation

| NFR                 | Status  | Evidence                                                                                                                                        |
| ------------------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| **Security**        | ✅ PASS | Account enumeration prevention verified - UserNotFoundException always shows success message; no sensitive data exposure in errors              |
| **Performance**     | ✅ PASS | Framer Motion animations, react-hook-form with onChange validation mode                                                                         |
| **Reliability**     | ✅ PASS | Handles both returned errors and thrown exceptions; proper error state management                                                               |
| **Accessibility**   | ✅ PASS | Full ARIA compliance: aria-live="polite" for announcements, aria-invalid for validation, role="status"/"alert" for alerts, autoComplete="email" |
| **Maintainability** | ✅ PASS | TypeScript interfaces, consistent data-testid usage, proper mock setup in tests                                                                 |

### Risks Identified

None.

### Recommendations

**Future Improvements:**

1. Consider adding E2E Gherkin tests for complete forgot password flow with reset password
2. Add monitoring/analytics for password reset completion rates in production

## Change Log

| Date       | Version | Description                                                       | Author      |
| ---------- | ------- | ----------------------------------------------------------------- | ----------- |
| 2025-11-28 | 0.1     | Initial draft                                                     | Claude Code |
| 2025-11-29 | 1.0     | Complete: All ACs met, 33 unit tests passing, security-aware flow | Claude Code |
