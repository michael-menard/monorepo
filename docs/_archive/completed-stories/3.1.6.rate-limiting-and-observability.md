# Story 3.1.6: Rate Limiting and Observability

## Status

Ready for Review

## Story

**As a** platform owner,
**I want** a per-user/day limit applied to the uploader presign/initialize and finalize steps with strong logging,
**so that** usage is fair, abuse is contained, and diagnostics are traceable.

## Acceptance Criteria

1. Per-user/day limit applied to presign (initialize) and finalize using `UPLOAD_RATE_LIMIT_PER_DAY` from validated config.
2. When limit exceeded, return HTTP 429 with human-readable message and `nextAllowedAt` timestamp (ISO) and `retryAfterSeconds`; ensure no partial records are created/modified.
3. Structured logs via `@/core/observability/logger`: INFO on success, WARN on validation/rate-limit, ERROR on server failure; include `correlationId`/`requestId` and `ownerId` (no PII beyond ownerId).
4. Unit tests: limit reached on presign and finalize; logs include correlationId; verify that exceeding limit in initialize prevents any DB inserts.

## Tasks / Subtasks

- [x] Rate limit service (DB-backed) (AC: 1–2)
  - [x] Create `apps/api/core/rate-limit/upload-rate-limit.ts` with:
    - [x] `checkAndIncrementDailyLimit(userId: string, maxPerDay: number)` using PostgreSQL transaction and an `upsert` table with unique `(user_id, day)`
    - [x] Returns `{ allowed: boolean, remaining: number, nextAllowedAt: Date, retryAfterSeconds: number }`
  - [x] Add Drizzle table + migration: `user_daily_uploads (user_id text, day date, count int, updated_at timestamp)` with unique index on `(user_id, day)`
- [x] Config integration (AC: 1)
  - [x] Reuse `getUploadConfig()` from 3.1.5 to read `UPLOAD_RATE_LIMIT_PER_DAY`
- [x] Initialize (presign) handler integration (AC: 1–3)
  - [x] In `apps/api/endpoints/moc-instructions/initialize-with-files/handler.ts`, call rate limit check BEFORE any DB writes
  - [x] On exceeded: return 429 with `{ message, nextAllowedAt, retryAfterSeconds }`; log WARN with `ownerId` and `requestId`
  - [x] On success: log INFO with `remaining`
- [x] Finalize handler integration (AC: 1–3)
  - [x] In `apps/api/endpoints/moc-instructions/finalize-with-files/handler.ts`, check rate limit before side effects
  - [x] Apply same 429 response shape and logging
- [x] Logging consistency (AC: 3)
  - [x] Ensure `correlationId`/`requestId` and `ownerId` are included on all relevant logs
- [x] Unit tests (Vitest) (AC: 4)
  - [x] Rate limit service unit tests: under limit, at limit, nextAllowedAt calc, atomicity
  - [x] Initialize handler test: rate limit exceeded -> 429, no DB insert, WARN log with requestId
  - [x] Finalize handler test: rate limit exceeded -> 429, WARN log with requestId
- [x] Docs
  - [x] Update `apps/api/README.md` to document `UPLOAD_RATE_LIMIT_PER_DAY`, 429 semantics, and example response

## Dev Notes

- Redis is disabled in this repo (`apps/api/core/cache/redis.ts` throws). Do NOT use the Redis-based `packages/backend/rate-limiter`. Implement DB-backed counters instead (PostgreSQL via Drizzle).
- Suggested table: `user_daily_uploads` with unique `(user_id, day)`; use `CURRENT_DATE` (UTC) for day bucketing. Increment with a transaction and a `WHERE count < :limit` guard to ensure atomicity under concurrency (e.g., `UPDATE ... SET count = count + 1 WHERE user_id = $1 AND day = $2 AND count < $3 RETURNING *`). If no row updated, attempt INSERT with `count = 1` when under limit; otherwise, compute `nextAllowedAt` as `startOfNextUTCDate`.
- Read `UPLOAD_RATE_LIMIT_PER_DAY` from the validated config created in Story 3.1.5; fail-safe defaults are not allowed—config must be present and valid (Story 3.1.5 AC).
- Response shape on 429 should be user-friendly and include retry hints: `{ message, nextAllowedAt, retryAfterSeconds }`. Use existing `errorResponse(429, 'TOO_MANY_REQUESTS', ...)` with details.
- Logging: use `createLogger`; include `requestId = event.requestContext.requestId`, and `ownerId = userId`. No console usage.
- Integration points:
  - Presign/initialize: `apps/api/endpoints/moc-instructions/initialize-with-files/handler.ts`
  - Finalize: `apps/api/endpoints/moc-instructions/finalize-with-files/handler.ts`

### Testing

- Framework: Vitest; follow repo patterns for API handler tests under `apps/api/endpoints/**/__tests__` and service tests under `apps/api/core/**/__tests__`.
- Scenarios:
  - Service: increments under limit; returns not allowed at limit; correct `nextAllowedAt` at UTC midnight rollover; concurrency-safe behavior (simulate with sequential calls)
  - Initialize: 429 occurs before any DB insert when over limit; WARN log contains `requestId` and `ownerId`
  - Finalize: 429 with same response shape and logging

## Change Log

| Date       | Version | Description                            | Author |
| ---------- | ------- | -------------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft created from PRD (3.1.6) | SM     |
