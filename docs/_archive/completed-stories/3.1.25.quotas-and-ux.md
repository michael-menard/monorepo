# Story 3.1.25: Quotas & UX â€” Rate Limits and Feedback

## Status

Ready for Review

## Story

As a creator,
I want clear feedback when I hit quotas or rate limits,
so I know when to try again and why it failed.

## Acceptance Criteria

1. Presign/finalize 429 handling

- Show friendly message with nextAllowedAt and countdown; disable actions during countdown.

2. Daily limit source

- Values from env; surfaced in tooltips/inline help; logs include limit and current usage.

3. Tests

- Integration: 429 paths for both endpoints; countdown and disablement behavior.

## Tasks / Subtasks

- [x] Client error mapping for RATE_LIMITED
- [x] UI banner/toast with countdown
- [x] Tests

## Dev Notes

- Reuse 3.1.6 server contract; do not spam retry calls while disabled.

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### File List

| File                                                                                    | Action                          |
| --------------------------------------------------------------------------------------- | ------------------------------- |
| `apps/web/main-app/src/services/api/errorMapping.ts`                                    | Existing - RATE_LIMITED mapping |
| `apps/web/main-app/src/services/api/finalizeClient.ts`                                  | Existing - 429 handling         |
| `apps/web/main-app/src/services/api/uploadClient.ts`                                    | Existing - 429 handling         |
| `apps/web/main-app/src/components/Uploader/RateLimitBanner/index.tsx`                   | Existing - countdown banner     |
| `apps/web/main-app/src/routes/pages/InstructionsNewPage.tsx`                            | Existing - integration          |
| `apps/web/main-app/src/services/api/__tests__/errorMapping.test.ts`                     | Existing - tests                |
| `apps/web/main-app/src/services/api/__tests__/finalizeClient.test.ts`                   | Existing - 429 tests            |
| `apps/web/main-app/src/services/api/__tests__/uploadClient.test.ts`                     | Existing - 429 tests            |
| `apps/web/main-app/src/components/Uploader/__tests__/FinalizeFlow.integration.test.tsx` | Existing - banner tests         |

### Debug Log References

None required - all tests passing.

### Completion Notes

- All functionality was already implemented in prior stories (3.1.6, 3.1.10, 3.1.19, 3.1.21)
- Client error mapping: `errorMapping.ts` maps RATE_LIMITED/TOO_MANY_REQUESTS with action='wait', retryDelay=60
- RateLimitBanner: Complete with countdown timer, disabled retry during countdown, progress bar, accessibility
- InstructionsNewPage: Disables finalize button via `canFinalize = ... && rateLimitSeconds === 0`
- Tests: 82 tests across 4 test files all passing (65 + 17)

## Change Log

| Date       | Version | Description                      | Author            |
| ---------- | ------- | -------------------------------- | ----------------- |
| 2025-12-06 | 0.1     | Initial draft (quotas UX)        | SM                |
| 2025-12-08 | 1.0     | Verified implementation complete | James (Dev Agent) |
