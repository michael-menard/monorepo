# Story 3.1.12: Finalize Endpoint — Verify, Persist, Idempotent

## Status

Implemented

## Story

As a creator,
I want finalize to verify uploads and persist my instruction,
so the record is created reliably without duplication.

## Acceptance Criteria

1. Verify uploaded files

- For each referenced key: S3 HeadObject check size; magic-bytes type validation via Range GET (3.1.8) — treat Content-Type as advisory.
- Reject mismatches with per-file errors; do not create partial records.

2. Persist metadata

- Fields: id, ownerId, title, slug, description, pdfKey, imageKeys[], partsKeys[], tags[], theme, status=private, timestamps.
- Slug by 3.1.14; uniqueness per user enforced; on conflict return 409 with suggested slug.

3. Idempotency & concurrency (3.1.7)

- Idempotent by uploadSessionId: first call performs side effects; subsequent return prior result.
- Concurrency-safe: atomic update-if-null or finalizing state; only set finalizedAt after all side effects succeed.

4. Errors & observability (3.1.21)

- Error shape { code, message, details?, correlationId }.
- Logs: requestId, ownerId, uploadSessionId, counts; warn on validation failures; info on success.

5. Tests

- Integration: happy path, type mismatch, size mismatch, duplicate title (409), idempotent double-call.
- Concurrency test: two finalize calls; only one performs writes; both receive consistent response.

## Tasks / Subtasks

- [x] Zod request schema and response shape
- [x] Implement handler (POST /mocs/uploads/finalize) with S3 verification and DB writes
- [x] Add finalizedAt + uploadSessionId fields/migration if missing
- [x] Catch unique_violation; suggest available slug
- [x] Tests (integration + concurrency)

## Dev Notes

- Ensure transactional behavior: rollback or avoid writes on any verification failure.
- Avoid trusting client MIME; rely on magic bytes (leading signature only).

### Auth, Cookies, and CSRF

- Cookie-based (HttpOnly) session auth.
- Frontend MUST send `credentials: 'include'` and MUST NOT send `Authorization` headers.
- Cookie attributes: `HttpOnly`; `Secure`; `SameSite=Lax` (recommended) or `SameSite=None; Secure` when API is on a different site/domain.
- CORS: `Access-Control-Allow-Credentials: true`; `Access-Control-Allow-Origin` must be the exact client origin (no `*`). Include `Vary: Origin`.
- Responses are JSON; clients send `Accept: application/json`.
- CSRF for unsafe methods (POST/PUT/PATCH/DELETE): require `X-CSRF-Token` and verify server-side (double-submit cookie or session-bound token). GET endpoints do not require CSRF.

Ensure:

- RTK Query uses `credentials: 'include'` and does not set `Authorization`.
- XHR uploads use `withCredentials = true` and appropriate `Content-Type` (e.g., `application/octet-stream` for binary part uploads).
- Backend sets cookies with `HttpOnly`; `Secure`; `SameSite` (Lax or None+Secure) and CORS allows credentials for the exact origin.
- Optional `X-CSRF-Token` header is included on unsafe methods when CSRF is enabled.

## Change Log

| Date       | Version | Description                       | Author |
| ---------- | ------- | --------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft (finalize endpoint) | SM     |
| 2025-12-07 | 1.0     | Implemented finalize endpoint     | Agent  |
