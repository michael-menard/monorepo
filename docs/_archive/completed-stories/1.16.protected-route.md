# Story 1.16: Protected Route

## Status

Ready for Review

## Story

**As a** developer,
**I want** route protection that redirects unauthenticated users,
**so that** protected pages are secure.

## Acceptance Criteria

1. ✅ Route guard utility exists
2. ✅ Protected routes redirect to /login
3. ✅ Redirect includes original URL as search param
4. ✅ Loading state shows while auth checking
5. ✅ Role-based route protection available
6. ✅ Guest-only routes redirect authenticated users

## Tasks / Subtasks

- [x] **Task 1: Verify Route Guards Exist** (AC: 1-3)
  - [x] Check lib/route-guards.ts exists
  - [x] Verify createTanStackRouteGuard function
  - [x] Check RouteGuards.protected exists
  - [x] Verify redirect includes search param

- [x] **Task 2: Loading State** (AC: 4)
  - [x] Guard skips redirect while auth.isLoading
  - [x] Show loading component during check (RootLayout LEGO brick animation)
  - [x] Verify user doesn't see flash of login page

- [x] **Task 3: Verify Role-Based Guards** (AC: 5)
  - [x] Check RouteGuards.admin exists
  - [x] Verify requireRoles option works
  - [x] Test role check logic (23 tests pass)

- [x] **Task 4: Guest-Only Routes** (AC: 6)
  - [x] Check RouteGuards.guestOnly exists
  - [x] Verify redirects authenticated users
  - [x] Apply to login, signup, forgot-password routes

## Dev Notes

### Existing Implementation ✅

**File:** `apps/web/main-app/src/lib/route-guards.ts`

Already implements:

- createTanStackRouteGuard() factory function
- RouteGuards.public
- RouteGuards.protected
- RouteGuards.verified
- RouteGuards.admin
- RouteGuards.guestOnly
- Redirect with search param for return URL

### Route Configuration

```typescript
// In route definition
export const Route = createFileRoute('/dashboard')({
  beforeLoad: RouteGuards.protected,
  component: DashboardPage,
})
```

### Loading State Handling

The current implementation skips guard if auth.isLoading:

```typescript
if (auth.isLoading) {
  return // Don't redirect, wait for auth check
}
```

### Guest-Only Implementation

```typescript
guestOnly: createTanStackRouteGuard({
  guestOnly: true,
  redirectTo: '/dashboard',
})
```

### Testing

- Test protected route redirects when not authenticated
- Test protected route allows when authenticated
- Test redirect URL is preserved
- Test guest-only redirects authenticated users

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### File List

| File                                                       | Action   | Description                                            |
| ---------------------------------------------------------- | -------- | ------------------------------------------------------ |
| `apps/web/main-app/src/lib/route-guards.ts`                | Modified | Added guestOnly option for redirecting auth users      |
| `apps/web/main-app/src/App.tsx`                            | Modified | Connect auth state to router context via InnerApp      |
| `apps/web/main-app/src/components/Layout/RootLayout.tsx`   | Modified | Added reset-password and new-password to public routes |
| `apps/web/main-app/src/lib/__tests__/route-guards.test.ts` | Created  | 23 tests for route guards                              |

### Completion Notes

- Route guards were already implemented but router context wasn't receiving auth state
- Fixed by creating InnerApp component that connects Redux auth state to router context
- Added `guestOnly` option to RouteGuardOptions for cleaner guest-only logic
- Loading state is properly handled - guards skip while `isLoading` is true
- RootLayout shows LEGO brick animation during auth loading
- All 23 route guard tests pass

## Change Log

| Date       | Version | Description                        | Author    |
| ---------- | ------- | ---------------------------------- | --------- |
| 2025-11-28 | 0.1     | Initial draft - mostly implemented | SM Agent  |
| 2025-11-29 | 1.0     | Complete implementation & tests    | Dev Agent |

## QA Results

### Review Date: 2025-11-29

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review Depth: STANDARD**

- Auth-related code but focused on routing guards (lower risk than auth state management)
- 6 acceptance criteria with comprehensive test coverage (23 tests)
- Well-structured implementation with clear separation of concerns

### Requirements Traceability

| AC# | Acceptance Criteria                   | Test Coverage                                                            | Status     |
| --- | ------------------------------------- | ------------------------------------------------------------------------ | ---------- |
| 1   | Route guard utility exists            | `route-guards.test.ts:27-262` - tests `createTanStackRouteGuard` factory | ✅ Covered |
| 2   | Protected routes redirect to /login   | `route-guards.test.ts:59-68` - verifies unauthenticated redirect         | ✅ Covered |
| 3   | Redirect includes original URL        | `route-guards.test.ts:99-108` - verifies `search.redirect` param         | ✅ Covered |
| 4   | Loading state shows while checking    | `route-guards.test.ts:35-55` - verifies guard skips during loading       | ✅ Covered |
| 5   | Role-based route protection           | `route-guards.test.ts:155-231` - tests `requireRoles` option             | ✅ Covered |
| 6   | Guest-only routes redirect auth users | `route-guards.test.ts:112-152` - tests `guestOnly` option                | ✅ Covered |

**Given-When-Then Test Scenarios (Verified):**

```gherkin
# AC 2 & 3: Protected Route Redirect
Given an unauthenticated user
When they access a protected route /dashboard
Then they are redirected to /login
And the redirect URL includes ?redirect=/dashboard

# AC 4: Loading State
Given auth.isLoading is true
When a user accesses any guarded route
Then the guard skips (no redirect)
And the loading UI is shown (RootLayout.tsx:55-89)

# AC 5: Role-Based Protection
Given an authenticated user without admin role
When they access /admin route
Then they are redirected to /unauthorized

# AC 6: Guest-Only Routes
Given an authenticated user
When they access /login or /register
Then they are redirected to /dashboard
```

### Code Quality Assessment

**Strengths:**

- Clean, well-documented factory function (`createTanStackRouteGuard`) with dependency injection for testing
- Comprehensive preset configurations (`RouteGuards.public`, `.protected`, `.verified`, `.admin`, `.guestOnly`)
- Legacy route patterns for migration compatibility (`LegacyRoutePatterns`)
- `InnerApp` component in `App.tsx` correctly connects Redux auth state to router context
- Loading animation in `RootLayout.tsx` provides good UX during auth check

**Implementation Quality:**

- `route-guards.ts`: 231 lines, well-organized with clear TypeScript interfaces
- Test file: 346 lines covering all guard variations and edge cases
- Proper use of TanStack Router's `beforeLoad` hook pattern

### Refactoring Performed

None. Code quality is excellent for the scope of this story.

### Compliance Check

- Coding Standards: ✅ Functional patterns, proper TypeScript, dependency injection for testing
- Project Structure: ✅ Located in `lib/route-guards.ts` per architecture guidelines
- Testing Strategy: ✅ 23 unit tests covering all acceptance criteria (70%+ recommended coverage)
- All ACs Met: ✅ All 6 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Route guard factory function with dependency injection (route-guards.ts:19-22)
- [x] All RouteGuards presets implemented (public, protected, verified, admin, guestOnly)
- [x] InnerApp connects auth state to router context (App.tsx:20-24)
- [x] Loading state with LEGO brick animation (RootLayout.tsx:55-89)
- [x] Comprehensive test coverage (23 tests passing)
- [x] guestOnly routes applied to all auth pages (routes/index.ts:38-80)
- [ ] Consider using `RouteGuards.protected` instead of inline guards for wishlist/instructions/dashboard routes (routes/index.ts:91-128) - minor consistency improvement

### Test Architecture Assessment

**Current Coverage:**

- `route-guards.test.ts`: 346 lines, 23 tests covering all guard options ✅
- Unit tests mock the redirect function for isolation ✅
- Tests cover edge cases: undefined roles, loading state, multiple roles ✅

**Test Quality:**

- Follows AAA pattern (Arrange-Act-Assert)
- Uses descriptive test names
- Proper mocking of TanStack Router's redirect function
- Helper functions for test context creation (`createMockContext`, `createMockLocation`)

**Recommended Test Level:**
| Scenario | Current Level | Status |
|----------|--------------|--------|
| Guard factory options | Unit | ✅ Complete |
| RouteGuards presets | Unit | ✅ Complete |
| Integration with router | Not tested | ⚠️ Could add E2E test |

### Security Review

- ✅ Guards check authentication state from Redux (secure source)
- ✅ Role-based access control properly implemented
- ✅ No sensitive data exposed in redirect URLs (only path preserved)
- ✅ Loading state prevents premature redirects (avoids flicker-based exploits)

### Performance Considerations

- ✅ Guards execute synchronously (no async overhead)
- ✅ `isLoading` check runs first (fast-path for loading state)
- ✅ `allowedPaths` uses `startsWith` for efficient matching

### Files Modified During Review

None. No refactoring was performed.

### Gate Status

**Gate: PASS** → `docs/qa/gates/1.16-protected-route.yml`

All acceptance criteria are fully implemented with comprehensive test coverage. The 23 unit tests cover all guard options and edge cases. Code quality is excellent.

### Recommended Status

**✓ Ready for Done**

Story owner can proceed to Done status. All acceptance criteria are met with high-quality implementation and test coverage.
