# Story 1.15: Auth State Sync

## Status

Ready for Review

## Story

**As a** user,
**I want** my auth state to sync with Amplify on app load,
**so that** I stay logged in across page refreshes.

## Acceptance Criteria

1. ✅ AuthProvider component wraps application
2. ✅ Checks current auth state on mount
3. ✅ Syncs Amplify session to Redux authSlice
4. ✅ Handles token refresh automatically (via Hub listener)
5. ✅ Shows loading state while checking
6. ✅ Clears state on session expiry (via Hub listener)

## Tasks / Subtasks

- [x] **Task 1: Verify AuthProvider Exists** (AC: 1)
  - [x] Check services/auth/AuthProvider.tsx exists
  - [x] Review current implementation

- [x] **Task 2: Implement Auth Check** (AC: 2-3)
  - [x] Use getCurrentUser() from Amplify
  - [x] Use fetchAuthSession() to get tokens
  - [x] Dispatch setAuthenticated or setUnauthenticated

- [x] **Task 3: Token Refresh** (AC: 4)
  - [x] Amplify handles refresh automatically
  - [x] Listen for tokenRefresh Hub events
  - [x] Update Redux with new tokens

- [x] **Task 4: Loading State** (AC: 5)
  - [x] Set isLoading=true initially (authSlice default)
  - [x] Render loading UI until auth checked
  - [x] Set isLoading=false after check

- [x] **Task 5: Session Expiry** (AC: 6)
  - [x] Listen for signedOut Hub events
  - [x] Listen for tokenRefresh_failure Hub events
  - [x] Dispatch setUnauthenticated
  - [x] Clear Cognito token manager

## Dev Notes

### Existing Implementation

**File:** `apps/web/main-app/src/services/auth/AuthProvider.tsx`

### Amplify v6 Auth Check

```typescript
import { getCurrentUser, fetchAuthSession } from '@aws-amplify/auth'
import { Hub } from 'aws-amplify/utils'

function AuthProvider({ children }: { children: React.ReactNode }) {
  const dispatch = useAppDispatch()

  useEffect(() => {
    async function checkAuth() {
      dispatch(setLoading(true))
      try {
        const user = await getCurrentUser()
        const session = await fetchAuthSession()

        dispatch(setAuthenticated({
          user: {
            id: user.userId,
            email: user.signInDetails?.loginId || '',
            name: user.username,
          },
          tokens: {
            accessToken: session.tokens?.accessToken?.toString(),
            idToken: session.tokens?.idToken?.toString(),
          },
        }))
      } catch {
        dispatch(setUnauthenticated())
      }
    }

    checkAuth()
  }, [dispatch])

  // Listen for auth events
  useEffect(() => {
    const unsubscribe = Hub.listen('auth', ({ payload }) => {
      switch (payload.event) {
        case 'signedOut':
          dispatch(setUnauthenticated())
          break
        case 'tokenRefresh':
          // Refresh tokens in Redux
          break
      }
    })
    return unsubscribe
  }, [dispatch])

  return <>{children}</>
}
```

### App Integration

```typescript
// In App.tsx
<Provider store={store}>
  <AuthProvider>
    <RouterProvider router={router} />
  </AuthProvider>
</Provider>
```

### Testing

- Test auth check on mount
- Test authenticated state dispatch
- Test unauthenticated state dispatch
- Test Hub event listeners

## Change Log

| Date       | Version | Description                                   | Author    |
| ---------- | ------- | --------------------------------------------- | --------- |
| 2025-11-28 | 0.1     | Initial draft                                 | SM Agent  |
| 2025-11-29 | 1.0     | Complete: Added Hub listeners for auth events | Dev Agent |

## QA Results

### Review Date: 2025-11-29

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review Depth: DEEP** (Auto-escalated)

- Auth/security files touched: ✅ `AuthProvider.tsx` handles authentication
- 6 acceptance criteria requiring comprehensive verification

### Requirements Traceability

| AC# | Acceptance Criteria            | Test Coverage                                                                         | Status            |
| --- | ------------------------------ | ------------------------------------------------------------------------------------- | ----------------- |
| 1   | AuthProvider wraps application | `App.integration.test.tsx:204-208` - verifies AuthProvider presence                   | ✅ Covered        |
| 2   | Checks auth state on mount     | Tested implicitly via auth flow tests; `checkAuthState()` called in `useEffect`       | ⚠️ Indirect       |
| 3   | Syncs Amplify to Redux         | `authSlice.test.ts:52-74` - tests `setAuthenticated` action                           | ✅ Covered        |
| 4   | Token refresh via Hub          | Implementation at `AuthProvider.tsx:126-153`; Hub listener registered                 | ⚠️ No Direct Test |
| 5   | Loading state while checking   | `authSlice.test.ts:44-49` - tests `setLoading`; initial state `isLoading: true`       | ✅ Covered        |
| 6   | Clears state on session expiry | `authSlice.test.ts:77-96` - tests `setUnauthenticated`; Hub listener at line 113, 156 | ⚠️ Indirect       |

**Given-When-Then Test Scenarios (Recommended):**

```gherkin
# AC 2 & 3: Auth State Check on Mount
Given the application loads
When AuthProvider mounts
Then it should call getCurrentUser() and fetchAuthSession()
And dispatch setAuthenticated with user data if session exists
And dispatch setUnauthenticated if no session

# AC 4: Token Refresh
Given the user is authenticated
When Amplify emits a 'tokenRefresh' Hub event
Then AuthProvider should fetch new session tokens
And dispatch updateTokens to Redux

# AC 6: Session Expiry
Given the user is authenticated
When Amplify emits 'signedOut' or 'tokenRefresh_failure' Hub event
Then AuthProvider should dispatch setUnauthenticated
And clear the Cognito token manager
```

### Code Quality Assessment

**Strengths:**

- Clean functional component adhering to coding standards
- Comprehensive Hub event handling (signedOut, tokenRefresh, tokenRefresh_failure, signedIn)
- Proper cleanup of Hub listener on unmount (`AuthProvider.tsx:171-173`)
- Good separation of concerns: Redux slice for state, AuthProvider for Amplify orchestration
- Token manager integration synchronized with Redux state
- Error handling with fallback to `setUnauthenticated` on failures

**Observations:**

1. `checkAuthState` function defined inside component but called in `useEffect` without `useCallback` wrapper - works correctly but triggers ESLint exhaustive-deps warning (line 103-105)
2. Type assertion for refreshToken extraction (`AuthProvider.tsx:136-137, 195-197`) - necessary due to Amplify v6 typing

### Refactoring Performed

None. Code quality is acceptable for the scope of this story.

### Compliance Check

- Coding Standards: ✅ Functional component, proper TypeScript, correct import order
- Project Structure: ✅ Located in `services/auth/` per architecture guidelines
- Testing Strategy: ⚠️ Unit tests exist for authSlice; AuthProvider Hub listener tests missing
- All ACs Met: ✅ All acceptance criteria are implemented correctly

### Improvements Checklist

- [x] AuthProvider wraps app correctly (`App.tsx:31-33`)
- [x] Hub event listeners properly set up and cleaned up
- [x] Token manager integration works with Amplify
- [ ] Add unit tests for AuthProvider Hub event listeners
- [ ] Add integration test for auth state sync on mount
- [ ] Consider wrapping `checkAuthState` in useCallback for ESLint compliance

### Test Architecture Assessment

**Current Coverage:**

- `authSlice.test.ts`: 159 lines covering all slice actions and selectors ✅
- `App.integration.test.tsx`: Verifies AuthProvider integration ✅
- `AuthFlow.test.tsx`: Tests auth pages with mocked AuthProvider ✅

**Gaps Identified:**

- No direct unit tests for `AuthProvider` Hub event handling
- No integration test verifying `checkAuthState` → Redux flow
- Hub events (tokenRefresh, signedOut, tokenRefresh_failure) lack test coverage

**Recommended Test Level:**
| Scenario | Recommended Level | Priority |
|----------|------------------|----------|
| Hub tokenRefresh handling | Unit (mock Hub.listen) | P1 |
| Hub signedOut handling | Unit | P1 |
| checkAuthState flow | Integration | P2 |

### Security Review

- ✅ Tokens stored in Redux state (memory-only, appropriate for SPA)
- ✅ Token manager cleared on sign out and token refresh failure
- ✅ No tokens exposed in URLs or localStorage (beyond Amplify's own storage)
- ✅ Error handling doesn't leak sensitive information

### Performance Considerations

- ✅ Auth check runs only once on mount (dependency array is correct)
- ✅ Hub listener cleanup prevents memory leaks
- ⚠️ Token manager initialization includes retry logic with configurable delays (`AuthProvider.tsx:209-215`) - acceptable overhead

### Files Modified During Review

None. No refactoring was performed.

### Gate Status

**Gate: CONCERNS** → `docs/qa/gates/1.15-auth-state-sync.yml`

**Reason:** All acceptance criteria are implemented correctly. However, critical auth functionality (Hub event handling) lacks direct test coverage. Missing tests for tokenRefresh, signedOut, and tokenRefresh_failure Hub events represent a testability gap for a security-critical feature.

### Recommended Status

**⚠️ Changes Required** - Address unchecked items above (specifically: add Hub event listener tests)

Alternatively, if the team accepts this as technical debt:

- WAIVER option available: Gate can be set to PASS with waiver if PO accepts missing tests for later sprint
