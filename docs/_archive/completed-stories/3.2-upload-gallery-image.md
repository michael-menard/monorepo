# Story 3.2: Implement POST /api/images - Upload Gallery Image

**Epic**: 3 - Gallery & Wishlist APIs Migration

**As a** user,
**I want** to upload images to my gallery,
**so that** I can organize photos of my LEGO builds.

## Acceptance Criteria

1. Lambda handler for `POST /api/images` with multipart form data parsing
2. Image validation: file types (JPEG, PNG, WebP), max size 10MB (via `@monorepo/file-validator`)
3. Sharp image processing pipeline: resize to max 2048px width, optimize quality (80%), convert to WebP
4. Processed image uploaded to S3: `images/{userId}/{uuid}.webp`
5. Thumbnail generated (400px width) and stored: `images/{userId}/thumbnails/{uuid}.webp`
6. Database record created in `galleryImages` with metadata from form: `title`, `description`, `tags`, `albumId`
7. Image indexed in OpenSearch `gallery_images` index
8. Redis cache invalidated for user's gallery list
9. Lambda memory: 2048 MB (for Sharp processing), timeout: 60 seconds
10. Response format: `{ success: true, data: { id, imageUrl, thumbnailUrl, ... } }`
11. Error handling for image processing failures, S3 upload errors

## Implementation Status

**Status**: Not Started

## Files Modified

_To be populated during implementation_

## QA Results

_Pending implementation and review_

---

## Requirements Traceability Matrix

| AC # | Requirement                         | Test Coverage | Status     |
| ---- | ----------------------------------- | ------------- | ---------- |
| 1    | POST handler with multipart parsing | TBD           | ⏳ PENDING |
| 2    | Image validation (types, size)      | TBD           | ⏳ PENDING |
| 3    | Sharp processing pipeline           | TBD           | ⏳ PENDING |
| 4    | S3 upload main image                | TBD           | ⏳ PENDING |
| 5    | S3 upload thumbnail                 | TBD           | ⏳ PENDING |
| 6    | Database record creation            | TBD           | ⏳ PENDING |
| 7    | OpenSearch indexing                 | TBD           | ⏳ PENDING |
| 8    | Redis cache invalidation            | TBD           | ⏳ PENDING |
| 9    | Lambda memory and timeout config    | TBD           | ⏳ PENDING |
| 10   | Response format compliance          | TBD           | ⏳ PENDING |
| 11   | Error handling                      | TBD           | ⏳ PENDING |

**Overall Coverage: TBD**

---

## Test Summary

_To be populated during implementation_

---

## Technical Notes

### Image Processing Pipeline

1. **Upload**: Receive multipart form data
2. **Validation**: Use @monorepo/file-validator (JPEG, PNG, WebP, max 10MB)
3. **Sharp Processing**:
   - Resize to max 2048px width (maintain aspect ratio)
   - Quality: 80%
   - Convert to WebP format
4. **Thumbnail Generation**:
   - Resize to 400px width
   - Same quality and format settings
5. **S3 Storage**:
   - Main: `images/{userId}/{uuid}.webp`
   - Thumbnail: `images/{userId}/thumbnails/{uuid}.webp`
6. **Database**: Store metadata + URLs
7. **Indexing**: Add to OpenSearch for search
8. **Cache**: Invalidate user's gallery list cache

### Lambda Configuration

- **Memory**: 2048 MB (Sharp requires significant memory for image processing)
- **Timeout**: 60 seconds (allow time for large image processing)
- **VPC**: Connected to RDS, Redis, OpenSearch

### Error Scenarios

- Invalid file type → 400 VALIDATION_ERROR
- File too large → 400 VALIDATION_ERROR
- Sharp processing failure → 400 FILE_ERROR
- S3 upload failure → 500 INTERNAL_ERROR
- Database error → 500 DATABASE_ERROR
