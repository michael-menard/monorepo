schema: 1
story: 'wish-2000'
story_title: 'Database Schema & Shared Types'
gate: CONCERNS
status_reason: >-
  Story deliverables complete (7/7 ACs met, 31 schema tests passing), but pre-existing
  infrastructure issues in wishlist handlers require attention before production deployment.
  Redis cache is disabled but handlers still call it; schema inconsistencies between
  packages need resolution.
reviewer: 'Quinn (Test Architect)'
updated: '2025-12-27T00:00:00Z'

top_issues:
  - id: SEC-001
    category: security
    severity: high
    finding: 'Redis client disabled but handlers attempt to use it - will crash at runtime'
    file: 'apps/api/endpoints/wishlist/*/handler.ts'
    suggested_owner: dev
    suggested_action: 'Remove Redis calls or re-enable Redis infrastructure'

  - id: QUAL-001
    category: code_quality
    severity: high
    finding: 'Schema duplication between packages/core/api-client and apps/api/endpoints/wishlist/schemas'
    file: 'packages/core/api-client/src/schemas/wishlist.ts'
    suggested_owner: dev
    suggested_action: 'Consolidate to single source of truth in api-client package'

  - id: TEST-001
    category: test_coverage
    severity: high
    finding: 'No integration tests for wishlist API handlers (8 handlers, 0 tests)'
    file: 'apps/api/endpoints/wishlist/'
    suggested_owner: dev
    suggested_action: 'Create handler tests before deployment'

  - id: DEBT-002
    category: technical_debt
    severity: high
    finding: 'Datetime type inconsistency - handlers use z.date(), api-client uses z.string().datetime()'
    file: 'apps/api/endpoints/wishlist/schemas/index.ts'
    suggested_owner: dev
    suggested_action: 'Align to z.string().datetime() for JSON serialization consistency'

  - id: SEC-002
    category: security
    severity: high
    finding: 'Missing authorization check for sortOrder field in update-item handler'
    file: 'apps/api/endpoints/wishlist/update-item/handler.ts:106'
    suggested_owner: dev
    suggested_action: 'Remove sortOrder from UpdateWishlistItemSchema or use dedicated reorder endpoint'

  - id: PERF-002
    category: performance
    severity: medium
    finding: 'N+1 query pattern in reorder handler - individual UPDATE per item in loop'
    file: 'apps/api/endpoints/wishlist/reorder/handler.ts:76-85'
    suggested_owner: dev
    suggested_action: 'Use single UPDATE with CASE statement and IN clause'

waiver:
  active: false

quality_score: 62
expires: '2026-01-10T00:00:00Z'

evidence:
  tests_reviewed: 31
  files_analyzed: 15
  risks_identified: 6
  trace:
    ac_covered: [1, 2, 3, 4, 5, 6, 7]
    ac_gaps: []

nfr_validation:
  security:
    status: CONCERNS
    notes: 'Redis dependency will crash endpoints; sortOrder lacks authz check; OpenSearch data exposure risk'
  performance:
    status: CONCERNS
    notes: 'N+1 query in reorder; inefficient cache invalidation with redis.keys(); missing pagination in list'
  reliability:
    status: CONCERNS
    notes: 'Redis calls will throw errors; schema type mismatches may cause runtime issues'
  maintainability:
    status: CONCERNS
    notes: 'Schema duplication; cache helper duplicated 5x; inconsistent datetime handling'

recommendations:
  immediate:
    - action: 'Fix Redis dependency - either remove cache calls or stub with no-op'
      refs: ['apps/api/endpoints/wishlist/*/handler.ts']
    - action: 'Consolidate wishlist schemas to single source in api-client'
      refs: ['packages/core/api-client/src/schemas/wishlist.ts']
    - action: 'Create handler integration tests (at minimum for create, update, delete)'
      refs: ['apps/api/endpoints/wishlist/__tests__/']
  future:
    - action: 'Refactor reorder handler to use single bulk UPDATE query'
      refs: ['apps/api/endpoints/wishlist/reorder/handler.ts']
    - action: 'Standardize cache key patterns across handlers'
      refs: ['apps/api/endpoints/wishlist/_shared/cache-keys.ts']
    - action: 'Add enum validation for store and currency fields'
      refs: ['apps/api/endpoints/wishlist/schemas/index.ts']

specialist_findings_summary:
  requirements_traceability:
    total: 0
    note: 'All 7 ACs covered with test evidence; migration execution deferred to wish-2007'
  code_quality:
    total: 14
    high: 2
    medium: 6
    low: 6
  security:
    total: 9
    high: 3
    medium: 3
    low: 3
  performance:
    total: 11
    high: 1
    medium: 5
    low: 5
  accessibility:
    total: 6
    high: 0
    medium: 1
    low: 5
    note: 'Backend-only story, minimal direct A11Y impact'
  test_coverage:
    total: 20
    high: 2
    medium: 11
    low: 7
  technical_debt:
    total: 15
    high: 4
    medium: 9
    low: 2
