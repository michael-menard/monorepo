# Story 1.6: Theme Slice

## Status

Ready for Review

## Story

**As a** user,
**I want** to switch between light, dark, and system themes,
**so that** the app matches my visual preference.

## Acceptance Criteria

1. ✅ themeSlice created with theme: 'light' | 'dark' | 'system'
2. ✅ Resolved theme computed based on system preference
3. ✅ Theme persisted to localStorage
4. ✅ Theme restored from localStorage on init
5. ✅ Actions: setTheme, setSystemTheme, initializeTheme
6. ✅ Selectors: selectTheme, selectResolvedTheme, selectSystemTheme
7. ✅ System theme listener updates on OS change (via ThemeProvider)
8. ✅ Document class applied to <html> element (via ThemeProvider)

## Tasks / Subtasks

- [x] **Task 1: Verify Slice Structure** (AC: 1-6)
  - [x] Confirm themeSlice exists at `store/slices/themeSlice.ts`
  - [x] Check Theme type is 'light' | 'dark' | 'system'
  - [x] Verify resolvedTheme is computed via `getResolvedTheme()`
  - [x] Check localStorage persistence in setTheme action
  - [x] Verify initializeTheme loads from localStorage
  - [x] Confirm all selectors exported

- [x] **Task 2: Verify System Theme Listener** (AC: 7)
  - [x] ThemeProvider (from @repo/ui) sets up matchMedia listener
  - [x] Listener triggers on OS theme change
  - [x] resolvedTheme updates correctly for 'system' mode

- [x] **Task 3: Verify DOM Class Application** (AC: 8)
  - [x] ThemeProvider applies 'dark' class to document.documentElement
  - [x] Class updates when theme changes
  - [x] Tailwind dark: variants work via `darkMode: ['class']`

## Dev Notes

### Existing Implementation ✅

**File:** `apps/web/main-app/src/store/slices/themeSlice.ts`

Already implements:

- Theme type: 'light' | 'dark' | 'system'
- ThemeState with theme, resolvedTheme, systemTheme
- getSystemTheme() helper using matchMedia
- getResolvedTheme() helper for computing actual theme
- localStorage persistence with key 'main-app-theme'
- All required actions and selectors

### ThemeProvider Integration (from @repo/ui)

The `ThemeProvider` from `@repo/ui/providers/ThemeProvider` handles AC 7 and 8:

**System Theme Listener (lines 65-73):**

```typescript
const handleChange = () => {
  if (theme === 'system') {
    updateTheme()
  }
}
mediaQuery.addEventListener('change', handleChange)
return () => mediaQuery.removeEventListener('change', handleChange)
```

**DOM Class Application (lines 55-60):**

```typescript
if (newResolvedTheme === 'dark') {
  root.classList.add('dark')
} else {
  root.classList.remove('dark')
}
```

### Testing

ThemeProvider has comprehensive tests at `packages/core/ui/src/__tests__/ThemeProvider.test.tsx`:

- Default theme values
- localStorage persistence
- Dark class application
- System preference detection
- Custom storage key support

## Verification Summary

### themeSlice Implementation (src/store/slices/themeSlice.ts)

**State Shape:**

```typescript
interface ThemeState {
  theme: 'light' | 'dark' | 'system'
  resolvedTheme: 'light' | 'dark'
  systemTheme: 'light' | 'dark'
}
```

**Actions:**

- `setTheme(theme)` - Sets theme and persists to localStorage
- `setSystemTheme(theme)` - Updates system preference
- `initializeTheme()` - Loads theme from localStorage

**Selectors:**

- `selectTheme` - Current theme preference
- `selectResolvedTheme` - Actual applied theme
- `selectSystemTheme` - System preference

### App Integration

App.tsx wraps the app with ThemeProvider:

```typescript
<ThemeProvider defaultTheme="system" storageKey="main-app-theme">
```

This ensures:

- System theme listener is active
- DOM class application works
- localStorage key matches themeSlice

### Key Files

- `apps/web/main-app/src/store/slices/themeSlice.ts` - Redux slice
- `packages/core/ui/src/providers/ThemeProvider.tsx` - React provider
- `packages/core/ui/src/__tests__/ThemeProvider.test.tsx` - Tests

## Change Log

| Date       | Version | Description                                          | Author   |
| ---------- | ------- | ---------------------------------------------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft - partial implementation exists        | SM Agent |
| 2025-11-28 | 0.2     | Verification complete - all AC met via ThemeProvider | Claude   |
