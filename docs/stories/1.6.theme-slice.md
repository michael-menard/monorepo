# Story 1.6: Theme Slice

## Status

Approved

## Story

**As a** user,
**I want** to switch between light, dark, and system themes,
**so that** the app matches my visual preference.

## Acceptance Criteria

1. ✅ themeSlice created with theme: 'light' | 'dark' | 'system'
2. ✅ Resolved theme computed based on system preference
3. ✅ Theme persisted to localStorage
4. ✅ Theme restored from localStorage on init
5. ✅ Actions: setTheme, setSystemTheme, initializeTheme
6. ✅ Selectors: selectTheme, selectResolvedTheme, selectSystemTheme
7. ⬜ System theme listener updates on OS change
8. ⬜ Document class applied to <html> element

## Tasks / Subtasks

- [ ] **Task 1: Verify Slice Structure** (AC: 1-6)
  - [x] Confirm themeSlice exists
  - [x] Check Theme type is 'light' | 'dark' | 'system'
  - [x] Verify resolvedTheme is computed
  - [x] Check localStorage persistence in setTheme
  - [x] Verify initializeTheme loads from localStorage
  - [x] Confirm all selectors exported

- [ ] **Task 2: Verify System Theme Listener** (AC: 7)
  - [ ] Check if matchMedia listener is set up
  - [ ] Verify setSystemTheme is dispatched on OS change
  - [ ] Test that resolvedTheme updates correctly

- [ ] **Task 3: Verify DOM Class Application** (AC: 8)
  - [ ] Check if 'dark' class is applied to document.documentElement
  - [ ] Verify class updates when theme changes
  - [ ] Test Tailwind dark: variants work

## Dev Notes

### Existing Implementation ✅

**File:** `apps/web/main-app/src/store/slices/themeSlice.ts`

Already implements:

- Theme type: 'light' | 'dark' | 'system'
- ThemeState with theme, resolvedTheme, systemTheme
- getSystemTheme() helper using matchMedia
- getResolvedTheme() helper for computing actual theme
- localStorage persistence with key 'main-app-theme'
- All required actions and selectors

### Missing: System Theme Listener

Need to add a listener for OS theme changes:

```typescript
// In a useEffect or component
useEffect(() => {
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
  const handler = (e: MediaQueryListEvent) => {
    dispatch(setSystemTheme(e.matches ? 'dark' : 'light'))
  }
  mediaQuery.addEventListener('change', handler)
  return () => mediaQuery.removeEventListener('change', handler)
}, [dispatch])
```

### Missing: Document Class Application

Need to sync resolvedTheme to DOM:

```typescript
useEffect(() => {
  const root = document.documentElement
  root.classList.remove('light', 'dark')
  root.classList.add(resolvedTheme)
}, [resolvedTheme])
```

### Testing

- Unit test slice actions
- Test localStorage persistence
- Test system theme detection
- Verify dark class applies correctly

## Change Log

| Date       | Version | Description                                   | Author   |
| ---------- | ------- | --------------------------------------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft - partial implementation exists | SM Agent |
