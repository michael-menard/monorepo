# Story 1.17: Logout Flow

## Status

Ready for Review

## Story

**As a** user,
**I want** to log out and clear my session,
**so that** my account is secure on shared devices.

## Acceptance Criteria

1. ✅ Logout button in user menu
2. ✅ Calls Amplify signOut
3. ✅ Clears Redux auth state
4. ✅ Clears any cached data
5. ✅ Redirects to home or login page
6. ✅ Confirmation dialog (optional)

## Tasks / Subtasks

- [x] **Task 1: Logout Button** (AC: 1)
  - [x] Add logout option to user dropdown in Header
  - [x] Use @repo/ui DropdownMenuItem
  - [x] Show logout icon

- [x] **Task 2: Amplify Sign Out** (AC: 2)
  - [x] Import signOut from @aws-amplify/auth
  - [x] Call signOut({ global: true }) for all devices
  - [x] Handle errors gracefully

- [x] **Task 3: State Cleanup** (AC: 3-4)
  - [x] Dispatch setUnauthenticated
  - [x] Clear any RTK Query cache
  - [x] Clear Cognito token manager

- [x] **Task 4: Navigation** (AC: 5)
  - [x] Redirect to / after logout
  - [x] Use navigate from TanStack Router

- [x] **Task 5: Confirmation (Optional)** (AC: 6)
  - [x] Add confirmation dialog
  - [x] "You will need to sign in again to access your account."
  - [x] Use @repo/ui AlertDialog

## Dev Notes

### Amplify v6 Sign Out

```typescript
import { signOut } from '@aws-amplify/auth'

async function handleLogout() {
  try {
    await signOut({ global: true }) // Signs out from all devices
    dispatch(setUnauthenticated())
    navigate('/')
  } catch (error) {
    console.error('Logout error:', error)
    // Still clear local state
    dispatch(setUnauthenticated())
    navigate('/')
  }
}
```

### User Menu Integration

```typescript
// In Header.tsx
<DropdownMenu>
  <DropdownMenuTrigger>
    <Avatar src={user.avatar} />
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem>Profile</DropdownMenuItem>
    <DropdownMenuItem>Settings</DropdownMenuItem>
    <DropdownMenuSeparator />
    <DropdownMenuItem onClick={handleLogout}>
      <LogOut className="mr-2 h-4 w-4" />
      Log out
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

### Cache Clearing

```typescript
// Clear RTK Query cache
dispatch(api.util.resetApiState())

// Clear specific localStorage items
localStorage.removeItem('main-app-theme')
```

### Confirmation Dialog (Optional)

```typescript
<AlertDialog open={showConfirm}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Log out?</AlertDialogTitle>
      <AlertDialogDescription>
        You will need to sign in again to access your account.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction onClick={handleLogout}>Log out</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

### Testing

- Test logout clears auth state
- Test redirect after logout
- Test logout works even if Amplify fails
- Test confirmation dialog (if implemented)

## Change Log

| Date       | Version | Description                             | Author    |
| ---------- | ------- | --------------------------------------- | --------- |
| 2025-11-28 | 0.1     | Initial draft                           | SM Agent  |
| 2025-11-29 | 1.0     | Implementation complete - all AC passed | Dev Agent |

## QA Results

### Review Date: 2025-11-29

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review Depth: DEEP** (Auto-escalated)

- Auth/security files touched: `AuthProvider.tsx` handles session termination
- 6 acceptance criteria covering complete logout flow
- Security-critical: ensures sessions are properly terminated

### Requirements Traceability

| AC# | Acceptance Criteria        | Implementation                                                       | Test Coverage                      | Status      |
| --- | -------------------------- | -------------------------------------------------------------------- | ---------------------------------- | ----------- |
| 1   | Logout button in user menu | `Header.tsx:206-209` - DropdownMenuItem with LogOut icon             | `Header.test.tsx:293-297`          | ✅ Covered  |
| 2   | Calls Amplify signOut      | `AuthProvider.tsx:565` - `signOut({ global: true })`                 | `Header.test.tsx:324-336` (mocked) | ✅ Covered  |
| 3   | Clears Redux auth state    | `AuthProvider.tsx:579` - `dispatch(setUnauthenticated())`            | Indirect via mock                  | ⚠️ Indirect |
| 4   | Clears any cached data     | `AuthProvider.tsx:574-576` - resets 3 RTK Query APIs + token manager | Indirect via mock                  | ⚠️ Indirect |
| 5   | Redirects to home page     | `AuthProvider.tsx:582` - `navigate({ to: '/' })`                     | Indirect via mock                  | ⚠️ Indirect |
| 6   | Confirmation dialog        | `Header.tsx:238-251` - AlertDialog with Cancel/Log out               | `Header.test.tsx:308-356`          | ✅ Covered  |

**Given-When-Then Test Scenarios (Verified):**

```gherkin
# AC 1 & 6: Logout Button with Confirmation
Given an authenticated user
When they click "Sign out" in the user menu
Then a confirmation dialog appears with "Log out?" title
And shows "You will need to sign in again to access your account."
And has Cancel and Log out buttons

# AC 2-5: Complete Logout Flow
Given the user clicks "Log out" in the confirmation dialog
When signOut is called
Then Amplify signOut({ global: true }) is invoked
And Cognito token manager is cleared
And RTK Query caches are reset (galleryApi, wishlistApi, dashboardApi)
And Redux auth state is set to unauthenticated
And user is redirected to home page

# Error Handling
Given Amplify signOut fails
When the error is caught
Then local state is still cleared (setUnauthenticated)
And user is still redirected to home page
```

### Code Quality Assessment

**Strengths:**

- Well-structured separation: Header handles UI, AuthProvider handles logic
- Confirmation dialog implemented with proper @repo/ui AlertDialog components
- Error handling ensures local state is cleared even if Amplify fails (`AuthProvider.tsx:583-588`)
- Global sign out (`{ global: true }`) signs user out from all devices
- Comprehensive cache clearing: 3 RTK Query APIs + Cognito token manager

**Implementation Quality:**

- `Header.tsx:61-72` - Clean state management for confirmation dialog
- `AuthProvider.tsx:562-589` - Complete signOut implementation with AC comments
- Test file: 497 lines with dedicated logout flow tests

### Refactoring Performed

None. Code quality is excellent for the scope of this story.

### Compliance Check

- Coding Standards: ✅ Functional patterns, proper TypeScript, React hooks
- Project Structure: ✅ UI in Header, logic in AuthProvider per architecture
- Testing Strategy: ✅ Unit tests for UI interactions; signOut function mocked
- All ACs Met: ✅ All 6 acceptance criteria fully implemented

### Improvements Checklist

- [x] Logout button in user menu with LogOut icon (Header.tsx:206-209)
- [x] Confirmation dialog with proper messaging (Header.tsx:238-251)
- [x] Amplify signOut with global: true (AuthProvider.tsx:565)
- [x] Cognito token manager cleared (AuthProvider.tsx:567-571)
- [x] RTK Query caches reset (AuthProvider.tsx:574-576)
- [x] Redux auth state cleared (AuthProvider.tsx:579)
- [x] Redirect to home page (AuthProvider.tsx:582)
- [x] Error handling with fallback (AuthProvider.tsx:583-588)
- [x] UI tests for confirmation dialog (Header.test.tsx:308-356)
- [ ] Add unit test for AuthProvider.handleSignOut directly (currently tested via Header mock)

### Test Architecture Assessment

**Current Coverage:**

- `Header.test.tsx`: 497 lines, comprehensive UI tests including logout flow ✅
- Tests verify confirmation dialog appears, Cancel works, and signOut is called ✅
- signOut function is mocked - tests UI behavior, not implementation ✅

**Test Quality:**

- Follows AAA pattern (Arrange-Act-Assert)
- Uses proper React Testing Library patterns
- Mocks useAuth hook correctly

**Gaps Identified:**

- No direct unit test for `AuthProvider.handleSignOut` logic
- RTK Query cache reset not directly verified (mocked in tests)

**Recommended Test Level:**
| Scenario | Current Level | Status |
|----------|--------------|--------|
| UI: Logout button & dialog | Unit | ✅ Complete |
| signOut call | Unit (mocked) | ✅ Complete |
| Cache clearing | Not tested | ⚠️ Gap |
| Redirect after logout | Not tested | ⚠️ Gap |

### Security Review

- ✅ Global signOut (`{ global: true }`) terminates sessions on all devices
- ✅ Token manager cleared on logout
- ✅ RTK Query caches cleared (prevents data leakage to next user)
- ✅ Error handling still clears local state (secure fallback)
- ✅ Confirmation dialog prevents accidental logouts

### Performance Considerations

- ✅ Single async operation (signOut)
- ✅ Cache resets are synchronous dispatch calls
- ✅ No unnecessary re-renders during logout flow

### Files Modified During Review

None. No refactoring was performed.

### Gate Status

**Gate: PASS** → `docs/qa/gates/1.17-logout-flow.yml`

All 6 acceptance criteria are fully implemented with comprehensive UI test coverage. The logout flow correctly handles Amplify signOut, clears all caches, and includes a user-friendly confirmation dialog. Error handling ensures secure fallback.

### Recommended Status

**✓ Ready for Done**

Story owner can proceed to Done status. All acceptance criteria are met with high-quality implementation.
