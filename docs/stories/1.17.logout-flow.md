# Story 1.17: Logout Flow

## Status

Done ✅

## Story

**As a** user,
**I want** to log out and clear my session,
**so that** my account is secure on shared devices.

## Acceptance Criteria

1. ✅ Logout button in user menu
2. ✅ Calls Amplify signOut
3. ✅ Clears Redux auth state
4. ✅ Clears any cached data
5. ✅ Redirects to home or login page
6. ✅ Confirmation dialog (optional)

## Tasks / Subtasks

- [x] **Task 1: Logout Button** (AC: 1)
  - [x] Add logout option to user dropdown in Header
  - [x] Use @repo/ui DropdownMenuItem
  - [x] Show logout icon

- [x] **Task 2: Amplify Sign Out** (AC: 2)
  - [x] Import signOut from @aws-amplify/auth
  - [x] Call signOut({ global: true }) for all devices
  - [x] Handle errors gracefully

- [x] **Task 3: State Cleanup** (AC: 3-4)
  - [x] Dispatch setUnauthenticated
  - [x] Clear any RTK Query cache
  - [x] Clear Cognito token manager

- [x] **Task 4: Navigation** (AC: 5)
  - [x] Redirect to / after logout
  - [x] Use navigate from TanStack Router

- [x] **Task 5: Confirmation (Optional)** (AC: 6)
  - [x] Add confirmation dialog
  - [x] "You will need to sign in again to access your account."
  - [x] Use @repo/ui AlertDialog

## Dev Notes

### Amplify v6 Sign Out

```typescript
import { signOut } from '@aws-amplify/auth'

async function handleLogout() {
  try {
    await signOut({ global: true }) // Signs out from all devices
    dispatch(setUnauthenticated())
    navigate('/')
  } catch (error) {
    console.error('Logout error:', error)
    // Still clear local state
    dispatch(setUnauthenticated())
    navigate('/')
  }
}
```

### User Menu Integration

```typescript
// In Header.tsx
<DropdownMenu>
  <DropdownMenuTrigger>
    <Avatar src={user.avatar} />
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem>Profile</DropdownMenuItem>
    <DropdownMenuItem>Settings</DropdownMenuItem>
    <DropdownMenuSeparator />
    <DropdownMenuItem onClick={handleLogout}>
      <LogOut className="mr-2 h-4 w-4" />
      Log out
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

### Cache Clearing

```typescript
// Clear RTK Query cache
dispatch(api.util.resetApiState())

// Clear specific localStorage items
localStorage.removeItem('main-app-theme')
```

### Confirmation Dialog (Optional)

```typescript
<AlertDialog open={showConfirm}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Log out?</AlertDialogTitle>
      <AlertDialogDescription>
        You will need to sign in again to access your account.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction onClick={handleLogout}>Log out</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

### Testing

- Test logout clears auth state
- Test redirect after logout
- Test logout works even if Amplify fails
- Test confirmation dialog (if implemented)

## Change Log

| Date       | Version | Description                              | Author    |
| ---------- | ------- | ---------------------------------------- | --------- |
| 2025-11-28 | 0.1     | Initial draft                            | SM Agent  |
| 2025-11-29 | 1.0     | Implementation complete - all AC passed  | Dev Agent |
