# Story 4.1: Umami Deployment on ECS/Fargate

## Status

Draft

## Story

**As a** DevOps Engineer,
**I want** Umami analytics deployed on ECS/Fargate with Aurora database,
**so that** the Product team can access privacy-focused web analytics.

## Acceptance Criteria

1. Umami Docker image configured and tested locally
2. ECS task definition created for Umami (0.25-0.5 vCPU, 512MB-1GB RAM)
3. ECS service deployed in private subnet with ALB (or direct service discovery)
4. Environment variables configured (database connection, encryption keys)
5. Umami web UI accessible and initial admin account created
6. Health checks configured and ECS service auto-recovery validated

**Integration Verification:**

- IV1: Aurora database performance unaffected by Umami connections
- IV2: ECS deployment doesn't interfere with existing application infrastructure
- IV3: Network connectivity from frontend (CloudFront) to Umami tracking endpoint works

## Tasks / Subtasks

- [ ] **Task 1: Configure and test Umami Docker image locally** (AC: 1)
  - [ ] Pull official Umami Docker image (ghcr.io/umami-software/umami:postgresql-latest)
  - [ ] Create local Docker Compose configuration for testing
  - [ ] Configure environment variables for local PostgreSQL connection
  - [ ] Test Umami startup and web UI accessibility locally
  - [ ] Validate database schema creation and migration process
  - [ ] Create initial admin account and test basic functionality
  - [ ] Document Docker image configuration and requirements

- [ ] **Task 2: Create ECS task definition for Umami** (AC: 2, 4)
  - [ ] Create ECS task definition in SST configuration
  - [ ] Configure resource allocation: 0.25-0.5 vCPU, 512MB-1GB RAM
  - [ ] Set up environment variables for Aurora database connection:
    - DATABASE_URL (from existing Aurora PostgreSQL)
    - HASH_SALT (generated encryption key)
    - APP_SECRET (generated application secret)
  - [ ] Configure logging to CloudWatch Logs
  - [ ] Set up IAM task role with minimal required permissions
  - [ ] Apply comprehensive UserMetrics tagging schema

- [ ] **Task 3: Deploy ECS service with networking and load balancing** (AC: 3, 6)
  - [ ] Create ECS cluster (or use existing cluster if available)
  - [ ] Deploy ECS service in private subnet for security
  - [ ] Configure Application Load Balancer for Umami web UI access
  - [ ] Set up ALB target group with health checks (HTTP /api/heartbeat)
  - [ ] Configure security groups for ECS tasks and ALB
  - [ ] Set up service discovery for internal communication
  - [ ] Configure auto-scaling policies (min 1, max 2 tasks)

- [ ] **Task 4: Configure Aurora database integration** (AC: 4, IV1)
  - [ ] Create dedicated `umami` schema in existing Aurora PostgreSQL
  - [ ] Configure database connection pooling for ECS tasks
  - [ ] Set up database credentials via AWS Secrets Manager
  - [ ] Test database connectivity from ECS task
  - [ ] Validate Umami database migrations run successfully
  - [ ] Monitor Aurora performance impact from Umami connections
  - [ ] Configure appropriate database connection limits

- [ ] **Task 5: Set up Umami web UI and admin access** (AC: 5)
  - [ ] Access Umami web UI via ALB endpoint
  - [ ] Complete initial setup wizard and create admin account
  - [ ] Configure Umami settings (timezone, language, etc.)
  - [ ] Create initial website tracking configuration
  - [ ] Test Umami dashboard functionality and data visualization
  - [ ] Document admin credentials and access procedures
  - [ ] Set up user accounts for Product team members

- [ ] **Task 6: Implement health checks and monitoring** (AC: 6, IV2)
  - [ ] Configure ECS service health checks (HTTP /api/heartbeat)
  - [ ] Set up CloudWatch alarms for ECS task health
  - [ ] Configure auto-recovery for failed ECS tasks
  - [ ] Test ECS service restart and recovery scenarios
  - [ ] Monitor ECS resource utilization and performance
  - [ ] Validate ECS deployment doesn't impact existing infrastructure
  - [ ] Set up CloudWatch dashboard for Umami ECS metrics

- [ ] **Task 7: Validate network connectivity and integration** (AC: IV3)
  - [ ] Test network connectivity from frontend to Umami tracking endpoint
  - [ ] Validate CloudFront can reach Umami API endpoints
  - [ ] Configure CORS settings for frontend integration
  - [ ] Test Umami tracking script loading and functionality
  - [ ] Validate SSL/TLS configuration for secure connections
  - [ ] Test connectivity from different network environments
  - [ ] Document network configuration and firewall rules

- [ ] **Task 8: Create deployment documentation and runbook** (AC: 1-6)
  - [ ] Document Umami ECS deployment process and configuration
  - [ ] Create troubleshooting guide for common Umami issues
  - [ ] Document database schema and migration procedures
  - [ ] Create monitoring and alerting runbook
  - [ ] Document scaling and performance optimization procedures
  - [ ] Create backup and disaster recovery procedures
  - [ ] Document integration with existing infrastructure
