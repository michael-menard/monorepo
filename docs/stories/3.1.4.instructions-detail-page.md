# Story 3.1.4: Instructions Detail Page

## Status

Ready for Review

## Story

**As a** user,
**I want** to view full details of an instruction,
**so that** I can see all images and information about a MOC.

## Acceptance Criteria

1. ✅ Route `/instructions/:instructionId` configured
2. ✅ Displays all instruction images in gallery view
3. ✅ Shows instruction metadata (name, pieces, theme, tags)
4. ✅ Lightbox opens on image click
5. ✅ Back button returns to gallery
6. ✅ Edit button navigates to edit page
7. ⏸️ Linked inspiration images section (if any) - Deferred to API integration

## Tasks / Subtasks

- [x] **Task 1: Create Detail Route**
  - [x] Create route `/instructions/$instructionId` in main-app router
  - [x] Configure route params with TanStack Router
  - [x] Create InstructionsDetailModule wrapper in main-app

- [x] **Task 2: Detail Page Layout**
  - [x] Header with back button and title
  - [x] Image gallery section with thumbnails
  - [x] Metadata sidebar with piece count, theme, tags, description
  - [x] Actions (edit, favorite)
  - [x] PDF download button when available

- [x] **Task 3: Image Gallery**
  - [x] Grid of all instruction images using GalleryGrid
  - [x] Click to open lightbox with GalleryLightbox
  - [x] Navigate between images with useLightbox hook

- [ ] **Task 4: Linked Content** - Deferred
  - [ ] Show linked inspiration images (requires API)
  - [ ] Show if part of any sets (requires API)

## Dev Notes

### Route Structure

```typescript
// routes/instructions/$instructionId.tsx
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/instructions/$instructionId')({
  component: InstructionDetailPage,
  loader: ({ params }) => ({
    instructionId: params.instructionId,
  }),
})
```

### Page Component

```typescript
function InstructionDetailPage() {
  const { instructionId } = Route.useParams()
  const navigate = useNavigate()
  const { data: instruction, isLoading } = useGetInstructionByIdQuery(instructionId)
  const [lightboxOpen, setLightboxOpen] = useState(false)
  const [lightboxIndex, setLightboxIndex] = useState(0)

  if (isLoading) return <DetailPageSkeleton />
  if (!instruction) return <NotFound />

  return (
    <div className="container mx-auto py-6">
      {/* Header */}
      <div className="flex items-center gap-4 mb-6">
        <Button variant="ghost" onClick={() => navigate({ to: '/instructions' })}>
          <ArrowLeft className="w-4 h-4 mr-2" />
          Back
        </Button>
        <h1 className="text-2xl font-bold flex-1">{instruction.name}</h1>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => navigate({ to: '/instructions/$instructionId/edit', params: { instructionId } })}>
            <Pencil className="w-4 h-4 mr-2" />
            Edit
          </Button>
          <Button variant="ghost" size="icon">
            <Heart className={cn(instruction.isFavorite && 'fill-current text-red-500')} />
          </Button>
        </div>
      </div>

      {/* Content Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Images */}
        <div className="lg:col-span-2">
          <GalleryGrid columns={{ sm: 2, lg: 3 }}>
            {instruction.images.map((image, index) => (
              <div
                key={image.id}
                className="cursor-pointer"
                onClick={() => {
                  setLightboxIndex(index)
                  setLightboxOpen(true)
                }}
              >
                <img
                  src={image.thumbnail}
                  alt={`${instruction.name} image ${index + 1}`}
                  className="rounded-lg aspect-square object-cover"
                />
              </div>
            ))}
          </GalleryGrid>
        </div>

        {/* Metadata Sidebar */}
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Details</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <Label>Piece Count</Label>
                <p className="text-lg font-semibold">{instruction.pieceCount}</p>
              </div>
              <div>
                <Label>Theme</Label>
                <Badge>{instruction.theme}</Badge>
              </div>
              <div>
                <Label>Tags</Label>
                <div className="flex flex-wrap gap-1 mt-1">
                  {instruction.tags.map(tag => (
                    <Badge key={tag} variant="outline">{tag}</Badge>
                  ))}
                </div>
              </div>
              {instruction.pdfUrl && (
                <Button className="w-full" asChild>
                  <a href={instruction.pdfUrl} target="_blank" rel="noopener">
                    <Download className="w-4 h-4 mr-2" />
                    Download PDF
                  </a>
                </Button>
              )}
            </CardContent>
          </Card>

          {/* Linked Inspiration */}
          {instruction.linkedInspirations?.length > 0 && (
            <Card>
              <CardHeader>
                <CardTitle>Inspiration Images</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-3 gap-2">
                  {instruction.linkedInspirations.map(img => (
                    <img
                      key={img.id}
                      src={img.thumbnail}
                      alt=""
                      className="rounded aspect-square object-cover"
                    />
                  ))}
                </div>
              </CardContent>
            </Card>
          )}
        </div>
      </div>

      <GalleryLightbox
        images={instruction.images}
        initialIndex={lightboxIndex}
        open={lightboxOpen}
        onOpenChange={setLightboxOpen}
      />
    </div>
  )
}
```

## Testing

- [x] Route renders with valid ID (29 unit tests)
- [x] Not found state shown for invalid ID
- [x] Lightbox integrates with useLightbox hook
- [x] Back button triggers onBack callback
- [x] Edit button triggers onEdit callback with instruction ID
- [x] Favorite button triggers onFavorite callback
- [x] Loading skeleton displays during fetch
- [x] Error state displays with error message
- [ ] Linked content displays when present (deferred)

## Change Log

| Date       | Version | Description             | Author    |
| ---------- | ------- | ----------------------- | --------- |
| 2025-11-30 | 0.1     | Initial draft           | SM Agent  |
| 2025-12-05 | 0.2     | Implementation complete | Dev Agent |

## Dev Agent Record

### Implementation Summary

Implemented the Instructions Detail Page with full image gallery, metadata display, and lightbox functionality.

### Files Created

- `apps/web/app-instructions-gallery/src/pages/detail-page.tsx` - Main detail page component with loading, error, and not found states
- `apps/web/app-instructions-gallery/src/DetailModule.tsx` - Module wrapper for main-app integration
- `apps/web/app-instructions-gallery/src/pages/__tests__/detail-page.test.tsx` - 29 unit tests
- `apps/web/main-app/src/routes/modules/InstructionsDetailModule.tsx` - Main-app routing wrapper

### Files Modified

- `apps/web/app-instructions-gallery/src/__types__/index.ts` - Added description, images, pdfUrl, updatedAt fields
- `apps/web/app-instructions-gallery/src/index.ts` - Added exports for DetailModule and DetailPage
- `apps/web/app-instructions-gallery/src/pages/main-page.tsx` - Fixed icon prop type, added navigation
- `apps/web/main-app/src/routes/index.ts` - Added instructionDetailRoute
- `packages/core/gallery/src/index.ts` - Fixed duplicate GallerySortOption export

### Architecture Decisions

1. **Module Pattern**: Created DetailModule wrapper in micro-app for ThemeProvider and default handlers, with InstructionsDetailModule in main-app for routing integration
2. **Cross-Module Navigation**: Using `window.location.href` for navigation from gallery to detail page since micro-apps don't have internal routing
3. **Lightbox Integration**: Leveraged existing `useLightbox` hook and `GalleryLightbox` component from @repo/gallery
4. **Data Flow**: Props-based data flow from main-app to micro-app module, preparing for RTK Query integration

### Test Coverage

- 29 unit tests covering all states and interactions
- All tests passing
- Tests cover loading, error, not found, successful render, navigation, edit, favorite actions
