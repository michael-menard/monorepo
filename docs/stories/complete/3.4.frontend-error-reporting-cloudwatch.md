# Story 3.4: Frontend Error Reporting to CloudWatch

## Status

✅ **Completed**

## Story

**As a** Frontend Developer,
**I want** unhandled frontend errors reported to CloudWatch,
**so that** I can debug production issues via logs in Grafana.

## Acceptance Criteria

1. ✅ Error reporting module created in `src/lib/tracking/error-reporting.ts`
2. ✅ React error boundary implemented to catch component errors
3. ✅ Global error handler for unhandled promise rejections and window errors
4. ✅ Error context captured (user agent, URL, stack trace, user session ID)
5. ✅ Errors sent to CloudWatch via API Gateway endpoint (batched for efficiency)
6. ✅ PII excluded from error reports (no user email, names, etc.)

**Integration Verification:**

- ✅ IV1: Existing error handling preserved (errors still display to users appropriately)
- ✅ IV2: Application functionality unaffected by error boundary wrapping
- ✅ IV3: Error boundary doesn't mask errors in development environment

## Implementation Summary

### Architecture

The error reporting system consists of five main components:

1. **PII Sanitizer Package** (`packages/tools/pii-sanitizer`)
   - Comprehensive PII detection and sanitization
   - Removes emails, phones, credit cards, SSN, API keys, JWT tokens, AWS keys
   - Configurable sanitization options with partial redaction support
   - Full test coverage (48 passing tests)

2. **Frontend Error Reporting Module** (`apps/web/lego-moc-instructions-app/src/lib/tracking/error-reporting.ts`)
   - Captures and reports frontend errors
   - Session tracking with persistent session IDs
   - Batching support for efficiency
   - Environment-aware (console in dev, CloudWatch in prod)

3. **React ErrorBoundary** (`apps/web/lego-moc-instructions-app/src/components/ErrorBoundary.tsx`)
   - Catches React component errors
   - User-friendly fallback UI with error details
   - Reports errors to CloudWatch with component stack
   - Customizable fallback and error handlers

4. **Lambda Ingestion Function** (`apps/api/lego-api-serverless/src/lambda/tracking/frontend-error-ingestion.ts`)
   - Receives error reports from frontend
   - Supports both single and batch error payloads
   - Validates payloads with Zod schemas
   - Processes errors with fault tolerance

5. **CloudWatch Logging Module** (`apps/api/lego-api-serverless/src/lib/tracking/cloudwatch-frontend-errors.ts`)
   - Sanitizes errors using PII sanitizer
   - Logs structured error data to CloudWatch
   - Provides fields for CloudWatch Insights queries
   - Truncates stack traces to prevent excessive log size

### Features

#### PII Sanitization

All error data is sanitized before transmission:

- **Email addresses**: `user@example.com` → `[REDACTED]`
- **Phone numbers**: `555-123-4567` → `[REDACTED]`
- **Credit cards**: `4532-1234-5678-9010` → `[REDACTED]`
- **SSN**: `123-45-6789` → `[REDACTED]`
- **API Keys/Tokens**: Detected and redacted
- **JWT Tokens**: `eyJ...` → `[REDACTED]`
- **AWS Keys**: `AKIA...` → `[REDACTED]`
- **Sensitive field names**: `password`, `token`, `api_key`, etc. → `[REDACTED]`

**Partial Redaction Support:**

- Credit cards: `****-****-****-1234` (last 4 digits preserved)
- SSN: `***-**-6789` (last 4 digits preserved)
- Emails: `user***@example.com` (partial local part preserved)

#### Error Classification

Three error types are tracked:

1. **error**: Uncaught JavaScript errors (`window.onerror`)
2. **unhandledrejection**: Unhandled promise rejections
3. **react-error-boundary**: React component errors

#### Batching Strategy

- **Batch Size**: 10 errors (configurable)
- **Flush Interval**: 5000ms (configurable)
- **Critical Errors**: Sent immediately (React errors, ChunkLoadErrors)
- **Auto-flush**: On page visibility change and before unload

#### Error Context

Each error includes:

- Session ID (persistent across page loads)
- Timestamp (ISO format)
- URL and route
- User agent (optional, configurable)
- Error message, name, stack trace
- Component stack (for React errors)
- Custom metadata (userId, action, etc.)

### Files Created/Modified

#### New Files

**PII Sanitizer Package:**

- `packages/tools/pii-sanitizer/src/index.ts`
- `packages/tools/pii-sanitizer/src/patterns.ts`
- `packages/tools/pii-sanitizer/src/types.ts`
- `packages/tools/pii-sanitizer/src/validators.ts`
- `packages/tools/pii-sanitizer/src/sanitizer.ts`
- `packages/tools/pii-sanitizer/src/__tests__/sanitizer.test.ts`
- `packages/tools/pii-sanitizer/package.json`
- `packages/tools/pii-sanitizer/tsconfig.json`
- `packages/tools/pii-sanitizer/tsup.config.ts`
- `packages/tools/pii-sanitizer/vitest.config.ts`
- `packages/tools/pii-sanitizer/README.md`

**Backend:**

- `apps/api/lego-api-serverless/src/lambda/tracking/frontend-error-ingestion.ts`
- `apps/api/lego-api-serverless/src/lib/tracking/cloudwatch-frontend-errors.ts`

**Frontend:**

- `apps/web/lego-moc-instructions-app/src/lib/tracking/error-reporting.ts`
- `apps/web/lego-moc-instructions-app/src/components/ErrorBoundary.tsx`

**Documentation:**

- `apps/web/lego-moc-instructions-app/docs/error-reporting.md`
- `docs/stories/complete/3.4.frontend-error-reporting-cloudwatch.md`

#### Modified Files

- `apps/web/lego-moc-instructions-app/src/main.tsx`
  - Added ErrorBoundary wrapper
  - Added initErrorReporting() call

- `apps/api/lego-api-serverless/package.json`
  - Added @monorepo/pii-sanitizer dependency

### API Endpoint

**Endpoint:** `POST /api/tracking/errors`

**Single Error Payload:**

```json
{
  "type": "error",
  "sessionId": "1234567890-abc123",
  "timestamp": 1234567890000,
  "url": "https://example.com/profile",
  "userAgent": "Mozilla/5.0...",
  "error": {
    "message": "Error message",
    "name": "TypeError",
    "stack": "Error stack trace..."
  },
  "context": {
    "userId": "user-123",
    "route": "/profile",
    "action": "save-settings",
    "metadata": {}
  }
}
```

**Batch Error Payload:**

```json
{
  "sessionId": "1234567890-abc123",
  "errors": [
    {
      /* error 1 */
    },
    {
      /* error 2 */
    }
  ]
}
```

### CloudWatch Log Structure

```json
{
  "ErrorType": "react-error-boundary",
  "ErrorName": "TypeError",
  "ErrorMessage": "[REDACTED]",
  "SessionId": "1234567890-abc123",
  "Timestamp": 1234567890000,
  "ISOTimestamp": "2024-01-01T00:00:00.000Z",
  "URL": "[REDACTED]",
  "UserAgent": "Mozilla/5.0...",
  "Route": "/profile",
  "UserAction": "save-settings",
  "Stack": "[REDACTED stack trace...]",
  "ComponentStack": "[REDACTED component stack...]",
  "Metadata": {},
  "LogLevel": "ERROR",
  "Source": "Frontend"
}
```

### CloudWatch Insights Queries

**All Frontend Errors:**

```
fields @timestamp, ErrorType, ErrorName, ErrorMessage
| filter Source = "Frontend"
| sort @timestamp desc
| limit 100
```

**Error Count by Type:**

```
fields ErrorType
| filter Source = "Frontend"
| stats count() as Count by ErrorType
```

**Top Errors:**

```
fields ErrorName, ErrorMessage
| filter Source = "Frontend"
| stats count() as Count by ErrorName
| sort Count desc
| limit 10
```

**Errors by Session:**

```
fields @timestamp, ErrorType, ErrorName, ErrorMessage
| filter Source = "Frontend" and SessionId = "session-id"
| sort @timestamp asc
```

### Configuration

Error reporting is controlled via `src/config/performance.ts`:

```typescript
{
  enabled: true,
  production: {
    sendToAnalytics: true,
    batchSize: 10,
    flushInterval: 5000,
  },
  privacy: {
    anonymizeUserAgent: false,
  }
}
```

### Development vs Production

**Development Mode:**

- Errors logged to console only
- No CloudWatch transmission
- Full error details shown
- Development indicator in UI

**Production Mode:**

- Errors sent to CloudWatch
- PII sanitized
- User-friendly messages
- Batched for efficiency

## Tasks / Subtasks

- [x] **Task 1: Create error reporting module** (AC: 1, 6)
  - [x] Created PII sanitizer package in `packages/tools/pii-sanitizer`
  - [x] Defined comprehensive error data interfaces
  - [x] Implemented PII sanitization with configurable options
  - [x] Created error context extraction utilities
  - [x] Added environment-specific behavior
  - [x] Created comprehensive test suite (48 tests)

- [x] **Task 2: Implement React error boundary** (AC: 2, IV2)
  - [x] Created ErrorBoundary component in `src/components/ErrorBoundary.tsx`
  - [x] Implemented componentDidCatch with error reporting
  - [x] Created user-friendly fallback UI with error details toggle
  - [x] Added support for custom fallback and error handlers
  - [x] Preserved existing error display behavior
  - [x] Added context support for additional metadata

- [x] **Task 3: Implement global error handlers** (AC: 3, 4)
  - [x] Added window.onerror handler in error-reporting.ts
  - [x] Added unhandledrejection handler
  - [x] Implemented comprehensive error context capture
  - [x] Added session tracking with persistent IDs
  - [x] Integrated with performance configuration

- [x] **Task 4: Create Lambda function for error ingestion** (AC: 5)
  - [x] Created frontend-error-ingestion.ts Lambda function
  - [x] Implemented POST /api/tracking/errors endpoint
  - [x] Added Zod schema validation for payloads
  - [x] Created cloudwatch-frontend-errors.ts logging module
  - [x] Implemented error sanitization before logging
  - [x] Added support for batch and single error processing

- [x] **Task 5: Implement error batching and transmission** (AC: 5)
  - [x] Created error queue for batching
  - [x] Implemented configurable batch size and flush interval
  - [x] Added auto-flush on visibility change and before unload
  - [x] Implemented critical error immediate sending
  - [x] Added keepalive flag for reliable transmission
  - [x] Configured production-only transmission

- [x] **Task 6: Integrate error reporting with React application** (AC: 2, IV1, IV3)
  - [x] Wrapped App with ErrorBoundary in main.tsx
  - [x] Initialized global error handlers on startup
  - [x] Ensured development mode shows full errors
  - [x] Preserved user-facing error messages
  - [x] Added error reporting initialization

- [x] **Task 7: Documentation** (AC: 1-6)
  - [x] Created comprehensive error reporting documentation
  - [x] Documented PII sanitization rules and patterns
  - [x] Created CloudWatch Insights query examples
  - [x] Documented API endpoint and payload structure
  - [x] Added usage examples and best practices
  - [x] Created troubleshooting guide

## Next Steps

1. **Deploy to Production**: Deploy Lambda function and frontend changes
2. **Configure Grafana Dashboards**: Create error monitoring dashboards
3. **Set Up Alerts**: Configure CloudWatch alarms for error rate spikes
4. **Monitor Performance**: Track error reporting impact on application performance
5. **Refine Sanitization**: Add custom patterns based on production data

## Related Stories

- [Story 3.3: Frontend Web Vitals Tracking](./complete/3.3.frontend-web-vitals-tracking.md)
- [Story 2.1: Amazon Managed Grafana Workspace Provisioning](./2.1.amazon-managed-grafana-workspace-provisioning.md)

## References

- [Error Reporting Documentation](../../apps/web/lego-moc-instructions-app/docs/error-reporting.md)
- [PII Sanitizer Package](../../packages/tools/pii-sanitizer/README.md)
- [CloudWatch Logs Insights Query Syntax](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html)
