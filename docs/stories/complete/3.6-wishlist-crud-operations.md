# Story 3.6: Implement Wishlist CRUD Operations

**Epic**: 3 - Gallery & Wishlist APIs Migration

**As a** user,
**I want** to add, view, update, and delete items from my wishlist,
**so that** I can track LEGO sets I want to acquire.

## Acceptance Criteria

1. `POST /api/wishlist` creates item with fields: `title`, `description`, `productLink`, `imageUrl`, `category`, `sortOrder`
2. `GET /api/wishlist` returns all user's items sorted by `sortOrder` with optional `category` filter
3. `GET /api/wishlist/{id}` returns single item with ownership check
4. `PATCH /api/wishlist/{id}` updates item metadata with validation
5. `DELETE /api/wishlist/{id}` removes item and S3 image if present
6. `POST /api/wishlist/reorder` updates `sortOrder` for multiple items in batch transaction
7. Image upload support via separate endpoint `POST /api/wishlist/{id}/image` using Sharp processing (handled in Story 3.7)
8. Redis caching with pattern: `wishlist:user:{userId}:all`
9. OpenSearch indexing for wishlist search by title, description, category
10. All operations validate ownership and return appropriate errors

## Implementation Status

**Status**: ✅ Complete

**Implementation Date**: 2025-11-02

## Files Modified

1. **`apps/api/lego-api-serverless/src/functions/wishlist.ts`**
   - Implemented POST /api/wishlist (create item)
   - Implemented GET /api/wishlist (list with caching)
   - Implemented GET /api/wishlist/{id} (single item)
   - Implemented PATCH /api/wishlist/{id} (update)
   - Implemented DELETE /api/wishlist/{id} (with S3 cleanup)
   - Implemented POST /api/wishlist/reorder (batch transaction)
   - Added Redis caching with 5-10 minute TTLs
   - Added OpenSearch indexing for all operations
   - Added ownership validation for all operations

2. **`apps/api/lego-api-serverless/src/functions/__tests__/integration/wishlist.integration.test.ts`** (NEW)
   - 18 comprehensive integration tests covering all CRUD operations
   - Tests for caching, validation, error handling, ownership checks
   - All tests passing

## QA Results

**Quality Gate**: ✅ **PASS** (Score: 92/100)
**Reviewed By**: Quinn (Test Architect)
**Review Date**: 2025-11-02

### Test Results

- **Total Tests**: 18 integration tests
- **Pass Rate**: 100% (18/18 passing)
- **Coverage**: All 9 in-scope acceptance criteria covered
- **Test Quality**: Comprehensive Given-When-Then structure with mocked dependencies

### Code Quality Assessment

**Security** ✅ PASS

- JWT authentication on all endpoints (401 when missing)
- Ownership validation on all operations (403 for unauthorized)
- UUID validation via WishlistItemIdSchema before business logic
- Zod validation prevents injection attacks
- ZodError properly caught and sanitized to 400 responses

**Performance** ✅ PASS

- Redis caching with appropriate TTLs (5min list, 10min detail)
- Pattern-based cache invalidation on mutations
- Database transactions for batch reorder (ACID compliance)
- Efficient indexed queries (userId, sortOrder)
- OpenSearch indexing asynchronous

**Reliability** ✅ PASS

- Comprehensive error handling (400/401/403/404/500)
- S3 deletion wrapped as non-fatal operation
- Cache invalidation errors caught as non-fatal
- Database transaction rollback on failure
- 100% test pass rate validates error paths

**Maintainability** ✅ PASS

- Excellent JSDoc with Story AC references
- Consistent architecture pattern (matches gallery.ts)
- Type-safe with Zod schema validation
- Clear separation of concerns (6 handler functions)
- Well-documented caching and indexing strategy

### Strengths

- ✅ Outstanding test coverage with comprehensive scenarios
- ✅ Proper requirements traceability (AC refs in JSDoc)
- ✅ ZodError catch blocks added (improvement over Story 3.5)
- ✅ UUID validation addresses Story 3.5 concern SEC-001
- ✅ Ownership validation on all operations
- ✅ S3 cleanup with graceful failure handling
- ✅ Database transactions ensure atomicity

### Minor Observations (Low Priority)

- Console.error usage (codebase-wide pattern, 60+ occurrences across handlers)
- Cache key pattern variance (list vs detail) - functional but could be standardized
- Integration tests only (unit tests for individual handlers could be added)

### Gate Decision Rationale

Story 3.6 demonstrates production-ready quality with comprehensive testing, proper security controls, and excellent maintainability. All acceptance criteria implemented with robust error handling and type safety. Minor observations are cosmetic and don't impact functionality.

**Ready for Production Deployment** ✅

---

**Full Review Details**: See `docs/qa/gates/3.6-wishlist-crud-operations.yml`

---

## Requirements Traceability Matrix

| AC # | Requirement                       | Test Coverage | Status      |
| ---- | --------------------------------- | ------------- | ----------- |
| 1    | POST creates item with all fields | ✅ 2 tests    | ✅ COMPLETE |
| 2    | GET list sorted by sortOrder      | ✅ 3 tests    | ✅ COMPLETE |
| 3    | GET single with ownership check   | ✅ 4 tests    | ✅ COMPLETE |
| 4    | PATCH updates with validation     | ✅ 2 tests    | ✅ COMPLETE |
| 5    | DELETE removes item and S3 image  | ✅ 3 tests    | ✅ COMPLETE |
| 6    | POST reorder batch transaction    | ✅ 2 tests    | ✅ COMPLETE |
| 7    | Image upload endpoint (Story 3.7) | N/A           | ⏳ PENDING  |
| 8    | Redis caching pattern             | ✅ Tested     | ✅ COMPLETE |
| 9    | OpenSearch indexing               | ✅ Tested     | ✅ COMPLETE |
| 10   | Ownership validation & errors     | ✅ Tested     | ✅ COMPLETE |

**Overall Coverage: 100% (excluding AC #7 - deferred to Story 3.7)**

---

## Test Summary

**Total Tests**: 18 integration tests
**Status**: ✅ All Passing

### Test Coverage Details

1. **POST /api/wishlist** - 2 tests
   - ✅ Create item successfully with OpenSearch indexing
   - ✅ Validation errors (400 for invalid data)

2. **GET /api/wishlist** - 3 tests
   - ✅ Return cached items when available
   - ✅ Query database and cache results on cache miss
   - ✅ Filter items by category

3. **GET /api/wishlist/{id}** - 4 tests
   - ✅ Return cached item when available
   - ✅ Query database and cache result on cache miss
   - ✅ 404 not found
   - ✅ 403 forbidden (ownership)

4. **PATCH /api/wishlist/{id}** - 2 tests
   - ✅ Update item and invalidate caches
   - ✅ 403 forbidden (ownership)

5. **DELETE /api/wishlist/{id}** - 3 tests
   - ✅ Delete item with image and clean up S3
   - ✅ Delete item without image successfully
   - ✅ 403 forbidden (ownership)

6. **POST /api/wishlist/reorder** - 2 tests
   - ✅ Reorder items in batch transaction
   - ✅ 400 validation error when items not owned by user

7. **Error Handling** - 2 tests
   - ✅ 401 when user is not authenticated
   - ✅ 500 when database error occurs

---

## Technical Notes

### Database Schema

```typescript
wishlistItems = {
  id: uuid,
  userId: text,
  title: text,
  description: text,
  productLink: text,
  imageUrl: text,
  category: text,
  sortOrder: text, // ISO datetime for flexible ordering
  createdAt: timestamp,
  updatedAt: timestamp,
}
```

### SortOrder Pattern

- Default: Current timestamp (ISO 8601)
- Allows flexible reordering via string comparison
- Batch updates in `POST /api/wishlist/reorder`

### Caching Strategy

**Cache Keys**:

- List: `wishlist:user:{userId}:all`
- List with filter: `wishlist:user:{userId}:category:{category}`
- Detail: `wishlist:item:{itemId}`

**TTL**:

- List cache: 5 minutes
- Detail cache: 10 minutes

**Invalidation**:

- Create/Update/Delete: Invalidate all user's wishlist caches
- Pattern matching: `wishlist:user:{userId}:*`

### OpenSearch Indexing

**Index**: `wishlist_items`

**Document Structure**:

```json
{
  "id": "uuid",
  "userId": "cognito-sub",
  "title": "LEGO Set Name",
  "description": "Description text",
  "category": "Star Wars",
  "sortOrder": "2025-01-02T12:00:00Z",
  "createdAt": "2025-01-02T12:00:00Z"
}
```

**Searchable Fields**: title, description, category

### Error Handling

- **400 VALIDATION_ERROR**: Invalid input (missing fields, invalid format)
- **401 UNAUTHORIZED**: Missing JWT
- **403 FORBIDDEN**: Ownership mismatch
- **404 NOT_FOUND**: Item not found
- **500 INTERNAL_ERROR**: Database/S3/Redis failures

### Batch Reorder Transaction

```typescript
// POST /api/wishlist/reorder
{
  "items": [
    { "id": "uuid1", "sortOrder": "2025-01-02T12:00:00Z" },
    { "id": "uuid2", "sortOrder": "2025-01-02T13:00:00Z" }
  ]
}
```

- Use database transaction for atomicity
- Verify all items belong to user before update
- Invalidate all caches on success

---

## Dependencies

- **Story 3.5**: Wishlist Lambda handler infrastructure (prerequisite)
- **Story 3.7**: Image upload endpoint (independent, can run in parallel)
- **Story 3.8**: Search functionality (uses indexing from this story)
