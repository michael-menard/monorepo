# Story 1.19: Lazy Loading Setup

## Status

Approved

## Story

**As a** user,
**I want** domain apps to lazy load,
**so that** initial bundle size is small and pages load fast.

## Acceptance Criteria

1. ⬜ React.lazy() used for domain app modules
2. ⬜ Suspense boundary with fallback loading
3. ⬜ Code splitting verified in build output
4. ⬜ Module prefetch on hover (optional)
5. ⬜ Loading skeleton shown during load

## Tasks / Subtasks

- [ ] **Task 1: Verify Module Structure** (AC: 1)
  - [ ] Check routes/modules/ folder structure
  - [ ] Verify lazy() wraps module imports

- [ ] **Task 2: Suspense Configuration** (AC: 2, 5)
  - [ ] Suspense boundary in RootLayout
  - [ ] Fallback shows LoadingPage
  - [ ] Consider per-module Suspense

- [ ] **Task 3: Verify Code Splitting** (AC: 3)
  - [ ] Run production build
  - [ ] Check chunk files generated
  - [ ] Verify module chunks are separate

- [ ] **Task 4: Prefetch (Optional)** (AC: 4)
  - [ ] Add prefetch on Link hover
  - [ ] Use router.preloadRoute()

## Dev Notes

### Existing Module Pattern

**Files in:** `apps/web/main-app/src/routes/modules/`

- DashboardModule.tsx
- GalleryModule.tsx
- InstructionsModule.tsx
- WishlistModule.tsx

### Lazy Loading Pattern

```typescript
import { lazy, Suspense } from 'react'

const DashboardModule = lazy(() => import('./modules/DashboardModule'))
const GalleryModule = lazy(() => import('./modules/GalleryModule'))
const InstructionsModule = lazy(() => import('./modules/InstructionsModule'))
const WishlistModule = lazy(() => import('./modules/WishlistModule'))
```

### Suspense Boundary

```typescript
// In RootLayout or per-route
<Suspense fallback={<LoadingPage />}>
  <Outlet />
</Suspense>
```

### TanStack Router Lazy

TanStack Router supports lazy loading natively:

```typescript
export const Route = createFileRoute('/dashboard')({
  component: lazy(() => import('./DashboardPage')),
})
```

### Build Verification

```bash
pnpm build
# Check dist/assets/ for chunk files
# Look for: DashboardModule-[hash].js, etc.
```

### Vite Code Splitting Config

**File:** `apps/web/main-app/vite.config.ts`

```typescript
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        vendor: ['react', 'react-dom'],
        router: ['@tanstack/react-router'],
        redux: ['@reduxjs/toolkit', 'react-redux'],
      },
    },
  },
},
```

### Testing

- Test modules load on navigation
- Test loading fallback shows
- Verify chunks in build output
- Test prefetch on hover (if implemented)

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
