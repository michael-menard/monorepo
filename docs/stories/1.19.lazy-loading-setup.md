# Story 1.19: Lazy Loading Setup

## Status

Ready for Review

## Story

**As a** user,
**I want** domain apps to lazy load,
**so that** initial bundle size is small and pages load fast.

## Acceptance Criteria

1. ✅ React.lazy() used for domain app modules (TanStack Router dynamic import pattern)
2. ✅ Suspense boundary with fallback loading (pendingComponent: LoadingPage)
3. ✅ Code splitting verified in build output (separate chunk files)
4. ✅ Module prefetch on hover (defaultPreload: 'intent')
5. ✅ Loading skeleton shown during load (enhanced LoadingPage with skeleton)

## Tasks / Subtasks

- [x] **Task 1: Verify Module Structure** (AC: 1)
  - [x] Check routes/modules/ folder structure
  - [x] Verify dynamic import pattern in route definitions

- [x] **Task 2: Suspense Configuration** (AC: 2, 5)
  - [x] TanStack Router pendingComponent for each lazy route
  - [x] Enhanced LoadingPage with skeleton layout
  - [x] Animated skeleton cards with LEGO-themed styling

- [x] **Task 3: Verify Code Splitting** (AC: 3)
  - [x] Run production build
  - [x] Verified separate chunk files for each module
  - [x] DashboardModule, WishlistModule, InstructionsModule all split

- [x] **Task 4: Prefetch (Optional)** (AC: 4)
  - [x] defaultPreload: 'intent' configured in router
  - [x] Routes prefetch on link hover automatically

## Dev Notes

### Existing Module Pattern

**Files in:** `apps/web/main-app/src/routes/modules/`

- DashboardModule.tsx
- GalleryModule.tsx
- InstructionsModule.tsx
- WishlistModule.tsx

### Lazy Loading Pattern

```typescript
import { lazy, Suspense } from 'react'

const DashboardModule = lazy(() => import('./modules/DashboardModule'))
const GalleryModule = lazy(() => import('./modules/GalleryModule'))
const InstructionsModule = lazy(() => import('./modules/InstructionsModule'))
const WishlistModule = lazy(() => import('./modules/WishlistModule'))
```

### Suspense Boundary

```typescript
// In RootLayout or per-route
<Suspense fallback={<LoadingPage />}>
  <Outlet />
</Suspense>
```

### TanStack Router Lazy

TanStack Router supports lazy loading natively:

```typescript
export const Route = createFileRoute('/dashboard')({
  component: lazy(() => import('./DashboardPage')),
})
```

### Build Verification

```bash
pnpm build
# Check dist/assets/ for chunk files
# Look for: DashboardModule-[hash].js, etc.
```

### Vite Code Splitting Config

**File:** `apps/web/main-app/vite.config.ts`

```typescript
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        vendor: ['react', 'react-dom'],
        router: ['@tanstack/react-router'],
        redux: ['@reduxjs/toolkit', 'react-redux'],
      },
    },
  },
},
```

### Testing

- Test modules load on navigation
- Test loading fallback shows
- Verify chunks in build output
- Test prefetch on hover (if implemented)

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
| 2025-11-30 | 1.0     | Implementation complete | Dev Agent |

---

## Story Wrap-Up

### What was done

1. **Verified Lazy Loading Pattern** - All domain modules (Dashboard, Wishlist, Instructions) use TanStack Router's native lazy loading via dynamic `import()`:
   ```typescript
   component: () => import('./modules/DashboardModule').then(m => m.DashboardModule)
   ```

2. **Enhanced LoadingPage** - Updated `LoadingPage` component to show animated skeleton layout instead of simple spinner:
   - Skeleton header with icon and title placeholders
   - 6-card grid with staggered animation
   - LEGO-themed styling with motion effects

3. **Verified Code Splitting** - Production build confirms separate chunks:
   - `DashboardModule-*.js` (7.77 kB)
   - `WishlistModule-*.js` (14.99 kB)
   - `InstructionsModule-*.js` (2.45 kB)

4. **Prefetch Configuration** - Router configured with `defaultPreload: 'intent'` for automatic prefetch on hover

5. **Added Tests** - Extended router tests with lazy loading verification (15 tests total)

### Files Modified

| File | Change |
|------|--------|
| `apps/web/main-app/src/routes/pages/LoadingPage.tsx` | Enhanced with skeleton layout and animations |
| `apps/web/main-app/src/routes/__tests__/router.test.ts` | Added lazy loading tests |
| `docs/stories/1.19.lazy-loading-setup.md` | Updated status |

### Test Results

```
✓ src/lib/__tests__/route-guards.test.ts (23 tests)
✓ src/routes/__tests__/router.test.ts (15 tests)

Test Files: 2 passed
Tests: 38 passed
```

### Build Output

```
dist/assets/InstructionsModule-*.js    2.45 kB
dist/assets/DashboardModule-*.js       7.77 kB
dist/assets/WishlistModule-*.js       14.99 kB
dist/assets/vendor-*.js               11.84 kB
dist/assets/router-*.js               79.86 kB
dist/assets/auth-*.js                211.23 kB
```

### Technical Notes

- TanStack Router uses `pendingComponent` instead of React Suspense for route-level loading states
- The `defaultPreload: 'intent'` setting enables automatic prefetch when user hovers over links
- GalleryModule exists but is not yet in the route tree (future story)
