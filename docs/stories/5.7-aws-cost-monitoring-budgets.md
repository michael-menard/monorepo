# Story 5.7: Configure AWS Cost Monitoring and Budgets

**Epic**: 5 - Production Deployment, Monitoring & Cutover

**As a** DevOps engineer,
**I want** AWS Cost Monitoring and Budget alerts configured,
**so that** I can prevent unexpected cost overruns and optimize spending.

## Acceptance Criteria

1. AWS Budget created for monthly threshold: $800
2. Budget alerts at 50%, 75%, 90%, and 100% of threshold
3. SNS topic for budget alerts with email subscription
4. Cost allocation tags applied to all SST resources (`Project: lego-api`, `Environment: production`)
5. Cost Explorer enabled with custom reports for Lambda, API Gateway, RDS, ElastiCache, OpenSearch, S3
6. Daily cost anomaly detection enabled
7. Slack notifications for budget alerts and cost anomalies
8. Cost optimization recommendations reviewed monthly
9. Reserved Instance analysis for RDS and ElastiCache
10. S3 lifecycle policies to reduce storage costs

## Implementation Status

**Status**: Not Started

## Files Modified

_To be populated during implementation_

## QA Results

_Pending implementation and review_

---

## Requirements Traceability Matrix

| AC # | Requirement                            | Test Coverage | Status   |
| ---- | -------------------------------------- | ------------- | -------- |
| 1    | AWS Budget ($800 monthly threshold)    | TBD           | â³ PENDING |
| 2    | Budget alerts (50%, 75%, 90%, 100%)    | TBD           | â³ PENDING |
| 3    | SNS topic for budget alerts            | TBD           | â³ PENDING |
| 4    | Cost allocation tags                   | TBD           | â³ PENDING |
| 5    | Cost Explorer custom reports           | TBD           | â³ PENDING |
| 6    | Daily cost anomaly detection           | TBD           | â³ PENDING |
| 7    | Slack notifications                    | TBD           | â³ PENDING |
| 8    | Monthly cost optimization review       | TBD           | â³ PENDING |
| 9    | Reserved Instance analysis             | TBD           | â³ PENDING |
| 10   | S3 lifecycle policies                  | TBD           | â³ PENDING |

**Overall Coverage: TBD**

---

## Test Summary

_To be populated during implementation_

### Recommended Test Coverage

1. **Budget Alerts** - 4 tests
   - 50% threshold alert sent
   - 75% threshold alert sent
   - 90% threshold alert sent
   - 100% threshold alert sent

2. **Cost Anomaly Detection** - 2 tests
   - Anomaly detected (cost spike >20%)
   - Anomaly alert sent to Slack

3. **Cost Allocation Tags** - 1 test
   - Verify all SST resources have required tags

4. **S3 Lifecycle Policies** - 1 test
   - Objects transitioned to Glacier after 90 days

---

## Technical Notes

### AWS Budget Configuration

```typescript
// infra/monitoring/budgets.ts
import * as budgets from 'aws-cdk-lib/aws-budgets'
import * as sns from 'aws-cdk-lib/aws-sns'
import * as subscriptions from 'aws-cdk-lib/aws-sns-subscriptions'

export interface BudgetProps {
  readonly monthlyLimit: number // In USD
  readonly emailAddress: string
  readonly slackWebhookUrl?: string
}

export class CostMonitoringBudget extends Construct {
  public readonly budgetAlertTopic: sns.Topic

  constructor(scope: Construct, id: string, props: BudgetProps) {
    super(scope, id)

    // Create SNS topic for budget alerts
    this.budgetAlertTopic = new sns.Topic(this, 'BudgetAlertTopic', {
      topicName: 'lego-api-budget-alerts',
      displayName: 'LEGO API Budget Alerts',
    })

    // Subscribe email to SNS topic
    this.budgetAlertTopic.addSubscription(
      new subscriptions.EmailSubscription(props.emailAddress),
    )

    // If Slack webhook provided, create Lambda forwarder
    if (props.slackWebhookUrl) {
      this.addSlackIntegration(props.slackWebhookUrl)
    }

    // Create budget with multiple alert thresholds
    new budgets.CfnBudget(this, 'MonthlyBudget', {
      budget: {
        budgetName: 'lego-api-monthly-budget',
        budgetType: 'COST',
        timeUnit: 'MONTHLY',
        budgetLimit: {
          amount: props.monthlyLimit,
          unit: 'USD',
        },
        costFilters: {
          TagKeyValue: ['user:Project$lego-api'],
        },
      },
      notificationsWithSubscribers: [
        // 50% threshold
        {
          notification: {
            notificationType: 'ACTUAL',
            comparisonOperator: 'GREATER_THAN',
            threshold: 50,
            thresholdType: 'PERCENTAGE',
          },
          subscribers: [
            {
              subscriptionType: 'SNS',
              address: this.budgetAlertTopic.topicArn,
            },
          ],
        },
        // 75% threshold
        {
          notification: {
            notificationType: 'ACTUAL',
            comparisonOperator: 'GREATER_THAN',
            threshold: 75,
            thresholdType: 'PERCENTAGE',
          },
          subscribers: [
            {
              subscriptionType: 'SNS',
              address: this.budgetAlertTopic.topicArn,
            },
          ],
        },
        // 90% threshold
        {
          notification: {
            notificationType: 'ACTUAL',
            comparisonOperator: 'GREATER_THAN',
            threshold: 90,
            thresholdType: 'PERCENTAGE',
          },
          subscribers: [
            {
              subscriptionType: 'SNS',
              address: this.budgetAlertTopic.topicArn,
            },
          ],
        },
        // 100% threshold
        {
          notification: {
            notificationType: 'ACTUAL',
            comparisonOperator: 'GREATER_THAN',
            threshold: 100,
            thresholdType: 'PERCENTAGE',
          },
          subscribers: [
            {
              subscriptionType: 'SNS',
              address: this.budgetAlertTopic.topicArn,
            },
          ],
        },
        // Forecasted to exceed 100%
        {
          notification: {
            notificationType: 'FORECASTED',
            comparisonOperator: 'GREATER_THAN',
            threshold: 100,
            thresholdType: 'PERCENTAGE',
          },
          subscribers: [
            {
              subscriptionType: 'SNS',
              address: this.budgetAlertTopic.topicArn,
            },
          ],
        },
      ],
    })
  }

  private addSlackIntegration(webhookUrl: string): void {
    // Lambda function to forward budget alerts to Slack
    const slackForwarder = new lambda.Function(this, 'SlackForwarder', {
      runtime: lambda.Runtime.NODEJS_20_X,
      handler: 'index.handler',
      code: lambda.Code.fromInline(`
        const https = require('https');

        exports.handler = async (event) => {
          const snsMessage = JSON.parse(event.Records[0].Sns.Message);
          const budgetName = snsMessage.budgetName;
          const threshold = snsMessage.threshold;
          const currentSpend = snsMessage.currentSpend;
          const budgetLimit = snsMessage.budgetLimit;

          const percentUsed = ((currentSpend / budgetLimit) * 100).toFixed(2);
          const emoji = percentUsed >= 90 ? 'ðŸš¨' : percentUsed >= 75 ? 'âš ï¸' : 'ðŸ’°';

          const slackPayload = {
            attachments: [
              {
                color: percentUsed >= 90 ? 'danger' : percentUsed >= 75 ? 'warning' : 'good',
                title: \`\${emoji} AWS Budget Alert: \${budgetName}\`,
                fields: [
                  { title: 'Threshold', value: \`\${threshold}%\`, short: true },
                  { title: 'Current Spend', value: \`$\${currentSpend.toFixed(2)}\`, short: true },
                  { title: 'Budget Limit', value: \`$\${budgetLimit.toFixed(2)}\`, short: true },
                  { title: 'Percent Used', value: \`\${percentUsed}%\`, short: true },
                ],
                footer: 'AWS Cost Monitoring',
                ts: Math.floor(Date.now() / 1000),
              },
            ],
          };

          return new Promise((resolve, reject) => {
            const req = https.request('${webhookUrl}', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
            }, (res) => {
              resolve({ statusCode: res.statusCode });
            });

            req.on('error', reject);
            req.write(JSON.stringify(slackPayload));
            req.end();
          });
        };
      `),
      environment: {
        SLACK_WEBHOOK_URL: webhookUrl,
      },
    })

    // Subscribe Lambda to SNS topic
    this.budgetAlertTopic.addSubscription(
      new subscriptions.LambdaSubscription(slackForwarder),
    )
  }
}
```

### Cost Allocation Tags (SST Config)

```typescript
// sst.config.ts
export default $config({
  app(input) {
    return {
      name: 'lego-api',
      removal: input?.stage === 'production' ? 'retain' : 'remove',
      home: 'aws',
      // Apply cost allocation tags to all resources
      tags: {
        Project: 'lego-api',
        Environment: input?.stage || 'development',
        ManagedBy: 'SST',
        CostCenter: 'Engineering',
      },
    }
  },
  async run() {
    const stage = $app.stage

    // Lambda functions with cost allocation tags
    const mocFunction = new sst.aws.Function('MocFunction', {
      handler: 'src/functions/moc-instructions.handler',
      runtime: 'nodejs20.x',
      timeout: '60 seconds',
      memory: '1024 MB',
      vpc,
      link: [postgres, redis, openSearch, bucket],
      tags: {
        Component: 'MOC',
        BillingCategory: 'Lambda',
      },
    })

    // Similar for other functions (Gallery, Wishlist, Profile)
    // ...

    return {
      apiUrl: api.url,
    }
  },
})
```

### Cost Anomaly Detection

```typescript
// infra/monitoring/cost-anomaly-detection.ts
import * as ce from 'aws-cdk-lib/aws-ce'
import * as sns from 'aws-cdk-lib/aws-sns'

export class CostAnomalyDetection extends Construct {
  constructor(scope: Construct, id: string, alertTopic: sns.Topic) {
    super(scope, id)

    // Create cost anomaly monitor
    const anomalyMonitor = new ce.CfnAnomalyMonitor(this, 'AnomalyMonitor', {
      monitorName: 'lego-api-cost-anomaly-monitor',
      monitorType: 'DIMENSIONAL',
      monitorDimension: 'SERVICE',
    })

    // Create anomaly subscription
    new ce.CfnAnomalySubscription(this, 'AnomalySubscription', {
      subscriptionName: 'lego-api-cost-anomaly-alerts',
      frequency: 'DAILY',
      monitorArnList: [anomalyMonitor.attrMonitorArn],
      subscribers: [
        {
          type: 'SNS',
          address: alertTopic.topicArn,
        },
      ],
      threshold: 20, // Alert if cost anomaly >$20
      thresholdExpression: JSON.stringify({
        And: [
          {
            Dimensions: {
              Key: 'ANOMALY_TOTAL_IMPACT_ABSOLUTE',
              MatchOptions: ['GREATER_THAN_OR_EQUAL'],
              Values: ['20'],
            },
          },
        ],
      }),
    })
  }
}
```

### Cost Explorer Reports

```bash
# scripts/generate-cost-report.sh
#!/bin/bash

set -e

START_DATE=$(date -u -d '30 days ago' +%Y-%m-%d)
END_DATE=$(date -u +%Y-%m-%d)

echo "ðŸ“Š Generating Cost Explorer report for $START_DATE to $END_DATE..."

# Get cost by service
aws ce get-cost-and-usage \
  --time-period Start="$START_DATE",End="$END_DATE" \
  --granularity MONTHLY \
  --metrics "UnblendedCost" \
  --group-by Type=DIMENSION,Key=SERVICE \
  --filter file://cost-filter.json \
  --output json > reports/cost-by-service.json

# Get cost by day (for trend analysis)
aws ce get-cost-and-usage \
  --time-period Start="$START_DATE",End="$END_DATE" \
  --granularity DAILY \
  --metrics "UnblendedCost" \
  --filter file://cost-filter.json \
  --output json > reports/cost-by-day.json

# Generate human-readable summary
node scripts/format-cost-report.js

echo "âœ… Cost report generated: reports/cost-summary.txt"
```

### Cost Filter (LEGO API Resources)

```json
{
  "Tags": {
    "Key": "Project",
    "Values": ["lego-api"],
    "MatchOptions": ["EQUALS"]
  }
}
```

### S3 Lifecycle Policies

```typescript
// infra/storage/s3-lifecycle.ts
import * as s3 from 'aws-cdk-lib/aws-s3'

export class S3BucketWithLifecycle extends Construct {
  public readonly bucket: s3.Bucket

  constructor(scope: Construct, id: string) {
    super(scope, id)

    this.bucket = new s3.Bucket(this, 'LegoFilesBucket', {
      bucketName: 'lego-api-files-production',
      versioned: true,
      encryption: s3.BucketEncryption.S3_MANAGED,
      lifecycleRules: [
        // Transition MOC files to Intelligent-Tiering after 30 days
        {
          id: 'moc-files-intelligent-tiering',
          prefix: 'mocs/',
          transitions: [
            {
              storageClass: s3.StorageClass.INTELLIGENT_TIERING,
              transitionAfter: Duration.days(30),
            },
          ],
        },
        // Transition gallery images to Glacier after 90 days
        {
          id: 'gallery-images-glacier',
          prefix: 'gallery/',
          transitions: [
            {
              storageClass: s3.StorageClass.GLACIER,
              transitionAfter: Duration.days(90),
            },
          ],
        },
        // Delete temporary upload files after 7 days
        {
          id: 'temp-uploads-delete',
          prefix: 'temp/',
          expiration: Duration.days(7),
        },
        // Transition old versions to Glacier after 30 days
        {
          id: 'old-versions-glacier',
          noncurrentVersionTransitions: [
            {
              storageClass: s3.StorageClass.GLACIER,
              transitionAfter: Duration.days(30),
            },
          ],
        },
        // Delete old versions after 90 days
        {
          id: 'old-versions-delete',
          noncurrentVersionExpiration: Duration.days(90),
        },
      ],
    })
  }
}
```

### Reserved Instance Analysis Script

```typescript
// scripts/analyze-reserved-instances.ts
import { CostExplorerClient, GetReservationPurchaseRecommendationCommand } from '@aws-sdk/client-cost-explorer'

const costExplorer = new CostExplorerClient({ region: 'us-east-1' })

async function getReservedInstanceRecommendations() {
  // RDS Reserved Instance recommendations
  const rdsRecommendations = await costExplorer.send(new GetReservationPurchaseRecommendationCommand({
    Service: 'Amazon Relational Database Service',
    LookbackPeriodInDays: 'SIXTY_DAYS',
    TermInYears: 'ONE_YEAR',
    PaymentOption: 'NO_UPFRONT',
  }))

  // ElastiCache Reserved Node recommendations
  const elasticacheRecommendations = await costExplorer.send(new GetReservationPurchaseRecommendationCommand({
    Service: 'Amazon ElastiCache',
    LookbackPeriodInDays: 'SIXTY_DAYS',
    TermInYears: 'ONE_YEAR',
    PaymentOption: 'NO_UPFRONT',
  }))

  // OpenSearch Reserved Instance recommendations
  const openSearchRecommendations = await costExplorer.send(new GetReservationPurchaseRecommendationCommand({
    Service: 'Amazon OpenSearch Service',
    LookbackPeriodInDays: 'SIXTY_DAYS',
    TermInYears: 'ONE_YEAR',
    PaymentOption: 'NO_UPFRONT',
  }))

  console.log('\n=== Reserved Instance Recommendations ===\n')

  // RDS
  const rdsSavings = rdsRecommendations.Recommendations?.RecommendationDetails?.[0]?.EstimatedMonthlySavingsAmount || '0'
  console.log(`RDS: Estimated Monthly Savings: $${rdsSavings}`)

  // ElastiCache
  const elasticacheSavings = elasticacheRecommendations.Recommendations?.RecommendationDetails?.[0]?.EstimatedMonthlySavingsAmount || '0'
  console.log(`ElastiCache: Estimated Monthly Savings: $${elasticacheSavings}`)

  // OpenSearch
  const openSearchSavings = openSearchRecommendations.Recommendations?.RecommendationDetails?.[0]?.EstimatedMonthlySavingsAmount || '0'
  console.log(`OpenSearch: Estimated Monthly Savings: $${openSearchSavings}`)

  const totalSavings = parseFloat(rdsSavings) + parseFloat(elasticacheSavings) + parseFloat(openSearchSavings)
  console.log(`\nTotal Estimated Monthly Savings: $${totalSavings.toFixed(2)}`)

  if (totalSavings > 50) {
    console.log(`\nðŸ’¡ Recommendation: Purchase Reserved Instances to save $${totalSavings.toFixed(2)}/month`)
  } else {
    console.log(`\nâœ… Reserved Instances not cost-effective at current usage levels`)
  }
}

getReservedInstanceRecommendations()
```

### Monthly Cost Optimization Review Checklist

```markdown
# Monthly Cost Optimization Review

**Month**: January 2025
**Reviewed By**: DevOps Team

---

## Checklist

- [ ] Review AWS Budget alerts and anomalies
- [ ] Analyze Cost Explorer reports for trends
- [ ] Check Lambda memory/timeout configurations for optimization
- [ ] Review RDS instance sizes (right-sizing)
- [ ] Analyze ElastiCache utilization (right-sizing)
- [ ] Check OpenSearch instance sizes (right-sizing)
- [ ] Review S3 storage classes and lifecycle policies
- [ ] Analyze Reserved Instance recommendations
- [ ] Review unused or idle resources (CloudWatch)
- [ ] Check for orphaned resources (unattached EBS volumes, unused Elastic IPs)

---

## Findings

**Total Monthly Cost**: $720
**Target**: $800
**Status**: âœ… Under budget by $80

**Optimization Opportunities**:
1. RDS Reserved Instance: Save $30/month (15% savings on RDS)
2. S3 Lifecycle Policies: Applied, expect $5-10/month savings starting next month
3. Lambda Memory Optimization: MOC function reduced from 1024 MB to 512 MB, saving ~$5/month

**Actions Taken**:
- [x] Purchased RDS Reserved Instance (1-year, no upfront)
- [x] Applied S3 lifecycle policies
- [x] Optimized Lambda memory configurations

**Next Month Focus**:
- Monitor Reserved Instance savings
- Review ElastiCache utilization for potential downgrade

---

## Cost Breakdown

| Service | Current Month | Last Month | Change |
|---------|---------------|------------|--------|
| Lambda | $180 | $185 | -$5 (optimized memory) |
| API Gateway | $20 | $20 | $0 |
| RDS | $200 | $200 | $0 |
| ElastiCache | $100 | $100 | $0 |
| OpenSearch | $150 | $150 | $0 |
| S3 | $50 | $50 | $0 |
| Other | $20 | $25 | -$5 |
| **Total** | **$720** | **$730** | **-$10** |
```

---

## Design Decisions

### $800 Monthly Budget

**Decision**: Set monthly budget at $800

**Rationale**:
- SST projected cost: $700/month
- 14% buffer for traffic growth
- ECS baseline: $950/month
- Budget ensures cost savings maintained

### Multi-Threshold Alerts (50%, 75%, 90%, 100%)

**Decision**: Alert at 4 thresholds plus forecasted overage

**Rationale**:
- 50%: Early warning, time to investigate
- 75%: Actionable threshold, implement cost controls
- 90%: Urgent, requires immediate action
- 100%: Budget exceeded
- Forecasted: Prevents end-of-month surprises

### S3 Lifecycle Policies

**Decision**: Transition gallery images to Glacier after 90 days

**Rationale**:
- Gallery images rarely accessed after 90 days
- Glacier storage 90% cheaper than S3 Standard
- Retrieval time (3-5 hours) acceptable for old images
- Intelligent-Tiering for MOC files (unpredictable access patterns)

### Reserved Instances (RDS, ElastiCache, OpenSearch)

**Decision**: Purchase Reserved Instances if savings >$20/month

**Rationale**:
- 1-year term balances savings and flexibility
- No upfront payment option reduces risk
- Typical savings: 30-40% vs on-demand
- Production workloads have predictable usage

---

## Error Scenarios

| Scenario | Resolution |
|----------|------------|
| Budget exceeded | Investigate cost anomalies, implement temporary cost controls (reduce Lambda memory, disable non-critical features) |
| Cost anomaly detected | Review CloudWatch metrics, check for unexpected traffic spikes or misconfigurations |
| Budget alerts not received | Verify SNS subscription confirmed, check spam folder |
| Cost allocation tags missing | Apply tags via AWS Resource Tagging API or CDK update |

---

## Performance Considerations

1. **Budget Alert Latency**: Alerts sent within 24 hours of threshold breach
2. **Cost Anomaly Detection**: Daily analysis, alerts sent within 24 hours
3. **Cost Explorer Reports**: Data updated daily (24-48 hour delay)
4. **S3 Lifecycle Transitions**: Applied within 24 hours of eligibility

---

## Dependencies

- **AWS Budgets**: For budget thresholds and alerts
- **AWS Cost Explorer**: For cost analysis and trends
- **AWS Cost Anomaly Detection**: For automated anomaly detection
- **AWS SNS**: For budget alert notifications
- **AWS Lambda**: For Slack integration
- **AWS S3**: For lifecycle policies

---

## Future Enhancements

1. **Savings Plans**: Analyze Compute Savings Plans for Lambda
2. **Spot Instances**: Use Spot for non-critical workloads (dev/test)
3. **Auto-Scaling Cost Controls**: Automatically scale down during low-traffic hours
4. **Cost Allocation Reports**: Detailed cost breakdown by feature/API endpoint
5. **FinOps Dashboard**: Custom dashboard showing cost per user, cost per request

---

## Related Stories

- **Story 5.6**: Performance Validation - Cost validation is part of performance validation
- **Story 5.8**: ECS Decommission - Cost savings from decommissioning ECS
