# Story 1.13.7: Forgot Password Flow

## Status

Ready for Review

## Story

**As a** user who has forgotten my password,
**I want** to request a password reset code via email,
**so that** I can regain access to my account.

## Acceptance Criteria

1. ✅ Forgot password page at /forgot-password route
2. ✅ Email input with validation
3. ✅ Submit button calls Amplify resetPassword
4. ✅ Success message shows code was sent
5. ✅ Redirect to reset password page with email
6. ✅ Error handling for non-existent accounts (security-aware)
7. ✅ Rate limiting feedback (LimitExceededException)
8. ✅ Link back to login page
9. ✅ Accessible form with ARIA labels
10. ✅ Unit tests (33 tests passing)

## Tasks / Subtasks

- [x] **Task 1: Page Setup** (AC: 1, 8)
  - [x] Create/verify ForgotPasswordPage component
  - [x] Route at /forgot-password
  - [x] Use AuthLayout wrapper
  - [x] Back to login link

- [x] **Task 2: Form Implementation** (AC: 2)
  - [x] Email input field
  - [x] Zod validation schema
  - [x] Form state management

- [x] **Task 3: Amplify Integration** (AC: 3)
  - [x] Call forgotPassword from AuthProvider (uses Amplify resetPassword)
  - [x] Handle success response
  - [x] Pass email to reset password page via sessionStorage

- [x] **Task 4: Success Flow** (AC: 4, 5)
  - [x] Display success message and alert
  - [x] Show email where code was sent
  - [x] "Continue to Reset Password" button
  - [x] "Try a different email" button to reset form
  - [x] Pass email via sessionStorage (pendingResetEmail)

- [x] **Task 5: Error Handling** (AC: 6, 7)
  - [x] Handle UserNotFoundException - show success message (security)
  - [x] Handle LimitExceededException - show rate limit error
  - [x] Handle InvalidParameterException - show email validation error
  - [x] Handle both returned errors and thrown exceptions

- [x] **Task 6: Accessibility** (AC: 9)
  - [x] ARIA labels on inputs (aria-invalid, aria-describedby)
  - [x] Live region for screen reader announcements (aria-live="polite")
  - [x] role="status" for success alerts
  - [x] role="alert" for error alerts
  - [x] aria-hidden="true" on decorative icons
  - [x] autoComplete="email" on email input

- [x] **Task 7: Testing** (AC: 10)
  - [x] Unit tests for form validation (3 tests)
  - [x] Tests for success flow (7 tests)
  - [x] Tests for security/account enumeration prevention (2 tests)
  - [x] Tests for error scenarios (6 tests)
  - [x] Tests for loading state (1 test)
  - [x] Tests for accessibility (5 tests)
  - [x] Tests for navigation tracking (5 tests)
  - [x] Tests for rendering (5 tests)

## Dev Notes

### Amplify v6 Reset Password

```typescript
import { resetPassword } from 'aws-amplify/auth'

async function handleForgotPassword(email: string) {
  try {
    const result = await resetPassword({ username: email })

    // result.nextStep contains delivery details
    const { codeDeliveryDetails } = result.nextStep

    // Navigate to reset password page with email
    navigate('/reset-password', { state: { email } })

    return { success: true, deliveryDetails: codeDeliveryDetails }
  } catch (error) {
    if (error.name === 'UserNotFoundException') {
      // Don't reveal if user exists - show generic message
      return { success: true } // Still show "code sent" for security
    }
    if (error.name === 'LimitExceededException') {
      return { success: false, error: 'Too many attempts. Please try again later.' }
    }
    throw error
  }
}
```

### Implementation Details

The ForgotPasswordPage component is located at `apps/web/main-app/src/routes/pages/ForgotPasswordPage.tsx` with tests at `apps/web/main-app/src/routes/pages/__tests__/ForgotPasswordPage.test.tsx`.

Key features:
- Uses `useAuth().forgotPassword` which wraps Amplify's `resetPassword`
- Stores email in `sessionStorage.setItem('pendingResetEmail', email)` for reset password page
- Security-aware error handling: UserNotFoundException always shows success
- LEGO-themed branding consistent with other auth pages
- Framer Motion animations for smooth UX

### Error Messages

| Amplify Error             | User Message                               |
| ------------------------- | ------------------------------------------ |
| UserNotFoundException     | (Show success anyway for security)         |
| LimitExceededException    | Too many attempts. Please try again later. |
| InvalidParameterException | Please enter a valid email address.        |

### Security Note

For security, always show the same success message whether the email exists or not. This prevents account enumeration attacks.

## Dependencies

- Story 1.13.8: Reset Password Flow (Next step in flow)
- Story 1.14: Login Page (Link from login)

## Change Log

| Date       | Version | Description                                                        | Author      |
| ---------- | ------- | ------------------------------------------------------------------ | ----------- |
| 2025-11-28 | 0.1     | Initial draft                                                      | Claude Code |
| 2025-11-29 | 1.0     | Complete: All ACs met, 33 unit tests passing, security-aware flow  | Claude Code |
