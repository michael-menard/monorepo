# Story 1.2: Aurora PostgreSQL Schema for Umami

## Status
Draft

## Story
**As a** Database Administrator,
**I want** to create an isolated PostgreSQL schema in Aurora for Umami analytics,
**so that** Umami has dedicated database storage without impacting application data.

## Acceptance Criteria
1. New PostgreSQL schema `umami` created in existing Aurora instance
2. Dedicated database user created with permissions scoped to `umami` schema only
3. Connection string and credentials stored in AWS Secrets Manager
4. Schema isolation verified (Umami cannot access application schemas)
5. Database performance baseline documented before and after schema addition
6. Umami schema migrations (tables, indexes) applied successfully

**Integration Verification:**
- IV1: Existing application schemas remain untouched and functional
- IV2: Application database connections unaffected by new schema
- IV3: Aurora RDS metrics show no performance degradation (CPU, connections, IOPS)

## Tasks / Subtasks

- [ ] **Task 1: Document Aurora database baseline performance** (AC: 5, IV3)
  - [ ] Connect to Aurora database using existing credentials
  - [ ] Query current database size: `SELECT pg_database_size(current_database())/1024/1024 AS size_mb;`
  - [ ] Query current schema list: `SELECT schema_name FROM information_schema.schemata;`
  - [ ] Check CloudWatch RDS metrics (last 24 hours): CPU, connections, IOPS, storage
  - [ ] Document baseline in story completion notes (pre-Umami metrics for comparison)

- [ ] **Task 2: Create Umami PostgreSQL schema** (AC: 1)
  - [ ] Connect to Aurora with administrative credentials (master user or equivalent)
  - [ ] Execute SQL: `CREATE SCHEMA IF NOT EXISTS umami;`
  - [ ] Verify schema creation: `SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'umami';`
  - [ ] Document schema owner in completion notes

- [ ] **Task 3: Create dedicated Umami database user** (AC: 2, 4)
  - [ ] Generate secure random password using AWS Secrets Manager or `openssl rand -base64 32`
  - [ ] Execute SQL: `CREATE USER umami_user WITH PASSWORD '[generated-password]';`
  - [ ] Grant schema-only permissions:
    ```sql
    GRANT USAGE ON SCHEMA umami TO umami_user;
    GRANT CREATE ON SCHEMA umami TO umami_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA umami TO umami_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA umami TO umami_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA umami GRANT ALL ON TABLES TO umami_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA umami GRANT ALL ON SEQUENCES TO umami_user;
    ```
  - [ ] Verify user permissions: `SELECT grantee, privilege_type FROM information_schema.schema_privileges WHERE schema_name = 'umami';`

- [ ] **Task 4: Verify schema isolation** (AC: 4, IV1)
  - [ ] Test Umami user cannot access application schemas:
    ```sql
    -- Connect as umami_user
    SET ROLE umami_user;
    -- Attempt to list tables in application schema (should fail or return empty)
    SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';
    ```
  - [ ] Test Umami user can access umami schema:
    ```sql
    SET ROLE umami_user;
    SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'umami';
    ```
  - [ ] Document isolation verification results in completion notes

- [ ] **Task 5: Store connection credentials in AWS Secrets Manager** (AC: 3)
  - [ ] Create new secret via AWS CLI or SST construct:
    ```bash
    aws secretsmanager create-secret \
      --name observability/umami-db-credentials \
      --description "Umami database connection credentials" \
      --secret-string '{
        "username": "umami_user",
        "password": "[generated-password]",
        "host": "[aurora-endpoint]",
        "port": 5432,
        "database": "[database-name]",
        "schema": "umami"
      }' \
      --tags Key=Project,Value=UserMetrics Key=Component,Value=Database
    ```
  - [ ] Verify secret created: `aws secretsmanager describe-secret --secret-id observability/umami-db-credentials`
  - [ ] Document secret ARN in completion notes for use in Story 4.1 (Umami ECS deployment)

- [ ] **Task 6: Apply Umami schema migrations (dry-run)** (AC: 6)
  - [ ] Pull Umami Docker image: `docker pull ghcr.io/umami-software/umami:postgresql-latest`
  - [ ] Create local `.env` file with Umami connection string:
    ```bash
    DATABASE_URL=postgresql://umami_user:[password]@[aurora-endpoint]:5432/[database]?schema=umami
    ```
  - [ ] Run Umami migrations: `docker run --env-file .env ghcr.io/umami-software/umami:postgresql-latest prisma migrate deploy`
  - [ ] Verify Umami tables created: `SELECT table_name FROM information_schema.tables WHERE table_schema = 'umami' ORDER BY table_name;`
  - [ ] Document Umami table count (expected: ~10-15 tables including `_prisma_migrations`)

- [ ] **Task 7: Document post-migration performance metrics** (AC: 5, IV3)
  - [ ] Query database size after Umami schema: `SELECT pg_database_size(current_database())/1024/1024 AS size_mb;`
  - [ ] Query Umami schema size: `SELECT pg_total_relation_size('umami') / 1024 / 1024 AS umami_size_mb;`
  - [ ] Check CloudWatch RDS metrics (after migration): CPU, connections, IOPS, storage
  - [ ] Compare baseline vs. post-migration metrics in completion notes
  - [ ] Verify no degradation: CPU <5% increase, connections same or +1-2, IOPS within 10% variance

- [ ] **Task 8: Integration testing** (AC: IV1, IV2, IV3)
  - [ ] Test existing application endpoints to verify database connectivity unaffected
  - [ ] Check application Lambda function logs for successful database queries
  - [ ] Run application database migration status check (if migration framework exists)
  - [ ] Query application schema tables to verify no modifications: `SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';`
  - [ ] Document integration test results in completion notes

## Dev Notes

### Project Context
This story is **Story 1.2** from **Phase 1: Infrastructure Foundation** of the User Metrics PRD brownfield enhancement. This is the second story in Phase 1, following Story 1.1 (AWS Infrastructure Foundation Setup).

**Project:** User Tracking & Metrics Implementation (Brownfield Enhancement)
**Epic:** Phase 1 - Infrastructure Foundation (4 stories total)
**PRD Location:** `docs/prd/user-metrics/user-metrics-prd.md`
**Architecture:** `docs/prd/user-metrics/user-metrics-architecture.md`
**Phase File:** `docs/prd/user-metrics/phase-1.md`

### Previous Story Insights
**Story 1.1 (AWS Infrastructure Foundation Setup):**
- Established AWS infrastructure foundation including VPC, security groups, IAM roles
- Created centralized tagging configuration at `sst/observability/tags.ts`
- Deployed networking infrastructure for ECS services (Umami, OpenReplay)
- Applied comprehensive resource tagging schema (required + functional tags)

**Relevant Context from Story 1.1:**
- Aurora database already exists (pre-existing application infrastructure)
- Security groups created for ECS tasks that will connect to Aurora
- IAM roles for ECS task execution created (will need database access permissions)
- Resource tagging schema established for cost allocation and tracking

### Tech Stack for This Story
[Source: docs/architecture/tech-stack.md]

**Database:**
- **Aurora PostgreSQL** - Version 15.8 (existing instance)
- **PostgreSQL Schema Namespace** - For isolation (`umami` schema)
- **Connection Pooling** - RDS Proxy (if available) or native PostgreSQL connection pooling

**Infrastructure:**
- **AWS Secrets Manager** - For secure credential storage
- **AWS CLI** - For Secrets Manager operations
- **CloudWatch RDS Metrics** - For performance monitoring

**Development Tools:**
- **PostgreSQL Client** (`psql`) - For database administration
- **Docker** - For running Umami migrations locally
- **Umami Docker Image** - `ghcr.io/umami-software/umami:postgresql-latest`

### Source Tree Structure
[Source: docs/architecture/source-tree.md]

**Database Configuration Location:**
```
apps/api/lego-api-serverless/
├── sst.config.ts          # SST infrastructure configuration
├── sst/
│   └── observability/
│       └── tags.ts        # Tagging utilities (from Story 1.1)
├── drizzle.config.ts      # Existing Drizzle ORM configuration (application database)
└── src/
    └── db/
        └── schema/        # Existing application schema definitions
```

**Note:** This story does NOT modify existing database schema files. Umami manages its own schema within the `umami` PostgreSQL schema namespace.

**SST Secrets Manager Integration (Optional):**
If using SST to create the secret (alternative to AWS CLI):
```typescript
// In sst.config.ts
const umamiDbSecret = new Secret('UmamiDbCredentials');
```

### Umami Schema Details
[Source: docs/prd/user-metrics/user-metrics-architecture.md#data-models-and-schema-changes]

**Umami Analytics Schema:**
- **Purpose:** Store privacy-focused web analytics data (page views, sessions, events, traffic sources)
- **Integration:** Dedicated PostgreSQL schema `umami` in existing Aurora instance, completely isolated from application schemas
- **Schema Namespace:** `umami` (separate from application schemas like `public`)
- **Storage Estimate:** 100-500 MB for <100 users, 1-year retention
- **Tables (Umami-managed):** `website`, `session`, `pageview`, `event`, `event_data`, and others per Umami schema (managed by Prisma migrations)

**Access Control:**
- Dedicated database user `umami_user` with permissions scoped to `umami` schema only
- Application database users have no access to `umami` schema
- Connection string stored in AWS Secrets Manager (secret name: `observability/umami-db-credentials`)

**Schema Isolation Strategy:**
[Source: docs/prd/user-metrics/user-metrics-architecture.md#schema-integration-strategy]

PostgreSQL schema namespacing ensures zero interaction with application data:
- **Application schemas:** `public` (or other application-specific schemas)
- **Umami schema:** `umami` (completely isolated)
- **No foreign keys** or relationships between application and Umami data
- **Connection pooling:** Umami uses separate connection pool (no impact on application connection limits)

**Migration Strategy:**
1. **Story 1.2 (this story):** Create `umami` schema and `umami_user` database role
2. **Story 4.1 (Umami ECS deployment):** Umami Docker container executes schema migrations on first startup
3. **Validation:** Query Aurora performance metrics before and after Umami deployment
4. **Rollback:** Drop `umami` schema and revoke `umami_user` permissions if needed

### Database Administration Commands

**Connect to Aurora PostgreSQL:**
```bash
# Using psql client (requires Aurora endpoint and credentials)
psql -h [aurora-endpoint] -U [master-user] -d [database-name]
```

**Aurora Endpoint Retrieval:**
```bash
# Via AWS CLI
aws rds describe-db-clusters --db-cluster-identifier [cluster-id] \
  --query 'DBClusters[0].Endpoint' --output text

# Via SST (if Aurora provisioned via SST)
sst console --stage dev
# Navigate to database resource to view endpoint
```

**Schema and User Management:**
```sql
-- Create schema
CREATE SCHEMA IF NOT EXISTS umami;

-- Create user with password
CREATE USER umami_user WITH PASSWORD '[secure-password]';

-- Grant schema-level permissions
GRANT USAGE ON SCHEMA umami TO umami_user;
GRANT CREATE ON SCHEMA umami TO umami_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA umami TO umami_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA umami TO umami_user;

-- Set default privileges for future objects
ALTER DEFAULT PRIVILEGES IN SCHEMA umami GRANT ALL ON TABLES TO umami_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA umami GRANT ALL ON SEQUENCES TO umami_user;

-- Verify grants
SELECT grantee, privilege_type
FROM information_schema.schema_privileges
WHERE schema_name = 'umami';
```

**Performance Baseline Queries:**
```sql
-- Database size
SELECT pg_database_size(current_database())/1024/1024 AS size_mb;

-- Schema list
SELECT schema_name FROM information_schema.schemata;

-- Schema size (after Umami schema creation)
SELECT
  schemaname,
  pg_size_pretty(SUM(pg_total_relation_size(schemaname || '.' || tablename))::bigint) AS size
FROM pg_tables
GROUP BY schemaname;

-- Connection count
SELECT count(*) FROM pg_stat_activity;

-- Active queries
SELECT pid, usename, application_name, state, query
FROM pg_stat_activity
WHERE state = 'active';
```

### AWS Secrets Manager Integration

**Secret Structure for Umami Database Connection:**
```json
{
  "username": "umami_user",
  "password": "[generated-secure-password]",
  "host": "[aurora-cluster-endpoint]",
  "port": 5432,
  "database": "[database-name]",
  "schema": "umami"
}
```

**Create Secret via AWS CLI:**
```bash
aws secretsmanager create-secret \
  --name observability/umami-db-credentials \
  --description "Umami database connection credentials for Aurora PostgreSQL" \
  --secret-string '{
    "username": "umami_user",
    "password": "[password]",
    "host": "[aurora-endpoint]",
    "port": 5432,
    "database": "[database-name]",
    "schema": "umami"
  }' \
  --tags Key=Project,Value=UserMetrics Key=Component,Value=Database Key=Environment,Value=dev
```

**Retrieve Secret ARN (needed for ECS task definition in Story 4.1):**
```bash
aws secretsmanager describe-secret \
  --secret-id observability/umami-db-credentials \
  --query 'ARN' --output text
```

**Connection String Format for Umami:**
Umami uses Prisma and expects a DATABASE_URL environment variable:
```
DATABASE_URL=postgresql://umami_user:[password]@[host]:5432/[database]?schema=umami
```

### Umami Schema Migrations

**Umami Migration Approach:**
Umami uses Prisma as its ORM and migration tool. Schema migrations are managed by Prisma and executed when the Umami container starts for the first time.

**Expected Umami Tables (as of Umami v2.x):**
- `_prisma_migrations` - Prisma migration tracking
- `account` - User accounts for Umami admin interface
- `event` - Analytics events
- `event_data` - Event metadata
- `pageview` - Page view tracking
- `session` - User session data
- `website` - Website configurations
- `website_event` - Website-specific events
- And other supporting tables

**Running Migrations Locally (for validation):**
```bash
# Pull Umami image
docker pull ghcr.io/umami-software/umami:postgresql-latest

# Create .env file with DATABASE_URL
echo "DATABASE_URL=postgresql://umami_user:[password]@[host]:5432/[database]?schema=umami" > umami.env

# Run Prisma migrations
docker run --env-file umami.env ghcr.io/umami-software/umami:postgresql-latest \
  npx prisma migrate deploy
```

**Verify Migrations:**
```sql
-- Check migration status
SELECT * FROM umami._prisma_migrations ORDER BY started_at DESC;

-- List all Umami tables
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'umami'
ORDER BY table_name;

-- Count Umami tables (expected: 10-15 tables)
SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'umami';
```

### Performance Monitoring

**CloudWatch RDS Metrics to Monitor:**
[Source: docs/architecture/tech-stack.md]

Before and after Umami schema creation, monitor these Aurora metrics:
- **CPUUtilization** - Should remain <10% for <100 users (db.t4g.micro)
- **DatabaseConnections** - Existing connections + Umami connection pool (~5-10 connections)
- **ReadIOPS** / **WriteIOPS** - Baseline IOPS vs. post-migration IOPS
- **FreeableMemory** - Available memory on Aurora instance
- **FreeStorageSpace** - Disk space consumption (Umami adds ~100-500 MB initially)

**Performance Threshold Alerts:**
[Source: docs/prd/user-metrics/user-metrics-architecture.md#schema-integration-strategy]

Alert if:
- Aurora CPU exceeds 70%
- Connection count exceeds 80% of `max_connections`
- Storage growth exceeds expected rate (>1 GB/month for <100 users)

**CloudWatch Metrics Query (via AWS CLI):**
```bash
# CPU utilization (last 1 hour)
aws cloudwatch get-metric-statistics \
  --namespace AWS/RDS \
  --metric-name CPUUtilization \
  --dimensions Name=DBClusterIdentifier,Value=[cluster-id] \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average

# Database connections
aws cloudwatch get-metric-statistics \
  --namespace AWS/RDS \
  --metric-name DatabaseConnections \
  --dimensions Name=DBClusterIdentifier,Value=[cluster-id] \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average,Maximum
```

### Integration Constraints
[Source: docs/prd/user-metrics/user-metrics-prd.md - Compatibility Requirements]

**CR2: Database Schema Compatibility** - The Umami schema addition to Aurora PostgreSQL shall be isolated and not interfere with existing application schemas or impact database performance.

**Existing Infrastructure to Preserve:**
- Application schemas (typically `public` schema) - DO NOT modify
- Application database users and permissions - DO NOT modify
- Existing database connection pooling configuration - DO NOT modify
- Application Lambda functions' database connectivity - Must remain functional

**Rollback Plan:**
If issues arise, rollback is straightforward:
```sql
-- Revoke all privileges from umami_user
REVOKE ALL ON SCHEMA umami FROM umami_user;

-- Drop umami user
DROP USER IF EXISTS umami_user;

-- Drop umami schema (cascades to all tables)
DROP SCHEMA IF EXISTS umami CASCADE;

-- Verify removal
SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'umami';
```

### Cost Implications
[Source: docs/prd/user-metrics/user-metrics-prd.md - NFR1]

**Budget:** $100-150/month total for observability stack

**This Story's Cost Impact:**
- **Aurora Storage:** +100-500 MB (~$0.10-0.50/month for Aurora PostgreSQL storage)
- **Aurora I/O:** Minimal increase for <100 users (negligible cost)
- **Secrets Manager:** $0.40/month per secret + $0.05 per 10,000 API calls
- **Estimated Total:** ~$0.50-1.00/month

**Note:** Major Aurora costs (compute, I/O) are shared with existing application. Umami schema adds minimal incremental cost.

### Security Considerations

**Least-Privilege Access:**
- `umami_user` has NO access to application schemas (only `umami` schema)
- Application users have NO access to `umami` schema
- Master database user retained for administrative tasks only

**Credential Security:**
- Umami password generated with `openssl rand -base64 32` (256-bit entropy)
- Credentials stored in AWS Secrets Manager (encrypted at rest with KMS)
- No plaintext credentials in code or configuration files
- ECS task definition (Story 4.1) will reference secret ARN for secure injection

**Schema Isolation Validation:**
Must verify `umami_user` cannot:
- List tables in `public` schema
- Query data from application tables
- Execute DDL statements on application schemas
- Access system catalogs beyond necessary metadata queries

### Testing

**Testing Strategy:**
[Source: docs/architecture/coding-standards.md - Testing section]

**No Unit/Integration Tests Required:** This story creates database schema and users, not application code. Validation is done via:
1. SQL queries to verify schema and user creation
2. Permission verification queries
3. CloudWatch RDS metrics comparison (baseline vs. post-migration)
4. Integration tests of existing application functionality

**Manual Validation Checklist:**
- [ ] `umami` schema exists: `SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'umami';`
- [ ] `umami_user` exists: `SELECT usename FROM pg_user WHERE usename = 'umami_user';`
- [ ] `umami_user` has correct permissions on `umami` schema (USAGE, CREATE, ALL on tables/sequences)
- [ ] `umami_user` cannot access `public` schema (isolation verified)
- [ ] AWS Secrets Manager secret created with correct structure
- [ ] Umami tables created successfully (10-15 tables visible in `umami` schema)
- [ ] Aurora performance metrics unchanged (CPU, connections, IOPS within acceptable variance)

**Integration Tests:**
Verify existing application functionality:
```bash
# Test existing Lambda function database connectivity
curl https://[api-gateway-url]/health

# Check Lambda CloudWatch logs for database queries
aws logs tail /aws/lambda/[function-name] --follow

# Query application schema to ensure no modifications
psql -h [aurora-endpoint] -U [app-user] -d [database] \
  -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';"
```

**Performance Regression Tests:**
- Compare baseline (Task 1) vs. post-migration (Task 7) CloudWatch metrics
- CPU utilization delta should be <5%
- Connection count delta should be 0-2 connections
- IOPS delta should be within 10% variance
- Storage increase should match expected Umami schema size (~100-500 MB)

**E2E Tests:**
Not applicable for database schema story. No Playwright tests required.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-23 | 1.0 | Initial story creation from Phase 1 PRD | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_(To be populated by Dev Agent)_

### Debug Log References
_(To be populated by Dev Agent)_

### Completion Notes
_(To be populated by Dev Agent)_

### File List
_(To be populated by Dev Agent)_

## QA Results
_(To be populated by QA Agent)_
