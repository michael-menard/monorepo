# Story 3.2: Structured Logging Implementation

## Status

✅ **Completed** (2025-11-23)

## Story

**As a** Backend Developer,
**I want** structured JSON logging implemented across all Lambda functions,
**so that** logs are easily queryable in OpenSearch via Grafana.

## Acceptance Criteria

1. Winston or Pino logging library installed and configured
2. Structured log format defined (timestamp, level, message, context, requestId, userId if available)
3. Existing `console.log` statements migrated to structured logger
4. Log levels configured appropriately (ERROR, WARN, INFO, DEBUG)
5. Request correlation IDs added to all log entries for tracing
6. Log output validated in CloudWatch Logs with proper JSON structure

**Integration Verification:**

- IV1: All existing log statements still output (format changed but content preserved)
- IV2: Error handling and alerting based on logs still functional
- IV3: Log volume doesn't increase significantly (within CloudWatch budget)

## Implementation Summary

**Completed:** November 23, 2025

Successfully implemented structured JSON logging across all Lambda functions with correlation IDs, X-Ray integration, and comprehensive documentation.

### Key Components Implemented

1. **Lambda-Optimized Logger** (`packages/core/logger/src/lambda-logger.ts`)
   - Pino-based structured logger with pure JSON output
   - Automatic correlation ID generation: `{timestamp}-{random}`
   - X-Ray trace ID extraction from environment
   - Request-scoped child logger pattern
   - Environment-based log level configuration

2. **Enhanced Lambda Wrapper** (`apps/api/lego-api-serverless/src/lib/utils/lambda-wrapper.ts`)
   - Integrated LambdaLogger with full request context
   - Correlation ID generation and propagation
   - Response header: `X-Correlation-ID`
   - X-Ray annotations for correlation IDs
   - Structured error logging with stack traces

3. **Console.log Migration**
   - Migrated `cost-metrics-publisher.ts` Lambda (8 console statements → structured logger)
   - Migrated `budget-alerts.ts` handler (5 console statements → structured logger)
   - All Lambda handlers now use structured logging

4. **Comprehensive Documentation** (`apps/api/lego-api-serverless/docs/structured-logging.md`)
   - Log format specifications with all core fields
   - Correlation ID and X-Ray integration guide
   - CloudWatch Logs Insights query examples
   - Migration guide from console.log
   - Best practices and troubleshooting

### Log Format

```json
{
  "level": "INFO",
  "time": "2025-01-23T10:15:30.123Z",
  "context": "lambda-wrapper",
  "functionName": "GetMocById",
  "requestId": "abc123-def456",
  "correlationId": "1706005530123-a1b2c3d4",
  "traceId": "1-5e645f3e-1234567890abcdef",
  "userId": "user-123",
  "method": "GET",
  "path": "/api/mocs/123",
  "msg": "Incoming request"
}
```

## Tasks / Subtasks

- [x] **Task 1: Install and configure structured logging library** (AC: 1, 4)
  - [x] Install Pino logging library (faster than Winston for Lambda)
  - [x] Create logging configuration module in `packages/core/logger/src/lambda-logger.ts`
  - [x] Configure log levels: ERROR, WARN, INFO, DEBUG
  - [x] Set up environment-specific log level filtering (DEBUG in dev, INFO in prod)
  - [x] Configure JSON output format for CloudWatch Logs compatibility
  - [x] Test logger initialization and basic log output

- [x] **Task 2: Define structured log format schema** (AC: 2, 5)
  - [x] Create standardized log entry interface (LambdaLogContext)
  - [x] Create log context builder utility (child() method)
  - [x] Implement correlation ID generation and propagation
  - [x] Test log format with sample entries

- [x] **Task 3: Integrate structured logger with Lambda wrapper** (AC: 2, 5)
  - [x] Modify existing `lambda-wrapper.ts` to use structured logger
  - [x] Extract request context for logging (requestId, userId, method, path)
  - [x] Add correlation ID generation and propagation
  - [x] Integrate with existing X-Ray tracing (include traceId in logs)
  - [x] Preserve existing error handling and response logging
  - [x] Ensure structured logs include all necessary context

- [x] **Task 4: Migrate existing console.log statements** (AC: 3, IV1)
  - [x] Audit all Lambda functions for console.log, console.error, console.warn usage
  - [x] Replace console statements with structured logger calls in cost-metrics-publisher.ts
  - [x] Replace console statements with structured logger calls in budget-alerts.ts
  - [x] Preserve existing log message content and context
  - [x] Update error logging to include stack traces in structured format
  - [x] Test each migrated function to ensure log content preserved

- [x] **Task 5: Implement request correlation and tracing** (AC: 5)
  - [x] Generate unique correlation ID for each Lambda invocation
  - [x] Propagate correlation ID through all log entries in request
  - [x] Integrate correlation ID with X-Ray trace ID when available
  - [x] Add correlation ID to Lambda response headers for client tracing
  - [x] Implement correlation ID extraction from incoming requests
  - [x] X-Ray annotation support for correlation IDs

- [ ] **Task 6: Validate structured logging in CloudWatch** (AC: 6, IV2, IV3)
  - [ ] Deploy functions with structured logging to dev environment
  - [ ] Generate test traffic to produce log entries
  - [ ] Verify logs appear as valid JSON in CloudWatch Logs
  - [ ] Test log parsing and querying in CloudWatch Logs Insights
  - [ ] Validate existing error alerting still functions correctly
  - [ ] Monitor log volume to ensure within budget constraints
  - [ ] Test log searchability and filtering capabilities
  - **Note:** Task 6 moved to Story 3.2.1 (Validate Structured Logging in CloudWatch) - requires deployment

- [x] **Task 7: Create logging documentation and best practices** (AC: 1-6)
  - [x] Document structured logging format and schema
  - [x] Create logging best practices guide for developers
  - [x] Document correlation ID usage and tracing patterns
  - [x] Create troubleshooting guide for logging issues
  - [x] Document integration with OpenSearch and Grafana log analysis
  - [x] Create examples of effective log queries for common scenarios
