# Story 3.2: Structured Logging Implementation

## Status

Draft

## Story

**As a** Backend Developer,
**I want** structured JSON logging implemented across all Lambda functions,
**so that** logs are easily queryable in OpenSearch via Grafana.

## Acceptance Criteria

1. Winston or Pino logging library installed and configured
2. Structured log format defined (timestamp, level, message, context, requestId, userId if available)
3. Existing `console.log` statements migrated to structured logger
4. Log levels configured appropriately (ERROR, WARN, INFO, DEBUG)
5. Request correlation IDs added to all log entries for tracing
6. Log output validated in CloudWatch Logs with proper JSON structure

**Integration Verification:**

- IV1: All existing log statements still output (format changed but content preserved)
- IV2: Error handling and alerting based on logs still functional
- IV3: Log volume doesn't increase significantly (within CloudWatch budget)

## Tasks / Subtasks

- [ ] **Task 1: Install and configure structured logging library** (AC: 1, 4)
  - [ ] Install Pino logging library (faster than Winston for Lambda)
  - [ ] Create logging configuration module in `src/lib/utils/logger.ts`
  - [ ] Configure log levels: ERROR, WARN, INFO, DEBUG
  - [ ] Set up environment-specific log level filtering (DEBUG in dev, INFO in prod)
  - [ ] Configure JSON output format for CloudWatch Logs compatibility
  - [ ] Test logger initialization and basic log output

- [ ] **Task 2: Define structured log format schema** (AC: 2, 5)
  - [ ] Create standardized log entry interface:
    - timestamp (ISO 8601)
    - level (ERROR, WARN, INFO, DEBUG)
    - message (human-readable)
    - context (structured data)
    - requestId (correlation ID)
    - userId (if available from JWT)
    - functionName (Lambda function name)
    - traceId (X-Ray trace ID if available)
  - [ ] Create log context builder utility
  - [ ] Implement correlation ID generation and propagation
  - [ ] Test log format with sample entries

- [ ] **Task 3: Integrate structured logger with Lambda wrapper** (AC: 2, 5)
  - [ ] Modify existing `lambda-wrapper.ts` to use structured logger
  - [ ] Extract request context for logging (requestId, userId, method, path)
  - [ ] Add correlation ID generation and propagation
  - [ ] Integrate with existing X-Ray tracing (include traceId in logs)
  - [ ] Preserve existing error handling and response logging
  - [ ] Ensure structured logs include all necessary context

- [ ] **Task 4: Migrate existing console.log statements** (AC: 3, IV1)
  - [ ] Audit all Lambda functions for console.log, console.error, console.warn usage
  - [ ] Replace console statements with structured logger calls:
    - console.log → logger.info
    - console.error → logger.error
    - console.warn → logger.warn
    - console.debug → logger.debug
  - [ ] Preserve existing log message content and context
  - [ ] Update error logging to include stack traces in structured format
  - [ ] Test each migrated function to ensure log content preserved

- [ ] **Task 5: Implement request correlation and tracing** (AC: 5)
  - [ ] Generate unique correlation ID for each Lambda invocation
  - [ ] Propagate correlation ID through all log entries in request
  - [ ] Integrate correlation ID with X-Ray trace ID when available
  - [ ] Add correlation ID to Lambda response headers for client tracing
  - [ ] Implement correlation ID extraction from incoming requests
  - [ ] Test correlation ID propagation across function calls

- [ ] **Task 6: Validate structured logging in CloudWatch** (AC: 6, IV2, IV3)
  - [ ] Deploy functions with structured logging to dev environment
  - [ ] Generate test traffic to produce log entries
  - [ ] Verify logs appear as valid JSON in CloudWatch Logs
  - [ ] Test log parsing and querying in CloudWatch Logs Insights
  - [ ] Validate existing error alerting still functions correctly
  - [ ] Monitor log volume to ensure within budget constraints
  - [ ] Test log searchability and filtering capabilities

- [ ] **Task 7: Create logging documentation and best practices** (AC: 1-6)
  - [ ] Document structured logging format and schema
  - [ ] Create logging best practices guide for developers
  - [ ] Document correlation ID usage and tracing patterns
  - [ ] Create troubleshooting guide for logging issues
  - [ ] Document integration with OpenSearch and Grafana log analysis
  - [ ] Create examples of effective log queries for common scenarios
