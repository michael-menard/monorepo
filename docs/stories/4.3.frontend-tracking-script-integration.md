# Story 4.3: Frontend Tracking Script Integration (Umami + OpenReplay)

## Status

Draft

## Story

**As a** Frontend Developer,
**I want** Umami and OpenReplay tracking scripts integrated into the React app,
**so that** user sessions and analytics are captured from production traffic.

## Acceptance Criteria

1. OpenReplay SDK installed via npm (`@openreplay/tracker`)
2. Umami tracking script integration configured (script tag or npm package)
3. Tracking initialization module created in `src/lib/tracking/` directory
4. Initialization happens in `main.tsx` before React render, asynchronously
5. Environment detection prevents tracking in development mode (optional based on preference)
6. Session recording and analytics events verified in respective UIs

**Integration Verification:**

- IV1: Vite HMR works correctly in development with tracking code present
- IV2: Production build succeeds and application loads without errors
- IV3: Tracking scripts don't block React render or impact initial page load

## Tasks / Subtasks

- [ ] **Task 1: Install OpenReplay SDK and dependencies** (AC: 1)
  - [ ] Install `@openreplay/tracker` npm package in frontend project
  - [ ] Install additional OpenReplay plugins if needed (tracker-redux, tracker-fetch)
  - [ ] Update package.json and verify dependency compatibility
  - [ ] Test OpenReplay SDK import and basic initialization
  - [ ] Configure TypeScript types for OpenReplay SDK
  - [ ] Validate OpenReplay SDK works with Vite build system

- [ ] **Task 2: Configure Umami tracking integration** (AC: 2)
  - [ ] Choose Umami integration method (script tag vs npm package)
  - [ ] If using script tag: Configure dynamic script loading
  - [ ] If using npm: Install umami tracking package
  - [ ] Configure Umami tracking script with site ID and endpoint
  - [ ] Set up Umami tracking configuration (auto-track, domains)
  - [ ] Test Umami tracking script loading and initialization
  - [ ] Validate Umami tracking works with React Router

- [ ] **Task 3: Create tracking initialization module** (AC: 3, 4)
  - [ ] Create `src/lib/tracking/index.ts` as main tracking module
  - [ ] Create `src/lib/tracking/openreplay.ts` for OpenReplay configuration
  - [ ] Create `src/lib/tracking/umami.ts` for Umami configuration
  - [ ] Implement environment detection and conditional initialization
  - [ ] Configure tracking initialization to be asynchronous and non-blocking
  - [ ] Add error handling for tracking initialization failures
  - [ ] Create tracking configuration interface and types

- [ ] **Task 4: Integrate tracking initialization in main.tsx** (AC: 4, IV3)
  - [ ] Modify `main.tsx` to initialize tracking before React render
  - [ ] Ensure tracking initialization is asynchronous and non-blocking
  - [ ] Add error boundaries to prevent tracking errors from breaking app
  - [ ] Configure tracking to start after DOM content loaded
  - [ ] Test that tracking initialization doesn't delay React render
  - [ ] Validate application loads correctly with tracking enabled
  - [ ] Monitor initial page load performance impact

- [ ] **Task 5: Configure environment-specific tracking behavior** (AC: 5)
  - [ ] Implement environment detection (development vs production)
  - [ ] Configure tracking to be disabled in development mode (optional)
  - [ ] Set up environment-specific tracking endpoints and configuration
  - [ ] Configure different tracking behavior for staging vs production
  - [ ] Add console logging for tracking events in development
  - [ ] Test tracking behavior across different environments
  - [ ] Document environment configuration options

- [ ] **Task 6: Validate tracking functionality** (AC: 6, IV1, IV2)
  - [ ] Test OpenReplay session recording in production environment
  - [ ] Verify session recordings appear in OpenReplay dashboard
  - [ ] Test Umami analytics tracking and event capture
  - [ ] Verify analytics data appears in Umami dashboard
  - [ ] Test tracking across different pages and user interactions
  - [ ] Validate Vite HMR works correctly with tracking code
  - [ ] Confirm production build succeeds without errors
  - [ ] Test application functionality with tracking enabled

- [ ] **Task 7: Implement tracking event capture** (AC: 6)
  - [ ] Configure automatic page view tracking for both systems
  - [ ] Set up custom event tracking for key user interactions:
    - User login/logout
    - MOC browsing and search
    - Wishlist operations
    - Image uploads
    - Error events
  - [ ] Configure user identification for session correlation
  - [ ] Test custom event tracking in both Umami and OpenReplay
  - [ ] Validate event data quality and completeness

- [ ] **Task 8: Performance optimization and testing** (AC: IV3)
  - [ ] Optimize tracking script loading to minimize performance impact
  - [ ] Implement lazy loading for non-critical tracking features
  - [ ] Configure tracking script caching and CDN delivery
  - [ ] Test tracking performance impact on Core Web Vitals
  - [ ] Monitor bundle size increase from tracking libraries
  - [ ] Optimize tracking initialization for fastest possible load time
  - [ ] Create performance benchmarks for tracking integration

- [ ] **Task 9: Create tracking documentation and troubleshooting** (AC: 1-6)
  - [ ] Document tracking integration architecture and configuration
  - [ ] Create troubleshooting guide for tracking issues
  - [ ] Document environment-specific tracking behavior
  - [ ] Create guide for adding custom tracking events
  - [ ] Document tracking data privacy and PII handling
  - [ ] Create monitoring procedures for tracking functionality
