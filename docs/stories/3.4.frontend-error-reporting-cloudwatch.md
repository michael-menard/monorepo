# Story 3.4: Frontend Error Reporting to CloudWatch

## Status

Draft

## Story

**As a** Frontend Developer,
**I want** unhandled frontend errors reported to CloudWatch,
**so that** I can debug production issues via logs in Grafana.

## Acceptance Criteria

1. Error reporting module created in `src/lib/tracking/error-reporter.ts`
2. React error boundary implemented to catch component errors
3. Global error handler for unhandled promise rejections and window errors
4. Error context captured (user agent, URL, stack trace, user session ID)
5. Errors sent to CloudWatch via API Gateway endpoint (batched for efficiency)
6. PII excluded from error reports (no user email, names, etc.)

**Integration Verification:**

- IV1: Existing error handling preserved (errors still display to users appropriately)
- IV2: Application functionality unaffected by error boundary wrapping
- IV3: Error boundary doesn't mask errors in development environment

## Tasks / Subtasks

- [ ] **Task 1: Create error reporting module** (AC: 1, 6)
  - [ ] Create error reporting module in `src/lib/tracking/error-reporter.ts`
  - [ ] Define error data interface with required fields (message, stack, url, timestamp)
  - [ ] Implement PII sanitization for error messages and stack traces
  - [ ] Create error context extraction utilities (user agent, viewport, etc.)
  - [ ] Add environment-specific behavior (console logging in dev, CloudWatch in prod)
  - [ ] Test error data sanitization and context extraction

- [ ] **Task 2: Implement React error boundary** (AC: 2, IV2)
  - [ ] Create React error boundary component: `ErrorBoundary.tsx`
  - [ ] Implement componentDidCatch to capture React component errors
  - [ ] Add error reporting integration to error boundary
  - [ ] Create fallback UI for error boundary display
  - [ ] Preserve existing error display behavior for users
  - [ ] Test error boundary with intentional component errors

- [ ] **Task 3: Implement global error handlers** (AC: 3, 4)
  - [ ] Add window.onerror handler for JavaScript runtime errors
  - [ ] Add unhandledrejection handler for Promise rejections
  - [ ] Implement error context capture:
    - User agent string
    - Current URL and referrer
    - Viewport dimensions
    - Timestamp
    - User session ID (if available)
    - Browser version and capabilities
  - [ ] Test global error handlers with various error types

- [ ] **Task 4: Create Lambda function for error ingestion** (AC: 5)
  - [ ] Create new Lambda function: `frontend-error-ingestion.ts`
  - [ ] Implement API Gateway endpoint: `POST /api/tracking/errors`
  - [ ] Add request validation for error payload
  - [ ] Implement CloudWatch Logs publishing for frontend errors
  - [ ] Add error deduplication logic to prevent spam
  - [ ] Configure appropriate rate limiting and request size limits
  - [ ] Configure Lambda function in SST with API Gateway integration

- [ ] **Task 5: Implement error batching and transmission** (AC: 5)
  - [ ] Create error queue for batching multiple errors
  - [ ] Implement batch transmission every 30 seconds or 10 errors
  - [ ] Add retry logic for failed error submissions
  - [ ] Implement exponential backoff for API failures
  - [ ] Add local storage fallback for offline error collection
  - [ ] Configure transmission only in production environment
  - [ ] Test error batching and API endpoint integration

- [ ] **Task 6: Integrate error reporting with React application** (AC: 2, IV1, IV3)
  - [ ] Wrap main App component with ErrorBoundary
  - [ ] Initialize global error handlers on application startup
  - [ ] Ensure error reporting doesn't interfere with development debugging
  - [ ] Preserve existing user-facing error messages and handling
  - [ ] Add error reporting to key user interaction points
  - [ ] Test error reporting across different error scenarios

- [ ] **Task 7: Validate error reporting in CloudWatch** (AC: 1-6)
  - [ ] Deploy error reporting to dev environment
  - [ ] Generate test errors to trigger error reporting
  - [ ] Verify errors appear in CloudWatch Logs
  - [ ] Test error queries and filtering in CloudWatch Logs Insights
  - [ ] Validate PII sanitization is working correctly
  - [ ] Confirm error context data is complete and useful
  - [ ] Monitor API Gateway costs and error submission patterns

- [ ] **Task 8: Create error monitoring and documentation** (AC: 1-6)
  - [ ] Create documentation for error reporting implementation
  - [ ] Document error data schema and PII sanitization rules
  - [ ] Create troubleshooting guide for error reporting issues
  - [ ] Set up CloudWatch alarms for high error rates
  - [ ] Create Grafana dashboard queries for error visualization
  - [ ] Document integration with existing error handling systems
