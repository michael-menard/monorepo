# Story 4.1: Create User Profile Lambda Handler

**Epic**: 4 - User Profile & Advanced Features Migration

**As a** backend developer,
**I want** to create Lambda handlers for user profile operations,
**so that** users can manage their account settings and avatars.

## Acceptance Criteria

1. Lambda functions created (one per endpoint): `profile-get.ts`, `profile-update.ts`, `profile-avatar-upload.ts`, `profile-avatar-delete.ts`
2. API Gateway routes: `GET /api/users/{id}`, `PATCH /api/users/{id}`, `POST /api/users/{id}/avatar`, `DELETE /api/users/{id}/avatar`
3. JWT authorizer validates user can only access their own profile (userId match)
4. Note: User profiles stored in AWS Cognito, not PostgreSQL - Lambda queries Cognito User Pool for profile data
5. S3 client configured for avatar storage
6. Redis client for profile caching
7. TypeScript types for Cognito user attributes

## Implementation Status

**Status**: ✅ Completed

## Files Modified

### Created

- `apps/api/lego-api-serverless/src/functions/profile-get.ts` - GET /api/users/{id} handler (512 MB, 10s timeout)
- `apps/api/lego-api-serverless/src/functions/profile-update.ts` - PATCH /api/users/{id} handler (512 MB, 10s timeout)
- `apps/api/lego-api-serverless/src/functions/profile-avatar-upload.ts` - POST /api/users/{id}/avatar handler (2048 MB, 60s timeout for Sharp)
- `apps/api/lego-api-serverless/src/functions/profile-avatar-delete.ts` - DELETE /api/users/{id}/avatar handler (256 MB, 10s timeout)
- `apps/api/lego-api-serverless/src/lib/cognito/cognito-client.ts` - Cognito client utilities for user operations
- `apps/api/lego-api-serverless/src/types/profile.ts` - TypeScript types for Cognito user profiles
- `apps/api/lego-api-serverless/src/functions/__tests__/integration/profile.integration.test.ts` - Integration tests

### Modified

- `apps/api/lego-api-serverless/sst.config.ts` - Added 4 separate profile Lambda functions and API Gateway routes

## QA Results

### Review Date: 2025-11-15

### Reviewed By: Quinn (Test Architect)

### Test Results

- **Integration Tests**: ✅ 14/14 passing (refactored to 4 separate handlers)
- **Type Checking**: ✅ Passing
- **Linting**: ✅ Passing (new code)

### Test Coverage

- Authorization checks (userId match requirement)
- Routing to correct handlers
- Error handling for unauthorized and invalid requests
- Response format validation

### Gate Status

Gate: PASS → docs/qa/gates/4.1-create-user-profile-lambda-handler.yml

---

## Requirements Traceability Matrix

| AC # | Requirement                           | Test Coverage           | Status      |
| ---- | ------------------------------------- | ----------------------- | ----------- |
| 1    | 4 Lambda functions (one per endpoint) | Integration tests       | ✅ COMPLETE |
| 2    | API Gateway routes configured         | Integration tests       | ✅ COMPLETE |
| 3    | JWT authorizer with userId match      | 8 authorization tests   | ✅ COMPLETE |
| 4    | Cognito User Pool integration         | Cognito client created  | ✅ COMPLETE |
| 5    | S3 client configured                  | Linked in sst.config.ts | ✅ COMPLETE |
| 6    | Redis client configured               | Linked in sst.config.ts | ✅ COMPLETE |
| 7    | TypeScript types for Cognito attrs    | TypeScript compilation  | ✅ COMPLETE |

**Overall Coverage: 100% (14/14 tests passing)**

---

## Test Summary

### Integration Tests (14 tests)

**GET Handler Tests (3 tests)**

- ✅ Returns 401 when no userId in JWT
- ✅ Returns 403 when userId does not match profile ID
- ✅ Returns 501 placeholder for Story 4.2

**PATCH Handler Tests (3 tests)**

- ✅ Returns 401 when no userId in JWT
- ✅ Returns 403 when userId does not match profile ID
- ✅ Returns 501 placeholder for Story 4.3

**POST Avatar Handler Tests (3 tests)**

- ✅ Returns 401 when no userId in JWT
- ✅ Returns 403 when userId does not match profile ID
- ✅ Returns 501 placeholder for Story 4.4

**DELETE Avatar Handler Tests (3 tests)**

- ✅ Returns 401 when no userId in JWT
- ✅ Returns 403 when userId does not match profile ID
- ✅ Returns 501 placeholder for Story 4.5

**Response Format Tests (2 tests)**

- ✅ Includes CORS headers
- ✅ Returns valid JSON response

**Test File**: `src/functions/__tests__/integration/profile.integration.test.ts`

---

## Technical Notes

### Architecture Overview

This story sets up the infrastructure for user profile operations with a key architectural distinction:

**User Profile Data Storage**:

- **Cognito User Pool**: Primary source of truth for user identity and profile attributes
  - `sub` (user ID)
  - `email`
  - `name`
  - `picture` (avatar URL)
  - Other standard Cognito attributes

- **PostgreSQL**: Stores user-generated content
  - MOCs (`mocInstructions` table)
  - Gallery images (`galleryImages` table)
  - Wishlist items (`wishlistItems` table)
  - Used for aggregated statistics only

### Lambda Function Structure

```typescript
export const handler = async (event: APIGatewayProxyEventV2): Promise<APIGatewayProxyResultV2> => {
  // Extract userId from JWT
  // Extract route parameter :id
  // Verify userId === id (authorization)
  // Route to appropriate handler
}
```

### API Gateway JWT Authorization

```typescript
// sst.config.ts - Cognito JWT Authorizer
const cognitoAuthorizer = new aws.apigatewayv2.Authorizer('CognitoJwtAuthorizer', {
  apiId: api.id,
  authorizerType: 'JWT',
  identitySources: ['$request.header.Authorization'],
  jwtConfiguration: {
    audiences: [cognitoClientId],
    issuer: `https://cognito-idp.${region}.amazonaws.com/${cognitoUserPoolId}`,
  },
})
```

**API Gateway validates**:

- ✅ JWT signature (cryptographically valid)
- ✅ Issuer matches Cognito User Pool
- ✅ Audience matches Client ID
- ✅ **JWT is not expired (exp claim)**
- ✅ Not Before time is valid (nbf claim)

**Lambda still validates**:

- ✅ Authorization: `userId === profileId` (business logic)

### API Routes Configuration

```typescript
// sst.config.ts - 4 separate Lambda functions with JWT auth
api.route('GET /api/users/{id}', profileGetFunction, {
  auth: { jwt: { authorizer: cognitoAuthorizer } },
})
api.route('PATCH /api/users/{id}', profileUpdateFunction, {
  auth: { jwt: { authorizer: cognitoAuthorizer } },
})
api.route('POST /api/users/{id}/avatar', profileAvatarUploadFunction, {
  auth: { jwt: { authorizer: cognitoAuthorizer } },
})
api.route('DELETE /api/users/{id}/avatar', profileAvatarDeleteFunction, {
  auth: { jwt: { authorizer: cognitoAuthorizer } },
})
```

### Cognito Client Setup

```typescript
import { CognitoIdentityProviderClient } from '@aws-sdk/client-cognito-identity-provider'

const cognitoClient = new CognitoIdentityProviderClient({
  region: process.env.AWS_REGION,
})
```

### Authorization Pattern

```typescript
// Every handler must verify userId match
const userId = getUserIdFromEvent(event)
const profileId = event.pathParameters?.id

if (userId !== profileId) {
  return createErrorResponse(403, 'FORBIDDEN', "Cannot access another user's profile")
}
```

### TypeScript Types

```typescript
// Cognito user attributes
interface CognitoUserProfile {
  sub: string // User ID (Cognito sub claim)
  email: string
  email_verified: boolean
  name?: string
  picture?: string // Avatar URL
}

// API response
interface UserProfileResponse {
  id: string
  email: string
  name: string | null
  avatarUrl: string | null
  stats: {
    mocs: number
    images: number
    wishlistItems: number
  }
}
```

### Redis Caching Setup

```typescript
// Cache key pattern
const cacheKey = `profile:user:${userId}`

// TTL: 10 minutes
await redis.setEx(cacheKey, 600, JSON.stringify(profile))
```

### S3 Storage Pattern

```
avatars/
  {userId}/
    avatar.webp    <- Current avatar (overwrites on upload)
```

---

## Dependencies

- **AWS Cognito User Pool**: Must be configured with user pool ID
- **S3 Bucket**: For avatar storage
- **Redis**: For profile caching
- **JWT Authorizer**: Must extract userId from Cognito token

---

## Next Steps

After this infrastructure story, implement:

- **Story 4.2**: GET /api/users/:id (retrieve profile)
- **Story 4.3**: PATCH /api/users/:id (update profile)
- **Story 4.4**: POST /api/users/:id/avatar (upload avatar)
- **Story 4.5**: DELETE /api/users/:id/avatar (remove avatar)

---

## Key Differences from Previous Stories

1. **No PostgreSQL for user data**: Profiles stored in Cognito, not database
2. **Cognito SDK**: Uses AWS SDK for Cognito Identity Provider
3. **Authorization pattern**: userId must match route parameter `:id`
4. **Single avatar per user**: Overwrites instead of versioning
