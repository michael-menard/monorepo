# Story 1.3: Deploy Infrastructure to Dev Environment

## Status

**Draft**

---

## Story

**As a** DevOps Engineer,
**I want** to deploy the SST infrastructure stack to the dev environment and verify all AWS resources are created correctly,
**so that** the Image Service infrastructure is operational and ready for Lambda deployment.

---

## Acceptance Criteria

1. AWS credentials configured for lego-moc profile
2. SST stack deployed successfully to dev stage
3. DynamoDB table `ImageMetadata-dev` exists and accessible
4. S3 bucket `images-lego-moc-dev` created
5. CloudFront distribution created and accessible
6. API Gateway created with endpoints
7. All SST outputs printed (API endpoint, bucket name, CloudFront URL)
8. Manual verification of resources via AWS CLI succeeds
9. API Gateway returns 404 (expected - no Lambda handlers yet)

---

## Tasks / Subtasks

- [ ] **Task 1: Configure AWS Credentials** (AC: 1)
  - [ ] Verify AWS CLI installed: `aws --version`
  - [ ] Configure AWS profile: `aws configure --profile lego-moc`
  - [ ] Set AWS_PROFILE environment variable: `export AWS_PROFILE=lego-moc`
  - [ ] Verify credentials: `aws sts get-caller-identity`
  - [ ] Confirm correct AWS account ID

- [ ] **Task 2: Pre-Deployment Validation** (AC: 2)
  - [ ] Run `pnpm build` to verify TypeScript compiles
  - [ ] Review sst.config.ts for correct configuration
  - [ ] Verify ImageServiceStack is imported and called
  - [ ] Check for any SST configuration warnings

- [ ] **Task 3: Deploy SST Stack to Dev** (AC: 2)
  - [ ] Run `pnpm sst deploy --stage dev`
  - [ ] Monitor deployment progress in terminal
  - [ ] Wait for CloudFormation stack creation (5-15 minutes)
  - [ ] Verify deployment completes successfully
  - [ ] Review any warnings or errors during deployment

- [ ] **Task 4: Capture Stack Outputs** (AC: 7)
  - [ ] Note DynamoDB table name from SST output
  - [ ] Note S3 bucket name from SST output
  - [ ] Note CloudFront distribution domain from SST output
  - [ ] Note API Gateway endpoint URL from SST output
  - [ ] Save outputs to file: `deployment-outputs-dev.txt`

- [ ] **Task 5: Verify DynamoDB Table** (AC: 3)
  - [ ] Run `aws dynamodb describe-table --table-name ImageMetadata-dev`
  - [ ] Verify table status is ACTIVE
  - [ ] Verify primary key: PK (HASH), SK (RANGE)
  - [ ] Verify GSI1 (UserIndex) exists with correct keys
  - [ ] Verify GSI2 (AlbumIndex) exists with correct keys
  - [ ] Verify billing mode is PAY_PER_REQUEST
  - [ ] Verify DynamoDB Streams enabled
  - [ ] Verify encryption enabled (AWS managed keys)

- [ ] **Task 6: Verify S3 Bucket** (AC: 4)
  - [ ] Run `aws s3 ls s3://images-lego-moc-dev`
  - [ ] Verify bucket exists (should be empty)
  - [ ] Check bucket encryption: `aws s3api get-bucket-encryption --bucket images-lego-moc-dev`
  - [ ] Check CORS configuration: `aws s3api get-bucket-cors --bucket images-lego-moc-dev`
  - [ ] Check lifecycle configuration: `aws s3api get-bucket-lifecycle-configuration --bucket images-lego-moc-dev`
  - [ ] Verify Intelligent-Tiering rule exists
  - [ ] Verify incomplete multipart upload cleanup rule exists

- [ ] **Task 7: Verify CloudFront Distribution** (AC: 5)
  - [ ] Run `aws cloudfront list-distributions`
  - [ ] Find distribution for Image Service (check tags or origin)
  - [ ] Verify status is "Deployed"
  - [ ] Verify origin points to S3 bucket
  - [ ] Verify HTTPS redirect policy
  - [ ] Note distribution domain name (e.g., d123abc.cloudfront.net)
  - [ ] Test access: `curl https://{distribution-domain}/test.jpg` (should return 403 or 404)

- [ ] **Task 8: Verify API Gateway** (AC: 6, 9)
  - [ ] Run `aws apigatewayv2 get-apis`
  - [ ] Find API for Image Service
  - [ ] Verify API endpoint URL matches SST output
  - [ ] Test API health: `curl {api-endpoint}/images` (should return 404 - no handlers yet)
  - [ ] Verify 404 response (not 403 or 500)
  - [ ] Verify CORS headers in response

- [ ] **Task 9: Create Verification Report** (AC: 8)
  - [ ] Document all resource ARNs/names
  - [ ] Screenshot AWS Console showing resources
  - [ ] Create verification checklist:
    - DynamoDB table ✓
    - S3 bucket ✓
    - CloudFront distribution ✓
    - API Gateway ✓
  - [ ] Save report as `deployment-verification-dev.md`

- [ ] **Task 10: Cleanup Test (Optional)** (AC: 2)
  - [ ] Test SST remove: `pnpm sst remove --stage dev` (only if needed)
  - [ ] Re-deploy to verify reproducibility
  - [ ] Confirm all resources recreated successfully

---

## Dev Notes

### Deployment Context

This story deploys the infrastructure stack created in Story 1.2 to the AWS dev environment. The deployment creates real AWS resources and validates they are configured correctly.

**Source:** [docs/prd/image-service-migration/04-infrastructure.md](../prd/image-service-migration/04-infrastructure.md)

### AWS CLI Configuration

**Source:** [docs/architecture/source-tree.md](../architecture/source-tree.md#environment-configuration)

**AWS Profile:** lego-moc
**Region:** us-east-1 (default)
**Account:** Verify correct AWS account before deployment

**Configuration Steps:**
```bash
# Configure AWS CLI (if not already done)
aws configure --profile lego-moc
# Enter: Access Key ID, Secret Access Key, Region (us-east-1), Output format (json)

# Set environment variable
export AWS_PROFILE=lego-moc

# Verify credentials
aws sts get-caller-identity
# Should show correct account ID and user ARN
```

### SST Deployment Process

**Source:** [docs/architecture/tech-stack.md](../architecture/tech-stack.md#deployment)

**Deployment Command:**
```bash
pnpm sst deploy --stage dev
```

**What Happens:**
1. SST validates TypeScript configuration
2. SST synthesizes CloudFormation template
3. CloudFormation creates/updates resources
4. SST prints stack outputs when complete

**Expected Duration:**
- First deployment: 10-15 minutes
- CloudFront distribution takes longest (~10 minutes)
- Subsequent deployments: 2-5 minutes (only changed resources)

**Deployment Output Example:**
```
✓  Deployed:
   TableName: ImageMetadata-dev
   BucketName: images-lego-moc-dev
   CloudFrontDomain: d1a2b3c4d5e6f7.cloudfront.net
   ApiEndpoint: https://abc123.execute-api.us-east-1.amazonaws.com
   ApiId: abc123
```

### DynamoDB Verification

**Source:** [docs/prd/image-service-migration/02-data-model.md](../prd/image-service-migration/02-data-model.md)

**Verification Commands:**
```bash
# Describe table
aws dynamodb describe-table --table-name ImageMetadata-dev

# Check for specific attributes
aws dynamodb describe-table --table-name ImageMetadata-dev \
  --query 'Table.[TableName,TableStatus,BillingModeSummary.BillingMode,GlobalSecondaryIndexes[*].[IndexName,KeySchema]]' \
  --output json
```

**Expected Configuration:**
- Table Status: ACTIVE
- Billing Mode: PAY_PER_REQUEST
- Primary Keys: PK (HASH), SK (RANGE)
- GSI1 (UserIndex): GSI1PK (HASH), GSI1SK (RANGE)
- GSI2 (AlbumIndex): GSI2PK (HASH), GSI2SK (RANGE)
- Stream: Enabled (NEW_AND_OLD_IMAGES)
- Encryption: Enabled (AWS managed)

### S3 Bucket Verification

**Source:** [docs/prd/image-service-migration/04-infrastructure.md](../prd/image-service-migration/04-infrastructure.md)

**Verification Commands:**
```bash
# List bucket (should be empty)
aws s3 ls s3://images-lego-moc-dev

# Get encryption configuration
aws s3api get-bucket-encryption --bucket images-lego-moc-dev

# Get CORS configuration
aws s3api get-bucket-cors --bucket images-lego-moc-dev

# Get lifecycle configuration
aws s3api get-bucket-lifecycle-configuration --bucket images-lego-moc-dev
```

**Expected CORS Configuration:**
```json
{
  "CORSRules": [{
    "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
    "AllowedOrigins": ["https://lego-moc.com", "https://*.lego-moc.com"],
    "AllowedHeaders": ["*"]
  }]
}
```

**Expected Lifecycle Rules:**
1. **Intelligent-Tiering:** Transition after 0 days
2. **Abort Incomplete Uploads:** After 1 day

### CloudFront Verification

**Source:** [docs/prd/image-service-migration/04-infrastructure.md](../prd/image-service-migration/04-infrastructure.md)

**Verification Commands:**
```bash
# List distributions
aws cloudfront list-distributions

# Get specific distribution
aws cloudfront get-distribution --id {distribution-id}
```

**Expected Configuration:**
- Status: Deployed
- Origin: S3 bucket (images-lego-moc-dev)
- Origin Access Identity: Configured
- Viewer Protocol Policy: redirect-to-https
- Price Class: PriceClass_100
- HTTP Version: http2
- Enabled: true

**Testing CloudFront:**
```bash
# Should return 403 (no objects yet) or 404
curl -I https://d1a2b3c4d5e6f7.cloudfront.net/test.jpg

# Should redirect HTTP to HTTPS
curl -I http://d1a2b3c4d5e6f7.cloudfront.net/test.jpg
```

### API Gateway Verification

**Source:** [docs/prd/image-service-migration/03-api-specification.md](../prd/image-service-migration/03-api-specification.md)

**Verification Commands:**
```bash
# List APIs
aws apigatewayv2 get-apis

# Get specific API
aws apigatewayv2 get-api --api-id {api-id}

# List routes (will be empty until Epic 2)
aws apigatewayv2 get-routes --api-id {api-id}
```

**Testing API Gateway:**
```bash
# Should return 404 (no routes/handlers yet)
curl -I https://abc123.execute-api.us-east-1.amazonaws.com/images

# Should include CORS headers
curl -I -X OPTIONS https://abc123.execute-api.us-east-1.amazonaws.com/images
```

**Expected Response:**
- Status: 404 Not Found
- CORS Headers present:
  - Access-Control-Allow-Origin
  - Access-Control-Allow-Methods
  - Access-Control-Allow-Headers

**Why 404 is Expected:**
No Lambda handlers are deployed yet (Epic 2). The 404 confirms:
- API Gateway is working
- CORS is configured
- Routes can be added later

### Troubleshooting Common Issues

**Issue: CloudFormation Stack Rollback**
- Check CloudFormation console for error details
- Common causes: IAM permissions, resource limits, naming conflicts
- Fix: Update stack configuration, redeploy

**Issue: CloudFront Distribution Takes Too Long**
- Normal: CloudFront distributions take 10-15 minutes
- Can proceed with other verification while waiting
- Check status: `aws cloudfront list-distributions`

**Issue: S3 Bucket Name Already Taken**
- S3 bucket names are globally unique
- Add random suffix or use different naming pattern
- Update ImageServiceStack.ts with new name

**Issue: API Gateway CORS Errors**
- Verify CORS configuration in stack
- Check allowed origins match application domain
- Test with OPTIONS request

### Resource Cleanup (Dev Environment)

**Source:** [docs/prd/image-service-migration/04-infrastructure.md](../prd/image-service-migration/04-infrastructure.md)

**Removal Policy:**
Dev environment uses `RemovalPolicy.DESTROY` which means:
- Resources will be deleted when stack is removed
- Use `pnpm sst remove --stage dev` to clean up
- Useful for testing deployment reproducibility

**Warning:** Never run `sst remove` on production!

### Cost Considerations

**Dev Environment Costs:**
- DynamoDB: Pay-per-request (negligible for dev)
- S3: Storage + requests (pennies for dev testing)
- CloudFront: Free tier covers most dev usage
- API Gateway: Pay-per-request (negligible)

**Estimated Dev Cost:** <$5/month with minimal usage

---

## Testing

### Testing Standards

**Source:** [docs/architecture/coding-standards.md#testing](../architecture/coding-standards.md#testing)

This story involves manual verification of deployed infrastructure:

#### Deployment Verification Checklist

- [ ] **Pre-Deployment**
  - TypeScript compiles without errors
  - SST configuration validates
  - AWS credentials configured correctly

- [ ] **Deployment Success**
  - `sst deploy` completes without errors
  - Stack outputs displayed in terminal
  - CloudFormation stack shows CREATE_COMPLETE

- [ ] **Resource Verification**
  - DynamoDB table exists and is ACTIVE
  - S3 bucket exists with correct configuration
  - CloudFront distribution deployed
  - API Gateway created with correct endpoint

- [ ] **Configuration Verification**
  - DynamoDB has correct keys and GSIs
  - S3 has CORS and lifecycle policies
  - CloudFront has HTTPS redirect and caching
  - API Gateway has CORS configured

- [ ] **Access Testing**
  - CloudFront URL returns 403/404 (expected)
  - API Gateway returns 404 with CORS headers (expected)
  - AWS CLI commands work for all resources

#### Verification Report

Create `deployment-verification-dev.md` with:
- Deployment timestamp
- All resource ARNs/names
- Verification command outputs
- Screenshots from AWS Console
- Any warnings or issues encountered
- Sign-off that all ACs are met

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-16 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent after story completion_

---

**Epic Reference:** [Epic 1: Infrastructure Setup](../prd/epic-1-infrastructure-setup.md)
**PRD Reference:** [Image Service Migration - Infrastructure](../prd/image-service-migration/04-infrastructure.md)
**Previous Story:** [Story 1.2: SST Infrastructure Stack Implementation](./1.2.story.md)
**Next Story:** Story 1.4: CloudWatch Monitoring & Alarms Setup
