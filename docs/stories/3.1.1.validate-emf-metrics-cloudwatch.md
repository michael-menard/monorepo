# Story 3.1.1: Validate EMF Metrics in CloudWatch

## Status

Draft

## Story

**As a** Backend Developer,
**I want** to validate that EMF metrics are properly published to CloudWatch,
**so that** I can confirm the instrumentation works correctly before using it in Grafana dashboards.

## Parent Story

This story is a follow-up validation task for **Story 3.1: Lambda CloudWatch EMF Instrumentation**.

## Prerequisites

- ✅ Story 3.1 completed: EMF instrumentation implemented
- ✅ Lambda functions instrumented with EMF metrics
- ✅ Code deployed to at least one environment (dev/staging)

## Acceptance Criteria

1. Lambda functions successfully deployed to dev environment with EMF instrumentation
2. Test traffic generated to trigger metric publishing (min 100 invocations per function)
3. EMF metrics appear in CloudWatch Logs as structured JSON with `_aws` field
4. Metrics appear in CloudWatch Metrics console under `UserMetrics/Lambda/dev` namespace
5. All expected metric dimensions present and correct (FunctionName, Environment, Method, Path)
6. Metric queries execute successfully in CloudWatch Metrics Insights
7. Cold start metrics correctly identify first vs subsequent invocations
8. Error metrics correctly track error types and status codes
9. Memory utilization metrics within expected ranges (< 80% for healthy functions)
10. Performance impact measured and documented (< 50ms overhead requirement met)

**Integration Verification:**

- IV1: Existing Lambda tests still pass after deployment
- IV2: No production incidents or errors related to EMF
- IV3: CloudWatch Logs volume increase within budget (<10% increase)

## Tasks / Subtasks

- [ ] **Task 1: Deploy instrumented functions to dev environment**
  - [ ] Review current dev environment configuration
  - [ ] Deploy latest code with EMF instrumentation
  - [ ] Verify deployment success (no errors in CloudWatch Logs)
  - [ ] Confirm all Lambda functions updated successfully
  - [ ] Check Lambda execution role has required permissions

- [ ] **Task 2: Generate test traffic**
  - [ ] Create test script to invoke each instrumented function
  - [ ] Generate variety of scenarios:
    - Successful requests (200 responses)
    - Error requests (400, 404, 500 responses)
    - Authenticated vs unauthenticated requests
    - Different API paths and methods
  - [ ] Trigger enough invocations to observe cold starts (min 10 per function)
  - [ ] Wait for metrics to propagate to CloudWatch (5-10 minutes)

- [ ] **Task 3: Validate EMF logs in CloudWatch Logs**
  - [ ] Open CloudWatch Logs console
  - [ ] Find log group for instrumented Lambda function
  - [ ] Search for EMF log entries (contain `_aws` field)
  - [ ] Verify EMF log structure:
    ```json
    {
      "_aws": {
        "Timestamp": ...,
        "CloudWatchMetrics": [...]
      },
      "FunctionName": "...",
      "Environment": "dev",
      "ColdStart": 1,
      "ExecutionDuration": 123,
      ...
    }
    ```
  - [ ] Confirm no errors in EMF log parsing
  - [ ] Verify metric dimensions match expected values

- [ ] **Task 4: Validate metrics in CloudWatch Metrics console**
  - [ ] Open CloudWatch Metrics console
  - [ ] Navigate to `UserMetrics/Lambda/dev` namespace
  - [ ] Verify presence of all expected metrics:
    - ColdStart
    - ColdStartIndicator
    - InvocationCount
    - ExecutionDuration
    - ErrorCount
    - ErrorRate
    - MemoryUtilization
    - MemoryUsed
  - [ ] Check metric dimensions are populated correctly
  - [ ] Verify metric values are reasonable (no negative values, etc.)
  - [ ] Confirm metric timestamps align with invocation times

- [ ] **Task 5: Test CloudWatch Metrics Insights queries**
  - [ ] Test cold start rate query:
    ```sql
    SELECT SUM(ColdStart) / SUM(InvocationCount) * 100
    FROM SCHEMA("UserMetrics/Lambda/dev")
    WHERE FunctionName = 'GetMocById'
    ```
  - [ ] Test average execution duration query:
    ```sql
    SELECT AVG(ExecutionDuration)
    FROM SCHEMA("UserMetrics/Lambda/dev")
    GROUP BY FunctionName
    ```
  - [ ] Test error rate query:
    ```sql
    SELECT SUM(ErrorCount) / SUM(InvocationCount) * 100
    FROM SCHEMA("UserMetrics/Lambda/dev")
    GROUP BY ErrorType
    ```
  - [ ] Test P95 memory utilization query:
    ```sql
    SELECT PERCENTILE(MemoryUtilization, 95)
    FROM SCHEMA("UserMetrics/Lambda/dev")
    GROUP BY FunctionName
    ```
  - [ ] Verify all queries return expected results
  - [ ] Document any query issues or limitations

- [ ] **Task 6: Validate cold start detection**
  - [ ] Force cold start by updating Lambda function code/config
  - [ ] Invoke function immediately after deployment
  - [ ] Verify `ColdStart` metric = 1 for first invocation
  - [ ] Invoke function multiple times in succession
  - [ ] Verify `ColdStart` metric = 0 for warm invocations
  - [ ] Check cold start is recorded in X-Ray traces
  - [ ] Validate cold start dimensions (Method, Path) are correct

- [ ] **Task 7: Validate error tracking**
  - [ ] Trigger 400 errors (validation errors)
  - [ ] Trigger 404 errors (not found)
  - [ ] Trigger 500 errors (internal errors)
  - [ ] Verify `ErrorCount` increments for each error
  - [ ] Check `ErrorType` dimension shows correct error classification
  - [ ] Verify `StatusCode` dimension matches HTTP status
  - [ ] Confirm error messages not exposed in metrics (only in logs)

- [ ] **Task 8: Measure performance impact**
  - [ ] Capture baseline metrics (before EMF):
    - Average execution duration
    - P95 execution duration
    - P99 execution duration
  - [ ] Capture current metrics (after EMF):
    - Average execution duration
    - P95 execution duration
    - P99 execution duration
  - [ ] Calculate overhead:
    - Delta in average duration
    - Delta in P95 duration
    - Delta in P99 duration
  - [ ] Verify overhead < 50ms for all percentiles
  - [ ] Document performance impact in story

- [ ] **Task 9: Validate CloudWatch Logs volume impact**
  - [ ] Check CloudWatch Logs insights for log volume:
    ```sql
    fields @timestamp, @message
    | stats sum(@logStream) as logVolume by bin(5m)
    ```
  - [ ] Compare log volume before vs after EMF
  - [ ] Calculate percentage increase
  - [ ] Verify increase < 10% (within budget)
  - [ ] Estimate monthly cost impact

- [ ] **Task 10: Document validation results**
  - [ ] Create validation report with:
    - Deployment summary
    - Test scenarios executed
    - Metric validation results
    - Query test results
    - Performance impact measurements
    - Cost impact analysis
  - [ ] Add screenshots of CloudWatch console showing metrics
  - [ ] Document any issues found and resolutions
  - [ ] Update EMF documentation with real-world findings

## Dev Notes

### Test Functions to Validate

Priority order for validation:

1. **High Traffic Functions** (most important to validate)
   - `getMocById` - GET /api/mocs/{id}
   - `searchMocs` - GET /api/search/mocs
   - `getGalleryImages` - GET /api/gallery/images

2. **Error-Prone Functions** (test error tracking)
   - `uploadMocInstructions` - POST /api/mocs
   - `updateMocMetadata` - PUT /api/mocs/{id}
   - File upload handlers

3. **WebSocket Functions** (different event structure)
   - `websocketConnect` - WebSocket $connect
   - `websocketMessage` - WebSocket message handler

### Test Script Template

```typescript
// scripts/validate-emf-metrics.ts
import { APIGatewayProxyEventV2 } from 'aws-lambda'

async function generateTestTraffic() {
  const functions = ['getMocById', 'searchMocs', 'uploadMocInstructions']

  for (const fn of functions) {
    // Generate 100 invocations per function
    for (let i = 0; i < 100; i++) {
      await invokeLambda(fn, generateTestEvent())
      await sleep(100) // Avoid throttling
    }
  }
}
```

### CloudWatch Query Examples

Save these queries for reuse in Grafana:

```sql
-- Cold Start Rate by Function
SELECT SUM(ColdStart) / SUM(InvocationCount) * 100 as ColdStartRate
FROM SCHEMA("UserMetrics/Lambda/dev")
GROUP BY FunctionName
ORDER BY ColdStartRate DESC

-- Error Rate by Error Type
SELECT
  ErrorType,
  SUM(ErrorCount) as TotalErrors,
  SUM(ErrorCount) / SUM(InvocationCount) * 100 as ErrorRate
FROM SCHEMA("UserMetrics/Lambda/dev")
WHERE ErrorCount > 0
GROUP BY ErrorType
ORDER BY TotalErrors DESC

-- Memory Utilization Distribution
SELECT
  FunctionName,
  AVG(MemoryUtilization) as AvgMemory,
  PERCENTILE(MemoryUtilization, 95) as P95Memory,
  PERCENTILE(MemoryUtilization, 99) as P99Memory
FROM SCHEMA("UserMetrics/Lambda/dev")
GROUP BY FunctionName
ORDER BY P99Memory DESC

-- Execution Duration Trends
SELECT
  BIN(1m) as period,
  FunctionName,
  AVG(ExecutionDuration) as AvgDuration,
  PERCENTILE(ExecutionDuration, 95) as P95Duration
FROM SCHEMA("UserMetrics/Lambda/dev")
GROUP BY period, FunctionName
ORDER BY period DESC
```

### Expected Metric Ranges

Use these as validation baselines:

| Metric                 | Expected Range | Alert If |
| ---------------------- | -------------- | -------- |
| Cold Start Rate        | 5-15%          | > 25%    |
| Avg Execution Duration | 50-200ms       | > 500ms  |
| P95 Execution Duration | 100-500ms      | > 1000ms |
| Memory Utilization     | 30-70%         | > 80%    |
| Error Rate             | < 1%           | > 5%     |

### Known Limitations

Document any limitations found during validation:

1. **Metric Propagation Delay**: 5-10 minutes for metrics to appear
2. **Dimension Cardinality**: Keep unique dimension values < 100
3. **Log Group Retention**: Verify retention matches cost budget
4. **Concurrent Executions**: High concurrency may affect cold start detection

### Success Criteria

Story considered complete when:

- [ ] All metrics appear in CloudWatch within 10 minutes
- [ ] Query success rate > 95%
- [ ] Performance overhead < 50ms (P99)
- [ ] Log volume increase < 10%
- [ ] No errors or warnings in CloudWatch Logs
- [ ] Validation report documented and reviewed

## References

- Story 3.1: Lambda CloudWatch EMF Instrumentation
- Documentation: `apps/api/lego-api-serverless/docs/cloudwatch-emf-metrics.md`
- [AWS EMF Documentation](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format.html)
- [CloudWatch Metrics Insights Query Syntax](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch-metrics-insights-querylanguage.html)
