# Story 1.13.3: Email Verification Flow (Signup)

## Status

Ready for Review

## Story

**As a** new user who just signed up,
**I want** to verify my email address with a code,
**so that** I can activate my account and complete registration.

## Acceptance Criteria

1. ✅ Email verification page at /auth/verify-email route
2. ✅ Displays user's email (partially masked)
3. ✅ Uses OTPInput component for 6-digit code
4. ✅ Calls confirmSignUp from Amplify Auth
5. ✅ Shows success message on verification
6. ✅ Auto-redirects to login after success
7. ✅ Error handling for invalid/expired codes
8. ✅ Link to resend verification code
9. ✅ Accessible with proper ARIA attributes
10. ✅ Unit tests for the flow

## Tasks / Subtasks

- [x] **Task 1: Create Verification Page** (AC: 1, 2)
  - [x] Create EmailVerificationPage component
  - [x] Add route at /auth/verify-email
  - [x] Display masked email from signup context
  - [x] Use AuthLayout wrapper

- [x] **Task 2: Form Implementation** (AC: 3)
  - [x] Integrate OTPInput component
  - [x] 6-digit code validation
  - [x] Form submission handling

- [x] **Task 3: Amplify Integration** (AC: 4)
  - [x] Add confirmSignUp to AuthProvider
  - [x] Handle confirmationCode parameter
  - [x] Handle auto-signin after confirmation

- [x] **Task 4: Success Flow** (AC: 5, 6)
  - [x] Display success message/animation
  - [x] Auto-redirect to /login after 3 seconds
  - [x] Show manual link to login

- [x] **Task 5: Error Handling** (AC: 7)
  - [x] Handle CodeMismatchException
  - [x] Handle ExpiredCodeException
  - [x] Clear input and show retry option

- [x] **Task 6: Resend Code** (AC: 8)
  - [x] Add "Resend Code" button
  - [x] Call resendSignUpCode from Amplify
  - [x] Show cooldown timer (60 seconds)

- [x] **Task 7: Accessibility** (AC: 9)
  - [x] ARIA labels for all inputs
  - [x] Live region for status updates
  - [x] Keyboard navigation

- [x] **Task 8: Testing** (AC: 10)
  - [x] Unit tests for page component
  - [x] Tests for confirmSignUp flow
  - [x] Tests for error scenarios

## Dev Notes

### Amplify v6 Confirm Sign Up

```typescript
import { confirmSignUp, resendSignUpCode, autoSignIn } from 'aws-amplify/auth'

// Confirm signup with code
const result = await confirmSignUp({
  username: email,
  confirmationCode: code,
})

// If auto sign-in is enabled
if (result.isSignUpComplete) {
  try {
    const signInResult = await autoSignIn()
    if (signInResult.isSignedIn) {
      // User is signed in, redirect to dashboard
    }
  } catch (e) {
    // Auto sign-in failed, redirect to login
  }
}

// Resend verification code
await resendSignUpCode({
  username: email,
})
```

### AuthProvider Updates Needed

```typescript
interface AuthContextType {
  // ... existing
  confirmSignUp: (email: string, code: string) => Promise<{ success: boolean; error?: string }>
  resendSignUpCode: (email: string) => Promise<{ success: boolean; error?: string }>
}
```

### Route Configuration

```typescript
const verifyEmailRoute = createRoute({
  getParentRoute: () => rootRoute,
  path: '/auth/verify-email',
  component: EmailVerificationPage,
  beforeLoad: RouteGuards.guestOnly,
})
```

### Email Masking Helper

```typescript
function maskEmail(email: string): string {
  const [local, domain] = email.split('@')
  const maskedLocal = local.charAt(0) + '***' + local.charAt(local.length - 1)
  return `${maskedLocal}@${domain}`
}
// "j***n@example.com"
```

### Error Messages

| Amplify Error          | User Message                                           |
| ---------------------- | ------------------------------------------------------ |
| CodeMismatchException  | Invalid verification code. Please check and try again. |
| ExpiredCodeException   | This code has expired. Please request a new one.       |
| LimitExceededException | Too many attempts. Please wait before trying again.    |
| UserNotFoundException  | No account found with this email address.              |

## Dependencies

- Story 1.13.1: OTP Input Component (Complete)
- Story 1.13.4: Resend Verification Code (Required)

## Change Log

| Date       | Version | Description   | Author      |
| ---------- | ------- | ------------- | ----------- |
| 2025-11-28 | 0.1     | Initial draft | Claude Code |
