# Story 3.1.23: Parts Schema Validation â€” Pluggable

## Status

Ready for Review

## Story

As a creator,
I want my parts lists validated,
so errors are caught early and communicated clearly.

## Acceptance Criteria

1. Formats

- Accept csv/xml per env; validate light schema (columns/fields present, numeric counts, optional headers).

1. Modes

- Strict vs relaxed via env; relaxed allows extra columns; strict enforces exact sets.

1. Errors

- Per-file validation errors surfaced in finalize UI without blocking other files; targeted retry.

1. Tests

- Unit: validators; Integration: mixed-file finalize with parts errors.

## Tasks / Subtasks

- [x] Validator interfaces + implementations (csv/xml)
- [x] Wire into finalize; map errors via 3.1.21
- [x] Tests

## Dev Notes

- Keep validators pluggable/extensible for future formats.

### Bricklink XML Example

<INVENTORY><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>64644</ITEMID><COLOR>11</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>15332</ITEMID><COLOR>11</COLOR><MINQTY>6</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>21229</ITEMID><COLOR>11</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3023</ITEMID><COLOR>11</COLOR><MINQTY>6</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>4073</ITEMID><COLOR>11</COLOR><MINQTY>7</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>4742</ITEMID><COLOR>85</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3710</ITEMID><COLOR>85</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3795</ITEMID><COLOR>85</COLOR><MINQTY>2</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3032</ITEMID><COLOR>85</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>41539</ITEMID><COLOR>85</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>60474</ITEMID><COLOR>85</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>6003</ITEMID><COLOR>85</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>2540</ITEMID><COLOR>85</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3709</ITEMID><COLOR>85</COLOR><MINQTY>2</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>91405</ITEMID><COLOR>6</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>30377</ITEMID><COLOR>86</COLOR><MINQTY>33</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>42445</ITEMID><COLOR>86</COLOR><MINQTY>16</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>63965</ITEMID><COLOR>86</COLOR><MINQTY>10</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>6020</ITEMID><COLOR>86</COLOR><MINQTY>5</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3023</ITEMID><COLOR>86</COLOR><MINQTY>8</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3022</ITEMID><COLOR>86</COLOR><MINQTY>8</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>60474</ITEMID><COLOR>86</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>4085d</ITEMID><COLOR>86</COLOR><MINQTY>16</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>60478</ITEMID><COLOR>86</COLOR><MINQTY>16</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>41740</ITEMID><COLOR>86</COLOR><MINQTY>8</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>87580</ITEMID><COLOR>86</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>95347</ITEMID><COLOR>86</COLOR><MINQTY>12</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3069</ITEMID><COLOR>86</COLOR><MINQTY>2</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>4162</ITEMID><COLOR>86</COLOR><MINQTY>3</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>27507</ITEMID><COLOR>86</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>61485</ITEMID><COLOR>86</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>4073</ITEMID><COLOR>17</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>2454</ITEMID><COLOR>1</COLOR><MINQTY>16</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3010</ITEMID><COLOR>1</COLOR><MINQTY>8</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3941</ITEMID><COLOR>1</COLOR><MINQTY>30</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>76797</ITEMID><COLOR>1</COLOR><MINQTY>4</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>3943a</ITEMID><COLOR>1</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>30562</ITEMID><COLOR>1</COLOR><MINQTY>8</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>87580</ITEMID><COLOR>1</COLOR><MINQTY>1</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>50950</ITEMID><COLOR>1</COLOR><MINQTY>24</MINQTY></ITEM><ITEM><ITEMTYPE>P</ITEMTYPE><ITEMID>87079</ITEMID><COLOR>1</COLOR><MINQTY>4</MINQTY></ITEM></INVENTORY>

### Lego CSV Example

elementId,quantity
4538456,4
6066113,6
6115198,4
302326,6
614126,7
4222113,1
4211001,1
4211002,2
4211115,4
4210802,1
4528323,1
4500517,4
4210660,1
4227398,2
6397826,1
6319333,33
6277023,16
6170418,10
4275673,5
4211398,8
4211397,8
4515351,4
6296894,16
4515369,16
6257593,8
6126082,4
6186292,12
4211414,2
4211481,3
6163989,4
6045718,4
6208450,1
245401,16
301001,8
614301,30
6334524,4
4513990,8
6126046,1
4249112,24
4560178,4

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File                                                                                               | Action   | Description                                           |
| -------------------------------------------------------------------------------------------------- | -------- | ----------------------------------------------------- |
| apps/api/endpoints/moc-instructions/\_shared/parts-validators/types.ts                             | Created  | Validator interfaces and type definitions             |
| apps/api/endpoints/moc-instructions/\_shared/parts-validators/config.ts                            | Created  | Environment-based configuration (strict/relaxed mode) |
| apps/api/endpoints/moc-instructions/\_shared/parts-validators/csv-validator.ts                     | Created  | CSV parts list validator implementation               |
| apps/api/endpoints/moc-instructions/\_shared/parts-validators/xml-validator.ts                     | Created  | XML/Bricklink parts list validator implementation     |
| apps/api/endpoints/moc-instructions/\_shared/parts-validators/validator-registry.ts                | Created  | Pluggable validator registry                          |
| apps/api/endpoints/moc-instructions/\_shared/parts-validators/**tests**/csv-validator.test.ts      | Created  | CSV validator unit tests (16 tests)                   |
| apps/api/endpoints/moc-instructions/\_shared/parts-validators/**tests**/xml-validator.test.ts      | Created  | XML validator unit tests (16 tests)                   |
| apps/api/endpoints/moc-instructions/\_shared/parts-validators/**tests**/validator-registry.test.ts | Created  | Registry unit tests (11 tests)                        |
| apps/api/endpoints/moc-instructions/**tests**/finalize-with-files.handler.test.ts                  | Modified | Added parts validation integration tests (4 tests)    |
| apps/api/endpoints/moc-instructions/finalize-with-files/handler.ts                                 | Modified | Wired parts validation into finalize flow             |
| packages/shared/api-types/src/common/index.ts                                                      | Modified | Added PARTS_VALIDATION_ERROR code                     |
| packages/backend/lambda-responses/src/types.ts                                                     | Modified | Added PARTS_VALIDATION_ERROR to ApiErrorTypeSchema    |
| packages/backend/lambda-responses/src/errors.ts                                                    | Modified | Added PartsValidationError class                      |
| apps/api/core/utils/errors.ts                                                                      | Modified | Re-exported PartsValidationError                      |
| apps/api/core/utils/responses.ts                                                                   | Modified | Re-exported PartsValidationError                      |
| apps/web/main-app/src/services/api/errorMapping.ts                                                 | Modified | Added PARTS_VALIDATION_ERROR client mapping           |

### Completion Notes

- Implemented pluggable validator architecture with CSV and XML support
- Validators are stateless and format-specific, easily extensible for new formats
- Supports Bricklink XML format (INVENTORY/ITEM) and standard CSV formats
- Environment variables for configuration: PARTS_VALIDATION_MODE (strict/relaxed), PARTS_MAX_FILE_SIZE, PARTS_MAX_PARTS
- Per-file validation errors returned in finalize response without blocking other files
- Total piece count calculated from validated parts lists
- All tests passing: 43 unit tests + 17 integration tests (60 total)

## Change Log

| Date       | Version | Description                      | Author |
| ---------- | ------- | -------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft (parts validation) | SM     |
| 2025-12-08 | 1.0     | Implementation complete          | Claude |
