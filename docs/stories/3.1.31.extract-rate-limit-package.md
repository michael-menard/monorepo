# Story 3.1.31: Extract Rate Limit Package

## Status

Ready for Review

## Story

**As a** developer,
**I want** rate limiting utilities in `@repo/rate-limit`,
**so that** all API features can apply consistent rate limiting.

## Epic Context

This is **Story 0.4 of Epic 0: Package Extraction & Reuse Foundation**.

**Depends on:** Story 3.1.28 (DB Schema Migration)

## Acceptance Criteria

1. Create `packages/tools/rate-limit` package
2. Move logic from `apps/api/core/rate-limit/upload-rate-limit.ts`
3. Use store abstraction pattern for framework-agnostic implementation
4. Export: `createRateLimiter`, `RateLimitStore`, `RateLimitResult` type
5. Provide `PostgresRateLimitStore` implementation in `apps/api`
6. Generalize for any feature (not upload-specific naming)
7. Update upload endpoints to use `@repo/rate-limit`

## Tasks / Subtasks

- [x] **Task 1: Create Package Structure** (AC: 1)
  - [x] Create `packages/tools/rate-limit/` directory
  - [x] Create `package.json` with name `@repo/rate-limit`
  - [x] Create `tsconfig.json` extending root config
  - [x] Add package to `pnpm-workspace.yaml` (already included via `packages/tools/*`)

- [x] **Task 2: Define Store Abstraction** (AC: 3, 4)
  - [x] Create `RateLimitStore` interface
  - [x] Create `RateLimitResult` type with `allowed`, `remaining`, `resetAt`
  - [x] Create `RateLimitConfig` type with `maxRequests`, `windowMs`

- [x] **Task 3: Implement Core Logic** (AC: 2)
  - [x] Create `createRateLimiter(store: RateLimitStore): RateLimiter`
  - [x] Implement `checkLimit(key: string, config: RateLimitConfig): Promise<RateLimitResult>`
  - [x] Move sliding window / fixed window logic from existing code
  - [x] Keep package database-agnostic

- [x] **Task 4: Create PostgreSQL Store** (AC: 5)
  - [x] Create `PostgresRateLimitStore` in `apps/api/core/rate-limit/`
  - [x] Implements `RateLimitStore` interface
  - [x] Uses Drizzle ORM for queries
  - [x] Handles daily reset at midnight UTC

- [x] **Task 5: Generalize Naming** (AC: 6)
  - [x] Rename any `upload`-specific functions to generic names
  - [x] Use `feature` or `resource` instead of `upload` in keys
  - [x] Document key format: `{feature}:{userId}:{date}`

- [x] **Task 6: Update Consumers** (AC: 7)
  - [x] Update upload session create handler
  - [x] Update upload finalize handler
  - [x] Verify 429 responses include `retryAfterSeconds`

## Dev Notes

### Store Abstraction Pattern

```typescript
// packages/tools/rate-limit/src/types.ts
export interface RateLimitStore {
  checkAndIncrement(key: string, limit: number): Promise<RateLimitResult>
  reset(key: string): Promise<void>
}

export interface RateLimitResult {
  allowed: boolean
  remaining: number
  resetAt: Date
  retryAfterSeconds?: number
}

export interface RateLimitConfig {
  maxRequests: number
  windowMs: number // e.g., 24 * 60 * 60 * 1000 for daily
}
```

### Core Logic

```typescript
// packages/tools/rate-limit/src/limiter.ts
export const createRateLimiter = (store: RateLimitStore) => ({
  checkLimit: async (key: string, config: RateLimitConfig): Promise<RateLimitResult> => {
    return store.checkAndIncrement(key, config.maxRequests)
  },
})
```

### PostgreSQL Store Implementation

```typescript
// apps/api/core/rate-limit/postgres-store.ts
import { RateLimitStore, RateLimitResult } from '@repo/rate-limit'
import { db } from '@/core/database'
import { rateLimitCounters } from '@repo/db'

export class PostgresRateLimitStore implements RateLimitStore {
  async checkAndIncrement(key: string, limit: number): Promise<RateLimitResult> {
    // Atomic increment with INSERT ... ON CONFLICT
    const result = await db
      .insert(rateLimitCounters)
      .values({ key, count: 1, resetAt: this.getNextResetTime() })
      .onConflictDoUpdate({
        target: rateLimitCounters.key,
        set: { count: sql`${rateLimitCounters.count} + 1` },
      })
      .returning()

    const count = result[0].count
    const allowed = count <= limit

    return {
      allowed,
      remaining: Math.max(0, limit - count),
      resetAt: result[0].resetAt,
      retryAfterSeconds: allowed ? undefined : this.secondsUntilReset(),
    }
  }

  private getNextResetTime(): Date {
    // Midnight UTC
    const tomorrow = new Date()
    tomorrow.setUTCHours(24, 0, 0, 0)
    return tomorrow
  }
}
```

### Usage Pattern

```typescript
// apps/api/endpoints/moc-uploads/sessions/create/handler.ts
import { createRateLimiter } from '@repo/rate-limit'
import { PostgresRateLimitStore } from '@/core/rate-limit/postgres-store'

const rateLimiter = createRateLimiter(new PostgresRateLimitStore(db))

const result = await rateLimiter.checkLimit(
  `moc-upload:${userId}:${todayDate}`,
  { maxRequests: 100, windowMs: 24 * 60 * 60 * 1000 }
)

if (!result.allowed) {
  return response429({
    code: 'RATE_LIMIT_EXCEEDED',
    message: 'Daily upload limit reached',
    retryAfterSeconds: result.retryAfterSeconds,
  })
}
```

### Why Store Abstraction

- **Testability**: Use in-memory store for tests
- **Flexibility**: Could switch to Redis without changing core logic
- **Separation**: Package has no database dependencies

### Existing Rate Limit Location

- `apps/api/core/rate-limit/upload-rate-limit.ts`

## Testing

### Test Location
- `packages/tools/rate-limit/src/__tests__/` (new)
- `apps/api/core/rate-limit/__tests__/` (store implementation)

### Test Requirements
- Unit: Core limiter logic with mock store
- Unit: PostgreSQL store with test database
- Integration: 429 responses include correct headers
- Regression: Upload rate limiting works identically

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 0.1 | Initial draft from Edit MOC PRD | SM Agent |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

N/A

### Completion Notes

- Created `@repo/rate-limit` package with store abstraction pattern
- Implemented `RateLimitStore` interface, `RateLimitResult`, `RateLimitConfig` types
- Created `createRateLimiter` factory function
- Created `createInMemoryStore` for testing
- Created `generateDailyKey` helper and `RATE_LIMIT_WINDOWS` constants
- Created `createPostgresRateLimitStore` in apps/api
- Updated deprecated `upload-rate-limit.ts` to wrap new package for backwards compatibility
- Updated 3 consumers to use new package directly
- Added `nextAllowedAt` alias for backwards compatibility with existing consumers
- All tests passing (12 package tests + 8 store tests + 6 backwards compat tests)

### File List

- `packages/tools/rate-limit/package.json` - New
- `packages/tools/rate-limit/tsconfig.json` - New
- `packages/tools/rate-limit/vitest.config.ts` - New
- `packages/tools/rate-limit/src/index.ts` - New
- `packages/tools/rate-limit/src/types.ts` - New
- `packages/tools/rate-limit/src/limiter.ts` - New
- `packages/tools/rate-limit/src/memory-store.ts` - New
- `packages/tools/rate-limit/src/__tests__/limiter.test.ts` - New
- `apps/api/core/rate-limit/postgres-store.ts` - New
- `apps/api/core/rate-limit/__tests__/postgres-store.test.ts` - New
- `apps/api/core/rate-limit/upload-rate-limit.ts` - Modified (deprecated wrapper)
- `apps/api/endpoints/moc-uploads/sessions/create/handler.ts` - Modified
- `apps/api/endpoints/moc-instructions/initialize-with-files/handler.ts` - Modified
- `apps/api/endpoints/moc-instructions/finalize-with-files/handler.ts` - Modified
- `apps/api/package.json` - Modified (added @repo/rate-limit dependency)
