# Story 1.2: SST Infrastructure Stack Implementation

## Status

**Draft**

---

## Story

**As a** DevOps Engineer,
**I want** to implement the complete ImageServiceStack with all AWS resources (DynamoDB, S3, CloudFront, API Gateway),
**so that** the Image Service has a fully configured infrastructure ready for Lambda deployment.

---

## Acceptance Criteria

1. `ImageServiceStack.ts` created in `stacks/` directory
2. DynamoDB table configured with:
   - Primary key: PK (partition), SK (sort)
   - GSI: UserIndex (userId, createdAt)
   - On-demand billing mode
3. S3 bucket configured with:
   - Lifecycle policies (Intelligent-Tiering after 30 days)
   - CORS configuration for uploads
   - Versioning enabled
4. CloudFront distribution configured with:
   - S3 origin
   - Cache behavior optimized for images
   - Custom domain (images.lego-api.com)
5. API Gateway HTTP API configured with JWT authorizer
6. TypeScript compiles without errors
7. Stack validates successfully

---

## Tasks / Subtasks

- [ ] **Task 1: Create Stack Directory Structure** (AC: 1)
  - [ ] Create `stacks/` directory in project root
  - [ ] Create `stacks/ImageServiceStack.ts` file
  - [ ] Add proper TypeScript imports for SST and AWS CDK

- [ ] **Task 2: Implement DynamoDB Table Configuration** (AC: 2)
  - [ ] Define table with name `ImageMetadata`
  - [ ] Configure primary key: PK (partition key, string), SK (sort key, string)
  - [ ] Configure GSI1 (UserIndex): GSI1PK (partition), GSI1SK (sort)
  - [ ] Configure GSI2 (AlbumIndex): GSI2PK (partition), GSI2SK (sort)
  - [ ] Set billing mode to PAY_PER_REQUEST (on-demand)
  - [ ] Enable DynamoDB Streams (for future analytics)
  - [ ] Add TTL attribute: `ttl`
  - [ ] Configure encryption: AWS_MANAGED
  - [ ] Set removal policy: RETAIN for production, DESTROY for dev

- [ ] **Task 3: Implement S3 Bucket Configuration** (AC: 3)
  - [ ] Define bucket with name: `images-lego-moc-${stage}`
  - [ ] Configure CORS:
    - Allowed methods: GET, PUT, POST, DELETE, HEAD
    - Allowed origins: https://lego-moc.com, https://*.lego-moc.com
    - Allowed headers: *
  - [ ] Enable S3 managed encryption
  - [ ] Configure lifecycle rule: Intelligent-Tiering (immediate)
  - [ ] Configure lifecycle rule: Delete incomplete multipart uploads after 1 day
  - [ ] Set versioning: disabled (not needed for this use case)
  - [ ] Set removal policy: RETAIN for production, DESTROY for dev

- [ ] **Task 4: Implement CloudFront Distribution** (AC: 4)
  - [ ] Create S3 origin with Origin Access Identity (OAI)
  - [ ] Configure default behavior:
    - Viewer protocol policy: REDIRECT_TO_HTTPS
    - Cache policy: 24h default TTL, 365d max TTL
    - Enable Brotli and Gzip compression
  - [ ] Set price class: PRICE_CLASS_100 (US, Canada, Europe)
  - [ ] Enable HTTP/2
  - [ ] Add output for CloudFront domain name

- [ ] **Task 5: Implement API Gateway HTTP API** (AC: 5)
  - [ ] Create API Gateway v2 (HTTP API)
  - [ ] Configure CORS for API:
    - Allowed origins: https://lego-moc.com, https://*.lego-moc.com
    - Allowed methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
    - Allowed headers: Content-Type, Authorization
  - [ ] Add JWT authorizer (Cognito)
  - [ ] Configure custom domain: `images-{stage}.lego-api.com`
  - [ ] Add route placeholders (handlers will be added in Epic 2)

- [ ] **Task 6: Add Stack Outputs** (AC: 7)
  - [ ] Output DynamoDB table name
  - [ ] Output S3 bucket name
  - [ ] Output CloudFront distribution domain
  - [ ] Output API Gateway endpoint URL
  - [ ] Output API Gateway ID

- [ ] **Task 7: Update sst.config.ts** (AC: 1)
  - [ ] Import ImageServiceStack
  - [ ] Call ImageServiceStack in async run() function
  - [ ] Verify configuration compiles

- [ ] **Task 8: Validate Stack Configuration** (AC: 6, 7)
  - [ ] Run `pnpm build` (tsc --noEmit)
  - [ ] Verify zero TypeScript errors
  - [ ] Review SST configuration for best practices
  - [ ] Ensure all required CDK imports are present

---

## Dev Notes

### Architecture Context

This story implements the core infrastructure stack for the Image Service. The stack uses SST v3 (Ion) to define AWS resources as TypeScript code, providing type safety and better developer experience compared to CloudFormation or Terraform.

**Source:** [docs/prd/image-service-migration/04-infrastructure.md](../prd/image-service-migration/04-infrastructure.md)

### DynamoDB Table Design

**Source:** [docs/prd/image-service-migration/02-data-model.md](../prd/image-service-migration/02-data-model.md)

**Table Name:** `ImageMetadata-{stage}`

**Primary Key Structure:**
- **PK** (Partition Key): `IMAGE#<imageId>` - Ensures each image gets unique partition
- **SK** (Sort Key): `METADATA` - Fixed value, allows future expansion (e.g., VERSION#1, TAGS)

**Global Secondary Indexes:**

1. **UserIndex (GSI1)**
   - Purpose: Query all images for a user, sorted by upload date
   - Partition Key: `GSI1PK` = `USER#<userId>`
   - Sort Key: `GSI1SK` = `UPLOADED#<timestamp>`
   - Projection: ALL

2. **AlbumIndex (GSI2)**
   - Purpose: Query all images in an album, sorted by upload date
   - Partition Key: `GSI2PK` = `ALBUM#<albumId>`
   - Sort Key: `GSI2SK` = `UPLOADED#<timestamp>`
   - Projection: ALL

**Key Attributes:**
```typescript
fields: {
  PK: 'string',      // IMAGE#<imageId>
  SK: 'string',      // METADATA
  GSI1PK: 'string',  // USER#<userId>
  GSI1SK: 'string',  // UPLOADED#<timestamp>
  GSI2PK: 'string',  // ALBUM#<albumId>
  GSI2SK: 'string',  // UPLOADED#<timestamp>
}
```

**Configuration:**
- Billing Mode: PAY_PER_REQUEST (on-demand, auto-scaling)
- Encryption: AWS managed keys
- DynamoDB Streams: Enabled (new-and-old-images)
- TTL Attribute: `ttl` (for temporary images)
- Point-in-Time Recovery: Enabled in production only

### S3 Bucket Configuration

**Source:** [docs/prd/image-service-migration/04-infrastructure.md](../prd/image-service-migration/04-infrastructure.md)

**Bucket Name:** `images-lego-moc-{stage}`

**CORS Configuration:**
```typescript
cors: [
  {
    allowedMethods: ['GET', 'PUT', 'POST', 'DELETE', 'HEAD'],
    allowedOrigins: ['https://lego-moc.com', 'https://*.lego-moc.com'],
    allowedHeaders: ['*'],
  },
]
```

**Lifecycle Policies:**

1. **Intelligent-Tiering** (immediate)
   - Automatically moves objects between access tiers based on usage
   - Optimizes storage costs without performance impact
   - Transition after: 0 days (immediate)

2. **Delete Incomplete Multipart Uploads**
   - Cleans up failed uploads to reduce storage costs
   - Abort after: 1 day

**Encryption:** S3 managed encryption (SSE-S3)

**Versioning:** Disabled (not needed - images are immutable)

**Removal Policy:**
- Production: RETAIN (prevent accidental deletion)
- Dev/Staging: DESTROY (allow cleanup)

### CloudFront Distribution

**Source:** [docs/prd/image-service-migration/04-infrastructure.md](../prd/image-service-migration/04-infrastructure.md)

**Purpose:** Global CDN for fast image delivery

**Configuration:**
- **Origin:** S3 bucket with Origin Access Identity (OAI)
- **Viewer Protocol:** REDIRECT_TO_HTTPS (force secure connections)
- **Price Class:** PRICE_CLASS_100 (US, Canada, Europe)
- **HTTP Version:** HTTP/2 (faster, multiplexing)

**Cache Policy:**
- Default TTL: 24 hours
- Max TTL: 365 days
- Min TTL: 0 seconds
- Compression: Brotli and Gzip enabled

**Why CloudFront?**
- Reduces latency from ~300ms to <50ms for cached images
- Reduces S3 GET request costs
- Reduces NAT Gateway costs (Lambda → S3 via CloudFront)
- Improves user experience globally

### API Gateway HTTP API

**Source:** [docs/prd/image-service-migration/03-api-specification.md](../prd/image-service-migration/03-api-specification.md)

**Type:** API Gateway v2 (HTTP API) - Lower cost than REST API

**CORS Configuration:**
```typescript
cors: {
  allowOrigins: ['https://lego-moc.com', 'https://*.lego-moc.com'],
  allowMethods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization'],
}
```

**Authorizer:** JWT authorizer (AWS Cognito)
- Validates JWT tokens from Cognito user pool
- Extracts userId from token claims
- Passes userId to Lambda handlers

**Custom Domain:**
- Dev: `images-dev.lego-api.com`
- Staging: `images-staging.lego-api.com`
- Production: `images.lego-api.com`

**Routes:** (Placeholder - Lambda handlers added in Epic 2)
- POST /images - Upload image
- GET /images/{imageId} - Get image metadata
- GET /images - List user images
- PATCH /images/{imageId} - Update metadata
- DELETE /images/{imageId} - Delete image

### SST v3 Implementation

**Source:** [docs/architecture/tech-stack.md](../architecture/tech-stack.md#serverless-framework)

**SST Version:** v3 (Ion)
- Latest version with improved TypeScript support
- AWS CDK under the hood
- Type-safe infrastructure definitions
- Live Lambda debugging

**Project Structure:**
```
apps/api/image-service/
├── sst.config.ts           # Main SST config
├── stacks/
│   └── ImageServiceStack.ts # This story's deliverable
└── src/                    # Lambda handlers (Epic 2)
```

**Key Imports:**
```typescript
import { Table, Bucket, StackContext } from 'sst/constructs'
import { RemovalPolicy, Duration } from 'aws-cdk-lib'
import {
  Distribution,
  ViewerProtocolPolicy,
  CachePolicy,
  PriceClass,
  HttpVersion
} from 'aws-cdk-lib/aws-cloudfront'
import { S3Origin } from 'aws-cdk-lib/aws-cloudfront-origins'
import {
  BillingMode,
  TableEncryption
} from 'aws-cdk-lib/aws-dynamodb'
import {
  BucketEncryption,
  StorageClass
} from 'aws-cdk-lib/aws-s3'
```

### Stack Outputs

**Critical Outputs for Later Epics:**

```typescript
stack.addOutputs({
  TableName: imageMetadataTable.tableName,
  BucketName: imageBucket.bucketName,
  CloudFrontDomain: distribution.distributionDomainName,
  ApiEndpoint: api.url,
  ApiId: api.apiId,
})
```

These outputs will be used by:
- Epic 2: Lambda handlers need table/bucket names
- Epic 3: Dual-write needs API endpoint
- Epic 5: Cutover needs to verify infrastructure

### Environment Considerations

**Source:** [docs/architecture/source-tree.md](../architecture/source-tree.md#environment-configuration)

**Stage Detection:**
```typescript
const stage = stack.stage // 'dev', 'staging', or 'production'
```

**Stage-Specific Configuration:**
- **Dev:** Cheaper resources, destroy on delete
- **Staging:** Production-like, but destroy on delete
- **Production:** Full features, retain on delete

**Examples:**
- Point-in-Time Recovery: production only
- Removal Policy: RETAIN (prod) vs DESTROY (dev/staging)
- Redis: staging/production only (optional in dev)

### Security Considerations

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md#security)

**S3 Bucket:**
- No public access (CloudFront OAI only)
- Encryption at rest (S3 managed)
- CORS limited to known origins

**DynamoDB:**
- Encryption at rest (AWS managed)
- IAM roles with least privilege
- No public access

**CloudFront:**
- HTTPS only (redirect HTTP)
- Viewer protocol policy enforces TLS
- Cache headers respect S3 settings

**API Gateway:**
- JWT authorizer (Cognito)
- CORS limited to known origins
- Rate limiting (added later)

---

## Testing

### Testing Standards

**Source:** [docs/architecture/coding-standards.md#testing](../architecture/coding-standards.md#testing)

Since this is infrastructure code, testing is manual verification through deployment:

#### Manual Verification Checklist

- [ ] **TypeScript Compilation**
  - Run `pnpm build` (tsc --noEmit)
  - Verify zero compilation errors
  - Verify all imports resolve correctly

- [ ] **Stack Validation**
  - SST validates infrastructure definitions
  - Check for any CDK errors or warnings
  - Review stack outputs in terminal

- [ ] **Code Review**
  - Review CDK constructs match requirements
  - Verify all acceptance criteria configurations present
  - Check for hardcoded values (should use `stack.stage`)

#### Post-Deployment Verification (Story 1.3)

The actual deployment and resource verification happens in Story 1.3. This story focuses on:
- Correct TypeScript definitions
- Proper SST/CDK configuration
- Compilation without errors

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-16 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent after story completion_

---

**Epic Reference:** [Epic 1: Infrastructure Setup](../prd/epic-1-infrastructure-setup.md)
**PRD Reference:** [Image Service Migration - Infrastructure](../prd/image-service-migration/04-infrastructure.md)
**Previous Story:** [Story 1.1: SST Project Initialization](./1.1.story.md)
**Next Story:** Story 1.3: Deploy Infrastructure to Dev Environment
