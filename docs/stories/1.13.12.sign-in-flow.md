# Story 1.13.12: Sign-In Flow

## Status

Complete

## Story

**As a** registered user,
**I want** a complete sign-in flow that handles authentication, MFA, and redirects,
**so that** I can securely access my account and be directed to the appropriate page.

## Acceptance Criteria

1. ✅ User can enter email and password on login page
2. ✅ Form validates email format and password length
3. ✅ Loading state shown during authentication
4. ✅ Successful login redirects to /dashboard (or original URL)
5. ✅ MFA challenge redirects to OTP verification page
6. ✅ NEW_PASSWORD_REQUIRED challenge redirects to new password page
7. ✅ Invalid credentials display error message
8. ✅ Network errors display appropriate error message
9. ✅ Protected routes redirect to login with return URL
10. ✅ Successful authentication restores redirect to original URL
11. ✅ Session persists across page refresh
12. ✅ Unit tests cover all sign-in scenarios (38 tests)

## Tasks / Subtasks

- [x] **Task 1: Login Page** (AC: 1, 2, 3)
  - [x] Email input with validation (Story 1.14)
  - [x] Password input with show/hide toggle (Story 1.14)
  - [x] Loading spinner during submission (Story 1.14)
  - [x] Form validation with Zod (Story 1.14)

- [x] **Task 2: AuthProvider signIn** (AC: 4, 5, 6)
  - [x] Call Amplify signIn with credentials
  - [x] Handle isSignedIn = true → checkAuthState → navigate
  - [x] Handle nextStep challenges → set currentChallenge
  - [x] Return result with success/error/challenge

- [x] **Task 3: Challenge Routing** (AC: 5, 6)
  - [x] CONFIRM_SIGN_IN_WITH_SMS_CODE → /auth/otp-verification
  - [x] CONFIRM_SIGN_IN_WITH_TOTP_CODE → /auth/otp-verification
  - [x] CONFIRM_SIGN_IN_WITH_EMAIL_CODE → /auth/otp-verification
  - [x] CONFIRM_SIGN_IN_WITH_NEW_PASSWORD_REQUIRED → /auth/new-password

- [x] **Task 4: Error Handling** (AC: 7, 8)
  - [x] Display error alert on invalid credentials
  - [x] Handle network errors with generic message
  - [x] Clear errors on new submission attempt

- [x] **Task 5: Protected Route Redirect** (AC: 9, 10)
  - [x] RouteGuards.protected passes redirect in search params
  - [x] LoginPage reads redirect from useSearch
  - [x] Navigate to original URL or default dashboard

- [x] **Task 6: Session Persistence** (AC: 11)
  - [x] checkAuthState runs on app load
  - [x] Cognito tokens stored securely
  - [x] Auth state restored from tokens

- [x] **Task 7: Integration Testing** (AC: 12)
  - [x] Test complete sign-in flow (no MFA)
  - [x] Test sign-in with MFA challenge
  - [x] Test sign-in with NEW_PASSWORD challenge
  - [x] Test error scenarios
  - [x] Test redirect after protected route access

## Dev Notes

### Sign-In Flow Diagram

```
┌─────────────────┐
│   Login Page    │
│ /login          │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Enter email &   │
│ password        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ signIn()        │
│ AuthProvider    │
└────────┬────────┘
         │
    ┌────┴────────────────────────────────┐
    │                                      │
    ▼                                      ▼
┌─────────────────┐              ┌─────────────────┐
│ isSignedIn=true │              │ nextStep        │
│                 │              │ (Challenge)     │
└────────┬────────┘              └────────┬────────┘
         │                                 │
         ▼                       ┌─────────┴─────────┐
┌─────────────────┐              │                   │
│ checkAuthState()│              ▼                   ▼
│ Update Redux    │     ┌─────────────┐     ┌─────────────┐
└────────┬────────┘     │ MFA Code    │     │ New Password│
         │              │ SMS/TOTP/   │     │ Required    │
         ▼              │ Email       │     └──────┬──────┘
┌─────────────────┐     └──────┬──────┘            │
│ Navigate to     │            │                   │
│ /dashboard      │            ▼                   ▼
└─────────────────┘     ┌─────────────┐     ┌─────────────┐
                        │ OTP Page    │     │ New Password│
                        │ /auth/otp-  │     │ Page        │
                        │ verification│     │ /auth/new-  │
                        └──────┬──────┘     │ password    │
                               │            └──────┬──────┘
                               ▼                   │
                        ┌─────────────┐            │
                        │confirmSignIn│◄───────────┘
                        │ (code/pass) │
                        └──────┬──────┘
                               │
                               ▼
                        ┌─────────────┐
                        │ isSignedIn  │
                        │ = true      │
                        └──────┬──────┘
                               │
                               ▼
                        ┌─────────────┐
                        │ /dashboard  │
                        └─────────────┘
```

### Error Flow Diagram

```
┌─────────────────┐
│ signIn() Error  │
└────────┬────────┘
         │
    ┌────┴────────────────────────────┐
    │                                  │
    ▼                                  ▼
┌─────────────────┐          ┌─────────────────┐
│ UserNotFound    │          │ NotAuthorized   │
│ Exception       │          │ Exception       │
└────────┬────────┘          └────────┬────────┘
         │                            │
         ▼                            ▼
┌─────────────────────────────────────────────┐
│ Display error message in Alert component    │
│ "Incorrect username or password"            │
└─────────────────────────────────────────────┘
```

### Existing Implementation

**LoginPage:** `apps/web/main-app/src/routes/pages/LoginPage.tsx`
- Form with email/password inputs
- Calls `signIn` from AuthProvider
- Routes based on result (success/challenge/error)

**AuthProvider:** `apps/web/main-app/src/services/auth/AuthProvider.tsx`
- `handleSignIn` - calls Amplify signIn
- `handleConfirmSignIn` - resolves MFA/password challenges
- `currentChallenge` state for multi-step auth
- `checkAuthState` - initializes auth on app load

**OTPVerificationPage:** `apps/web/main-app/src/pages/auth/OTPVerificationPage.tsx`
- Handles MFA code entry
- Calls `confirmSignIn` to complete authentication

**NewPasswordPage:** `apps/web/main-app/src/pages/auth/NewPasswordPage.tsx`
- Handles NEW_PASSWORD_REQUIRED challenge
- Requires new password with confirmation
- Calls `confirmSignIn` with new password

### Protected Route Redirect (TODO)

```typescript
// In RouteGuards.protected
beforeLoad: ({ location }) => {
  const auth = useAuthStore.getState()
  if (!auth.isAuthenticated) {
    // Store intended URL for redirect after login
    sessionStorage.setItem('redirectAfterLogin', location.href)
    throw redirect({ to: '/login' })
  }
}

// In LoginPage after successful login
const onLoginSuccess = () => {
  const redirectUrl = sessionStorage.getItem('redirectAfterLogin')
  sessionStorage.removeItem('redirectAfterLogin')
  navigate({ to: redirectUrl || '/dashboard' })
}
```

### Related Stories

- Story 1.14: Login Page (Complete) - UI and form
- Story 1.13.5: MFA Challenge Handling (Ready for Review) - Challenge routing
- Story 1.13.2: OTP Verification Page (Complete) - MFA code entry
- Story 1.13.6: Auth Flow E2E Tests (Approved) - Playwright tests

## Dependencies

- Story 1.13: Amplify Configuration (Complete)
- Story 1.14: Login Page (Complete)
- Story 1.13.5: MFA Challenge Handling (Ready for Review)

## Change Log

| Date       | Version | Description                                          | Author    |
| ---------- | ------- | ---------------------------------------------------- | --------- |
| 2025-11-29 | 0.1     | Initial story - documents existing login flow        | Dev Agent |
| 2025-11-29 | 1.0     | Complete: Added redirect support, 38 unit tests      | Dev Agent |
