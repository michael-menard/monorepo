# Story 1.34: Transition Delay Threshold

## Status

Approved

## Story

**As a** user,
**I want** the spinner to only show for slow transitions,
**so that** I don't see distracting flashes on fast pages.

## Acceptance Criteria

1. ⬜ Spinner only shows if load takes > 300ms
2. ⬜ Fast navigations complete without spinner
3. ⬜ Configurable threshold
4. ⬜ Smooth appearance when shown

## Tasks / Subtasks

- [ ] **Task 1: Implement Debounce** (AC: 1-2)
  - [ ] Add delay before showing spinner
  - [ ] Cancel if navigation completes quickly
  - [ ] Use setTimeout or debounce hook

- [ ] **Task 2: Configuration** (AC: 3)
  - [ ] Accept threshold prop
  - [ ] Default to 300ms
  - [ ] Allow per-route override

- [ ] **Task 3: Smooth Appearance** (AC: 4)
  - [ ] Fade in animation after delay
  - [ ] No "pop" appearance

## Dev Notes

### Delayed Show Hook

**File:** `apps/web/main-app/src/hooks/useDelayedShow.ts`

```typescript
import { useState, useEffect, useRef } from 'react'

export function useDelayedShow(isActive: boolean, delayMs: number = 300): boolean {
  const [shouldShow, setShouldShow] = useState(false)
  const timeoutRef = useRef<NodeJS.Timeout | null>(null)

  useEffect(() => {
    if (isActive) {
      // Start timer to show
      timeoutRef.current = setTimeout(() => {
        setShouldShow(true)
      }, delayMs)
    } else {
      // Clear timer and hide
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current)
        timeoutRef.current = null
      }
      setShouldShow(false)
    }

    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current)
      }
    }
  }, [isActive, delayMs])

  return shouldShow
}
```

### Usage in Spinner

```typescript
export function PageTransitionSpinner({ delayMs = 300 }) {
  const isNavigating = useRouterState({ select: s => s.isLoading })
  const shouldShow = useDelayedShow(isNavigating, delayMs)

  return (
    <AnimatePresence>
      {shouldShow && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed top-0 left-0 right-0 z-50 h-1 bg-primary"
        />
      )}
    </AnimatePresence>
  )
}
```

### Alternative: CSS-only Delay

```css
.spinner {
  opacity: 0;
  animation: fadeIn 0.2s ease 0.3s forwards;
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}
```

### Per-Route Configuration

```typescript
// Route meta for custom threshold
export const Route = createFileRoute('/heavy-page')({
  meta: () => [{ spinnerDelay: 100 }], // Show faster for known slow pages
})

// Access in spinner
const routeMeta = useRouteMatch()?.meta
const delay = routeMeta?.spinnerDelay ?? 300
```

### Testing

- Test spinner doesn't show for fast (<300ms) navigation
- Test spinner shows for slow (>300ms) navigation
- Test custom threshold works
- Test no visual flash

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
