# Story 1.27: Route Permission Check

## Status

Approved

## Story

**As a** developer,
**I want** route-level permission checks,
**so that** users only access pages they're authorized for.

## Acceptance Criteria

1. ⬜ Permission check middleware function
2. ⬜ Reads required permissions from route meta
3. ⬜ Checks user roles/permissions from auth state
4. ⬜ Redirects to unauthorized page if denied
5. ⬜ Supports role-based and permission-based checks

## Tasks / Subtasks

- [ ] **Task 1: Create Permission Middleware** (AC: 1-2)
  - [ ] Create lib/permission-middleware.ts
  - [ ] Accept required roles/permissions array
  - [ ] Read from route meta if available

- [ ] **Task 2: Role Check Logic** (AC: 3, 5)
  - [ ] Extract user roles from auth.user.roles
  - [ ] Support role-based: hasRole('admin')
  - [ ] Support permission-based: hasPermission('gallery.edit')

- [ ] **Task 3: Unauthorized Handling** (AC: 4)
  - [ ] Redirect to /unauthorized page
  - [ ] Optionally show toast message
  - [ ] Log unauthorized access attempts

## Dev Notes

### Permission Middleware

**File:** `apps/web/main-app/src/lib/permission-middleware.ts`

```typescript
import { redirect } from '@tanstack/react-router'
import type { AuthState } from '@/store/slices/authSlice'

export interface PermissionOptions {
  roles?: string[]
  permissions?: string[]
  requireAll?: boolean // true = AND, false = OR
  redirectTo?: string
}

export function createPermissionMiddleware(options: PermissionOptions) {
  const { roles = [], permissions = [], requireAll = false, redirectTo = '/unauthorized' } = options

  return ({ context }: { context: any }) => {
    const auth: AuthState = context.auth

    if (!auth.isAuthenticated) {
      throw redirect({ to: '/login' })
    }

    const userRoles = auth.user?.roles || []
    const userPermissions = auth.user?.permissions || []

    const checks: boolean[] = []

    // Check roles
    if (roles.length > 0) {
      const hasRole = roles.some(role => userRoles.includes(role))
      checks.push(hasRole)
    }

    // Check permissions
    if (permissions.length > 0) {
      const hasPermission = permissions.some(perm => userPermissions.includes(perm))
      checks.push(hasPermission)
    }

    const passed = requireAll ? checks.every(Boolean) : checks.some(Boolean)

    if (!passed) {
      logger.warn('Unauthorized access attempt', {
        userId: auth.user?.id,
        requiredRoles: roles,
        requiredPermissions: permissions,
      })
      throw redirect({ to: redirectTo })
    }
  }
}

// Pre-configured middleware
export const PermissionMiddleware = {
  admin: createPermissionMiddleware({ roles: ['admin'] }),
  moderator: createPermissionMiddleware({ roles: ['admin', 'moderator'] }),
}
```

### Route Usage

```typescript
export const Route = createFileRoute('/admin')({
  beforeLoad: PermissionMiddleware.admin,
  component: AdminPage,
})
```

### Unauthorized Page

Create a simple /unauthorized page:

```typescript
export function UnauthorizedPage() {
  return (
    <div className="flex flex-col items-center justify-center min-h-[60vh]">
      <ShieldX className="h-12 w-12 text-destructive" />
      <h1 className="mt-4 text-2xl font-bold">Access Denied</h1>
      <p className="text-muted-foreground">
        You don't have permission to view this page.
      </p>
      <Button asChild className="mt-4">
        <Link to="/">Go Home</Link>
      </Button>
    </div>
  )
}
```

### Testing

- Test admin role allows access
- Test non-admin redirects
- Test permission-based check
- Test AND vs OR logic

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
