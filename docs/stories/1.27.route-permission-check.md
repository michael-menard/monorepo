# Story 1.27: Route Permission Check

## Status

Ready for Review

## Story

**As a** developer,
**I want** route-level permission checks,
**so that** users only access pages they're authorized for.

## Acceptance Criteria

1. ✅ Permission check middleware function
2. ✅ Reads required permissions from route meta
3. ✅ Checks user roles/permissions from auth state
4. ✅ Redirects to unauthorized page if denied
5. ✅ Supports role-based and permission-based checks

## Tasks / Subtasks

- [x] **Task 1: Add helper to extract scopes from access token** (AC: 1-2)
  - [x] Create getTokenScopes() in lib/jwt.ts
  - [x] Parse scope string from CognitoAccessTokenPayload
  - [x] Return array of permissions/scopes

- [x] **Task 2: Enhance route-guards with permission checking** (AC: 1-3, 5)
  - [x] Add requirePermissions option to RouteGuardOptions
  - [x] Add requireAll option for AND/OR logic
  - [x] Extract permissions from access token scopes
  - [x] Support combined role + permission checks

- [x] **Task 3: Create UnauthorizedPage** (AC: 4)
  - [x] Create /unauthorized page component
  - [x] LEGO-themed design with locked brick
  - [x] Go Home and Go Back buttons

- [x] **Task 4: Add unauthorized route**
  - [x] Add /unauthorized route to routes/index.ts

- [x] **Task 5: Add comprehensive tests**
  - [x] Test permission-based checking
  - [x] Test AND/OR logic
  - [x] Test combined role + permission checks
  - [x] Test logging of unauthorized attempts

- [x] **Task 6: Update story documentation**
  - [x] Mark ACs complete
  - [x] Add Dev Agent Record
  - [x] Add Change Log

## Dev Notes

### Permission Middleware

**File:** `apps/web/main-app/src/lib/permission-middleware.ts`

```typescript
import { redirect } from '@tanstack/react-router'
import type { AuthState } from '@/store/slices/authSlice'

export interface PermissionOptions {
  roles?: string[]
  permissions?: string[]
  requireAll?: boolean // true = AND, false = OR
  redirectTo?: string
}

export function createPermissionMiddleware(options: PermissionOptions) {
  const { roles = [], permissions = [], requireAll = false, redirectTo = '/unauthorized' } = options

  return ({ context }: { context: any }) => {
    const auth: AuthState = context.auth

    if (!auth.isAuthenticated) {
      throw redirect({ to: '/login' })
    }

    const userRoles = auth.user?.roles || []
    const userPermissions = auth.user?.permissions || []

    const checks: boolean[] = []

    // Check roles
    if (roles.length > 0) {
      const hasRole = roles.some(role => userRoles.includes(role))
      checks.push(hasRole)
    }

    // Check permissions
    if (permissions.length > 0) {
      const hasPermission = permissions.some(perm => userPermissions.includes(perm))
      checks.push(hasPermission)
    }

    const passed = requireAll ? checks.every(Boolean) : checks.some(Boolean)

    if (!passed) {
      logger.warn('Unauthorized access attempt', {
        userId: auth.user?.id,
        requiredRoles: roles,
        requiredPermissions: permissions,
      })
      throw redirect({ to: redirectTo })
    }
  }
}

// Pre-configured middleware
export const PermissionMiddleware = {
  admin: createPermissionMiddleware({ roles: ['admin'] }),
  moderator: createPermissionMiddleware({ roles: ['admin', 'moderator'] }),
}
```

### Route Usage

```typescript
export const Route = createFileRoute('/admin')({
  beforeLoad: PermissionMiddleware.admin,
  component: AdminPage,
})
```

### Unauthorized Page

Create a simple /unauthorized page:

```typescript
export function UnauthorizedPage() {
  return (
    <div className="flex flex-col items-center justify-center min-h-[60vh]">
      <ShieldX className="h-12 w-12 text-destructive" />
      <h1 className="mt-4 text-2xl font-bold">Access Denied</h1>
      <p className="text-muted-foreground">
        You don't have permission to view this page.
      </p>
      <Button asChild className="mt-4">
        <Link to="/">Go Home</Link>
      </Button>
    </div>
  )
}
```

### Testing

- Test admin role allows access
- Test non-admin redirects
- Test permission-based check
- Test AND vs OR logic

## Dev Agent Record

### Implementation Approach

Enhanced existing `route-guards.ts` instead of creating new `permission-middleware.ts` to:
- Avoid code duplication with existing role-based checking
- Maintain single source of truth for route protection
- Leverage existing test infrastructure (38 tests → 46 tests)
- Keep consistent API for developers

### Key Changes

1. **Added `getTokenScopes()` helper to `jwt.ts`**:
   - Extracts permissions from Cognito access token's `scope` field
   - Parses space-separated scope string into array
   - Example: `"openid profile custom:gallery.read"` → `["openid", "profile", "custom:gallery.read"]`

2. **Enhanced `RouteGuardOptions` interface**:
   - Added `requirePermissions?: string[]` - checks scopes from access token
   - Added `requireAll?: boolean` - controls AND vs OR logic (default: false for OR)

3. **Updated permission/role checking logic**:
   - Extracts permissions from access token using `getTokenScopes()`
   - Supports combined role + permission checks
   - OR logic (default): User needs at least ONE required role/permission
   - AND logic (`requireAll: true`): User needs ALL required roles/permissions
   - Logs unauthorized access attempts with user ID, path, and requirements

4. **Created `/unauthorized` page**:
   - LEGO-themed design with locked brick illustration
   - 403 error code with red/amber gradient
   - "Go Home" and "Go Back" buttons

5. **Added pre-configured `RouteGuards.moderator`**:
   - Demonstrates OR logic: requires admin OR moderator role
   - Uses `requireAll: false` for flexibility

### Test Coverage

- Added 8 new tests (38 → 46 total tests)
- Permission-based checking (with/without required permissions)
- AND logic (`requireAll: true`) for strict authorization
- OR logic (`requireAll: false`) for flexible authorization
- Combined role + permission checks
- Logging of unauthorized access attempts
- All 46 tests passing

### Files Modified

- `apps/web/main-app/src/lib/jwt.ts` - Added `getTokenScopes()` helper
- `apps/web/main-app/src/lib/route-guards.ts` - Enhanced with permission checking
- `apps/web/main-app/src/lib/__tests__/jwt.test.ts` - Added 6 tests for `getTokenScopes()`
- `apps/web/main-app/src/lib/__tests__/route-guards.test.ts` - Added 8 tests for permissions

### Files Created

- `apps/web/main-app/src/routes/pages/UnauthorizedPage.tsx` - 403 error page
- Updated `apps/web/main-app/src/routes/index.ts` - Added `/unauthorized` route

## Change Log

| Date       | Version | Description                                  | Author   |
| ---------- | ------- | -------------------------------------------- | -------- |
| 2025-11-30 | 1.0     | Implemented permission checking (Story 1.27) | AI Agent |
| 2025-11-28 | 0.1     | Initial draft                                | SM Agent |
