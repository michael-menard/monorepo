# Story 3.1.36: Edit Finalize Endpoint

## GitHub Issue
- Issue: #257
- URL: https://github.com/michael-menard/monorepo/issues/257
- Status: Todo

## Status

Draft

## Story

**As an** owner,
**I want** to commit my edit changes atomically,
**so that** metadata updates, new files, and removed files are saved together.

## Epic Context

This is **Story 1.4 of Epic 1: Backend Edit Pipeline**.

## Blocked By

- All Epic 0 stories (3.1.28-3.1.32)
- Story 3.1.33: GET MOC for Edit Endpoint
- Story 3.1.35: Edit Presign Endpoint

## Acceptance Criteria

1. POST `/mocs/:mocId/edit/finalize` accepts: metadata changes, new file keys, removed file IDs
2. Verifies new files exist in S3 with magic bytes validation
3. Soft-deletes removed files (mark `deletedAt`)
4. Updates MOC record atomically
5. Idempotent by `updatedAt` comparison (prevents duplicate submissions)
6. Re-indexes in OpenSearch
7. Returns updated MOC data

## Tasks / Subtasks

- [ ] **Task 1: Create Handler Structure** (AC: 1)
  - [ ] Create `apps/api/endpoints/moc-instructions/edit-finalize/handler.ts`
  - [ ] Create Zod request schema
  - [ ] Create Zod response schema

- [ ] **Task 2: Verify New Files in S3** (AC: 2)
  - [ ] For each new file key, call S3 HeadObject
  - [ ] Download first 8KB for magic bytes validation
  - [ ] Verify MIME type matches expected for category
  - [ ] Return 400 if any file missing or invalid

- [ ] **Task 3: Soft-Delete Removed Files** (AC: 3)
  - [ ] For each removed file ID, set `deletedAt = NOW()`
  - [ ] Verify file belongs to this MOC (security)
  - [ ] Do not hard delete - cleanup job handles that

- [ ] **Task 4: Atomic Update** (AC: 4, 5)
  - [ ] Use database transaction
  - [ ] Update MOC metadata
  - [ ] Insert new file records
  - [ ] Soft-delete removed files
  - [ ] Use `updatedAt` comparison for idempotency
  - [ ] If `updatedAt` mismatch, return 409 (concurrent edit)

- [ ] **Task 5: Re-index OpenSearch** (AC: 6)
  - [ ] After successful commit, update OpenSearch
  - [ ] Update all indexed fields including file references
  - [ ] Fail-open with warning log

- [ ] **Task 6: Return Updated Data** (AC: 7)
  - [ ] Return full MOC data with updated fields
  - [ ] Include new file list (excluding deleted)
  - [ ] Include presigned GET URLs for files

- [ ] **Task 7: Add Observability**
  - [ ] Log finalize start with file counts
  - [ ] Log S3 verification results
  - [ ] Log transaction completion
  - [ ] Warn on OpenSearch failures

## Dev Notes

### Request Schema

```typescript
const EditFinalizeRequestSchema = z.object({
  // Metadata updates (all optional)
  title: z.string().min(1).max(100).optional(),
  description: z.string().max(2000).optional(),
  tags: z.array(z.string()).max(10).optional(),
  theme: z.string().nullable().optional(),
  slug: z.string().optional(),

  // File changes
  newFiles: z.array(z.object({
    s3Key: z.string(),
    category: z.enum(['instruction', 'image', 'parts-list', 'thumbnail']),
    filename: z.string(),
    size: z.number().positive(),
    mimeType: z.string(),
  })).optional().default([]),

  removedFileIds: z.array(z.string().uuid()).optional().default([]),

  // Idempotency
  expectedUpdatedAt: z.string().datetime(), // For conflict detection
})
```

### Idempotency Pattern (updatedAt Comparison)

```typescript
// Before finalize: client includes expectedUpdatedAt from GET response
// During finalize: check if it matches current value

const [current] = await db
  .select({ updatedAt: mocInstructions.updatedAt })
  .from(mocInstructions)
  .where(eq(mocInstructions.id, mocId))

if (current.updatedAt.toISOString() !== body.expectedUpdatedAt) {
  return response409({
    code: 'CONCURRENT_EDIT',
    message: 'This MOC was modified since you started editing. Please reload and try again.',
    currentUpdatedAt: current.updatedAt.toISOString(),
  })
}
```

### Magic Bytes Validation

```typescript
import { validateMagicBytes } from '@monorepo/file-validator'

for (const file of newFiles) {
  // Check file exists
  const head = await s3.headObject({ Bucket, Key: file.s3Key })
  if (!head) {
    throw new ValidationError('FILE_NOT_FOUND', { s3Key: file.s3Key })
  }

  // Validate magic bytes
  const chunk = await s3.getObject({
    Bucket,
    Key: file.s3Key,
    Range: 'bytes=0-8191', // First 8KB
  })
  const buffer = await chunk.Body.transformToByteArray()

  if (!validateMagicBytes(buffer, file.mimeType)) {
    throw new ValidationError('INVALID_FILE_CONTENT', {
      s3Key: file.s3Key,
      expectedType: file.mimeType,
    })
  }
}
```

### Atomic Transaction

```typescript
await db.transaction(async tx => {
  // 1. Update MOC metadata
  const [updated] = await tx
    .update(mocInstructions)
    .set({
      ...metadataUpdates,
      updatedAt: new Date(),
    })
    .where(
      and(
        eq(mocInstructions.id, mocId),
        eq(mocInstructions.updatedAt, expectedUpdatedAt) // Optimistic lock
      )
    )
    .returning()

  if (!updated) {
    throw new ConcurrentEditError()
  }

  // 2. Insert new files
  if (newFiles.length > 0) {
    await tx.insert(mocFiles).values(
      newFiles.map(f => ({
        id: generateUUID(),
        mocId,
        category: f.category,
        s3Key: f.s3Key,
        filename: f.filename,
        size: f.size,
        mimeType: f.mimeType,
        uploadedAt: new Date(),
      }))
    )
  }

  // 3. Soft-delete removed files
  if (removedFileIds.length > 0) {
    await tx
      .update(mocFiles)
      .set({ deletedAt: new Date() })
      .where(
        and(
          eq(mocFiles.mocId, mocId),
          inArray(mocFiles.id, removedFileIds)
        )
      )
  }

  return updated
})
```

### Thumbnail Handling

If instruction PDF is replaced:
- Regenerate thumbnail server-side (or queue for async processing)
- Use first page of PDF as thumbnail source

## Testing

### Test Location
- `apps/api/endpoints/moc-instructions/edit-finalize/__tests__/handler.test.ts`

### Test Requirements
- Unit: Request schema validation
- Integration: S3 file verification (mock S3)
- Integration: Magic bytes validation
- Integration: Atomic transaction (all-or-nothing)
- Integration: Soft-delete sets `deletedAt`
- Integration: 409 on concurrent edit (updatedAt mismatch)
- Integration: OpenSearch receives update
- Integration: Response includes updated data with file URLs
- Unit: Idempotency (same request returns same result)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 0.1 | Initial draft from Edit MOC PRD | SM Agent |

## Dev Agent Record

### Agent Model Used

N/A

### Debug Log References

N/A

### Completion Notes

N/A

### File List

- `apps/api/endpoints/moc-instructions/edit-finalize/handler.ts` - New
- `apps/api/endpoints/moc-instructions/edit-finalize/__tests__/handler.test.ts` - New
- `apps/api/stacks/functions/moc-instructions.yml` - Modified (add route)
