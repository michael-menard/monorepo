# Story 4.3: Implement PATCH /api/users/:id - Update User Profile

**Epic**: 4 - User Profile & Advanced Features Migration

**As a** user,
**I want** to update my profile information,
**so that** I can keep my details current.

## Acceptance Criteria

1. Lambda handler accepts `name` field update (other Cognito attributes managed via Cognito console)
2. Validation: `name` must be 1-100 characters, alphanumeric + spaces
3. Update via `AdminUpdateUserAttributesCommand` to Cognito User Pool
4. Authorization: userId match enforced
5. Redis cache invalidated for user profile
6. Response format: `{ success: true, data: { ...updated profile } }`
7. 400 for validation errors, 403 for unauthorized, 500 for Cognito API errors

## Implementation Status

**Status**: ✅ Completed

## Files Modified

### New Files
- `src/lib/validation/profile-schemas.ts` - Zod schema for profile update validation
- `src/lib/validation/__tests__/profile-schemas.test.ts` - Unit tests for validation schema (19 tests)
- `src/functions/__tests__/profile-update.test.ts` - Unit tests for PATCH handler (13 tests)

### Modified Files
- `src/functions/profile-update.ts` - Implemented full PATCH handler logic
- `src/lib/services/profile-service.ts` - Added `updateUserProfile()` function
- `src/lib/cognito/cognito-client.ts` - Already has `updateCognitoUserAttributes()` helper
- `sst.config.ts` - Updated profileUpdateFunction to link postgres (for fetching updated profile)

## QA Results

_Pending implementation and review_

---

## Requirements Traceability Matrix

| AC # | Requirement                            | Test Coverage | Status   |
| ---- | -------------------------------------- | ------------- | -------- |
| 1    | Accept name field update               | profile-update.test.ts (2 tests) | ✅ COMPLETE |
| 2    | Name validation (1-100 chars)          | profile-schemas.test.ts (19 tests) | ✅ COMPLETE |
| 3    | AdminUpdateUserAttributesCommand       | Implemented in updateUserProfile() | ✅ COMPLETE |
| 4    | Authorization userId match             | profile-update.test.ts (2 tests) | ✅ COMPLETE |
| 5    | Redis cache invalidation               | Implemented in updateUserProfile() | ✅ COMPLETE |
| 6    | Response format compliance             | profile-update.test.ts (2 tests) | ✅ COMPLETE |
| 7    | Error handling (400, 403, 500)         | profile-update.test.ts (7 tests) | ✅ COMPLETE |

**Overall Coverage: 32 tests (19 validation + 13 handler)**

---

## Test Summary

### Implemented Test Coverage

#### Validation Schema Tests (`profile-schemas.test.ts`) - 19 tests

1. **Valid Inputs** - 5 tests
   - Valid name with letters only
   - Name with letters and numbers
   - Name with multiple spaces
   - Single character name
   - Name with exactly 100 characters

2. **Empty/Short Names** - 2 tests
   - Empty string → validation error
   - Missing name field → type error

3. **Too Long** - 2 tests
   - 101 characters → validation error
   - 200 characters → validation error

4. **Special Characters** - 7 tests
   - Names with !, @, #, $, %, _, -, periods, emojis → validation errors

5. **Wrong Types** - 3 tests
   - Number instead of string
   - Null value
   - Undefined value

#### Handler Tests (`profile-update.test.ts`) - 13 tests

1. **Successful Update** - 2 tests
   - Update name successfully
   - Update with numbers and spaces

2. **Validation Errors** - 4 tests
   - Empty name → 400
   - Name too long → 400
   - Special characters → 400
   - Missing name field → 400
   - Invalid JSON → 400

3. **Authorization** - 2 tests
   - 403 when updating another user's profile
   - 401 when JWT missing

4. **Error Handling** - 3 tests
   - 404 when user not found
   - 500 when Cognito update fails
   - 500 on unexpected errors

**Total: 32 passing tests**

---

## Technical Notes

### Validation Schema

```typescript
import { z } from 'zod'

const UpdateProfileSchema = z.object({
  name: z
    .string()
    .min(1, 'Name is required')
    .max(100, 'Name must be less than 100 characters')
    .regex(/^[a-zA-Z0-9\s]+$/, 'Name can only contain letters, numbers, and spaces'),
})

export type UpdateProfileRequest = z.infer<typeof UpdateProfileSchema>
```

### Cognito Update Command

```typescript
import { AdminUpdateUserAttributesCommand } from '@aws-sdk/client-cognito-identity-provider'

const command = new AdminUpdateUserAttributesCommand({
  UserPoolId: process.env.COGNITO_USER_POOL_ID,
  Username: userId,
  UserAttributes: [
    {
      Name: 'name',
      Value: updateData.name,
    },
  ],
})

await cognitoClient.send(command)
```

### Handler Implementation

```typescript
async function handleUpdateProfile(
  event: APIGatewayProxyEventV2,
  userId: string,
  profileId: string,
): Promise<APIGatewayProxyResultV2> {
  // Authorization check
  if (userId !== profileId) {
    return createErrorResponse(403, 'FORBIDDEN', 'Cannot update another user\'s profile')
  }

  // Parse and validate request body
  const body = JSON.parse(event.body || '{}')
  const updateData = UpdateProfileSchema.parse(body)

  // Update Cognito user attributes
  try {
    const command = new AdminUpdateUserAttributesCommand({
      UserPoolId: process.env.COGNITO_USER_POOL_ID!,
      Username: userId,
      UserAttributes: [
        {
          Name: 'name',
          Value: updateData.name,
        },
      ],
    })

    await cognitoClient.send(command)
  } catch (error) {
    console.error('Cognito update error:', error)
    return createErrorResponse(500, 'INTERNAL_ERROR', 'Failed to update profile')
  }

  // Invalidate cache
  const redis = await getRedisClient()
  await redis.del(`profile:user:${userId}`)

  // Fetch updated profile (leverages Story 4.2 logic)
  const updatedProfile = await getProfile(userId)

  return createSuccessResponse(updatedProfile)
}
```

### Cache Invalidation

```typescript
// Invalidate profile cache after update
const cacheKey = `profile:user:${userId}`
await redis.del(cacheKey)

// Next GET request will fetch fresh data from Cognito
```

### Response Format

```json
{
  "success": true,
  "data": {
    "id": "cognito-user-sub-uuid",
    "email": "user@example.com",
    "name": "Updated Name",
    "avatarUrl": "https://bucket.s3.region.amazonaws.com/avatars/userId/avatar.webp",
    "stats": {
      "mocs": 15,
      "images": 42,
      "wishlistItems": 8
    }
  },
  "timestamp": "2025-01-02T12:00:00Z"
}
```

### Error Handling

```typescript
try {
  const updateData = UpdateProfileSchema.parse(body)
} catch (error) {
  if (error instanceof z.ZodError) {
    return createErrorResponse(
      400,
      'VALIDATION_ERROR',
      error.errors.map(e => e.message).join(', ')
    )
  }
  throw error
}

try {
  await cognitoClient.send(command)
} catch (error) {
  if (error.name === 'UserNotFoundException') {
    return createErrorResponse(404, 'NOT_FOUND', 'User not found')
  }

  console.error('Cognito update error:', error)
  return createErrorResponse(500, 'INTERNAL_ERROR', 'Failed to update profile')
}
```

### Validation Examples

```typescript
// Valid names
"John Doe"       // ✅
"Jane Smith 123" // ✅
"ABC"            // ✅

// Invalid names
""               // ❌ Too short
"A"              // ✅ Technically valid (min 1 char)
"Name!@#"        // ❌ Invalid characters
"A".repeat(101)  // ❌ Too long
```

---

## Design Decisions

### Limited Update Scope

**Decision**: Only allow `name` field updates via API

**Rationale**:
- Email changes require verification flow (handled by Cognito Hosted UI)
- Password changes should use Cognito's secure forgot password flow
- Email verification status is system-managed
- Avatar has dedicated endpoints (Stories 4.4, 4.5)

**Other Cognito Attributes**: Managed via AWS Cognito console or Cognito Hosted UI

### Name Validation Pattern

**Regex**: `/^[a-zA-Z0-9\s]+$/`

**Allows**:
- Letters (uppercase and lowercase)
- Numbers
- Spaces

**Blocks**:
- Special characters (@, !, #, etc.)
- Emojis
- Unicode characters beyond basic ASCII

**Future Enhancement**: Consider allowing more Unicode characters for international names

---

## Dependencies

- **Story 4.1**: Profile Lambda handler infrastructure (prerequisite)
- **Story 4.2**: Get profile logic for response (used after update)
- **AWS Cognito User Pool**: Must be configured and accessible
- **Redis**: For cache invalidation

---

## Security Considerations

1. **Authorization**: Strict userId matching prevents cross-user updates
2. **Input Validation**: Zod schema prevents injection attacks
3. **Rate Limiting**: Consider implementing to prevent abuse
4. **Audit Logging**: Log all profile updates with userId and timestamp
