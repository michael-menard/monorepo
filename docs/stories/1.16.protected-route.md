# Story 1.16: Protected Route

## Status

Ready for Review

## Story

**As a** developer,
**I want** route protection that redirects unauthenticated users,
**so that** protected pages are secure.

## Acceptance Criteria

1. ✅ Route guard utility exists
2. ✅ Protected routes redirect to /login
3. ✅ Redirect includes original URL as search param
4. ✅ Loading state shows while auth checking
5. ✅ Role-based route protection available
6. ✅ Guest-only routes redirect authenticated users

## Tasks / Subtasks

- [x] **Task 1: Verify Route Guards Exist** (AC: 1-3)
  - [x] Check lib/route-guards.ts exists
  - [x] Verify createTanStackRouteGuard function
  - [x] Check RouteGuards.protected exists
  - [x] Verify redirect includes search param

- [x] **Task 2: Loading State** (AC: 4)
  - [x] Guard skips redirect while auth.isLoading
  - [x] Show loading component during check (RootLayout LEGO brick animation)
  - [x] Verify user doesn't see flash of login page

- [x] **Task 3: Verify Role-Based Guards** (AC: 5)
  - [x] Check RouteGuards.admin exists
  - [x] Verify requireRoles option works
  - [x] Test role check logic (23 tests pass)

- [x] **Task 4: Guest-Only Routes** (AC: 6)
  - [x] Check RouteGuards.guestOnly exists
  - [x] Verify redirects authenticated users
  - [x] Apply to login, signup, forgot-password routes

## Dev Notes

### Existing Implementation ✅

**File:** `apps/web/main-app/src/lib/route-guards.ts`

Already implements:

- createTanStackRouteGuard() factory function
- RouteGuards.public
- RouteGuards.protected
- RouteGuards.verified
- RouteGuards.admin
- RouteGuards.guestOnly
- Redirect with search param for return URL

### Route Configuration

```typescript
// In route definition
export const Route = createFileRoute('/dashboard')({
  beforeLoad: RouteGuards.protected,
  component: DashboardPage,
})
```

### Loading State Handling

The current implementation skips guard if auth.isLoading:

```typescript
if (auth.isLoading) {
  return // Don't redirect, wait for auth check
}
```

### Guest-Only Implementation

```typescript
guestOnly: createTanStackRouteGuard({
  guestOnly: true,
  redirectTo: '/dashboard',
})
```

### Testing

- Test protected route redirects when not authenticated
- Test protected route allows when authenticated
- Test redirect URL is preserved
- Test guest-only redirects authenticated users

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### File List

| File                                                        | Action   | Description                                       |
| ----------------------------------------------------------- | -------- | ------------------------------------------------- |
| `apps/web/main-app/src/lib/route-guards.ts`                 | Modified | Added guestOnly option for redirecting auth users |
| `apps/web/main-app/src/App.tsx`                             | Modified | Connect auth state to router context via InnerApp |
| `apps/web/main-app/src/components/Layout/RootLayout.tsx`    | Modified | Added reset-password and new-password to public routes |
| `apps/web/main-app/src/lib/__tests__/route-guards.test.ts`  | Created  | 23 tests for route guards                         |

### Completion Notes

- Route guards were already implemented but router context wasn't receiving auth state
- Fixed by creating InnerApp component that connects Redux auth state to router context
- Added `guestOnly` option to RouteGuardOptions for cleaner guest-only logic
- Loading state is properly handled - guards skip while `isLoading` is true
- RootLayout shows LEGO brick animation during auth loading
- All 23 route guard tests pass

## Change Log

| Date       | Version | Description                        | Author    |
| ---------- | ------- | ---------------------------------- | --------- |
| 2025-11-28 | 0.1     | Initial draft - mostly implemented | SM Agent  |
| 2025-11-29 | 1.0     | Complete implementation & tests    | Dev Agent |
