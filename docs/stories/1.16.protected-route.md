# Story 1.16: Protected Route

## Status

Approved

## Story

**As a** developer,
**I want** route protection that redirects unauthenticated users,
**so that** protected pages are secure.

## Acceptance Criteria

1. ✅ Route guard utility exists
2. ✅ Protected routes redirect to /login
3. ✅ Redirect includes original URL as search param
4. ⬜ Loading state shows while auth checking
5. ⬜ Role-based route protection available
6. ⬜ Guest-only routes redirect authenticated users

## Tasks / Subtasks

- [ ] **Task 1: Verify Route Guards Exist** (AC: 1-3)
  - [x] Check lib/route-guards.ts exists
  - [x] Verify createTanStackRouteGuard function
  - [x] Check RouteGuards.protected exists
  - [x] Verify redirect includes search param

- [ ] **Task 2: Loading State** (AC: 4)
  - [ ] Guard skips redirect while auth.isLoading
  - [ ] Show loading component during check
  - [ ] Verify user doesn't see flash of login page

- [ ] **Task 3: Verify Role-Based Guards** (AC: 5)
  - [x] Check RouteGuards.admin exists
  - [x] Verify requireRoles option works
  - [ ] Test role check logic

- [ ] **Task 4: Guest-Only Routes** (AC: 6)
  - [x] Check RouteGuards.guestOnly exists
  - [ ] Verify redirects authenticated users
  - [ ] Apply to login, signup routes

## Dev Notes

### Existing Implementation ✅

**File:** `apps/web/main-app/src/lib/route-guards.ts`

Already implements:

- createTanStackRouteGuard() factory function
- RouteGuards.public
- RouteGuards.protected
- RouteGuards.verified
- RouteGuards.admin
- RouteGuards.guestOnly
- Redirect with search param for return URL

### Route Configuration

```typescript
// In route definition
export const Route = createFileRoute('/dashboard')({
  beforeLoad: RouteGuards.protected,
  component: DashboardPage,
})
```

### Loading State Handling

The current implementation skips guard if auth.isLoading:

```typescript
if (auth.isLoading) {
  return // Don't redirect, wait for auth check
}
```

### Guest-Only Implementation

```typescript
guestOnly: createTanStackRouteGuard({
  requireAuth: false,
  blockedPaths: ['/login', '/register', '/forgot-password'],
  redirectTo: '/dashboard',
})
```

### Testing

- Test protected route redirects when not authenticated
- Test protected route allows when authenticated
- Test redirect URL is preserved
- Test guest-only redirects authenticated users

## Change Log

| Date       | Version | Description                        | Author   |
| ---------- | ------- | ---------------------------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft - mostly implemented | SM Agent |
