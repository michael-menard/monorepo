# Story 1.30: Auth Middleware Tests

## Status

Approved

## Story

**As a** developer,
**I want** comprehensive tests for auth middleware,
**so that** authentication flows are verified.

## Acceptance Criteria

1. ⬜ Tests for JWT validation utility
2. ⬜ Tests for auth middleware
3. ⬜ Tests for permission middleware
4. ⬜ Tests for token refresh hook
5. ⬜ Tests for 401 handling
6. ⬜ Integration tests for protected routes

## Tasks / Subtasks

- [ ] **Task 1: JWT Utility Tests** (AC: 1)
  - [ ] Test decodeToken with valid token
  - [ ] Test decodeToken with invalid token
  - [ ] Test isTokenExpired with expired token
  - [ ] Test isTokenExpired with valid token
  - [ ] Test buffer time calculation

- [ ] **Task 2: Auth Middleware Tests** (AC: 2)
  - [ ] Test allows authenticated requests
  - [ ] Test redirects unauthenticated requests
  - [ ] Test skips during loading state
  - [ ] Test handles expired tokens

- [ ] **Task 3: Permission Middleware Tests** (AC: 3)
  - [ ] Test allows users with correct role
  - [ ] Test denies users without role
  - [ ] Test AND logic for multiple roles
  - [ ] Test OR logic for multiple roles

- [ ] **Task 4: Token Refresh Tests** (AC: 4)
  - [ ] Test refresh triggered near expiry
  - [ ] Test state updated after refresh
  - [ ] Test logout on refresh failure

- [ ] **Task 5: 401 Handling Tests** (AC: 5)
  - [ ] Test 401 triggers logout
  - [ ] Test redirect includes return URL
  - [ ] Test auth pages not redirected

- [ ] **Task 6: Integration Tests** (AC: 6)
  - [ ] Test protected route with auth
  - [ ] Test protected route without auth
  - [ ] Test role-protected route

## Dev Notes

### Test File Locations

- `lib/__tests__/jwt.test.ts`
- `lib/__tests__/auth-middleware.test.ts`
- `lib/__tests__/permission-middleware.test.ts`
- `hooks/__tests__/useTokenRefresh.test.ts`
- `services/api/__tests__/baseQuery.test.ts`

### JWT Utility Test Example

```typescript
import { decodeToken, isTokenExpired } from '../jwt'

describe('JWT utilities', () => {
  const createMockToken = (exp: number) => {
    const payload = { sub: '123', exp }
    const base64 = btoa(JSON.stringify(payload))
    return `header.${base64}.signature`
  }

  describe('decodeToken', () => {
    it('decodes valid token', () => {
      const token = createMockToken(Date.now() / 1000 + 3600)
      const payload = decodeToken(token)
      expect(payload?.sub).toBe('123')
    })

    it('returns null for invalid token', () => {
      const payload = decodeToken('invalid')
      expect(payload).toBeNull()
    })
  })

  describe('isTokenExpired', () => {
    it('returns true for expired token', () => {
      const token = createMockToken(Date.now() / 1000 - 100)
      expect(isTokenExpired(token)).toBe(true)
    })

    it('returns false for valid token', () => {
      const token = createMockToken(Date.now() / 1000 + 3600)
      expect(isTokenExpired(token)).toBe(false)
    })
  })
})
```

### Auth Middleware Test Example

```typescript
import { createAuthMiddleware } from '../auth-middleware'

describe('Auth Middleware', () => {
  const middleware = createAuthMiddleware({ requireAuth: true })

  it('allows authenticated users', () => {
    const context = {
      auth: { isAuthenticated: true, isLoading: false },
    }
    expect(() => middleware({ context, location: {} })).not.toThrow()
  })

  it('redirects unauthenticated users', () => {
    const context = {
      auth: { isAuthenticated: false, isLoading: false },
    }
    expect(() => middleware({ context, location: { pathname: '/test' } })).toThrow()
  })
})
```

### Mocking Amplify

```typescript
vi.mock('@aws-amplify/auth', () => ({
  fetchAuthSession: vi.fn(),
}))
```

### Testing

Meta: This story is about testing!

- Run all auth-related tests
- Verify coverage for auth code
- All tests pass

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
