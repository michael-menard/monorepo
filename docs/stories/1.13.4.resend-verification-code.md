# Story 1.13.4: Resend Verification Code

## Status

Ready for Review

## Story

**As a** user who hasn't received my verification code,
**I want** to request a new code,
**so that** I can complete the verification process.

## Acceptance Criteria

1. ✅ "Resend Code" button on verification pages
2. ✅ Calls appropriate Amplify resend function
3. ✅ Cooldown timer prevents spam (base 60 seconds)
4. ✅ Success toast/message when code is sent
5. ✅ Error handling for rate limits
6. ✅ Button disabled during cooldown
7. ✅ Countdown timer displayed (mm:ss format for > 60s)
8. ✅ Works for both signup verification and MFA
9. ✅ Exponential backoff on repeated resends (60s → 120s → 240s → 480s → 600s cap)
10. ✅ Attempt count persists in sessionStorage
11. ✅ Attempt count resets after 30 minutes of inactivity

## Tasks / Subtasks

- [x] **Task 1: Create Resend Button Component** (AC: 1, 6, 7)
  - [x] Create ResendCodeButton component
  - [x] Countdown timer state management
  - [x] Disabled state during cooldown
  - [x] Display remaining seconds (mm:ss for > 60s)

- [x] **Task 2: Amplify Integration** (AC: 2, 8)
  - [x] Add resendSignUpCode to AuthProvider
  - [x] Support for MFA code resend (if applicable)
  - [x] Handle different resend scenarios

- [x] **Task 3: Cooldown Logic** (AC: 3)
  - [x] 60-second base cooldown after resend
  - [x] Persist cooldown in sessionStorage
  - [x] Resume countdown on page reload

- [x] **Task 4: Feedback** (AC: 4, 5)
  - [x] Success toast notification
  - [x] Error handling for LimitExceededException
  - [x] Loading state during request

- [x] **Task 5: Exponential Backoff** (AC: 9, 10, 11)
  - [x] Implement exponential backoff formula: base × 2^(attempt-1)
  - [x] Cap maximum cooldown at 10 minutes (600s)
  - [x] Track attempt count in sessionStorage
  - [x] Auto-reset attempt count after 30 minutes of inactivity

## Dev Notes

### Exponential Backoff Schedule

| Attempt | Cooldown |
|---------|----------|
| 1st     | 60s      |
| 2nd     | 120s (2 min) |
| 3rd     | 240s (4 min) |
| 4th     | 480s (8 min) |
| 5th+    | 600s (10 min, capped) |

### ResendCodeButton Component

```typescript
interface ResendCodeButtonProps {
  /** Async function called when resend is requested */
  onResend: () => Promise<{ success: boolean; error?: string }>
  /** Base cooldown duration in seconds (first attempt). Default: 60 */
  baseCooldownSeconds?: number
  /** Maximum cooldown duration in seconds (cap). Default: 600 (10 min) */
  maxCooldownSeconds?: number
  /** Additional CSS classes */
  className?: string
  /** Whether the button should be disabled externally */
  disabled?: boolean
  /** Callback when resend succeeds */
  onSuccess?: () => void
  /** Callback when resend fails with error message */
  onError?: (error: string) => void
  /** Custom text when button is active */
  activeText?: string
}
```

### Exponential Backoff Implementation

```typescript
/**
 * Calculate exponential backoff cooldown based on attempt number
 * Formula: base * 2^(attempt-1), capped at max
 */
const calculateCooldown = (attemptNumber: number, baseCooldown: number, maxCooldown: number): number => {
  if (attemptNumber <= 0) return baseCooldown
  const exponentialCooldown = baseCooldown * Math.pow(2, attemptNumber - 1)
  return Math.min(exponentialCooldown, maxCooldown)
}
```

### SessionStorage Keys

```typescript
const RESEND_COOLDOWN_KEY = 'auth_resend_cooldown'      // Cooldown expiration timestamp
const RESEND_ATTEMPT_KEY = 'auth_resend_attempts'       // Number of attempts
const RESEND_ATTEMPT_RESET_KEY = 'auth_resend_attempt_reset'  // When to reset attempts
```

### Amplify v6 Resend Code

```typescript
import { resendSignUpCode } from 'aws-amplify/auth'

async function handleResendCode(email: string) {
  await resendSignUpCode({ username: email })
}
```

## Dependencies

- Story 1.13.3: Email Verification Flow (Uses this)
- Story 1.23: Toast System (For notifications)

## Change Log

| Date       | Version | Description                              | Author      |
| ---------- | ------- | ---------------------------------------- | ----------- |
| 2025-11-28 | 0.1     | Initial draft                            | Claude Code |
| 2025-11-29 | 0.2     | Added exponential backoff (AC 9, 10, 11) | Claude Code |
