# Story 3.1.22: Filename & Content Hardening

## Status

Ready for Review

## Story

As a platform,
I want safe filenames and content checks,
so uploads donâ€™t introduce risk.

## Acceptance Criteria

1. Safe keying & names

- Sanitize filename: strip control chars, reserved names, excessive length; normalize unicode; keep extension.
- Server generates S3 keys; never trust client path.

2. Content checks

- Enforce allowlisted extensions and types; finalize validates magic bytes (3.1.8).

3. Tests

- Unit: filename sanitizer; Integration: reject dangerous names; keep safe names.

## Tasks / Subtasks

- [x] Filename sanitizer util + tests
- [x] Integrate into presign/finalize
- [x] Docs: guidance for users on allowed names/types

## Dev Notes

- Keep user-visible name in metadata; key is independent and safe.

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

| File                                                                   | Action   | Description                                                                 |
| ---------------------------------------------------------------------- | -------- | --------------------------------------------------------------------------- |
| `apps/api/core/utils/filename-sanitizer.ts`                            | Created  | Centralized filename sanitizer utility with comprehensive security features |
| `apps/api/core/utils/__tests__/filename-sanitizer.test.ts`             | Created  | 83 unit tests for filename sanitizer covering all edge cases                |
| `apps/api/endpoints/moc-instructions/_shared/moc-file-service.ts`      | Modified | Integrated sanitizeFilenameForS3 from central utility                       |
| `apps/api/endpoints/moc-instructions/initialize-with-files/handler.ts` | Modified | Integrated sanitizeFilenameForS3 from central utility                       |
| `docs/guides/file-upload-requirements.md`                              | Created  | User documentation for allowed names, types, and best practices             |

### Debug Log References

- None required; all tests passed on first run after fixes

### Completion Notes

1. Created comprehensive filename sanitizer with:
   - Control character stripping (0x00-0x1F, 0x7F-0x9F)
   - Windows reserved name blocking (CON, PRN, AUX, NUL, COM1-9, LPT1-9)
   - Unicode NFC normalization
   - Path traversal prevention (strips path components)
   - Length limiting to 255 characters
   - Extension preservation during truncation
   - Unsafe character replacement with collapse
2. Replaced duplicate inline sanitizeFilename functions with centralized utility
3. All 83 unit tests pass including dangerous filename integration tests
4. All 355 API tests pass after integration
5. Type checking passes

## Change Log

| Date       | Version | Description                         | Author |
| ---------- | ------- | ----------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft (hardening filenames) | SM     |
| 2025-12-08 | 1.0     | Implementation complete             | Claude |
