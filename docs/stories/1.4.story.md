# Story 1.4: CloudWatch Monitoring & Alarms Setup

## Status

**Draft**

---

## Story

**As a** DevOps Engineer,
**I want** to configure comprehensive CloudWatch monitoring dashboards and alarms for the Image Service,
**so that** we can proactively monitor health, performance, and errors before Lambda handlers are deployed.

---

## Acceptance Criteria

1. CloudWatch dashboard created with widgets for:
   - Lambda invocations, errors, duration
   - DynamoDB read/write capacity, throttles
   - S3 upload/download metrics
   - CloudFront requests, cache hit rate
   - API Gateway 4xx/5xx errors
2. CloudWatch alarms configured for:
   - Lambda error rate >1%
   - Lambda P95 duration >1000ms
   - DynamoDB throttling >0
   - S3 5xx errors >5/hour
   - API Gateway 5xx errors >10/hour
3. SNS topic created for alarm notifications
4. Test alarm triggering verified
5. Dashboard accessible via AWS Console
6. All alarms in "OK" state (no active alerts)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Monitoring Stack File** (AC: 1, 2, 3)
  - [ ] Create `stacks/MonitoringStack.ts`
  - [ ] Import CloudWatch, SNS, and alarm constructs from AWS CDK
  - [ ] Add MonitoringStack to `sst.config.ts`

- [ ] **Task 2: Create SNS Topic for Alarms** (AC: 3)
  - [ ] Define SNS topic: `image-service-alarms-{stage}`
  - [ ] Add email subscription (use environment variable for email)
  - [ ] Set display name: "Image Service Alarms"
  - [ ] Export topic ARN for use in alarms

- [ ] **Task 3: Configure Lambda Alarms** (AC: 2)
  - [ ] Create error rate alarm (>10 errors in 5 minutes)
  - [ ] Create P95 latency alarm (>3000ms)
  - [ ] Create throttle alarm (>5 throttles in 5 minutes)
  - [ ] Link all alarms to SNS topic
  - [ ] Set evaluation periods: 2 for errors/latency, 1 for throttles

- [ ] **Task 4: Configure DynamoDB Alarms** (AC: 2)
  - [ ] Create system errors alarm (>5 errors in 5 minutes)
  - [ ] Create user errors alarm (>10 in 5 minutes, 2 evaluation periods)
  - [ ] Link alarms to SNS topic
  - [ ] Note: Will show "Insufficient Data" until Lambda handlers deployed (Epic 2)

- [ ] **Task 5: Configure S3 Alarms** (AC: 2)
  - [ ] Create 5xx error alarm (>5 errors per hour)
  - [ ] Link to SNS topic
  - [ ] Set 5-minute period, 2 evaluation periods

- [ ] **Task 6: Configure CloudFront Alarms** (AC: 2)
  - [ ] Create 5xx error rate alarm (>1%)
  - [ ] Create cache hit rate alarm (<80%)
  - [ ] Link to SNS topic
  - [ ] Set appropriate evaluation periods

- [ ] **Task 7: Configure API Gateway Alarms** (AC: 2)
  - [ ] Create 5xx error alarm (>10 errors per hour)
  - [ ] Create 4xx error alarm (>100 errors per hour)
  - [ ] Link to SNS topic

- [ ] **Task 8: Create CloudWatch Dashboard** (AC: 1)
  - [ ] Create dashboard: `ImageService-{stage}`
  - [ ] Add Lambda metrics widget (invocations, errors, duration)
  - [ ] Add DynamoDB metrics widget (read/write capacity, errors)
  - [ ] Add S3 metrics widget (requests, errors, latency)
  - [ ] Add CloudFront metrics widget (requests, cache hit rate, errors)
  - [ ] Add API Gateway metrics widget (requests, latency, errors)
  - [ ] Organize widgets in logical layout (2-3 columns)

- [ ] **Task 9: Deploy Monitoring Stack** (AC: 5, 6)
  - [ ] Run `pnpm sst deploy --stage dev`
  - [ ] Verify SNS topic created
  - [ ] Verify alarms created in CloudWatch console
  - [ ] Verify dashboard created and accessible
  - [ ] Check alarm states (should be "Insufficient Data" or "OK")

- [ ] **Task 10: Test Alarm Notifications** (AC: 4)
  - [ ] Confirm SNS subscription via email
  - [ ] Manually trigger test alarm (set low threshold temporarily)
  - [ ] Verify email notification received
  - [ ] Reset alarm threshold to production values
  - [ ] Document alarm notification flow

---

## Dev Notes

### Monitoring Context

This story sets up proactive monitoring before Lambda handlers are deployed (Epic 2). The monitoring infrastructure will initially show "Insufficient Data" for most alarms, but will become active as soon as Lambda handlers start processing requests.

**Source:** [docs/prd/image-service-migration/09-monitoring.md](../prd/image-service-migration/09-monitoring.md)

### SNS Topic Configuration

**Source:** [docs/prd/image-service-migration/09-monitoring.md](../prd/image-service-migration/09-monitoring.md)

**Topic Name:** `image-service-alarms-{stage}`

**Email Subscription:**
```typescript
import { Topic } from 'aws-cdk-lib/aws-sns'
import { EmailSubscription } from 'aws-cdk-lib/aws-sns-subscriptions'

const snsAlarmTopic = new Topic(stack, 'ImageServiceAlarms', {
  displayName: 'Image Service Alarms',
  topicName: `image-service-alarms-${stage}`,
})

// Use environment variable for email
const alertEmail = process.env.ALARM_EMAIL || 'devops@lego-moc.com'
snsAlarmTopic.addSubscription(new EmailSubscription(alertEmail))
```

**Important:** After deployment, confirm the SNS subscription via email before alarms can send notifications.

### Lambda Alarms

**Source:** [docs/prd/image-service-migration/09-monitoring.md](../prd/image-service-migration/09-monitoring.md#upload-lambda-alarms)

Since Lambda handlers aren't deployed yet, these alarms will reference function names that will be created in Epic 2:

**Alarm Thresholds:**

1. **Error Rate Alarm**
   - Threshold: >10 errors in 5 minutes
   - Evaluation periods: 2
   - Statistic: Sum
   - Why: Catches sustained error patterns, not transient failures

2. **P95 Latency Alarm**
   - Threshold: >3000ms (3 seconds)
   - Evaluation periods: 2
   - Statistic: p95
   - Why: Upload operations should complete <3s (target <1s)

3. **Throttle Alarm**
   - Threshold: >5 throttles in 5 minutes
   - Evaluation periods: 1
   - Statistic: Sum
   - Why: Immediate alert - throttling indicates capacity issues

**Implementation:**
```typescript
import { Alarm, ComparisonOperator } from 'aws-cdk-lib/aws-cloudwatch'
import { Duration } from 'aws-cdk-lib'

// Note: uploadLambda won't exist until Epic 2
// For now, create alarms with function name references
const uploadFunctionName = `image-service-upload-${stage}`

new Alarm(stack, 'UploadErrorRateAlarm', {
  metricName: 'Errors',
  namespace: 'AWS/Lambda',
  dimensions: {
    FunctionName: uploadFunctionName,
  },
  period: Duration.minutes(5),
  statistic: 'Sum',
  threshold: 10,
  evaluationPeriods: 2,
  comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
  alarmDescription: 'Upload Lambda error rate exceeded threshold',
  actionsEnabled: true,
  alarmActions: [snsAlarmTopic.topicArn],
})
```

### DynamoDB Alarms

**Source:** [docs/prd/image-service-migration/09-monitoring.md](../prd/image-service-migration/09-monitoring.md#dynamodb-alarms)

**Alarm Thresholds:**

1. **System Errors Alarm**
   - Threshold: >5 errors in 5 minutes
   - Evaluation periods: 1
   - Why: DynamoDB unavailability or infrastructure issues

2. **User Errors Alarm** (Throttling)
   - Threshold: >10 errors in 5 minutes
   - Evaluation periods: 2
   - Why: Throttling or conditional check failures

**Implementation:**
```typescript
import { Table } from 'sst/constructs'

// Reference the table created in ImageServiceStack
const tableName = `ImageMetadata-${stage}`

new Alarm(stack, 'DynamoDBSystemErrorsAlarm', {
  metricName: 'SystemErrors',
  namespace: 'AWS/DynamoDB',
  dimensions: {
    TableName: tableName,
  },
  period: Duration.minutes(5),
  statistic: 'Sum',
  threshold: 5,
  evaluationPeriods: 1,
  comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
  alarmDescription: 'DynamoDB system errors detected',
  actionsEnabled: true,
  alarmActions: [snsAlarmTopic.topicArn],
})
```

**Note:** On-demand billing prevents throttling in most cases, but alarm detects if it happens.

### S3 Alarms

**Source:** [docs/prd/image-service-migration/09-monitoring.md](../prd/image-service-migration/09-monitoring.md)

**Alarm Thresholds:**

1. **5xx Error Alarm**
   - Threshold: >5 errors per hour
   - Evaluation periods: 2
   - Why: S3 service issues or permission problems

**Implementation:**
```typescript
const bucketName = `images-lego-moc-${stage}`

new Alarm(stack, 'S35xxErrorAlarm', {
  metricName: '5xxErrors',
  namespace: 'AWS/S3',
  dimensions: {
    BucketName: bucketName,
  },
  period: Duration.hours(1),
  statistic: 'Sum',
  threshold: 5,
  evaluationPeriods: 2,
  comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
  alarmDescription: 'S3 5xx errors exceeded threshold',
  actionsEnabled: true,
  alarmActions: [snsAlarmTopic.topicArn],
})
```

### CloudFront Alarms

**Source:** [docs/prd/image-service-migration/09-monitoring.md](../prd/image-service-migration/09-monitoring.md#cloudfront-alarms)

**Alarm Thresholds:**

1. **5xx Error Rate Alarm**
   - Threshold: >1% error rate
   - Evaluation periods: 2
   - Why: Origin (S3) issues or configuration problems

2. **Cache Hit Rate Alarm**
   - Threshold: <80% cache hit rate
   - Evaluation periods: 2
   - Comparison: LESS_THAN_THRESHOLD
   - Why: Low cache hit rate increases costs and latency

**Implementation:**
```typescript
// Note: Distribution ID will be from ImageServiceStack output
const distributionId = 'E1234567890ABC' // Placeholder - get from stack output

new Alarm(stack, 'CloudFront5xxAlarm', {
  metricName: '5xxErrorRate',
  namespace: 'AWS/CloudFront',
  dimensions: {
    DistributionId: distributionId,
  },
  period: Duration.minutes(5),
  statistic: 'Average',
  threshold: 1, // 1%
  evaluationPeriods: 2,
  comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
  alarmDescription: 'CloudFront 5xx error rate exceeded 1%',
  actionsEnabled: true,
  alarmActions: [snsAlarmTopic.topicArn],
})
```

### API Gateway Alarms

**Alarm Thresholds:**

1. **5xx Error Alarm**
   - Threshold: >10 errors per hour
   - Evaluation periods: 2
   - Why: Lambda errors or Gateway configuration issues

2. **4xx Error Alarm** (Warning only)
   - Threshold: >100 errors per hour
   - Evaluation periods: 2
   - Why: Client errors (bad requests, unauthorized)

**Implementation:**
```typescript
// API ID from ImageServiceStack output
const apiId = 'abc123def456' // Placeholder

new Alarm(stack, 'ApiGateway5xxAlarm', {
  metricName: '5XXError',
  namespace: 'AWS/ApiGateway',
  dimensions: {
    ApiId: apiId,
  },
  period: Duration.hours(1),
  statistic: 'Sum',
  threshold: 10,
  evaluationPeriods: 2,
  comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
  alarmDescription: 'API Gateway 5xx errors exceeded threshold',
  actionsEnabled: true,
  alarmActions: [snsAlarmTopic.topicArn],
})
```

### CloudWatch Dashboard

**Source:** [docs/prd/image-service-migration/09-monitoring.md](../prd/image-service-migration/09-monitoring.md)

**Dashboard Name:** `ImageService-{stage}`

**Widget Layout:**
```
┌─────────────────────────────────────────────────────────┐
│ Lambda Metrics                | DynamoDB Metrics        │
│ - Invocations                | - Read/Write Capacity   │
│ - Errors                     | - Throttles             │
│ - Duration (P50, P95, P99)   | - User/System Errors    │
├─────────────────────────────────────────────────────────┤
│ S3 Metrics                    | CloudFront Metrics      │
│ - Requests                   | - Requests              │
│ - 4xx/5xx Errors            | - Cache Hit Rate        │
│ - Latency                   | - 4xx/5xx Errors        │
├─────────────────────────────────────────────────────────┤
│ API Gateway Metrics                                     │
│ - Total Requests                                        │
│ - Latency (P50, P95, P99)                              │
│ - 4xx/5xx Errors                                       │
└─────────────────────────────────────────────────────────┘
```

**Implementation:**
```typescript
import { Dashboard, GraphWidget, Metric } from 'aws-cdk-lib/aws-cloudwatch'

const dashboard = new Dashboard(stack, 'ImageServiceDashboard', {
  dashboardName: `ImageService-${stage}`,
})

// Lambda Widget
dashboard.addWidgets(
  new GraphWidget({
    title: 'Lambda Invocations & Errors',
    left: [
      new Metric({
        namespace: 'AWS/Lambda',
        metricName: 'Invocations',
        dimensions: { FunctionName: uploadFunctionName },
        statistic: 'Sum',
        period: Duration.minutes(5),
      }),
    ],
    right: [
      new Metric({
        namespace: 'AWS/Lambda',
        metricName: 'Errors',
        dimensions: { FunctionName: uploadFunctionName },
        statistic: 'Sum',
        period: Duration.minutes(5),
      }),
    ],
  }),
)

// Additional widgets for DynamoDB, S3, CloudFront, API Gateway...
```

### Stack Integration

**MonitoringStack Dependencies:**
- Needs table name from ImageServiceStack
- Needs bucket name from ImageServiceStack
- Needs CloudFront distribution ID from ImageServiceStack
- Needs API Gateway ID from ImageServiceStack

**Approach:**
Pass resource identifiers as parameters or use SST's built-in resource binding.

**Example:**
```typescript
// In sst.config.ts
export default $config({
  async run() {
    const imageService = await import('./stacks/ImageServiceStack')
    const monitoring = await import('./stacks/MonitoringStack')

    // Pass outputs to monitoring stack
    monitoring.MonitoringStack({
      tableName: imageService.tableName,
      bucketName: imageService.bucketName,
      distributionId: imageService.distributionId,
      apiId: imageService.apiId,
    })
  },
})
```

### Testing Alarms

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md#testing)

**Manual Test Procedure:**

1. **Verify SNS Subscription**
   - Check email for SNS confirmation
   - Click confirmation link
   - Verify subscription status in AWS Console

2. **Trigger Test Alarm**
   - Temporarily lower alarm threshold (e.g., >0 errors)
   - Wait for alarm state change (1-2 evaluation periods)
   - Verify email notification received
   - Reset threshold to production value

3. **Verify Dashboard**
   - Open CloudWatch console
   - Navigate to Dashboards
   - Find `ImageService-{stage}` dashboard
   - Verify all widgets display (may show "No Data" until Epic 2)

### Expected State After Deployment

**Alarm States:**
- Most alarms: "Insufficient Data" (no metrics yet - normal)
- Some alarms: "OK" (metrics exist but within threshold)
- Zero alarms: "ALARM" (if any, investigate immediately)

**Dashboard State:**
- All widgets visible
- Most widgets: "No data available" (until Lambda handlers deployed)
- Some widgets: Data for infrastructure (DynamoDB, S3, CloudFront if used)

---

## Testing

### Testing Standards

**Source:** [docs/architecture/coding-standards.md#testing](../architecture/coding-standards.md#testing)

This story involves manual verification of monitoring infrastructure:

#### Deployment Verification Checklist

- [ ] **Pre-Deployment**
  - MonitoringStack TypeScript compiles without errors
  - All alarm configurations validated
  - SNS topic configuration correct

- [ ] **Post-Deployment**
  - SNS topic created successfully
  - All alarms created (verify count in console)
  - Dashboard created and accessible
  - SNS subscription pending confirmation

- [ ] **SNS Testing**
  - Email subscription confirmed
  - Test notification sent and received
  - Notification includes alarm details

- [ ] **Dashboard Verification**
  - Dashboard accessible via AWS Console
  - All widgets display correctly
  - Widget layout matches design
  - Time range selector works

- [ ] **Alarm Verification**
  - All alarms in "Insufficient Data" or "OK" state
  - Alarm actions configured (SNS topic)
  - Evaluation periods correct
  - Thresholds match requirements

#### Alarm Test Report

Create `monitoring-test-report-dev.md` with:
- SNS topic ARN
- List of all alarms created
- Dashboard URL
- Test alarm notification screenshot
- Verification that all ACs are met

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-16 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent after story completion_

---

**Epic Reference:** [Epic 1: Infrastructure Setup](../prd/epic-1-infrastructure-setup.md)
**PRD Reference:** [Image Service Migration - Monitoring](../prd/image-service-migration/09-monitoring.md)
**Previous Story:** [Story 1.3: Deploy Infrastructure to Dev Environment](./1.3.story.md)
**Next Story:** Epic 2, Story 2.1 (Lambda Implementation)
