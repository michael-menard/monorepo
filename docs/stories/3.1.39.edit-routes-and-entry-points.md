# Story 3.1.39: Edit Routes & Entry Points

## GitHub Issue
- Issue: #260
- URL: https://github.com/michael-menard/monorepo/issues/260
- Status: Todo

## Status

Draft

## Story

**As an** owner,
**I want** clear entry points to edit my MOC,
**so that** I can easily access the edit functionality from multiple places.

## Epic Context

This is **Story 2.1 of Epic 2: Edit UX & Frontend**.

## Blocked By

- All Epic 0 stories (3.1.28-3.1.32) - Package Extraction
- All Epic 1 stories (3.1.33-3.1.38) - Backend Edit Pipeline

**All backend stories must be complete before starting frontend work.**

## Acceptance Criteria

1. Route `/mocs/:slug/edit` displays edit page (TanStack Router)
2. Edit button visible on detail page only for owner (uses `isOwner` from API response)
3. Edit link in "My MOCs" list for each item
4. Direct URL access requires authentication (redirect to login if not)
5. Non-owner accessing edit URL sees access denied page (frontend checks `isOwner: false`)
6. Route validates slug format

**Note:** Backend `GET /mocs/:mocId` returns `isOwner: true/false` flag. Frontend must check this flag to determine edit access - backend does NOT return 403 for non-owners viewing published MOCs.

## Tasks / Subtasks

- [ ] **Task 1: Create Edit Route** (AC: 1)
  - [ ] Create `apps/web/main-app/src/routes/pages/InstructionsEditPage.tsx`
  - [ ] Create route definition for `/mocs/:slug/edit`
  - [ ] Add route validation with Zod for slug format

- [ ] **Task 2: Add Auth Guard** (AC: 4)
  - [ ] Create or extend route guard for authenticated routes
  - [ ] Redirect to login with `returnTo` query param
  - [ ] Store intended destination for post-login redirect

- [ ] **Task 3: Add Edit Button to Detail Page** (AC: 2)
  - [ ] Modify `InstructionsDetailPage.tsx`
  - [ ] Check if current user is owner (`moc.userId === currentUserId`)
  - [ ] Show "Edit" button only for owner
  - [ ] Position near title or in action bar

- [ ] **Task 4: Add Edit Link to My MOCs List** (AC: 3)
  - [ ] Modify MOC card component in dashboard/my-mocs
  - [ ] Add edit icon/button in card actions
  - [ ] Link to `/mocs/:slug/edit`

- [ ] **Task 5: Handle Non-Owner Access** (AC: 5)
  - [ ] After loading MOC, check `isOwner` flag from API response
  - [ ] If `isOwner: false`, redirect to detail page OR show access denied component
  - [ ] Display friendly message for non-owners
  - [ ] Provide link back to MOC detail page

- [ ] **Task 6: Route Validation** (AC: 6)
  - [ ] Validate slug matches `[a-z0-9-]+` pattern
  - [ ] Show 404 for invalid slug format

## Dev Notes

### Route Definition

```typescript
// apps/web/main-app/src/routes/pages/InstructionsEditPage.tsx
import { createFileRoute, redirect } from '@tanstack/react-router'
import { z } from 'zod'

const slugSchema = z.string().regex(/^[a-z0-9-]+$/)

export const Route = createFileRoute('/mocs/$slug/edit')({
  parseParams: params => ({
    slug: slugSchema.parse(params.slug),
  }),
  beforeLoad: async ({ context }) => {
    // Auth guard - edit requires authentication
    if (!context.auth.isAuthenticated) {
      throw redirect({
        to: '/login',
        search: { returnTo: window.location.pathname },
      })
    }
  },
  loader: async ({ params, context }) => {
    // Uses same GET /mocs/:mocId endpoint - returns isOwner flag
    // Owner gets presigned URLs for files, non-owner gets CDN URLs
    const moc = await context.api.getMoc(params.slug)

    // Frontend enforces edit access via isOwner flag
    if (!moc.isOwner) {
      throw redirect({
        to: '/mocs/$slug',
        params: { slug: params.slug },
        // Or throw custom error for AccessDenied component
      })
    }

    return moc
  },
  component: InstructionsEditPage,
  errorComponent: EditErrorBoundary,
})
```

### Edit Button on Detail Page

```typescript
// In InstructionsDetailPage.tsx
// Uses isOwner flag from API response (Story 3.1.33)
// No need to compare userIds - backend already determined ownership

function InstructionsDetailPage() {
  const { moc } = Route.useLoaderData()
  // isOwner comes directly from GET /mocs/:mocId response
  const { isOwner } = moc

  return (
    <div>
      <header className="flex items-center justify-between">
        <h1>{moc.title}</h1>
        {isOwner && (
          <Link to="/mocs/$slug/edit" params={{ slug: moc.slug }}>
            <Button variant="outline">
              <PencilIcon className="w-4 h-4 mr-2" />
              Edit
            </Button>
          </Link>
        )}
      </header>
      {/* ... rest of page */}
    </div>
  )
}
```

### My MOCs List Edit Action

```typescript
// In MocCard component
function MocCard({ moc }: { moc: MocListItem }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>{moc.title}</CardTitle>
      </CardHeader>
      <CardFooter className="flex justify-between">
        <Link to="/mocs/$slug" params={{ slug: moc.slug }}>
          View
        </Link>
        <Link to="/mocs/$slug/edit" params={{ slug: moc.slug }}>
          <PencilIcon className="w-4 h-4" />
          <span className="sr-only">Edit {moc.title}</span>
        </Link>
      </CardFooter>
    </Card>
  )
}
```

### Non-Owner Access Handling

The route loader redirects non-owners before the component renders. If you prefer to show an access denied component instead of redirecting:

```typescript
// Alternative: Throw custom error in loader instead of redirect
loader: async ({ params, context }) => {
  const moc = await context.api.getMoc(params.slug)
  if (!moc.isOwner) {
    throw new AccessDeniedError('You do not own this MOC')
  }
  return moc
},

// AccessDeniedComponent.tsx
function AccessDeniedComponent() {
  const { slug } = Route.useParams()

  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <h1 className="text-2xl font-bold">Access Denied</h1>
      <p className="text-muted-foreground mt-2">
        You don't have permission to edit this MOC.
      </p>
      <Link to="/mocs/$slug" params={{ slug }}>
        <Button>View MOC</Button>
      </Link>
    </div>
  )
}

// EditErrorBoundary.tsx
function EditErrorBoundary({ error }: { error: Error }) {
  if (error instanceof AccessDeniedError) {
    return <AccessDeniedComponent />
  }
  // Re-throw other errors for global error boundary
  throw error
}
```

**Note:** Backend returns 404 (not 403) for draft/archived MOCs when accessed by non-owners to prevent existence leak. The frontend should handle 404 errors with a standard "not found" message.

### Existing Components

- `apps/web/main-app/src/routes/pages/InstructionsDetailPage.tsx` - Detail page to modify
- `apps/web/main-app/src/routes/pages/InstructionsNewPage.tsx` - Reference for form patterns
- `apps/web/main-app/src/components/Layout/` - Layout components

## Testing

### Test Location
- `apps/web/main-app/src/routes/pages/__tests__/InstructionsEditPage.test.tsx`
- `apps/web/playwright/features/moc-edit/` (E2E)

### Test Requirements
- Unit: Route renders for authenticated owner
- Unit: Route redirects to login for unauthenticated
- Unit: Edit button visible only for owner
- Unit: 403 error component displays for non-owner
- E2E: Navigate to edit via detail page
- E2E: Navigate to edit via My MOCs list
- E2E: Direct URL access requires auth

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 0.1 | Initial draft from Edit MOC PRD | SM Agent |

## Dev Agent Record

### Agent Model Used

N/A

### Debug Log References

N/A

### Completion Notes

N/A

### File List

- `apps/web/main-app/src/routes/pages/InstructionsEditPage.tsx` - New
- `apps/web/main-app/src/routes/pages/InstructionsDetailPage.tsx` - Modified (add edit button)
- `apps/web/main-app/src/components/Dashboard/MocCard.tsx` - Modified (add edit link)
