# Story 6.1: Feature Flag Infrastructure Setup

## Status

Draft

## Story

**As a** DevOps Engineer,
**I want** to implement feature flag infrastructure for toggling between Express and Serverless backends,
**so that** we can safely roll out the serverless migration with instant rollback capability.

## Acceptance Criteria

### Functional Requirements

1. Environment variable `VITE_USE_SERVERLESS_API` controls backend selection (defaults to `false` = Express)
2. Frontend `apiClient` dynamically selects base URL based on feature flag
3. Feature flag can be toggled at runtime without code changes (via environment variable update)
4. Flag state is logged on application initialization for debugging

### Integration Requirements

5. Existing Express API calls continue to work when flag is `false` (default)
6. Feature flag works consistently across all environments (dev, staging, production)
7. No breaking changes to existing API client or RTK Query setup

### Quality Requirements

8. Feature flag logic covered by unit tests (both flag states tested)
9. Environment variable validation fails build if `VITE_USE_SERVERLESS_API` has invalid value
10. Documentation added to `README.md` explaining feature flag usage

**Integration Verification:**

- IV1: With flag disabled (`false`), all existing API calls work against Express backend
- IV2: With flag enabled (`true`), API client points to serverless endpoint (validated via health check)
- IV3: Feature flag can be toggled in production without frontend redeployment

## Tasks / Subtasks

- [ ] **Task 1: Create feature flag configuration module** (AC: 1, 4)
  - [ ] Create `src/config/featureFlags.ts` with `USE_SERVERLESS_API` constant
  - [ ] Add environment variable validation (must be 'true' or 'false', defaults to 'false')
  - [ ] Add logging on app initialization: "Feature Flag: USE_SERVERLESS_API = {value}"
  - [ ] Export `isServerlessEnabled()` helper function

- [ ] **Task 2: Update API client to respect feature flag** (AC: 2)
  - [ ] Modify `src/services/apiClient.ts` to check `isServerlessEnabled()`
  - [ ] If `false`, return Express base URL (current behavior)
  - [ ] If `true`, return serverless API Gateway URL from environment
  - [ ] Ensure auth headers and CORS settings work for both backends

- [ ] **Task 3: Add environment variable configuration** (AC: 3, 6)
  - [ ] Add `VITE_USE_SERVERLESS_API=false` to `.env` (local dev default)
  - [ ] Add `VITE_SERVERLESS_API_URL` for API Gateway URL (to be populated later)
  - [ ] Update `env.example` with new variables and documentation
  - [ ] Add validation in `src/config/env-loader.ts`

- [ ] **Task 4: Update Vite configuration for runtime flag changes** (AC: 3)
  - [ ] Ensure `import.meta.env.VITE_USE_SERVERLESS_API` reads from process env
  - [ ] Verify flag can change between builds without code modification
  - [ ] Document deployment process for toggling flag in production

- [ ] **Task 5: Add unit tests for feature flag logic** (AC: 8)
  - [ ] Test `apiClient` returns Express URL when flag is `false`
  - [ ] Test `apiClient` returns serverless URL when flag is `true`
  - [ ] Test invalid flag value throws validation error
  - [ ] Test flag defaults to `false` if not set

- [ ] **Task 6: Integration testing** (AC: IV1, IV2, IV3)
  - [ ] Start app with flag `false`, verify Express endpoints called
  - [ ] Start app with flag `true`, verify serverless health check succeeds
  - [ ] Document rollback procedure (flip flag to `false`, restart app)

- [ ] **Task 7: Documentation** (AC: 10)
  - [ ] Update `README.md` with "Feature Flags" section
  - [ ] Document how to toggle backend in each environment
  - [ ] Add troubleshooting guide for flag-related issues
  - [ ] Document rollback procedure for production

## Dev Notes

### Project Context

This story is **Story 6.1** from **Phase 1: Preparation & Infrastructure** of the Frontend Serverless Migration epic. This is the foundational story that enables all subsequent migration work by providing instant rollback capability.

**Project:** Frontend Serverless Migration
**Epic:** FRONTEND-SERVERLESS-MIGRATION (15 stories total)
**Project Brief:** `docs/brief-frontend-serverless-migration.md`
**Epic Overview:** `docs/stories/frontend-serverless-migration-epic.md`

### Previous Story Insights

**None** - This is the first story in the epic. No previous story context.

### Critical Risk Mitigation

This story directly addresses:

- **Risk 8.2 (No Rollback Plan):** Feature flag enables instant rollback without redeployment
- **Risk 6.1 (Missing Environment Variables):** Validation ensures required vars present

### Tech Stack for This Story

[Source: docs/architecture/tech-stack.md]

- **Frontend Framework:** React 19, TypeScript 5.8
- **Build Tool:** Vite 6 (environment variable handling)
- **State Management:** RTK Query (API client integration)
- **Environment Config:** Centralized in `src/config/` directory

### Existing Patterns to Follow

[Source: apps/web/lego-moc-instructions-app/src/config/environment.ts]

- Environment configuration uses `import.meta.env.VITE_*` variables
- Config validation happens in `env-loader.ts`
- API URLs managed in `api.ts` with environment-based selection

### Integration Points

**Files to Modify:**

1. `src/config/featureFlags.ts` - NEW FILE (feature flag logic)
2. `src/services/apiClient.ts` - MODIFY (add flag check)
3. `src/config/env-loader.ts` - MODIFY (add validation)
4. `.env` - MODIFY (add new variables)
5. `env.example` - MODIFY (document new variables)
6. `README.md` - MODIFY (add feature flag documentation)

**Dependencies:**

- No code dependencies on other stories
- Blocks Story 6.2 (environment configuration requires flag infrastructure)

### Testing Strategy

**Unit Tests:**

- `featureFlags.test.ts` - Test flag reading and validation
- `apiClient.test.ts` - Test URL selection based on flag

**Integration Tests:**

- Manual testing with flag toggled in local environment
- Verify health check endpoint accessible in both modes

**E2E Tests:**

- Not required for this story (E2E updates in Story 6.10)

### Definition of Done Checklist

- [ ] Feature flag module created with validation
- [ ] API client respects flag for URL selection
- [ ] Environment variables documented in `.env` and `env.example`
- [ ] Unit tests pass with 100% coverage for flag logic
- [ ] Integration verification completed (both flag states tested)
- [ ] Documentation updated in `README.md`
- [ ] Code reviewed and approved
- [ ] Merged to main branch

### Rollback Plan

**If this story causes issues:**

1. This story doesn't change default behavior (flag defaults to `false` = Express)
2. Revert the PR if any validation issues arise
3. No production impact since flag remains disabled

### Estimated Effort

**Story Points:** 3
**Time Estimate:** 4-6 hours
**Complexity:** Low-Medium

### Success Metrics

- Feature flag toggles backend without code changes: ✅
- Rollback time <5 minutes via environment variable change: ✅
- Zero regression in existing Express API calls: ✅

---

**Story Version:** 1.0
**Last Updated:** 2025-11-23
**Ready for Development:** Yes
