# Story 3.1.16: Form & Validation — Zod-First

## Status

Implemented

## Story

As a creator,
I want to import MOC data by pasting a URL and have the app auto-populate fields,
so I can quickly add MOCs without manual data entry.

As a creator,
I want clear form validation for all MOC/Set metadata fields,
so I can complete the form confidently with proper guidance.

## Acceptance Criteria

### 0) URL Import Feature

#### Supported Platforms

| Platform         | URL Pattern                                        | Data Available                                                     |
| ---------------- | -------------------------------------------------- | ------------------------------------------------------------------ |
| Rebrickable      | `rebrickable.com/mocs/MOC-{id}/*`                  | All fields (title, author, parts, theme, dimensions, images, etc.) |
| BrickLink Studio | `bricklink.com/v3/studio/design.page?idModel={id}` | Full metadata (see below)                                          |
| Rebrickable Sets | `rebrickable.com/sets/{number}/*`                  | Set info, parts, theme, images                                     |

#### BrickLink Studio Data Extraction

The BrickLink Studio page embeds model data in JavaScript (`blapp.models.set([...])`). Extract:

| BrickLink Field                        | Maps To                               | Notes                                    |
| -------------------------------------- | ------------------------------------- | ---------------------------------------- |
| `strModelName`                         | `title`                               | Model display name                       |
| `dmUserBuilder.strUsername`            | `author`, `designer.username`         | Designer username                        |
| `dmUserBuilder.strDisplayName`         | `designer.displayName`                | Designer display name                    |
| `dmUserBuilder.strAvatar`              | `designer.avatarUrl`                  | Avatar image URL                         |
| `dmUserBuilder.stats.nPublicCreations` | `designer.stats.publicCreationsCount` | Designer's total MOCs                    |
| `dmUserBuilder.stats.nPublicViews`     | `designer.stats.totalPublicViews`     | Designer's total views                   |
| `dmUserBuilder.stats.nPublicLikes`     | `designer.stats.totalPublicLikes`     | Designer's total likes                   |
| `dmUserBuilder.stats.nStaffPicked`     | `designer.stats.staffPickedCount`     | Designer's staff picks                   |
| `idModel`                              | `sourcePlatform.externalId`           | BrickLink model ID                       |
| `idModelCategory`                      | `platformCategoryId`                  | Category ID                              |
| `strDescriptionLegacy`                 | `description`                         | Model description                        |
| `strModelNameTags`                     | `tags`                                | Comma-separated tags (split & normalize) |
| `dmMainImage.url`                      | `thumbnailUrl`, gallery               | Main image URL                           |
| `dmMainThumb.url`                      | `thumbnailUrl`                        | Thumbnail URL                            |
| `nImageWidth`, `nImageHeight`          | image dimensions                      | For gallery images                       |
| `udtCreate`                            | `sourcePlatform.importedAt`           | Original creation date                   |
| `udtPublish`                           | `publishedAt`                         | Publish date                             |
| `nUploadedFrom`                        | `sourcePlatform.uploadSource`         | 1=web, 2=desktop, 3=mobile               |
| `idModelFrom`                          | `sourcePlatform.forkedFromId`         | If remix, source model ID                |
| `listEventBadges`                      | `eventBadges[]`                       | Competition badges array                 |
| `bStaffPicked`                         | (info only)                           | Staff picked status                      |
| `udtStaffPicked`                       | (info only)                           | Staff pick date                          |

**Note:** Set `sourcePlatform.platform = 'bricklink'` and `sourcePlatform.sourceUrl` to the original URL.

#### Import Flow

1. User pastes URL into "Import from URL" field
2. App validates URL format and shows supported platform icon
3. User clicks "Import" or presses Enter
4. Loading state shown with progress indicator
5. Backend fetches page, parses HTML, extracts data
6. Form fields auto-populate with extracted data
7. User can review/edit any field before saving
8. Images are displayed as previews (not yet uploaded)

#### Import API Endpoint

```
POST /api/mocs/import-from-url
Body: { url: string }
Response: {
  success: boolean
  data: Partial<MocInstruction>  // Includes all extracted fields
  images: Array<{ url: string, alt: string, width?: number, height?: number }>
  warnings: string[]  // e.g., "Could not extract dimensions"
  source: {
    platform: 'rebrickable' | 'bricklink' | 'brickowl'
    url: string
    externalId: string
  }
}
```

The `data` object may include BrickLink-specific fields when importing from BrickLink:

- `designer` with nested `stats` object
- `sourcePlatform` with platform tracking info
- `eventBadges[]` array if the model has competition badges
- `platformCategoryId` for BrickLink category

#### Import Behavior

- **Non-destructive**: Only populates empty fields, doesn't overwrite user edits
- **Preview mode**: Show imported data diff before applying
- **Partial success**: Import what's available, warn about missing fields
- **Rate limiting**: Max 10 imports per minute per user
- **Caching**: Cache parsed results for 1 hour (same URL = instant)

#### Error Handling

| Error                | User Message                                                       |
| -------------------- | ------------------------------------------------------------------ |
| Invalid URL format   | "Please enter a valid URL from Rebrickable or BrickLink"           |
| Unsupported platform | "URL not supported. We support Rebrickable and BrickLink URLs"     |
| Page not found       | "Could not find a MOC at this URL. Please check the link"          |
| Rate limited         | "Too many imports. Please wait a moment and try again"             |
| Parse error          | "Could not read all data from this page. Some fields may be empty" |

### 1) Zod Schemas (Required Fields)

#### Basic Information

| Field         | Validation                         | Notes                        |
| ------------- | ---------------------------------- | ---------------------------- |
| `title`       | Required, min 3, max 120 chars     | Display title of the MOC     |
| `description` | Required, min 10, max 2000 chars   | Plain text description       |
| `type`        | Required, enum: `'moc'` \| `'set'` | Discriminator for MOC vs Set |

#### MOC-Specific Fields (when type='moc')

| Field        | Validation                       | Notes                          |
| ------------ | -------------------------------- | ------------------------------ |
| `author`     | Required for MOCs, max 255 chars | Designer/creator name          |
| `setNumber`  | Required for MOCs, max 50 chars  | MOC ID (e.g., "MOC-243400")    |
| `partsCount` | Required for MOCs, min 1         | Total brick count              |
| `theme`      | Required for MOCs                | Primary theme (e.g., "Castle") |

#### Set-Specific Fields (when type='set')

| Field       | Validation                       | Notes                               |
| ----------- | -------------------------------- | ----------------------------------- |
| `brand`     | Required for Sets, max 255 chars | Brand name (e.g., "LEGO")           |
| `setNumber` | Required for Sets                | Official set number (e.g., "10294") |
| `theme`     | Required for Sets                | Primary theme category              |

### 2) Zod Schemas (Optional Fields)

#### Core Identification

| Field   | Validation                        | Notes                                     |
| ------- | --------------------------------- | ----------------------------------------- |
| `mocId` | Optional, max 50 chars            | External platform ID (e.g., "MOC-243400") |
| `slug`  | Optional, max 255 chars, URL-safe | URL-friendly identifier                   |

#### Categorization

| Field          | Validation                  | Notes                                   |
| -------------- | --------------------------- | --------------------------------------- |
| `themeId`      | Optional, integer           | Numeric theme ID from external platform |
| `subtheme`     | Optional, string            | Sub-theme (e.g., "Lion Knights")        |
| `tags`         | Optional, array of strings  | Normalize: trim, lowercase, dedupe      |
| `minifigCount` | Optional, integer >= 0      | Number of minifigures                   |
| `releaseYear`  | Optional, integer 1950-2027 | Year of release (Sets only)             |
| `retired`      | Optional, boolean           | Whether set is retired (Sets only)      |

#### Designer Information (JSONB)

| Field                                 | Validation                             | Notes                                      |
| ------------------------------------- | -------------------------------------- | ------------------------------------------ |
| `designer.username`                   | Required if designer provided, max 100 | Designer's username                        |
| `designer.displayName`                | Optional, max 255                      | Display name                               |
| `designer.profileUrl`                 | Optional, valid URL                    | Profile page URL                           |
| `designer.avatarUrl`                  | Optional, valid URL                    | Avatar image URL                           |
| `designer.socialLinks.instagram`      | Optional, valid URL                    | Instagram profile                          |
| `designer.socialLinks.twitter`        | Optional, valid URL                    | Twitter/X profile                          |
| `designer.socialLinks.youtube`        | Optional, valid URL                    | YouTube channel                            |
| `designer.socialLinks.website`        | Optional, valid URL                    | Personal website                           |
| `designer.stats.publicCreationsCount` | Optional, integer >= 0                 | Total public MOCs by designer (BrickLink)  |
| `designer.stats.totalPublicViews`     | Optional, integer >= 0                 | Total views across all MOCs (BrickLink)    |
| `designer.stats.totalPublicLikes`     | Optional, integer >= 0                 | Total likes across all MOCs (BrickLink)    |
| `designer.stats.staffPickedCount`     | Optional, integer >= 0                 | Number of staff-picked designs (BrickLink) |

#### Physical Dimensions (JSONB)

| Field                      | Validation                 | Notes                           |
| -------------------------- | -------------------------- | ------------------------------- |
| `dimensions.height.cm`     | Optional, positive number  | Height in centimeters           |
| `dimensions.height.inches` | Optional, positive number  | Height in inches                |
| `dimensions.width.cm`      | Optional, positive number  | Width in cm                     |
| `dimensions.width.inches`  | Optional, positive number  | Width in inches                 |
| `dimensions.width.openCm`  | Optional, positive number  | Width when open (foldable MOCs) |
| `dimensions.depth.cm`      | Optional, positive number  | Depth in cm                     |
| `dimensions.depth.inches`  | Optional, positive number  | Depth in inches                 |
| `dimensions.weight.kg`     | Optional, positive number  | Weight in kg                    |
| `dimensions.weight.lbs`    | Optional, positive number  | Weight in lbs                   |
| `dimensions.studsWidth`    | Optional, positive integer | Baseplate width in studs        |
| `dimensions.studsDepth`    | Optional, positive integer | Baseplate depth in studs        |

#### Instructions Metadata (JSONB)

| Field                                  | Validation                 | Notes                                                                 |
| -------------------------------------- | -------------------------- | --------------------------------------------------------------------- |
| `instructionsMetadata.instructionType` | Optional, enum             | `'pdf'` \| `'xml'` \| `'studio'` \| `'ldraw'` \| `'lxf'` \| `'other'` |
| `instructionsMetadata.hasInstructions` | Boolean, default false     | Auto-set to true when files uploaded                                  |
| `instructionsMetadata.pageCount`       | Optional, positive integer | PDF page count                                                        |
| `instructionsMetadata.fileSize`        | Optional, positive integer | File size in bytes                                                    |
| `instructionsMetadata.previewImages`   | Optional, array of URLs    | Preview image URLs                                                    |

#### Alternate Build Info (JSONB)

| Field                                  | Validation                 | Notes                                  |
| -------------------------------------- | -------------------------- | -------------------------------------- |
| `alternateBuild.isAlternateBuild`      | Boolean, default false     | Is this an alternate build?            |
| `alternateBuild.sourceSetNumbers`      | Array of strings           | Source set numbers (e.g., ["31168-1"]) |
| `alternateBuild.sourceSetNames`        | Array of strings           | Source set names                       |
| `alternateBuild.setsRequired`          | Optional, positive integer | How many copies needed                 |
| `alternateBuild.additionalPartsNeeded` | Integer >= 0, default 0    | Extra parts beyond source sets         |

#### Features List (JSONB Array)

| Field                    | Validation               | Notes                               |
| ------------------------ | ------------------------ | ----------------------------------- |
| `features[].title`       | Required, min 1, max 255 | Feature name (e.g., "Working Gate") |
| `features[].description` | Optional, max 1000       | Feature description                 |
| `features[].icon`        | Optional, max 50         | Icon identifier or emoji            |

#### Rich Description

| Field              | Validation              | Notes                      |
| ------------------ | ----------------------- | -------------------------- |
| `descriptionHtml`  | Optional, string        | HTML-formatted description |
| `shortDescription` | Optional, max 500 chars | Brief summary for previews |

#### Build Information

| Field               | Validation                | Notes                                                          |
| ------------------- | ------------------------- | -------------------------------------------------------------- |
| `difficulty`        | Optional, enum            | `'beginner'` \| `'intermediate'` \| `'advanced'` \| `'expert'` |
| `buildTimeHours`    | Optional, positive number | Estimated build time in hours                                  |
| `ageRecommendation` | Optional, max 20 chars    | Age range (e.g., "16+", "12+")                                 |

#### Status & Visibility

| Field        | Validation              | Notes                                                            |
| ------------ | ----------------------- | ---------------------------------------------------------------- |
| `status`     | Enum, default 'draft'   | `'draft'` \| `'published'` \| `'archived'` \| `'pending_review'` |
| `visibility` | Enum, default 'private' | `'public'` \| `'private'` \| `'unlisted'`                        |

#### Source Platform (JSONB) — BrickLink Import Tracking

| Field                         | Validation                 | Notes                                                                                         |
| ----------------------------- | -------------------------- | --------------------------------------------------------------------------------------------- |
| `sourcePlatform.platform`     | Required if provided, enum | `'rebrickable'` \| `'bricklink'` \| `'brickowl'` \| `'mecabricks'` \| `'studio'` \| `'other'` |
| `sourcePlatform.externalId`   | Optional, max 100 chars    | Original ID on source platform                                                                |
| `sourcePlatform.sourceUrl`    | Optional, valid URL        | Link to original listing                                                                      |
| `sourcePlatform.uploadSource` | Optional, enum             | `'web'` \| `'desktop_app'` \| `'mobile_app'` \| `'api'` \| `'unknown'`                        |
| `sourcePlatform.forkedFromId` | Optional, max 100 chars    | If remix/fork, original model ID                                                              |
| `sourcePlatform.importedAt`   | Optional, ISO datetime     | When MOC was imported                                                                         |

#### Event Badges (JSONB Array) — BrickLink Competitions

| Field                         | Validation              | Notes                                    |
| ----------------------------- | ----------------------- | ---------------------------------------- |
| `eventBadges[].eventId`       | Required, max 100 chars | Event identifier                         |
| `eventBadges[].eventName`     | Required, max 255 chars | Event name (e.g., "Summer Contest 2024") |
| `eventBadges[].badgeType`     | Optional, max 50 chars  | Badge type (e.g., "winner", "finalist")  |
| `eventBadges[].badgeImageUrl` | Optional, valid URL     | Badge image URL                          |
| `eventBadges[].awardedAt`     | Optional, ISO datetime  | When badge was awarded                   |

#### Moderation (JSONB) — BrickLink Moderation Status

| Field                      | Validation              | Notes                                                                 |
| -------------------------- | ----------------------- | --------------------------------------------------------------------- |
| `moderation.action`        | Enum, default 'none'    | `'none'` \| `'approved'` \| `'flagged'` \| `'removed'` \| `'pending'` |
| `moderation.moderatedAt`   | Optional, ISO datetime  | When moderation action was taken                                      |
| `moderation.reason`        | Optional, max 500 chars | Reason for moderation action                                          |
| `moderation.forcedPrivate` | Boolean, default false  | If forced private by moderation                                       |

#### Platform Category ID

| Field                | Validation        | Notes                                   |
| -------------------- | ----------------- | --------------------------------------- |
| `platformCategoryId` | Optional, integer | BrickLink category ID (idModelCategory) |

### 3) Form UX Requirements

#### Live Validation

- Inline errors appear on blur or after 500ms debounce while typing
- Error summary at top of form with links to each invalid field
- Disable "Finalize" button until:
  - All required fields are valid
  - At least one instruction PDF is uploaded
  - Type-specific required fields are present (author for MOCs, brand for Sets)

#### Progressive Disclosure

- Show basic fields first (title, description, type, theme)
- Expand advanced sections on demand:
  - "Designer Info" accordion
  - "Dimensions" accordion
  - "Alternate Build" accordion
  - "Build Details" accordion
- Pre-populate fields when data is available from external sources

### 4) A11y Requirements

- All inputs have associated `<label>` elements
- Inputs have `aria-describedby` linking to helper text
- Invalid inputs have `aria-invalid="true"`
- Error summary is announced via `aria-live="polite"`
- Error summary links set focus to corresponding field on click
- Form sections use proper heading hierarchy

### 5) Tests

#### Unit Tests

- Zod schema validation for each field type
- Discriminated union validation (MOC vs Set required fields)
- JSONB nested object validation
- Tag normalization (trim, lowercase, dedupe)

#### Integration Tests (RTL)

- Form renders all fields correctly
- Live validation shows/hides errors appropriately
- Finalize button disabled state based on validation
- Accordion expand/collapse for advanced sections
- Error summary navigation to fields
- Type switcher changes required fields

## Tasks / Subtasks

### URL Import Feature

- [ ] Create `POST /api/mocs/import-from-url` endpoint
- [ ] Implement Rebrickable MOC page parser (HTML scraping)
- [ ] Implement Rebrickable Set page parser
- [ ] Implement BrickLink Studio page parser
- [ ] Add URL validation and platform detection
- [ ] Implement rate limiting (10/min per user)
- [ ] Add Redis caching for parsed results (1hr TTL)
- [ ] Build "Import from URL" input component with platform icons
- [ ] Create import preview modal showing extracted data
- [ ] Handle partial imports with warning messages
- [ ] Write parser unit tests with sample HTML fixtures
- [ ] Write integration tests for import flow

### Form Validation

- [ ] Create form Zod schemas in `__types__/` directory
- [ ] Build form field components with validation states
- [ ] Implement error summary component with field linking
- [ ] Create accordion sections for progressive disclosure
- [ ] Add type switcher (MOC/Set) with conditional fields
- [ ] Implement tag input with normalization
- [ ] Add dimension input group with unit conversion
- [ ] Build feature list editor (add/remove/reorder)
- [ ] Implement designer info section
- [ ] Add alternate build section with set picker
- [ ] Connect form to finalize button disable logic
- [ ] Write unit tests for all schemas
- [ ] Write integration tests for form interactions

## Dev Notes

### URL Import Implementation

- Use `cheerio` for server-side HTML parsing (lightweight, no browser needed)
- Store HTML fixtures in `__fixtures__/` for parser unit tests
- Platform parsers should be modular: `parsers/rebrickable-moc.ts`, `parsers/bricklink-studio.ts`
- Consider using Rebrickable API if available (more reliable than scraping)
- Proxy external image URLs through our CDN to avoid CORS issues
- Log parse failures to identify selector changes on source sites

### BrickLink Studio Parsing

BrickLink embeds model data in JavaScript, not HTML. Parse the `<script>` tags:

```typescript
// parsers/bricklink-studio.ts
import * as cheerio from 'cheerio'

interface BrickLinkModel {
  idModel: number
  strModelName: string
  strDescriptionLegacy: string
  strModelNameTags: string
  idModelCategory: number
  nUploadedFrom: number
  idModelFrom: number | null
  udtCreate: string
  udtPublish: string
  dmUserBuilder: {
    strUsername: string
    strDisplayName: string
    strAvatar: string
    stats: {
      nPublicCreations: number
      nPublicViews: number
      nPublicLikes: number
      nStaffPicked: number
    }
  }
  dmMainImage: { url: string; n2ImageWidth: number; n2ImageHeight: number }
  dmMainThumb: { url: string }
  listEventBadges: Array<{ eventId: string; eventName: string; badgeType?: string }>
}

export function parseBrickLinkStudio(html: string, sourceUrl: string) {
  const $ = cheerio.load(html)

  // Find the script containing blapp.models.set([...])
  let modelData: BrickLinkModel | null = null
  $('script').each((_, el) => {
    const content = $(el).html() || ''
    const match = content.match(/blapp\.models\.set\(\s*\[([\s\S]*?)\]\s*\)/)
    if (match) {
      try {
        // Parse the JSON array - first element is the model
        const models = JSON.parse(`[${match[1]}]`)
        modelData = models[0]
      } catch (e) {
        // Log parse error
      }
    }
  })

  if (!modelData) {
    throw new Error('Could not find model data in BrickLink page')
  }

  // Map nUploadedFrom to uploadSource enum
  const uploadSourceMap: Record<number, string> = {
    1: 'web',
    2: 'desktop_app',
    3: 'mobile_app',
  }

  return {
    title: modelData.strModelName,
    description: modelData.strDescriptionLegacy,
    author: modelData.dmUserBuilder.strUsername,
    tags: modelData.strModelNameTags
      ?.split(',')
      .map(t => t.trim().toLowerCase())
      .filter(Boolean),
    thumbnailUrl: modelData.dmMainThumb?.url || modelData.dmMainImage?.url,
    platformCategoryId: modelData.idModelCategory,
    designer: {
      username: modelData.dmUserBuilder.strUsername,
      displayName: modelData.dmUserBuilder.strDisplayName,
      avatarUrl: modelData.dmUserBuilder.strAvatar,
      stats: {
        publicCreationsCount: modelData.dmUserBuilder.stats.nPublicCreations,
        totalPublicViews: modelData.dmUserBuilder.stats.nPublicViews,
        totalPublicLikes: modelData.dmUserBuilder.stats.nPublicLikes,
        staffPickedCount: modelData.dmUserBuilder.stats.nStaffPicked,
      },
    },
    sourcePlatform: {
      platform: 'bricklink' as const,
      externalId: String(modelData.idModel),
      sourceUrl,
      uploadSource: uploadSourceMap[modelData.nUploadedFrom] || 'unknown',
      forkedFromId: modelData.idModelFrom ? String(modelData.idModelFrom) : null,
      importedAt: new Date().toISOString(),
    },
    eventBadges:
      modelData.listEventBadges?.map(badge => ({
        eventId: badge.eventId,
        eventName: badge.eventName,
        badgeType: badge.badgeType || null,
      })) || [],
    // Images for gallery
    images: modelData.dmMainImage
      ? [
          {
            url: modelData.dmMainImage.url,
            width: modelData.dmMainImage.n2ImageWidth,
            height: modelData.dmMainImage.n2ImageHeight,
            alt: modelData.strModelName,
          },
        ]
      : [],
  }
}
```

### Form Implementation

- Normalize tags: `tags.map(t => t.trim().toLowerCase()).filter(Boolean).filter((v, i, a) => a.indexOf(v) === i)`
- Avoid barrel files - import schemas directly
- Use `react-hook-form` with `@hookform/resolvers/zod` for validation
- Consider `react-query` for external data fetching (theme lists, etc.)
- JSONB fields should use controlled nested form components

### URL Parsing Selectors (Rebrickable MOC)

```typescript
// Example selectors - may need updating if Rebrickable changes their HTML
const selectors = {
  title: 'h1',
  author: '.author-name a',
  partsCount: '.stats .parts-count',
  theme: '.breadcrumb a[href*="/themes/"]',
  description: '.description',
  dimensions: '.dimensions-table td',
  images: '.gallery img',
  // ... etc
}
```

## Related Files

- `apps/api/endpoints/moc-instructions/_shared/types.ts` - API Zod schemas
- `apps/api/core/database/schema/index.ts` - Database schema
- `apps/api/endpoints/moc-instructions/initialize-with-files/handler.ts` - Create endpoint

## Change Log

| Date       | Version | Description                                                                                                  | Author |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------ | ------ |
| 2025-12-06 | 0.1     | Initial draft (form validation)                                                                              | SM     |
| 2025-12-06 | 0.2     | Expanded with all new MOC fields from types.ts                                                               | Claude |
| 2025-12-06 | 0.3     | Added BrickLink-specific fields: designer.stats, sourcePlatform, eventBadges, moderation, platformCategoryId | Claude |
| 2025-12-06 | 0.4     | Added BrickLink URL import: field mapping table, API response updates, parser implementation example         | Claude |
| 2025-12-07 | 1.0     | Implemented: URL import API, form validation schemas, InstructionsNewPage with react-hook-form               | Claude |
