# Story 1.15: Auth State Sync

## Status

Complete

## Story

**As a** user,
**I want** my auth state to sync with Amplify on app load,
**so that** I stay logged in across page refreshes.

## Acceptance Criteria

1. ✅ AuthProvider component wraps application
2. ✅ Checks current auth state on mount
3. ✅ Syncs Amplify session to Redux authSlice
4. ✅ Handles token refresh automatically (via Hub listener)
5. ✅ Shows loading state while checking
6. ✅ Clears state on session expiry (via Hub listener)

## Tasks / Subtasks

- [x] **Task 1: Verify AuthProvider Exists** (AC: 1)
  - [x] Check services/auth/AuthProvider.tsx exists
  - [x] Review current implementation

- [x] **Task 2: Implement Auth Check** (AC: 2-3)
  - [x] Use getCurrentUser() from Amplify
  - [x] Use fetchAuthSession() to get tokens
  - [x] Dispatch setAuthenticated or setUnauthenticated

- [x] **Task 3: Token Refresh** (AC: 4)
  - [x] Amplify handles refresh automatically
  - [x] Listen for tokenRefresh Hub events
  - [x] Update Redux with new tokens

- [x] **Task 4: Loading State** (AC: 5)
  - [x] Set isLoading=true initially (authSlice default)
  - [x] Render loading UI until auth checked
  - [x] Set isLoading=false after check

- [x] **Task 5: Session Expiry** (AC: 6)
  - [x] Listen for signedOut Hub events
  - [x] Listen for tokenRefresh_failure Hub events
  - [x] Dispatch setUnauthenticated
  - [x] Clear Cognito token manager

## Dev Notes

### Existing Implementation

**File:** `apps/web/main-app/src/services/auth/AuthProvider.tsx`

### Amplify v6 Auth Check

```typescript
import { getCurrentUser, fetchAuthSession } from '@aws-amplify/auth'
import { Hub } from 'aws-amplify/utils'

function AuthProvider({ children }: { children: React.ReactNode }) {
  const dispatch = useAppDispatch()

  useEffect(() => {
    async function checkAuth() {
      dispatch(setLoading(true))
      try {
        const user = await getCurrentUser()
        const session = await fetchAuthSession()

        dispatch(setAuthenticated({
          user: {
            id: user.userId,
            email: user.signInDetails?.loginId || '',
            name: user.username,
          },
          tokens: {
            accessToken: session.tokens?.accessToken?.toString(),
            idToken: session.tokens?.idToken?.toString(),
          },
        }))
      } catch {
        dispatch(setUnauthenticated())
      }
    }

    checkAuth()
  }, [dispatch])

  // Listen for auth events
  useEffect(() => {
    const unsubscribe = Hub.listen('auth', ({ payload }) => {
      switch (payload.event) {
        case 'signedOut':
          dispatch(setUnauthenticated())
          break
        case 'tokenRefresh':
          // Refresh tokens in Redux
          break
      }
    })
    return unsubscribe
  }, [dispatch])

  return <>{children}</>
}
```

### App Integration

```typescript
// In App.tsx
<Provider store={store}>
  <AuthProvider>
    <RouterProvider router={router} />
  </AuthProvider>
</Provider>
```

### Testing

- Test auth check on mount
- Test authenticated state dispatch
- Test unauthenticated state dispatch
- Test Hub event listeners

## Change Log

| Date       | Version | Description                                      | Author    |
| ---------- | ------- | ------------------------------------------------ | --------- |
| 2025-11-28 | 0.1     | Initial draft                                    | SM Agent  |
| 2025-11-29 | 1.0     | Complete: Added Hub listeners for auth events    | Dev Agent |
