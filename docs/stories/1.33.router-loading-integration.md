# Story 1.33: Router Loading Integration

## Status

Approved

## Story

**As a** developer,
**I want** the spinner to integrate with TanStack Router pending state,
**so that** it accurately reflects navigation status.

## Acceptance Criteria

1. ⬜ Subscribe to router pending/loading state
2. ⬜ Handle route loading (data fetching)
3. ⬜ Handle component loading (lazy import)
4. ⬜ Distinguish between pending and complete states
5. ⬜ No flash for instant navigations

## Tasks / Subtasks

- [ ] **Task 1: Router State Subscription** (AC: 1)
  - [ ] Use useRouterState hook
  - [ ] Or subscribe via router.subscribe
  - [ ] Track isLoading, isTransitioning

- [ ] **Task 2: Data Loading** (AC: 2)
  - [ ] Route loader functions trigger loading
  - [ ] Spinner shows during beforeLoad
  - [ ] Spinner shows during loader()

- [ ] **Task 3: Lazy Loading** (AC: 3)
  - [ ] Component lazy loading triggers
  - [ ] Suspense fallback for component load
  - [ ] Progress bar for route load

- [ ] **Task 4: State Transitions** (AC: 4)
  - [ ] pending → loading → complete
  - [ ] Handle abort/cancel

- [ ] **Task 5: Debounce Flash** (AC: 5)
  - [ ] Don't show for < 300ms loads
  - [ ] See Story 1.34 for implementation

## Dev Notes

### TanStack Router States

```typescript
const routerState = useRouterState()

// Available state properties:
routerState.isLoading // Currently loading route
routerState.isTransitioning // Route transition in progress
routerState.pendingMatches // Routes being loaded
routerState.status // 'idle' | 'pending'
```

### Router Subscription Pattern

```typescript
import { useRouter } from '@tanstack/react-router'

function NavigationObserver() {
  const router = useRouter()

  useEffect(() => {
    const unsubscribe = router.subscribe('onBeforeLoad', event => {
      console.log('Navigation starting', event)
      dispatch(setNavigating(true))
    })

    const unsubComplete = router.subscribe('onLoad', event => {
      console.log('Navigation complete', event)
      dispatch(setNavigating(false))
    })

    return () => {
      unsubscribe()
      unsubComplete()
    }
  }, [router])

  return null
}
```

### Route Loader Example

```typescript
export const Route = createFileRoute('/gallery')({
  // This triggers loading state
  loader: async () => {
    const data = await fetchGalleryData()
    return { data }
  },
  pendingComponent: () => <Skeleton />, // Shows during load
  component: GalleryPage,
})
```

### Combined Loading Check

```typescript
function useIsNavigating() {
  const routerState = useRouterState()

  return routerState.isLoading || routerState.isTransitioning || routerState.status === 'pending'
}
```

### Suspense Integration

```typescript
// For lazy component loading
<Suspense fallback={<PageTransitionSpinner />}>
  <Outlet />
</Suspense>
```

### Testing

- Test loading state during route transition
- Test loading state during data fetch
- Test loading state during lazy load
- Test state clears on complete

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
