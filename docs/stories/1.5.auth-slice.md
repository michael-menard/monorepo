# Story 1.5: Auth Slice

## Status

Ready for Review

## Story

**As a** developer,
**I want** an authSlice managing user authentication state,
**so that** components can access auth status and user info.

## Acceptance Criteria

1. ✅ authSlice created with createSlice
2. ✅ State includes: isAuthenticated, isLoading, user, tokens, error
3. ✅ Actions: setAuthenticated, setUnauthenticated, setLoading, updateUser, setError
4. ✅ Selectors: selectIsAuthenticated, selectUser, selectAuthLoading, selectAuthError
5. ✅ User type defined with id, email, name, avatar, roles
6. ✅ Tokens include accessToken, idToken, refreshToken
7. ✅ Integration with Amplify auth (via AuthProvider)

## Tasks / Subtasks

- [x] **Task 1: Verify Slice Structure** (AC: 1-5)
  - [x] Confirm authSlice exists at store/slices/authSlice.ts
  - [x] Check state shape matches requirements
  - [x] Verify all actions are exported
  - [x] Verify all selectors are exported
  - [x] Check User type definition

- [x] **Task 2: Verify Token Handling** (AC: 6)
  - [x] Confirm tokens state includes all three token types
  - [x] Verify updateTokens action works correctly (tested)

- [x] **Task 3: Verify Amplify Integration** (AC: 7)
  - [x] AuthProvider syncs Amplify state to authSlice
  - [x] Token refresh dispatches updateTokens action
  - [x] Sign in/out properly update slice state

## Dev Notes

### Existing Implementation ✅

**File:** `apps/web/main-app/src/store/slices/authSlice.ts`

Already implements:

- User interface with id, email, name, avatar, roles, preferences
- AuthState with isAuthenticated, isLoading, user, tokens, error
- All required actions
- All required selectors

### State Shape

```typescript
interface AuthState {
  isAuthenticated: boolean
  isLoading: boolean
  user: User | null
  tokens: {
    accessToken?: string
    idToken?: string
    refreshToken?: string
  } | null
  error: string | null
}
```

### Actions

- setLoading(boolean)
- setAuthenticated({ user, tokens })
- setUnauthenticated()
- updateUser(Partial<User>)
- updateTokens(tokens)
- setError(string)
- clearError()

### Selectors

- selectAuth
- selectIsAuthenticated
- selectUser
- selectAuthLoading
- selectAuthError

### Testing

- Unit test each action
- Test selectors return correct state
- Test initial state is correct

## Verification Summary

### authSlice Implementation (src/store/slices/authSlice.ts)

**State Shape:**

```typescript
interface AuthState {
  isAuthenticated: boolean
  isLoading: boolean
  user: User | null
  tokens: {
    accessToken?: string
    idToken?: string
    refreshToken?: string
  } | null
  error: string | null
}
```

**User Interface:**

```typescript
interface User {
  id: string
  email: string
  name?: string
  avatar?: string
  roles?: string[]
  preferences?: {
    theme?: 'light' | 'dark' | 'system'
    language?: string
    notifications?: boolean
  }
}
```

**Actions:**

- `setLoading(boolean)` - Set loading state
- `setAuthenticated({ user, tokens })` - Set authenticated with user data
- `setUnauthenticated()` - Clear auth state
- `updateUser(Partial<User>)` - Partial user update
- `updateTokens(tokens)` - Update token state
- `setError(string)` - Set error message
- `clearError()` - Clear error

**Selectors:**

- `selectAuth` - Full auth state
- `selectIsAuthenticated` - Boolean auth status
- `selectUser` - User object or null
- `selectAuthLoading` - Loading state
- `selectAuthError` - Error message or null

### Amplify Integration (src/services/auth/AuthProvider.tsx)

The AuthProvider fully integrates with authSlice:

- Initializes auth state from Cognito on mount
- Dispatches `setAuthenticated`/`setUnauthenticated` based on session
- Uses `updateTokens` action for token refresh
- Handles multi-step authentication (MFA, challenges)
- Integrates with `@repo/api-client` token manager

### Test Results

All 9 unit tests pass:

- Initial state verification
- setLoading action
- setAuthenticated action
- setUnauthenticated action
- updateUser action (with and without existing user)
- updateTokens action
- Error handling (setError, clearError)

## Change Log

| Date       | Version | Description                                      | Author   |
| ---------- | ------- | ------------------------------------------------ | -------- |
| 2025-11-28 | 0.1     | Initial draft - verified existing implementation | SM Agent |
| 2025-11-28 | 0.2     | Verification complete - all tests pass           | Claude   |
