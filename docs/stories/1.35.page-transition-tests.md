# Story 1.35: Page Transition Tests

## Status

Approved

## Story

**As a** developer,
**I want** tests for page transition functionality,
**so that** loading states work correctly.

## Acceptance Criteria

1. ⬜ Tests for PageTransitionSpinner component
2. ⬜ Tests for useDelayedShow hook
3. ⬜ Tests for navigation state tracking
4. ⬜ Tests for router integration
5. ⬜ Integration tests for full transition flow

## Tasks / Subtasks

- [ ] **Task 1: Spinner Component Tests** (AC: 1)
  - [ ] Test renders when isNavigating true
  - [ ] Test hidden when isNavigating false
  - [ ] Test animation classes applied

- [ ] **Task 2: Delayed Show Hook Tests** (AC: 2)
  - [ ] Test doesn't show before delay
  - [ ] Test shows after delay
  - [ ] Test hides when condition becomes false
  - [ ] Test cleans up timeout

- [ ] **Task 3: Navigation State Tests** (AC: 3)
  - [ ] Test setNavigating action
  - [ ] Test selectIsNavigating selector
  - [ ] Test state updates correctly

- [ ] **Task 4: Router Integration Tests** (AC: 4)
  - [ ] Test router state subscription
  - [ ] Test loading state detection
  - [ ] Mock router for tests

- [ ] **Task 5: E2E Tests** (AC: 5)
  - [ ] Test spinner appears during navigation
  - [ ] Test spinner disappears after load
  - [ ] Test delay threshold works

## Dev Notes

### Test File Locations

- `components/__tests__/PageTransitionSpinner.test.tsx`
- `hooks/__tests__/useDelayedShow.test.ts`
- `store/slices/__tests__/globalUISlice.test.ts`

### Spinner Component Test

```typescript
import { render, screen } from '@testing-library/react'
import { PageTransitionSpinner } from '../PageTransitionSpinner'

// Mock useRouterState
vi.mock('@tanstack/react-router', () => ({
  useRouterState: vi.fn(),
}))

describe('PageTransitionSpinner', () => {
  it('renders when navigating', () => {
    vi.mocked(useRouterState).mockReturnValue({ isLoading: true })

    render(<PageTransitionSpinner />)
    expect(screen.getByRole('progressbar')).toBeInTheDocument()
  })

  it('hidden when not navigating', () => {
    vi.mocked(useRouterState).mockReturnValue({ isLoading: false })

    render(<PageTransitionSpinner />)
    expect(screen.queryByRole('progressbar')).not.toBeInTheDocument()
  })
})
```

### Delayed Show Hook Test

```typescript
import { renderHook, act } from '@testing-library/react'
import { useDelayedShow } from '../useDelayedShow'

describe('useDelayedShow', () => {
  beforeEach(() => {
    vi.useFakeTimers()
  })

  afterEach(() => {
    vi.useRealTimers()
  })

  it('shows after delay', () => {
    const { result } = renderHook(() => useDelayedShow(true, 300))

    expect(result.current).toBe(false)

    act(() => {
      vi.advanceTimersByTime(300)
    })

    expect(result.current).toBe(true)
  })

  it('does not show if condition clears before delay', () => {
    const { result, rerender } = renderHook(({ active }) => useDelayedShow(active, 300), {
      initialProps: { active: true },
    })

    act(() => {
      vi.advanceTimersByTime(200)
    })

    rerender({ active: false })

    act(() => {
      vi.advanceTimersByTime(200)
    })

    expect(result.current).toBe(false)
  })
})
```

### Integration Test

```typescript
describe('Page Transition Flow', () => {
  it('shows spinner during slow navigation', async () => {
    render(<App />, { wrapper: TestProviders })

    // Trigger navigation to slow route
    fireEvent.click(screen.getByText('Heavy Page'))

    // Wait for delay threshold
    await waitFor(() => {
      expect(screen.getByRole('progressbar')).toBeVisible()
    }, { timeout: 400 })

    // Wait for navigation complete
    await waitFor(() => {
      expect(screen.queryByRole('progressbar')).not.toBeInTheDocument()
    })
  })
})
```

### Testing

Meta: This story is about testing!

- Run all transition-related tests
- Verify coverage
- All tests pass

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
