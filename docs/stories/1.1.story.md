# Story 1.1: SST Project Initialization & TypeScript Configuration

## Status

**Draft**

---

## Story

**As a** DevOps Engineer,
**I want** to create the foundational SST project structure with TypeScript configuration,
**so that** the Image Service has a proper serverless infrastructure foundation ready for development.

---

## Acceptance Criteria

1. SST project created in `apps/api/image-service/`
2. `package.json` configured with required dependencies (sst, aws-cdk-lib, constructs)
3. `tsconfig.json` configured for TypeScript compilation
4. `sst.config.ts` scaffolded
5. Git repository initialized with initial commit
6. Project builds successfully (`pnpm build` completes)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Project Directory Structure** (AC: 1)
  - [ ] Navigate to `apps/api/` directory
  - [ ] Create `image-service/` directory
  - [ ] Verify directory created successfully with `ls -la`

- [ ] **Task 2: Initialize pnpm Workspace** (AC: 2)
  - [ ] Run `pnpm init` in `apps/api/image-service/`
  - [ ] Update root `pnpm-workspace.yaml` to include `apps/api/image-service`
  - [ ] Verify workspace configuration

- [ ] **Task 3: Install SST and Core Dependencies** (AC: 2)
  - [ ] Install SST v3: `pnpm add sst`
  - [ ] Install AWS CDK: `pnpm add aws-cdk-lib constructs`
  - [ ] Install TypeScript dev dependencies: `pnpm add -D @types/node typescript @types/aws-lambda`
  - [ ] Verify all dependencies listed in `package.json`

- [ ] **Task 4: Configure TypeScript** (AC: 3)
  - [ ] Create `tsconfig.json` with strict mode enabled
  - [ ] Configure compiler options:
    - `strict: true`
    - `target: "ES2022"`
    - `module: "ESNext"`
    - `moduleResolution: "bundler"`
    - `esModuleInterop: true`
    - `skipLibCheck: true`
    - `forceConsistentCasingInFileNames: true`
  - [ ] Set `include` and `exclude` paths
  - [ ] Add path aliases for `@/` pointing to `src/`

- [ ] **Task 5: Scaffold SST Configuration** (AC: 4)
  - [ ] Create `sst.config.ts` in project root
  - [ ] Import SST v3 types
  - [ ] Define basic configuration structure:
    - App name: "image-service"
    - Region from environment variable
    - Stage support (dev, staging, production)
  - [ ] Add placeholder comment for future stack imports
  - [ ] Ensure TypeScript compilation succeeds

- [ ] **Task 6: Configure Build Scripts** (AC: 6)
  - [ ] Add `build` script to `package.json`: `"tsc --noEmit"`
  - [ ] Add `dev` script: `"sst dev"`
  - [ ] Add `deploy` script: `"sst deploy"`
  - [ ] Test build script runs successfully

- [ ] **Task 7: Initialize Git Repository** (AC: 5)
  - [ ] Run `git init` if not already a git repo
  - [ ] Create `.gitignore` with:
    - `node_modules/`
    - `.sst/`
    - `dist/`
    - `.env`
    - `*.log`
  - [ ] Stage all files: `git add .`
  - [ ] Create initial commit: `git commit -m "chore: initialize image-service SST project"`

- [ ] **Task 8: Verify Project Setup** (AC: 6)
  - [ ] Run `pnpm build` and verify no TypeScript errors
  - [ ] Verify `sst.config.ts` is valid (TypeScript compiles)
  - [ ] Check all acceptance criteria are met
  - [ ] Document any issues or deviations

---

## Dev Notes

### Architecture Context

This story creates the foundational infrastructure for the **Image Service Migration** project, which extracts image upload functionality from the monolithic LEGO API into a standalone, dedicated service.

**Source:** [docs/prd/image-service-migration/00-overview.md](../prd/image-service-migration/00-overview.md)

### Technology Stack

**Source:** [docs/architecture/tech-stack.md](../architecture/tech-stack.md)

#### Language & Build Tools
- **TypeScript 5.8** - All source code must be TypeScript with strict mode enabled
- **pnpm 9** - Fast, disk-efficient package manager with workspace support
- **Node.js 20.x** - LTS version with ES Modules support

#### Serverless Framework
- **SST v3 (Ion)** - Modern serverless framework
  - AWS CDK under the hood
  - Local development environment
  - Type-safe infrastructure as code
  - Live Lambda debugging

#### Key Dependencies
- `sst` - SST v3 framework
- `aws-cdk-lib` - AWS CDK library for infrastructure definitions
- `constructs` - AWS CDK constructs
- `@types/node` - Node.js type definitions
- `typescript` - TypeScript compiler
- `@types/aws-lambda` - Lambda type definitions

### Project Structure

**Source:** [docs/architecture/source-tree.md](../architecture/source-tree.md)

The project should be created at: `apps/api/image-service/`

**Monorepo Workspace Configuration:**
The root `pnpm-workspace.yaml` needs to be updated to include the new service:

```yaml
packages:
  - 'apps/*'
  - 'apps/api/*'  # This pattern should already include image-service
  - 'packages/core/*'
  - 'packages/features/*'
  - 'packages/tools/*'
```

**Initial Directory Structure:**
```
apps/api/image-service/
├── sst.config.ts          # SST infrastructure configuration
├── package.json           # Package dependencies and scripts
├── tsconfig.json          # TypeScript configuration
└── .gitignore            # Git ignore patterns
```

### TypeScript Configuration Standards

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md)

#### Strict Mode Requirements
All TypeScript must use strict mode with the following compiler options:

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

**CRITICAL RULES:**
- ❌ Never use `any` type
- ❌ Never create JavaScript files (only TypeScript)
- ✅ All source files must be `.ts` or `.tsx`
- ✅ Use Zod schemas for all data validation

### SST Configuration

**Source:** [docs/prd/image-service-migration/04-infrastructure.md](../prd/image-service-migration/04-infrastructure.md)

The `sst.config.ts` should follow SST v3 structure:

```typescript
/// <reference path="./.sst/platform/config.d.ts" />

export default $config({
  app(input) {
    return {
      name: "image-service",
      removal: input?.stage === "production" ? "retain" : "remove",
      home: "aws",
    };
  },
  async run() {
    // Future: Import and instantiate ImageServiceStack
  },
});
```

### Git Workflow

**Source:** [docs/architecture/coding-standards.md#git-workflow](../architecture/coding-standards.md#git-workflow)

**Commit Message Format:**
Use conventional commits: `type(scope): message`

For this story, the initial commit should be:
```
chore: initialize image-service SST project

- Create SST v3 project structure
- Configure TypeScript with strict mode
- Set up pnpm workspace
- Add build and deployment scripts
```

### Environment Configuration

**Source:** [docs/architecture/source-tree.md#environment-configuration](../architecture/source-tree.md#environment-configuration)

Environment variables will be needed later, but for initialization:
- AWS region should default to `us-east-1`
- AWS profile should use existing `lego-moc` profile
- Stage will be passed via CLI (`--stage dev`)

### File Naming Conventions

**Source:** [docs/architecture/coding-standards.md#file-naming](../architecture/coding-standards.md#file-naming)

- **Configuration files**: `kebab-case` (e.g., `sst.config.ts`, `tsconfig.json`)
- **Source files**: `kebab-case.ts` for utilities, `PascalCase.tsx` for components
- **TypeScript**: All files must use `.ts` extension (not `.js`)

### Package Manager

**Source:** [docs/architecture/tech-stack.md#package-management](../architecture/tech-stack.md#package-management)

**CRITICAL:** Use `pnpm` exclusively for package management.

Commands:
```bash
# Install dependencies
pnpm add <package>

# Install dev dependencies
pnpm add -D <package>

# Install from project root
pnpm --filter image-service add <package>
```

### Development Ports

**Source:** [docs/architecture/tech-stack.md#development-ports](../architecture/tech-stack.md#development-ports)

Image Service will not use a fixed port (it's serverless), but these ports are reserved:
- **Frontend**: 3002
- **LEGO Projects API**: 9000
- **PostgreSQL**: 5432
- **Redis**: 6379
- **Elasticsearch**: 9200

---

## Testing

### Testing Standards

**Source:** [docs/architecture/coding-standards.md#testing](../architecture/coding-standards.md#testing)

#### Test Framework
- **Vitest** - Fast unit test framework
- Located in `src/**/*.test.ts` files

#### Test Requirements for This Story
Since this is project initialization, testing will be manual verification:

1. **Build Verification**
   - Run `pnpm build` (which executes `tsc --noEmit`)
   - Verify zero TypeScript compilation errors
   - Verify all imports resolve correctly

2. **Configuration Validation**
   - Verify `tsconfig.json` is valid JSON
   - Verify `package.json` has correct `packageManager` field
   - Verify `sst.config.ts` compiles without errors

3. **Workspace Integration**
   - From monorepo root, run `pnpm install`
   - Verify `image-service` is recognized as a workspace
   - Run `pnpm --filter image-service build` from root

4. **Git Verification**
   - Verify `.gitignore` excludes `node_modules/`, `.sst/`, `dist/`
   - Verify initial commit includes all necessary files
   - Verify no sensitive files are tracked

#### Manual Test Checklist
- [ ] `pnpm build` completes successfully
- [ ] `tsconfig.json` validates (no errors)
- [ ] `sst.config.ts` compiles without TypeScript errors
- [ ] Git repository initialized with proper `.gitignore`
- [ ] All acceptance criteria verified

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-16 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent after story completion_

---

**Epic Reference:** [Epic 1: Infrastructure Setup](../prd/epic-1-infrastructure-setup.md)
**PRD Reference:** [Image Service Migration](../prd/image-service-migration/00-overview.md)
