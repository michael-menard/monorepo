# Story 1.31: Navigation Loading State

## Status

Ready for Review

## Story

**As a** developer,
**I want** to track navigation pending state globally,
**so that** I can show loading indicators during route transitions.

## Acceptance Criteria

1. ⬜ Add isNavigating flag to global UI state
2. ⬜ Set true when navigation starts
3. ⬜ Set false when navigation completes
4. ⬜ Selector for isNavigating available
5. ⬜ Works with TanStack Router pending state

## Tasks / Subtasks

- [x] **Task 1: Update Global UI Slice** (AC: 1, 4)
  - [x] Add isNavigating to state
  - [x] Create setNavigating action
  - [x] Create selectIsNavigating selector

- [x] **Task 2: Router Integration** (AC: 2-3, 5)
  - [x] Use router.subscribe() for state changes
  - [x] Or use useRouterState().isLoading
  - [x] Dispatch setNavigating(true) on start
  - [x] Dispatch setNavigating(false) on complete

## Dev Notes

### Global UI Slice Update

**File:** `apps/web/main-app/src/store/slices/globalUISlice.ts`

```typescript
interface GlobalUIState {
  sidebar: {
    isOpen: boolean
    isCollapsed: boolean
  }
  loading: {
    isNavigating: boolean
    isPageLoading: boolean
  }
}

const initialState: GlobalUIState = {
  sidebar: {
    isOpen: false,
    isCollapsed: false,
  },
  loading: {
    isNavigating: false,
    isPageLoading: false,
  },
}

export const globalUISlice = createSlice({
  name: 'globalUI',
  initialState,
  reducers: {
    setNavigating: (state, action: PayloadAction<boolean>) => {
      state.loading.isNavigating = action.payload
    },
    // ... other actions
  },
})

export const selectIsNavigating = (state: RootState) => state.globalUI.loading.isNavigating
```

### Router State Integration

```typescript
// Hook to sync router state with Redux
export function useNavigationSync() {
  const dispatch = useAppDispatch()
  const routerState = useRouterState()

  useEffect(() => {
    dispatch(setNavigating(routerState.isLoading))
  }, [routerState.isLoading, dispatch])
}
```

### TanStack Router Pending State

TanStack Router has built-in pending state:

```typescript
const routerState = useRouterState()
// routerState.isLoading - true during navigation
// routerState.isTransitioning - true during transitions
```

### Alternative: Direct Router State

Instead of Redux, could use router state directly:

```typescript
function NavigationIndicator() {
  const isNavigating = useRouterState({
    select: (state) => state.isLoading,
  })

  return isNavigating ? <Spinner /> : null
}
```

### Testing

- Test isNavigating updates on navigation start
- Test isNavigating clears on navigation complete
- Test selector returns correct value

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### File List

| File | Action | Description |
|------|--------|-------------|
| `apps/web/main-app/src/hooks/useNavigationSync.ts` | Created | Hook to sync TanStack Router isLoading state with Redux |
| `apps/web/main-app/src/hooks/__tests__/useNavigationSync.test.tsx` | Created | Unit tests for useNavigationSync hook |
| `apps/web/main-app/src/App.tsx` | Modified | Added useNavigationSync hook to InnerApp component |
| `apps/web/main-app/src/store/slices/globalUISlice.ts` | Pre-existing | Already had isNavigating state, setNavigating action, selectIsNavigating selector |

### Debug Log References

None - implementation completed without issues.

### Completion Notes

- **Task 1**: The globalUISlice already contained all required state (`isNavigating`), action (`setNavigating`), and selector (`selectIsNavigating`) from a previous story. No changes needed.
- **Task 2**: Created `useNavigationSync` hook that uses TanStack Router's `useRouterState` with a selector to extract `isLoading`, then dispatches `setNavigating` action on changes. Hook is called in `InnerApp` component inside `RouterProvider`.
- All 34 tests pass (28 for globalUISlice, 6 for useNavigationSync)
- Lint passes with no errors
- Pre-existing type errors in codebase not related to this story

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
| 2025-11-30 | 1.0     | Implementation complete | Dev Agent (James) |
