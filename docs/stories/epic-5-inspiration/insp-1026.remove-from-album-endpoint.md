# Story insp-1026: Remove from Album Endpoint

## Status

Draft

## Story

**As a** user,
**I want** to remove an inspiration from an album,
**so that** I can reorganize my collections.

## Acceptance Criteria

1. DELETE /api/albums/:albumId/inspirations/:inspirationId removes relationship
2. Inspiration remains in gallery (possibly orphaned)
3. Inspiration may still be in other albums
4. Returns 204 on success
5. Returns 404 if album or inspiration not found
6. Returns 403 if user doesn't own both
7. Idempotent: returns 204 if not in album

## Tasks / Subtasks

- [ ] **Task 1: Create Endpoint** (AC: 1, 5, 6)
  - [ ] Create DELETE /api/albums/:albumId/inspirations/:inspirationId
  - [ ] Add authentication middleware
  - [ ] Validate user owns both

- [ ] **Task 2: Remove Relationship** (AC: 2, 3, 4, 7)
  - [ ] Delete from inspiration_albums junction table
  - [ ] Return 204 (idempotent)

- [ ] **Task 3: Update Album Metadata**
  - [ ] Update album.updatedAt timestamp
  - [ ] Clear coverImageId if removed image was cover

- [ ] **Task 4: Add to Serverless Config**
  - [ ] Add Lambda function definition
  - [ ] Configure API Gateway route

## Dev Notes

### Endpoint Location
`apps/api/endpoints/albums/remove-inspiration/handler.ts`

### Implementation

```typescript
await db.transaction(async (tx) => {
  // Verify ownership
  const album = await tx.query.albums.findFirst({
    where: and(eq(albums.id, albumId), eq(albums.userId, userId)),
  })
  const inspiration = await tx.query.inspirations.findFirst({
    where: and(eq(inspirations.id, inspirationId), eq(inspirations.userId, userId)),
  })

  if (!album || !inspiration) {
    throw new NotFoundError()
  }

  // Delete relationship (idempotent)
  await tx.delete(inspirationAlbums)
    .where(and(
      eq(inspirationAlbums.albumId, albumId),
      eq(inspirationAlbums.inspirationId, inspirationId)
    ))

  // Update album timestamp
  await tx.update(albums)
    .set({ updatedAt: new Date() })
    .where(eq(albums.id, albumId))

  // Clear cover if removed
  if (album.coverImageId === inspirationId) {
    await tx.update(albums)
      .set({ coverImageId: null })
      .where(eq(albums.id, albumId))
  }
})

return new Response(null, { status: 204 })
```

### Orphan Behavior
Per PRD: "Orphans: Inspirations not in any album remain visible in the root gallery"

When removed from the last album, the inspiration becomes orphaned and appears at the root gallery level.

## Testing

- [ ] Removes inspiration from album
- [ ] Inspiration still exists in gallery
- [ ] Returns 204 on success
- [ ] Returns 204 if not in album (idempotent)
- [ ] Returns 404 if album doesn't exist
- [ ] Returns 404 if inspiration doesn't exist
- [ ] Returns 403 if user doesn't own album
- [ ] Clears coverImageId if applicable

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
