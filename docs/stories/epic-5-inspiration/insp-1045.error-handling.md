# Story insp-1045: Error Handling (toasts, retry)

## Status

Draft

## Story

**As a** user,
**I want** clear error feedback with retry options,
**so that** I can recover from failures gracefully.

## Acceptance Criteria

1. Save failure shows toast with retry action
2. Delete failure shows toast with retry
3. Network errors show appropriate message
4. API errors show user-friendly message
5. Retry actions actually retry the operation
6. Error states don't block other actions

## Tasks / Subtasks

- [ ] **Task 1: Configure Toast System** (AC: 1, 2)
  - [ ] Set up toast provider (Sonner or similar)
  - [ ] Configure positioning and duration
  - [ ] Add action button support

- [ ] **Task 2: Handle Save Errors** (AC: 1, 5)
  - [ ] Catch mutation errors
  - [ ] Show toast with "Retry" action
  - [ ] Retry on action click

- [ ] **Task 3: Handle Delete Errors** (AC: 2, 5)
  - [ ] Catch delete mutation errors
  - [ ] Show toast with "Retry" action
  - [ ] Keep modal open on failure

- [ ] **Task 4: Handle Network Errors** (AC: 3)
  - [ ] Detect network failures
  - [ ] Show "Check your connection" message
  - [ ] Auto-retry on reconnection (optional)

- [ ] **Task 5: Format API Errors** (AC: 4, 6)
  - [ ] Map error codes to messages
  - [ ] Don't expose technical details
  - [ ] Allow dismissing errors

## Dev Notes

### PRD Reference
From PRD Loading & Error States:
> "Save failure: Toast: 'Couldn't save changes. Retry?' with retry action"
> "Delete failure: Toast: 'Couldn't delete. Please try again.'"

### Toast with Retry Action

```tsx
import { toast } from 'sonner'

async function handleSave(data: UpdateData) {
  try {
    await updateMutation(data).unwrap()
    toast.success('Changes saved')
  } catch (error) {
    toast.error("Couldn't save changes", {
      action: {
        label: 'Retry',
        onClick: () => handleSave(data),
      },
    })
  }
}

async function handleDelete(id: string) {
  try {
    await deleteMutation(id).unwrap()
    toast.success('Deleted')
    navigate({ to: '/inspiration' })
  } catch (error) {
    toast.error("Couldn't delete. Please try again.", {
      action: {
        label: 'Retry',
        onClick: () => handleDelete(id),
      },
    })
    // Keep modal open - don't close
  }
}
```

### Error Message Mapping

```typescript
function getErrorMessage(error: unknown): string {
  if (error instanceof FetchBaseQueryError) {
    if (error.status === 'FETCH_ERROR') {
      return 'Check your internet connection and try again.'
    }
    if (typeof error.status === 'number') {
      switch (error.status) {
        case 400:
          return 'Invalid data. Please check your input.'
        case 403:
          return "You don't have permission to do this."
        case 404:
          return 'This item no longer exists.'
        case 429:
          return 'Too many requests. Please wait a moment.'
        case 500:
          return 'Something went wrong on our end. Please try again.'
        default:
          return 'An error occurred. Please try again.'
      }
    }
  }
  return 'An unexpected error occurred.'
}
```

### RTK Query Error Handling

```tsx
function GalleryPage() {
  const { data, error, isError, refetch } = useGetInspirationsQuery()

  if (isError) {
    return (
      <div className="flex flex-col items-center py-12">
        <AlertCircle className="w-12 h-12 text-destructive mb-4" />
        <h3 className="font-medium mb-2">Failed to load gallery</h3>
        <p className="text-muted-foreground mb-4">
          {getErrorMessage(error)}
        </p>
        <Button onClick={refetch}>Try again</Button>
      </div>
    )
  }

  // Normal render...
}
```

### Network Detection (Optional)

```tsx
function useNetworkStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine)

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return isOnline
}
```

## Testing

- [ ] Save failure shows toast
- [ ] Retry on save works
- [ ] Delete failure shows toast
- [ ] Retry on delete works
- [ ] Network error shows message
- [ ] 404 shows appropriate message
- [ ] 500 shows generic message
- [ ] Errors don't block UI

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
