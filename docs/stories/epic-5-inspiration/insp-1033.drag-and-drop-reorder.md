# Story insp-1033: Drag-and-Drop Reorder (gallery)

## Status

Draft

## Story

**As a** user,
**I want** to drag and drop items to reorder them in the gallery,
**so that** I can arrange my inspirations and albums as I prefer.

## Acceptance Criteria

1. Items can be dragged within gallery grid
2. Visual feedback shows drop position (line indicator)
3. Drop reorders item to new position
4. Reorder persists to backend
5. Works for both inspirations and albums
6. Touch support: long-press (300ms) to initiate drag

## Tasks / Subtasks

- [ ] **Task 1: Set Up DnD Library** (AC: 1)
  - [ ] Install dnd-kit or similar library
  - [ ] Configure sortable context
  - [ ] Wrap gallery grid with DnD provider

- [ ] **Task 2: Make Items Draggable** (AC: 1, 6)
  - [ ] Add draggable wrapper to cards
  - [ ] Implement drag handle or full-card drag
  - [ ] Add long-press for touch devices

- [ ] **Task 3: Add Visual Feedback** (AC: 2)
  - [ ] Show line indicator between items
  - [ ] Highlight drop zone
  - [ ] Animate dragged item

- [ ] **Task 4: Handle Drop & Persist** (AC: 3, 4)
  - [ ] Calculate new sort order on drop
  - [ ] Update local state immediately
  - [ ] Call reorder endpoint
  - [ ] Handle API failure (revert)

- [ ] **Task 5: Create Reorder Endpoint** (AC: 4, 5)
  - [ ] PATCH /api/inspirations/:id/reorder
  - [ ] PATCH /api/albums/:id/reorder
  - [ ] Accept new sortOrder value

## Dev Notes

### PRD Reference
From PRD Interaction Patterns:
> "Visual feedback: Line indicator appears between items showing drop position"
> "Touch: Long-press (300ms) to initiate drag"

### Library Choice
Recommended: `@dnd-kit/core` + `@dnd-kit/sortable`
- Good React integration
- Touch support built-in
- Accessible by default

### DnD Setup

```tsx
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  TouchSensor,
  useSensor,
  useSensors,
} from '@dnd-kit/core'
import {
  SortableContext,
  sortableKeyboardCoordinates,
  rectSortingStrategy,
} from '@dnd-kit/sortable'

function GalleryGrid({ items, onReorder }) {
  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(TouchSensor, {
      activationConstraint: {
        delay: 300,  // Long press
        tolerance: 5,
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  function handleDragEnd(event: DragEndEvent) {
    const { active, over } = event
    if (over && active.id !== over.id) {
      const oldIndex = items.findIndex(i => i.id === active.id)
      const newIndex = items.findIndex(i => i.id === over.id)
      onReorder(active.id, oldIndex, newIndex)
    }
  }

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCenter}
      onDragEnd={handleDragEnd}
    >
      <SortableContext items={items} strategy={rectSortingStrategy}>
        <div className="grid grid-cols-4 gap-4">
          {items.map((item) => (
            <SortableItem key={item.id} item={item} />
          ))}
        </div>
      </SortableContext>
    </DndContext>
  )
}
```

### Reorder API

```typescript
// PATCH /api/inspirations/:id/reorder
const ReorderRequestSchema = z.object({
  sortOrder: z.number().int().nonnegative(),
  albumId: z.string().uuid().optional(), // Context for album reordering
})

// Backend: Update sortOrder and shift others
async function reorderInspiration(id: string, newSortOrder: number, albumId?: string) {
  // If in album context, update inspiration_albums.sortOrder
  // Otherwise, update inspirations.sortOrder
}
```

### Optimistic Update

```typescript
async function handleReorder(itemId: string, oldIndex: number, newIndex: number) {
  // 1. Optimistic update
  const reordered = arrayMove(items, oldIndex, newIndex)
  setItems(reordered)

  // 2. Calculate new sortOrder
  const newSortOrder = calculateSortOrder(reordered, newIndex)

  // 3. Persist to backend
  try {
    await reorderMutation({ id: itemId, sortOrder: newSortOrder })
  } catch {
    // Revert on failure
    setItems(items)
    toast.error('Failed to reorder')
  }
}
```

## Testing

- [ ] Items can be dragged
- [ ] Line indicator shows drop position
- [ ] Drop moves item to position
- [ ] Order persists after refresh
- [ ] Works for inspirations
- [ ] Works for albums
- [ ] Touch long-press works
- [ ] Handles API failure gracefully

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
