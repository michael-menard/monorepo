# Story insp-1048: Tag Management Integration

## Status

Draft

## Story

**As a** user,
**I want** to manage tags on my inspirations and albums,
**so that** I can categorize and filter my collection.

## Acceptance Criteria

1. Tag input with autocomplete from existing tags
2. Add new tags inline
3. Remove tags with "x" button
4. Max 10 tags per item, max 50 chars each
5. Filter gallery by tags
6. Tag chips clickable to filter

## Tasks / Subtasks

- [ ] **Task 1: Create Tag Input Component** (AC: 1, 2, 3, 4)
  - [ ] Chip-style input for tags
  - [ ] Autocomplete from existing user tags
  - [ ] Add new tag on Enter/comma
  - [ ] Remove with x button or backspace
  - [ ] Enforce limits

- [ ] **Task 2: Integrate with Forms** (AC: 1)
  - [ ] Use in edit inspiration modal
  - [ ] Use in edit album modal
  - [ ] Use in create forms

- [ ] **Task 3: Create Tag Endpoint** (AC: 1)
  - [ ] GET /api/tags - list user's tags
  - [ ] Return usage counts
  - [ ] Cache for autocomplete

- [ ] **Task 4: Add Tag Filtering** (AC: 5, 6)
  - [ ] Add tags param to list endpoint
  - [ ] Filter sidebar with tag chips
  - [ ] Click tag in card to filter

## Dev Notes

### PRD Reference
From PRD Gallery View:
> "Tags: Theme/category tags (tree, castle, car, 1:8 scale, etc.)"

From PRD Shared Gallery Integration:
> "Tag chips"

### Tag Input Component

```tsx
interface TagInputProps {
  value: string[]
  onChange: (tags: string[]) => void
  maxTags?: number
  maxLength?: number
}

function TagInput({
  value,
  onChange,
  maxTags = 10,
  maxLength = 50,
}: TagInputProps) {
  const [input, setInput] = useState('')
  const { data: suggestions } = useGetTagsQuery()

  const filteredSuggestions = suggestions?.filter(
    tag => tag.toLowerCase().includes(input.toLowerCase()) && !value.includes(tag)
  )

  function addTag(tag: string) {
    const normalized = tag.trim().toLowerCase()
    if (
      normalized &&
      normalized.length <= maxLength &&
      value.length < maxTags &&
      !value.includes(normalized)
    ) {
      onChange([...value, normalized])
      setInput('')
    }
  }

  function removeTag(tag: string) {
    onChange(value.filter(t => t !== tag))
  }

  function handleKeyDown(e: React.KeyboardEvent) {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault()
      addTag(input)
    } else if (e.key === 'Backspace' && !input && value.length) {
      removeTag(value[value.length - 1])
    }
  }

  return (
    <div className="flex flex-wrap gap-1 p-2 border rounded-md">
      {value.map(tag => (
        <Badge key={tag} variant="secondary" className="gap-1">
          {tag}
          <button
            type="button"
            onClick={() => removeTag(tag)}
            className="hover:text-destructive"
          >
            <X className="w-3 h-3" />
          </button>
        </Badge>
      ))}

      {value.length < maxTags && (
        <div className="relative flex-1 min-w-[100px]">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder={value.length === 0 ? "Add tags..." : ""}
            className="w-full bg-transparent outline-none text-sm"
          />

          {/* Autocomplete dropdown */}
          {input && filteredSuggestions?.length > 0 && (
            <div className="absolute top-full left-0 w-full bg-popover border rounded-md shadow-md mt-1 z-10">
              {filteredSuggestions.slice(0, 5).map(tag => (
                <button
                  key={tag}
                  type="button"
                  onClick={() => addTag(tag)}
                  className="w-full px-3 py-1.5 text-left text-sm hover:bg-muted"
                >
                  {tag}
                </button>
              ))}
            </div>
          )}
        </div>
      )}

      <span className="text-xs text-muted-foreground ml-auto">
        {value.length}/{maxTags}
      </span>
    </div>
  )
}
```

### Tags Endpoint

```typescript
// GET /api/tags
const response = {
  tags: [
    { name: 'castle', count: 15 },
    { name: 'medieval', count: 12 },
    { name: 'space', count: 8 },
    // ...
  ]
}
```

### Gallery Filter by Tag

```tsx
function TagFilterSidebar({ selectedTags, onTagsChange, availableTags }) {
  return (
    <div className="space-y-2">
      <h3 className="font-medium">Tags</h3>
      <div className="flex flex-wrap gap-1">
        {availableTags.map(tag => (
          <Badge
            key={tag.name}
            variant={selectedTags.includes(tag.name) ? 'default' : 'outline'}
            className="cursor-pointer"
            onClick={() => {
              if (selectedTags.includes(tag.name)) {
                onTagsChange(selectedTags.filter(t => t !== tag.name))
              } else {
                onTagsChange([...selectedTags, tag.name])
              }
            }}
          >
            {tag.name} ({tag.count})
          </Badge>
        ))}
      </div>
    </div>
  )
}
```

## Testing

- [ ] Tag input shows autocomplete
- [ ] Can add new tags
- [ ] Can remove tags
- [ ] Limits enforced (10 tags, 50 chars)
- [ ] Tags save correctly
- [ ] Gallery filters by tag
- [ ] Tag chips in cards are clickable

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
