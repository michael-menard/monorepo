# Story insp-1024: Add Inspiration to Album Endpoint

## Status

Draft

## Story

**As a** user,
**I want** to add an inspiration to an album,
**so that** I can organize my images into collections.

## Acceptance Criteria

1. POST /api/albums/:albumId/inspirations/:inspirationId adds relationship
2. Many-to-many: inspiration can be in multiple albums
3. Assigns sortOrder at end of album
4. Returns 204 on success
5. Returns 404 if album or inspiration not found
6. Returns 403 if user doesn't own both
7. Idempotent: returns 204 if already in album

## Tasks / Subtasks

- [ ] **Task 1: Create Endpoint** (AC: 1, 5, 6)
  - [ ] Create POST /api/albums/:albumId/inspirations/:inspirationId handler
  - [ ] Add authentication middleware
  - [ ] Validate user owns both album and inspiration

- [ ] **Task 2: Create Relationship** (AC: 2, 3, 7)
  - [ ] Check if relationship already exists
  - [ ] If not, query max sortOrder in album
  - [ ] Insert into inspiration_albums junction table
  - [ ] Return 204 (idempotent)

- [ ] **Task 3: Update Album Metadata**
  - [ ] Update album.updatedAt timestamp
  - [ ] If first item, set as coverImageId if none set

- [ ] **Task 4: Add to Serverless Config**
  - [ ] Add Lambda function definition
  - [ ] Configure API Gateway route

## Dev Notes

### Endpoint Location
`apps/api/endpoints/albums/add-inspiration/handler.ts`

### Junction Table Insert

```typescript
await db.transaction(async (tx) => {
  // Verify ownership
  const album = await tx.query.albums.findFirst({
    where: and(eq(albums.id, albumId), eq(albums.userId, userId)),
  })
  const inspiration = await tx.query.inspirations.findFirst({
    where: and(eq(inspirations.id, inspirationId), eq(inspirations.userId, userId)),
  })

  if (!album || !inspiration) {
    throw new NotFoundError()
  }

  // Check if already in album (idempotent)
  const existing = await tx.query.inspirationAlbums.findFirst({
    where: and(
      eq(inspirationAlbums.albumId, albumId),
      eq(inspirationAlbums.inspirationId, inspirationId)
    ),
  })

  if (!existing) {
    // Get next sortOrder
    const maxSort = await tx
      .select({ max: sql`MAX(${inspirationAlbums.sortOrder})` })
      .from(inspirationAlbums)
      .where(eq(inspirationAlbums.albumId, albumId))

    const nextSort = (maxSort[0]?.max ?? -1) + 1

    // Insert relationship
    await tx.insert(inspirationAlbums).values({
      albumId,
      inspirationId,
      sortOrder: nextSort,
    })

    // Update album timestamp
    await tx.update(albums)
      .set({ updatedAt: new Date() })
      .where(eq(albums.id, albumId))
  }
})

return new Response(null, { status: 204 })
```

### Many-to-Many
An inspiration can belong to multiple albums. This is tracked in the `inspiration_albums` junction table.

## Testing

- [ ] Adds inspiration to album
- [ ] Assigns correct sortOrder
- [ ] Returns 204 on success
- [ ] Returns 204 if already in album (idempotent)
- [ ] Returns 404 if album doesn't exist
- [ ] Returns 404 if inspiration doesn't exist
- [ ] Returns 403 if user doesn't own album
- [ ] Returns 403 if user doesn't own inspiration

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
