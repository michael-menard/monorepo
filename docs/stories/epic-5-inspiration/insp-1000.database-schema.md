# Story insp-1000: Database Schema (Inspiration + Album)

## Status

Draft

## Story

**As a** developer,
**I want** the database schema for Inspiration and Album entities created,
**so that** we have a foundation for storing inspiration images and organizing them into albums.

## Acceptance Criteria

1. Inspiration table created with all required fields (id, userId, imageUrl, title, description, sourceUrl, tags, sortOrder, createdAt, updatedAt)
2. Album table created with all required fields (id, userId, title, description, coverImageId, tags, sortOrder, createdAt, updatedAt)
3. Junction table for inspiration-to-album many-to-many relationship (inspiration_albums)
4. Junction table for album-to-parent-album many-to-many relationship (album_parents)
5. Junction table for inspiration-to-moc many-to-many relationship (inspiration_mocs)
6. Junction table for album-to-moc many-to-many relationship (album_mocs)
7. Appropriate indexes created for userId, foreign keys, and sortOrder
8. Migrations run successfully

## Tasks / Subtasks

- [ ] **Task 1: Create Inspiration Table Schema** (AC: 1)
  - [ ] Define Drizzle schema for `inspirations` table
  - [ ] Add all required columns with appropriate types
  - [ ] Add userId index for owner queries

- [ ] **Task 2: Create Album Table Schema** (AC: 2)
  - [ ] Define Drizzle schema for `albums` table
  - [ ] Add all required columns with appropriate types
  - [ ] Add userId index for owner queries

- [ ] **Task 3: Create Junction Tables** (AC: 3, 4, 5, 6)
  - [ ] Create `inspiration_albums` junction table
  - [ ] Create `album_parents` junction table (for nested albums)
  - [ ] Create `inspiration_mocs` junction table
  - [ ] Create `album_mocs` junction table
  - [ ] Add composite primary keys and foreign key constraints

- [ ] **Task 4: Create Indexes** (AC: 7)
  - [ ] Add index on inspirations.userId
  - [ ] Add index on albums.userId
  - [ ] Add index on sortOrder fields
  - [ ] Add indexes on junction table foreign keys

- [ ] **Task 5: Run Migrations** (AC: 8)
  - [ ] Generate migration files
  - [ ] Test migration in dev environment
  - [ ] Verify rollback works

## Dev Notes

### Database Location
- Schema files: `apps/api/database/schema/`
- Follow existing patterns from MOC Instructions schema

### Table Definitions

```typescript
// inspirations table
export const inspirations = pgTable('inspirations', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id),
  imageUrl: text('image_url').notNull(),
  title: text('title'),
  description: text('description'),
  sourceUrl: text('source_url'),
  tags: text('tags').array(),
  sortOrder: integer('sort_order').notNull().default(0),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
})

// albums table
export const albums = pgTable('albums', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id),
  title: text('title').notNull(),
  description: text('description'),
  coverImageId: uuid('cover_image_id'),
  tags: text('tags').array(),
  sortOrder: integer('sort_order').notNull().default(0),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
})
```

### Many-to-Many Relationships
The data model is a DAG (Directed Acyclic Graph):
- Inspirations can belong to multiple albums
- Albums can have multiple parent albums
- Cycle detection will be handled at the API layer (insp-1028)

## Testing

- [ ] Migration runs without errors
- [ ] Tables created with correct column types
- [ ] Foreign key constraints enforced
- [ ] Indexes created successfully
- [ ] Rollback migration works correctly

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
