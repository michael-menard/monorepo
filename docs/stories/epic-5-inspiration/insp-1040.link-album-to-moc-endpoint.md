# Story insp-1040: Link Album to MOC Endpoint

## Status

Draft

## Story

**As a** user,
**I want** to link an album to a MOC,
**so that** I can associate a collection of reference images with a build.

## Acceptance Criteria

1. POST /api/albums/:id/mocs/:mocId creates link
2. Many-to-many: album can link to multiple MOCs
3. Returns 204 on success
4. Returns 404 if album or MOC not found
5. Returns 403 if user doesn't own both
6. Idempotent: returns 204 if already linked

## Tasks / Subtasks

- [ ] **Task 1: Create Link Endpoint** (AC: 1, 4, 5)
  - [ ] Create POST /api/albums/:id/mocs/:mocId handler
  - [ ] Add authentication middleware
  - [ ] Validate user owns both album and MOC

- [ ] **Task 2: Create Relationship** (AC: 2, 3, 6)
  - [ ] Check if link already exists
  - [ ] Insert into album_mocs junction table
  - [ ] Return 204 (idempotent)

- [ ] **Task 3: Add to Serverless Config**
  - [ ] Add Lambda function definition
  - [ ] Configure API Gateway route

## Dev Notes

### Endpoint Location
`apps/api/endpoints/albums/link-moc/handler.ts`

### Junction Table Schema

```typescript
export const albumMocs = pgTable('album_mocs', {
  albumId: uuid('album_id').notNull().references(() => albums.id),
  mocId: uuid('moc_id').notNull().references(() => mocs.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  pk: primaryKey(table.albumId, table.mocId),
}))
```

### Implementation

```typescript
export async function handler(event: APIGatewayEvent) {
  const userId = getUserId(event)
  const { id, mocId } = event.pathParameters

  await db.transaction(async (tx) => {
    // Verify ownership of album
    const album = await tx.query.albums.findFirst({
      where: and(eq(albums.id, id), eq(albums.userId, userId)),
    })
    if (!album) throw new NotFoundError('Album not found')

    // Verify ownership of MOC
    const moc = await tx.query.mocs.findFirst({
      where: and(eq(mocs.id, mocId), eq(mocs.userId, userId)),
    })
    if (!moc) throw new NotFoundError('MOC not found')

    // Check if already linked (idempotent)
    const existing = await tx.query.albumMocs.findFirst({
      where: and(
        eq(albumMocs.albumId, id),
        eq(albumMocs.mocId, mocId)
      ),
    })

    if (!existing) {
      await tx.insert(albumMocs).values({
        albumId: id,
        mocId,
      })
    }
  })

  return { statusCode: 204 }
}
```

### Use Case
Link entire albums to MOCs. Useful when an album contains all reference images for a specific build.

## Testing

- [ ] Links album to MOC
- [ ] Returns 204 on success
- [ ] Returns 204 if already linked (idempotent)
- [ ] Returns 404 if album doesn't exist
- [ ] Returns 404 if MOC doesn't exist
- [ ] Returns 403 if user doesn't own album
- [ ] Returns 403 if user doesn't own MOC

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
