# Story insp-1032: Upload Progress & Partial Failure

## Status

Draft

## Story

**As a** user,
**I want** clear feedback during uploads with graceful failure handling,
**so that** I know the status and can retry failed uploads.

## Acceptance Criteria

1. Overall progress indicator ("X of Y uploaded")
2. Individual file progress bars
3. Failed files marked with red indicator
4. Retry button per failed file
5. "Skip" option to ignore failed files
6. Modal shows summary on completion
7. Can close modal when some files succeed

## Tasks / Subtasks

- [ ] **Task 1: Add Overall Progress** (AC: 1)
  - [ ] Track completed vs total count
  - [ ] Show "3 of 8 uploaded" text
  - [ ] Update as each file completes

- [ ] **Task 2: Enhance Individual Progress** (AC: 2)
  - [ ] Show progress bar per file
  - [ ] Different colors for status (uploading, success, error)
  - [ ] Animate progress updates

- [ ] **Task 3: Handle Failures** (AC: 3, 4, 5)
  - [ ] Show error indicator on failed files
  - [ ] Add retry button per failed file
  - [ ] Add "Skip" button to ignore
  - [ ] Track retry attempts

- [ ] **Task 4: Completion Summary** (AC: 6, 7)
  - [ ] Show summary when all complete
  - [ ] Display success/failure counts
  - [ ] Allow closing with partial success
  - [ ] Warn before closing with failures

## Dev Notes

### PRD Reference
From PRD Loading & Error States:
> "Upload in progress: Modal stays open, per-file progress bars, 'X of Y uploaded'"
> "Upload failure: Red indicator on failed file, 'Retry' button, option to skip"

### Progress UI

```tsx
function UploadProgress({ files, onRetry, onSkip }) {
  const completed = files.filter(f => f.status === 'success' || f.status === 'error')
  const successful = files.filter(f => f.status === 'success')
  const failed = files.filter(f => f.status === 'error')

  return (
    <div className="space-y-4">
      {/* Overall progress */}
      <div className="text-center">
        <p className="text-lg font-medium">
          {successful.length} of {files.length} uploaded
        </p>
        <Progress
          value={(completed.length / files.length) * 100}
          className="mt-2"
        />
      </div>

      {/* Individual files */}
      <div className="space-y-2 max-h-60 overflow-y-auto">
        {files.map((file) => (
          <div key={file.id} className="flex items-center gap-2 p-2 rounded border">
            <img
              src={file.preview}
              alt=""
              className="w-10 h-10 object-cover rounded"
            />
            <div className="flex-1 min-w-0">
              <p className="text-sm truncate">{file.file.name}</p>
              {file.status === 'uploading' && (
                <Progress value={file.progress} className="h-1 mt-1" />
              )}
            </div>
            {file.status === 'success' && (
              <Check className="w-5 h-5 text-green-500" />
            )}
            {file.status === 'error' && (
              <div className="flex items-center gap-1">
                <AlertCircle className="w-5 h-5 text-destructive" />
                <Button
                  size="sm"
                  variant="outline"
                  onClick={() => onRetry(file.id)}
                >
                  Retry
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => onSkip(file.id)}
                >
                  Skip
                </Button>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* Completion state */}
      {completed.length === files.length && (
        <div className="text-center">
          {failed.length === 0 ? (
            <p className="text-green-600">All uploads complete!</p>
          ) : (
            <p className="text-muted-foreground">
              {successful.length} uploaded, {failed.length} failed
            </p>
          )}
        </div>
      )}
    </div>
  )
}
```

### Retry Logic

```typescript
async function handleRetry(fileId: string) {
  const file = files.find(f => f.id === fileId)
  if (!file) return

  setFiles(prev =>
    prev.map(f =>
      f.id === fileId
        ? { ...f, status: 'uploading', progress: 0, error: undefined }
        : f
    )
  )

  try {
    await uploadFile(file)
    setFiles(prev =>
      prev.map(f => f.id === fileId ? { ...f, status: 'success' } : f)
    )
  } catch (error) {
    setFiles(prev =>
      prev.map(f =>
        f.id === fileId
          ? { ...f, status: 'error', error: error.message }
          : f
      )
    )
  }
}

function handleSkip(fileId: string) {
  setFiles(prev => prev.filter(f => f.id !== fileId))
}
```

### Dependencies
- insp-1030: Multi-Image Upload Modal

## Testing

- [ ] Overall progress updates correctly
- [ ] Individual progress bars work
- [ ] Failed files show error indicator
- [ ] Retry re-attempts upload
- [ ] Skip removes file from list
- [ ] Summary shows on completion
- [ ] Can close with partial success
- [ ] Warning shown if closing with failures

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
