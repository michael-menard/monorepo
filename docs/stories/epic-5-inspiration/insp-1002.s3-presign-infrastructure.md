# Story insp-1002: S3 Presign Infrastructure

## Status

Draft

## Story

**As a** developer,
**I want** S3 presigned URL infrastructure for inspiration image uploads,
**so that** users can securely upload images directly to S3.

## Acceptance Criteria

1. Presign endpoint generates valid S3 presigned URLs for image uploads
2. URLs scoped to user's inspiration folder path (users/{userId}/inspirations/)
3. Supported image types: JPEG, PNG, WebP, GIF
4. Max file size enforced (10MB per image)
5. Presigned URLs expire after 15 minutes
6. Returns both upload URL and final image URL

## Tasks / Subtasks

- [ ] **Task 1: Create Presign Endpoint** (AC: 1, 5, 6)
  - [ ] Create POST /api/inspirations/upload/presign endpoint
  - [ ] Accept filename and contentType in request
  - [ ] Generate unique S3 key with UUID
  - [ ] Return presignedUrl and imageUrl

- [ ] **Task 2: Configure S3 Path Structure** (AC: 2)
  - [ ] Use path pattern: users/{userId}/inspirations/{uuid}/{filename}
  - [ ] Ensure user isolation via path prefix

- [ ] **Task 3: Validate File Types** (AC: 3)
  - [ ] Validate contentType against allowed list
  - [ ] Return 400 for unsupported types
  - [ ] Allowed: image/jpeg, image/png, image/webp, image/gif

- [ ] **Task 4: Enforce Size Limits** (AC: 4)
  - [ ] Set Content-Length limit in presigned URL conditions
  - [ ] Max 10MB (10485760 bytes)

- [ ] **Task 5: Add IAM Permissions** (AC: 1)
  - [ ] Verify Lambda has s3:PutObject permission
  - [ ] Scope to inspirations path prefix

## Dev Notes

### Endpoint Location
`apps/api/endpoints/inspirations/upload/presign/handler.ts`

### Existing Pattern
Reference MOC Instructions presign endpoint:
`apps/api/endpoints/moc-uploads/sessions/create/handler.ts`

### Request/Response

```typescript
// Request
const PresignRequestSchema = z.object({
  filename: z.string().min(1).max(255),
  contentType: z.enum(['image/jpeg', 'image/png', 'image/webp', 'image/gif']),
})

// Response
const PresignResponseSchema = z.object({
  presignedUrl: z.string().url(),
  imageUrl: z.string().url(),
  expiresAt: z.string().datetime(),
})
```

### S3 Configuration
- Bucket: Use existing API bucket or configure dedicated inspiration bucket
- Expiration: 900 seconds (15 minutes)
- Conditions: Content-Length <= 10MB, Content-Type matches request

## Testing

- [ ] Presign returns valid URL for allowed image types
- [ ] Presign rejects unsupported file types
- [ ] Presign rejects files over 10MB
- [ ] URLs are scoped to correct user path
- [ ] URLs expire after 15 minutes

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
