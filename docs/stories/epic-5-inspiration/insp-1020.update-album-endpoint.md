# Story insp-1020: Update Album Endpoint

## Status

Draft

## Story

**As a** user,
**I want** to update an album's metadata,
**so that** I can rename albums and update descriptions.

## Acceptance Criteria

1. PATCH /api/albums/:id updates album
2. Accepts partial updates (only fields provided)
3. Can update: title, description, tags, coverImageId
4. Returns updated album
5. Returns 404 if not found
6. Returns 403 if user doesn't own album
7. Updates updatedAt timestamp

## Tasks / Subtasks

- [ ] **Task 1: Create Update Endpoint** (AC: 1, 5, 6)
  - [ ] Create PATCH /api/albums/:id handler
  - [ ] Add authentication middleware
  - [ ] Validate ownership
  - [ ] Return appropriate error codes

- [ ] **Task 2: Implement Partial Update** (AC: 2, 3, 7)
  - [ ] Parse request with UpdateAlbumRequestSchema
  - [ ] Only update provided fields
  - [ ] Validate coverImageId belongs to album
  - [ ] Always update updatedAt

- [ ] **Task 3: Return Updated Data** (AC: 4)
  - [ ] Fetch and return complete updated record

- [ ] **Task 4: Add to Serverless Config**
  - [ ] Add Lambda function definition
  - [ ] Configure API Gateway route

## Dev Notes

### Endpoint Location
`apps/api/endpoints/albums/update/handler.ts`

### Request Schema

```typescript
const UpdateAlbumRequestSchema = z.object({
  title: z.string().min(1).max(200).optional(),
  description: z.string().max(2000).nullable().optional(),
  tags: z.array(z.string().max(50)).max(10).optional(),
  coverImageId: z.string().uuid().nullable().optional(),
}).partial()
```

### Cover Image Validation
When coverImageId is provided, verify:
1. The inspiration exists
2. The inspiration belongs to this album (or is owned by user)

```typescript
if (data.coverImageId) {
  const inspiration = await db.query.inspirations.findFirst({
    where: eq(inspirations.id, data.coverImageId)
  })
  if (!inspiration || inspiration.userId !== userId) {
    throw new BadRequestError('Invalid cover image')
  }
}
```

### Database Update

```typescript
const result = await db
  .update(albums)
  .set({
    ...validatedData,
    updatedAt: new Date(),
  })
  .where(
    and(
      eq(albums.id, id),
      eq(albums.userId, userId)
    )
  )
  .returning()
```

## Testing

- [ ] Updates title correctly
- [ ] Updates description correctly
- [ ] Updates tags correctly
- [ ] Updates coverImageId correctly
- [ ] Rejects invalid coverImageId
- [ ] Partial update doesn't affect other fields
- [ ] Returns 404 for non-existent
- [ ] Returns 403 for other user's album
- [ ] updatedAt is refreshed

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
