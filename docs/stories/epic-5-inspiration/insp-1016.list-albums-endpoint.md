# Story insp-1016: List Albums Endpoint

## Status

Draft

## Story

**As a** user,
**I want** to retrieve my list of albums,
**so that** I can see my organized collections.

## Acceptance Criteria

1. GET /api/albums returns user's albums
2. By default, returns only root-level albums (no parent)
3. Supports parentId filter to get nested albums
4. Supports pagination (limit, offset)
5. Supports sorting (sortOrder, createdAt, title)
6. Returns item count for each album
7. Returns total count for pagination

## Tasks / Subtasks

- [ ] **Task 1: Create List Endpoint** (AC: 1)
  - [ ] Create GET /api/albums handler
  - [ ] Add authentication middleware
  - [ ] Filter by userId

- [ ] **Task 2: Implement Parent Filtering** (AC: 2, 3)
  - [ ] Default to root albums (no parentAlbumIds)
  - [ ] Accept parentId query param
  - [ ] Filter by parent when provided

- [ ] **Task 3: Implement Pagination** (AC: 4, 7)
  - [ ] Accept limit (default 20, max 100)
  - [ ] Accept offset (default 0)
  - [ ] Return total count

- [ ] **Task 4: Implement Sorting & Counts** (AC: 5, 6)
  - [ ] Accept sortField query param
  - [ ] Count inspirations + nested albums per album
  - [ ] Include itemCount in response

- [ ] **Task 5: Add to Serverless Config**
  - [ ] Add Lambda function definition
  - [ ] Configure API Gateway route

## Dev Notes

### Endpoint Location
`apps/api/endpoints/albums/list/handler.ts`

### Query Parameters

```typescript
const ListAlbumsQuerySchema = z.object({
  parentId: z.string().uuid().optional(), // Filter by parent album
  limit: z.coerce.number().int().min(1).max(100).default(20),
  offset: z.coerce.number().int().min(0).default(0),
  sortField: z.enum(['sortOrder', 'createdAt', 'title']).default('sortOrder'),
  sortDirection: z.enum(['asc', 'desc']).default('asc'),
})
```

### Response

```typescript
const AlbumListResponseSchema = z.object({
  items: z.array(AlbumSummarySchema),
  total: z.number().int().nonnegative(),
  limit: z.number().int().positive(),
  offset: z.number().int().nonnegative(),
})

const AlbumSummarySchema = z.object({
  id: z.string().uuid(),
  title: z.string(),
  description: z.string().nullable(),
  coverImageUrl: z.string().url().nullable(), // From cover image or first image
  tags: z.array(z.string()),
  itemCount: z.number().int().nonnegative(),
  sortOrder: z.number().int(),
  createdAt: z.string().datetime(),
})
```

### Item Count Query
Count both inspirations and nested albums:
```sql
SELECT
  a.*,
  (SELECT COUNT(*) FROM inspiration_albums WHERE album_id = a.id) +
  (SELECT COUNT(*) FROM album_parents WHERE parent_album_id = a.id)
  AS item_count
FROM albums a
WHERE a.user_id = $1
```

### Root-Level Detection
Albums with no entries in `album_parents` table are root-level.

## Testing

- [ ] Returns user's albums only
- [ ] Default returns root albums only
- [ ] parentId filter returns nested albums
- [ ] Pagination works correctly
- [ ] itemCount is accurate
- [ ] Returns 401 for unauthenticated

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
