# Story insp-1050: E2E Test Suite

## Status

Draft

## Story

**As a** developer,
**I want** a comprehensive E2E test suite for the Inspiration Gallery,
**so that** we can verify all user flows work correctly before releasing the epic.

## Acceptance Criteria

1. Tests cover complete user journey from empty gallery to organized collection
2. Upload flow tested (single and multi-image)
3. Album CRUD operations tested
4. Drag-and-drop interactions tested
5. Keyboard navigation tested
6. MOC linking tested
7. Delete flows tested (with both album options)
8. Tests run in CI pipeline
9. All tests pass before epic is considered complete

## Tasks / Subtasks

- [ ] **Task 1: Set Up Test Infrastructure** (AC: 8)
  - [ ] Configure Playwright for Inspiration Gallery routes
  - [ ] Set up test database seeding
  - [ ] Create test user fixtures
  - [ ] Configure CI integration

- [ ] **Task 2: Test Empty States & Onboarding** (AC: 1)
  - [ ] Verify new user sees welcome empty state
  - [ ] Verify onboarding tooltip appears
  - [ ] Verify empty album state
  - [ ] Verify no search results state

- [ ] **Task 3: Test Upload Flows** (AC: 2)
  - [ ] Single image upload via modal
  - [ ] Multi-image upload
  - [ ] "Create as album?" flow
  - [ ] Upload validation (file type, size)
  - [ ] Upload progress and error handling
  - [ ] Verify images appear in gallery

- [ ] **Task 4: Test Inspiration CRUD** (AC: 1)
  - [ ] View inspiration detail
  - [ ] Edit inspiration metadata
  - [ ] Delete inspiration (with album warning)
  - [ ] Verify gallery updates after operations

- [ ] **Task 5: Test Album CRUD** (AC: 3)
  - [ ] Create album via modal
  - [ ] View album contents
  - [ ] Edit album metadata
  - [ ] Set album cover image
  - [ ] Delete album (album only option)
  - [ ] Delete album (with contents option)

- [ ] **Task 6: Test Album Relationships** (AC: 3)
  - [ ] Add inspiration to album
  - [ ] Remove inspiration from album
  - [ ] Create nested album
  - [ ] Navigate album hierarchy
  - [ ] Verify breadcrumb navigation
  - [ ] Test "Also in:" display

- [ ] **Task 7: Test Drag-and-Drop** (AC: 4)
  - [ ] Reorder inspirations in gallery
  - [ ] Reorder items in album
  - [ ] Stack-to-create-album gesture
  - [ ] Undo album creation
  - [ ] Verify order persists after refresh

- [ ] **Task 8: Test Keyboard Navigation** (AC: 5)
  - [ ] Arrow key gallery navigation
  - [ ] Space to select
  - [ ] Enter to open detail
  - [ ] Escape to close modals
  - [ ] Delete key functionality
  - [ ] "U" for upload, "G" for group

- [ ] **Task 9: Test MOC Linking** (AC: 6)
  - [ ] Link inspiration to MOC
  - [ ] Link album to MOC
  - [ ] Unlink from MOC
  - [ ] Verify links display correctly

- [ ] **Task 10: Test Multi-Select & Bulk Operations** (AC: 7)
  - [ ] Shift+click range select
  - [ ] Ctrl/Cmd+click toggle select
  - [ ] Create album from selected
  - [ ] Add selected to album
  - [ ] Delete selected

- [ ] **Task 11: Test Error Handling**
  - [ ] Network failure recovery
  - [ ] API error display
  - [ ] Retry functionality
  - [ ] Offline behavior (if applicable)

- [ ] **Task 12: Test Accessibility** (AC: 5)
  - [ ] Screen reader announcements
  - [ ] Focus management after actions
  - [ ] ARIA labels present
  - [ ] Keyboard-only operation

## Dev Notes

### Test Location
`apps/web/playwright/tests/inspiration-gallery/`

### Test Structure

```
apps/web/playwright/tests/inspiration-gallery/
├── upload.spec.ts           # Upload flows
├── inspiration-crud.spec.ts # Inspiration operations
├── album-crud.spec.ts       # Album operations
├── album-relationships.spec.ts # Nesting, membership
├── drag-and-drop.spec.ts    # DnD interactions
├── keyboard-nav.spec.ts     # Keyboard accessibility
├── moc-linking.spec.ts      # MOC integration
├── bulk-operations.spec.ts  # Multi-select, bulk
├── error-handling.spec.ts   # Error states
├── e2e-journey.spec.ts      # Full user journey
└── fixtures/
    ├── test-images/         # Sample images for upload
    └── setup.ts             # Database seeding
```

### Full User Journey Test

```typescript
// e2e-journey.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Inspiration Gallery - Complete User Journey', () => {
  test.beforeEach(async ({ page }) => {
    // Login as test user
    await loginAsTestUser(page)
  })

  test('new user can build an organized inspiration collection', async ({ page }) => {
    // 1. Start with empty gallery
    await page.goto('/inspiration')
    await expect(page.getByText('Start your inspiration collection')).toBeVisible()

    // 2. Upload first image
    await page.getByRole('button', { name: /upload/i }).click()
    await page.setInputFiles('input[type="file"]', 'fixtures/test-images/castle1.jpg')
    await expect(page.getByText('Image uploaded')).toBeVisible()

    // 3. Upload multiple images and create album
    await page.getByRole('button', { name: /add/i }).click()
    await page.setInputFiles('input[type="file"]', [
      'fixtures/test-images/castle2.jpg',
      'fixtures/test-images/castle3.jpg',
      'fixtures/test-images/castle4.jpg',
    ])
    await expect(page.getByText('Create as album?')).toBeVisible()
    await page.getByPlaceholder('Album name').fill('Castle Ideas')
    await page.getByRole('button', { name: 'Create Album' }).click()

    // 4. Verify album created and navigated
    await expect(page).toHaveURL(/\/inspiration\/albums\//)
    await expect(page.getByRole('heading', { name: 'Castle Ideas' })).toBeVisible()
    await expect(page.locator('[data-gallery-item]')).toHaveCount(3)

    // 5. Navigate back to gallery
    await page.getByRole('button', { name: /back/i }).click()
    await expect(page.locator('[data-gallery-item]')).toHaveCount(2) // 1 orphan + 1 album

    // 6. Edit inspiration metadata
    await page.locator('[data-gallery-item]').first().click()
    await page.getByRole('button', { name: /edit/i }).click()
    await page.getByLabel('Title').fill('My First Castle')
    await page.getByRole('button', { name: 'Save' }).click()
    await expect(page.getByRole('heading', { name: 'My First Castle' })).toBeVisible()

    // 7. Add to album
    await page.getByRole('button', { name: /add to album/i }).click()
    await page.getByRole('checkbox', { name: 'Castle Ideas' }).check()
    await page.getByRole('button', { name: 'Save' }).click()
    await expect(page.getByText('Also in:')).toBeVisible()
    await expect(page.getByText('Castle Ideas')).toBeVisible()

    // 8. Create nested album via drag (or keyboard)
    await page.goto('/inspiration')
    await page.keyboard.press('Space') // Select first
    await page.keyboard.press('Shift+ArrowRight') // Select second
    await page.keyboard.press('g') // Group
    await page.getByPlaceholder('Album name').fill('Favorites')
    await page.getByRole('button', { name: 'Create' }).click()

    // 9. Delete an inspiration
    await page.locator('[data-gallery-item]').first().click()
    await page.getByRole('button', { name: /delete/i }).click()
    await expect(page.getByText('This cannot be undone')).toBeVisible()
    await page.getByRole('button', { name: /delete permanently/i }).click()
    await expect(page).toHaveURL('/inspiration')

    // 10. Verify final state
    const items = page.locator('[data-gallery-item]')
    await expect(items).toHaveCount(2) // Castle Ideas album + Favorites album
  })
})
```

### Database Seeding

```typescript
// fixtures/setup.ts
export async function seedTestData(userId: string) {
  // Create test inspirations
  const inspirations = await db.insert(inspirationsTable).values([
    { userId, imageUrl: 'https://test-bucket/img1.jpg', title: 'Test 1' },
    { userId, imageUrl: 'https://test-bucket/img2.jpg', title: 'Test 2' },
    // ...
  ]).returning()

  // Create test albums
  const albums = await db.insert(albumsTable).values([
    { userId, title: 'Test Album' },
  ]).returning()

  // Create relationships
  await db.insert(inspirationAlbumsTable).values([
    { inspirationId: inspirations[0].id, albumId: albums[0].id, sortOrder: 0 },
  ])

  return { inspirations, albums }
}

export async function cleanupTestData(userId: string) {
  await db.delete(inspirationsTable).where(eq(inspirationsTable.userId, userId))
  await db.delete(albumsTable).where(eq(albumsTable.userId, userId))
}
```

### CI Configuration

```yaml
# .github/workflows/e2e.yml (relevant section)
- name: Run Inspiration Gallery E2E Tests
  run: pnpm playwright test tests/inspiration-gallery/
  env:
    DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
    S3_BUCKET: ${{ secrets.TEST_S3_BUCKET }}
```

### Test Coverage Requirements

| Flow | Minimum Tests |
|------|---------------|
| Upload | 5 |
| Inspiration CRUD | 4 |
| Album CRUD | 6 |
| Album Relationships | 5 |
| Drag-and-Drop | 4 |
| Keyboard Navigation | 6 |
| MOC Linking | 3 |
| Bulk Operations | 4 |
| Error Handling | 3 |
| Full Journey | 1 |
| **Total** | **41+** |

### Dependencies
- All other insp-* stories must be complete
- Test environment with S3 bucket access
- Playwright configured in monorepo

## Testing

- [ ] All test files created
- [ ] Tests run locally
- [ ] Tests pass in CI
- [ ] Coverage meets requirements
- [ ] Flaky tests identified and fixed
- [ ] Test data cleanup works

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
