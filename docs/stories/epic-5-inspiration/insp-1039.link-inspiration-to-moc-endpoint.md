# Story insp-1039: Link Inspiration to MOC Endpoint

## Status

Draft

## Story

**As a** user,
**I want** to link an inspiration to a MOC,
**so that** I can associate reference images with my builds.

## Acceptance Criteria

1. POST /api/inspirations/:id/mocs/:mocId creates link
2. Many-to-many: inspiration can link to multiple MOCs
3. Returns 204 on success
4. Returns 404 if inspiration or MOC not found
5. Returns 403 if user doesn't own both
6. Idempotent: returns 204 if already linked

## Tasks / Subtasks

- [ ] **Task 1: Create Link Endpoint** (AC: 1, 4, 5)
  - [ ] Create POST /api/inspirations/:id/mocs/:mocId handler
  - [ ] Add authentication middleware
  - [ ] Validate user owns both inspiration and MOC

- [ ] **Task 2: Create Relationship** (AC: 2, 3, 6)
  - [ ] Check if link already exists
  - [ ] Insert into inspiration_mocs junction table
  - [ ] Return 204 (idempotent)

- [ ] **Task 3: Add to Serverless Config**
  - [ ] Add Lambda function definition
  - [ ] Configure API Gateway route

## Dev Notes

### Endpoint Location
`apps/api/endpoints/inspirations/link-moc/handler.ts`

### Junction Table Schema

```typescript
export const inspirationMocs = pgTable('inspiration_mocs', {
  inspirationId: uuid('inspiration_id').notNull().references(() => inspirations.id),
  mocId: uuid('moc_id').notNull().references(() => mocs.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  pk: primaryKey(table.inspirationId, table.mocId),
}))
```

### Implementation

```typescript
export async function handler(event: APIGatewayEvent) {
  const userId = getUserId(event)
  const { id, mocId } = event.pathParameters

  await db.transaction(async (tx) => {
    // Verify ownership of inspiration
    const inspiration = await tx.query.inspirations.findFirst({
      where: and(eq(inspirations.id, id), eq(inspirations.userId, userId)),
    })
    if (!inspiration) throw new NotFoundError('Inspiration not found')

    // Verify ownership of MOC
    const moc = await tx.query.mocs.findFirst({
      where: and(eq(mocs.id, mocId), eq(mocs.userId, userId)),
    })
    if (!moc) throw new NotFoundError('MOC not found')

    // Check if already linked (idempotent)
    const existing = await tx.query.inspirationMocs.findFirst({
      where: and(
        eq(inspirationMocs.inspirationId, id),
        eq(inspirationMocs.mocId, mocId)
      ),
    })

    if (!existing) {
      await tx.insert(inspirationMocs).values({
        inspirationId: id,
        mocId,
      })
    }
  })

  return { statusCode: 204 }
}
```

### Use Case
Link inspiration images to MOCs they inspired. When viewing a MOC, user can see related inspirations. When viewing inspiration, user can see which MOCs it's linked to.

## Testing

- [ ] Links inspiration to MOC
- [ ] Returns 204 on success
- [ ] Returns 204 if already linked (idempotent)
- [ ] Returns 404 if inspiration doesn't exist
- [ ] Returns 404 if MOC doesn't exist
- [ ] Returns 403 if user doesn't own inspiration
- [ ] Returns 403 if user doesn't own MOC

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
