# Story insp-1018: Get Album Contents Endpoint

## Status

Draft

## Story

**As a** user,
**I want** to retrieve an album's contents,
**so that** I can view the inspirations and nested albums within.

## Acceptance Criteria

1. GET /api/albums/:id/contents returns album contents
2. Returns album metadata (title, description, tags)
3. Returns list of inspirations in album
4. Returns list of nested albums
5. Respects sortOrder for both types
6. Returns 404 if album not found
7. Returns 403 if user doesn't own album

## Tasks / Subtasks

- [ ] **Task 1: Create Endpoint** (AC: 1, 6, 7)
  - [ ] Create GET /api/albums/:id/contents handler
  - [ ] Add authentication middleware
  - [ ] Validate ownership
  - [ ] Return appropriate error codes

- [ ] **Task 2: Fetch Album Metadata** (AC: 2)
  - [ ] Fetch album record by ID
  - [ ] Include all metadata fields

- [ ] **Task 3: Fetch Album Contents** (AC: 3, 4, 5)
  - [ ] Query inspirations via inspiration_albums junction
  - [ ] Query nested albums via album_parents junction
  - [ ] Sort both by sortOrder

- [ ] **Task 4: Add to Serverless Config**
  - [ ] Add Lambda function definition
  - [ ] Configure API Gateway route

## Dev Notes

### Endpoint Location
`apps/api/endpoints/albums/get-contents/handler.ts`

### Response Schema

```typescript
const AlbumContentsResponseSchema = z.object({
  // Album metadata
  album: z.object({
    id: z.string().uuid(),
    title: z.string(),
    description: z.string().nullable(),
    coverImageId: z.string().uuid().nullable(),
    tags: z.array(z.string()),
    parentAlbumIds: z.array(z.string().uuid()),
    mocIds: z.array(z.string().uuid()),
    createdAt: z.string().datetime(),
    updatedAt: z.string().datetime(),
  }),
  // Parent albums for "Also in:" display
  parentAlbums: z.array(z.object({
    id: z.string().uuid(),
    title: z.string(),
  })),
  // Contents
  inspirations: z.array(InspirationSummarySchema),
  nestedAlbums: z.array(AlbumSummarySchema),
})
```

### Query Structure

```typescript
// Get album
const album = await db.query.albums.findFirst({
  where: and(
    eq(albums.id, albumId),
    eq(albums.userId, userId)
  ),
})

// Get inspirations in album
const inspirations = await db
  .select()
  .from(inspirations)
  .innerJoin(inspirationAlbums, eq(inspirations.id, inspirationAlbums.inspirationId))
  .where(eq(inspirationAlbums.albumId, albumId))
  .orderBy(asc(inspirationAlbums.sortOrder))

// Get nested albums
const nestedAlbums = await db
  .select()
  .from(albums)
  .innerJoin(albumParents, eq(albums.id, albumParents.childAlbumId))
  .where(eq(albumParents.parentAlbumId, albumId))
  .orderBy(asc(albumParents.sortOrder))
```

### Parent Albums Query
Also fetch parent albums for multi-parent display:
```typescript
const parentAlbums = await db
  .select({ id: albums.id, title: albums.title })
  .from(albums)
  .innerJoin(albumParents, eq(albums.id, albumParents.parentAlbumId))
  .where(eq(albumParents.childAlbumId, albumId))
```

## Testing

- [ ] Returns album metadata
- [ ] Returns inspirations with correct order
- [ ] Returns nested albums with correct order
- [ ] Returns parent albums for "Also in:"
- [ ] Returns 404 for non-existent
- [ ] Returns 403 for other user's album

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
