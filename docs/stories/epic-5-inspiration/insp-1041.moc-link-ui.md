# Story insp-1041: MOC Link UI (picker modal)

## Status

Draft

## Story

**As a** user,
**I want** a modal to link inspirations/albums to MOCs,
**so that** I can easily associate reference images with my builds.

## Acceptance Criteria

1. "Link to MOC" action in inspiration detail view
2. "Link to MOC" action in album header
3. Modal shows list of user's MOCs
4. Search/filter MOCs by title
5. Can select multiple MOCs
6. Shows currently linked MOCs as checked
7. Save applies all link changes

## Tasks / Subtasks

- [ ] **Task 1: Add Link Actions** (AC: 1, 2)
  - [ ] Add "Link to MOC" button in inspiration detail
  - [ ] Add "Link to MOC" button in album header
  - [ ] Opens MocLinkModal

- [ ] **Task 2: Create Modal Component** (AC: 3, 6)
  - [ ] Create MocLinkModal component
  - [ ] Fetch user's MOCs
  - [ ] Show as checkbox list
  - [ ] Pre-check currently linked MOCs

- [ ] **Task 3: Add Search/Filter** (AC: 4)
  - [ ] Add search input
  - [ ] Filter MOC list by title
  - [ ] Debounce search input

- [ ] **Task 4: Implement Multi-Select** (AC: 5)
  - [ ] Allow checking multiple MOCs
  - [ ] Track changes from initial state

- [ ] **Task 5: Save Changes** (AC: 7)
  - [ ] Compare initial vs final selections
  - [ ] Call link endpoint for newly checked
  - [ ] Call unlink endpoint for unchecked
  - [ ] Show success toast

## Dev Notes

### Component Location
`apps/web/main-app/src/routes/inspiration/-components/MocLinkModal/index.tsx`

### PRD Reference
From PRD Detail View:
> "'Link to MOC' action"

From PRD Multi-Album Visibility (similar pattern for MOC links):
> "[+ Add to album...]" â†’ Opens picker

### Modal Implementation

```tsx
function MocLinkModal({
  entityType,  // 'inspiration' | 'album'
  entityId,
  currentMocIds,
  onClose,
}) {
  const [searchQuery, setSearchQuery] = useState('')
  const debouncedSearch = useDebounce(searchQuery, 300)

  const { data: mocs } = useGetMocsQuery({
    search: debouncedSearch,
    limit: 50,
  })

  const [selected, setSelected] = useState(new Set(currentMocIds))

  const [linkToMoc] = useLinkToMocMutation()
  const [unlinkFromMoc] = useUnlinkFromMocMutation()

  async function handleSave() {
    const toLink = [...selected].filter(id => !currentMocIds.includes(id))
    const toUnlink = currentMocIds.filter(id => !selected.has(id))

    await Promise.all([
      ...toLink.map(mocId =>
        linkToMoc({ entityType, entityId, mocId }).unwrap()
      ),
      ...toUnlink.map(mocId =>
        unlinkFromMoc({ entityType, entityId, mocId }).unwrap()
      ),
    ])

    toast.success('MOC links updated')
    onClose()
  }

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Link to MOC</DialogTitle>
        </DialogHeader>

        {/* Search */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
          <Input
            placeholder="Search MOCs..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="pl-9"
          />
        </div>

        {/* MOC list */}
        <div className="space-y-2 max-h-60 overflow-y-auto">
          {mocs?.items.map(moc => (
            <label
              key={moc.id}
              className="flex items-center gap-3 p-2 hover:bg-muted rounded cursor-pointer"
            >
              <Checkbox
                checked={selected.has(moc.id)}
                onCheckedChange={(checked) => {
                  const next = new Set(selected)
                  if (checked) next.add(moc.id)
                  else next.delete(moc.id)
                  setSelected(next)
                }}
              />
              {moc.coverImageUrl && (
                <img
                  src={moc.coverImageUrl}
                  alt=""
                  className="w-10 h-10 object-cover rounded"
                />
              )}
              <span className="truncate">{moc.title}</span>
            </label>
          ))}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSave}>Save</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

### Displaying Linked MOCs
In detail view, show linked MOCs similarly to albums:

```tsx
{linkedMocs.length > 0 && (
  <div>
    <h3 className="font-medium mb-2">Linked MOCs:</h3>
    <div className="flex flex-wrap gap-2">
      {linkedMocs.map(moc => (
        <Badge
          key={moc.id}
          variant="outline"
          className="cursor-pointer"
          onClick={() => navigate({ to: '/instructions/$id', params: { id: moc.id } })}
        >
          {moc.title}
        </Badge>
      ))}
    </div>
  </div>
)}
```

### Dependencies
- insp-1039: Link Inspiration to MOC Endpoint
- insp-1040: Link Album to MOC Endpoint

## Testing

- [ ] Modal opens from inspiration detail
- [ ] Modal opens from album header
- [ ] Shows user's MOCs
- [ ] Search filters MOCs
- [ ] Current links pre-checked
- [ ] Can select multiple
- [ ] Save updates links correctly
- [ ] Linked MOCs display in detail view

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
