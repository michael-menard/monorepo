# Story insp-1036: Stack Undo Toast

## Status

Draft

## Story

**As a** user,
**I want** to undo an accidentally created album,
**so that** I can recover from mistakes quickly.

## Acceptance Criteria

1. Toast appears after stack-to-create-album
2. Toast shows album name: "Album '[name]' created"
3. Toast has "Undo" action button
4. Undo removes album and restores images as orphans
5. Toast auto-dismisses after 5 seconds
6. Clicking undo within timeout reverts creation

## Tasks / Subtasks

- [ ] **Task 1: Show Toast on Album Create** (AC: 1, 2)
  - [ ] Trigger toast after stack creates album
  - [ ] Display album name in message
  - [ ] Include Undo button

- [ ] **Task 2: Implement Undo Action** (AC: 4)
  - [ ] Track created album ID
  - [ ] Track original image IDs
  - [ ] Delete album (orphan mode) on undo
  - [ ] Refresh gallery

- [ ] **Task 3: Handle Timeout** (AC: 5, 6)
  - [ ] Auto-dismiss after 5 seconds
  - [ ] Undo only works within timeout
  - [ ] Clear undo data after timeout

## Dev Notes

### PRD Reference
From PRD Interaction Patterns - Stack-to-Create-Album:
> "Undo: Toast appears: 'Album [name] created' with 'Undo' action (5 second timeout)"

### Toast Implementation

```tsx
import { toast } from 'sonner' // or your toast library

function handleStackCreateAlbum(name: string, images: Inspiration[]) {
  // Create album
  const album = await createAlbumWithImages(name, images)

  // Show toast with undo
  toast.success(`Album '${name}' created`, {
    duration: 5000,
    action: {
      label: 'Undo',
      onClick: () => handleUndo(album.id),
    },
  })
}
```

### Undo Logic

```typescript
async function handleUndo(albumId: string) {
  try {
    // Delete album in orphan mode (images remain)
    await deleteAlbum({ id: albumId, deleteContents: false }).unwrap()

    toast.success('Album creation undone')

    // Refresh gallery to show orphaned images
    refetchGallery()
  } catch {
    toast.error('Failed to undo. Album may have been modified.')
  }
}
```

### Undo State Management
For more complex scenarios, track undo state:

```typescript
interface UndoState {
  albumId: string
  imageIds: string[]
  createdAt: number
  timeout: NodeJS.Timeout
}

const [undoState, setUndoState] = useState<UndoState | null>(null)

function startUndo(albumId: string, imageIds: string[]) {
  // Clear any existing undo
  if (undoState?.timeout) clearTimeout(undoState.timeout)

  const timeout = setTimeout(() => {
    setUndoState(null)
  }, 5000)

  setUndoState({ albumId, imageIds, createdAt: Date.now(), timeout })
}

function canUndo(): boolean {
  return undoState !== null && Date.now() - undoState.createdAt < 5000
}
```

### Edge Cases
- User navigates away: undo still works if they come back within 5s
- Album modified: undo may fail if album was edited
- Multiple creates: each creates new undo (replaces previous)

### Dependencies
- insp-1035: Stack-to-Create-Album Gesture
- insp-1022: Delete Album Endpoint (orphan mode)

## Testing

- [ ] Toast appears after stack create
- [ ] Toast shows album name
- [ ] Undo button visible
- [ ] Undo deletes album
- [ ] Images remain after undo
- [ ] Toast auto-dismisses at 5s
- [ ] Undo fails after timeout
- [ ] Gallery refreshes after undo

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
