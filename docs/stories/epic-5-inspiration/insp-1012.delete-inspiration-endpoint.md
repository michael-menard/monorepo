# Story insp-1012: Delete Inspiration Endpoint

## Status

Draft

## Story

**As a** user,
**I want** to permanently delete an inspiration,
**so that** I can remove unwanted images from my gallery.

## Acceptance Criteria

1. DELETE /api/inspirations/:id deletes inspiration
2. Hard delete (no soft delete/recycle bin)
3. Deletes image from S3
4. Removes from all albums (junction table cleanup)
5. Removes all MOC links (junction table cleanup)
6. Returns 204 on success
7. Returns 404 if not found
8. Returns 403 if user doesn't own inspiration

## Tasks / Subtasks

- [ ] **Task 1: Create Delete Endpoint** (AC: 1, 6, 7, 8)
  - [ ] Create DELETE /api/inspirations/:id handler
  - [ ] Add authentication middleware
  - [ ] Validate ownership
  - [ ] Return 204 No Content on success

- [ ] **Task 2: Delete S3 Object** (AC: 3)
  - [ ] Extract S3 key from imageUrl
  - [ ] Delete object from S3
  - [ ] Handle S3 errors gracefully

- [ ] **Task 3: Clean Up Relationships** (AC: 4, 5)
  - [ ] Delete from inspiration_albums junction table
  - [ ] Delete from inspiration_mocs junction table
  - [ ] Use transaction for atomicity

- [ ] **Task 4: Delete Database Record** (AC: 2)
  - [ ] Delete from inspirations table
  - [ ] Verify cascade/cleanup is complete

- [ ] **Task 5: Add to Serverless Config**
  - [ ] Add Lambda function definition
  - [ ] Configure API Gateway route

## Dev Notes

### Endpoint Location
`apps/api/endpoints/inspirations/delete/handler.ts`

### Transaction Flow

```typescript
await db.transaction(async (tx) => {
  // 1. Verify ownership
  const inspiration = await tx.query.inspirations.findFirst({
    where: and(
      eq(inspirations.id, id),
      eq(inspirations.userId, userId)
    ),
  })

  if (!inspiration) throw new NotFoundError()

  // 2. Delete junction table records
  await tx.delete(inspirationAlbums).where(eq(inspirationAlbums.inspirationId, id))
  await tx.delete(inspirationMocs).where(eq(inspirationMocs.inspirationId, id))

  // 3. Delete inspiration record
  await tx.delete(inspirations).where(eq(inspirations.id, id))

  // 4. Delete S3 object (outside transaction, but after DB success)
})

// S3 deletion after transaction commits
await deleteS3Object(inspiration.imageUrl)
```

### S3 Deletion
Extract key from imageUrl and use S3 DeleteObject. If S3 deletion fails, log error but don't fail the request (DB is source of truth).

### Hard Delete Warning
Per PRD: Inspiration Gallery uses hard delete, NOT soft delete. This is permanent.

## Testing

- [ ] Deletes inspiration from database
- [ ] Deletes image from S3
- [ ] Removes album memberships
- [ ] Removes MOC links
- [ ] Returns 204 on success
- [ ] Returns 404 for non-existent
- [ ] Returns 403 for other user's inspiration

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
