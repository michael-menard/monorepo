# Story insp-1042: Unlink MOC (endpoint + UI)

## Status

Draft

## Story

**As a** user,
**I want** to unlink MOCs from inspirations and albums,
**so that** I can remove incorrect associations.

## Acceptance Criteria

1. DELETE /api/inspirations/:id/mocs/:mocId removes link
2. DELETE /api/albums/:id/mocs/:mocId removes link
3. Returns 204 on success
4. Idempotent: returns 204 if not linked
5. UI shows remove action on linked MOC badges
6. Confirmation before unlinking

## Tasks / Subtasks

- [ ] **Task 1: Create Unlink Endpoints** (AC: 1, 2, 3, 4)
  - [ ] DELETE /api/inspirations/:id/mocs/:mocId
  - [ ] DELETE /api/albums/:id/mocs/:mocId
  - [ ] Validate ownership
  - [ ] Delete from junction table

- [ ] **Task 2: Add Unlink UI** (AC: 5)
  - [ ] Add "x" button on MOC badges in detail view
  - [ ] Or context menu with "Unlink" option

- [ ] **Task 3: Add Confirmation** (AC: 6)
  - [ ] Show confirmation before unlink
  - [ ] "Unlink from [MOC name]?"

- [ ] **Task 4: Add to Serverless Config**
  - [ ] Add Lambda functions
  - [ ] Configure routes

## Dev Notes

### Endpoint Locations
- `apps/api/endpoints/inspirations/unlink-moc/handler.ts`
- `apps/api/endpoints/albums/unlink-moc/handler.ts`

### Implementation

```typescript
// Inspiration unlink
export async function handler(event: APIGatewayEvent) {
  const userId = getUserId(event)
  const { id, mocId } = event.pathParameters

  // Verify ownership
  const inspiration = await db.query.inspirations.findFirst({
    where: and(eq(inspirations.id, id), eq(inspirations.userId, userId)),
  })
  if (!inspiration) throw new NotFoundError()

  // Delete link (idempotent)
  await db.delete(inspirationMocs).where(
    and(
      eq(inspirationMocs.inspirationId, id),
      eq(inspirationMocs.mocId, mocId)
    )
  )

  return { statusCode: 204 }
}
```

### UI Implementation

```tsx
// In detail view
{linkedMocs.map(moc => (
  <Badge
    key={moc.id}
    variant="outline"
    className="group"
  >
    <span
      className="cursor-pointer"
      onClick={() => navigate({ to: '/instructions/$id', params: { id: moc.id } })}
    >
      {moc.title}
    </span>
    <button
      className="ml-1 opacity-0 group-hover:opacity-100 transition-opacity"
      onClick={(e) => {
        e.stopPropagation()
        handleUnlink(moc)
      }}
    >
      <X className="w-3 h-3" />
    </button>
  </Badge>
))}
```

### Confirmation

```tsx
function handleUnlink(moc: Moc) {
  if (confirm(`Unlink from "${moc.title}"?`)) {
    unlinkFromMoc({ entityId, mocId: moc.id })
      .then(() => toast.success('Unlinked from MOC'))
  }
}
```

Or use a proper AlertDialog for better UX.

### Dependencies
- insp-1039: Link Inspiration to MOC Endpoint (for context)
- insp-1041: MOC Link UI (displays links)

## Testing

- [ ] DELETE endpoint removes inspiration-MOC link
- [ ] DELETE endpoint removes album-MOC link
- [ ] Returns 204 on success
- [ ] Returns 204 if not linked (idempotent)
- [ ] X button appears on hover
- [ ] Confirmation shows before unlink
- [ ] Badge removed after unlink

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-12-27 | 0.1     | Initial draft | SM Agent |
