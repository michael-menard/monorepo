# Story 5.8: ECS Service Decommission Plan

**Epic**: 5 - Production Deployment, Monitoring & Cutover

**As a** DevOps engineer,
**I want** a safe decommission plan for the ECS service,
**so that** the legacy infrastructure can be removed without impacting production.

## Acceptance Criteria

1. Decommission checklist created with pre-requisite validation
2. Traffic verification: 100% traffic on SST (Route53 weighted routing at 0% ECS)
3. Performance validation: SST performance matches or exceeds ECS baseline for 7 days
4. Error rate validation: SST error rate ‚â§ ECS baseline for 7 days
5. Cost validation: SST cost ‚â§ ECS cost for 7 days
6. Database migration validation: All data migrated, no missing records
7. ECS service scaled to 0 tasks (not deleted) for 7-day observation period
8. CloudWatch alarms updated to remove ECS references
9. Route53 DNS records for ECS removed after observation period
10. ECS cluster, task definitions, and related resources deleted after 30 days
11. Rollback plan documented and tested
12. Final decommission report generated

## Implementation Status

**Status**: Not Started

## Files Modified

_To be populated during implementation_

## QA Results

_Pending implementation and review_

---

## Requirements Traceability Matrix

| AC # | Requirement                            | Test Coverage | Status   |
| ---- | -------------------------------------- | ------------- | -------- |
| 1    | Decommission checklist created         | TBD           | ‚è≥ PENDING |
| 2    | 100% traffic on SST (Route53)          | TBD           | ‚è≥ PENDING |
| 3    | Performance validation (7 days)        | TBD           | ‚è≥ PENDING |
| 4    | Error rate validation (7 days)         | TBD           | ‚è≥ PENDING |
| 5    | Cost validation (7 days)               | TBD           | ‚è≥ PENDING |
| 6    | Database migration validation          | TBD           | ‚è≥ PENDING |
| 7    | ECS scaled to 0 tasks (7-day watch)    | TBD           | ‚è≥ PENDING |
| 8    | CloudWatch alarms updated              | TBD           | ‚è≥ PENDING |
| 9    | Route53 DNS records removed            | TBD           | ‚è≥ PENDING |
| 10   | ECS cluster deleted (after 30 days)    | TBD           | ‚è≥ PENDING |
| 11   | Rollback plan documented/tested        | TBD           | ‚è≥ PENDING |
| 12   | Final decommission report generated    | TBD           | ‚è≥ PENDING |

**Overall Coverage: TBD**

---

## Test Summary

_To be populated during implementation_

### Recommended Test Coverage

1. **Pre-Decommission Validation** - 5 tests
   - Traffic 100% on SST
   - Performance metrics meet baseline
   - Error rate below threshold
   - Cost below ECS baseline
   - Database integrity check passes

2. **Decommission Execution** - 3 tests
   - ECS service scaled to 0 successfully
   - No production impact observed
   - CloudWatch alarms not firing

3. **Rollback Test** - 1 test
   - ECS service can be restored within 15 minutes

4. **Final Cleanup** - 2 tests
   - All ECS resources deleted
   - No orphaned resources (Load Balancers, Target Groups, etc.)

---

## Technical Notes

### Decommission Checklist

```markdown
# ECS Service Decommission Checklist

**Date**: ___________
**Executed By**: DevOps Team

---

## Phase 1: Pre-Decommission Validation (Day 0)

- [ ] **Traffic Validation**: Route53 shows 100% traffic on SST (0% on ECS)
- [ ] **Performance Validation**: SST performance ‚â• ECS baseline for 7 consecutive days
  - [ ] Response time p95 <500ms
  - [ ] Throughput >100 req/sec
  - [ ] Cold start p99 <2s
- [ ] **Error Rate Validation**: SST error rate ‚â§ ECS baseline for 7 consecutive days
  - [ ] 5xx error rate <1%
  - [ ] No critical CloudWatch alarms
- [ ] **Cost Validation**: SST cost ‚â§ ECS cost for 7 consecutive days
  - [ ] Lambda costs within budget
  - [ ] Total infrastructure cost <$800/month
- [ ] **Database Validation**: All data migrated successfully
  - [ ] Record count matches between ECS and SST
  - [ ] Data integrity checks pass
  - [ ] No missing foreign key references
- [ ] **Monitoring Validation**: SST monitoring fully operational
  - [ ] CloudWatch dashboards displaying metrics
  - [ ] CloudWatch alarms configured and tested
  - [ ] X-Ray tracing capturing requests
  - [ ] Slack notifications working

---

## Phase 2: ECS Service Scale-Down (Day 1)

- [ ] **Backup ECS Configuration**: Export task definitions, service definitions, autoscaling policies
- [ ] **Scale ECS to 0 Tasks**: Update ECS service desired count to 0
  - [ ] Verify all ECS tasks terminated
  - [ ] Verify no production impact
- [ ] **Monitor for 7 Days**: Ensure SST handles 100% traffic without issues
  - [ ] Daily performance checks
  - [ ] Daily error rate checks
  - [ ] Daily cost checks
- [ ] **Document Rollback Steps**: Update rollback runbook with current state

---

## Phase 3: DNS Cleanup (Day 8)

- [ ] **Remove ECS DNS Records**: Delete Route53 weighted routing records for ECS
  - [ ] Remove ECS ALB A record
  - [ ] Remove ECS service discovery records
- [ ] **Verify DNS Propagation**: Confirm api.lego-mocs.com resolves to SST only
- [ ] **Monitor for 7 Days**: Ensure no DNS-related issues

---

## Phase 4: CloudWatch Alarms Update (Day 8)

- [ ] **Remove ECS Alarms**: Delete CloudWatch alarms for ECS service
  - [ ] ECS service CPU alarm
  - [ ] ECS service memory alarm
  - [ ] ECS task count alarm
  - [ ] ALB target health alarm
- [ ] **Verify SST Alarms**: Ensure all SST alarms operational
  - [ ] Lambda error alarms
  - [ ] API Gateway 5xx alarms
  - [ ] RDS alarms
  - [ ] Redis alarms
  - [ ] OpenSearch alarms

---

## Phase 5: Final Resource Cleanup (Day 30)

- [ ] **Delete ECS Service**: Remove ECS service from cluster
- [ ] **Delete ECS Task Definitions**: Deregister all task definition versions
- [ ] **Delete ECS Cluster**: Remove ECS cluster
- [ ] **Delete Application Load Balancer**: Remove ALB and target groups
- [ ] **Delete ECS Security Groups**: Remove security groups (verify no dependencies)
- [ ] **Delete ECS IAM Roles**: Remove IAM roles and policies (verify no dependencies)
- [ ] **Delete ECS CloudWatch Log Groups**: Remove log groups (archive if needed)
- [ ] **Delete Unused ECR Repositories**: Remove Docker image repositories (archive if needed)
- [ ] **Verify Cost Reduction**: Confirm monthly cost reduced by ~$250

---

## Phase 6: Documentation & Reporting (Day 30)

- [ ] **Generate Decommission Report**: Document final costs, performance, lessons learned
- [ ] **Update Architecture Diagrams**: Remove ECS from diagrams, show SST-only architecture
- [ ] **Archive ECS Configuration**: Store task definitions, service configs in Git for reference
- [ ] **Update Runbooks**: Remove ECS references, update with SST-only procedures
- [ ] **Celebrate**: Migration complete! üéâ

---

## Rollback Plan (Emergency Only)

**Trigger**: Critical production issue requiring immediate ECS restoration

**Steps**:
1. Scale ECS service desired count to 2 (minimum for HA)
2. Wait 3-5 minutes for tasks to start
3. Update Route53 weighted routing: 100% ECS, 0% SST
4. Wait 60 seconds for DNS propagation
5. Verify traffic flowing to ECS
6. Investigate SST issue
7. Fix SST issue
8. Shift traffic back to SST (0% ‚Üí 10% ‚Üí 50% ‚Üí 100%)

**Estimated Rollback Time**: 10-15 minutes
```

### Pre-Decommission Validation Script

```bash
#!/bin/bash
# scripts/validate-pre-decommission.sh

set -e

echo "üîç Starting pre-decommission validation..."

# Step 1: Verify 100% traffic on SST
echo "1Ô∏è‚É£ Validating Route53 traffic split..."
BLUE_WEIGHT=$(aws route53 list-resource-record-sets \
  --hosted-zone-id "$HOSTED_ZONE_ID" \
  --query "ResourceRecordSets[?Name=='api.lego-mocs.com.' && SetIdentifier=='blue'].Weight | [0]" \
  --output text)

if [ "$BLUE_WEIGHT" != "0" ]; then
  echo "‚ùå VALIDATION FAILED: ECS still receiving traffic (weight: $BLUE_WEIGHT)"
  exit 1
fi

echo "‚úÖ Traffic validation passed: 100% on SST"

# Step 2: Validate performance metrics (7-day average)
echo "2Ô∏è‚É£ Validating performance metrics (7-day average)..."
END_TIME=$(date -u +%Y-%m-%dT%H:%M:%S)
START_TIME=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%S)

RESPONSE_TIME_P95=$(aws cloudwatch get-metric-statistics \
  --namespace AWS/ApiGateway \
  --metric-name Latency \
  --dimensions Name=ApiId,Value="$SST_API_ID" \
  --statistics p95 \
  --start-time "$START_TIME" \
  --end-time "$END_TIME" \
  --period 604800 \
  --query 'Datapoints[0].p95' \
  --output text)

if (( $(echo "$RESPONSE_TIME_P95 > 500" | bc -l) )); then
  echo "‚ùå VALIDATION FAILED: Response time p95 ($RESPONSE_TIME_P95 ms) exceeds threshold (500 ms)"
  exit 1
fi

echo "‚úÖ Performance validation passed: p95 latency $RESPONSE_TIME_P95 ms"

# Step 3: Validate error rate (7-day average)
echo "3Ô∏è‚É£ Validating error rate (7-day average)..."
ERROR_COUNT=$(aws cloudwatch get-metric-statistics \
  --namespace AWS/ApiGateway \
  --metric-name 5XXError \
  --dimensions Name=ApiId,Value="$SST_API_ID" \
  --statistics Sum \
  --start-time "$START_TIME" \
  --end-time "$END_TIME" \
  --period 604800 \
  --query 'Datapoints[0].Sum' \
  --output text)

REQUEST_COUNT=$(aws cloudwatch get-metric-statistics \
  --namespace AWS/ApiGateway \
  --metric-name Count \
  --dimensions Name=ApiId,Value="$SST_API_ID" \
  --statistics Sum \
  --start-time "$START_TIME" \
  --end-time "$END_TIME" \
  --period 604800 \
  --query 'Datapoints[0].Sum' \
  --output text)

ERROR_RATE=$(echo "scale=2; ($ERROR_COUNT / $REQUEST_COUNT) * 100" | bc)

if (( $(echo "$ERROR_RATE > 1" | bc -l) )); then
  echo "‚ùå VALIDATION FAILED: Error rate ($ERROR_RATE%) exceeds threshold (1%)"
  exit 1
fi

echo "‚úÖ Error rate validation passed: $ERROR_RATE%"

# Step 4: Validate cost (7-day projection)
echo "4Ô∏è‚É£ Validating cost (7-day projection)..."
SEVEN_DAY_COST=$(aws ce get-cost-and-usage \
  --time-period Start="$(date -u -d '7 days ago' +%Y-%m-%d)",End="$(date -u +%Y-%m-%d)" \
  --granularity DAILY \
  --metrics "UnblendedCost" \
  --filter file://sst-cost-filter.json \
  --query 'ResultsByTime[*].Total.UnblendedCost.Amount' \
  --output text | awk '{s+=$1} END {print s}')

MONTHLY_PROJECTION=$(echo "scale=2; ($SEVEN_DAY_COST / 7) * 30" | bc)

if (( $(echo "$MONTHLY_PROJECTION > 800" | bc -l) )); then
  echo "‚ùå VALIDATION FAILED: Projected monthly cost (\$$MONTHLY_PROJECTION) exceeds budget (\$800)"
  exit 1
fi

echo "‚úÖ Cost validation passed: Projected monthly cost \$$MONTHLY_PROJECTION"

# Step 5: Validate database integrity
echo "5Ô∏è‚É£ Validating database integrity..."
node scripts/validate-database-migration.js

if [ $? -ne 0 ]; then
  echo "‚ùå VALIDATION FAILED: Database integrity check failed"
  exit 1
fi

echo "‚úÖ Database validation passed"

echo ""
echo "‚úÖ‚úÖ‚úÖ ALL PRE-DECOMMISSION VALIDATIONS PASSED ‚úÖ‚úÖ‚úÖ"
echo ""
echo "Safe to proceed with ECS decommission."
```

### Database Integrity Validation Script

```typescript
// scripts/validate-database-migration.ts
import { db } from '@/lib/db/client'
import { mocInstructions, galleryImages, wishlistItems, mocFiles } from '@/db/schema'

async function validateDatabaseIntegrity() {
  console.log('Validating database integrity...')

  // Check MOC Instructions
  const mocCount = await db.select({ count: sql`COUNT(*)` }).from(mocInstructions)
  console.log(`MOC Instructions: ${mocCount[0].count} records`)

  // Check Gallery Images
  const galleryCount = await db.select({ count: sql`COUNT(*)` }).from(galleryImages)
  console.log(`Gallery Images: ${galleryCount[0].count} records`)

  // Check Wishlist Items
  const wishlistCount = await db.select({ count: sql`COUNT(*)` }).from(wishlistItems)
  console.log(`Wishlist Items: ${wishlistCount[0].count} records`)

  // Check MOC Files
  const filesCount = await db.select({ count: sql`COUNT(*)` }).from(mocFiles)
  console.log(`MOC Files: ${filesCount[0].count} records`)

  // Validate foreign key integrity
  const orphanedGalleryImages = await db.execute(sql`
    SELECT COUNT(*) as count
    FROM gallery_images gi
    LEFT JOIN users u ON gi.user_id = u.id
    WHERE u.id IS NULL
  `)

  if (orphanedGalleryImages.rows[0].count > 0) {
    console.error(`‚ùå Found ${orphanedGalleryImages.rows[0].count} orphaned gallery images`)
    process.exit(1)
  }

  const orphanedMocFiles = await db.execute(sql`
    SELECT COUNT(*) as count
    FROM moc_files mf
    LEFT JOIN moc_instructions mi ON mf.moc_id = mi.id
    WHERE mi.id IS NULL
  `)

  if (orphanedMocFiles.rows[0].count > 0) {
    console.error(`‚ùå Found ${orphanedMocFiles.rows[0].count} orphaned MOC files`)
    process.exit(1)
  }

  console.log('‚úÖ Database integrity validation passed')
}

validateDatabaseIntegrity()
```

### ECS Service Scale-Down Script

```bash
#!/bin/bash
# scripts/scale-down-ecs.sh

set -e

ECS_CLUSTER="lego-api-production"
ECS_SERVICE="lego-api-service"

echo "‚ö†Ô∏è WARNING: This will scale the ECS service to 0 tasks."
echo "Ensure 100% traffic is on SST before proceeding."
read -p "Press Enter to continue, or Ctrl+C to abort: "

# Backup current ECS configuration
echo "üì¶ Backing up current ECS configuration..."
aws ecs describe-services \
  --cluster "$ECS_CLUSTER" \
  --services "$ECS_SERVICE" \
  > backups/ecs-service-config-$(date +%Y%m%d).json

# Scale down to 0 tasks
echo "‚¨áÔ∏è Scaling ECS service to 0 tasks..."
aws ecs update-service \
  --cluster "$ECS_CLUSTER" \
  --service "$ECS_SERVICE" \
  --desired-count 0

# Wait for tasks to terminate
echo "‚è≥ Waiting for tasks to terminate..."
aws ecs wait services-stable \
  --cluster "$ECS_CLUSTER" \
  --services "$ECS_SERVICE"

# Verify 0 running tasks
RUNNING_COUNT=$(aws ecs describe-services \
  --cluster "$ECS_CLUSTER" \
  --services "$ECS_SERVICE" \
  --query 'services[0].runningCount' \
  --output text)

if [ "$RUNNING_COUNT" != "0" ]; then
  echo "‚ùå ERROR: ECS service still has $RUNNING_COUNT running tasks"
  exit 1
fi

echo "‚úÖ ECS service scaled to 0 tasks successfully"
echo "üîç Monitor SST performance for 7 days before proceeding with final cleanup"
```

### Final Cleanup Script

```bash
#!/bin/bash
# scripts/cleanup-ecs-resources.sh

set -e

ECS_CLUSTER="lego-api-production"
ECS_SERVICE="lego-api-service"
ALB_NAME="lego-api-alb"

echo "‚ö†Ô∏è WARNING: This will DELETE all ECS resources permanently."
echo "Ensure 7-day observation period has passed with no issues."
read -p "Type 'DELETE' to confirm: " CONFIRM

if [ "$CONFIRM" != "DELETE" ]; then
  echo "Aborted."
  exit 0
fi

# Step 1: Delete ECS service
echo "1Ô∏è‚É£ Deleting ECS service..."
aws ecs delete-service \
  --cluster "$ECS_CLUSTER" \
  --service "$ECS_SERVICE" \
  --force

# Step 2: Wait for service deletion
echo "‚è≥ Waiting for service deletion..."
sleep 30

# Step 3: Deregister task definitions
echo "2Ô∏è‚É£ Deregistering task definitions..."
TASK_DEFS=$(aws ecs list-task-definitions \
  --family-prefix lego-api \
  --query 'taskDefinitionArns' \
  --output text)

for task_def in $TASK_DEFS; do
  echo "Deregistering $task_def..."
  aws ecs deregister-task-definition --task-definition "$task_def"
done

# Step 4: Delete ECS cluster
echo "3Ô∏è‚É£ Deleting ECS cluster..."
aws ecs delete-cluster --cluster "$ECS_CLUSTER"

# Step 5: Delete Application Load Balancer
echo "4Ô∏è‚É£ Deleting Application Load Balancer..."
ALB_ARN=$(aws elbv2 describe-load-balancers \
  --names "$ALB_NAME" \
  --query 'LoadBalancers[0].LoadBalancerArn' \
  --output text)

aws elbv2 delete-load-balancer --load-balancer-arn "$ALB_ARN"

# Step 6: Delete target groups
echo "5Ô∏è‚É£ Deleting target groups..."
TARGET_GROUPS=$(aws elbv2 describe-target-groups \
  --query "TargetGroups[?contains(TargetGroupName, 'lego-api')].TargetGroupArn" \
  --output text)

for tg in $TARGET_GROUPS; do
  echo "Deleting $tg..."
  aws elbv2 delete-target-group --target-group-arn "$tg"
done

# Step 7: Delete security groups
echo "6Ô∏è‚É£ Deleting security groups..."
# (Manual verification recommended to avoid deleting shared security groups)
echo "‚ö†Ô∏è Security group deletion requires manual verification."
echo "List security groups with: aws ec2 describe-security-groups --filters Name=group-name,Values=lego-api*"

# Step 8: Delete IAM roles
echo "7Ô∏è‚É£ Deleting IAM roles..."
# (Manual verification recommended to avoid deleting shared roles)
echo "‚ö†Ô∏è IAM role deletion requires manual verification."
echo "List roles with: aws iam list-roles --query 'Roles[?contains(RoleName, \`lego-api-ecs\`)]'"

# Step 9: Delete CloudWatch log groups
echo "8Ô∏è‚É£ Deleting CloudWatch log groups..."
LOG_GROUPS=$(aws logs describe-log-groups \
  --log-group-name-prefix /ecs/lego-api \
  --query 'logGroups[*].logGroupName' \
  --output text)

for log_group in $LOG_GROUPS; do
  echo "Deleting $log_group..."
  aws logs delete-log-group --log-group-name "$log_group"
done

echo ""
echo "‚úÖ ECS resources cleanup complete!"
echo "üìä Verify cost reduction in AWS Cost Explorer in 7 days."
```

### Rollback Runbook

```markdown
# ECS Rollback Runbook (Emergency Only)

**Last Updated**: 2025-01-15
**Owner**: DevOps Team

---

## When to Use This Runbook

**ONLY use this runbook in emergency situations where:**
- SST is experiencing critical production issues
- Error rate >5% for >5 minutes
- Multiple CloudWatch alarms firing
- Complete service outage

**DO NOT use this runbook for:**
- Minor performance issues (investigate first)
- Isolated errors (debug with X-Ray)
- Cost concerns (not a production emergency)

---

## Pre-Rollback Checklist

- [ ] Confirm SST is causing production issues (not infrastructure)
- [ ] Notify stakeholders in #incidents Slack channel
- [ ] Have at least 2 DevOps engineers on call

---

## Rollback Steps (Execute in Order)

### Step 1: Scale ECS Service (ETA: 5 minutes)

```bash
aws ecs update-service \
  --cluster lego-api-production \
  --service lego-api-service \
  --desired-count 2
```

**Expected Result**: ECS tasks start launching

### Step 2: Wait for ECS Tasks to be Healthy (ETA: 3 minutes)

```bash
aws ecs wait services-stable \
  --cluster lego-api-production \
  --services lego-api-service
```

**Expected Result**: 2 healthy tasks running

### Step 3: Shift 100% Traffic to ECS (ETA: 2 minutes)

```bash
aws route53 change-resource-record-sets \
  --hosted-zone-id Z1234567890ABC \
  --change-batch file://traffic-shift-ecs-100.json
```

**Expected Result**: Route53 change submitted

### Step 4: Verify Traffic Flow (ETA: 1 minute)

```bash
# Wait for DNS propagation
sleep 60

# Test API endpoint
curl -I https://api.lego-mocs.com/health
```

**Expected Result**: HTTP 200 from ECS

### Step 5: Monitor ECS Performance (ETA: 5 minutes)

- Open CloudWatch dashboard
- Verify error rate <1%
- Verify response time p95 <500ms
- Verify no CloudWatch alarms firing

---

## Post-Rollback Actions

1. **Create incident report** in Confluence
2. **Root cause analysis** for SST issue
3. **Fix SST issue** before attempting cutover again
4. **Test SST fix** in staging environment
5. **Schedule new cutover** after fixes validated

---

## Rollback Contacts

- **Primary**: DevOps Team Lead
- **Secondary**: Engineering Manager
- **Escalation**: CTO
```

### Final Decommission Report Template

```markdown
# ECS Service Decommission - Final Report

**Date**: 2025-02-15
**Executed By**: DevOps Team
**Status**: ‚úÖ COMPLETE

---

## Executive Summary

The ECS service was successfully decommissioned after 30 days of SST operating at 100% production traffic with no issues. Total cost savings: **$250/month (26% reduction)**.

---

## Timeline

| Date | Phase | Action | Status |
|------|-------|--------|--------|
| 2025-01-15 | Pre-Validation | Traffic, performance, cost, database validation | ‚úÖ PASS |
| 2025-01-16 | Scale-Down | ECS scaled to 0 tasks | ‚úÖ COMPLETE |
| 2025-01-16-23 | Observation | 7-day monitoring of SST at 100% traffic | ‚úÖ NO ISSUES |
| 2025-01-24 | DNS Cleanup | Removed ECS Route53 records | ‚úÖ COMPLETE |
| 2025-01-24 | Alarms Update | Removed ECS CloudWatch alarms | ‚úÖ COMPLETE |
| 2025-02-15 | Final Cleanup | Deleted ECS cluster, ALB, task definitions | ‚úÖ COMPLETE |

---

## Performance Comparison (30-Day Average)

| Metric | ECS Baseline | SST Production | Change |
|--------|--------------|----------------|--------|
| Response Time (p95) | 450ms | 380ms | -15% |
| Response Time (p99) | 800ms | 650ms | -19% |
| Throughput | 166 req/sec | 150 req/sec | -10% |
| Error Rate | 0.5% | 0.3% | -40% |
| Uptime | 99.9% | 99.95% | +0.05% |

---

## Cost Comparison (Monthly)

| Service | ECS Cost | SST Cost | Savings |
|---------|----------|----------|---------|
| Compute | $450 | $180 | $270 |
| Database | $200 | $200 | $0 |
| Cache | $100 | $100 | $0 |
| Search | $150 | $150 | $0 |
| Storage | $50 | $50 | $0 |
| API Gateway | N/A | $20 | -$20 |
| **Total** | **$950** | **$700** | **$250** |

**Annual Savings**: $3,000

---

## Lessons Learned

**What Went Well**:
- Blue/Green deployment allowed zero-downtime cutover
- 30-day observation period provided high confidence
- Cost savings exceeded projections (26% vs 20% target)
- Performance improved despite lower throughput

**What Could Be Improved**:
- Database migration took longer than expected (add 2 weeks buffer)
- Cold start optimization should have been done earlier
- S3 lifecycle policies should have been configured pre-migration

**Recommendations for Future Migrations**:
- Use provisioned concurrency for latency-sensitive Lambdas
- Implement cost monitoring from day 1
- Add performance regression tests to CI/CD earlier

---

## Resources Deleted

- ‚úÖ ECS Service: lego-api-service
- ‚úÖ ECS Cluster: lego-api-production
- ‚úÖ Task Definitions: 15 versions deregistered
- ‚úÖ Application Load Balancer: lego-api-alb
- ‚úÖ Target Groups: 2 deleted
- ‚úÖ Security Groups: 3 deleted
- ‚úÖ IAM Roles: 2 deleted
- ‚úÖ CloudWatch Log Groups: 5 deleted
- ‚úÖ Route53 Records: 2 deleted

---

## Verification

**Cost Reduction Confirmed**: AWS Cost Explorer shows $250/month savings starting February 2025.

**No Production Impact**: Zero user-reported issues during decommission.

**Monitoring Operational**: SST CloudWatch dashboards, alarms, and X-Ray tracing fully operational.

---

## Sign-Off

- [x] DevOps Lead - John Doe
- [x] Engineering Manager - Jane Smith
- [x] Product Owner - Bob Johnson

**Approved on**: 2025-02-15

**Status**: Migration COMPLETE üéâ
```

---

## Design Decisions

### 30-Day Observation Period

**Decision**: Wait 30 days after scaling ECS to 0 before deleting resources

**Rationale**:
- Provides ample time to identify edge cases or seasonal traffic patterns
- Allows quick rollback if critical issues discovered
- Low cost to retain idle ECS cluster (no compute charges)
- Industry best practice for infrastructure migrations

**Alternative Considered**: 7-day observation period (rejected as too short)

### Scale to 0 (Not Delete) Initially

**Decision**: Scale ECS to 0 tasks instead of deleting service immediately

**Rationale**:
- Fast rollback (<15 minutes) if needed
- Preserves ECS configuration (task definitions, autoscaling policies)
- No cost for idle ECS service (only compute charges for running tasks)
- Provides safety net during observation period

### Database Integrity Validation

**Decision**: Automated script to validate database integrity before decommission

**Rationale**:
- Ensures no data loss during migration
- Validates foreign key integrity
- Confirms record counts match expectations
- Prevents decommissioning ECS with missing data

---

## Error Scenarios

| Scenario | Resolution |
|----------|------------|
| Critical issue discovered during observation | Execute rollback runbook, restore ECS service |
| Database integrity check fails | Investigate missing records, re-run migration if needed |
| Cost unexpectedly high | Analyze Cost Explorer, optimize Lambda memory/timeout |
| ECS deletion fails (dependencies) | Manually identify and remove dependencies (security groups, IAM roles) |

---

## Performance Considerations

1. **Rollback Time**: <15 minutes (ECS task startup + DNS propagation)
2. **Observation Period**: 30 days (allows detection of monthly patterns)
3. **Resource Deletion**: Phased over 30 days (minimizes risk)

---

## Dependencies

- **Story 5.5**: Blue/Green Deployment - Traffic shifting mechanism
- **Story 5.6**: Performance Validation - Pre-decommission validation
- **Story 5.7**: Cost Monitoring - Cost comparison and validation
- **All Epic 1-4 Stories**: SST infrastructure must be fully operational

---

## Future Enhancements

1. **Automated Decommission**: Script to execute entire decommission process
2. **Rollback Automation**: One-click rollback to ECS if critical issue detected
3. **Cost Tracking**: Automated reporting of cost savings post-decommission
4. **Decommission Checklist Tool**: Interactive checklist with validation gates

---

## Related Stories

- **Story 5.5**: Blue/Green Deployment - Enables safe traffic shifting
- **Story 5.6**: Performance Validation - Validates SST ready for 100% traffic
- **Story 5.7**: Cost Monitoring - Validates cost savings achieved
