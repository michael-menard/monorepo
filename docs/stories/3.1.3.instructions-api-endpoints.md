# Story 3.1.3: Instructions Gallery API Endpoints

## Status

Draft

## Story

**As a** developer,
**I want** API endpoints for fetching instructions,
**so that** the gallery can display real data.

## Acceptance Criteria

1. ⬜ GET /api/instructions - list with pagination
2. ⬜ GET /api/instructions/:id - single instruction detail
3. ⬜ Search by name/description supported
4. ⬜ Filter by tags supported
5. ⬜ Filter by theme supported
6. ⬜ Sort by name, date, piece count supported
7. ⬜ RTK Query hooks generated

## Tasks / Subtasks

- [ ] **Task 1: Backend API Routes**
  - [ ] Create GET /api/instructions route
  - [ ] Create GET /api/instructions/:id route
  - [ ] Implement query parameter parsing

- [ ] **Task 2: Query Parameters**
  - [ ] `q` - search query (name, description)
  - [ ] `tags` - comma-separated tag filter
  - [ ] `theme` - theme filter
  - [ ] `sort` - field to sort by
  - [ ] `order` - asc/desc
  - [ ] `page` - page number
  - [ ] `limit` - items per page

- [ ] **Task 3: Database Query**
  - [ ] Build Drizzle query with filters
  - [ ] Add text search on name/description
  - [ ] Add pagination with total count

- [ ] **Task 4: RTK Query Integration**
  - [ ] Create instructionsApi slice
  - [ ] Define useGetInstructionsQuery hook
  - [ ] Define useGetInstructionByIdQuery hook
  - [ ] Configure caching/invalidation

## Dev Notes

### API Response Shape

```typescript
// GET /api/instructions?q=castle&tags=medieval&sort=pieceCount&order=desc&page=1&limit=20

interface InstructionsListResponse {
  items: Instruction[]
  pagination: {
    page: number
    limit: number
    total: number
    totalPages: number
  }
  filters: {
    availableTags: string[]
    availableThemes: string[]
  }
}

interface Instruction {
  id: string
  name: string
  description?: string
  thumbnail: string
  images: string[]
  pieceCount: number
  theme: string
  tags: string[]
  pdfUrl?: string
  createdAt: string
  updatedAt: string
  isFavorite: boolean
}
```

### RTK Query Slice

```typescript
// services/instructionsApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'

interface GetInstructionsParams {
  search?: string
  tags?: string[]
  theme?: string | null
  sort?: string
  order?: 'asc' | 'desc'
  page?: number
  limit?: number
}

export const instructionsApi = createApi({
  reducerPath: 'instructionsApi',
  baseQuery: fetchBaseQuery({ baseUrl: '/api' }),
  tagTypes: ['Instruction'],
  endpoints: (builder) => ({
    getInstructions: builder.query<InstructionsListResponse, GetInstructionsParams>({
      query: (params) => ({
        url: '/instructions',
        params: {
          q: params.search,
          tags: params.tags?.join(','),
          theme: params.theme,
          sort: params.sort,
          order: params.order,
          page: params.page,
          limit: params.limit,
        },
      }),
      providesTags: (result) =>
        result
          ? [
              ...result.items.map(({ id }) => ({ type: 'Instruction' as const, id })),
              { type: 'Instruction', id: 'LIST' },
            ]
          : [{ type: 'Instruction', id: 'LIST' }],
    }),
    getInstructionById: builder.query<Instruction, string>({
      query: (id) => `/instructions/${id}`,
      providesTags: (result, error, id) => [{ type: 'Instruction', id }],
    }),
  }),
})

export const { useGetInstructionsQuery, useGetInstructionByIdQuery } = instructionsApi
```

### Backend Handler (Serverless)

```typescript
// apps/api/src/handlers/instructions/list.ts
export const handler = async (event: APIGatewayProxyEvent) => {
  const { q, tags, theme, sort, order, page, limit } = event.queryStringParameters ?? {}

  const query = db
    .select()
    .from(instructions)
    .where(
      and(
        q ? or(
          like(instructions.name, `%${q}%`),
          like(instructions.description, `%${q}%`)
        ) : undefined,
        tags ? inArray(instructions.tags, tags.split(',')) : undefined,
        theme ? eq(instructions.theme, theme) : undefined
      )
    )
    .orderBy(sort === 'name' ? instructions.name : instructions.createdAt)
    .limit(parseInt(limit ?? '20'))
    .offset((parseInt(page ?? '1') - 1) * parseInt(limit ?? '20'))

  const items = await query
  const total = await db.select({ count: count() }).from(instructions)

  return {
    statusCode: 200,
    body: JSON.stringify({
      items,
      pagination: {
        page: parseInt(page ?? '1'),
        limit: parseInt(limit ?? '20'),
        total: total[0].count,
        totalPages: Math.ceil(total[0].count / parseInt(limit ?? '20')),
      },
    }),
  }
}
```

## Testing

- [ ] API test: GET /instructions returns paginated list
- [ ] API test: search filter works
- [ ] API test: tag filter works
- [ ] API test: theme filter works
- [ ] API test: sort works
- [ ] Unit test: RTK Query hooks work correctly

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-30 | 0.1     | Initial draft | SM Agent |
