# Story 3.1.3: Instructions Gallery API Endpoints

## Status

Ready for Review

## Story

**As a** developer,
**I want** API endpoints for fetching instructions,
**so that** the gallery can display real data.

## Acceptance Criteria

1. ✅ GET /api/instructions - list with pagination (via /api/v2/mocs/search)
2. ✅ GET /api/instructions/:id - single instruction detail (via /api/v2/mocs/{id})
3. ✅ Search by name/description supported (q parameter)
4. ✅ Filter by tags supported (tags parameter)
5. ✅ Filter by theme supported (theme parameter)
6. ✅ Sort by name, date, piece count supported (sort/order parameters)
7. ✅ RTK Query hooks generated

## Tasks / Subtasks

- [x] **Task 1: Backend API Routes** (Pre-existing in /api/v2/mocs)
  - [x] GET /api/v2/mocs/search route exists
  - [x] GET /api/v2/mocs/{id} route exists
  - [x] Query parameter parsing implemented

- [x] **Task 2: Query Parameters** (Implemented in RTK Query)
  - [x] `q` - search query (name, description)
  - [x] `tags` - comma-separated tag filter
  - [x] `theme` - theme filter
  - [x] `sort` - field to sort by (name, createdAt, pieceCount)
  - [x] `order` - asc/desc
  - [x] `page` - page number
  - [x] `limit` - items per page

- [x] **Task 3: Database Query** (Pre-existing backend)
  - [x] Backend queries with filters at /api/mocs endpoints
  - [x] Text search on name/description
  - [x] Pagination with total count

- [x] **Task 4: RTK Query Integration**
  - [x] Create instructionsApi slice
  - [x] Define useGetInstructionsQuery hook
  - [x] Define useGetInstructionByIdQuery hook
  - [x] Configure caching/invalidation
  - [x] Add toggleInstructionFavorite mutation

## Dev Notes

### API Response Shape

```typescript
// GET /api/instructions?q=castle&tags=medieval&sort=pieceCount&order=desc&page=1&limit=20

interface InstructionsListResponse {
  items: Instruction[]
  pagination: {
    page: number
    limit: number
    total: number
    totalPages: number
  }
  filters: {
    availableTags: string[]
    availableThemes: string[]
  }
}

interface Instruction {
  id: string
  name: string
  description?: string
  thumbnail: string
  images: string[]
  pieceCount: number
  theme: string
  tags: string[]
  pdfUrl?: string
  createdAt: string
  updatedAt: string
  isFavorite: boolean
}
```

### RTK Query Slice

```typescript
// services/instructionsApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'

interface GetInstructionsParams {
  search?: string
  tags?: string[]
  theme?: string | null
  sort?: string
  order?: 'asc' | 'desc'
  page?: number
  limit?: number
}

export const instructionsApi = createApi({
  reducerPath: 'instructionsApi',
  baseQuery: fetchBaseQuery({ baseUrl: '/api' }),
  tagTypes: ['Instruction'],
  endpoints: builder => ({
    getInstructions: builder.query<InstructionsListResponse, GetInstructionsParams>({
      query: params => ({
        url: '/instructions',
        params: {
          q: params.search,
          tags: params.tags?.join(','),
          theme: params.theme,
          sort: params.sort,
          order: params.order,
          page: params.page,
          limit: params.limit,
        },
      }),
      providesTags: result =>
        result
          ? [
              ...result.items.map(({ id }) => ({ type: 'Instruction' as const, id })),
              { type: 'Instruction', id: 'LIST' },
            ]
          : [{ type: 'Instruction', id: 'LIST' }],
    }),
    getInstructionById: builder.query<Instruction, string>({
      query: id => `/instructions/${id}`,
      providesTags: (result, error, id) => [{ type: 'Instruction', id }],
    }),
  }),
})

export const { useGetInstructionsQuery, useGetInstructionByIdQuery } = instructionsApi
```

### Backend Handler (Serverless)

```typescript
// apps/api/src/handlers/instructions/list.ts
export const handler = async (event: APIGatewayProxyEvent) => {
  const { q, tags, theme, sort, order, page, limit } = event.queryStringParameters ?? {}

  const query = db
    .select()
    .from(instructions)
    .where(
      and(
        q
          ? or(like(instructions.name, `%${q}%`), like(instructions.description, `%${q}%`))
          : undefined,
        tags ? inArray(instructions.tags, tags.split(',')) : undefined,
        theme ? eq(instructions.theme, theme) : undefined,
      ),
    )
    .orderBy(sort === 'name' ? instructions.name : instructions.createdAt)
    .limit(parseInt(limit ?? '20'))
    .offset((parseInt(page ?? '1') - 1) * parseInt(limit ?? '20'))

  const items = await query
  const total = await db.select({ count: count() }).from(instructions)

  return {
    statusCode: 200,
    body: JSON.stringify({
      items,
      pagination: {
        page: parseInt(page ?? '1'),
        limit: parseInt(limit ?? '20'),
        total: total[0].count,
        totalPages: Math.ceil(total[0].count / parseInt(limit ?? '20')),
      },
    }),
  }
}
```

## Testing

- [x] Unit test: RTK Query API creation
- [x] Unit test: All endpoints defined correctly
- [x] Unit test: Hooks exported correctly
- [x] Unit test: Store integration works
- [x] Unit test: Parameters accepted correctly
- [ ] API test: GET /instructions returns paginated list (requires E2E test)
- [ ] API test: search filter works (requires E2E test)
- [ ] API test: tag filter works (requires E2E test)
- [ ] API test: theme filter works (requires E2E test)
- [ ] API test: sort works (requires E2E test)

## Change Log

| Date       | Version | Description                       | Author    |
| ---------- | ------- | --------------------------------- | --------- |
| 2025-11-30 | 0.1     | Initial draft                     | SM Agent  |
| 2025-12-05 | 1.0     | RTK Query implementation complete | Dev Agent |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

N/A

### Completion Notes

- Created `instructions-api.ts` RTK Query slice in `@repo/api-client/src/rtk/`
- Added Zod schemas for Instruction, InstructionsListResponse, InstructionDetailResponse to `api-responses.ts`
- Hooks: `useGetInstructionsQuery`, `useLazyGetInstructionsQuery`, `useGetInstructionByIdQuery`, `useLazyGetInstructionByIdQuery`, `useToggleInstructionFavoriteMutation`
- Uses existing `/api/v2/mocs/*` backend endpoints (defined in `SERVERLESS_ENDPOINTS.MOC`)
- Configured with serverless caching (medium for lists, long for details)
- Optimistic updates for favorite toggle
- 25 unit tests passing

### File List

- `packages/core/api-client/src/rtk/instructions-api.ts` - New: RTK Query slice with hooks
- `packages/core/api-client/src/types/api-responses.ts` - Modified: Added Instruction schemas
- `packages/core/api-client/package.json` - Modified: Added instructions-api export
- `packages/core/api-client/src/test/instructions-api.test.ts` - New: 25 unit tests
