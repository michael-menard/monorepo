# Story 3.1.29: Extract Upload Types Package

## GitHub Issue
- Issue: #249
- URL: https://github.com/michael-menard/monorepo/issues/249
- Status: Todo

## Status

Draft

## Story

**As a** developer,
**I want** shared upload types in `@repo/upload-types`,
**so that** edit and future upload features use consistent type definitions.

## Epic Context

This is **Story 0.2 of Epic 0: Package Extraction & Reuse Foundation**.

**Depends on:** Story 3.1.28 (DB Schema Migration)

## Acceptance Criteria

1. Create `packages/core/upload-types` with proper `package.json` and `tsconfig.json`
2. Move types from `apps/web/main-app/src/types/uploader-session.ts` and `uploader-upload.ts`
3. Export: `UploaderSession`, `FileCategory`, `UploadStatus`, `UploadErrorCode`, `UploaderFileItem`, `UploadBatchState`
4. Move slug utilities from `apps/api/core/utils/slug.ts`: `slugify`, `findAvailableSlug`
5. Update imports in main-app and API to use `@repo/upload-types`
6. All existing upload tests pass

## Tasks / Subtasks

- [ ] **Task 1: Create Package Structure** (AC: 1)
  - [ ] Create `packages/core/upload-types/` directory
  - [ ] Create `package.json` with name `@repo/upload-types`
  - [ ] Create `tsconfig.json` extending root config
  - [ ] Add package to `pnpm-workspace.yaml`

- [ ] **Task 2: Move Session/Upload Types** (AC: 2, 3)
  - [ ] Move `UploaderSession` schema/type from `apps/web/main-app/src/types/uploader-session.ts`
  - [ ] Move `FileCategory` enum/type
  - [ ] Move `UploadStatus` enum/type
  - [ ] Move `UploadErrorCode` enum/type
  - [ ] Move `UploaderFileItem` schema/type
  - [ ] Move `UploadBatchState` schema/type
  - [ ] Create `src/index.ts` with all exports (package boundary barrel is acceptable)

- [ ] **Task 3: Move Slug Utilities** (AC: 4)
  - [ ] Move `slugify` function from `apps/api/core/utils/slug.ts`
  - [ ] Move `findAvailableSlug` function
  - [ ] Create `src/slug.ts` for slug utilities
  - [ ] Export from package index

- [ ] **Task 4: Update Consumer Imports** (AC: 5)
  - [ ] Update `apps/web/main-app/` imports to use `@repo/upload-types`
  - [ ] Update `apps/api/` imports to use `@repo/upload-types`
  - [ ] Remove old type files from apps (delete or leave as re-exports temporarily)

- [ ] **Task 5: Verify Regression** (AC: 6)
  - [ ] Run `pnpm build` to verify TypeScript compilation
  - [ ] Run upload-related tests in main-app
  - [ ] Run upload-related tests in API

## Dev Notes

### Package Structure

```
packages/core/upload-types/
├── src/
│   ├── index.ts           # Package exports (barrel file OK at package boundary)
│   ├── session.ts         # Session-related types
│   ├── upload.ts          # Upload-related types
│   └── slug.ts            # Slug utilities
├── package.json
├── tsconfig.json
└── tsconfig.build.json
```

### package.json Template

```json
{
  "name": "@repo/upload-types",
  "version": "0.0.1",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts"
  },
  "scripts": {
    "build": "tsc -b tsconfig.build.json",
    "check-types": "tsc --noEmit"
  },
  "dependencies": {
    "zod": "workspace:*"
  }
}
```

### Types to Extract

From `apps/web/main-app/src/types/uploader-session.ts`:
- `UploaderSessionSchema` / `UploaderSession`
- `FileCategory` (instruction, image, parts-list, thumbnail)

From `apps/web/main-app/src/types/uploader-upload.ts`:
- `UploadStatus` (pending, uploading, completed, failed)
- `UploadErrorCode`
- `UploaderFileItemSchema` / `UploaderFileItem`
- `UploadBatchStateSchema` / `UploadBatchState`

From `apps/api/core/utils/slug.ts`:
- `slugify(title: string): string`
- `findAvailableSlug(baseSlug: string, existingSlugs: string[]): string`

### Import Update Pattern

```typescript
// Before
import { UploaderSession } from '@/types/uploader-session'
import { slugify } from '@/core/utils/slug'

// After
import { UploaderSession, slugify } from '@repo/upload-types'
```

### Why Package Extraction

- **Shared across features**: Upload, Edit, future Sets/Gallery/Profile uploads
- **Single source of truth**: Zod schemas define both types and validation
- **Consistent slug generation**: Same logic for upload and edit flows

## Testing

### Test Location
- `packages/core/upload-types/src/__tests__/` (new)
- Existing tests in `apps/web/main-app/` and `apps/api/`

### Test Requirements
- Unit: Zod schema validation tests for all exported schemas
- Unit: `slugify` and `findAvailableSlug` function tests
- Regression: All existing upload feature tests pass

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 0.1 | Initial draft from Edit MOC PRD | SM Agent |

## Dev Agent Record

### Agent Model Used

N/A

### Debug Log References

N/A

### Completion Notes

N/A

### File List

- `packages/core/upload-types/` - New package directory
- `packages/core/upload-types/package.json` - New
- `packages/core/upload-types/src/index.ts` - New
- `packages/core/upload-types/src/session.ts` - New
- `packages/core/upload-types/src/upload.ts` - New
- `packages/core/upload-types/src/slug.ts` - New
- `apps/web/main-app/src/types/uploader-session.ts` - Modified/Deleted
- `apps/web/main-app/src/types/uploader-upload.ts` - Modified/Deleted
- `apps/api/core/utils/slug.ts` - Modified/Deleted
- `pnpm-workspace.yaml` - Modified (add package)
