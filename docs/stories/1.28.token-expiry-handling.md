# Story 1.28: Token Expiry Handling

## Status

Approved

## Story

**As a** user,
**I want** my session to refresh automatically,
**so that** I don't get logged out unexpectedly.

## Acceptance Criteria

1. ⬜ Detect token expiring soon (5 min before expiry)
2. ⬜ Trigger Amplify token refresh
3. ⬜ Update Redux with new tokens
4. ⬜ Handle refresh failure gracefully
5. ⬜ Show notification if refresh fails

## Tasks / Subtasks

- [ ] **Task 1: Expiry Detection** (AC: 1)
  - [ ] Create token expiry watcher
  - [ ] Check expiry every minute
  - [ ] Trigger refresh at 5 min threshold

- [ ] **Task 2: Token Refresh** (AC: 2-3)
  - [ ] Use Amplify fetchAuthSession({ forceRefresh: true })
  - [ ] Dispatch updateTokens to Redux
  - [ ] Update auth context

- [ ] **Task 3: Error Handling** (AC: 4-5)
  - [ ] Catch refresh errors
  - [ ] Log out if refresh fails
  - [ ] Show toast notification

## Dev Notes

### Token Expiry Watcher

**File:** `apps/web/main-app/src/hooks/useTokenRefresh.ts`

```typescript
import { useEffect } from 'react'
import { fetchAuthSession } from '@aws-amplify/auth'
import { useAppDispatch, useAppSelector } from '@/store/hooks'
import { updateTokens, setUnauthenticated, selectAuth } from '@/store/slices/authSlice'
import { isTokenExpired, getTokenExpiration } from '@/lib/jwt'
import { useToast } from '@repo/ui'

const REFRESH_THRESHOLD_SECONDS = 5 * 60 // 5 minutes

export function useTokenRefresh() {
  const dispatch = useAppDispatch()
  const { isAuthenticated, tokens } = useAppSelector(selectAuth)
  const { toast } = useToast()

  useEffect(() => {
    if (!isAuthenticated || !tokens?.accessToken) return

    const checkAndRefresh = async () => {
      // Check if token expires within threshold
      if (isTokenExpired(tokens.accessToken!, REFRESH_THRESHOLD_SECONDS)) {
        try {
          const session = await fetchAuthSession({ forceRefresh: true })

          dispatch(
            updateTokens({
              accessToken: session.tokens?.accessToken?.toString(),
              idToken: session.tokens?.idToken?.toString(),
            }),
          )
        } catch (error) {
          logger.error('Token refresh failed', { error })
          toast({
            title: 'Session Expired',
            description: 'Please sign in again.',
            variant: 'destructive',
          })
          dispatch(setUnauthenticated())
        }
      }
    }

    // Check immediately
    checkAndRefresh()

    // Check every minute
    const interval = setInterval(checkAndRefresh, 60 * 1000)
    return () => clearInterval(interval)
  }, [isAuthenticated, tokens?.accessToken, dispatch, toast])
}
```

### Usage in App

```typescript
function App() {
  useTokenRefresh() // Hook at app level
  return <RouterProvider router={router} />
}
```

### Amplify Hub Listener Alternative

```typescript
Hub.listen('auth', ({ payload }) => {
  if (payload.event === 'tokenRefresh') {
    // Tokens were refreshed automatically
    const tokens = payload.data.tokens
    dispatch(
      updateTokens({
        accessToken: tokens.accessToken.toString(),
        idToken: tokens.idToken.toString(),
      }),
    )
  }
  if (payload.event === 'tokenRefresh_failure') {
    // Refresh failed
    dispatch(setUnauthenticated())
  }
})
```

### Testing

- Test expiry detection at threshold
- Test successful refresh updates state
- Test failed refresh logs out user
- Test notification shows on failure

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
