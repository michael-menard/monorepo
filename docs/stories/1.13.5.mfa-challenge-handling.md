# Story 1.13.5: MFA Challenge Handling

## Status

Ready for Review

## Story

**As a** user with MFA enabled on my account,
**I want** the login flow to properly detect and route MFA challenges,
**so that** I can complete multi-factor authentication seamlessly.

## Acceptance Criteria

1. ✅ Login detects MFA challenge from Cognito response
2. ✅ AuthProvider tracks current challenge state
3. ✅ Automatic redirect to /auth/otp-verification on MFA challenge
4. ✅ Challenge type passed to OTP page (SMS, TOTP, Email)
5. ✅ confirmSignIn properly resolves the challenge
6. ✅ Handle additional challenge steps if needed
7. ✅ Clear challenge state on success/cancel
8. ✅ Support for NEW_PASSWORD_REQUIRED challenge
9. ✅ Unit tests for challenge flow

## Tasks / Subtasks

- [x] **Task 1: Challenge Detection** (AC: 1)
  - [x] Parse signIn response for nextStep
  - [x] Identify challenge type from signInStep
  - [x] Handle CONFIRM_SIGN_IN_WITH_SMS_CODE
  - [x] Handle CONFIRM_SIGN_IN_WITH_TOTP_CODE
  - [x] Handle CONFIRM_SIGN_IN_WITH_EMAIL_CODE

- [x] **Task 2: AuthProvider State** (AC: 2, 7)
  - [x] currentChallenge state in AuthProvider (already implemented)
  - [x] setCurrentChallenge when challenge detected
  - [x] Clear challenge on success/cancel/timeout (clearChallenge function added)

- [x] **Task 3: Navigation** (AC: 3)
  - [x] Programmatic redirect from LoginPage to OTP page
  - [x] Pass challenge info via route state or context
  - [x] Handle back navigation

- [x] **Task 4: Challenge Resolution** (AC: 4, 5, 6)
  - [x] confirmSignIn calls Amplify confirmSignIn (already implemented)
  - [x] Handle multiple challenge steps
  - [x] Update auth state on success

- [x] **Task 5: Password Change Challenge** (AC: 8)
  - [x] Detect CONFIRM_SIGN_IN_WITH_NEW_PASSWORD_REQUIRED
  - [x] Create NewPasswordPage component
  - [x] Route to password change form
  - [x] Call confirmSignIn with newPassword

- [x] **Task 6: Testing** (AC: 9)
  - [x] Test challenge detection
  - [x] Test navigation flow
  - [x] Test confirmSignIn resolution
  - [x] Test multi-step challenges

## Dev Notes

### Cognito MFA Challenge Types

| Challenge Step                             | Description                  | Action Required          |
| ------------------------------------------ | ---------------------------- | ------------------------ |
| CONFIRM_SIGN_IN_WITH_SMS_CODE              | SMS MFA code sent            | Enter 6-digit SMS code   |
| CONFIRM_SIGN_IN_WITH_TOTP_CODE             | TOTP app code required       | Enter authenticator code |
| CONFIRM_SIGN_IN_WITH_EMAIL_CODE            | Email OTP code sent          | Enter email code         |
| CONFIRM_SIGN_IN_WITH_NEW_PASSWORD_REQUIRED | First login / password reset | Enter new password       |
| CONFIRM_SIGN_IN_WITH_CUSTOM_CHALLENGE      | Custom auth challenge        | Handle custom flow       |

### SignIn Response Handling

```typescript
const result = await signIn({ username: email, password })

if (result.isSignedIn) {
  // Direct sign in - no MFA
  await checkAuthState()
  navigate('/dashboard')
} else if (result.nextStep) {
  // MFA or other challenge required
  const challenge: AuthChallenge = {
    challengeName: result.nextStep.signInStep,
    challengeParameters: result.nextStep.additionalInfo,
  }
  setCurrentChallenge(challenge)

  // Route based on challenge type
  switch (result.nextStep.signInStep) {
    case 'CONFIRM_SIGN_IN_WITH_SMS_CODE':
    case 'CONFIRM_SIGN_IN_WITH_TOTP_CODE':
    case 'CONFIRM_SIGN_IN_WITH_EMAIL_CODE':
      navigate('/auth/otp-verification')
      break
    case 'CONFIRM_SIGN_IN_WITH_NEW_PASSWORD_REQUIRED':
      navigate('/auth/new-password')
      break
  }
}
```

### New Password Challenge Page

```typescript
// File: pages/auth/NewPasswordPage.tsx
function NewPasswordPage() {
  const { confirmSignIn, currentChallenge } = useAuth()
  const [newPassword, setNewPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')

  const handleSubmit = async () => {
    if (newPassword !== confirmPassword) {
      setError('Passwords do not match')
      return
    }

    const result = await confirmSignIn(newPassword)
    if (result.success) {
      navigate('/dashboard')
    }
  }

  // ... form UI
}
```

### Challenge Flow Diagram

```
Login Page
    │
    ▼
signIn(email, password)
    │
    ├── isSignedIn = true ──────────▶ Dashboard
    │
    └── nextStep.signInStep
            │
            ├── SMS_CODE ───────────▶ OTP Page (SMS)
            ├── TOTP_CODE ──────────▶ OTP Page (Authenticator)
            ├── EMAIL_CODE ─────────▶ OTP Page (Email)
            └── NEW_PASSWORD ───────▶ New Password Page
                    │
                    ▼
              confirmSignIn(response)
                    │
                    └── isSignedIn = true ──▶ Dashboard
```

## Dependencies

- Story 1.13.2: OTP Verification Page (Complete - handles OTP challenges)
- Story 1.14: Login Page (Triggers MFA flow)

## Change Log

| Date       | Version | Description                                               | Author      |
| ---------- | ------- | --------------------------------------------------------- | ----------- |
| 2025-11-28 | 0.1     | Initial draft                                             | Claude Code |
| 2025-11-29 | 1.0     | Complete: All challenge types, NewPasswordPage, all tests | Claude Code |
