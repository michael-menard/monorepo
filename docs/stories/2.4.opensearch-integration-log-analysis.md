# Story 2.4: OpenSearch Integration for Log Analysis

## Status

approved

## Story

**As a** Engineering Team Member,
**I want** OpenSearch configured as Grafana data source for log analysis,
**so that** I can query and visualize application logs alongside metrics.

## Acceptance Criteria

1. OpenSearch data source added to Grafana workspace
2. CloudWatch Logs subscription filter configured to stream logs to OpenSearch
3. OpenSearch index lifecycle management (ILM) policy created (7 days hot, 30 days warm, 90 days delete)
4. Test log query dashboard created showing error patterns and search capabilities
5. Access permissions validated for OpenSearch queries from Grafana
6. Documentation created for log query syntax and common patterns

**Integration Verification:**

- IV1: Existing CloudWatch Logs streams continue functioning
- IV2: Application logging not impacted by subscription filter
- IV3: OpenSearch query performance acceptable (<2 second response for typical queries)

## Tasks / Subtasks

- [ ] **Task 1: Configure OpenSearch data source in Grafana** (AC: 1, 5)
  - [ ] Access Grafana workspace and navigate to Data Sources
  - [ ] Add new OpenSearch data source
  - [ ] Configure data source name: `OpenSearch-UserMetrics`
  - [ ] Set OpenSearch endpoint URL from existing domain (lego-api-opensearch-{stage})
  - [ ] Configure IAM role authentication using Grafana workspace service role
  - [ ] Set appropriate index patterns for log data
  - [ ] Validate permissions for OpenSearch queries (es:ESHttpGet, es:ESHttpPost)
  - [ ] Test connection and save data source configuration

- [ ] **Task 2: Configure CloudWatch Logs subscription filter** (AC: 2, IV1, IV2)
  - [ ] Identify existing Lambda function log groups to stream to OpenSearch
  - [ ] Create CloudWatch Logs subscription filter for each log group
  - [ ] Configure filter pattern to capture all log events (empty filter)
  - [ ] Set destination as existing OpenSearch domain
  - [ ] Configure appropriate IAM role for Logs to OpenSearch streaming
  - [ ] Test log streaming with sample log entries
  - [ ] Verify existing CloudWatch Logs functionality unaffected
  - [ ] Monitor application performance to ensure no logging impact

- [ ] **Task 3: Create OpenSearch index lifecycle management policy** (AC: 3)
  - [ ] Create ILM policy: `user-metrics-logs-policy`
  - [ ] Configure hot phase: 7 days (high-performance storage)
  - [ ] Configure warm phase: 30 days (reduced replica count)
  - [ ] Configure delete phase: 90 days (automatic deletion)
  - [ ] Apply ILM policy to log indices
  - [ ] Configure index template for automatic policy application
  - [ ] Validate policy application and lifecycle transitions
  - [ ] Monitor storage usage and cost implications

- [ ] **Task 4: Create test log query dashboard** (AC: 4, 6)
  - [ ] Create new dashboard: "Log Analysis" in Infrastructure folder
  - [ ] Add panel: Error Log Count (count of ERROR level logs over time)
  - [ ] Add panel: Top Error Messages (most frequent error messages)
  - [ ] Add panel: Log Level Distribution (INFO, WARN, ERROR breakdown)
  - [ ] Add panel: Lambda Function Log Volume (log count by function)
  - [ ] Add panel: Recent Error Logs (table of recent error entries)
  - [ ] Add panel: Log Search (text search across all logs)
  - [ ] Configure appropriate time ranges and refresh intervals
  - [ ] Test query performance and optimize as needed

- [ ] **Task 5: Validate OpenSearch integration and performance** (AC: 1-6, IV1-IV3)
  - [ ] Test OpenSearch data source connectivity from Grafana
  - [ ] Verify log data appears in OpenSearch indices
  - [ ] Test log query performance (ensure <2 second response)
  - [ ] Validate log streaming from CloudWatch Logs works correctly
  - [ ] Confirm existing CloudWatch Logs functionality unaffected
  - [ ] Test log search and filtering capabilities
  - [ ] Monitor OpenSearch cluster health and performance
  - [ ] Validate ILM policy is working correctly

- [ ] **Task 6: Create documentation and query patterns** (AC: 6)
  - [ ] Document OpenSearch data source configuration
  - [ ] Create guide for OpenSearch query syntax in Grafana
  - [ ] Document common log query patterns and examples
  - [ ] Create troubleshooting guide for OpenSearch connectivity issues
  - [ ] Document ILM policy configuration and lifecycle management
  - [ ] Create team guide for log analysis using OpenSearch in Grafana
  - [ ] Document performance optimization tips for log queries

- [ ] **Task 7: Configure monitoring and alerting for log pipeline** (AC: 1-6)
  - [ ] Create CloudWatch alarm for subscription filter errors
  - [ ] Monitor OpenSearch cluster health metrics
  - [ ] Set up alerts for high log ingestion rates
  - [ ] Monitor ILM policy execution and storage usage
  - [ ] Create dashboard panel for log pipeline health
  - [ ] Configure alerts for OpenSearch query performance degradation
  - [ ] Document monitoring and alerting procedures
