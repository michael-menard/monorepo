# Story 2.2: CloudWatch Data Source Configuration

## Status

Draft

## Story

**As a** Engineering Team Member,
**I want** CloudWatch configured as primary data source in Grafana,
**so that** I can visualize Lambda, API Gateway, and CloudFront metrics.

## Acceptance Criteria

1. CloudWatch data source added to Grafana workspace with IAM role authentication
2. Permissions validated to query all relevant CloudWatch namespaces (Lambda, APIGateway, CloudFront)
3. CloudWatch Logs Insights configured as data source for log queries
4. Default region set correctly for data source
5. Test query executed successfully to verify connectivity
6. Data source marked as default for CloudWatch metrics

**Integration Verification:**

- IV1: CloudWatch metrics collection for existing resources unaffected
- IV2: Existing CloudWatch alarms continue functioning normally
- IV3: No additional CloudWatch API costs from Grafana queries (within free tier limits)

## Tasks / Subtasks

- [ ] **Task 1: Configure CloudWatch metrics data source** (AC: 1, 2, 4, 6)
  - [ ] Access Grafana workspace created in Story 2.1
  - [ ] Navigate to Configuration â†’ Data Sources in Grafana UI
  - [ ] Add new CloudWatch data source with IAM role authentication
  - [ ] Configure data source name: `CloudWatch-UserMetrics`
  - [ ] Set default region to match application infrastructure (us-east-1)
  - [ ] Configure IAM role ARN from Grafana workspace service role
  - [ ] Validate permissions for CloudWatch namespaces: AWS/Lambda, AWS/ApiGateway, AWS/CloudFront, AWS/RDS, AWS/ElastiCache, AWS/ES
  - [ ] Mark as default data source for CloudWatch metrics
  - [ ] Test connection and save data source configuration

- [ ] **Task 2: Configure CloudWatch Logs Insights data source** (AC: 3, 4, 5)
  - [ ] Add CloudWatch Logs Insights as separate data source in Grafana
  - [ ] Configure data source name: `CloudWatch-Logs-UserMetrics`
  - [ ] Set same region and IAM role as CloudWatch metrics data source
  - [ ] Validate permissions for CloudWatch Logs: logs:StartQuery, logs:GetQueryResults, logs:DescribeLogGroups
  - [ ] Test connection with sample log query from existing Lambda log groups
  - [ ] Verify log group discovery works correctly
  - [ ] Save Logs Insights data source configuration

- [ ] **Task 3: Validate data source permissions and connectivity** (AC: 1, 2, 5)
  - [ ] Test CloudWatch metrics query for existing Lambda functions
  - [ ] Test CloudWatch metrics query for existing API Gateway
  - [ ] Test CloudWatch metrics query for existing RDS Aurora metrics
  - [ ] Test CloudWatch metrics query for existing OpenSearch metrics
  - [ ] Test CloudWatch Logs Insights query for Lambda function logs
  - [ ] Verify metric discovery works for all configured namespaces
  - [ ] Validate time series data retrieval for different time ranges
  - [ ] Document any permission issues or missing metrics

- [ ] **Task 4: Configure data source settings and optimization** (AC: 1-6)
  - [ ] Configure appropriate query timeout settings (30 seconds)
  - [ ] Set up data source caching to reduce API calls
  - [ ] Configure metric name caching for better performance
  - [ ] Set up appropriate retry policies for failed queries
  - [ ] Configure data source health check intervals
  - [ ] Optimize query concurrency settings
  - [ ] Document data source configuration and settings

- [ ] **Task 5: Create test queries and validate functionality** (AC: 5, IV1-IV3)
  - [ ] Create test dashboard with sample CloudWatch metrics panels
  - [ ] Test Lambda invocation metrics from existing functions
  - [ ] Test API Gateway request count and latency metrics
  - [ ] Test RDS connection count and CPU utilization metrics
  - [ ] Test CloudWatch Logs query for error patterns
  - [ ] Verify historical data retrieval works correctly
  - [ ] Monitor CloudWatch API usage to ensure within free tier limits
  - [ ] Validate existing CloudWatch alarms and dashboards unaffected

- [ ] **Task 6: Document data source configuration and troubleshooting** (AC: 1-6)
  - [ ] Create documentation for CloudWatch data source configuration
  - [ ] Document IAM permissions required for data source access
  - [ ] Create troubleshooting guide for common connectivity issues
  - [ ] Document query syntax and examples for CloudWatch metrics
  - [ ] Document CloudWatch Logs Insights query patterns
  - [ ] Create team guide for using CloudWatch data sources in Grafana
  - [ ] Document data source limitations and best practices

## Dev Notes

### Project Context

This story is **Story 2.2** from **Phase 2: Amazon Managed Grafana & CloudWatch** of the User Metrics PRD brownfield enhancement. This is the second story in Phase 2, following Story 2.1 (Grafana Workspace Provisioning).

**Project:** User Tracking & Metrics Implementation (Brownfield Enhancement)
**Epic:** Phase 2 - Amazon Managed Grafana & CloudWatch (4 stories total)
**PRD Location:** `docs/prd/user-metrics/user-metrics-prd.md`
**Architecture:** `docs/prd/user-metrics/user-metrics-architecture.md`
**Phase File:** `docs/prd/user-metrics/phase-2.md`

### Previous Story Dependencies

**Story 2.1 (Amazon Managed Grafana Workspace Provisioning) - REQUIRED:**

- Grafana workspace created in Essential tier with IAM authentication
- Workspace service role configured with CloudWatch and Logs permissions
- Workspace accessible via HTTPS with admin/viewer roles assigned
- Workspace URL and access credentials documented

**Phase 1 Context:**

- **CloudWatch Infrastructure** (Story 1.1): Existing CloudWatch dashboard and alarms for Lambda, API Gateway, RDS, OpenSearch
- **Cost Budget** (Story 1.4): CloudWatch API calls must stay within free tier limits to maintain budget
- **Tagging Schema** (Story 1.1): All resources tagged for cost tracking and organization

### Tech Stack for This Story

[Source: docs/architecture/tech-stack.md, apps/api/lego-api-serverless/sst.config.ts]

**Amazon Managed Grafana:**

- **Data Source Types:** CloudWatch (metrics), CloudWatch Logs Insights (logs)
- **Authentication:** IAM role-based authentication using workspace service role
- **Region:** Same as application infrastructure (us-east-1 or configured region)

**AWS CloudWatch:**

- **Metrics:** Existing metrics from Lambda, API Gateway, RDS Aurora, ElastiCache Redis, OpenSearch
- **Logs:** Existing log groups from all Lambda functions
- **Namespaces:** AWS/Lambda, AWS/ApiGateway, AWS/CloudFront, AWS/RDS, AWS/ElastiCache, AWS/ES

**Existing CloudWatch Resources:**

- **Dashboard:** `LEGO-API-Serverless-{Stage}` with comprehensive metrics
- **Log Groups:** `/aws/lambda/{function-name}` for all Lambda functions
- **Alarms:** Error rate, latency, and resource utilization alarms
