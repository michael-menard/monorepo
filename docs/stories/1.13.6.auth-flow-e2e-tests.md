# Story 1.13.6: Auth Flow E2E Tests (Playwright)

## Status

Approved

## Story

**As a** developer,
**I want** comprehensive Playwright E2E tests for the authentication flows,
**so that** I can ensure the entire auth journey works correctly across browsers.

## Acceptance Criteria

1. ⬜ Playwright configured for main-app
2. ⬜ Test: Successful login flow (no MFA)
3. ⬜ Test: Login with MFA challenge → OTP verification
4. ⬜ Test: Signup → Email verification flow
5. ⬜ Test: Resend verification code
6. ⬜ Test: Invalid credentials error handling
7. ⬜ Test: Invalid OTP code error handling
8. ⬜ Test: Logout flow
9. ⬜ Test: Protected route redirect to login
10. ⬜ Test: Session persistence across page refresh
11. ⬜ Test: Forgot password → request reset code
12. ⬜ Test: Reset password → enter code and new password
13. ⬜ Test: Password validation rules
14. ⬜ CI integration for E2E tests

## Tasks / Subtasks

- [ ] **Task 1: Playwright Setup** (AC: 1)
  - [ ] Install @playwright/test
  - [ ] Create playwright.config.ts
  - [ ] Configure base URL and browsers
  - [ ] Add test scripts to package.json
  - [ ] Create tests/e2e directory structure

- [ ] **Task 2: Test Utilities** (AC: all)
  - [ ] Create auth test fixtures
  - [ ] Create mock Cognito responses (if using MSW)
  - [ ] Create page object models for auth pages
  - [ ] Setup test user credentials

- [ ] **Task 3: Login Tests** (AC: 2, 6)
  - [ ] Test successful login with valid credentials
  - [ ] Test redirect to dashboard after login
  - [ ] Test invalid email format validation
  - [ ] Test invalid password error message
  - [ ] Test wrong credentials error

- [ ] **Task 4: MFA Tests** (AC: 3, 7)
  - [ ] Test MFA challenge detection
  - [ ] Test redirect to OTP page
  - [ ] Test OTP input functionality
  - [ ] Test successful MFA verification
  - [ ] Test invalid OTP error
  - [ ] Test back to login navigation

- [ ] **Task 5: Signup Tests** (AC: 4, 5)
  - [ ] Test signup form submission
  - [ ] Test redirect to email verification
  - [ ] Test OTP entry for email verification
  - [ ] Test resend code button
  - [ ] Test resend cooldown timer
  - [ ] Test successful verification → login

- [ ] **Task 6: Session Tests** (AC: 8, 9, 10)
  - [ ] Test logout clears session
  - [ ] Test protected route redirects to login
  - [ ] Test redirect back after login
  - [ ] Test session persists on refresh
  - [ ] Test token refresh (if testable)

- [ ] **Task 7: Forgot Password Tests** (AC: 11)
  - [ ] Test forgot password form displays
  - [ ] Test email input validation
  - [ ] Test submit sends reset code
  - [ ] Test redirect to reset password page
  - [ ] Test rate limiting error handling
  - [ ] Test back to login navigation

- [ ] **Task 8: Reset Password Tests** (AC: 12, 13)
  - [ ] Test reset password form displays
  - [ ] Test email pre-fill from navigation state
  - [ ] Test OTP code entry
  - [ ] Test password validation rules
  - [ ] Test password strength indicator
  - [ ] Test confirm password match validation
  - [ ] Test successful password reset
  - [ ] Test invalid/expired code error
  - [ ] Test redirect to login after success

- [ ] **Task 9: CI Integration** (AC: 14)
  - [ ] Add Playwright to GitHub Actions
  - [ ] Configure test artifacts (screenshots, videos)
  - [ ] Setup parallel test execution
  - [ ] Add to PR checks

## Dev Notes

**important** use the cucumber/Gurkin language to describe tests

### Playwright Configuration

**File:** `apps/web/main-app/playwright.config.ts`

```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### Page Object Models

**File:** `tests/e2e/pages/login.page.ts`

```typescript
import { Page, Locator } from '@playwright/test'

export class LoginPage {
  readonly page: Page
  readonly emailInput: Locator
  readonly passwordInput: Locator
  readonly submitButton: Locator
  readonly errorMessage: Locator
  readonly forgotPasswordLink: Locator
  readonly signUpLink: Locator

  constructor(page: Page) {
    this.page = page
    this.emailInput = page.getByLabel('Email')
    this.passwordInput = page.getByLabel('Password')
    this.submitButton = page.getByRole('button', { name: /sign in/i })
    this.errorMessage = page.getByTestId('error-message')
    this.forgotPasswordLink = page.getByRole('link', { name: /forgot password/i })
    this.signUpLink = page.getByRole('link', { name: /sign up/i })
  }

  async goto() {
    await this.page.goto('/login')
  }

  async login(email: string, password: string) {
    await this.emailInput.fill(email)
    await this.passwordInput.fill(password)
    await this.submitButton.click()
  }
}
```

**File:** `tests/e2e/pages/otp.page.ts`

```typescript
import { Page, Locator } from '@playwright/test'

export class OTPPage {
  readonly page: Page
  readonly otpInputs: Locator
  readonly verifyButton: Locator
  readonly backToLoginButton: Locator
  readonly errorMessage: Locator

  constructor(page: Page) {
    this.page = page
    this.otpInputs = page.getByTestId('otp-input')
    this.verifyButton = page.getByTestId('verify-button')
    this.backToLoginButton = page.getByTestId('back-to-login-button')
    this.errorMessage = page.getByTestId('error-message')
  }

  async enterOTP(code: string) {
    const digits = code.split('')
    for (let i = 0; i < digits.length; i++) {
      await this.page.getByTestId(`otp-input-input-${i}`).fill(digits[i])
    }
  }

  async verifyCode() {
    await this.verifyButton.click()
  }
}
```

**File:** `tests/e2e/pages/forgot-password.page.ts`

```typescript
import { Page, Locator } from '@playwright/test'

export class ForgotPasswordPage {
  readonly page: Page
  readonly emailInput: Locator
  readonly submitButton: Locator
  readonly backToLoginLink: Locator
  readonly successMessage: Locator
  readonly errorMessage: Locator
  readonly continueButton: Locator

  constructor(page: Page) {
    this.page = page
    this.emailInput = page.getByLabel('Email')
    this.submitButton = page.getByRole('button', { name: /send.*code|reset/i })
    this.backToLoginLink = page.getByRole('link', { name: /back to login|sign in/i })
    this.successMessage = page.getByTestId('success-message')
    this.errorMessage = page.getByTestId('error-message')
    this.continueButton = page.getByRole('button', { name: /continue|enter.*code/i })
  }

  async goto() {
    await this.page.goto('/forgot-password')
  }

  async requestResetCode(email: string) {
    await this.emailInput.fill(email)
    await this.submitButton.click()
  }
}
```

**File:** `tests/e2e/pages/reset-password.page.ts`

```typescript
import { Page, Locator } from '@playwright/test'

export class ResetPasswordPage {
  readonly page: Page
  readonly emailInput: Locator
  readonly codeInput: Locator
  readonly newPasswordInput: Locator
  readonly confirmPasswordInput: Locator
  readonly submitButton: Locator
  readonly passwordStrength: Locator
  readonly errorMessage: Locator
  readonly successMessage: Locator
  readonly resendCodeLink: Locator

  constructor(page: Page) {
    this.page = page
    this.emailInput = page.getByLabel('Email')
    this.codeInput = page.getByTestId('otp-input')
    this.newPasswordInput = page.getByLabel(/new password/i)
    this.confirmPasswordInput = page.getByLabel(/confirm password/i)
    this.submitButton = page.getByRole('button', { name: /reset password|submit/i })
    this.passwordStrength = page.getByTestId('password-strength')
    this.errorMessage = page.getByTestId('error-message')
    this.successMessage = page.getByTestId('success-message')
    this.resendCodeLink = page.getByRole('link', { name: /resend|request new code/i })
  }

  async goto() {
    await this.page.goto('/reset-password')
  }

  async enterCode(code: string) {
    const digits = code.split('')
    for (let i = 0; i < digits.length; i++) {
      await this.page.getByTestId(`otp-input-input-${i}`).fill(digits[i])
    }
  }

  async resetPassword(email: string, code: string, newPassword: string, confirmPassword: string) {
    if (await this.emailInput.isEditable()) {
      await this.emailInput.fill(email)
    }
    await this.enterCode(code)
    await this.newPasswordInput.fill(newPassword)
    await this.confirmPasswordInput.fill(confirmPassword)
    await this.submitButton.click()
  }
}
```

### Test Examples

**File:** `tests/e2e/auth/login.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import { LoginPage } from '../pages/login.page'

test.describe('Login Flow', () => {
  let loginPage: LoginPage

  test.beforeEach(async ({ page }) => {
    loginPage = new LoginPage(page)
    await loginPage.goto()
  })

  test('should display login form', async ({ page }) => {
    await expect(loginPage.emailInput).toBeVisible()
    await expect(loginPage.passwordInput).toBeVisible()
    await expect(loginPage.submitButton).toBeVisible()
  })

  test('should show error for invalid credentials', async ({ page }) => {
    await loginPage.login('invalid@email.com', 'wrongpassword')
    await expect(loginPage.errorMessage).toBeVisible()
    await expect(loginPage.errorMessage).toContainText(/incorrect/i)
  })

  test('should redirect to dashboard on successful login', async ({ page }) => {
    await loginPage.login('valid@email.com', 'ValidPassword123!')
    await expect(page).toHaveURL('/dashboard')
  })

  test('should navigate to forgot password page', async ({ page }) => {
    await loginPage.forgotPasswordLink.click()
    await expect(page).toHaveURL('/forgot-password')
  })

  test('should navigate to signup page', async ({ page }) => {
    await loginPage.signUpLink.click()
    await expect(page).toHaveURL('/register')
  })
})
```

**File:** `tests/e2e/auth/mfa.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import { LoginPage } from '../pages/login.page'
import { OTPPage } from '../pages/otp.page'

test.describe('MFA Flow', () => {
  test('should redirect to OTP page when MFA required', async ({ page }) => {
    const loginPage = new LoginPage(page)
    await loginPage.goto()

    // Login with MFA-enabled account
    await loginPage.login('mfa-user@email.com', 'ValidPassword123!')

    // Should redirect to OTP verification
    await expect(page).toHaveURL('/auth/otp-verification')
  })

  test('should complete MFA with valid code', async ({ page }) => {
    const loginPage = new LoginPage(page)
    const otpPage = new OTPPage(page)

    await loginPage.goto()
    await loginPage.login('mfa-user@email.com', 'ValidPassword123!')

    // Enter valid OTP
    await otpPage.enterOTP('123456')
    await otpPage.verifyCode()

    // Should redirect to dashboard
    await expect(page).toHaveURL('/dashboard')
  })

  test('should show error for invalid OTP', async ({ page }) => {
    const loginPage = new LoginPage(page)
    const otpPage = new OTPPage(page)

    await loginPage.goto()
    await loginPage.login('mfa-user@email.com', 'ValidPassword123!')

    // Enter invalid OTP
    await otpPage.enterOTP('000000')
    await otpPage.verifyCode()

    await expect(otpPage.errorMessage).toBeVisible()
    await expect(otpPage.errorMessage).toContainText(/invalid/i)
  })
})
```

**File:** `tests/e2e/auth/forgot-password.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import { ForgotPasswordPage } from '../pages/forgot-password.page'
import { LoginPage } from '../pages/login.page'

test.describe('Forgot Password Flow', () => {
  let forgotPasswordPage: ForgotPasswordPage

  test.beforeEach(async ({ page }) => {
    forgotPasswordPage = new ForgotPasswordPage(page)
    await forgotPasswordPage.goto()
  })

  test('should display forgot password form', async () => {
    await expect(forgotPasswordPage.emailInput).toBeVisible()
    await expect(forgotPasswordPage.submitButton).toBeVisible()
    await expect(forgotPasswordPage.backToLoginLink).toBeVisible()
  })

  test('should validate email format', async ({ page }) => {
    await forgotPasswordPage.emailInput.fill('invalid-email')
    await forgotPasswordPage.submitButton.click()

    // Should show validation error
    await expect(page.getByText(/valid email/i)).toBeVisible()
  })

  test('should send reset code and show success', async ({ page }) => {
    await forgotPasswordPage.requestResetCode('user@example.com')

    // Should show success message
    await expect(forgotPasswordPage.successMessage).toBeVisible()
    await expect(forgotPasswordPage.successMessage).toContainText(/sent|check your email/i)
  })

  test('should redirect to reset password page', async ({ page }) => {
    await forgotPasswordPage.requestResetCode('user@example.com')

    // Wait for success then click continue or auto-redirect
    await expect(page).toHaveURL('/reset-password', { timeout: 5000 })
  })

  test('should handle rate limiting', async ({ page }) => {
    // Trigger rate limit by multiple requests
    await forgotPasswordPage.requestResetCode('user@example.com')
    await forgotPasswordPage.goto()
    await forgotPasswordPage.requestResetCode('user@example.com')
    await forgotPasswordPage.goto()
    await forgotPasswordPage.requestResetCode('user@example.com')

    // Should show rate limit error
    await expect(forgotPasswordPage.errorMessage).toContainText(
      /too many attempts|try again later/i,
    )
  })

  test('should navigate back to login', async ({ page }) => {
    await forgotPasswordPage.backToLoginLink.click()
    await expect(page).toHaveURL('/login')
  })

  test('should be accessible from login page', async ({ page }) => {
    const loginPage = new LoginPage(page)
    await loginPage.goto()
    await loginPage.forgotPasswordLink.click()

    await expect(page).toHaveURL('/forgot-password')
  })
})
```

**File:** `tests/e2e/auth/reset-password.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import { ResetPasswordPage } from '../pages/reset-password.page'
import { ForgotPasswordPage } from '../pages/forgot-password.page'

test.describe('Reset Password Flow', () => {
  let resetPasswordPage: ResetPasswordPage

  test.beforeEach(async ({ page }) => {
    resetPasswordPage = new ResetPasswordPage(page)
    await resetPasswordPage.goto()
  })

  test('should display reset password form', async () => {
    await expect(resetPasswordPage.emailInput).toBeVisible()
    await expect(resetPasswordPage.codeInput).toBeVisible()
    await expect(resetPasswordPage.newPasswordInput).toBeVisible()
    await expect(resetPasswordPage.confirmPasswordInput).toBeVisible()
    await expect(resetPasswordPage.submitButton).toBeVisible()
  })

  test('should pre-fill email from navigation state', async ({ page }) => {
    // Navigate from forgot password with email
    const forgotPasswordPage = new ForgotPasswordPage(page)
    await forgotPasswordPage.goto()
    await forgotPasswordPage.requestResetCode('prefilled@example.com')

    // Email should be pre-filled
    await expect(resetPasswordPage.emailInput).toHaveValue('prefilled@example.com')
  })

  test('should show password strength indicator', async ({ page }) => {
    await resetPasswordPage.newPasswordInput.fill('weak')
    await expect(resetPasswordPage.passwordStrength).toContainText(/weak/i)

    await resetPasswordPage.newPasswordInput.fill('StrongerPass1!')
    await expect(resetPasswordPage.passwordStrength).toContainText(/strong/i)
  })

  test('should validate password requirements', async ({ page }) => {
    // Too short
    await resetPasswordPage.newPasswordInput.fill('Short1!')
    await expect(page.getByText(/at least 8 characters/i)).toBeVisible()

    // No uppercase
    await resetPasswordPage.newPasswordInput.fill('nouppercase1!')
    await expect(page.getByText(/uppercase/i)).toBeVisible()

    // No number
    await resetPasswordPage.newPasswordInput.fill('NoNumber!!')
    await expect(page.getByText(/number/i)).toBeVisible()

    // No special character
    await resetPasswordPage.newPasswordInput.fill('NoSpecial123')
    await expect(page.getByText(/special character/i)).toBeVisible()
  })

  test('should validate password confirmation match', async ({ page }) => {
    await resetPasswordPage.newPasswordInput.fill('ValidPassword1!')
    await resetPasswordPage.confirmPasswordInput.fill('DifferentPassword1!')
    await resetPasswordPage.submitButton.click()

    await expect(page.getByText(/passwords do not match/i)).toBeVisible()
  })

  test('should reset password with valid inputs', async ({ page }) => {
    await resetPasswordPage.resetPassword(
      'user@example.com',
      '123456',
      'NewValidPassword1!',
      'NewValidPassword1!',
    )

    // Should show success and redirect to login
    await expect(resetPasswordPage.successMessage).toBeVisible()
    await expect(page).toHaveURL('/login', { timeout: 5000 })
  })

  test('should show error for invalid code', async ({ page }) => {
    await resetPasswordPage.resetPassword(
      'user@example.com',
      '000000', // Invalid code
      'NewValidPassword1!',
      'NewValidPassword1!',
    )

    await expect(resetPasswordPage.errorMessage).toBeVisible()
    await expect(resetPasswordPage.errorMessage).toContainText(/invalid.*code/i)
  })

  test('should show error for expired code', async ({ page }) => {
    await resetPasswordPage.resetPassword(
      'user@example.com',
      '999999', // Expired code (mocked)
      'NewValidPassword1!',
      'NewValidPassword1!',
    )

    await expect(resetPasswordPage.errorMessage).toBeVisible()
    await expect(resetPasswordPage.errorMessage).toContainText(/expired/i)
  })

  test('should allow resending code', async ({ page }) => {
    await resetPasswordPage.resendCodeLink.click()

    // Should redirect to forgot password or show resend confirmation
    await expect(page).toHaveURL('/forgot-password')
  })

  test('should show success message with redirect countdown', async ({ page }) => {
    await resetPasswordPage.resetPassword(
      'user@example.com',
      '123456',
      'NewValidPassword1!',
      'NewValidPassword1!',
    )

    // Should show success with countdown
    await expect(resetPasswordPage.successMessage).toContainText(/password.*changed|reset/i)
    await expect(page.getByText(/redirecting/i)).toBeVisible()

    // Wait for redirect
    await expect(page).toHaveURL('/login', { timeout: 5000 })
  })
})
```

### Mock Cognito with MSW (Optional)

For reliable E2E tests without hitting real Cognito:

```typescript
// tests/e2e/mocks/handlers.ts
import { http, HttpResponse } from 'msw'

export const handlers = [
  http.post('https://cognito-idp.*.amazonaws.com/', async ({ request }) => {
    const body = await request.json()

    // Handle different Cognito operations
    if (body.AuthFlow === 'USER_SRP_AUTH') {
      // Mock successful login or MFA challenge
    }

    return HttpResponse.json({
      /* mock response */
    })
  }),
]
```

### Package.json Scripts

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:report": "playwright show-report"
  }
}
```

### GitHub Actions Integration

```yaml
# .github/workflows/e2e.yml
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: pnpm --filter main-app exec playwright install --with-deps

      - name: Run E2E tests
        run: pnpm --filter main-app test:e2e

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/main-app/playwright-report/
          retention-days: 30
```

## Test Coverage Matrix

| Flow            | Happy Path                  | Error Cases         | Edge Cases           |
| --------------- | --------------------------- | ------------------- | -------------------- |
| Login           | ✓ Valid credentials         | ✓ Wrong password    | ✓ Empty form         |
|                 | ✓ Redirect to dashboard     | ✓ User not found    | ✓ Special characters |
| MFA             | ✓ OTP entry                 | ✓ Invalid code      | ✓ Code expiry        |
|                 | ✓ Verify success            | ✓ Too many attempts | ✓ Back navigation    |
| Signup          | ✓ Form submission           | ✓ Email exists      | ✓ Password rules     |
|                 | ✓ Email verification        | ✓ Invalid code      | ✓ Resend code        |
| Forgot Password | ✓ Request code              | ✓ Rate limiting     | ✓ Back to login      |
|                 | ✓ Redirect to reset         | ✓ Invalid email     | ✓ Email validation   |
| Reset Password  | ✓ Enter code + new password | ✓ Invalid code      | ✓ Password strength  |
|                 | ✓ Redirect to login         | ✓ Expired code      | ✓ Password match     |
|                 | ✓ Success message           | ✓ Weak password     | ✓ Email pre-fill     |
| Session         | ✓ Persist on refresh        | ✓ Token expiry      | ✓ Multiple tabs      |
|                 | ✓ Logout clears             | ✓ Protected routes  |                      |

## Dependencies

- Story 1.13.1: OTP Input Component (Complete)
- Story 1.13.2: OTP Verification Page (Complete)
- Story 1.13.3: Email Verification Flow
- Story 1.13.4: Resend Verification Code
- Story 1.13.5: MFA Challenge Handling
- Story 1.13.7: Forgot Password Flow
- Story 1.13.8: Reset Password Flow
- Story 1.14: Login Page
- Story 1.17: Logout Flow

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-11-28 | 0.1     | Initial draft                     | Claude Code |
| 2025-11-28 | 0.2     | Added forgot/reset password tests | Claude Code |
