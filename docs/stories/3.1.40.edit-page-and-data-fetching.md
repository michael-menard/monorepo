# Story 3.1.40: Edit Page & Data Fetching

## GitHub Issue
- Issue: #263
- URL: https://github.com/michael-menard/monorepo/issues/263
- Status: Todo

## Status

Draft

## Story

**As an** owner,
**I want** the edit page pre-populated with my MOC data,
**so that** I can see and modify my existing content.

## Epic Context

This is **Story 2.2 of Epic 2: Edit UX & Frontend**.

## Blocked By

- All Epic 0 stories (3.1.28-3.1.32)
- All Epic 1 stories (3.1.33-3.1.38)
- Story 3.1.39: Edit Routes & Entry Points

## Acceptance Criteria

1. Edit page fetches MOC data via RTK Query from `/mocs/:mocId/edit`
2. Loading state shown while fetching
3. Form pre-populated with: title, description, tags, theme
4. Existing files displayed with preview/download links
5. Error state for failed fetch
6. Uses `@repo/upload-types` for type definitions

## Tasks / Subtasks

- [ ] **Task 1: Create RTK Query Endpoint** (AC: 1)
  - [ ] Add `getMocForEdit` query to `mocApi`
  - [ ] Define response type using `@repo/upload-types`
  - [ ] Configure appropriate cache behavior

- [ ] **Task 2: Create Edit Page Component** (AC: 1, 2)
  - [ ] Create `InstructionsEditPage.tsx` component
  - [ ] Use RTK Query hook for data fetching
  - [ ] Show loading skeleton during fetch

- [ ] **Task 3: Pre-populate Form** (AC: 3)
  - [ ] Initialize form state with fetched data
  - [ ] Title input with current value
  - [ ] Description textarea with current value
  - [ ] Tags input with current tags
  - [ ] Theme selector with current theme

- [ ] **Task 4: Display Existing Files** (AC: 4)
  - [ ] Show instruction PDF with preview/download
  - [ ] Show images with thumbnails and download
  - [ ] Show parts lists with download links
  - [ ] Show thumbnail with preview
  - [ ] Each file shows: name, size, type, upload date

- [ ] **Task 5: Handle Error States** (AC: 5)
  - [ ] Network error: Show retry button
  - [ ] 404: Show "MOC not found" message
  - [ ] 403: Redirect to 403 error component
  - [ ] Generic error: Show error message

- [ ] **Task 6: Type Integration** (AC: 6)
  - [ ] Import types from `@repo/upload-types`
  - [ ] Use `MocForEditResponse` type for query
  - [ ] Use `FileCategory` for file display

## Dev Notes

### RTK Query Endpoint

```typescript
// apps/web/main-app/src/services/api/mocApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'
import { MocForEditResponse } from '@repo/upload-types'

export const mocApi = createApi({
  reducerPath: 'mocApi',
  baseQuery: fetchBaseQuery({
    baseUrl: '/api',
    credentials: 'include', // Cookie auth
  }),
  tagTypes: ['Moc', 'MocForEdit'],
  endpoints: builder => ({
    getMocForEdit: builder.query<MocForEditResponse, string>({
      query: mocId => `/mocs/${mocId}/edit`,
      providesTags: (result, error, mocId) => [{ type: 'MocForEdit', id: mocId }],
    }),
    // ... other endpoints
  }),
})

export const { useGetMocForEditQuery } = mocApi
```

### Edit Page Component

```typescript
// apps/web/main-app/src/routes/pages/InstructionsEditPage.tsx
import { useGetMocForEditQuery } from '@/services/api/mocApi'
import { EditForm } from '@/components/MocEdit/EditForm'
import { FileList } from '@/components/MocEdit/FileList'
import { LoadingSkeleton } from '@/components/LoadingSkeleton'
import { ErrorDisplay } from '@/components/ErrorDisplay'

export function InstructionsEditPage() {
  const { slug } = Route.useParams()
  const { data: moc, isLoading, error } = useGetMocForEditQuery(slug)

  if (isLoading) {
    return <EditPageSkeleton />
  }

  if (error) {
    return <EditErrorDisplay error={error} />
  }

  if (!moc) {
    return <NotFound />
  }

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-8">Edit MOC</h1>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2">
          <EditForm moc={moc} />
        </div>

        <div>
          <h2 className="text-xl font-semibold mb-4">Current Files</h2>
          <FileList files={moc.files} />
        </div>
      </div>
    </div>
  )
}
```

### Loading Skeleton

```typescript
function EditPageSkeleton() {
  return (
    <div className="container mx-auto py-8">
      <Skeleton className="h-10 w-48 mb-8" />

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2 space-y-6">
          <Skeleton className="h-12 w-full" />
          <Skeleton className="h-32 w-full" />
          <Skeleton className="h-12 w-full" />
        </div>

        <div className="space-y-4">
          <Skeleton className="h-6 w-32" />
          <Skeleton className="h-20 w-full" />
          <Skeleton className="h-20 w-full" />
        </div>
      </div>
    </div>
  )
}
```

### File List Component

```typescript
// apps/web/main-app/src/components/MocEdit/FileList.tsx
import { FileCategory } from '@repo/upload-types'

interface FileListProps {
  files: Array<{
    id: string
    category: FileCategory
    filename: string
    size: number
    mimeType: string
    url: string
    uploadedAt: string
  }>
}

function FileList({ files }: FileListProps) {
  const groupedFiles = groupBy(files, 'category')

  return (
    <div className="space-y-6">
      {Object.entries(groupedFiles).map(([category, categoryFiles]) => (
        <div key={category}>
          <h3 className="font-medium mb-2 capitalize">{category}</h3>
          <ul className="space-y-2">
            {categoryFiles.map(file => (
              <li key={file.id} className="flex items-center gap-2 p-2 border rounded">
                <FileIcon mimeType={file.mimeType} />
                <div className="flex-1 min-w-0">
                  <p className="truncate text-sm">{file.filename}</p>
                  <p className="text-xs text-muted-foreground">
                    {formatBytes(file.size)}
                  </p>
                </div>
                <a
                  href={file.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-primary hover:underline text-sm"
                >
                  Download
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  )
}
```

### Form Initialization

```typescript
// apps/web/main-app/src/components/MocEdit/EditForm.tsx
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { MocForEditResponse, EditMocSchema } from '@repo/upload-types'

interface EditFormProps {
  moc: MocForEditResponse
}

function EditForm({ moc }: EditFormProps) {
  const form = useForm({
    resolver: zodResolver(EditMocSchema),
    defaultValues: {
      title: moc.title,
      description: moc.description,
      tags: moc.tags,
      theme: moc.theme ?? '',
      slug: moc.slug,
    },
  })

  // ... form implementation
}
```

## Testing

### Test Location
- `apps/web/main-app/src/routes/pages/__tests__/InstructionsEditPage.test.tsx`
- `apps/web/main-app/src/components/MocEdit/__tests__/`

### Test Requirements
- Unit: Loading skeleton displayed during fetch
- Unit: Form pre-populated with correct values
- Unit: Files displayed with correct information
- Unit: Error states render correctly
- Integration: RTK Query fetches data on mount
- Integration: Form values match fetched data

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 0.1 | Initial draft from Edit MOC PRD | SM Agent |

## Dev Agent Record

### Agent Model Used

N/A

### Debug Log References

N/A

### Completion Notes

N/A

### File List

- `apps/web/main-app/src/routes/pages/InstructionsEditPage.tsx` - Modified
- `apps/web/main-app/src/services/api/mocApi.ts` - Modified (add query)
- `apps/web/main-app/src/components/MocEdit/EditForm.tsx` - New
- `apps/web/main-app/src/components/MocEdit/FileList.tsx` - New
- `apps/web/main-app/src/components/MocEdit/EditPageSkeleton.tsx` - New
