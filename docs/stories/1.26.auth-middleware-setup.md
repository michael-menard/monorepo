# Story 1.26: Auth Middleware Setup

## Status

Approved

## Story

**As a** developer,
**I want** auth middleware that runs before protected routes,
**so that** invalid sessions are caught before page load.

## Acceptance Criteria

1. ⬜ Auth middleware function created
2. ⬜ Middleware checks for valid access token
3. ⬜ Middleware runs in TanStack Router beforeLoad
4. ⬜ Returns early if auth loading
5. ⬜ Can be composed with other middleware

## Tasks / Subtasks

- [ ] **Task 1: Create Middleware** (AC: 1-2)
  - [ ] Create lib/auth-middleware.ts
  - [ ] Check tokens exist in context
  - [ ] Validate token with JWT utility

- [ ] **Task 2: Router Integration** (AC: 3-4)
  - [ ] Use in route beforeLoad hook
  - [ ] Skip check if auth.isLoading
  - [ ] Return void if valid

- [ ] **Task 3: Composition** (AC: 5)
  - [ ] Allow chaining with other guards
  - [ ] Export composable function

## Dev Notes

### Middleware Pattern

**File:** `apps/web/main-app/src/lib/auth-middleware.ts`

```typescript
import { redirect } from '@tanstack/react-router'
import { isTokenExpired } from './jwt'
import type { AuthState } from '@/store/slices/authSlice'

export interface AuthMiddlewareOptions {
  requireAuth?: boolean
  redirectTo?: string
}

export function createAuthMiddleware(options: AuthMiddlewareOptions = {}) {
  const { requireAuth = true, redirectTo = '/login' } = options

  return ({ context, location }: { context: any; location: any }) => {
    const auth: AuthState = context.auth

    // Skip if still loading auth state
    if (auth.isLoading) {
      return
    }

    // Check authentication
    if (requireAuth && !auth.isAuthenticated) {
      throw redirect({
        to: redirectTo,
        search: { redirect: location.pathname },
      })
    }

    // Check token validity
    if (auth.tokens?.accessToken) {
      if (isTokenExpired(auth.tokens.accessToken)) {
        // Token expired - trigger refresh or logout
        throw redirect({
          to: redirectTo,
          search: { redirect: location.pathname, expired: true },
        })
      }
    }

    return
  }
}

// Pre-configured middleware instances
export const AuthMiddleware = {
  required: createAuthMiddleware({ requireAuth: true }),
  optional: createAuthMiddleware({ requireAuth: false }),
}
```

### Router Usage

```typescript
export const Route = createFileRoute('/dashboard')({
  beforeLoad: AuthMiddleware.required,
  component: DashboardPage,
})
```

### Composition Pattern

```typescript
function composeMiddleware(...middlewares: RouteGuard[]) {
  return (args: RouteArgs) => {
    for (const middleware of middlewares) {
      const result = middleware(args)
      if (result !== undefined) return result
    }
  }
}

// Usage
beforeLoad: composeMiddleware(AuthMiddleware.required, RoleMiddleware(['admin']))
```

### Testing

- Test middleware allows valid auth
- Test middleware redirects without auth
- Test middleware handles expired token
- Test composition works

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
