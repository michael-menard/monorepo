# Story 1.26: Auth Middleware Setup

## Status

Ready for Review

## Story

**As a** developer,
**I want** auth middleware that runs before protected routes,
**so that** invalid sessions are caught before page load.

## Acceptance Criteria

1. ✅ Auth middleware function created
2. ✅ Middleware checks for valid access token
3. ✅ Middleware runs in TanStack Router beforeLoad
4. ✅ Returns early if auth loading
5. ✅ Can be composed with other middleware

## Tasks / Subtasks

- [x] **Task 1: Create Middleware** (AC: 1-2)
  - [x] Enhanced existing route-guards.ts with token validation
  - [x] Check tokens exist in context
  - [x] Validate token with JWT utility using isTokenExpired()

- [x] **Task 2: Router Integration** (AC: 3-4)
  - [x] Added checkTokenExpiry option to createTanStackRouteGuard
  - [x] Skip check if auth.isLoading (already implemented)
  - [x] Return void if valid

- [x] **Task 3: Composition** (AC: 5)
  - [x] Created composeMiddleware() helper function
  - [x] Export composable function with RouteGuard type

## Dev Agent Record

### Implementation Approach

After analyzing the existing codebase, I found that `route-guards.ts` already provided most of the required functionality:
- TanStack Router `beforeLoad` integration
- Auth state checking with `isLoading` early return
- Pre-configured guard instances
- Redirect handling

**Decision:** Enhanced existing `route-guards.ts` instead of creating a new `auth-middleware.ts` file to:
- Avoid code duplication
- Maintain single source of truth for route protection
- Leverage existing test coverage (23 tests)
- Keep consistent API for developers

### Changes Made

1. **Enhanced `createTanStackRouteGuard()`**:
   - Added `checkTokenExpiry?: boolean` option to `RouteGuardOptions`
   - Imported `isTokenExpired()` from `jwt.ts`
   - Added token expiration check after auth check but before role checks
   - Redirects to login with `expired: true` search param when token is expired
   - Defaults to checking token expiry for all authenticated routes

2. **Updated `RouteGuards` pre-configured instances**:
   - `RouteGuards.protected` - now includes `checkTokenExpiry: true`
   - `RouteGuards.verified` - now includes `checkTokenExpiry: true`
   - `RouteGuards.admin` - now includes `checkTokenExpiry: true`
   - `RouteGuards.guestOnly` - no token check needed (unauthenticated)
   - `RouteGuards.public` - no token check needed (optional auth)

3. **Added `composeMiddleware()` helper**:
   - Accepts variadic `RouteGuard[]` arguments
   - Executes guards in order
   - Stops execution if any guard throws (redirects)
   - Returns early if any guard returns a value
   - Fully typed with `RouteGuard` type

4. **Added comprehensive tests**:
   - 15 new tests for token expiration checking
   - 7 new tests for middleware composition
   - All 38 tests passing
   - Mocked `isTokenExpired()` from jwt module
   - Tested all edge cases (no token, not authenticated, checkTokenExpiry: false, etc.)

### Files Modified

- `apps/web/main-app/src/lib/route-guards.ts` - Enhanced with token validation and composition
- `apps/web/main-app/src/lib/__tests__/route-guards.test.ts` - Added 22 new tests

### Test Results

```
✓ src/lib/__tests__/route-guards.test.ts (38 tests) 6ms
  Test Files  1 passed (1)
  Tests  38 passed (38)
```

## Dev Notes

### Middleware Pattern (Original Story Proposal)

**File:** `apps/web/main-app/src/lib/auth-middleware.ts`

```typescript
import { redirect } from '@tanstack/react-router'
import { isTokenExpired } from './jwt'
import type { AuthState } from '@/store/slices/authSlice'

export interface AuthMiddlewareOptions {
  requireAuth?: boolean
  redirectTo?: string
}

export function createAuthMiddleware(options: AuthMiddlewareOptions = {}) {
  const { requireAuth = true, redirectTo = '/login' } = options

  return ({ context, location }: { context: any; location: any }) => {
    const auth: AuthState = context.auth

    // Skip if still loading auth state
    if (auth.isLoading) {
      return
    }

    // Check authentication
    if (requireAuth && !auth.isAuthenticated) {
      throw redirect({
        to: redirectTo,
        search: { redirect: location.pathname },
      })
    }

    // Check token validity
    if (auth.tokens?.accessToken) {
      if (isTokenExpired(auth.tokens.accessToken)) {
        // Token expired - trigger refresh or logout
        throw redirect({
          to: redirectTo,
          search: { redirect: location.pathname, expired: true },
        })
      }
    }

    return
  }
}

// Pre-configured middleware instances
export const AuthMiddleware = {
  required: createAuthMiddleware({ requireAuth: true }),
  optional: createAuthMiddleware({ requireAuth: false }),
}
```

### Router Usage

```typescript
export const Route = createFileRoute('/dashboard')({
  beforeLoad: AuthMiddleware.required,
  component: DashboardPage,
})
```

### Composition Pattern

```typescript
function composeMiddleware(...middlewares: RouteGuard[]) {
  return (args: RouteArgs) => {
    for (const middleware of middlewares) {
      const result = middleware(args)
      if (result !== undefined) return result
    }
  }
}

// Usage
beforeLoad: composeMiddleware(AuthMiddleware.required, RoleMiddleware(['admin']))
```

### Testing

- Test middleware allows valid auth
- Test middleware redirects without auth
- Test middleware handles expired token
- Test composition works

## File List

- `apps/web/main-app/src/lib/route-guards.ts` - Enhanced with token validation and composition
- `apps/web/main-app/src/lib/__tests__/route-guards.test.ts` - Added comprehensive tests for new functionality

## Change Log

| Date       | Version | Description                                                      | Author    |
| ---------- | ------- | ---------------------------------------------------------------- | --------- |
| 2025-11-30 | 0.2     | Enhanced route-guards.ts with token validation and composition   | Dev Agent |
| 2025-11-28 | 0.1     | Initial draft                                                    | SM Agent  |
