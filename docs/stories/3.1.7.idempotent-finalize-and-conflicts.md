# Story 3.1.7: Idempotent Finalize and Duplicate Title Conflicts

## Status

Ready for Review

## Story

As a backend developer,
I want the finalize step to be idempotent and duplicate title conflicts to return a clear 409,
so that retries are safe and users understand why a creation fails.

## Acceptance Criteria

1. Finalize is idempotent:
   - Multiple POST /api/mocs/{mocId}/finalize calls return 200 with the same payload once complete, or 200 with `{ idempotent: true, status: 'finalizing' }` when another in‑flight finalize holds the lock.
   - Only the lock holder performs side effects (S3 verify, thumbnail assignment, OpenSearch index). Others short‑circuit and do not mutate state.
2. Duplicate title conflict (slug‑equivalent) on initialize:
   - Creating a MOC with a title that already exists for the same user returns 409 CONFLICT with an actionable message.
   - No partial records are created when conflict occurs.
3. Concurrency and failure semantics:
   - Two‑phase finalize with transient lock: atomically set `finalizing_at = now()` only when `finalized_at IS NULL AND finalizing_at IS NULL`, returning the row if lock acquired.
   - Do NOT set `finalized_at` until all verification and side effects succeed. On any failure, clear `finalizing_at` (set NULL) and return error; no partial writes.
   - If another call sees `finalizing_at` set:
     • If `finalized_at` is set → return current record with `{ idempotent: true }`.
     • If `finalized_at` is NULL → return 200 with `{ idempotent: true, status: 'finalizing' }` (clients may poll).
   - Stale‑lock rescue: if `finalizing_at` is older than `FINALIZE_LOCK_TTL_MINUTES` (env, default 5), allow lock acquisition by updating `finalizing_at` when older than the TTL window.
4. Logging and traceability:
   - INFO on successful first finalize; INFO with `idempotent: true` on subsequent/concurrent attempts.
   - WARN on 409 conflicts; ERROR on unexpected failures.
   - All logs include requestId and ownerId (no PII beyond ownerId).
5. Tests:
   - Double finalize: only one holder performs side effects; the other gets `{ idempotent: true }`; `finalizedAt` remains stable.
   - Concurrency: in‑flight finalize returns `{ status: 'finalizing' }` to concurrent callers; upon completion, subsequent call returns finalized record.
   - Failure path clears `finalizing_at` allowing retry; no partial records.
   - Initialize with duplicate title → 409 and no DB insert.

## Tasks / Subtasks

- [x] Schema & Migration
  - [x] Add columns to `moc_instructions`:
    - [x] `finalized_at timestamptz null`
    - [x] `finalizing_at timestamptz null` (transient lock)
  - [x] Update Drizzle schema in `apps/api/core/database/schema/index.ts` to include `finalizedAt` and `finalizingAt` (camelCase mappings).
  - [x] Config: add `FINALIZE_LOCK_TTL_MINUTES` to runtime config (default 5).
- [x] Finalize Handler Idempotency & Concurrency
  - [x] In `apps/api/endpoints/moc-instructions/finalize-with-files/handler.ts` implement:
    - [x] Acquire lock: `UPDATE ... SET finalizing_at = now() WHERE id=:mocId AND finalized_at IS NULL AND (finalizing_at IS NULL OR finalizing_at < now() - interval ':ttl minutes') RETURNING *`.
    - [x] If row returned (we hold lock): perform S3 verification, thumbnail assignment, OpenSearch index; on success, `UPDATE ... SET finalized_at = now(), finalizing_at = NULL RETURNING *`; on failure, `UPDATE ... SET finalizing_at = NULL` and return error.
    - [x] If no row returned: read current record — if `finalized_at` set → short-circuit with `{ idempotent: true }`; else return `{ idempotent: true, status: 'finalizing' }`.
    - [x] Ensure logs include `{ requestId, ownerId: userId, mocId, idempotent, status }`.
- [x] Initialize Handler Conflict Handling
  - [x] In `apps/api/endpoints/moc-instructions/initialize-with-files/handler.ts`:
    - [x] Pre-check for existing MOC with same `{ userId, title }`; if found, throw `ConflictError` with friendly message.
    - [x] Wrap insert in try/catch; on Postgres unique violation (code `23505` for `moc_instructions_user_title_unique`), throw `ConflictError`.
    - [x] Ensure no file records are created when a conflict is detected.
- [x] Tests (Vitest)
  - [x] Concurrency: two finalize calls — only one performs side effects; other returns `{ idempotent: true, status: 'finalizing' }`; after completion, both read finalized record.
  - [x] Failure path: simulate S3 verification error → `finalizing_at` cleared; subsequent finalize can proceed.
  - [x] Duplicate title returns 409; response uses standard error shape; no MOC insert.
  - [x] Mock OpenSearch as needed; assert logs contain `requestId` and `ownerId`.
- [x] Docs
  - [x] Update API docs describing two‑phase finalize, lock TTL, idempotent responses, and 409 conflict semantics.

## Dev Notes

- The schema already enforces unique `(user_id, title)` via `moc_instructions_user_title_unique`. We still add an application-level pre-check to return a friendly 409 before relying on DB errors, and catch 23505 as a second line of defense.
- OpenSearch indexing is idempotent by document ID; still, we short-circuit to avoid redundant work and logs.
- Use existing error/response builders (`ConflictError`, `errorResponseFromError`, `successResponse`).
- Include `requestId = event.requestContext.requestId` and `ownerId = userId` in logs via `@/core/observability/logger`.

## Change Log

| Date       | Version | Description                            | Author |
| ---------- | ------- | -------------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft created from PRD (3.1.7) | SM     |
