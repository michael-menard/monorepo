# Story 6.2: Environment Configuration Updates

## Status

Draft

## Story

**As a** Frontend Developer,
**I want** API Gateway URLs configured for all environments (dev, staging, production),
**so that** the frontend can connect to the serverless backend when the feature flag is enabled.

## Acceptance Criteria

### Functional Requirements

1. API Gateway URLs obtained from DevOps for dev, staging, and production environments
2. `VITE_SERVERLESS_API_URL` configured in all environment files
3. `src/config/api.ts` updated to support serverless base URL alongside Express URL
4. Health check endpoint validated against each serverless environment

### Integration Requirements

5. Existing Express API configuration remains unchanged (backward compatibility)
6. Environment-based URL selection works correctly (dev/staging/prod)
7. CORS configuration verified for frontend origin in all environments

### Quality Requirements

8. Environment variable validation enforces required format for API Gateway URLs
9. Build fails if `VITE_SERVERLESS_API_URL` is missing when feature flag enabled
10. Documentation updated with actual API Gateway URLs for each environment

**Integration Verification:**

- IV1: With feature flag disabled, Express URLs still used (no regression)
- IV2: With feature flag enabled in dev, health check succeeds against dev serverless API
- IV3: Staging and production URLs documented for future rollout phases

## Tasks / Subtasks

- [ ] **Task 1: Obtain API Gateway URLs from DevOps** (AC: 1)
  - [ ] Request API Gateway URLs for dev environment from DevOps team
  - [ ] Request API Gateway URLs for staging environment from DevOps team
  - [ ] Request API Gateway URLs for production environment from DevOps team
  - [ ] Verify URLs follow expected format: `https://{id}.execute-api.{region}.amazonaws.com/{stage}`
  - [ ] Document whether custom domain is used or default API Gateway URL

- [ ] **Task 2: Update environment configuration files** (AC: 2)
  - [ ] Add `VITE_SERVERLESS_API_URL` to `.env` (dev URL)
  - [ ] Add `VITE_SERVERLESS_API_URL` to `.env.staging` (staging URL)
  - [ ] Add `VITE_SERVERLESS_API_URL` to `.env.production` (production URL)
  - [ ] Update `env.example` with placeholder URL and documentation

- [ ] **Task 3: Update API configuration module** (AC: 3, 5)
  - [ ] Modify `src/config/api.ts` to include `serverlessApi` in `API_CONFIG`
  - [ ] Add serverless URLs for each environment (development, staging, production)
  - [ ] Ensure `currentConfig` respects feature flag when selecting base URL
  - [ ] Maintain backward compatibility with existing Express config

- [ ] **Task 4: Update API client to use serverless URL** (AC: 3)
  - [ ] Modify `src/services/apiClient.ts` `getLegoApiUrl()` method
  - [ ] Check feature flag, return serverless URL if enabled, Express URL if disabled
  - [ ] Ensure auth headers (Cognito JWT) included for serverless requests
  - [ ] Verify timeout and retry settings appropriate for Lambda cold starts

- [ ] **Task 5: Environment variable validation** (AC: 8, 9)
  - [ ] Update `src/config/env-loader.ts` to validate `VITE_SERVERLESS_API_URL` format
  - [ ] Enforce HTTPS URL format validation (reject HTTP in production)
  - [ ] Add build-time check: fail if flag enabled but serverless URL missing
  - [ ] Log warning if serverless URL not set in development

- [ ] **Task 6: CORS configuration verification** (AC: 7)
  - [ ] Coordinate with backend team to verify CORS settings on API Gateway
  - [ ] Ensure frontend origin (`https://app.domain.com`) allowed in production
  - [ ] Verify staging origin allowed in staging environment
  - [ ] Test preflight OPTIONS requests succeed from browser

- [ ] **Task 7: Health check validation** (AC: 4)
  - [ ] Test `/health` endpoint against dev serverless API
  - [ ] Test `/health` endpoint against staging serverless API
  - [ ] Test `/health` endpoint against production serverless API
  - [ ] Document response format and expected status code (200 OK)

- [ ] **Task 8: Integration testing** (AC: IV1, IV2, IV3)
  - [ ] Test with feature flag disabled - verify Express URL used
  - [ ] Test with feature flag enabled - verify serverless URL used
  - [ ] Verify environment-based URL selection (dev env uses dev URL)
  - [ ] Document URLs for staging and production rollout phases

- [ ] **Task 9: Documentation** (AC: 10)
  - [ ] Update `README.md` with "Environment Configuration" section
  - [ ] Document API Gateway URLs for each environment
  - [ ] Add troubleshooting guide for connection issues
  - [ ] Document how to update URLs if API Gateway redeployed

## Dev Notes

### Project Context

This story is **Story 6.2** from **Phase 1: Preparation & Infrastructure** of the Frontend Serverless Migration epic. This story provides the actual endpoint URLs needed for serverless connectivity.

**Project:** Frontend Serverless Migration
**Epic:** FRONTEND-SERVERLESS-MIGRATION (15 stories total)
**Project Brief:** `docs/brief-frontend-serverless-migration.md`
**Epic Overview:** `docs/stories/frontend-serverless-migration-epic.md`

### Previous Story Insights

**Story 6.1 (Feature Flag Infrastructure):**

- Feature flag infrastructure created with `VITE_USE_SERVERLESS_API`
- API client prepared to accept dynamic base URL
- Validation framework in place for environment variables

### Critical Risk Mitigation

This story directly addresses:

- **Risk 1.1 (API Gateway URL Configuration):** Prevents all API calls failing due to wrong URLs
- **Risk 1.2 (CORS Configuration Mismatch):** Validates preflight requests work
- **Risk 6.1 (Missing Environment Variables):** Ensures URLs present in all environments

### Tech Stack for This Story

[Source: docs/architecture/tech-stack.md]

- **Backend:** AWS Lambda + API Gateway v2 (HTTP API)
- **Frontend Build:** Vite 6 (environment variable handling)
- **Environment Management:** `.env` files per environment
- **Validation:** Zod schemas for environment variable validation

### Existing Patterns to Follow

[Source: apps/web/lego-moc-instructions-app/src/config/api.ts, lines 1-85]

Current structure:

```typescript
export const API_CONFIG = {
  development: {
    AUTH_API_URL: 'http://localhost:3001',
    LEGO_API_URL: 'http://localhost:3000',
  },
  staging: {
    /* ... */
  },
  production: {
    /* ... */
  },
}
```

**New structure to add:**

```typescript
export const API_CONFIG = {
  development: {
    AUTH_API_URL: 'http://localhost:3001',
    LEGO_API_URL: 'http://localhost:3000',
    SERVERLESS_API_URL: 'https://xxx.execute-api.us-east-1.amazonaws.com/dev', // NEW
  },
  // ... staging and production
}
```

### Integration Points

**Files to Modify:**

1. `.env`, `.env.staging`, `.env.production` - ADD `VITE_SERVERLESS_API_URL`
2. `env.example` - DOCUMENT new variable
3. `src/config/api.ts` - ADD serverless URL config
4. `src/services/apiClient.ts` - MODIFY to use serverless URL when flag enabled
5. `src/config/env-loader.ts` - ADD validation
6. `README.md` - DOCUMENT URLs

**Dependencies:**

- **Depends on:** Story 6.1 (feature flag infrastructure must exist first)
- **Blocks:** Story 6.5 (RTK Query updates need URLs configured)
- **Blocks:** Story 6.9 (staging validation needs staging URL)

### Coordination Required

**DevOps Team:**

- Provide API Gateway URLs for all environments
- Confirm CORS configuration on API Gateway
- Verify custom domain setup (if applicable)

**Backend Team:**

- Confirm `/health` endpoint deployed and accessible
- Verify JWT Lambda authorizer configured
- Confirm CORS headers returned correctly

### Testing Strategy

**Unit Tests:**

- `env-loader.test.ts` - Test URL validation (HTTPS required, valid format)
- `api.test.ts` - Test environment-based URL selection
- `apiClient.test.ts` - Test URL returned based on feature flag

**Integration Tests:**

- Manual testing: Enable flag, verify health check succeeds
- Manual testing: Disable flag, verify Express still works
- Browser DevTools: Inspect network requests confirm correct URL

**E2E Tests:**

- Not required for this story (E2E updates in Story 6.10)

### Known Challenges

**Challenge 1: API Gateway URLs Not Available**

- **Impact:** Cannot complete story without URLs
- **Mitigation:** Coordinate with DevOps in advance (sprint planning)
- **Workaround:** Use placeholder URLs for development, update when available

**Challenge 2: CORS Misconfiguration**

- **Impact:** Preflight requests fail, app cannot connect
- **Mitigation:** Test CORS early, coordinate with backend team
- **Validation:** Use browser DevTools to inspect preflight OPTIONS requests

**Challenge 3: Custom Domain vs Default Gateway URL**

- **Impact:** Uncertainty about which URL to use
- **Mitigation:** Confirm with DevOps which URL is canonical
- **Documentation:** Document both URLs if applicable

### Definition of Done Checklist

- [ ] API Gateway URLs obtained for all environments
- [ ] Environment variables configured in all `.env` files
- [ ] API config module updated with serverless URLs
- [ ] API client uses serverless URL when flag enabled
- [ ] Environment variable validation implemented
- [ ] CORS configuration verified in all environments
- [ ] Health check validated against all serverless environments
- [ ] Integration tests pass (both flag states)
- [ ] Documentation updated with actual URLs
- [ ] Code reviewed and approved
- [ ] Merged to main branch

### Rollback Plan

**If this story causes issues:**

1. Feature flag defaults to `false` (Express), so no production impact
2. Revert PR if validation breaks existing functionality
3. URLs can be updated post-deployment if incorrect

### Estimated Effort

**Story Points:** 3
**Time Estimate:** 4-6 hours (includes coordination time with DevOps)
**Complexity:** Low-Medium

### Success Metrics

- Health check succeeds in all environments: ✅
- CORS preflight requests return 200 OK: ✅
- Feature flag toggles between Express and Serverless correctly: ✅
- Zero regression in Express API calls: ✅

### Next Steps After This Story

Once this story is complete:

1. **Story 6.3** can begin (local development with SST)
2. **Story 6.5** can begin (RTK Query endpoint updates)
3. **Story 6.9** can begin (staging validation with real URLs)

---

**Story Version:** 1.0
**Last Updated:** 2025-11-23
**Ready for Development:** Yes (pending API Gateway URLs from DevOps)
