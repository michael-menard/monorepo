# Story 3.8: Implement Gallery and Wishlist Search

**Epic**: 3 - Gallery & Wishlist APIs Migration

**As a** user,
**I want** to search my gallery and wishlist by keywords,
**so that** I can quickly find specific items.

## Acceptance Criteria

1. `GET /api/images?search=query` searches gallery via OpenSearch multi-match on `title`, `description`, `tags`
2. `GET /api/wishlist?search=query` searches wishlist via OpenSearch multi-match on `title`, `description`, `category`
3. User ID filter enforced (search only own items)
4. Fallback to PostgreSQL `ILIKE` queries if OpenSearch unavailable
5. Search results paginated with `page` and `limit` parameters
6. Fuzzy matching enabled for typo tolerance
7. Results sorted by relevance score
8. Response includes total hits: `{ success: true, data: [...], total: number }`
9. Search performance metrics logged
10. Cache search results in Redis with short TTL (2 minutes)

## Implementation Status

**Status**: Not Started

## Files Modified

_To be populated during implementation_

## QA Results

_Pending implementation and review_

---

## Requirements Traceability Matrix

| AC # | Requirement                            | Test Coverage | Status   |
| ---- | -------------------------------------- | ------------- | -------- |
| 1    | Gallery search via OpenSearch          | TBD           | ⏳ PENDING |
| 2    | Wishlist search via OpenSearch         | TBD           | ⏳ PENDING |
| 3    | User ID filter enforced                | TBD           | ⏳ PENDING |
| 4    | PostgreSQL fallback                    | TBD           | ⏳ PENDING |
| 5    | Pagination support                     | TBD           | ⏳ PENDING |
| 6    | Fuzzy matching enabled                 | TBD           | ⏳ PENDING |
| 7    | Relevance sorting                      | TBD           | ⏳ PENDING |
| 8    | Response with total hits               | TBD           | ⏳ PENDING |
| 9    | Performance metrics logged             | TBD           | ⏳ PENDING |
| 10   | Redis caching (2 min TTL)              | TBD           | ⏳ PENDING |

**Overall Coverage: TBD**

---

## Test Summary

_To be populated during implementation_

### Recommended Test Coverage

1. **Gallery Search** - 5 tests
   - Search by title
   - Search by description
   - Search by tags
   - Multi-field match
   - User isolation (only own images)

2. **Wishlist Search** - 4 tests
   - Search by title
   - Search by description
   - Search by category
   - User isolation

3. **Pagination** - 2 tests
   - Page 1 with limit
   - Page 2 navigation

4. **Fuzzy Matching** - 2 tests
   - Typo tolerance in gallery
   - Typo tolerance in wishlist

5. **Fallback** - 2 tests
   - PostgreSQL fallback when OpenSearch fails (gallery)
   - PostgreSQL fallback when OpenSearch fails (wishlist)

6. **Caching** - 2 tests
   - Search results cached
   - Cache TTL verified (2 minutes)

7. **Performance** - 1 test
   - Metrics logged for search operations

---

## Technical Notes

### OpenSearch Query Structure

**Gallery Search** (`gallery_images` index):

```json
{
  "query": {
    "bool": {
      "must": [
        {
          "multi_match": {
            "query": "lego castle",
            "fields": ["title^3", "description^2", "tags"],
            "fuzziness": "AUTO",
            "operator": "or"
          }
        },
        {
          "term": { "userId": "cognito-user-id" }
        }
      ]
    }
  },
  "from": 0,
  "size": 20,
  "sort": [{ "_score": "desc" }]
}
```

**Wishlist Search** (`wishlist_items` index):

```json
{
  "query": {
    "bool": {
      "must": [
        {
          "multi_match": {
            "query": "millennium falcon",
            "fields": ["title^3", "description^2", "category"],
            "fuzziness": "AUTO",
            "operator": "or"
          }
        },
        {
          "term": { "userId": "cognito-user-id" }
        }
      ]
    }
  },
  "from": 0,
  "size": 20,
  "sort": [{ "_score": "desc" }]
}
```

### Field Boosting

- **title**: Boost factor of 3 (highest relevance)
- **description**: Boost factor of 2
- **tags/category**: Boost factor of 1 (default)

### Fuzzy Matching

```typescript
fuzziness: "AUTO"
// AUTO = 0 for 1-2 char terms, 1 for 3-5 chars, 2 for >5 chars
```

### PostgreSQL Fallback

```typescript
// Gallery fallback
const images = await db
  .select()
  .from(galleryImages)
  .where(
    and(
      eq(galleryImages.userId, userId),
      or(
        sql`${galleryImages.title} ILIKE ${`%${query}%`}`,
        sql`${galleryImages.description} ILIKE ${`%${query}%`}`,
        sql`${galleryImages.tags}::text ILIKE ${`%${query}%`}`
      )
    )
  )
  .limit(limit)
  .offset(offset)

// Wishlist fallback
const items = await db
  .select()
  .from(wishlistItems)
  .where(
    and(
      eq(wishlistItems.userId, userId),
      or(
        sql`${wishlistItems.title} ILIKE ${`%${query}%`}`,
        sql`${wishlistItems.description} ILIKE ${`%${query}%`}`,
        sql`${wishlistItems.category} ILIKE ${`%${query}%`}`
      )
    )
  )
  .orderBy(wishlistItems.sortOrder)
  .limit(limit)
  .offset(offset)
```

### Caching Strategy

**Cache Keys**:
- Gallery: `gallery:search:{userId}:query:{hash}:page:{page}:limit:{limit}`
- Wishlist: `wishlist:search:{userId}:query:{hash}:page:{page}:limit:{limit}`

**Hash**: MD5 of search query for key safety

**TTL**: 2 minutes (120 seconds)

```typescript
const cacheKey = `gallery:search:${userId}:query:${md5(query)}:page:${page}:limit:${limit}`
await redis.setEx(cacheKey, 120, JSON.stringify(results))
```

### Performance Metrics

```typescript
const searchStart = Date.now()
const results = await searchOpenSearch(...)
const searchDuration = Date.now() - searchStart

console.log({
  type: 'search_performance',
  index: 'gallery_images',
  query: query,
  duration: searchDuration,
  resultCount: results.length,
  totalHits: results.total,
  source: 'opensearch', // or 'postgres'
})
```

### Response Format

```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "title": "LEGO Castle",
      "description": "Medieval castle build",
      "imageUrl": "https://...",
      "score": 2.456
    }
  ],
  "total": 42,
  "pagination": {
    "page": 1,
    "limit": 20,
    "totalPages": 3
  },
  "timestamp": "2025-01-02T12:00:00Z"
}
```

### Error Handling

- **Empty query** → 400 VALIDATION_ERROR
- **Invalid pagination** → 400 VALIDATION_ERROR
- **OpenSearch failure** → Fallback to PostgreSQL (log warning)
- **Both OpenSearch and PostgreSQL fail** → 500 SEARCH_ERROR

---

## Dependencies

- **Story 3.3**: Gallery CRUD (provides indexing)
- **Story 3.6**: Wishlist CRUD (provides indexing)
- OpenSearch indices must be created and populated by previous stories

---

## Integration Points

### OpenSearch Indices

Must be created by Stories 3.2, 3.3, and 3.6:

- `gallery_images` - Created in Stories 3.2 & 3.3
- `wishlist_items` - Created in Story 3.6

### Index Mappings

**gallery_images**:
```json
{
  "mappings": {
    "properties": {
      "userId": { "type": "keyword" },
      "title": { "type": "text" },
      "description": { "type": "text" },
      "tags": { "type": "text" },
      "createdAt": { "type": "date" }
    }
  }
}
```

**wishlist_items**:
```json
{
  "mappings": {
    "properties": {
      "userId": { "type": "keyword" },
      "title": { "type": "text" },
      "description": { "type": "text" },
      "category": { "type": "text" },
      "sortOrder": { "type": "keyword" },
      "createdAt": { "type": "date" }
    }
  }
}
```
