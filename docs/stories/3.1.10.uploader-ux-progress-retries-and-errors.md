# Story 3.1.10: Uploader UX — Progress, Retries, and Error States

## Status

Implemented

## Story

As a creator,
I want clear per‑file progress, recoverable errors, and simple retries,
so my uploads feel reliable and I can complete the flow without losing work.

## Acceptance Criteria

1. Per‑file progress and states (FR16, FR21)

- Each file shows: name, size, type, status (queued | uploading | success | failed | canceled | expired), and % progress.
- Progressbars are accessible: role="progressbar" + aria‑valuenow/min/max; announce major state changes via aria‑live (polite).
- Aggregate header shows overall progress (optional) and counts (success/failed/queued).

2. Concurrency, cancel, retry (FR16)

- Configurable concurrency (default 3). New uploads start as slots free.
- Cancel in‑flight upload via AbortController; state → canceled; slot freed.
- Retry reuses existing File handle if still present; otherwise user can re‑select.

3. Error mapping → friendly messages (FR11, FR21)

- 401/403 during upload/registration → "Session expired. Please sign in and retry." Preserve state.
- API code EXPIRED_SESSION → mark expired; CTA "Refresh session".
- 413 Payload Too Large → "Too large. Max <X MB> for <type>." Values from env config.
- 415/400 invalid type → "Unsupported type. Allowed: <list>." Values from env config.
- 5xx/network → "Temporary issue. Retry." Keep state intact.
- Finalize 409 (duplicate title) → show conflict modal; allow in‑place title change and re‑finalize without re‑upload.
- Finalize 429 → show retry‑after countdown per 3.1.6; disable finalize during countdown.

4. Expired upload session (FR15, FR16)

- Detect session expiry: before upload/registration (session staleness), or during upload (API returns EXPIRED_SESSION). State → expired.
- Provide "Refresh session" to call session refresh for affected files only.
- Refresh preserves successful uploads; do not re‑upload those.

5. Finalize gating and recovery (FR8, FR13, FR17)

- Finalize button disabled until required PDF is in success state and form is valid.
- On finalize, show busy state; short‑circuit on idempotent double‑click (3.1.7).
- If finalize fails with per‑file validation errors (e.g., magic‑bytes mismatch from 3.1.8), surface specific items and keep others intact; allow selective retry.

6. Logging & A11y (NFR2, NFR7)

- @repo/logger: info on start/complete/cancel/retry per file; warn on failures; include correlationId/requestId if provided by API, route, userId.
- Announce major events via aria‑live; ensure keyboard access to cancel/retry actions; focus returns to an expected, logical element after actions.

7. Tests (Vitest + RTL)

- Upload manager unit tests: concurrency, progress aggregation, cancel/retry, expiry refresh.
- Error mapping tests: map representative 401/403/413/415/5xx to copy above.
- Finalize integration: 409 path (title edit) and 429 path (countdown) without re‑uploads.
- A11y: progressbars expose correct aria attributes; dialog focus‑trap and keyboard nav.

## Tasks / Subtasks

- [x] Types & schema (Zod)
  - [x] Add `apps/web/main-app/src/types/uploader-upload.ts` with `UploaderFileItemSchema`:
    - fields: `id, category (instruction|parts-list|image|thumbnail), name, size, type, lastModified, status, progress (0-100), errorCode?, expired?`.
  - [x] Optional aggregate schema for batch state (counts, overallProgress).

- [x] Upload Manager (hook + service)
  - [x] Create `useUploadManager` in `apps/web/main-app/src/hooks/useUploadManager.ts`:
    - [x] Accept files + category; ensure/refresh upload session via API; register files; schedule part uploads with concurrency and AbortController; emit progress.
    - [x] Map errors per AC; detect EXPIRED_SESSION; expose `cancel(fileId)`, `retry(fileId)`, `refreshSession()`.
  - [x] Create `uploadClient` in `apps/web/main-app/src/services/api/uploadClient.ts`:
    - [x] Use XHR for PUT to our API endpoints to enable progress events; set Content‑Type.
    - [x] Surface structured errors with `code` and `httpStatus` for mapping.

- [x] UI Components (use @repo/ui)
  - [x] `UploaderFileItem` at `apps/web/main-app/src/components/Uploader/UploaderFileItem/index.tsx` (progressbar, actions, a11y).
  - [x] `UploaderList` at `apps/web/main-app/src/components/Uploader/UploaderList/index.tsx` (group by category; aggregate header).
  - [x] Integrate into Uploader route page (`/instructions/new`), replacing PlaceholderPage; wire finalize button state per AC.

- [x] Error states & finalize UX
  - [x] Conflict modal on 409 with in‑place title edit and retry finalize.
  - [x] Rate‑limit banner on 429 with countdown (retryAfterSeconds) per 3.1.6.
  - [x] Display finalize validation errors from 3.1.8 (magic‑bytes mismatch) inline with per‑file items and allow targeted retry.

- [x] Tests
  - [x] Unit: `useUploadManager` (mock XHR); `uploadClient` error mapping.
  - [ ] Integration: route with mock API for initialize/upload/finalize; verify UI flows (cancel, retry, 409 fix, 429 countdown).
  - [x] A11y unit checks for progress and dialogs.

- [ ] Docs
  - [ ] Update PRD/architecture docs with error‑mapping table and accessibility notes for progress and dialogs.

## Dev Notes

- Follow CLAUDE.md: Zod‑first types; functional components; no barrel files; UI from @repo/ui; logging from @repo/logger; Tailwind + a11y.
- For progress, use XHR (`xhr.upload.onprogress`) — fetch lacks upload progress events in browsers.
- Do not store File/Blob in Redux or localStorage; keep File references in component state only.
- Concurrency default 3; consider env or config module later.
- Reuse 3.1.9 session persistence and unsaved‑changes guard.
- Use consistent error shapes from server: { code, message, details?, correlationId } and map to friendly copy.

### Auth, Cookies, and CSRF

- Cookie-based (HttpOnly) session auth.
- Frontend MUST send `credentials: 'include'` and MUST NOT send `Authorization` headers.
- Cookie attributes: `HttpOnly`; `Secure`; `SameSite=Lax` (recommended) or `SameSite=None; Secure` when API is on a different site/domain.
- CORS: `Access-Control-Allow-Credentials: true`; `Access-Control-Allow-Origin` must be the exact client origin (no `*`). Include `Vary: Origin`.
- Responses are JSON; clients send `Accept: application/json`.
- CSRF for unsafe methods (POST/PUT/PATCH/DELETE): require `X-CSRF-Token` and verify server-side (double-submit cookie or session-bound token). GET endpoints do not require CSRF.

Ensure:

- RTK Query uses `credentials: 'include'` and does not set `Authorization`.
- XHR uploads use `withCredentials = true` and appropriate `Content-Type` (e.g., `application/octet-stream` for binary part uploads).
- Backend sets cookies with `HttpOnly`; `Secure`; `SameSite` (Lax or None+Secure) and CORS allows credentials for the exact origin.
- Optional `X-CSRF-Token` header is included on unsafe methods when CSRF is enabled.

## Change Log

| Date       | Version | Description                                                              | Author |
| ---------- | ------- | ------------------------------------------------------------------------ | ------ |
| 2025-12-06 | 0.1     | Initial draft created (progress, retries, errors)                        | SM     |
| 2025-12-07 | 1.0     | Implemented: types, upload manager, UI components, error handling, tests | AI     |
