# Story 3.1.24: Expiry & Interrupted Uploads â€” Auto-Refresh & Resume

## Status

Approved

## Story

As a creator,
I want uploads to recover from expiry and interruptions,
so I can finish without starting over.

## Acceptance Criteria

1. Expiry detection

- Detect expired upload session via API error code EXPIRED_SESSION or local ttl > sessionTtlMinutes; mark files expired.

2. Auto-refresh flow

- "Refresh session" re-creates the upload session or re-registers affected files; preserve successful uploads; do not re-upload them.

3. Resume interrupted

- Allow retry for failed/canceled with existing File handle when available; otherwise prompt re-select.

4. Tests

- upload manager: expiry detection and refresh; resume flows.

## Tasks / Subtasks

- [ ] Implement refresh in useUploadManager
- [ ] UI hooks to trigger refresh and retries
- [ ] Tests

## Dev Notes

- Respect upload session TTL from 3.1.8; store issuedAt per session to estimate staleness.

### Auth, Cookies, and CSRF

- Cookie-based (HttpOnly) session auth.
- Frontend MUST send `credentials: 'include'` and MUST NOT send `Authorization` headers.
- Cookie attributes: `HttpOnly`; `Secure`; `SameSite=Lax` (recommended) or `SameSite=None; Secure` when API is on a different site/domain.
- CORS: `Access-Control-Allow-Credentials: true`; `Access-Control-Allow-Origin` must be the exact client origin (no `*`). Include `Vary: Origin`.
- Responses are JSON; clients send `Accept: application/json`.
- CSRF for unsafe methods (POST/PUT/PATCH/DELETE): require `X-CSRF-Token` and verify server-side (double-submit cookie or session-bound token). GET endpoints do not require CSRF.

Ensure:

- RTK Query uses `credentials: 'include'` and does not set `Authorization`.
- XHR uploads use `withCredentials = true` and appropriate `Content-Type` (e.g., `application/octet-stream` for binary part uploads).
- Backend sets cookies with `HttpOnly`; `Secure`; `SameSite` (Lax or None+Secure) and CORS allows credentials for the exact origin.
- Optional `X-CSRF-Token` header is included on unsafe methods when CSRF is enabled.

## Change Log

| Date       | Version | Description                           | Author |
| ---------- | ------- | ------------------------------------- | ------ |
| 2025-12-06 | 0.1     | Initial draft (expiry/resume uploads) | SM     |
