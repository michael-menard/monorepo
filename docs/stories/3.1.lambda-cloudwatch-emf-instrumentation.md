# Story 3.1: Lambda CloudWatch EMF Instrumentation

## Status

Draft

## Story

**As a** Backend Developer,
**I want** Lambda functions instrumented with CloudWatch Embedded Metric Format,
**so that** custom application metrics appear in Grafana dashboards.

## Acceptance Criteria

1. CloudWatch EMF library installed in Lambda project dependencies
2. Lambda wrapper utility enhanced to emit EMF metrics (cold start, business metrics)
3. Custom metrics defined: execution duration, cold start indicator, error count, invocation count per function
4. Metrics published asynchronously to avoid adding latency
5. Environment-specific metric namespaces configured (dev vs prod)
6. Test metric queries validated in CloudWatch Metrics console before Grafana

**Integration Verification:**

- IV1: Existing Lambda function logic unchanged and tests still pass
- IV2: Lambda execution time increase <50ms due to EMF overhead
- IV3: No errors introduced in Lambda error handling flow

## Tasks / Subtasks

- [ ] **Task 1: Install and configure CloudWatch EMF library** (AC: 1, 5)
  - [ ] Install `aws-embedded-metrics` npm package in Lambda project
  - [ ] Create EMF configuration module in `src/lib/tracking/cloudwatch-emf.ts`
  - [ ] Configure environment-specific metric namespaces: `UserMetrics/Lambda/{stage}`
  - [ ] Set up EMF logger with appropriate configuration (async mode, no stdout)
  - [ ] Configure metric dimensions: FunctionName, Environment, RequestId
  - [ ] Test EMF library initialization and basic metric publishing

- [ ] **Task 2: Enhance Lambda wrapper with EMF metrics** (AC: 2, 3, 4)
  - [ ] Modify existing `lambda-wrapper.ts` to integrate EMF metric publishing
  - [ ] Add cold start detection logic (check if container is reused)
  - [ ] Implement execution duration measurement (start to end of handler)
  - [ ] Add invocation count metric (increment on each handler call)
  - [ ] Add error count metric (increment on caught exceptions)
  - [ ] Ensure all metrics published asynchronously after response
  - [ ] Preserve existing error handling and X-Ray tracing functionality

- [ ] **Task 3: Define custom business metrics** (AC: 3, 5)
  - [ ] Create metric definitions for Lambda performance:
    - ExecutionDuration (milliseconds)
    - ColdStartIndicator (boolean/count)
    - ErrorCount (count by error type)
    - InvocationCount (count)
    - MemoryUtilization (percentage)
  - [ ] Add function-specific business metrics:
    - DatabaseQueryCount (per function)
    - S3OperationCount (per function)
    - OpenSearchQueryCount (per function)
  - [ ] Configure metric units and dimensions appropriately
  - [ ] Set up metric aggregation periods (1 minute, 5 minutes)

- [ ] **Task 4: Implement asynchronous metric publishing** (AC: 4, IV2)
  - [ ] Configure EMF to publish metrics after Lambda response
  - [ ] Implement metric batching to reduce API calls
  - [ ] Add error handling for metric publishing failures (non-blocking)
  - [ ] Set up metric publishing timeout (max 100ms)
  - [ ] Validate that metric publishing doesn't add latency to response
  - [ ] Test metric publishing under high load scenarios

- [ ] **Task 5: Update existing Lambda functions with EMF instrumentation** (AC: 2, 6)
  - [ ] Apply EMF wrapper to all existing Lambda functions:
    - MOC Instructions functions
    - Gallery image functions
    - Wishlist functions
    - User profile functions
    - WebSocket functions
  - [ ] Preserve existing function signatures and behavior
  - [ ] Update function configurations if needed (memory, timeout)
  - [ ] Test each instrumented function individually

- [ ] **Task 6: Validate metrics in CloudWatch console** (AC: 6, IV1-IV3)
  - [ ] Deploy instrumented functions to dev environment
  - [ ] Generate test traffic to trigger metric publishing
  - [ ] Verify metrics appear in CloudWatch Metrics console under UserMetrics/Lambda namespace
  - [ ] Test metric queries and aggregations
  - [ ] Validate metric dimensions and values are correct
  - [ ] Confirm existing Lambda functionality unchanged
  - [ ] Measure performance impact (<50ms overhead requirement)

- [ ] **Task 7: Create EMF metric documentation and monitoring** (AC: 1-6)
  - [ ] Document EMF metric definitions and purposes
  - [ ] Create troubleshooting guide for EMF metric issues
  - [ ] Document metric namespace and dimension structure
  - [ ] Create CloudWatch dashboard queries for new EMF metrics
  - [ ] Set up CloudWatch alarms for critical EMF metrics
  - [ ] Document integration with existing monitoring systems

## Dev Notes

### Project Context

This story is **Story 3.1** from **Phase 3: Application Instrumentation** of the User Metrics PRD brownfield enhancement. This is the first story in Phase 3, following completion of Phase 2 (Amazon Managed Grafana & CloudWatch).

**Project:** User Tracking & Metrics Implementation (Brownfield Enhancement)
**Epic:** Phase 3 - Application Instrumentation (5 stories total)
**PRD Location:** `docs/prd/user-metrics/user-metrics-prd.md`
**Architecture:** `docs/prd/user-metrics/user-metrics-architecture.md`
**Phase File:** `docs/prd/user-metrics/phase-3.md`

### Previous Phase Dependencies

**Phase 2 Completion Requirements:**

- Story 2.1: Amazon Managed Grafana workspace provisioned
- Story 2.2: CloudWatch data sources configured in Grafana
- Story 2.3: Initial Grafana dashboards created
- Story 2.4: OpenSearch integration for log analysis

**Relevant Context from Previous Phases:**

- **CloudWatch Dashboards** (Story 2.3): EMF metrics will enhance existing Lambda performance dashboard
- **Cost Budget** (Story 1.4): EMF API calls must stay within CloudWatch free tier limits
- **Tagging Schema** (Story 1.1): EMF metrics will use consistent tagging for cost tracking

### Tech Stack for This Story

[Source: apps/api/lego-api-serverless/package.json, src/lib/utils/lambda-wrapper.ts]

**CloudWatch EMF:**

- **Library:** `aws-embedded-metrics` npm package
- **Publishing Mode:** Asynchronous (non-blocking)
- **Namespace:** `UserMetrics/Lambda/{stage}`
- **Dimensions:** FunctionName, Environment, RequestId

**Existing Lambda Infrastructure:**

- **Runtime:** Node.js 20.x on ARM64 (Graviton2)
- **Wrapper:** Existing `lambda-wrapper.ts` with error handling, X-Ray tracing
- **Functions:** 45+ Lambda functions across MOC, Gallery, Wishlist, User, WebSocket domains
- **Monitoring:** Existing CloudWatch metrics, X-Ray tracing, structured logging
