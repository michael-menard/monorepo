# Story 3.1.21: Error Contract — Unified API + Client Mapping

## Status

Ready for Review

## Story

As a developer,
I want a unified error shape and mapping,
so the client shows consistent, actionable messages.

## Acceptance Criteria

1. Server contract

- { code, message, details?, correlationId } for all 4xx/5xx; map known codes: INVALID_TYPE, SIZE_TOO_LARGE, RATE_LIMITED, DUPLICATE_SLUG, UNAUTHORIZED, ACCESS_DENIED, EXPIRED_SESSION.

2. Client mapping

- Map codes to friendly copy and UI affordances; include retry hints; show correlationId in logs.

3. Tests

- Unit: mapping table; Integration: representative server errors → UI.

## Tasks / Subtasks

- [x] Define server error builders and codes
- [x] Client mapping module and tests
- [x] Update handlers to use contract

## Dev Notes

- Avoid leaking PII; include requestId/correlationId for support.

## Implementation Summary

### Server Side

- Updated `packages/shared/api-types/src/common/index.ts` with `ApiErrorCodeSchema` containing all known error codes
- Updated `packages/backend/lambda-responses` with new error classes: `DuplicateSlugError`, `SizeTooLargeError`, `InvalidTypeError`, `ExpiredSessionError`, `AccessDeniedError`
- All error responses now include `correlationId` in body and `X-Correlation-Id` header
- Backward-compatible wrappers in `apps/api/core/utils/` for existing handler compatibility

### Client Side

- Created `apps/web/main-app/src/services/api/errorMapping.ts` with:
  - `parseApiError()` - maps API errors to user-friendly messages
  - `parseApiErrorFromResponse()` - parses Response objects
  - `getRetryDelay()` - extracts retry timing from errors
  - `isRetryableStatus()` - determines if status code is retryable
  - `formatSupportReference()` - formats correlationId for support display
- Error mapping includes action hints: `retry`, `login`, `fix-input`, `wait`, `navigate-away`, `contact-support`

### Tests

- 27 unit tests for client error mapping module
- 41 tests for lambda-responses package
- 23 tests for handler integration

## Change Log

| Date       | Version | Description                    | Author |
| ---------- | ------- | ------------------------------ | ------ |
| 2025-12-06 | 0.1     | Initial draft (error contract) | SM     |
| 2025-12-08 | 1.0     | Implementation complete        | Claude |
