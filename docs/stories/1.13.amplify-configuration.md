# Story 1.13: Amplify Configuration

## Status

Ready for Review

## Story

**As a** developer,
**I want** AWS Amplify v6 configured for Cognito auth,
**so that** the app can authenticate users via AWS.

## Acceptance Criteria

1. âœ… @aws-amplify/auth v6 package installed (aws-amplify v6.15.7)
2. âœ… Amplify.configure() called with Cognito config
3. âœ… Environment variables for User Pool ID, Client ID, Region
4. âœ… Configuration loaded before app renders (in main.tsx)
5. âœ… TypeScript types for Amplify available
6. ðŸ”„ Backend: Cognito User Pool must exist (FE+BE coordination)

## Tasks / Subtasks

- [x] **Task 1: Verify Package Installation** (AC: 1, 5)
  - [x] Check @aws-amplify/auth in package.json (aws-amplify v6.15.7)
  - [x] Verify version is 6.x
  - [x] Check TypeScript types available

- [x] **Task 2: Create/Verify Amplify Config** (AC: 2)
  - [x] Create src/lib/amplify-config.ts
  - [x] Call Amplify.configure() with auth settings
  - [x] Export config for reference

- [x] **Task 3: Environment Variables** (AC: 3)
  - [x] Define VITE_AWS_USER_POOL_ID (existing naming convention)
  - [x] Define VITE_AWS_USER_POOL_WEB_CLIENT_ID (existing naming convention)
  - [x] Define VITE_AWS_REGION (existing naming convention)
  - [x] Already in .env.example

- [x] **Task 4: Initialize Early** (AC: 4)
  - [x] Import configureAmplify() in main.tsx
  - [x] Call configureAmplify() before React renders

## Dev Notes

### Package Installation

```bash
pnpm add @aws-amplify/auth
```

### Amplify v6 Configuration

**File:** `apps/web/main-app/src/lib/amplify-config.ts`

```typescript
import { Amplify } from 'aws-amplify'

export const amplifyConfig = {
  Auth: {
    Cognito: {
      userPoolId: import.meta.env.VITE_COGNITO_USER_POOL_ID,
      userPoolClientId: import.meta.env.VITE_COGNITO_CLIENT_ID,
      region: import.meta.env.VITE_COGNITO_REGION || 'us-east-1',
    },
  },
}

export function configureAmplify() {
  Amplify.configure(amplifyConfig)
}
```

### Environment Variables

**File:** `.env.example`

```
VITE_COGNITO_USER_POOL_ID=us-east-1_XXXXXXXXX
VITE_COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx
VITE_COGNITO_REGION=us-east-1
```

### Main.tsx Integration

```typescript
import { configureAmplify } from './lib/amplify-config'

// Configure before React
configureAmplify()

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
)
```

### Backend Coordination (FE+BE) ðŸ”„

- Cognito User Pool must be created
- User Pool ID and Client ID must be provided
- Client must allow USER_SRP_AUTH flow

### Testing

- Verify Amplify imports without error
- Test config loads env vars correctly
- Mock Amplify for unit tests

## QA Results

### Review Summary

| Attribute         | Value                                |
| ----------------- | ------------------------------------ |
| **Gate**          | PASS                                 |
| **Quality Score** | 100/100                              |
| **Review Depth**  | DEEP (infrastructure/security story) |
| **Reviewer**      | Quinn (Test Architect)               |
| **Review Date**   | 2025-11-29                           |

### Requirements Traceability

| AC  | Description                                               | Status  | Evidence                                                      |
| --- | --------------------------------------------------------- | ------- | ------------------------------------------------------------- |
| 1   | @aws-amplify/auth v6 package installed                    | âœ… PASS | package.json:40 `"aws-amplify": "6.15.7"`                     |
| 2   | Amplify.configure() called with Cognito config            | âœ… PASS | amplify-config.ts:68 `Amplify.configure(amplifyConfig)`       |
| 3   | Environment variables for User Pool ID, Client ID, Region | âœ… PASS | .env.example:9-11, amplify-config.ts:19-20                    |
| 4   | Configuration loaded before app renders                   | âœ… PASS | main.tsx:10 `configureAmplify()` before ReactDOM.createRoot   |
| 5   | TypeScript types for Amplify available                    | âœ… PASS | amplify-config.ts:9 `type ResourcesConfig from 'aws-amplify'` |
| 6   | Backend: Cognito User Pool must exist                     | ðŸ”„ N/A  | FE+BE coordination - outside FE review scope                  |

### Code Quality Assessment

| Dimension            | Rating    | Notes                                                              |
| -------------------- | --------- | ------------------------------------------------------------------ |
| **Architecture**     | Excellent | Clean module separation with single responsibility                 |
| **Type Safety**      | Excellent | Uses ResourcesConfig type from aws-amplify                         |
| **Error Handling**   | Excellent | Validates env vars, logs errors, returns boolean success indicator |
| **State Management** | Excellent | isConfigured flag prevents duplicate configuration                 |
| **Testability**      | Good      | Amplify mocked in test/setup.ts for all auth tests                 |

### Test Coverage Analysis

| Test Suite      | Coverage                                                       |
| --------------- | -------------------------------------------------------------- |
| Unit Tests      | No dedicated amplify-config.test.ts (low risk - config module) |
| Integration     | Amplify mocked in test/setup.ts for all auth flow tests        |
| Auth Page Tests | All pages mock aws-amplify/auth successfully                   |

### NFR Validation

| NFR                 | Status  | Evidence                                                                                                             |
| ------------------- | ------- | -------------------------------------------------------------------------------------------------------------------- |
| **Security**        | âœ… PASS | Sensitive values from env vars, not hardcoded. Partial logging of user pool ID (first 15 chars). No secrets exposed. |
| **Performance**     | âœ… PASS | Configuration runs once at startup. isConfigured flag prevents duplicate calls.                                      |
| **Reliability**     | âœ… PASS | Validates required env vars before configure. Returns false on missing config. Graceful degradation in dev.          |
| **Accessibility**   | N/A     | Infrastructure story - no UI components                                                                              |
| **Maintainability** | âœ… PASS | Well-documented with JSDoc. Exports helper functions (isAmplifyConfigured, getAmplifyConfig).                        |

### Risks Identified

None.

### Recommendations

**Future Improvements:**

1. Consider adding unit tests for amplify-config.ts edge cases (missing env vars, duplicate config calls)
2. AC6 (Backend coordination) should be tracked separately as FE+BE integration task

## Change Log

| Date       | Version | Description                                                           | Author      |
| ---------- | ------- | --------------------------------------------------------------------- | ----------- |
| 2025-11-28 | 0.1     | Initial draft                                                         | SM Agent    |
| 2025-11-28 | 1.0     | Implementation complete - created amplify-config.ts, updated main.tsx | Claude Code |
