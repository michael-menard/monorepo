# Story 1.29: Invalid Token Redirect

## Status

Approved

## Story

**As a** user,
**I want** to be redirected to login when my token is invalid,
**so that** I can re-authenticate and continue using the app.

## Acceptance Criteria

1. ⬜ Detect invalid token response from API (401)
2. ⬜ Clear local auth state
3. ⬜ Redirect to login with return URL
4. ⬜ Show notification explaining session expired
5. ⬜ Don't redirect during login/signup flows

## Tasks / Subtasks

- [ ] **Task 1: API Response Interceptor** (AC: 1)
  - [ ] Create RTK Query baseQuery wrapper
  - [ ] Or create Axios interceptor
  - [ ] Detect 401 Unauthorized responses

- [ ] **Task 2: State Cleanup** (AC: 2)
  - [ ] Dispatch setUnauthenticated on 401
  - [ ] Clear cached API data

- [ ] **Task 3: Redirect Logic** (AC: 3, 5)
  - [ ] Navigate to /login
  - [ ] Include current path as redirect param
  - [ ] Skip redirect if already on auth pages

- [ ] **Task 4: User Notification** (AC: 4)
  - [ ] Show toast: "Session expired. Please sign in again."
  - [ ] Use warning/info variant

## Dev Notes

### RTK Query Base Query Wrapper

**File:** `apps/web/main-app/src/services/api/baseQuery.ts`

```typescript
import { fetchBaseQuery } from '@reduxjs/toolkit/query/react'
import type { RootState } from '@/store'

const rawBaseQuery = fetchBaseQuery({
  baseUrl: import.meta.env.VITE_API_URL,
  prepareHeaders: (headers, { getState }) => {
    const token = (getState() as RootState).auth.tokens?.accessToken
    if (token) {
      headers.set('Authorization', `Bearer ${token}`)
    }
    return headers
  },
})

export const baseQueryWithReauth: typeof rawBaseQuery = async (args, api, extraOptions) => {
  let result = await rawBaseQuery(args, api, extraOptions)

  if (result.error && result.error.status === 401) {
    // Check if not on auth pages
    const currentPath = window.location.pathname
    const authPaths = ['/login', '/signup', '/forgot-password']

    if (!authPaths.some(path => currentPath.startsWith(path))) {
      // Clear auth state
      api.dispatch(setUnauthenticated())

      // Show notification
      // Note: Toast needs to be called differently in non-component context

      // Redirect
      window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}&expired=true`
    }
  }

  return result
}
```

### Handle Expired Param on Login Page

```typescript
// In LoginPage.tsx
const { expired } = useSearch({ from: '/login' })

useEffect(() => {
  if (expired) {
    toast({
      title: 'Session Expired',
      description: 'Please sign in again to continue.',
      variant: 'warning',
    })
  }
}, [expired])
```

### Global Error Handler Alternative

```typescript
// In App.tsx or a dedicated hook
useEffect(() => {
  const handleUnauthorized = (event: CustomEvent) => {
    dispatch(setUnauthenticated())
    toast({ title: 'Session expired', variant: 'warning' })
    navigate('/login')
  }

  window.addEventListener('auth:unauthorized', handleUnauthorized)
  return () => window.removeEventListener('auth:unauthorized', handleUnauthorized)
}, [])
```

### Testing

- Test 401 response triggers logout
- Test redirect includes return URL
- Test notification shows
- Test auth pages don't redirect

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-28 | 0.1     | Initial draft | SM Agent |
