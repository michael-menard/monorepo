# Story 5.5: Implement Blue/Green Deployment Strategy

**Epic**: 5 - Production Deployment, Monitoring & Cutover

**As a** DevOps engineer,
**I want** Blue/Green deployment with traffic shifting,
**so that** deployments are zero-downtime and can be quickly rolled back.

## Acceptance Criteria

1. Route53 weighted routing policy configured for API domain
2. Blue environment: Current production Lambda aliases (`production-blue`)
3. Green environment: New deployment Lambda aliases (`production-green`)
4. Traffic shift: 0% ‚Üí 10% ‚Üí 50% ‚Üí 100% over 30 minutes
5. Health checks configured to monitor green environment
6. Automatic rollback if health checks fail or error rate >5%
7. CloudWatch alarms trigger rollback on critical errors
8. Manual approval required before traffic shift to 100%
9. Database migrations run before traffic shift (idempotent)
10. Old environment (blue) retained for 24 hours for emergency rollback

## Implementation Status

**Status**: Not Started

## Files Modified

_To be populated during implementation_

## QA Results

_Pending implementation and review_

---

## Requirements Traceability Matrix

| AC # | Requirement                            | Test Coverage | Status   |
| ---- | -------------------------------------- | ------------- | -------- |
| 1    | Route53 weighted routing policy        | TBD           | ‚è≥ PENDING |
| 2    | Blue environment (production-blue)     | TBD           | ‚è≥ PENDING |
| 3    | Green environment (production-green)   | TBD           | ‚è≥ PENDING |
| 4    | Traffic shift (0% ‚Üí 10% ‚Üí 50% ‚Üí 100%)  | TBD           | ‚è≥ PENDING |
| 5    | Health checks configured               | TBD           | ‚è≥ PENDING |
| 6    | Automatic rollback on failure          | TBD           | ‚è≥ PENDING |
| 7    | CloudWatch alarms trigger rollback     | TBD           | ‚è≥ PENDING |
| 8    | Manual approval before 100% shift      | TBD           | ‚è≥ PENDING |
| 9    | Database migrations before shift       | TBD           | ‚è≥ PENDING |
| 10   | Blue environment retained 24 hours     | TBD           | ‚è≥ PENDING |

**Overall Coverage: TBD**

---

## Test Summary

_To be populated during implementation_

### Recommended Test Coverage

1. **Traffic Shifting** - 4 tests
   - Deploy green environment successfully
   - Traffic shifts to 10% after 5 minutes
   - Traffic shifts to 50% after 15 minutes
   - Traffic shifts to 100% after approval

2. **Rollback** - 3 tests
   - Automatic rollback on health check failure
   - Automatic rollback on error rate >5%
   - Manual rollback via CLI/console

3. **Health Checks** - 2 tests
   - Health checks pass on green environment
   - Health checks fail triggers rollback

4. **Database Migrations** - 1 test
   - Migrations run before traffic shift to 10%

---

## Technical Notes

### Lambda Alias Strategy

```typescript
// sst.config.ts
export default $config({
  app(input) {
    return {
      name: 'lego-api',
      removal: input?.stage === 'production' ? 'retain' : 'remove',
      home: 'aws',
    }
  },
  async run() {
    const stage = $app.stage
    const isProduction = stage === 'production'

    // Determine deployment color (blue or green)
    const deploymentColor = process.env.DEPLOYMENT_COLOR || 'green'
    const aliasName = isProduction ? `production-${deploymentColor}` : stage

    // Create Lambda functions with versioning
    const mocFunction = new sst.aws.Function('MocFunction', {
      handler: 'src/functions/moc-instructions.handler',
      runtime: 'nodejs20.x',
      timeout: '60 seconds',
      memory: '1024 MB',
      vpc,
      link: [postgres, redis, openSearch, bucket],
      environment: {
        NODE_ENV: isProduction ? 'production' : 'development',
        STAGE: stage,
        DEPLOYMENT_COLOR: deploymentColor,
      },
    })

    // Create Lambda alias for Blue/Green deployment
    const mocFunctionAlias = new aws.lambda.Alias(`MocFunctionAlias${deploymentColor}`, {
      name: aliasName,
      functionName: mocFunction.nodes.function.name,
      functionVersion: mocFunction.nodes.function.version,
    })

    // Similar aliases for other functions (Gallery, Wishlist, Profile)
    // ...

    // API Gateway routes to Lambda aliases (not $LATEST)
    api.route('GET /api/mocs', {
      handler: mocFunctionAlias.arn,
    })

    return {
      apiUrl: api.url,
      deploymentColor,
      aliasName,
    }
  },
})
```

### Route53 Weighted Routing

```typescript
// infra/deployment/route53-traffic-shift.ts
import * as route53 from 'aws-cdk-lib/aws-route53'
import * as targets from 'aws-cdk-lib/aws-route53-targets'
import { Construct } from 'constructs'

export interface TrafficShiftProps {
  readonly blueApiGateway: apigatewayv2.IHttpApi
  readonly greenApiGateway: apigatewayv2.IHttpApi
  readonly domainName: string
  readonly hostedZoneId: string
  readonly blueWeight: number // 0-100
  readonly greenWeight: number // 0-100
}

export class BlueGreenTrafficShift extends Construct {
  constructor(scope: Construct, id: string, props: TrafficShiftProps) {
    super(scope, id)

    const hostedZone = route53.HostedZone.fromHostedZoneAttributes(this, 'HostedZone', {
      hostedZoneId: props.hostedZoneId,
      zoneName: props.domainName,
    })

    // Blue environment (current production)
    new route53.ARecord(this, 'BlueRecord', {
      zone: hostedZone,
      recordName: 'api',
      target: route53.RecordTarget.fromAlias(
        new targets.ApiGatewayv2DomainProperties(
          props.blueApiGateway.defaultDomainName!,
          props.blueApiGateway.defaultDomainName!,
        ),
      ),
      weight: props.blueWeight,
      setIdentifier: 'blue',
    })

    // Green environment (new deployment)
    new route53.ARecord(this, 'GreenRecord', {
      zone: hostedZone,
      recordName: 'api',
      target: route53.RecordTarget.fromAlias(
        new targets.ApiGatewayv2DomainProperties(
          props.greenApiGateway.defaultDomainName!,
          props.greenApiGateway.defaultDomainName!,
        ),
      ),
      weight: props.greenWeight,
      setIdentifier: 'green',
    })
  }
}
```

### Traffic Shift Script

```bash
#!/bin/bash
# scripts/blue-green-deploy.sh

set -e

DEPLOYMENT_COLOR="${1:-green}"
DOMAIN="api.lego-mocs.com"
HOSTED_ZONE_ID="Z1234567890ABC"

echo "üöÄ Starting Blue/Green deployment to $DEPLOYMENT_COLOR environment"

# Step 1: Deploy green environment
echo "üì¶ Deploying green environment..."
DEPLOYMENT_COLOR=green pnpm sst deploy --stage production

# Step 2: Run database migrations
echo "üóÑÔ∏è Running database migrations..."
pnpm db:migrate

# Step 3: Health check green environment
echo "üè• Running health checks..."
sleep 30 # Wait for Lambda warm-up
GREEN_URL="https://production-green.execute-api.us-east-1.amazonaws.com"
HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$GREEN_URL/health")

if [ "$HEALTH_STATUS" != "200" ]; then
  echo "‚ùå Health check failed (HTTP $HEALTH_STATUS). Aborting deployment."
  exit 1
fi

echo "‚úÖ Health check passed"

# Step 4: Shift 10% traffic to green
echo "üîÄ Shifting 10% traffic to green..."
aws route53 change-resource-record-sets \
  --hosted-zone-id "$HOSTED_ZONE_ID" \
  --change-batch file://traffic-shift-10.json

sleep 300 # Wait 5 minutes

# Step 5: Check error rate
echo "üìä Checking error rate..."
ERROR_RATE=$(aws cloudwatch get-metric-statistics \
  --namespace AWS/ApiGateway \
  --metric-name 5XXError \
  --dimensions Name=ApiId,Value=green \
  --statistics Sum \
  --start-time "$(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%S)" \
  --end-time "$(date -u +%Y-%m-%dT%H:%M:%S)" \
  --period 300 \
  --query 'Datapoints[0].Sum' \
  --output text)

if [ "$ERROR_RATE" != "0.0" ] && [ "$ERROR_RATE" != "None" ]; then
  echo "‚ö†Ô∏è Error rate: $ERROR_RATE. Evaluating..."
  # Additional error rate validation logic
fi

# Step 6: Shift 50% traffic to green
echo "üîÄ Shifting 50% traffic to green..."
aws route53 change-resource-record-sets \
  --hosted-zone-id "$HOSTED_ZONE_ID" \
  --change-batch file://traffic-shift-50.json

sleep 600 # Wait 10 minutes

# Step 7: Manual approval for 100% shift
echo "‚è∏Ô∏è Waiting for manual approval to shift 100% traffic..."
read -p "Press Enter to continue with 100% traffic shift, or Ctrl+C to abort: "

# Step 8: Shift 100% traffic to green
echo "üîÄ Shifting 100% traffic to green..."
aws route53 change-resource-record-sets \
  --hosted-zone-id "$HOSTED_ZONE_ID" \
  --change-batch file://traffic-shift-100.json

echo "‚úÖ Deployment complete! 100% traffic on green environment."
echo "üîµ Blue environment will be decommissioned in 24 hours."

# Step 9: Schedule blue environment cleanup
echo "üóëÔ∏è Scheduling blue environment cleanup..."
at now + 24 hours <<< "DEPLOYMENT_COLOR=blue pnpm sst remove --stage production"
```

### Route53 Change Batch (10% Traffic)

```json
{
  "Comment": "Shift 10% traffic to green environment",
  "Changes": [
    {
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "api.lego-mocs.com",
        "Type": "A",
        "SetIdentifier": "blue",
        "Weight": 90,
        "AliasTarget": {
          "HostedZoneId": "Z1234567890ABC",
          "DNSName": "production-blue.execute-api.us-east-1.amazonaws.com",
          "EvaluateTargetHealth": true
        }
      }
    },
    {
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "api.lego-mocs.com",
        "Type": "A",
        "SetIdentifier": "green",
        "Weight": 10,
        "AliasTarget": {
          "HostedZoneId": "Z1234567890ABC",
          "DNSName": "production-green.execute-api.us-east-1.amazonaws.com",
          "EvaluateTargetHealth": true
        }
      }
    }
  ]
}
```

### Route53 Change Batch (50% Traffic)

```json
{
  "Comment": "Shift 50% traffic to green environment",
  "Changes": [
    {
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "api.lego-mocs.com",
        "Type": "A",
        "SetIdentifier": "blue",
        "Weight": 50,
        "AliasTarget": {
          "HostedZoneId": "Z1234567890ABC",
          "DNSName": "production-blue.execute-api.us-east-1.amazonaws.com",
          "EvaluateTargetHealth": true
        }
      }
    },
    {
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "api.lego-mocs.com",
        "Type": "A",
        "SetIdentifier": "green",
        "Weight": 50,
        "AliasTarget": {
          "HostedZoneId": "Z1234567890ABC",
          "DNSName": "production-green.execute-api.us-east-1.amazonaws.com",
          "EvaluateTargetHealth": true
        }
      }
    }
  ]
}
```

### Route53 Change Batch (100% Traffic)

```json
{
  "Comment": "Shift 100% traffic to green environment",
  "Changes": [
    {
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "api.lego-mocs.com",
        "Type": "A",
        "SetIdentifier": "blue",
        "Weight": 0,
        "AliasTarget": {
          "HostedZoneId": "Z1234567890ABC",
          "DNSName": "production-blue.execute-api.us-east-1.amazonaws.com",
          "EvaluateTargetHealth": true
        }
      }
    },
    {
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "api.lego-mocs.com",
        "Type": "A",
        "SetIdentifier": "green",
        "Weight": 100,
        "AliasTarget": {
          "HostedZoneId": "Z1234567890ABC",
          "DNSName": "production-green.execute-api.us-east-1.amazonaws.com",
          "EvaluateTargetHealth": true
        }
      }
    }
  ]
}
```

### Health Check Configuration

```typescript
// infra/deployment/health-check.ts
import * as route53 from 'aws-cdk-lib/aws-route53'

export class HealthCheck extends Construct {
  public readonly healthCheck: route53.CfnHealthCheck

  constructor(scope: Construct, id: string, apiUrl: string) {
    super(scope, id)

    this.healthCheck = new route53.CfnHealthCheck(this, 'HealthCheck', {
      type: 'HTTPS',
      resourcePath: '/health',
      fullyQualifiedDomainName: apiUrl.replace('https://', ''),
      port: 443,
      requestInterval: 30, // Check every 30 seconds
      failureThreshold: 3, // Mark unhealthy after 3 consecutive failures
      healthThreshold: 2, // Mark healthy after 2 consecutive successes
      measureLatency: true,
      enableSni: true,
    })
  }
}
```

### Automatic Rollback Lambda

```typescript
// src/functions/deployment/rollback-monitor.ts
import { CloudWatchClient, DescribeAlarmsCommand } from '@aws-sdk/client-cloudwatch'
import { Route53Client, ChangeResourceRecordSetsCommand } from '@aws-sdk/client-route-53'

export const handler = async (): Promise<void> => {
  const cloudwatch = new CloudWatchClient({ region: process.env.AWS_REGION })
  const route53 = new Route53Client({ region: process.env.AWS_REGION })

  // Check if any critical alarms are in ALARM state
  const response = await cloudwatch.send(new DescribeAlarmsCommand({
    AlarmNames: [
      'lego-api-gateway-5xx-errors',
      'lego-api-moc-errors',
      'lego-api-gallery-errors',
    ],
    StateValue: 'ALARM',
  }))

  if (response.MetricAlarms && response.MetricAlarms.length > 0) {
    console.error('Critical alarms detected. Triggering rollback...')

    // Shift 100% traffic back to blue environment
    await route53.send(new ChangeResourceRecordSetsCommand({
      HostedZoneId: process.env.HOSTED_ZONE_ID!,
      ChangeBatch: {
        Comment: 'Automatic rollback due to critical alarms',
        Changes: [
          {
            Action: 'UPSERT',
            ResourceRecordSet: {
              Name: 'api.lego-mocs.com',
              Type: 'A',
              SetIdentifier: 'blue',
              Weight: 100,
              AliasTarget: {
                HostedZoneId: process.env.HOSTED_ZONE_ID!,
                DNSName: 'production-blue.execute-api.us-east-1.amazonaws.com',
                EvaluateTargetHealth: true,
              },
            },
          },
          {
            Action: 'UPSERT',
            ResourceRecordSet: {
              Name: 'api.lego-mocs.com',
              Type: 'A',
              SetIdentifier: 'green',
              Weight: 0,
              AliasTarget: {
                HostedZoneId: process.env.HOSTED_ZONE_ID!,
                DNSName: 'production-green.execute-api.us-east-1.amazonaws.com',
                EvaluateTargetHealth: true,
              },
            },
          },
        ],
      },
    }))

    // Send Slack notification
    console.log('Rollback complete. Traffic shifted back to blue environment.')
  }
}
```

### EventBridge Rule for Rollback Monitor

```typescript
// infra/deployment/rollback-rule.ts
import * as events from 'aws-cdk-lib/aws-events'
import * as targets from 'aws-cdk-lib/aws-events-targets'

export class RollbackRule extends Construct {
  constructor(scope: Construct, id: string, rollbackFunction: lambda.IFunction) {
    super(scope, id)

    // Run rollback monitor every 1 minute during deployment
    const rule = new events.Rule(this, 'RollbackMonitorRule', {
      schedule: events.Schedule.rate(Duration.minutes(1)),
      enabled: true, // Enable only during deployment window
    })

    rule.addTarget(new targets.LambdaFunction(rollbackFunction))
  }
}
```

---

## Design Decisions

### Weighted Routing vs CodeDeploy

**Decision**: Use Route53 weighted routing for traffic shifting

**Rationale**:
- Simpler than AWS CodeDeploy (no additional service)
- Fine-grained control over traffic percentages
- Works with any backend (not just Lambda)
- Can shift traffic gradually over custom time periods
- Easy to rollback by changing weights

**Alternative Considered**: AWS CodeDeploy Lambda traffic shifting (rejected due to complexity)

### 0% ‚Üí 10% ‚Üí 50% ‚Üí 100% Shift

**Decision**: Shift traffic in 3 steps: 10%, 50%, 100%

**Rationale**:
- 10%: Canary deployment, minimal blast radius
- 50%: Larger sample size for validation
- 100%: Full production traffic
- 5-minute soak time at 10%, 10-minute soak time at 50%
- Total deployment time: ~30 minutes (excluding approval wait)

**Alternative Considered**: Linear 10% per minute (rejected as too fast)

### 24-Hour Blue Environment Retention

**Decision**: Keep blue environment for 24 hours after 100% traffic shift

**Rationale**:
- Allows quick rollback if issues discovered after deployment
- 24 hours covers one full business day
- Low cost (Lambda charges only for invocations)
- After 24 hours, high confidence in green deployment

### Manual Approval Before 100%

**Decision**: Require manual approval before shifting 100% traffic

**Rationale**:
- Final safety check before full production rollout
- Review metrics from 10% and 50% traffic
- Allows cancellation if anomalies detected
- Industry best practice for production deployments

---

## Error Scenarios

| Scenario | Resolution |
|----------|------------|
| Health check fails on green | Abort deployment, keep 100% traffic on blue |
| Error rate >5% at 10% traffic | Automatic rollback to blue |
| CloudWatch alarm fires during shift | Automatic rollback to blue |
| Manual approval denied | Keep traffic at current split (e.g., 50% blue, 50% green) |
| Database migration fails | Abort deployment, rollback migration if possible |

---

## Traffic Shift Timeline

```
Time    Blue    Green   Action
----    ----    -----   ------
T+0     100%    0%      Deploy green environment
T+5     100%    0%      Run database migrations
T+10    90%     10%     Shift 10% traffic to green
T+15    90%     10%     Monitor error rate, health checks
T+20    50%     50%     Shift 50% traffic to green
T+30    50%     50%     Monitor error rate, health checks
T+35    50%     50%     Wait for manual approval
T+40    0%      100%    Shift 100% traffic to green (approved)
T+1440  Remove  100%    Decommission blue environment (24 hours later)
```

---

## Rollback Process

### Automatic Rollback (Triggered by Alarms)

1. CloudWatch alarm enters ALARM state (e.g., 5xx error rate >5%)
2. EventBridge rule triggers rollback Lambda
3. Lambda shifts 100% traffic back to blue environment
4. Slack notification sent to DevOps team
5. Green environment remains for debugging

### Manual Rollback (Triggered by Team)

```bash
# scripts/rollback-to-blue.sh
#!/bin/bash

echo "‚èÆÔ∏è Rolling back to blue environment..."

aws route53 change-resource-record-sets \
  --hosted-zone-id "$HOSTED_ZONE_ID" \
  --change-batch '{
    "Comment": "Manual rollback to blue environment",
    "Changes": [
      {
        "Action": "UPSERT",
        "ResourceRecordSet": {
          "Name": "api.lego-mocs.com",
          "Type": "A",
          "SetIdentifier": "blue",
          "Weight": 100,
          "AliasTarget": {
            "HostedZoneId": "Z1234567890ABC",
            "DNSName": "production-blue.execute-api.us-east-1.amazonaws.com",
            "EvaluateTargetHealth": true
          }
        }
      },
      {
        "Action": "UPSERT",
        "ResourceRecordSet": {
          "Name": "api.lego-mocs.com",
          "Type": "A",
          "SetIdentifier": "green",
          "Weight": 0,
          "AliasTarget": {
            "HostedZoneId": "Z1234567890ABC",
            "DNSName": "production-green.execute-api.us-east-1.amazonaws.com",
            "EvaluateTargetHealth": true
          }
        }
      }
    ]
  }'

echo "‚úÖ Rollback complete. 100% traffic on blue environment."
```

---

## Performance Considerations

1. **DNS Propagation**: Route53 changes take ~60 seconds to propagate globally
2. **Lambda Warm-up**: Green environment may experience cold starts initially
3. **Database Migration Time**: Plan for migrations to complete before traffic shift
4. **Health Check Latency**: 30-second interval, 3 failures = 90 seconds to detect unhealthy

**Benchmark Targets**:
- Total deployment time: <30 minutes (excluding approval)
- Rollback time: <2 minutes (Route53 change + propagation)
- Zero downtime: Maintained throughout deployment

---

## Dependencies

- **AWS Route53**: For weighted routing and health checks
- **AWS Lambda Aliases**: For blue/green versioning
- **AWS EventBridge**: For automatic rollback monitoring
- **AWS CloudWatch**: For alarms and metrics
- **Story 5.2**: CloudWatch Alarms (provides alarms for rollback triggers)
- **Story 5.4**: CI/CD Pipeline (integrates blue/green deployment)

---

## Future Enhancements

1. **Automated Traffic Shift**: Remove manual approval for low-risk deployments
2. **Canary Analysis**: Use ML to detect anomalies in metrics during canary period
3. **Multi-Region Blue/Green**: Extend to multiple AWS regions
4. **Database Blue/Green**: Use RDS Blue/Green deployments for database updates
5. **Progressive Delivery**: Use feature flags for gradual feature rollout

---

## Related Stories

- **Story 5.2**: CloudWatch Alarms - Alarms trigger automatic rollback
- **Story 5.4**: CI/CD Pipeline - Pipeline orchestrates blue/green deployment
- **Story 5.6**: Performance Validation - Validate performance during traffic shift
