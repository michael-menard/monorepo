# Story 1.3: S3 Buckets and Lifecycle Policies

## Status
Draft

## Story
**As a** DevOps Engineer,
**I want** to create S3 buckets with appropriate lifecycle policies for session replay storage,
**so that** OpenReplay can store recordings cost-effectively with automatic cleanup.

## Acceptance Criteria
1. S3 bucket created for OpenReplay session recordings with encryption at rest
2. 30-day lifecycle policy configured to automatically delete old recordings
3. S3 Intelligent-Tiering enabled for automatic cost optimization
4. Bucket policy configured to allow ECS task role access only
5. CloudWatch metrics enabled for storage monitoring
6. S3 bucket for CloudWatch Logs export (optional) with 1-year Glacier transition

**Integration Verification:**
- IV1: Existing S3 buckets (frontend assets, etc.) remain unaffected
- IV2: CloudFront distribution continues serving frontend assets without disruption
- IV3: Application's existing S3 access patterns unchanged

## Tasks / Subtasks

- [ ] **Task 1: Create S3 bucket for OpenReplay session recordings** (AC: 1, 3)
  - [ ] Create bucket in SST configuration with naming convention: `user-metrics-openreplay-sessions-[stage]-[region]`
  - [ ] Enable server-side encryption with SSE-S3 (AES-256)
  - [ ] Enable S3 Intelligent-Tiering storage class for automatic cost optimization
  - [ ] Enable versioning (recommended for recovery, but can be disabled for cost optimization)
  - [ ] Block public access (all 4 settings enabled)
  - [ ] Apply resource tags from centralized tagging schema
  - [ ] Deploy using `sst deploy --stage dev`

- [ ] **Task 2: Configure 30-day lifecycle policy** (AC: 2)
  - [ ] Create lifecycle rule named `DeleteOldSessionRecordings`
  - [ ] Set expiration to 30 days for all objects in bucket
  - [ ] Enable rule for all objects (no prefix filter)
  - [ ] Optionally: Add transition to Intelligent-Tiering after 1 day (if not default storage class)
  - [ ] Validate lifecycle configuration via AWS CLI or console

- [ ] **Task 3: Configure bucket policy for ECS task role access** (AC: 4)
  - [ ] Retrieve ECS task role ARN created in Story 1.1 (OpenReplay task role)
  - [ ] Create bucket policy allowing `s3:PutObject`, `s3:GetObject`, `s3:DeleteObject` for ECS task role only
  - [ ] Deny access for all other principals except bucket owner
  - [ ] Apply bucket policy via SST bucket construct or AWS CLI
  - [ ] Validate policy with AWS CLI: `aws s3api get-bucket-policy --bucket [bucket-name]`

- [ ] **Task 4: Enable CloudWatch metrics for S3 bucket** (AC: 5)
  - [ ] Enable request metrics for entire bucket (filter: all objects)
  - [ ] Configure CloudWatch to track: `NumberOfObjects`, `BucketSizeBytes`, `AllRequests`, `GetRequests`, `PutRequests`
  - [ ] Set metric filter name: `OpenReplaySessionMetrics`
  - [ ] Verify metrics appear in CloudWatch (may take 15 minutes for first data points)

- [ ] **Task 5: Create optional S3 bucket for CloudWatch Logs export** (AC: 6)
  - [ ] Create bucket with naming convention: `user-metrics-cloudwatch-logs-[stage]-[region]`
  - [ ] Enable server-side encryption with SSE-S3
  - [ ] Configure lifecycle policy: Transition to Glacier after 90 days, expire after 1 year (365 days)
  - [ ] Create bucket policy allowing CloudWatch Logs service to write logs
  - [ ] Apply resource tags from centralized tagging schema
  - [ ] Document bucket name for use in CloudWatch Logs export configuration (future story)

- [ ] **Task 6: Update SST configuration with S3 bucket constructs** (AC: 1-6)
  - [ ] Import tagging utilities from `sst/observability/tags.ts`
  - [ ] Create `Bucket` constructs for OpenReplay sessions and CloudWatch Logs (optional)
  - [ ] Export bucket names and ARNs for use in Phase 4 stories (OpenReplay ECS deployment)
  - [ ] Validate SST configuration with `sst build`
  - [ ] Deploy buckets with `sst deploy --stage dev`

- [ ] **Task 7: Validate bucket configurations** (AC: 1-5)
  - [ ] Verify OpenReplay bucket encryption: `aws s3api get-bucket-encryption --bucket [bucket-name]`
  - [ ] Verify lifecycle policy: `aws s3api get-bucket-lifecycle-configuration --bucket [bucket-name]`
  - [ ] Verify Intelligent-Tiering: `aws s3api get-bucket-intelligent-tiering-configuration --bucket [bucket-name]`
  - [ ] Verify bucket policy: `aws s3api get-bucket-policy --bucket [bucket-name]`
  - [ ] Verify CloudWatch metrics configuration: `aws s3api list-bucket-metrics-configurations --bucket [bucket-name]`
  - [ ] Document validation results in completion notes

- [ ] **Task 8: Integration testing** (AC: IV1, IV2, IV3)
  - [ ] List all S3 buckets to verify no changes to existing buckets: `aws s3 ls`
  - [ ] Test existing application S3 operations (upload/download to existing buckets)
  - [ ] Verify CloudFront distribution still serves frontend assets (curl or browser test)
  - [ ] Check application Lambda logs for successful S3 operations
  - [ ] Document integration test results in completion notes

## Dev Notes

### Project Context
This story is **Story 1.3** from **Phase 1: Infrastructure Foundation** of the User Metrics PRD brownfield enhancement. This is the third story in Phase 1, following Story 1.1 (AWS Infrastructure) and Story 1.2 (Aurora Schema).

**Project:** User Tracking & Metrics Implementation (Brownfield Enhancement)
**Epic:** Phase 1 - Infrastructure Foundation (4 stories total)
**PRD Location:** `docs/prd/user-metrics/user-metrics-prd.md`
**Architecture:** `docs/prd/user-metrics/user-metrics-architecture.md`
**Phase File:** `docs/prd/user-metrics/phase-1.md`

### Previous Story Insights

**Story 1.1 (AWS Infrastructure Foundation Setup):**
- Created VPC, security groups, and IAM roles for ECS services
- Established centralized tagging configuration at `sst/observability/tags.ts`
- Created ECS task role for OpenReplay with placeholder S3 permissions
- Resource tagging schema applied to all infrastructure

**Story 1.2 (Aurora PostgreSQL Schema for Umami):**
- Created isolated `umami` schema in Aurora PostgreSQL
- Stored database credentials in AWS Secrets Manager
- Validated schema isolation and performance baseline
- Documented Aurora storage and performance metrics

**Relevant Context from Previous Stories:**
- **ECS Task Role ARN** (Story 1.1): OpenReplay ECS task role needs S3 bucket access for session storage
- **Tagging Schema** (Story 1.1): Use `requiredTags()` and `componentTags.storage` for S3 buckets
- **Cost Budget** (Story 1.1): $100-150/month total; S3 storage adds variable cost based on usage

### Tech Stack for This Story
[Source: docs/architecture/tech-stack.md]

**Storage:**
- **AWS S3** - Object storage for session recordings and logs
- **Storage Classes:** Intelligent-Tiering (automatic cost optimization), Glacier (long-term archival)
- **Encryption:** SSE-S3 (AES-256 server-side encryption)
- **Lifecycle Policies:** Automatic expiration and transition rules

**Infrastructure:**
- **SST (Serverless Stack) v3** - Infrastructure-as-code with `Bucket` construct
- **AWS CDK** - Underlying IaC framework (via SST)
- **CloudWatch Metrics** - S3 bucket monitoring

**Development Tools:**
- **AWS CLI** - For bucket validation and policy management
- **TypeScript 5.8** - For SST configuration

### Source Tree Structure
[Source: docs/architecture/source-tree.md]

**SST Configuration Location:**
```
apps/api/lego-api-serverless/
├── sst.config.ts          # Extend with S3 bucket constructs
├── sst/
│   └── observability/
│       └── tags.ts        # Tagging utilities (from Story 1.1)
└── src/
    └── lib/
        └── storage/       # Future: S3 client utilities (not needed in this story)
```

**Key File to Modify:**
- `apps/api/lego-api-serverless/sst.config.ts` - Add S3 `Bucket` constructs

### S3 Bucket Configuration Details
[Source: docs/prd/user-metrics/user-metrics-architecture.md#openreplay-session-data-s3]

**OpenReplay Session Data Storage:**
- **Purpose:** Store session replay recordings (user interactions, network requests, console logs, DOM snapshots)
- **Storage Type:** S3 objects (compressed recordings)
- **Retention:** 30-day lifecycle policy (automatic deletion)
- **Bucket Configuration:** Server-side encryption (SSE-S3), Intelligent-Tiering storage class
- **Access Control:** ECS task role only (via IAM policy)

**Storage Estimates:**
- **<100 users:** ~1-5 GB/month for session recordings (assuming 10-20 sessions/user/month at ~5-10 MB/session compressed)
- **Cost Estimate:** $0.02-0.12/GB (Intelligent-Tiering Frequent Access tier) = ~$0.02-0.60/month
- **After 30 days:** Automatic deletion via lifecycle policy

**CloudWatch Logs Export (Optional):**
- **Purpose:** Export CloudWatch Logs to S3 for long-term retention (beyond 90-day log retention)
- **Bucket Configuration:** Glacier transition after 90 days, expiration after 1 year
- **Cost Estimate:** Minimal (<$1/month for <100 users with low log volume)

### SST S3 Bucket Construct Patterns
[Source: docs/architecture/tech-stack.md - SST Infrastructure]

**Basic Bucket Creation:**
```typescript
import { Bucket } from 'sst/constructs';
import { requiredTags, componentTags } from './sst/observability/tags';

// OpenReplay session recordings bucket
const openreplayBucket = new Bucket(stack, 'OpenReplaySessionsBucket', {
  cdk: {
    bucket: {
      bucketName: `user-metrics-openreplay-sessions-${$app.stage}-${aws.region}`,
      encryption: BucketEncryption.S3_MANAGED, // SSE-S3
      versioned: false, // Disable for cost optimization
      intelligentTieringConfigurations: [
        {
          id: 'IntelligentTiering',
          status: IntelligentTieringStatus.ENABLED,
          tierings: [
            { days: 90, accessTier: IntelligentTieringAccessTier.ARCHIVE_ACCESS },
            { days: 180, accessTier: IntelligentTieringAccessTier.DEEP_ARCHIVE_ACCESS },
          ],
        },
      ],
      lifecycleRules: [
        {
          id: 'DeleteOldSessionRecordings',
          enabled: true,
          expiration: Duration.days(30),
        },
      ],
      blockPublicAccess: BlockPublicAccess.BLOCK_ALL,
      // Bucket policy added separately
    },
  },
});

// Apply tags using CDK Tags API
import { Tags } from 'aws-cdk-lib';
Tags.of(openreplayBucket).add('Project', 'UserMetrics');
Tags.of(openreplayBucket).add('Component', 'Storage');
Tags.of(openreplayBucket).add('DataType', 'Sessions');
Tags.of(openreplayBucket).add('RetentionPeriod', '30days');
```

**Alternative: SST Bucket with Simplified Syntax:**
```typescript
const openreplayBucket = new Bucket(stack, 'OpenReplaySessionsBucket');

// Configure via CDK escape hatch
openreplayBucket.cdk.bucket.addLifecycleRule({
  id: 'DeleteOldSessionRecordings',
  enabled: true,
  expiration: Duration.days(30),
});
```

**Bucket Policy for ECS Task Role Access:**
```typescript
import { PolicyStatement, Effect, ArnPrincipal } from 'aws-cdk-lib/aws-iam';

// Assuming openreplayTaskRole from Story 1.1
openreplayBucket.cdk.bucket.addToResourcePolicy(
  new PolicyStatement({
    effect: Effect.ALLOW,
    principals: [new ArnPrincipal(openreplayTaskRole.roleArn)],
    actions: [
      's3:PutObject',
      's3:GetObject',
      's3:DeleteObject',
      's3:ListBucket',
    ],
    resources: [
      openreplayBucket.bucketArn,
      `${openreplayBucket.bucketArn}/*`,
    ],
  })
);
```

**CloudWatch Metrics Configuration:**
```typescript
import { CfnBucket } from 'aws-cdk-lib/aws-s3';

const cfnBucket = openreplayBucket.cdk.bucket.node.defaultChild as CfnBucket;
cfnBucket.metricsConfigurations = [
  {
    id: 'OpenReplaySessionMetrics',
    // No prefix means all objects
  },
];
```

### AWS Resource Tagging for S3 Buckets
[Source: docs/aws-tagging-schema.md - Storage Resources]

**Required Tags (ALL Resources):**
```typescript
{
  Project: 'UserMetrics',
  Environment: 'dev|staging|prod',
  ManagedBy: 'SST',
  CostCenter: 'Observability',
  Owner: 'engineering@example.com',
}
```

**Functional Tags for S3 Buckets:**
```typescript
{
  Component: 'Storage',
  Function: 'Storage',
  DataType: 'Sessions',           // or 'Logs' for CloudWatch Logs bucket
  RetentionPeriod: '30days',      // or '365days' for logs bucket
  EncryptionEnabled: 'true',
}
```

**Complete Tagging Example:**
```typescript
import { Tags } from 'aws-cdk-lib';

Tags.of(openreplayBucket).add('Project', 'UserMetrics');
Tags.of(openreplayBucket).add('Environment', $app.stage);
Tags.of(openreplayBucket).add('ManagedBy', 'SST');
Tags.of(openreplayBucket).add('CostCenter', 'Observability');
Tags.of(openreplayBucket).add('Owner', 'engineering@example.com');
Tags.of(openreplayBucket).add('Component', 'Storage');
Tags.of(openreplayBucket).add('Function', 'Storage');
Tags.of(openreplayBucket).add('DataType', 'Sessions');
Tags.of(openreplayBucket).add('RetentionPeriod', '30days');
Tags.of(openreplayBucket).add('EncryptionEnabled', 'true');
```

### S3 Lifecycle Policy Configuration

**30-Day Expiration for Session Recordings:**
```json
{
  "Rules": [
    {
      "Id": "DeleteOldSessionRecordings",
      "Status": "Enabled",
      "Expiration": {
        "Days": 30
      },
      "Filter": {}
    }
  ]
}
```

**CloudWatch Logs Lifecycle (Optional Bucket):**
```json
{
  "Rules": [
    {
      "Id": "TransitionToGlacier",
      "Status": "Enabled",
      "Transitions": [
        {
          "Days": 90,
          "StorageClass": "GLACIER"
        }
      ],
      "Expiration": {
        "Days": 365
      },
      "Filter": {}
    }
  ]
}
```

### S3 Intelligent-Tiering Configuration

**Purpose:** Automatically move objects between access tiers based on usage patterns to optimize costs.

**Tiers:**
- **Frequent Access:** Objects accessed regularly (<30 days since last access)
- **Infrequent Access:** Objects not accessed for 30 days
- **Archive Access:** Objects not accessed for 90 days (optional)
- **Deep Archive Access:** Objects not accessed for 180 days (optional)

**Cost Optimization:**
- No retrieval fees for Frequent/Infrequent tiers
- Small monthly monitoring fee per object (~$0.0025 per 1,000 objects)
- Automatic cost reduction as objects age and become less frequently accessed

**Configuration in SST:**
```typescript
intelligentTieringConfigurations: [
  {
    id: 'IntelligentTiering',
    status: IntelligentTieringStatus.ENABLED,
    tierings: [
      { days: 90, accessTier: IntelligentTieringAccessTier.ARCHIVE_ACCESS },
      { days: 180, accessTier: IntelligentTieringAccessTier.DEEP_ARCHIVE_ACCESS },
    ],
  },
],
```

### S3 Bucket Policy for ECS Task Role

**Required Permissions:**
- `s3:PutObject` - Upload session recordings
- `s3:GetObject` - Retrieve session recordings for playback
- `s3:DeleteObject` - Delete recordings (if needed by OpenReplay)
- `s3:ListBucket` - List objects in bucket

**Bucket Policy JSON:**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowOpenReplayECSTaskAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::[account-id]:role/OpenReplayECSTaskRole"
      },
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::user-metrics-openreplay-sessions-dev-us-east-1",
        "arn:aws:s3:::user-metrics-openreplay-sessions-dev-us-east-1/*"
      ]
    }
  ]
}
```

### CloudWatch Metrics for S3 Buckets

**Metrics to Enable:**
- `NumberOfObjects` - Total object count in bucket
- `BucketSizeBytes` - Total storage size
- `AllRequests` - Total request count (GET, PUT, DELETE, etc.)
- `GetRequests` - GET request count
- `PutRequests` - PUT request count
- `4xxErrors` - Client errors (access denied, not found, etc.)
- `5xxErrors` - Server errors

**Metrics Configuration:**
Request metrics must be enabled for CloudWatch to collect S3 request data. Data appears in CloudWatch Metrics under `AWS/S3` namespace.

**Monitoring via CloudWatch Console:**
Navigate to CloudWatch → Metrics → S3 → Storage Metrics and Request Metrics

**Cost:** Request metrics cost $0.01 per 1,000 metrics monitored per month (minimal for <100 users)

### S3 Encryption Configuration

**Server-Side Encryption (SSE-S3):**
- **Encryption Method:** AES-256 encryption managed by AWS
- **Key Management:** S3 manages encryption keys automatically (no KMS required)
- **Cost:** Free (no additional cost for SSE-S3)
- **Configuration:** Enabled by default in SST `Bucket` construct or via `encryption: BucketEncryption.S3_MANAGED`

**Alternative: SSE-KMS (Not Recommended for This Use Case):**
- More expensive (~$1/month for key + $0.01 per 10,000 requests)
- Adds complexity with key rotation and IAM permissions
- Not required for session recordings (SSE-S3 sufficient)

### Deployment Commands
[Source: docs/architecture/tech-stack.md]

```bash
# Navigate to serverless API directory
cd apps/api/lego-api-serverless

# Build SST configuration (validates TypeScript)
sst build

# Deploy S3 buckets to dev environment
sst deploy --stage dev

# View deployed resources
sst console --stage dev
```

**Validation Commands:**
```bash
# List all S3 buckets in account
aws s3 ls

# Get bucket details
aws s3api head-bucket --bucket user-metrics-openreplay-sessions-dev-us-east-1

# Get bucket encryption
aws s3api get-bucket-encryption --bucket user-metrics-openreplay-sessions-dev-us-east-1

# Get lifecycle configuration
aws s3api get-bucket-lifecycle-configuration --bucket user-metrics-openreplay-sessions-dev-us-east-1

# Get bucket policy
aws s3api get-bucket-policy --bucket user-metrics-openreplay-sessions-dev-us-east-1

# List bucket metrics configurations
aws s3api list-bucket-metrics-configurations --bucket user-metrics-openreplay-sessions-dev-us-east-1

# Get bucket tagging
aws s3api get-bucket-tagging --bucket user-metrics-openreplay-sessions-dev-us-east-1
```

### Cost Implications
[Source: docs/prd/user-metrics/user-metrics-prd.md - NFR1]

**Budget:** $100-150/month total for observability stack

**This Story's Cost Impact:**

**OpenReplay Sessions Bucket:**
- **Storage:** 1-5 GB/month at $0.02-0.12/GB (Intelligent-Tiering) = ~$0.02-0.60/month
- **PUT Requests:** ~1,000-10,000/month at $0.005 per 1,000 = ~$0.005-0.05/month
- **GET Requests:** ~500-5,000/month at $0.0004 per 1,000 = ~$0.0002-0.002/month
- **Request Metrics:** $0.01 per 1,000 metrics = ~$0.01/month
- **Lifecycle Transitions:** Free (deletion is free)

**CloudWatch Logs Bucket (Optional):**
- **Storage:** ~0.5-1 GB/month (Glacier after 90 days) = ~$0.01-0.02/month (Glacier)
- **S3 Standard (first 90 days):** ~$0.01-0.02/month
- **Transition to Glacier:** $0.03 per 1,000 objects = ~$0.03/month

**Estimated Total:** ~$0.10-0.80/month (mostly storage for session recordings)

**Cost Optimization Strategies:**
- Intelligent-Tiering automatically moves infrequently accessed objects to cheaper tiers
- 30-day lifecycle policy prevents unbounded storage growth
- SSE-S3 encryption is free (vs. SSE-KMS which adds ~$1/month)

### Integration Constraints
[Source: docs/prd/user-metrics/user-metrics-prd.md - Compatibility Requirements]

**CR5: AWS Account Compatibility** - All new infrastructure (VPC if needed, ECS, Aurora schema, S3 buckets, Amazon Managed Grafana workspace) shall coexist with existing resources using proper namespacing and tagging conventions.

**Existing S3 Infrastructure to Preserve:**
- Frontend assets bucket (S3 + CloudFront)
- Application file upload buckets (user avatars, MOC instructions, gallery images, wishlist images)
- Existing S3 access patterns for Lambda functions

**Namespacing Strategy:**
- All new buckets prefixed with `user-metrics-` to distinguish from application buckets
- Separate bucket policies (new buckets have no relationship to existing buckets)
- ECS task role permissions scoped only to observability buckets

**Integration Verification:**
- List all buckets before and after deployment to verify no changes to existing buckets
- Test existing application S3 operations (upload/download)
- Verify CloudFront distribution continues serving frontend assets

### Security Considerations

**Least-Privilege Access:**
- ECS task role has access ONLY to OpenReplay sessions bucket (no access to application buckets)
- Application Lambda functions have NO access to observability buckets
- Public access blocked on all observability buckets (Block Public Access enabled)

**Encryption:**
- All data encrypted at rest with SSE-S3 (AES-256)
- Data encrypted in transit via HTTPS (enforced by S3 service)

**Bucket Policy Best Practices:**
- Explicit principal (ECS task role ARN) - no wildcards
- Minimal actions granted (PutObject, GetObject, DeleteObject, ListBucket)
- Resource ARN scoped to specific bucket only

### Testing

**Testing Strategy:**
[Source: docs/architecture/coding-standards.md - Testing section]

**No Unit/Integration Tests Required:** This story creates S3 bucket infrastructure, not application code. Validation is done via:
1. AWS CLI commands to verify bucket configuration
2. SST deployment success
3. Integration tests of existing application S3 functionality

**Manual Validation Checklist:**
- [ ] `sst build` succeeds without TypeScript errors
- [ ] `sst deploy --stage dev` completes successfully
- [ ] OpenReplay sessions bucket created with correct name
- [ ] Bucket encryption enabled (SSE-S3)
- [ ] Lifecycle policy configured (30-day expiration)
- [ ] Intelligent-Tiering enabled
- [ ] Bucket policy applied (ECS task role access)
- [ ] CloudWatch metrics configuration enabled
- [ ] Optional: CloudWatch Logs bucket created with Glacier transition
- [ ] All buckets have minimum 5 required tags

**Integration Tests:**
Verify existing application functionality:
```bash
# List all S3 buckets
aws s3 ls

# Test existing application S3 upload (via API endpoint)
curl -X POST https://[api-gateway-url]/api/images/upload \
  -H "Authorization: Bearer [token]" \
  -F "file=@test-image.jpg"

# Verify CloudFront serves frontend assets
curl https://[cloudfront-domain]/assets/logo.png

# Check Lambda CloudWatch logs for S3 operations
aws logs tail /aws/lambda/[function-name] --follow
```

**Performance Validation:**
- No performance impact expected (new buckets independent of existing infrastructure)
- Verify existing application S3 operations complete in same time range as baseline

**E2E Tests:**
Not applicable for S3 bucket infrastructure story. No Playwright tests required.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-23 | 1.0 | Initial story creation from Phase 1 PRD | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_(To be populated by Dev Agent)_

### Debug Log References
_(To be populated by Dev Agent)_

### Completion Notes
_(To be populated by Dev Agent)_

### File List
_(To be populated by Dev Agent)_

## QA Results
_(To be populated by QA Agent)_
