# Changelog

All notable changes to the workflow are documented here.

---

## [3.1.0] - 2026-02-07 MST

### Added
- **Knowledge Base Integration** (`knowledge-base.md`)
  - New documentation for KB semantic search integration
  - Workflow docs now stored as chunked entries in PostgreSQL with pgvector
  - Tagging strategy for source tracking, versioning, and section filtering
  - Update workflow with `--replace` mode for clean doc updates

- **migrate-docs-to-kb.ts Script** (`apps/api/knowledge-base/src/scripts/`)
  - Automated markdown-to-KB migration with chunking on `##` headers
  - Source file tracking via tags for easy updates
  - Version extraction from YAML front matter
  - Replace mode for atomic doc updates
  - Dry-run and verbose modes for preview

### Changed
- **README.md** - Added knowledge-base.md to documentation structure table

---

## [3.0.0] - 2026-02-06 MST

### Changed
- **Documentation reorganization** - Split monolithic `FULL_WORKFLOW.md` into focused files:
  - `README.md` - Overview, commands, state diagrams
  - `phases.md` - Detailed phase documentation
  - `agent-system.md` - Expert intelligence, agent architecture
  - `orchestration.md` - Error handling, state machine, observability
  - `autonomous-decisions.md` - Decision classification, batch processing
  - `context-caching.md` - Three-tier cache system
  - `extending.md` - How to extend the workflow
  - `changelog.md` - This file

---

## [2.25.0] - 2026-02-06 MST

### Added
- **Expert Agent Intelligence Framework** - Comprehensive upgrade for specialist agents
  - Expert Personas: Domain-specific intuitions and mental models
  - Decision Heuristics: RAPID framework for gray area reasoning
  - Reasoning Traces: Required explanation for all findings
  - Confidence Signals: Certainty levels on all findings
  - Severity Calibration: Consistent assessment with calibration questions
  - Precedent Awareness: KB queries before work, writes after
  - Cross-Domain Awareness: Sibling agent correlation
  - Knowledge Base Learning Loop: Lessons and ADL entries

- **New Shared Documents:**
  - `.claude/agents/_shared/expert-intelligence.md` - Master framework
  - `.claude/agents/_shared/expert-personas.md` - Domain expert definitions
  - `.claude/agents/_shared/severity-calibration.md` - Consistent severity
  - `.claude/agents/_shared/reasoning-traces.md` - Finding format
  - `.claude/agents/_shared/cross-domain-protocol.md` - Sibling awareness

### Changed
- **Enhanced Agents** (upgraded to expert intelligence):
  - `code-review-security` → v4.0.0 (full expert framework)
  - `architect-story-review` → v2.0.0 (full expert framework)
  - `uiux` → v3.0.0 (expert persona + KB integration)
  - `qa` → v3.0.0 (expert persona + decision heuristics)
  - `elab-epic-security` → v4.0.0 (expert persona + KB)
  - `elab-epic-engineering` → v4.0.0 (expert persona + KB)

- **KB Integration** (`.claude/agents/_shared/kb-integration.md`)
  - Added comprehensive ADL (Architecture Decision Log) patterns
  - Added lesson categories and examples
  - Added query-before-write deduplication pattern

- **Frontmatter Standard** (`.claude/agents/_shared/FRONTMATTER.md`)
  - Added references to new shared documents

---

## [2.24.0] - 2026-02-06 MST

### Added
- **Autonomous Elaboration Mode** (`/elab-story --autonomous`)
  - Auto-decision making for MVP-critical gaps (adds as ACs)
  - Non-blocking findings persisted to Knowledge Base
  - New agent: `elab-autonomous-decider.agent.md`
  - Output: `DECISIONS.yaml` with all auto-decisions made
  - Skips interactive prompts for faster story readiness

- **Pipeline Mode for PM Story** (`/pm-story generate --elab`)
  - Chain generation directly to elaboration
  - `--elab` flag: interactive elaboration after generation
  - `--elab --autonomous` flag: autonomous elaboration after generation
  - Reduces PM overhead for getting stories to `ready-to-work`

### Changed
- **Phase 3 (QA Elaboration)** - Now supports autonomous mode
  - Phase 1.5 added for autonomous decisions
  - FUTURE-OPPORTUNITIES.md now generated by analyst
  - elab-completion-leader reads from DECISIONS.yaml in autonomous mode

- **Phase 2 (PM Story Generation)** - Now supports pipeline mode
  - `--elab` chains to `/elab-story` on success
  - `--elab --autonomous` chains to `/elab-story --autonomous`

### Created (agents)
- `.claude/agents/elab-autonomous-decider.agent.md` - Autonomous decision maker

### Updated
- `.claude/commands/elab-story.md` - v5.0.0 with --autonomous flag
- `.claude/commands/pm-story.md` - v3.4.0 with --elab flag
- `.claude/agents/elab-completion-leader.agent.md` - Reads DECISIONS.yaml

---

## [2.23.0] - 2026-02-06 MST

### Added
- **Autonomous Decision Management** section
  - Decision Classification System with 4 tiers (Critical, MVP, Feature Improvement, Moonshot)
  - Auto-Accept Logic with configurable autonomy levels (conservative/moderate/aggressive)
  - Deferred Backlog Management for out-of-scope and moonshot decisions
  - Batch Processing Mode (`/workflow-batch`) for reducing HiTL interrupts
  - Preference Learning system with confidence-based application rules
  - Decisions stored in Knowledge Base via `kb_add_decision` and `kb_add_lesson`
- **Context Caching System** section
  - Three-Tier Cache Architecture (Static 24h, Domain 4h, Session 30min)
  - Cache Generators and Loaders with `pnpm cache:generate:*` commands
  - Session Context Inheritance protocol with `WORKER-CONTEXT.yaml`
  - Library Cache (Context7) integration for documentation caching
  - Cache Metrics and Observability with `CACHE-METRICS.yaml`
  - New artifacts: cache files in `.claude/cache/`

### Changed
- Updated "What's Next / Open Questions" with implementation status column
- Extended planned enhancements table with new documented features
- Added new open questions for cache TTL optimization and preference conflict resolution
- Updated known gaps to include pending TypeScript implementations
- Aligned documentation with existing 5-tier autonomy system in `.claude/agents/_shared/autonomy-tiers.md`

### Created (config files)
- `.claude/config/decision-classification.yaml` - Pattern-based tier classification rules
- `.claude/config/autonomy.yaml` - Autonomy level definitions and phase overrides
- `.claude/config/preferences.yaml` - Project and learned preference storage
- `.claude/config/context7.yaml` - Context7 library caching configuration

### Created (cache infrastructure)
- `.claude/cache/README.md` - Cache directory documentation
- `.claude/cache/.gitignore` - Ignore generated cache files
- `.claude/cache/session/` - Session cache directory (empty)
- `.claude/cache/context7/` - Library cache directory (empty)

### Created (commands)
- `.claude/commands/workflow-batch.md` - Batch mode wrapper for dev-implement-story

### Planned (TypeScript implementation)
- `packages/backend/orchestrator/src/decisions/decision-classifier.ts`
- `packages/backend/orchestrator/src/cache/cache-loader.ts`

---

## [2.22.0] - 2026-02-01 MST

### Added
- **Error Handling** section - Complete error contracts with types, retry configs, and circuit breaker pattern
- **Parallel Worker Configuration** section - Timeout handling, partial failure policy, aggregation rules
- **State Transition Matrix** section - Complete 17-status state machine with all valid transitions
- **Token Management** section - Budget thresholds, enforcement levels, and tracking requirements
- **Idempotency** section - Command re-run behavior, force flags, and artifact locking
- **Model Assignments** section - Centralized agent-to-model mapping with selection criteria
- **Observability** section - TRACE.jsonl format, METRICS.yaml structure, log levels
- **Testing Agents** section - Unit, integration, and regression testing guidance

### Technical Details
- New LangGraph schemas in `packages/backend/orchestrator/src/`:
  - `errors/workflow-errors.ts` - Error contracts and circuit breaker
  - `utils/parallel-executor.ts` - Parallel worker configuration
  - `state/story-state-machine.ts` - Complete state machine
  - `utils/token-budget.ts` - Token budget enforcement
  - `utils/idempotency.ts` - Idempotency modes and phase locking
  - `config/model-assignments.ts` - Model assignment loader
  - `observability/tracer.ts` - Workflow tracer
  - `observability/metrics.ts` - Metrics collector
- New YAML config: `.claude/config/model-assignments.yaml`
- Sync infrastructure: `scripts/check-workflow-sync.ts`, `scripts/generate-workflow-docs.ts`
- Pre-commit hook for sync verification
- CI workflow: `.github/workflows/workflow-sync.yml`
- Generated docs directory: `docs/generated/`

---

## [2.21.0] - 2026-02-01 MST

### Added
- **Knowledge Base Architecture** - New section documenting KB tools, knowledge flow, and fallback behavior
- `kb-writer.agent.md` - Reusable agent for writing to KB with deduplication and standardized tagging
- KB write integration in `qa-verify-completion-leader.agent.md` for capturing test strategies and edge cases
- Knowledge flow diagrams showing read path (story generation) and write path (knowledge capture)

### Changed
- **Knowledge Context Integration** - `load-knowledge-context.ts` now queries KB via `kb_search` with fallback to defaults
- `dev-implement-learnings.agent.md` - Now spawns `kb-writer` for each learning category instead of direct `kb_add` calls
- `qa-verify-completion-leader.agent.md` - Added optional step 5 for capturing significant QA findings to KB
- Updated agent spawning relationships (`spawns:` field) for knowledge capture chain

### Technical Details
- `getLessonsFromKB()` function added to orchestrator for domain-specific lesson queries
- KB integration uses optional dependency injection pattern for testability
- Silent fallback ensures workflow never blocks on KB unavailability
- Duplicate detection prevents redundant KB entries (>0.85 similarity threshold)

---

## [2.20.0] - 2026-02-01 MST

### Added
- **Knowledge Context Integration** - Story generation now automatically consults lessons learned and ADRs
- `knowledge-context-loader.agent.md` - New worker agent that loads lessons via `kb_search` and ADRs from `ADR-LOG.md`
- `pm-story-seed-agent.agent.md` - Updated with Phase 3: Load Knowledge Context
- Knowledge Context section in PM Story Generation documenting sources and usage
- `STORY-SEED.md` artifact created during story seeding with knowledge context

### Changed
- **Story Attack Analysis** (`story-attack-agent.agent.md`) - Now uses lessons learned as attack vectors
- Attack agent checks story approach against ADR constraints
- New assumption type `lesson_learned` for patterns that failed in past stories
- New edge case category `adr_violation` for potential architecture decision violations
- Attack analysis output includes `lessons_applied` and `adrs_checked` sections
- Required story sections now include "Knowledge Context" section

### Technical Details
- LangGraph `load-knowledge-context.ts` node parses ADR-LOG.md and provides default lessons
- Knowledge context flows through: seed → fanout agents → attack → synthesis
- ADR compliance is checked during attack phase with specific edge cases generated

---

## [2.19.0] - 2026-01-25 MST

### Added
- **`ready-for-qa/` directory** - Dedicated directory for stories awaiting QA verification
- `/dev-implement-story` now moves completed stories to `ready-for-qa/` directory

### Changed
- `/story-status` command displays `ready-for-qa` count in all views
- Swimlane view now has separate READY-QA and IN-QA columns
- Feature summary table includes "Ready-QA" column
- Status lifecycle table updated with `ready-for-qa` → `ready-for-qa/` mapping

---

## [2.18.0] - 2026-01-25 MST

### Added
- **Story Status Lifecycle** - New comprehensive table documenting all story statuses
- `ready-to-work` status for stories that passed elaboration and await development
- Status-to-directory mapping for all workflow stages

### Changed
- `/story-status` command now displays `ready-to-work` count in all views
- Feature summary table includes "Ready" column
- Swimlane view groups `ready-to-work` stories in READY column

---

## [2.17.0] - 2026-01-25 MST

### Changed
- **Story Elaboration** (`/elab-story`) - Now offers to chain to split on SPLIT REQUIRED verdict
- User prompted: "Would you like to split now?"
- If yes: Chains to `/pm-story split` automatically
- Streamlines workflow by allowing immediate continuation after split

---

## [2.16.0] - 2026-01-25 MST

### Changed
- **Story Split** (`/pm-story split`) - Superseded stories are now deleted instead of marked
- Original story directory is removed after splits are created
- Index entry for original story is removed (not marked as superseded)
- Split stories contain lineage in "Split Context" section

### Rationale
Superseded stories created confusion and stale references. The split context in each child story provides lineage tracking without keeping dead artifacts.

---

## [2.15.0] - 2026-01-25 MST

### Changed
- **Dev Implementation** (`/dev-implement-story`) - Now includes integrated code review and fix loop
- Command runs until code review passes (or max iterations reached)
- Context cleared between Implementation, Review, and Fix stages (fresh agents each time)
- Auto-detects existing artifacts and resumes from appropriate stage (no `--resume` flag needed)

### Added
- `--max-iterations=N` flag (default 3) - configurable review/fix loop limit
- `--force-continue` flag - proceed to QA with warnings after max iterations
- Two new code review workers: `code-review-typecheck.agent.md`, `code-review-build.agent.md`
- `VERIFICATION.yaml` schema v3 with 6 review categories
- `CHECKPOINT.md` tracks stage (implementation/review/fix/done) and iteration count

### Deprecated
- Manual `/dev-code-review` step is now optional (code review is integrated)
- `--resume` flag (replaced by automatic artifact detection)

---

## [2.14.0] - 2026-01-24 MST

### Added
- **Extending the Workflow** section - Comprehensive guide for workflow customization
- Architecture overview explaining phase leader pattern
- How to add checks to existing phases (example: type checking in QA)
- How to add parallel workers (example: Vercel build in code review)
- How to add new sub-phases (example: architectural review)
- How to add entirely new phases (example: security scan)
- Extension checklist for contributors
- Model selection guidelines (haiku/sonnet/opus)
- Common extension patterns quick reference

---

## [2.13.0] - 2026-01-24 MST

### Added
- **Workflow Run** (`/workflow-run`) - Meta-orchestrator for full story lifecycle
- Runs phases as isolated Tasks with fresh context (prevents context bloat)
- Checkpoint & resume via `_workflow/STATE.md`
- `--dry-run` mode for planning
- `--approve=phases` for approval gates at critical phases
- `--from` and `--to` for phase range execution
- Token tracking per phase
- Phase output capture to `_workflow/PHASE-N-OUTPUT.md`

### Changed
- Refactored `/workflow-run` to phase leader pattern
- Reduced orchestrator from 229 lines to ~100 lines (~56% reduction)
- Added 2 phase leaders: setup, loop
- Added reference doc: `.claude/docs/workflow-run-reference.md`

---

## [2.12.0] - 2026-01-24 MST

### Changed
- **UI/UX Review** (`/ui-ux-review`) - Refactored to phase leader pattern
- Reduced orchestrator from 143 lines to ~50 lines (~65% reduction)
- Added 3 phase leaders: setup, reviewer, report
- Added reference doc: `.claude/docs/ui-ux-review-reference.md`
- Added SKIPPED fast-path when story doesn't touch UI
- Output format remains `UI-UX-REVIEW-STORY-XXX.md` for human readability
- Intermediate artifact: `UI-UX-FINDINGS.yaml` (structured findings)

---

## [2.11.0] - 2026-01-24 MST

### Changed
- **QA Verify Story** (`/qa-verify-story`) - Refactored to phase leader pattern
- Reduced orchestrator from 314 lines to ~62 lines (~80% reduction)
- Added 3 phase leaders: setup, verification, completion
- Added reference doc: `.claude/docs/qa-verify-story-reference.md`
- Status transition now includes intermediate `in-qa` state
- Story moves between directories (`in-progress/` → `QA/` → `UAT/` or back)
- Output format remains `VERIFICATION.yaml` (qa_verify + gate sections)

---

## [2.10.0] - 2026-01-24 MST

### Added
- **Feature Triage** (`/pm-refine-story`) - New PM command for backlog management
- Step 1d in Bootstrap section documenting feature triage
- Interactive triage workflow with conversation phases
- Session logging to YAML files
- Bootstrap capability for FEATURES.md
- Chain to `/pm-story generate` for promoted features

### Changed
- Refactored `/pm-refine-story` command to phase leader pattern
- Reduced orchestrator from 250 lines to ~97 lines (~61% reduction)
- Updated pm-triage-leader.agent.md with quick wins (session log, chain to story)
- Added reference doc: `.claude/docs/pm-refine-story-reference.md`
- Updated Commands Overview table to include `/pm-refine-story`
- Updated Quick Reference section

---

## [2.9.0] - 2026-01-24 MST

### Changed
- **PM Story** (`/pm-story`) - Unified command consolidates story generation actions
- Reduced orchestrator from 910 lines to ~89 lines (~90% reduction)
- Added 4 new phase leaders: adhoc, bug, followup, split
- Reuses existing `pm-story-generation-leader.agent.md` for generate action
- Added reference doc: `.claude/docs/pm-story-reference.md`
- Deprecated individual commands: `/pm-generate-story`, `/pm-generate-ad-hoc-story`, `/pm-generate-bug-story`

### Added
- **Follow-up action** (`/pm-story followup`) - Generate stories from QA findings
- **Split action** (`/pm-story split`) - Split oversized stories into smaller parts
- Updated Commands Overview table in High-Level Flow
- Updated Phase 2 documentation with unified command structure
- Updated Quick Reference section

---

## [2.8.0] - 2026-01-24 MST

### Changed
- **Harness Story** (`/pm-generate-story-000-harness`) - Refactored to phase leader pattern
- Reduced orchestrator from 76 lines to ~55 lines
- Added 2 phase leaders: setup, generation
- Added reference doc: `.claude/docs/pm-generate-story-000-harness-reference.md`
- Command now requires `{PREFIX}` argument
- Added precondition checks (bootstrap complete, harness doesn't exist)
- Updated Step 1b section with agent diagrams

---

## [2.7.0] - 2026-01-24 MST

### Changed
- **PM Fix Story** (`/pm-fix-story`) - Refactored to phase leader pattern
- Reduced orchestrator from 107 lines to ~54 lines
- Added reference doc: `.claude/docs/pm-fix-story-reference.md`
- Added agent diagram to "PM Fix Story (Remediation)" section
- Reuses existing `pm-story-fix-leader.agent.md` (no new agents created)

---

## [2.6.0] - 2026-01-24 MST

### Changed
- **Bootstrap Workflow** (`/pm-bootstrap-workflow`) - Refactored to phase leader pattern
- Reduced orchestrator from 596 lines to ~100 lines
- Added 3 phase leaders: setup, analysis, generation
- Added reference doc: `.claude/docs/pm-bootstrap-workflow-reference.md`
- Added checkpoint & resume capability
- Added `--dry-run` mode for analysis without file generation
- Added ANALYSIS.yaml as intermediate artifact

---

## [2.5.0] - 2026-01-24 MST

### Changed
- **Story Elaboration** (`/elab-story`) - Refactored to phase leader pattern
- Added YAML frontmatter to all elab-story agents
- Replaced single qa.agent.md with 3 phase leaders: setup, analyst, completion
- Added reference doc: `.claude/docs/elab-story-reference.md`
- Updated ANALYSIS.md as intermediate artifact before final ELAB file

---

## [2.4.0] - 2026-01-24 MST

### Added
- **Epic Elaboration phase** (`/elab-epic`) - Multi-stakeholder review before story work
- Step 1c in Bootstrap section documenting epic elaboration
- 6 parallel stakeholder perspective agents (engineering, product, qa, ux, platform, security)
- 5 phase leader agents for setup, reviews, aggregation, interactive, updates
- Checkpoint & resume capability for epic elaboration
- Token estimation before running epic elaboration

### Changed
- Refactored `/elab-epic` command from 456 lines to ~60 lines
- Moved detailed logic into phase leader agents
- All stakeholder agents now output YAML (lean-docs compliant)

---

## [2.3.1] - 2026-01-22 22:45 MST

### Fixed
- Simplified Mermaid diagrams to fix rendering issues
- Removed unsupported multiline note syntax in stateDiagram
- Removed special characters that caused parsing errors
- Flowchart now shows commands in node labels for clarity

---

## [2.3.0] - 2026-01-22 22:35 MST

### Added
- **Agents & Sub-Agents section** for each phase with ASCII diagrams
- Agent file references for all sub-agents in each phase
- Related Skills callouts showing which skills support each phase
- Multi-agent pipeline tables with agent files and outputs

### Changed
- Phase 2 (PM): Documents `pm.agent.md` orchestrator + 3 sub-agents
- Phase 3 (Elab): Documents `qa.agent.md` single-agent flow
- Phase 4 (Dev): Documents all 9 sub-agents in implementation pipeline
- Phase 5 (Code Review): Documents `code-review.agent.md` + 4 specialist sub-agents
- Phase 6 (QA Verify): Documents `qa.agent.md` + optional `/ui-ux-review` skill
- Phase 7 (QA Gate): Documents evidence aggregation flow
- Phase 8 (Merge): Documents `/wt-finish` and `/wt-cleanup` skills

---

## [2.2.0] - 2026-01-22 22:20 MST

### Added
- **Elicitation / Refinement state** - New state branching off Elab for requirement clarification
- `NEEDS REFINEMENT` verdict at Elab gate (distinct from FAIL)
- Elicitation section explaining when and why stories enter refinement

### Changed
- State diagrams updated to show Elicitation state and its transitions
- Decision Points table now includes Elicitation outcomes
- Typical Cycles updated to show refinement patterns
- Renamed "Backward Path" column to "Refinement Path" for clarity
- QA Gate FAIL routes to Dev (not Elicitation) - scope issues should be caught at Elab

---

## [2.1.1] - 2026-01-22 22:15 MST

### Changed
- Replaced ASCII state diagram with **Mermaid diagrams** for better rendering
- Added two diagram views:
  - `stateDiagram-v2`: Full state machine with nested states and annotations
  - `flowchart LR`: Simplified linear view with decision diamonds
- Diagrams now render in GitHub, GitLab, Notion, VS Code, and other Mermaid-compatible viewers

---

## [2.1.0] - 2026-01-22 22:00 MST

### Added
- **State diagram** showing complete workflow with rejection paths and cycles
- Commands overview table with all phases and their purpose
- Decision points & verdicts table explaining each gate's outcomes
- Typical cycles section documenting common rejection patterns
- Visual representation of epic setup vs story lifecycle separation

### Changed
- Restructured High-Level Flow section for presentation clarity
- Now clearly shows non-linear nature of the workflow

---

## [2.0.1] - 2026-01-22 21:45 MST

### Added
- Step 1b: Harness Story documentation (`/pm-generate-story-000-harness`)
- Table of contents with nested subsections for Phase 1
- Clarified two-step bootstrap sequence in High-Level Flow

### Changed
- Updated Quick Reference to show harness story step
- Phase 1 now explicitly documents both bootstrap workflow and harness story

---

## [2.0.0] - 2026-01-22 21:30 MST

### Added
- Bootstrap phase documentation with `{PREFIX}.stories.index.md` generation
- Multi-agent pipeline for dev implementation (Planner, Validator, Coders, Verifier, Proof Writer, Learnings)
- Evidence bundle concept (`_implementation/` directory)
- Skills integration section (worktree commands, review, qa-gate)
- Templates reference (`WRKF-000/_templates/`)
- Token budget tracking requirement per story
- Reuse-first enforcement in elaboration and proof

### Changed
- Renamed from "Story Workflow" to "Unified Development Flow"
- Expanded elaboration from simple review to full audit with 8-point checklist
- Added `SPLIT REQUIRED` verdict for oversized stories
- Clarified that commands mutate state, skills produce evidence only

### Fixed
- Clarified status transitions at each phase
- Added explicit file locations for all artifacts

---

## [1.0.0] - 2026-01-15 10:00 MST

### Added
- Initial workflow documentation
- Basic lifecycle: generate → elaborate → implement → verify → gate
- Story folder structure with `_pm/` subdirectory
