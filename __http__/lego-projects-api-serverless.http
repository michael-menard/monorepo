# LEGO Projects API (Serverless) - HTTP Test Examples
# AWS Lambda + API Gateway
#
# Before running these tests:
# 1. Deploy serverless API: cd apps/api/lego-api-serverless && pnpm sst deploy --stage dev
# 2. OR use sst dev: pnpm sst dev
# 3. Update @apiUrl with your API Gateway endpoint
# 4. Have a valid JWT token from Cognito (see Cognito authentication flow)

### Variables
@apiUrl = https://dev-api.lego-moc-instructions.com
@localUrl = http://localhost:3000
@authToken = your-jwt-token-here
@userId = your-user-id-here

# Use @apiUrl for deployed environment, @localUrl for sst dev
@baseUrl = {{apiUrl}}

#####################
# HEALTH CHECK
#####################

### Health Check
GET {{baseUrl}}/health
Accept: application/json

#####################
# AUTHENTICATION (Cognito)
#####################
# Note: Authentication is handled by AWS Cognito
# Frontend uses AWS Amplify SDK to get JWT tokens
# Tokens are validated by API Gateway authorizer
# See COGNITO_MIGRATION.md for setup details

#####################
# MOC INSTRUCTIONS MANAGEMENT
#####################

### Get All MOCs
GET {{baseUrl}}/api/mocs
Accept: application/json
Authorization: Bearer {{authToken}}

### Get Specific MOC
GET {{baseUrl}}/api/mocs/moc-id-here
Accept: application/json
Authorization: Bearer {{authToken}}

### Create New MOC
POST {{baseUrl}}/api/mocs
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "My Awesome MOC",
  "description": "A detailed description of my MOC",
  "tags": ["space", "technic", "large"],
  "difficulty": "intermediate",
  "category": "Space"
}

### Update MOC Metadata
PATCH {{baseUrl}}/api/mocs/moc-id-here
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "Updated MOC Title",
  "description": "Updated description",
  "tags": ["updated", "tags"],
  "difficulty": "advanced"
}

### Delete MOC
DELETE {{baseUrl}}/api/mocs/moc-id-here
Authorization: Bearer {{authToken}}

#####################
# MOC FILE MANAGEMENT
#####################

### Upload MOC Instruction File
POST {{baseUrl}}/api/mocs/moc-id-here/files
Authorization: Bearer {{authToken}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="instructions.pdf"
Content-Type: application/pdf

< ./test-files/instructions.pdf
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="fileType"

instruction
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### Download MOC File
GET {{baseUrl}}/api/mocs/moc-id-here/files/file-id-here/download
Authorization: Bearer {{authToken}}

### Delete MOC File
DELETE {{baseUrl}}/api/mocs/moc-id-here/files/file-id-here
Authorization: Bearer {{authToken}}

### Upload Parts List (separate endpoint)
POST {{baseUrl}}/api/mocs/moc-id-here/upload-parts-list
Authorization: Bearer {{authToken}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="parts-list.csv"
Content-Type: text/csv

< ./test-files/parts-list.csv
------WebKitFormBoundary7MA4YWxkTrZu0gW--

#####################
# TWO-PHASE MOC CREATION (for large files)
#####################

### Initialize MOC with Files (returns presigned URLs)
POST {{baseUrl}}/api/mocs/with-files/initialize
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "title": "Large MOC with Multiple Files",
  "description": "MOC with multiple large instruction files",
  "tags": ["castle", "medieval"],
  "difficulty": "advanced",
  "files": [
    {
      "filename": "instructions-part1.pdf",
      "contentType": "application/pdf",
      "size": 15728640,
      "fileType": "instruction"
    },
    {
      "filename": "instructions-part2.pdf",
      "contentType": "application/pdf",
      "size": 12582912,
      "fileType": "instruction"
    },
    {
      "filename": "parts-list.csv",
      "contentType": "text/csv",
      "size": 102400,
      "fileType": "parts-list"
    }
  ]
}

### Finalize MOC Creation (after uploading to S3)
POST {{baseUrl}}/api/mocs/moc-id-here/finalize
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "fileIds": ["file-id-1", "file-id-2", "file-id-3"]
}

#####################
# MOC GALLERY IMAGES
#####################

### Link Gallery Image to MOC
POST {{baseUrl}}/api/mocs/moc-id-here/gallery-images
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "galleryImageId": "gallery-image-id-here"
}

### Get MOC Gallery Images
GET {{baseUrl}}/api/mocs/moc-id-here/gallery-images
Accept: application/json
Authorization: Bearer {{authToken}}

### Unlink Gallery Image from MOC
DELETE {{baseUrl}}/api/mocs/moc-id-here/gallery-images/gallery-image-id-here
Authorization: Bearer {{authToken}}

#####################
# MOC STATISTICS
#####################

### Get MOC Stats by Category
GET {{baseUrl}}/api/mocs/stats/by-category
Accept: application/json
Authorization: Bearer {{authToken}}

### Get MOC Uploads Over Time
GET {{baseUrl}}/api/mocs/stats/uploads-over-time
Accept: application/json
Authorization: Bearer {{authToken}}

#####################
# PARTS LISTS MANAGEMENT
#####################

### Get Parts Lists for MOC
GET {{baseUrl}}/api/moc-instructions/moc-id-here/parts-lists
Accept: application/json
Authorization: Bearer {{authToken}}

### Create Parts List
POST {{baseUrl}}/api/moc-instructions/moc-id-here/parts-lists
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "Main Parts List",
  "description": "Complete parts list for MOC",
  "totalPartsCount": "1500",
  "costEstimate": "249.99",
  "notes": "Parts list notes"
}

### Update Parts List
PUT {{baseUrl}}/api/moc-instructions/moc-id-here/parts-lists/parts-list-id-here
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "Updated Parts List Title",
  "description": "Updated description",
  "totalPartsCount": "1600",
  "actualCost": "275.50"
}

### Update Parts List Status
PATCH {{baseUrl}}/api/moc-instructions/moc-id-here/parts-lists/parts-list-id-here/status
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "built": true,
  "purchased": true,
  "inventoryPercentage": "85.50",
  "acquiredPartsCount": "1280",
  "actualCost": "275.50",
  "notes": "Most parts acquired from BrickLink"
}

### Delete Parts List
DELETE {{baseUrl}}/api/moc-instructions/moc-id-here/parts-lists/parts-list-id-here
Authorization: Bearer {{authToken}}

### Get User Parts Lists Summary
GET {{baseUrl}}/api/user/parts-lists/summary
Accept: application/json
Authorization: Bearer {{authToken}}

#####################
# GALLERY MANAGEMENT
#####################

### Upload Image (with Sharp processing)
POST {{baseUrl}}/api/images
Authorization: Bearer {{authToken}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="image"; filename="gallery-image.jpg"
Content-Type: image/jpeg

< ./test-files/gallery-image.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="title"

My Gallery Image
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="description"

Description of my gallery image
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="tags"

tag1,tag2,tag3
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="albumId"

album-id-here
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### Get All Images
GET {{baseUrl}}/api/images
Accept: application/json
Authorization: Bearer {{authToken}}

### Search Images
GET {{baseUrl}}/api/images/search?q=castle&tags=medieval&limit=20
Accept: application/json
Authorization: Bearer {{authToken}}

### Get Specific Image
GET {{baseUrl}}/api/images/image-id-here
Accept: application/json
Authorization: Bearer {{authToken}}

### Update Image Metadata
PATCH {{baseUrl}}/api/images/image-id-here
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "Updated Image Title",
  "description": "Updated description",
  "tags": ["updated", "tags"],
  "albumId": "new-album-id"
}

### Delete Image
DELETE {{baseUrl}}/api/images/image-id-here
Authorization: Bearer {{authToken}}

### Flag Image for Moderation
POST {{baseUrl}}/api/flag
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "imageId": "image-id-to-flag",
  "reason": "inappropriate content"
}

#####################
# ALBUM MANAGEMENT
#####################

### Create Album
POST {{baseUrl}}/api/albums
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "My LEGO Album",
  "description": "Collection of my favorite MOC images",
  "coverImageId": "image-id-for-cover"
}

### Get All Albums
GET {{baseUrl}}/api/albums
Accept: application/json
Authorization: Bearer {{authToken}}

### Get Specific Album
GET {{baseUrl}}/api/albums/album-id-here
Accept: application/json
Authorization: Bearer {{authToken}}

### Update Album
PATCH {{baseUrl}}/api/albums/album-id-here
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "Updated Album Title",
  "description": "Updated description",
  "coverImageId": "new-cover-image-id"
}

### Delete Album
DELETE {{baseUrl}}/api/albums/album-id-here
Authorization: Bearer {{authToken}}

#####################
# WISHLIST MANAGEMENT
#####################

### Get All Wishlist Items
GET {{baseUrl}}/api/wishlist
Accept: application/json
Authorization: Bearer {{authToken}}

### Search Wishlist
GET {{baseUrl}}/api/wishlist/search?q=creator&category=Architecture&limit=10
Accept: application/json
Authorization: Bearer {{authToken}}

### Get Specific Wishlist Item
GET {{baseUrl}}/api/wishlist/wishlist-id-here
Accept: application/json
Authorization: Bearer {{authToken}}

### Create Wishlist Item
POST {{baseUrl}}/api/wishlist
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "LEGO Creator Expert Big Ben",
  "description": "Amazing architecture set",
  "category": "Architecture",
  "productLink": "https://www.lego.com/product/big-ben",
  "imageUrl": "https://example.com/image.jpg",
  "sortOrder": "1"
}

### Update Wishlist Item
PATCH {{baseUrl}}/api/wishlist/wishlist-id-here
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "title": "Updated Wishlist Item",
  "description": "Updated description",
  "category": "Modular"
}

### Delete Wishlist Item
DELETE {{baseUrl}}/api/wishlist/wishlist-id-here
Authorization: Bearer {{authToken}}

### Reorder Wishlist Items
POST {{baseUrl}}/api/wishlist/reorder
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "itemIds": ["id1", "id2", "id3", "id4"]
}

### Upload Wishlist Item Image
POST {{baseUrl}}/api/wishlist/wishlist-id-here/image
Authorization: Bearer {{authToken}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="image"; filename="wishlist-item.jpg"
Content-Type: image/jpeg

< ./test-files/wishlist-item.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW--

#####################
# ERROR TESTING
#####################

### Test 404 Not Found
GET {{baseUrl}}/api/nonexistent-endpoint
Accept: application/json

### Test Unauthorized Access (no auth token)
GET {{baseUrl}}/api/mocs
Accept: application/json

### Test Invalid Token
GET {{baseUrl}}/api/mocs
Accept: application/json
Authorization: Bearer invalid-token-here

#####################
# NOTES
#####################
#
# Authentication Changes:
# - Now uses Authorization header with Bearer token (not Cookie)
# - Tokens issued by AWS Cognito
# - API Gateway validates JWT before Lambda execution
#
# Architecture Changes:
# - Serverless (AWS Lambda + API Gateway)
# - Files stored in S3 (no local storage)
# - Two-phase upload for large files (>10MB)
# - Automatic image optimization with Sharp
# - CloudFront CDN for static assets
#
# File Upload Limits:
# - Instructions: PDF, .io (50MB max)
# - Parts Lists: CSV, XML, JSON, PDF, TXT (10MB max)
# - Images: JPEG, PNG, WebP, HEIC (10MB max)
#
# Test Files Directory:
# Create these test files in __http__/test-files/:
# - instructions.pdf (MOC building instructions)
# - parts-list.csv (parts list file)
# - gallery-image.jpg (gallery image)
# - wishlist-item.jpg (wishlist item image)
# - avatar.jpg (user avatar - if user endpoints exist)
#####################
