import { describe, it, expect, vi } from 'vitest'
import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { App } from '../App'

// Mock the logger to avoid console output in tests
vi.mock('@repo/logger', () => ({
  logger: {
    info: vi.fn(),
    error: vi.fn(),
    warn: vi.fn(),
    debug: vi.fn(),
  },
}))

{{#if (eq type "shell")}}
describe('Shell App', () => {
  it('renders without crashing', () => {
    render(<App />)
    expect(screen.getByText(/{{displayName}}/i)).toBeInTheDocument()
  })

  it('shows loading state initially', () => {
    render(<App />)
    expect(screen.getByText(/loading/i)).toBeInTheDocument()
  })

  it('handles authentication flow', async () => {
    render(<App />)
    
    // Should show login page for unauthenticated users
    await waitFor(() => {
      expect(screen.getByText(/sign in/i)).toBeInTheDocument()
    })
  })
})
{{else if (eq type "module")}}
describe('{{displayName}} Module', () => {
  it('renders module correctly', () => {
    render(<App />)
    expect(screen.getByText(/{{displayName}}/i)).toBeInTheDocument()
  })

  it('displays module content', async () => {
    render(<App />)
    
    await waitFor(() => {
      expect(screen.getByText(/module/i)).toBeInTheDocument()
    })
  })

  it('handles user interactions', async () => {
    const user = userEvent.setup()
    render(<App />)
    
    // Add interaction tests here
    // Example: clicking buttons, filling forms, etc.
  })
})
{{else}}
describe('{{displayName}} App', () => {
  it('renders without crashing', () => {
    render(<App />)
    expect(screen.getByText(/{{displayName}}/i)).toBeInTheDocument()
  })

  it('displays main content', async () => {
    render(<App />)
    
    await waitFor(() => {
      expect(screen.getByRole('main')).toBeInTheDocument()
    })
  })

  it('handles navigation', async () => {
    const user = userEvent.setup()
    render(<App />)
    
    // Add navigation tests here
  })
})
{{/if}}

// API Integration Tests using MSW
describe('API Integration', () => {
  it('fetches data successfully', async () => {
    // This test will use the MSW handlers automatically
    const response = await fetch('http://localhost:3001/health')
    const data = await response.json()
    
    expect(response.ok).toBe(true)
    expect(data.status).toBe('ok')
    expect(data.service).toBe('{{kebabCase name}}')
  })

  it('handles API errors gracefully', async () => {
    const response = await fetch('http://localhost:3001/api/error/500')
    const data = await response.json()
    
    expect(response.status).toBe(500)
    expect(data.error.code).toBe('INTERNAL_SERVER_ERROR')
  })
})

{{#if includeAuth}}
// Authentication Tests
describe('Authentication', () => {
  it('handles successful login', async () => {
    const response = await fetch('http://localhost:3001/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: 'test@example.com',
        password: 'password',
      }),
    })
    
    const data = await response.json()
    
    expect(response.ok).toBe(true)
    expect(data.data.user.email).toBe('test@example.com')
    expect(data.data.tokens.accessToken).toBe('mock-access-token')
  })

  it('handles login failure', async () => {
    const response = await fetch('http://localhost:3001/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: 'wrong@example.com',
        password: 'wrongpassword',
      }),
    })
    
    const data = await response.json()
    
    expect(response.status).toBe(401)
    expect(data.error.code).toBe('INVALID_CREDENTIALS')
  })
})
{{/if}}
