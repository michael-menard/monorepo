# Gap Analysis: Adaptive Multi-Agent Dev Lifecycle System

**Date:** 2026-01-22 (Updated: 2026-01-24)
**Source PRD:** `agent_system_prd_bundle` (PRD.md, IMPLEMENTATION_PLAN.md, ROADMAP.md)
**Current System:** Multi-Agent Story Workflow (FEATURE-DEVELOPMENT-WORKFLOW.md v4.0, FULL_WORKFLOW.md v2.11.0)

---

## Executive Summary

The current multi-agent workflow already implements **~70% of the PRD concepts** through a different but compatible architecture. The primary gaps are:

1. **No queryable MCP** - Lessons are captured but not structured for agent queries
2. **No routing decision** - All stories use the full pipeline regardless of complexity
3. **Inconsistent token tracking** - Template exists but not enforced pre-STORY-016
4. **No confidence scoring** - Lessons lack metadata for prioritization

The recommendation is **incremental enhancement** rather than rebuild, converting existing artifacts into PRD-compatible structures.

---

## 1. Artifact & Evidence System

### PRD Requirement
> Canonical run bundle structure with artifact + evidence contracts

### Current State: IMPLEMENTED

| Artifact | Location | Status |
|----------|----------|--------|
| Story Definition | `STORY-XXX/STORY-XXX.md` | Exists with YAML frontmatter |
| Test Plan | `STORY-XXX/_pm/TEST-PLAN.md` | Generated by PM agent |
| Dev Feasibility | `STORY-XXX/_pm/DEV-FEASIBILITY.md` | Generated by PM agent |
| Implementation Plan | `STORY-XXX/_implementation/IMPLEMENTATION-PLAN.md` | Generated by Planner agent |
| Backend Log | `STORY-XXX/_implementation/BACKEND-LOG.md` | Generated by Backend Coder |
| Frontend Log | `STORY-XXX/_implementation/FRONTEND-LOG.md` | Generated by Frontend Coder |
| Verification (Dev) | `STORY-XXX/_implementation/VERIFICATION.md` | Generated by Verifier agent |
| Proof | `STORY-XXX/PROOF-STORY-XXX.md` | Generated by Proof Writer |
| Code Review | `STORY-XXX/CODE-REVIEW-STORY-XXX.md` | Generated by Code Review orchestrator |
| Unified Verification | `STORY-XXX/_implementation/VERIFICATION.yaml` | Updated by Code Review + QA Verify (code_review, qa_verify, gate sections) |

**Gap:** None. Current system exceeds PRD requirements for artifact structure.

**Evidence:** See `plans/stories/STORY-016/` for complete example.

---

## 2. Lessons Learned / MCP System

### PRD Requirement
> Lessons Learned MCP — structured, queryable knowledge base populated from Mini-Retrospectives
> - Explicit rules, guardrails, heuristics
> - Versioned and human-reviewable
> - Selectively applied at decision points

### Current State: PARTIAL

| Aspect | PRD Requirement | Current State | Gap |
|--------|-----------------|---------------|-----|
| Data Capture | Mini-retrospectives | `LESSONS-LEARNED.md` updated by Learnings Agent | None |
| Structure | Queryable schema | Flat markdown, story-by-story | **Major** |
| Versioning | Version-controlled | Git-tracked | None |
| Query API | MCP query at decision points | Agents read full file | **Major** |
| Categorization | By type (routing, validation, etc.) | By story only | **Moderate** |
| Confidence Scores | Scored entries | No scores | **Moderate** |

### Current LESSONS-LEARNED.md Structure

```markdown
## STORY-007: Gallery - Images Read
Date: 2026-01-19

### Reuse Discoveries
- [learning 1]
- [learning 2]

### Blockers Hit
- [blocker 1]

### Plan vs Reality
- Files planned: X
- Files touched: Y

### Recommendations for Future Stories
1. [recommendation 1]
2. [recommendation 2]
```

### Required MCP Structure

```yaml
lessons:
  - id: L-007-01
    story: STORY-007
    category: reuse
    tags: [di-pattern, core-functions, testing]
    severity: info
    confidence: 0.9
    lesson: "DI pattern for core functions is highly reusable"
    applies_to:
      - phase: dev-implement
      - workspace: packages/backend/*-core
    created: 2026-01-19
    validated_by: [STORY-008, STORY-010, STORY-011]
```

### Gap Details

1. **No Query API**
   - Current: Agents read entire `LESSONS-LEARNED.md` file (~400 lines, ~15k tokens)
   - Needed: `/query-lessons --phase=dev-implement --workspace=packages/backend`

2. **No Categorization**
   - Current: Lessons grouped by story chronologically
   - Needed: Categories: `reuse`, `routing`, `validation`, `risk`, `estimation`

3. **No Confidence Scoring**
   - Current: All lessons weighted equally
   - Needed: Confidence increases when lesson is validated by subsequent stories

4. **No Apply Points**
   - Current: Agents may or may not read lessons
   - Needed: Explicit query at: routing, elaboration, plan validation, code review

---

## 3. Routing System

### PRD Requirement
> Routing v1 — Static routing rules (heuristics + hard triggers) with deterministic router node

### Current State: NOT IMPLEMENTED

| Aspect | PRD Requirement | Current State | Gap |
|--------|-----------------|---------------|-----|
| Router Node | Dedicated routing step | None | **Major** |
| Workspace Categorization | By complexity/risk | None | **Major** |
| Route Options | Cheap vs Claude, simple vs full | Always full pipeline | **Major** |
| Routing Telemetry | Track routing decisions | None | **Major** |

### Current Flow (No Routing)

```
/elab-story → /dev-implement-story → /dev-code-review → /qa-verify-story
```

All stories use identical pipeline:
- Planner Agent
- Plan Validator
- Backend Coder (parallel with Frontend)
- Frontend Coder
- Contracts Agent
- Verifier Agent
- Playwright Agent
- Proof Writer
- Learnings Agent

### Proposed Routing Decision Points

| Story Characteristic | Proposed Route |
|---------------------|----------------|
| Backend-only (no UI) | Skip Frontend Coder, Skip Playwright |
| Single file change | Skip Planner, direct to coder |
| High-risk (security, payment) | Full pipeline + extra review |
| Simple bug fix | Minimal pipeline |
| Core package change | Full pipeline + regression focus |

### Routing Decision Artifact

```markdown
# ROUTING-STORY-XXX.md

## Story Characteristics
- AC Count: 57
- Files Touched (est): 18
- Workspaces: packages/backend/moc-instructions-core, apps/api/platforms/vercel
- Has Frontend: No
- Risk Flags: None

## Routing Decision
**Route:** backend-only-full

## Pipeline Configuration
| Agent | Enabled | Reason |
|-------|---------|--------|
| Planner | Yes | Multi-file change |
| Plan Validator | Yes | Standard |
| Backend Coder | Yes | Core changes |
| Frontend Coder | **Skip** | No UI changes |
| Contracts Agent | Yes | API endpoints |
| Verifier | Yes | Standard |
| Playwright Agent | **Skip** | No UI changes |
| Proof Writer | Yes | Standard |
| Learnings | Yes | Standard |

## MCP Lessons Applied
- L-016-05: "57 ACs is too large" → WARNING logged
- L-010-01: "Run scoped lint early" → Added to Backend Coder instructions
```

---

## 4. Token Telemetry

### PRD Requirement
> Telemetry capture including Claude Code token usage
> Token telemetry (Claude Code highlighted)

### Current State: PARTIAL

| Aspect | PRD Requirement | Current State | Gap |
|--------|-----------------|---------------|-----|
| Template | Budget template | `TOKEN-BUDGET-TEMPLATE.md` exists | None |
| Per-Story Tracking | Actual measurements | Only STORY-016 has data | **Moderate** |
| Sub-Agent Tracking | Per sub-agent costs | Template exists, not populated | **Moderate** |
| Phase Tracking | Before/after `/cost` | Template exists, rarely used | **Moderate** |
| Aggregation | Cross-story summary | `LESSONS-LEARNED.md` Token Summary table | **Partial** |

### Current Token Data (from LESSONS-LEARNED.md)

```markdown
| Story | Total Tokens | Input | Output | Most Expensive Phase |
|-------|--------------|-------|--------|---------------------|
| STORY-007 | — | — | — | Pre-token tracking |
| STORY-008 | — | — | — | Pre-token tracking |
...
| STORY-016 | ~97k | ~48k | ~50k | Dev: Backend Impl + Fix |
```

### Required Enforcement

1. **Mandatory TOKEN-SUMMARY.md** in `_implementation/` folder
2. **Before/after `/cost`** recorded for each phase
3. **Sub-agent costs** tracked separately
4. **High-cost operations** flagged automatically

---

## 5. Quality Gates

### PRD Requirement
> MR Review graph (evidence-gated), QA Validation graph, Unified HITL publish gate

### Current State: IMPLEMENTED (exceeds PRD)

| Gate | PRD | Current | Status |
|------|-----|---------|--------|
| Story Audit | Pre-dev validation | `/elab-story` with 3 phase leaders | Exceeds |
| Plan Validation | — | Plan Validator sub-agent | Exceeds |
| Build/Test Gate | — | Fast-fail in coders | Exceeds |
| Code Review | MR Review | `/dev-code-review` with 4 parallel agents | Exceeds |
| QA Verification | QA Validation | `/qa-verify-story` with 3 phase leaders | **Exceeds** |
| HITL Publish | Unified gate | Status-driven (`uat` → `done`) | Matches |

**Current Code Review Sub-Agents (PRD doesn't specify this level):**
1. Lint Agent - Run linter on touched files
2. Style Compliance Agent - Tailwind/component library only
3. Syntax Agent - ES7+ patterns
4. Security Agent - OWASP, secrets, injection

**Current QA Verify Phase Leaders (refactored 2026-01-24):**
1. Setup Leader (haiku) - Move story to QA/, validate preconditions, set `in-qa` status
2. Verification Leader (sonnet) - Run 6 hard gate checks, execute tests, produce verdict
3. Completion Leader (haiku) - Update status, move story, spawn index updater

**QA Verify Output:** `VERIFICATION.yaml` (qa_verify + gate sections)

---

## 6. Dev Execution

### PRD Requirement
> OpenCode executor (default), Claude Code executor (escalation), Context pack generator, proof.md generation

### Current State: PARTIAL

| Aspect | PRD Requirement | Current State | Gap |
|--------|-----------------|---------------|-----|
| Default Executor | OpenCode (cheap) | Claude Code (Opus) | **Design Decision** |
| Escalation Executor | Claude Code | N/A (always Claude) | **Not Needed Yet** |
| Context Pack | Generated context | Agents read files directly | **Moderate** |
| Proof Generation | proof.md | `PROOF-STORY-XXX.md` | None |

### Gap Details

1. **No Cheap Executor Option**
   - Current: All dev work uses Claude Opus via Claude Code CLI
   - PRD envisions: Default to cheaper model, escalate to Claude for complex tasks
   - **Decision:** Defer until routing is implemented

2. **No Context Pack**
   - Current: Each sub-agent reads files it needs via Glob/Grep/Read
   - PRD envisions: Pre-generated context pack for efficiency
   - **Recommendation:** Add `CONTEXT-PACK.md` to `_implementation/` with file inventory

3. **Phase Leader Pattern (2026-01-24)**
   - Commands are being refactored to use phase leaders with model tiering
   - Haiku for setup/completion phases, Sonnet for analysis phases
   - Reduces token costs by ~30-40% per command execution
   - See: `/qa-verify-story`, `/elab-story`, `/pm-bootstrap-workflow`, etc.

---

## 7. Self-Tuning (Future)

### PRD Requirement
> Post-50 stories: Routing stats aggregation, MCP confidence scoring, Optional model tuning

### Current State: NOT APPLICABLE YET

- Current story count: ~16 completed
- Target for self-tuning: 50-100 stories
- **Recommendation:** Track but do not implement until threshold reached

---

## Gap Priority Matrix

| Gap | Impact | Effort | Priority |
|-----|--------|--------|----------|
| Queryable MCP Schema | High | Medium | **P1** |
| MCP Query API | High | Medium | **P1** |
| Routing Decision Node | High | High | **P2** |
| Token Tracking Enforcement | Medium | Low | **P2** |
| MCP Confidence Scoring | Medium | Medium | **P3** |
| Routing Telemetry | Medium | Medium | **P3** |
| Context Pack Generator | Low | Medium | **P4** |
| Cheap Executor Option | Low | High | **Defer** |

---

## Recommended Implementation Phases

### Phase 0: MCP Foundation (Stories 017-018)

1. **STORY-017: Lessons MCP Schema**
   - Convert `LESSONS-LEARNED.md` to structured YAML
   - Add categories, tags, confidence scores
   - Maintain markdown readability

2. **STORY-018: MCP Query Command**
   - Create `/query-lessons` skill
   - Filter by phase, workspace, category
   - Return relevant lessons as context

### Phase 1: Routing v1 (Stories 019-020)

3. **STORY-019: Story Characterization**
   - Auto-detect: AC count, files touched, workspaces, risk flags
   - Output `ROUTING-DECISION.md` artifact

4. **STORY-020: Pipeline Configuration**
   - Enable/disable sub-agents based on routing
   - Add routing telemetry

### Phase 2: Integration (Stories 021-022)

5. **STORY-021: MCP Integration Points**
   - Query MCP at: elaboration, plan validation, code review
   - Cite applied lessons in artifacts

6. **STORY-022: Token Telemetry Enforcement**
   - Mandatory `TOKEN-SUMMARY.md`
   - Automated cost capture in agents

---

## Appendix: Current vs PRD Terminology Mapping

| PRD Term | Current Equivalent | Notes |
|----------|-------------------|-------|
| Run Bundle | Story folder (`STORY-XXX/`) | Same concept |
| MCP | `LESSONS-LEARNED.md` | Needs structure |
| Mini-Retrospective | Learnings Agent output | Same concept |
| Router Node | None | New component |
| OpenCode | N/A | Not using |
| Claude Code | Claude Code CLI | In use |
| Evidence | Proof document, Verification | Same concept |
| HITL Gate | Status-driven gates | Same concept |
| Context Pack | None | New concept |

---

## Appendix: Files Referenced

| File | Purpose |
|------|---------|
| `docs/FEATURE-DEVELOPMENT-WORKFLOW.md` | Current workflow documentation (v4.0) |
| `docs/FULL_WORKFLOW.md` | Unified development flow (v2.11.0) |
| `plans/stories/LESSONS-LEARNED.md` | Current lessons capture |
| `plans/stories/TOKEN-BUDGET-TEMPLATE.md` | Token tracking template |
| `plans/stories/STORY-016/` | Most recent complete story |
| `__prompts__/bootstrap-story-workflow.md` | Story bootstrapping prompt |
| `.claude/docs/qa-verify-story-reference.md` | QA Verify phase leader reference |

---

*Document Version: 1.1*
*Analysis Date: 2026-01-22*
*Last Updated: 2026-01-24*
*Updates: QA Verify refactored to phase leaders, VERIFICATION.yaml as unified output*
