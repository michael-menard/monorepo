schema: 1
story_id: "WKFL-009"
timestamp: "2026-02-07T22:05:00-07:00"

implementation_order:
  - step: 1
    name: "Schema Migration - Add archival columns"
    description: "Add archived, archived_at, canonical_id, is_canonical columns to knowledgeEntries table in Drizzle schema"
    files:
      - apps/api/knowledge-base/src/db/schema.ts
    ac_coverage: [AC-7]
    risk: medium
    notes: "Self-referential FK (canonical_id references knowledge_entries.id)"

  - step: 2
    name: "Update CRUD schemas and operations"
    description: "Extend KbUpdateInputSchema and kb_update to support archival fields. Extend KbAddInput for isCanonical."
    files:
      - apps/api/knowledge-base/src/crud-operations/schemas.ts
      - apps/api/knowledge-base/src/crud-operations/kb-update.ts
      - apps/api/knowledge-base/src/crud-operations/kb-add.ts
    ac_coverage: [AC-3, AC-7]
    risk: low

  - step: 3
    name: "Add Zod schemas for compression types"
    description: "Create CanonicalEntrySchema, ArchiveMetadataSchema, CompressionReportSchema in __types__"
    files:
      - apps/api/knowledge-base/src/__types__/index.ts
    ac_coverage: [AC-2, AC-4]
    risk: low

  - step: 4
    name: "Create kb-compressor agent"
    description: "Create haiku agent with compression algorithm: query entries, compute similarity, cluster, merge, archive, report"
    files:
      - .claude/agents/kb-compressor.agent.md
    ac_coverage: [AC-1, AC-2, AC-3, AC-5, AC-6]
    risk: low

  - step: 5
    name: "Create /kb-compress command"
    description: "Command documentation with --threshold, --dry-run, --days flags"
    files:
      - .claude/commands/kb-compress.md
    ac_coverage: [AC-6]
    risk: low

  - step: 6
    name: "Write unit tests"
    description: "Tests for schema changes, compression schemas, CRUD extensions"
    files:
      - apps/api/knowledge-base/src/__types__/__tests__/compression-schemas.test.ts
      - apps/api/knowledge-base/src/db/__tests__/schema-archival.test.ts
    ac_coverage: [AC-1, AC-2, AC-3, AC-4, AC-5, AC-7]
    risk: low

  - step: 7
    name: "Build verification"
    description: "Run type-check and build to verify no regressions"
    files: []
    ac_coverage: []
    risk: low

e2e_strategy:
  type: exempt
  reason: "Agent/command creation + schema extension - no API endpoints or UI. Verified via unit tests and type-checking."

dependencies:
  external: []
  internal:
    - "apps/api/knowledge-base/src/db/schema.ts (existing knowledgeEntries table)"
    - "apps/api/knowledge-base/src/crud-operations/ (existing CRUD ops)"
    - "apps/api/knowledge-base/src/search/semantic.ts (existing semantic search)"
