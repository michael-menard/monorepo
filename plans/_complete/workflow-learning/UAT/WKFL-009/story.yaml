id: WKFL-009
title: "Knowledge Compressor"
status: uat
priority: P2
phase: adaptation
created_at: 2026-02-06T17:00:00-07:00
updated_at: 2026-02-07T21:51:00-07:00
elaborated_at: 2026-02-07T21:51:00-07:00
elaboration_verdict: CONDITIONAL PASS

epic: workflow-learning
prefix: WKFL

dependencies: []
blocks: []

owner: null
estimated_tokens: 35000

tags:
  - adaptation
  - kb
  - compression
  - maintenance

summary: |
  Monthly job to cluster, deduplicate, and compress KB entries, maintaining
  a high-signal knowledge base that doesn't bloat over time.

goal: |
  Keep the KB lean and high-signal by:
  1. Clustering similar lessons (embedding similarity > 0.9)
  2. Merging clusters into canonical lessons
  3. Archiving originals with pointers to canonical
  4. Reporting compression stats

non_goals:
  - Deleting information (archive only)
  - Real-time compression
  - Cross-project KB management

scope:
  in:
    - kb-compressor.agent.md (haiku)
    - /kb-compress command (or monthly cron)
    - Embedding-based clustering
    - Canonical entry creation
    - Archive with pointer mechanism
    - Compression report

  out:
    - Pattern mining (WKFL-006 provides similar data)
    - Deleting any information

acceptance_criteria:
  - id: AC-1
    description: "Cluster similar lessons (embedding similarity > 0.9)"
    verification: "Run on test data, verify clusters formed correctly"

  - id: AC-2
    description: "Merge clusters into canonical lessons"
    verification: "Canonical entries created with examples array"

  - id: AC-3
    description: "Archive originals with pointer to canonical"
    verification: "Original entries have archived: true, canonical_id field"

  - id: AC-4
    description: "Report: entries before, after, token savings"
    verification: "COMPRESSION-REPORT.yaml has all stats"

  - id: AC-5
    description: "No loss of unique information"
    verification: "Automated test + manual spot-check verify all unique content preserved in canonical"

  - id: AC-6
    description: "Haiku model agent with /kb-compress command"
    verification: "Agent file exists with correct frontmatter, command registered"

  - id: AC-7
    description: "Schema migration adds archival columns"
    verification: "Database schema updated with archived, archived_at, canonical_id, is_canonical columns"

technical_notes: |
  ## Compression Algorithm

  1. Query all non-archived KB entries
  2. Compute embeddings for each entry
  3. Cluster by embedding similarity > 0.9
  4. For each cluster > 1 entry:
     a. Create canonical entry (merge titles, combine examples)
     b. Mark originals as archived with pointer
  5. Generate report

  ## Canonical Entry Schema

  ```yaml
  type: lesson
  id: kb-canonical-042
  title: "Zod validation required at API boundaries"
  canonical: true
  merged_from:
    - kb-lesson-015
    - kb-lesson-089
    - kb-lesson-123
  examples:
    - story: WISH-031
      context: "Missing validation on POST /wishlist"
    - story: AUTH-015
      context: "Missing validation on POST /login"
    - story: SET-042
      context: "Missing validation on PUT /sets/:id"
  recommendation: "Always add Zod schema validation in route handlers"
  tags:
    - canonical
    - validation
    - api
    - zod
  ```

  ## Archived Entry Update

  ```yaml
  # Original entry (updated)
  id: kb-lesson-015
  archived: true
  archived_at: 2026-02-28
  canonical_id: kb-canonical-042
  # Original content preserved
  ```

  ## COMPRESSION-REPORT.yaml

  ```yaml
  run_date: 2026-02-28

  before:
    total_entries: 847
    lessons: 623
    decisions: 142
    feedback: 82

  after:
    total_entries: 312
    canonical_entries: 312
    archived_entries: 535

  compression:
    ratio: 0.37  # 37% of original count
    estimated_token_savings: 245000  # ~45% token reduction in queries

  clusters_created:
    - id: kb-canonical-042
      size: 3
      topic: "Zod validation at boundaries"

    - id: kb-canonical-043
      size: 5
      topic: "Route handler length limits"

  no_cluster:
    count: 178
    reason: "Unique entries, no similar content"
  ```

  ## Safety Measures

  - Never delete, only archive
  - Archived entries still queryable with flag
  - Canonical entries include all unique info
  - Rollback: unarchive originals, delete canonical

reuse_plan:
  must_reuse:
    - KB tools (kb_search, kb_update)
    - Existing embedding infrastructure

  may_create:
    - kb-compressor.agent.md
    - /kb-compress command
    - Canonical entry schema
    - Archive mechanism

token_budget:
  estimated: 35000
  enforcement: warning
