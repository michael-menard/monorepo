---
status: backlog
split_from: STORY-01712
split_part: 1 of 4
---

# STORY-01721: Session & File Management - Gap Remediations

## Split Context

This story is part of a split from STORY-01712.
- **Original Story:** STORY-01712 (Session & File Management - Advanced Features, which itself was split from STORY-0171)
- **Split Reason:** STORY-01712 elaboration identified 16 ACs (8 gap remediations + 8 enhancements) that exceeded safe story sizing boundaries. This split addresses the 8 critical gaps identified during elaboration with low-risk documentation and edge case handling.
- **This Part:** 1 of 4 (Z=1)
- **Dependency:** STORY-01711 (requires core CRUD endpoints to be complete)

## Title

Multipart Upload Session Management - Gap Remediations & Documentation

## Context

This story addresses 8 critical gaps identified during STORY-01712 QA elaboration phase. These gaps include missing specifications around session cleanup timing, part size configuration rationale, concurrent registration race condition handling, complete file idempotency behavior, session expiration edge cases, MIME type validation documentation, file count limits enforcement, and rate limit bypass for testing environments.

All changes in this story are low-risk: documentation clarifications, test case additions, and defensive error handling. No new endpoints are added, no database schema changes are required. This story extends the core CRUD functionality established in STORY-01711 with edge case handling and clearer API behavior specifications.

This story does NOT implement new features, enhancements, or analytics. It focuses purely on gap remediation to make the existing session management API more robust and well-documented.

## Goal

Clarify and document session management API behavior for edge cases, add defensive error handling for concurrent operations and expired sessions, implement idempotency for the complete endpoint, and provide rate limit bypass configuration for local development. All changes maintain full API compatibility with existing clients.

## Non-Goals

- New feature implementation (deferred to STORY-01722, STORY-01723)
- WebSocket integration (STORY-01724)
- Database schema changes (use existing tables from STORY-01711)
- Binary part upload handling (STORY-0172)
- Session finalization (STORY-0172)
- Background cleanup job implementation (STORY-018)
- Frontend UI changes (backend API only)

## Scope

### Gap Remediations (8 items)

1. **Session Cleanup Timing Specification** (AC-10) - Document behavior of orphaned sessions and coordination with STORY-018
2. **Part Size Configuration Rationale** (AC-11) - Document why `partSizeBytes: 5242880` (5MB) is used and add env var override
3. **Concurrent Registration Handling** (AC-12) - Handle race conditions when multiple files registered simultaneously
4. **Complete File Idempotency** (AC-13) - Clarify and implement idempotent behavior for complete endpoint
5. **Session Expiration Edge Cases** (AC-14) - Handle sessions expiring during multipart upload with proper error codes
6. **MIME Type Validation Documentation** (AC-15) - Document advisory nature and finalize-time validation
7. **File Count Limits** (AC-16) - Validate registered file count against session metadata
8. **Rate Limit Bypass for Testing** (AC-17) - Add `RATE_LIMIT_BYPASS` env var for local development

### Packages/Apps Affected

**Modify:**
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/index.ts` (add file count validation, rate limit bypass)
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/index.ts` (add concurrent registration handling, expiration checks)
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/[fileId]/complete.ts` (add idempotency, expiration handling)

**Documentation:**
- Add code comments for cleanup timing (AC-10)
- Add code comments for part size rationale (AC-11)
- Add code comments for MIME validation advisory nature (AC-15)

## Acceptance Criteria

### AC-10: Session Cleanup Timing Specification
- [ ] Document in code comments that sessions with `status="active"` and `expiresAt < NOW` will be cleaned by STORY-018 background job
- [ ] Document minimum TTL buffer recommendation for clients (e.g., 10 minutes before expiration, re-create session)
- [ ] Add logging for session expiration events with context (sessionId, elapsed time, files registered)

### AC-11: Part Size Configuration Rationale
- [ ] Document in code comments that `partSizeBytes: 5242880` (5MB) is S3's minimum multipart part size
- [ ] Document trade-offs: smaller parts = more HTTP requests, larger parts = longer individual request times
- [ ] Add configuration option to override part size via env var `MULTIPART_PART_SIZE_MB` (default: 5)

### AC-12: Concurrent File Registration Handling
- [ ] Implement database transaction isolation for file registration
- [ ] Add test case for concurrent POST to same session with identical file metadata
- [ ] Return `409 CONFLICT` with clear message when duplicate file key detected within same session
- [ ] Document expected behavior: clients should use unique file names or allow system to generate unique keys

### AC-13: Complete File Idempotency
- [ ] Implement idempotent behavior: if file already completed, return `200 OK` with existing `fileUrl`
- [ ] Log idempotent completion attempts with warning level (potential client retry issue)
- [ ] Document idempotency behavior in API comments and error messages

### AC-14: Session Expiration Window Edge Case
- [ ] When complete endpoint called on expired session, return `410 GONE` (not `400`) with `sessionExpired: true` flag
- [ ] Include `expiresAt` and current time in error response for client debugging
- [ ] Document recommended client retry strategy: re-create session, re-register files, resume upload

### AC-15: MIME Type Validation Documentation
- [ ] Document in code comments that MIME validation at session creation is advisory only
- [ ] Document that real content validation happens at finalize (STORY-0172) using magic bytes
- [ ] Add warning-level log when client uploads different content-type than declared

### AC-16: File Count Limits Enforcement
- [ ] Track file count in `upload_sessions` table (add virtual column or compute on-the-fly)
- [ ] Validate that registered file count does not exceed declared count in session metadata
- [ ] Return `400 BAD_REQUEST` with `fileCountExceeded` error code when limit reached
- [ ] Document that enforcement happens at register time (not finalize)

### AC-17: Rate Limit Bypass for Testing
- [ ] Add `RATE_LIMIT_BYPASS=true` environment variable for local development
- [ ] When bypass enabled, skip rate limit checks but still log rate limit events
- [ ] Document in README that bypass should NEVER be enabled in production
- [ ] Add warning log on server startup when bypass is enabled

## Reuse Plan

### Existing Packages to Use

| Package | Purpose |
|---------|---------|
| `@repo/rate-limit` | Rate limiting (with bypass support) |
| `@repo/logger` | Structured logging for expiration events |
| Core handlers from STORY-01711 | Extend existing session/file endpoints |

### Existing Core Code to Reference

| Path | Purpose |
|------|---------|
| STORY-01711 handlers | Base implementation to extend |
| `apps/api/core/config/upload.ts` | Upload configuration |
| `apps/api/platforms/aws/endpoints/moc-uploads/` | AWS implementation patterns |

### New Shared Code

No new shared packages. All changes are inline in Vercel handlers or configuration files.

## Architecture Notes (Ports & Adapters)

### Port Interfaces (No changes)

This story extends existing port implementations from STORY-01711 without modifying interfaces:
- `SessionService.createSession()` - add file count validation
- `FileService.registerFile()` - add concurrent registration handling, expiration checks
- `FileService.completeFile()` - add idempotency, expiration handling

### Adapter Responsibilities

**Database Adapter (Drizzle) - Extended:**
- Transaction isolation for concurrent file registration (AC-12)
- Query for existing completed files (AC-13)
- Track registered file count (AC-16)

**Rate Limit Adapter - Extended:**
- Check `RATE_LIMIT_BYPASS` env var (AC-17)
- Log rate limit events even when bypassed

## Required Vercel / Infra Notes

### Environment Variables Required (New)

- `RATE_LIMIT_BYPASS` - Bypass rate limits for testing (true/false, default: false)
- `MULTIPART_PART_SIZE_MB` - Override default 5MB part size (optional, default: 5)

### No Route Changes

This story does not add new endpoints. All changes extend existing routes from STORY-01711.

## HTTP Contract Plan

### Required `.http` Requests

All requests are defined in `__http__/story-01721-gap-remediations.http`:

| Request | Test ID | Description |
|---------|---------|-------------|
| `completeFileIdempotent` | ID-HP-001 | Complete file twice, second returns 200 |
| `completeExpiredSession` | EE-HP-001 | Complete file on expired session, returns 410 |
| `registerFileConcurrent` | CR-HP-001 | Concurrent registration with same file key |
| `registerFileCountExceeded` | FC-HP-001 | Register file when count limit reached |
| `createSessionWithPartSizeOverride` | PS-HP-001 | Create session with custom part size env var |
| `registerFileBypassRateLimit` | RL-HP-001 | Register file with rate limit bypass enabled |

### Error Case Requests

| Request | Test ID | Expected Status |
|---------|---------|-----------------|
| Concurrent registration duplicate | CR-ERR-001 | 409 |
| File count exceeded | FC-ERR-001 | 400 |
| Session expired (410) | EE-ERR-001 | 410 |

### Required Evidence

Captured in proof document:
- All happy path requests with responses
- Error case examples with proper status codes
- Database queries showing transaction isolation behavior
- Log output showing expiration events, idempotency warnings, rate limit bypass warnings

## Seed Requirements

### Test Data for Gap Remediation Testing

```sql
-- Session nearing expiration for AC-14 testing
INSERT INTO upload_sessions (id, user_id, status, part_size_bytes, expires_at, created_at, updated_at)
VALUES (
  'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb',
  'dev-user-00000000-0000-0000-0000-000000000001',
  'active',
  5242880,
  NOW() - INTERVAL '5 minutes', -- expired 5 minutes ago
  NOW() - INTERVAL '35 minutes',
  NOW()
);

-- Completed file for AC-13 idempotency testing
INSERT INTO upload_session_files (id, session_id, file_key, file_size_bytes, status, file_url, created_at, updated_at)
VALUES (
  'cccccccc-cccc-cccc-cccc-cccccccccccc',
  'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa',
  'completed-test.pdf',
  5000000,
  'completed',
  's3://bucket/completed-test.pdf',
  NOW(),
  NOW()
);

-- Session with file count limit for AC-16 testing
INSERT INTO upload_sessions (id, user_id, status, part_size_bytes, metadata, expires_at, created_at, updated_at)
VALUES (
  'dddddddd-dddd-dddd-dddd-dddddddddddd',
  'dev-user-00000000-0000-0000-0000-000000000001',
  'active',
  5242880,
  '{"maxFiles": 2}',
  NOW() + INTERVAL '30 minutes',
  NOW(),
  NOW()
);
```

### Seed Location

Add to `apps/api/core/database/seeds/story-01721.ts` and register in seed index.

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| Feature | Test ID | Description | Expected |
|---------|---------|-------------|----------|
| Idempotency | ID-HP-001 | Complete file twice | 2nd returns 200 with same URL |
| Part Size Override | PS-HP-001 | Create session with env var override | Session uses custom part size |
| Rate Limit Bypass | RL-HP-001 | Register with bypass enabled | Request succeeds, bypass logged |

### Error Cases

| Category | Test ID | Condition | Status | Code |
|----------|---------|-----------|--------|------|
| Concurrent | CR-ERR-001 | Duplicate file key | 409 | CONFLICT |
| Limits | FC-ERR-001 | File count exceeded | 400 | BAD_REQUEST |
| Expiration | EE-ERR-001 | Complete expired session | 410 | GONE |

### Edge Cases

- **Idempotent completion**: Already-completed files return success, not error
- **Session expiration**: Proper 410 GONE with debugging context
- **Rate limit bypass**: Bypass logs warning but allows request
- **Concurrent registration**: Transaction isolation prevents duplicate keys

### Evidence Requirements

Per-feature proof:
- [ ] Happy path request/response for each AC
- [ ] Error case examples with proper status codes (409, 400, 410)
- [ ] Database queries showing transaction behavior
- [ ] Log output showing expiration events, warnings, bypass notices

---

## Risks / Edge Cases

### Risks

1. **Idempotency Breaking Change:** AC-13 makes complete endpoint idempotent (200 on second call). If existing clients expect 400 on duplicate completion, this could break their error handling.
2. **Part Size Override Risk:** AC-11 allows env var override. Values < 5MB will fail S3 multipart API. Need validation.
3. **Rate Limit Bypass Security:** AC-17 bypass could be accidentally enabled in production. Need startup warning and clear documentation.
4. **Transaction Isolation Performance:** AC-12 transaction isolation could impact concurrent registration throughput. Monitor performance.

### Edge Cases

- **Expired session during upload**: Client uploads parts but session expires before completion. Return 410 with clear context.
- **File count off-by-one**: Ensure count includes the current registration attempt (e.g., if maxFiles=2 and 1 registered, allow 1 more).
- **Idempotent completion race**: Two clients complete same file simultaneously. First wins, second gets idempotent response.
- **Part size validation**: Reject part sizes < 5MB (S3 minimum) or > 100MB (practical limit).

---

## Token Budget

| Phase | Agent | Input (est) | Output (est) |
|-------|-------|-------------|--------------|
| PM: Story Split | PM Split Leader | ~20K | ~8K |
| **PM Total** | â€” | **~20K** | **~8K** |

---

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-25 | PM Split Leader | Split STORY-01712 into 4 stories (STORY-01721, STORY-01722, STORY-01723, STORY-01724) | `plans/stories/backlog/STORY-01721/STORY-01721.md` |
