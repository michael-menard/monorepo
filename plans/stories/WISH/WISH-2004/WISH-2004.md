---
doc_type: story
title: "WISH-2004: Modals & Transitions"
story_id: WISH-2004
story_prefix: WISH
status: Approved
phase: 3
created_at: "2026-01-24T02:00:00-07:00"
updated_at: "2026-01-24T02:00:00-07:00"
depends_on: [WISH-2001]
estimated_points: 8
sizing_warning: true
---

# WISH-2004: Modals & Transitions

## Goal

Complete item lifecycle with delete and purchase flows.

## Feature

DELETE endpoint, POST purchased endpoint, delete confirmation modal, "Got It" modal with purchase details form, toast notifications with undo.

## Phase

Phase 3: Core Features

## Sizing Warning

⚠️ This story bundles multiple independent features (Delete + Purchase/Got It flows) with complex transaction logic. Monitor scope during elaboration.

## Acceptance Criteria

- [ ] DELETE `/api/wishlist/:id` endpoint removes item
- [ ] POST `/api/wishlist/:id/purchased` endpoint creates Set and optionally deletes Wishlist item
- [ ] Delete confirmation modal (AlertDialog) with "This is permanent" warning
- [ ] "Got It" modal with form: price paid (pre-filled), tax, shipping, quantity, purchase date, "Keep on wishlist" checkbox
- [ ] Purchase date defaults to today
- [ ] "Got It" transaction is atomic: create Set first, then delete Wishlist (if checkbox unchecked)
- [ ] RTK Query mutations: `useRemoveFromWishlistMutation`, `useMarkAsPurchasedMutation`
- [ ] Toast notifications for success with 5-second undo window
- [ ] Undo restores wishlist item and deletes set item
- [ ] Navigation to Sets Gallery after "Got It" (optional)

## Risk Notes

"Got It" transaction must be atomic to prevent data loss; create Set before deleting Wishlist item. Data loss risk if not handled correctly.

## Technical Details

### Backend (API)

**Locations:**
- `apps/api/endpoints/wishlist/delete/handler.ts`
- `apps/api/endpoints/wishlist/purchased/handler.ts`

**DELETE /api/wishlist/:id**

Hard deletes wishlist item (no soft delete).

Response: `204 No Content` on success

**POST /api/wishlist/:id/purchased**

Marks item as purchased by creating a Set item. Optionally deletes Wishlist item.

Request body:
```json
{
  "pricePaid": "number (optional)",
  "tax": "number (optional)",
  "shipping": "number (optional)",
  "quantity": "number (default: 1)",
  "purchaseDate": "ISO date (optional, default: today)",
  "keepOnWishlist": "boolean (default: false)"
}
```

Response: `201 Created` with new Set item object

**Transaction Logic**

1. Create Set item (with wishlist link for reference)
2. If `keepOnWishlist` is false, delete Wishlist item
3. Return new Set item
4. If Set creation fails, do NOT delete Wishlist item

### Frontend (React)

**Locations:**
- `apps/web/app-wishlist-gallery/src/components/DeleteConfirmModal.tsx`
- `apps/web/app-wishlist-gallery/src/components/GotItModal.tsx`
- `apps/web/app-wishlist-gallery/src/hooks/useUndoAction.ts`

**Delete Confirmation Modal**

AlertDialog with:
- Title: "Delete Item?"
- Message: "This action is permanent. You cannot undo it."
- Item preview (thumbnail + title)
- Cancel button
- Delete button (destructive/red)

On confirm: Call `useRemoveFromWishlistMutation`

**"Got It" Modal**

Form with:
- Price paid input (pre-filled from Wishlist price if available)
- Tax input (optional)
- Shipping input (optional)
- Quantity stepper (default: 1, min: 1)
- Purchase date picker (default: today)
- Checkbox: "Keep on Wishlist" (default: unchecked)
- Cancel button
- "Got It!" button

On submit: Call `useMarkAsPurchasedMutation`

**Toast Notifications**

On delete/purchase success:
- Show toast: "Item removed" / "Item added to your collection"
- Display "Undo" action for 5 seconds
- Undo action: Restore Wishlist item, delete Set item (if applicable)

### RTK Query Integration

**Location:** `packages/core/api-client/src/rtk/wishlist-api.ts`

Mutations:
- `useRemoveFromWishlistMutation()` - DELETE endpoint
- `useMarkAsPurchasedMutation()` - POST purchased endpoint

Both invalidate `useGetWishlistQuery` cache on success.

Undo logic:
- Keep deleted item in cache for 5 seconds
- Restore on undo action
- Clear from cache after 5 seconds if not undone

## Dependencies

- **Depends On:** WISH-2001 (gallery)
- **Can run in parallel with:** WISH-2002, WISH-2003
- **Unblocks:** WISH-2005 (UX Polish)
- **Future:** Links to SETS epic for "Got It" set creation

## Reuse Plan

- Use `@repo/app-component-library` AlertDialog for delete modal
- Use Modal component patterns from existing modals
- Use RTK Query mutation and cache invalidation patterns
- Leverage undo/optimistic update patterns from existing implementations

## Test Coverage

**Backend Tests:**
- Delete removes item
- Delete non-existent item (404)
- Delete unauthorized (403)
- Purchase creates Set
- Purchase with keepOnWishlist=true keeps Wishlist item
- Purchase with keepOnWishlist=false deletes Wishlist item
- Purchase transaction rollback on Set creation failure
- All field validation

**Frontend Tests:**
- Delete modal renders
- Got It modal renders with form
- Form validation
- Toast notifications appear/disappear
- Undo action restores item
- Optimistic updates

**E2E Tests:**
- User can delete item from gallery
- User can delete item from detail view
- Delete confirmation shows
- User can undo delete for 5 seconds
- User can mark item as purchased
- Got It modal shows and collects data
- Item disappears from gallery after undo window
- Item appears in Sets gallery after purchase

## Definition of Done

- [ ] DELETE endpoint created and deployed
- [ ] POST purchased endpoint created and deployed
- [ ] Delete confirmation modal implemented
- [ ] Got It modal with form implemented
- [ ] Toast notifications with undo working
- [ ] Transaction logic atomic and tested
- [ ] RTK Query mutations created
- [ ] Optimistic updates working
- [ ] All tests passing
- [ ] Code reviewed
- [ ] Ready for WISH-2005

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~8k | — | — | Large scope |
| Elaboration | ~12k | — | — | Transaction logic |
| Implementation | ~40k | — | — | Modals + transaction |
| Code Review | ~10k | — | — | Complex logic |
| **Total** | ~70k | — | — | Larger story |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-24 02:00 | pm-bootstrap-generation-leader | Created story file | WISH-2004.md |
