---
status: in-qa
split_from: STORY-0171
split_part: 1 of 2
---

# STORY-01711: Session & File Management - CRUD Only

## Split Context

This story is part of a split from STORY-0171.
- **Original Story:** STORY-0171 (Session & File Management, which itself was split from STORY-017)
- **Split Reason:** STORY-0171 elaboration identified 8 critical gaps and 8 enhancement opportunities that expanded scope beyond safe story sizing boundaries (from 5 ACs to 21 ACs). Split separates core CRUD functionality from advanced features.
- **This Part:** 1 of 2 (Z=1)
- **Dependency:** No dependencies

## Title

Migrate Multipart Upload Session Management Endpoints (Core CRUD) to Vercel

## Context

This story is part of the Vercel migration initiative and represents the core CRUD phase of migrating multipart upload session functionality. The multipart upload session flow enables uploading large MOC instruction files (PDFs up to 50MB) via chunked uploads with server-side coordination.

This story focuses on establishing the foundational session infrastructure: creating upload sessions, registering files within sessions, and completing file uploads. It does NOT handle binary part uploads (STORY-0172) or advanced features like session analytics, duplicate detection, or upload resume (STORY-01712).

The AWS Lambda implementation already exists and is production-tested. This story migrates that implementation to Vercel while preserving identical API contracts and behavior.

## Goal

Migrate core session creation, file registration, and file completion endpoints from AWS Lambda to Vercel serverless functions while maintaining full API compatibility and identical behavior. Establish clean code organization and database schema foundation for advanced features.

## Non-Goals

- Binary part upload handling (STORY-0172)
- Session finalization and MOC creation (STORY-0172)
- Advanced features (WebSocket progress, session analytics, duplicate detection, etc.) - deferred to STORY-01712
- Creating new UI for upload progress (existing frontend already uses these APIs)
- Adding new upload features not present in AWS implementation
- Implementing S3 lifecycle policies or cleanup jobs (STORY-018)
- Migrating WebSocket notifications (STORY-019)

## Scope

### Endpoints (3 total)

| Method | Route | Handler |
|--------|-------|---------|
| POST | `/api/mocs/uploads/sessions` | Create upload session |
| POST | `/api/mocs/uploads/sessions/:sessionId/files` | Register file within session |
| POST | `/api/mocs/uploads/sessions/:sessionId/files/:fileId/complete` | Complete file upload |

### Packages/Apps Affected

**Create:**
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/index.ts`
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/index.ts`
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/[fileId]/complete.ts`

**Modify:**
- `apps/api/platforms/vercel/vercel.json` (route rewrites)
- `__http__/` (add test file)

### Database Tables (No Schema Changes)

Existing tables used:
- `upload_sessions` - Session state, TTL, finalization state
- `upload_session_files` - Files with S3 keys and multipart upload IDs
- `upload_session_parts` - Part ETags for multipart completion (referenced but not modified in this story)

## Acceptance Criteria

### AC-1: Create Session Endpoint
- [ ] `POST /api/mocs/uploads/sessions` accepts `{ files: FileMetadata[] }` body
- [ ] Returns `201 Created` with `{ sessionId, partSizeBytes, expiresAt }`
- [ ] Validates files array has at least one instruction file
- [ ] Validates file size limits per category (PDF: 50MB, image: 10MB, parts-list: 5MB)
- [ ] Validates MIME types per category
- [ ] Enforces rate limit before DB write (daily limit via `@repo/rate-limit`)
- [ ] Returns `429` with `nextAllowedAt` when rate limited
- [ ] Returns `401` when unauthenticated

### AC-2: Register File Endpoint
- [ ] `POST /api/mocs/uploads/sessions/:sessionId/files` accepts file metadata
- [ ] Returns `201 Created` with `{ fileId, uploadId }`
- [ ] Validates session exists, belongs to user, is active, not expired
- [ ] Initiates S3 multipart upload via `CreateMultipartUploadCommand`
- [ ] Creates record in `upload_session_files` table
- [ ] Returns `404` for non-existent or other user's session
- [ ] Returns `400` for expired or non-active session

### AC-4: Complete File Endpoint
- [ ] `POST /api/mocs/uploads/sessions/:sessionId/files/:fileId/complete` accepts `{ parts: [{partNumber, etag}] }`
- [ ] Returns `200 OK` with `{ fileId, fileUrl }`
- [ ] Validates part count matches uploaded parts in DB
- [ ] Calls S3 `CompleteMultipartUploadCommand`
- [ ] Updates file status to `completed` with `fileUrl`
- [ ] Returns `400` for part count mismatch or already-completed file

### AC-6: Authentication (All Endpoints)
- [ ] All endpoints require authentication
- [ ] Local development uses `AUTH_BYPASS=true` with `DEV_USER_SUB`
- [ ] Returns `401 UNAUTHORIZED` when no auth token provided

### AC-7: Vercel Function Configuration
- [ ] Function timeout configured appropriately for S3 operations
- [ ] Routes added to `vercel.json` for all 3 endpoints

### AC-8: Core Package (Code Organization)
- [ ] Zod schemas defined inline following STORY-015/016 patterns
- [ ] Error mapping helper (`mapErrorToStatus()`) implemented
- [ ] Singleton DB client pattern used
- [ ] Singleton S3 client pattern used

### AC-9: Database Schema (Clarity)
- [ ] Database operations use existing schema without modifications
- [ ] Comments in code document expected table structures
- [ ] No schema migrations required for this story

## Reuse Plan

### Existing Packages to Use

| Package | Purpose |
|---------|---------|
| `@repo/rate-limit` | Daily rate limiting for session creation |
| `@repo/logger` | Structured logging |

### Existing Core Code to Reference

| Path | Purpose |
|------|---------|
| `apps/api/platforms/aws/endpoints/moc-uploads/sessions/_shared/schemas.ts` | Zod schemas for all request/response types |
| `apps/api/core/config/upload.ts` | Upload configuration (size limits, TTLs, MIME types) |
| `apps/api/core/rate-limit/postgres-store.ts` | Postgres-backed rate limit store |

### Patterns to Follow

- Singleton DB client pattern from STORY-015/016 Vercel handlers
- Singleton S3 client pattern from STORY-015/016 Vercel handlers
- Inline schema definitions (matching STORY-015/016 pattern)
- `mapErrorToStatus()` helper for error code -> HTTP status mapping

### No New Shared Packages Created

Per reuse-first principle, inline logic in Vercel handlers. Core package extraction is a follow-up refactor.

## Architecture Notes (Ports & Adapters)

### Port Interfaces

**Session Service Port:**
- `createSession(userId, files) -> { sessionId, partSizeBytes, expiresAt }`
- `getSession(sessionId) -> Session | null`
- `validateSessionOwnership(sessionId, userId) -> boolean`

**File Service Port:**
- `registerFile(sessionId, fileMetadata) -> { fileId, uploadId }`
- `completeFile(fileId, parts) -> { fileUrl }`

### Adapter Responsibilities

**Database Adapter (Drizzle):**
- Query `upload_sessions`, `upload_session_files` tables
- Insert/update records atomically
- Enforce unique constraints (session-file)

**S3 Adapter:**
- `CreateMultipartUploadCommand` - initiate upload
- `CompleteMultipartUploadCommand` - finalize file

## Required Vercel / Infra Notes

### Route Rewrites

```json
// vercel.json (rewrites section)
[
  { "source": "/api/mocs/uploads/sessions", "destination": "/api/mocs/uploads/sessions/index" },
  { "source": "/api/mocs/uploads/sessions/:sessionId/files", "destination": "/api/mocs/uploads/sessions/[sessionId]/files/index" },
  { "source": "/api/mocs/uploads/sessions/:sessionId/files/:fileId/complete", "destination": "/api/mocs/uploads/sessions/[sessionId]/files/[fileId]/complete" }
]
```

### Environment Variables Required

- `DATABASE_URL` - PostgreSQL connection string
- `AWS_ACCESS_KEY_ID` - S3 access
- `AWS_SECRET_ACCESS_KEY` - S3 secret
- `AWS_REGION` - S3 region (default: us-east-1)
- `MOC_BUCKET` or `LEGO_API_BUCKET_NAME` - S3 bucket for uploads
- `AUTH_BYPASS` - Local dev auth bypass (true/false)
- `DEV_USER_SUB` - Dev user ID when AUTH_BYPASS=true

## HTTP Contract Plan

### Required `.http` Requests

All requests are defined in `__http__/story-01711-session-crud.http`:

| Request | Test ID | Description |
|---------|---------|-------------|
| `createSessionSingleFile` | CS-HP-001 | Create session with single instruction file |
| `createSessionAllTypes` | CS-HP-004 | Create session with all file types |
| `registerFile` | RF-HP-001 | Register instruction PDF file |
| `completeFile` | CF-HP-001 | Complete single-part upload |

### Error Case Requests

| Request | Test ID | Expected Status |
|---------|---------|-----------------|
| Empty files array | CS-VAL-003 | 422 |
| No instruction file | CS-VAL-004 | 400 |
| File too large | CS-LIM-001 | 413 |
| Invalid MIME type | CS-LIM-006 | 415 |
| Non-existent session | RF-PATH-003 | 404 |
| Part count mismatch | CF-VAL-007 | 400 |

### Required Evidence

Captured in proof document:
- All happy path requests with 2xx responses
- Representative error cases (401, 400, 404, 413, 415, 422, 429)
- Database queries showing records created in `upload_sessions` and `upload_session_files` tables
- S3 console or CLI showing multipart upload IDs created

## Seed Requirements

### Test Data for Error Cases

The following should be seeded for testing edge cases:

```sql
-- Expired session for testing RF-STATE-004
INSERT INTO upload_sessions (id, user_id, status, part_size_bytes, expires_at, created_at, updated_at)
VALUES (
  'eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee',
  'dev-user-00000000-0000-0000-0000-000000000001',
  'active',
  5242880,
  NOW() - INTERVAL '1 hour',
  NOW() - INTERVAL '2 hours',
  NOW() - INTERVAL '2 hours'
);

-- Other user's session for auth testing (RF-AUTH-002)
INSERT INTO upload_sessions (id, user_id, status, part_size_bytes, expires_at, created_at, updated_at)
VALUES (
  'dddddddd-dddd-dddd-dddd-dddddddddddd',
  'other-user-99999999-9999-9999-9999-999999999999',
  'active',
  5242880,
  NOW() + INTERVAL '15 minutes',
  NOW(),
  NOW()
);
```

### Seed Location

Add to `apps/api/core/database/seeds/story-01711.ts` and register in seed index.

### Requirements

- Deterministic: Uses fixed UUIDs
- Idempotent: Use upsert or delete-then-insert pattern

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| Endpoint | Test ID | Description | Expected |
|----------|---------|-------------|----------|
| Create Session | CS-HP-001 | Single instruction file | 201, sessionId returned |
| Create Session | CS-HP-004 | All file types | 201, session created |
| Register File | RF-HP-001 | Instruction PDF | 201, fileId + uploadId |
| Complete File | CF-HP-001 | Single-part upload | 200, fileId + fileUrl |

### Error Cases

| Category | Test ID | Condition | Status | Code |
|----------|---------|-----------|--------|------|
| Auth | CS-AUTH-001 | Missing auth header | 401 | UNAUTHORIZED |
| Validation | CS-VAL-003 | Empty files array | 422 | VALIDATION_ERROR |
| Validation | CS-VAL-004 | No instruction file | 400 | BAD_REQUEST |
| Limit | CS-LIM-001 | Instruction >50MB | 413 | BAD_REQUEST |
| Limit | CS-LIM-006 | Invalid MIME type | 415 | BAD_REQUEST |
| Rate | CS-RL-001 | Daily limit exceeded | 429 | TOO_MANY_REQUESTS |
| State | RF-STATE-004 | Session expired | 400 | BAD_REQUEST |
| Path | RF-PATH-003 | Session not found | 404 | NOT_FOUND |
| State | CF-STATE-004 | File already completed | 400 | BAD_REQUEST |

### Evidence Requirements

Per-endpoint proof:
- [ ] Happy path request/response screenshot
- [ ] At least 3 error case screenshots per endpoint
- [ ] Database state verification (query results)
- [ ] S3 verification (multipart upload IDs)

---

## Risks / Edge Cases

### Risks

1. **Session Expiration:** Sessions expire after TTL. Client must handle 400 errors and re-create sessions.
2. **S3 Multipart Coordination:** Multipart upload IDs must be tracked correctly. Incomplete uploads create orphaned parts (cleanup in STORY-018).
3. **Rate Limiting:** Daily limits prevent abuse. Client must handle 429 responses with `nextAllowedAt`.
4. **Concurrent File Registration:** Multiple files can be registered concurrently. Database unique constraints prevent duplicates.

### Edge Cases

- **Re-complete same file:** Returns 400 if already completed
- **Session ownership validation:** All endpoints verify session belongs to authenticated user
- **Part count mismatch:** Complete endpoint validates parts count matches uploaded parts

---

## Token Budget

| Phase | Agent | Input (est) | Output (est) |
|-------|-------|-------------|--------------|
| PM: Story Split | PM | ~15K | ~8K |
| **PM Total** | — | **~15K** | **~8K** |

---

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-25 | PM Split Leader | Split STORY-017 into STORY-0171 and STORY-0172 | `plans/stories/backlog/STORY-0171/STORY-0171.md` |
| 2026-01-25 | QA Elaboration Leader | Elaborate STORY-0171, identify 8 gaps + 8 enhancements | `plans/stories/elaboration/STORY-0171/ELAB-STORY-0171.md` |
| 2026-01-25 | PM Split Leader | Split STORY-0171 into STORY-01711 (CRUD) and STORY-01712 (Advanced) | `plans/stories/backlog/STORY-01711/STORY-01711.md`, `plans/stories/backlog/STORY-01712/STORY-01712.md` |

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-25_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| gap1_file_metadata_validation | File metadata validation inconsistency - Story validates files at session creation (AC-1) but doesn't validate at file registration (AC-2). Client could register file with different metadata than declared. Recommend adding validation in register endpoint to verify file metadata matches session declaration. | Add as AC | Will be added as implementation requirement. |
| gap2_orphaned_multipart_cleanup | Orphaned multipart upload cleanup - Story creates S3 multipart uploads but doesn't handle cleanup of incomplete uploads. S3 charges for incomplete multipart uploads. Document that cleanup is deferred to STORY-018 and recommend S3 lifecycle policy for orphaned uploads. | Add as AC | Will be addressed during implementation or deferred to STORY-018. |
| gap3_session_expiration_grace | Session expiration grace period - Sessions expire at `expiresAt` timestamp. If client completes file exactly at expiration, race condition exists. Recommend 1-minute grace period or document that clients should buffer expiration by 5+ minutes. | Add as AC | Will be added as implementation requirement. |
| gap4_concurrent_operations | Concurrent operations on same session - Multiple clients with same auth token could register/complete files concurrently. Database constraints prevent duplicate file registration but don't prevent race conditions on session state validation. Recommend explicit test case for concurrent operations. | Add as AC | Will be added as implementation requirement. |
| gap5_part_count_validation | Part count validation gap - AC-4 validates "part count matches uploaded parts in DB" but story doesn't specify WHERE parts are tracked. `upload_session_parts` table exists in schema but STORY-01711 doesn't use it (parts upload is STORY-0172). How does complete file know expected part count? Recommend clarification or removal of this validation from STORY-01711 scope. | Add as AC | Will be clarified during implementation. |
| gap6_s3_key_generation | S3 key generation strategy not specified - Story references S3 keys but doesn't specify format or collision prevention strategy. AWS schemas show keys but generation logic not documented. Recommend documenting key format: `uploads/{userId}/{sessionId}/{fileId}/{filename}` with sanitization rules. | Add as AC | Will be added as implementation requirement. |
| gap7_session_status_transitions | Session status transition rules - Story defines session status field ('active', 'completed', 'expired', 'cancelled') but only uses 'active' in STORY-01711 scope. Document that other statuses are for STORY-0172/STORY-01712 or clarify if session status changes in this story. | Add as AC | Will be documented during implementation. |
| gap8_file_url_generation | File URL generation timing - AC-4 returns `fileUrl` after completion but story doesn't specify format. Is it S3 presigned URL, CloudFront URL, or permanent S3 URL? Document URL format and TTL (if presigned). Recommend permanent S3 URL format for completed files. | Add as AC | Will be added as implementation requirement. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| enh1_openapi_spec | OpenAPI spec generation - Story has comprehensive `.http` file with test IDs. Auto-generate OpenAPI 3.0 spec from `.http` file for API documentation and client SDK generation. Low effort, high DX value. | Add as AC | Optional for MVP but valuable for API documentation. |
| enh2_idempotency | Session creation idempotency - If client retries session creation due to network failure, multiple sessions created. Add idempotency key to CreateSessionRequest (optional header or body field) to prevent duplicate sessions. Deferred to STORY-01712 per split but worth noting. | Add as AC | Can be added to improve robustness. |
| enh3_file_registration_response | File registration response enhancement - Register file returns `fileId` and `uploadId` but not upload instructions (part size, part count). Client must remember from session creation. Consider returning session context in response for stateless clients. | Add as AC | Can improve developer experience. |
| enh4_structured_error_codes | Structured error codes - Story maps errors to HTTP status but doesn't define structured error code enum (e.g., "SESSION_EXPIRED", "FILE_TOO_LARGE"). Recommend error response schema: `{ code: string, message: string, details?: object }`. Improves client error handling. | Add as AC | Will improve API robustness. |
| enh5_audit_trail | Audit trail for operations - Upload sessions involve multiple operations (create, register, complete). Add audit log for security and debugging. Track who did what when. Low impact for MVP but valuable for production troubleshooting. | Add as AC | Optional for MVP. |
| enh6_metrics_observability | Metrics and observability - Track session success rate, average files per session, common failure points. Emit CloudWatch metrics via `@repo/logger`. Enables proactive monitoring. Minimal overhead. Deferred to STORY-01712 per session analytics AC-21. | Add as AC | Can be added for production readiness. |
| enh7_validation_middleware | Request validation middleware - Story validates request bodies inline in each handler. Extract Zod validation into reusable middleware: `validateRequest(schema)` returns 422 with Zod errors on failure. Reduces boilerplate across all 3 endpoints. | Add as AC | Will improve code maintainability. |
| enh8_file_size_validation | File size validation at completion - Story validates file size at session creation but not at completion. Client could upload file larger than declared. At complete, verify uploaded part sizes sum to expected file size ± 5%. Prevents size mismatch attacks. | Add as AC | Important for security and correctness. |

### Follow-up Stories Suggested
- [ ] STORY-01712: Advanced upload features (idempotency, session analytics, duplicate detection, resume support)
- [ ] STORY-018: S3 orphaned multipart upload cleanup with lifecycle policies
- [ ] STORY-019: WebSocket progress notifications for upload sessions
- [ ] Future: OpenAPI spec generation and client SDK auto-generation

### Items Marked Out-of-Scope
- Binary part upload handling: Deferred to STORY-0172 (separate part uploading logic)
- Session finalization and MOC creation: Deferred to STORY-0172
- Advanced features (WebSocket progress, session analytics, duplicate detection, resume): Deferred to STORY-01712
- S3 lifecycle policies and orphaned upload cleanup: Deferred to STORY-018
- WebSocket notifications infrastructure: Deferred to STORY-019
