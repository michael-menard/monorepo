---
status: uat
---

# wrkf-1010: GraphState Schema

## Context

The LangGraph Orchestrator requires a typed state object that flows through all graph nodes. This state carries context about the current story being processed, references to artifacts, routing decisions, and QA gate outcomes.

This story defines the core `GraphState` schema using Zod, following the repo's Zod-first type policy. The schema must be validated at graph boundaries while allowing efficient internal access.

This story depends on **wrkf-1000** (Package Scaffolding) which establishes the `packages/orchestrator` workspace package.

---

## Goal

Define a fully-typed, Zod-validated `GraphState` schema that all LangGraph nodes can consume and produce, with clear field semantics, enum values, and validation utilities.

---

## Non-Goals

- **NOT** implementing LangGraph nodes (that is wrkf-1020+)
- **NOT** implementing the StateGraph or graph execution
- **NOT** implementing adapters (OpenCode, MCP tools)
- **NOT** implementing subgraph definitions
- **NOT** creating graph execution runtime

---

## Scope

### Endpoints and Surfaces

**None.** This is a pure TypeScript schema definition with no API endpoints.

### Packages/Apps Affected

| Package/App | Change Type |
|-------------|-------------|
| `packages/orchestrator` | MODIFY — Add `src/state/` module |

---

## Acceptance Criteria

- [ ] **AC-1:** `GraphStateSchema` Zod schema is defined with all required fields
- [ ] **AC-2:** Schema includes `schemaVersion` field set to `"1.0.0"` for migration support
- [ ] **AC-3:** `epicPrefix` field validates as non-empty string (e.g., `"wrkf"`)
- [ ] **AC-4:** `storyId` field validates as string matching pattern `^[a-z]+-\d+$` (case-insensitive, e.g., `"wrkf-1010"` or `"WRKF-1010"`)
- [ ] **AC-5:** `artifactPaths` field is a record with typed keys from `ArtifactTypeSchema` enum
- [ ] **AC-6:** `routingFlags` field is a record with typed keys from `RoutingFlagSchema` enum
- [ ] **AC-7:** `evidenceRefs` field is an array of `EvidenceRefSchema` objects
- [ ] **AC-8:** `gateDecisions` field is a record with typed keys from `GateTypeSchema` and values from `GateDecisionSchema`
- [ ] **AC-9:** `errors` field is an array of `NodeErrorSchema` objects with sensible defaults
- [ ] **AC-10:** All schemas export inferred TypeScript types via `z.infer<>`
- [ ] **AC-11:** `validateGraphState()` utility validates complete state and returns typed result or throws
- [ ] **AC-12:** `createInitialState()` utility creates a valid initial state with defaults
- [ ] **AC-13:** All schemas (`GraphStateSchema`, `ArtifactTypeSchema`, `RoutingFlagSchema`, `GateTypeSchema`, `GateDecisionSchema`, `EvidenceRefSchema`, `NodeErrorSchema`) and their inferred types are exported from `@repo/orchestrator` package root
- [ ] **AC-14:** Unit tests cover happy path, error cases, and edge cases with 80%+ coverage for `src/state/`
- [ ] **AC-15:** TypeScript compilation passes with strict mode
- [ ] **AC-16:** `EvidenceRefSchema` defines fields: `type` (enum: test, build, http, screenshot, log), `path` (string), `timestamp` (ISO datetime string), `description` (optional string)
- [ ] **AC-17:** `NodeErrorSchema` defines fields: `nodeId` (string), `message` (string), `code` (optional string), `timestamp` (ISO datetime string), `stack` (optional string), `recoverable` (boolean, default false)
- [ ] **AC-18:** GraphState field requirements documented: `epicPrefix` (required), `storyId` (required), `schemaVersion` (required, default `"1.0.0"`), `artifactPaths` (optional, default `{}`), `routingFlags` (optional, default `{}`), `evidenceRefs` (optional, default `[]`), `gateDecisions` (optional, default `{}`), `errors` (optional, default `[]`)
- [ ] **AC-19:** `createInitialState()` accepts required parameters `{ epicPrefix: string, storyId: string }` and returns a complete GraphState with all defaults applied
- [ ] **AC-20:** `diffGraphState(before, after)` utility returns a `StateDiff` object identifying changed, added, and removed state properties
- [ ] **AC-21:** `serializeState(state)` utility returns a JSON string representation of GraphState
- [ ] **AC-22:** `deserializeState(json)` utility parses JSON string and returns validated GraphState, throwing on invalid input
- [ ] **AC-23:** GraphState includes optional `stateHistory` field (array of timestamped state snapshots) for time-travel debugging
- [ ] **AC-24:** `GraphStateSchema` includes Zod refinements for cross-field validation (e.g., routing flag consistency, artifact path format validation)

---

## Reuse Plan

### Existing Packages to Reuse

| Package | Usage |
|---------|-------|
| `zod` | All schema definitions |
| Existing Zod patterns | Follow `packages/backend/*-core/src/__types__/` patterns |

### New Shared Code Created

| Export | Purpose | Consumers |
|--------|---------|-----------|
| `GraphStateSchema` | Main state schema | All graph nodes (wrkf-1020+) |
| `ArtifactTypeSchema` | Enum of artifact types | All subgraphs |
| `RoutingFlagSchema` | Enum of routing decisions | Node runner (wrkf-1020) |
| `GateDecisionSchema` | Enum of QA gate outcomes | QA subgraphs (wrkf-1070, wrkf-1080, wrkf-1100) |
| `EvidenceRefSchema` | Evidence reference structure | Evidence bundle (wrkf-1140) |
| `NodeErrorSchema` | Node error capture structure | Node runner (wrkf-1020) |
| `validateGraphState` | Validation utility | Graph entry points |
| `createInitialState` | State factory | Graph initialization |
| `diffGraphState` | State comparison utility | Debugging, logging |
| `serializeState` | JSON serialization | Persistence, debugging |
| `deserializeState` | JSON deserialization | State restoration |

### Prohibited Patterns

- No `console.log` — use `@repo/logger` if logging needed
- No TypeScript interfaces without Zod schemas
- No barrel files beyond single `index.ts` export

---

## Architecture Notes (Ports & Adapters)

### Package Structure

```
packages/orchestrator/src/
├── index.ts                      # MODIFY — add state exports
└── state/
    ├── index.ts                  # CREATE — state module exports
    ├── graph-state.ts            # CREATE — main GraphState schema
    ├── enums/
    │   ├── index.ts              # CREATE — enum exports
    │   ├── artifact-type.ts      # CREATE — ArtifactType enum
    │   ├── routing-flag.ts       # CREATE — RoutingFlag enum
    │   ├── gate-type.ts          # CREATE — GateType enum
    │   └── gate-decision.ts      # CREATE — GateDecision enum
    ├── refs/
    │   ├── index.ts              # CREATE — ref schema exports
    │   ├── evidence-ref.ts       # CREATE — EvidenceRef schema
    │   └── node-error.ts         # CREATE — NodeError schema
    ├── validators.ts             # CREATE — validation utilities
    ├── utilities.ts              # CREATE — diff, serialize, deserialize utilities
    └── __tests__/
        ├── graph-state.test.ts   # CREATE — schema tests
        ├── validators.test.ts    # CREATE — validator tests
        └── utilities.test.ts     # CREATE — utility tests
```

### Enum Definitions (PM Decision)

#### ArtifactType (artifact path keys)
```typescript
const ArtifactTypeSchema = z.enum([
  'storyDoc',       // Main story document
  'elaboration',    // Story elaboration
  'proof',          // Implementation proof
  'codeReview',     // Code review output
  'qaVerify',       // QA verification output
  'uiuxReview',     // UI/UX review output
  'qaGate',         // QA gate decision
  'evidence',       // Evidence bundle
])
```

#### RoutingFlag (control flow decisions)
```typescript
const RoutingFlagSchema = z.enum([
  'proceed',        // Continue to next node
  'retry',          // Retry current node
  'blocked',        // Blocked by missing dependency
  'escalate',       // Escalate to human
  'skip',           // Skip optional node
  'complete',       // Graph execution complete
])
```

#### GateType (QA gate categories)
```typescript
const GateTypeSchema = z.enum([
  'codeReview',     // Code review gate
  'qaVerify',       // QA verification gate
  'uiuxReview',     // UI/UX review gate
  'qaGate',         // Final QA gate
])
```

#### GateDecision (gate outcomes)
```typescript
const GateDecisionSchema = z.enum([
  'PASS',           // Gate passed
  'CONCERNS',       // Gate passed with concerns
  'FAIL',           // Gate failed
  'WAIVED',         // Gate waived (not applicable)
  'PENDING',        // Gate not yet evaluated
])
```

### State Mutation Pattern (PM Decision)

LangGraph nodes receive and return **complete state objects**. The schema validates full state at graph boundaries. Nodes modify state and return the full updated object.

This pattern aligns with LangGraph's pure function approach: `(state: GraphState) => GraphState`.

Partial update utilities may be added as convenience helpers but are not required for schema validation.

---

## Required Vercel / Infra Notes

**None.** This is a pure TypeScript library package with no deployment requirements.

---

## HTTP Contract Plan

**Not applicable.** This story does not expose or consume any HTTP endpoints.

---

## Seed Requirements

**Not applicable.** No database entities or seed data required.

---

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| ID | Test Description | Expected Outcome | Evidence |
|----|------------------|------------------|----------|
| HP-1 | Create valid GraphState with all fields | Schema parses successfully | Test output |
| HP-2 | Type inference via `z.infer<typeof GraphStateSchema>` | TypeScript compiles | Type-check output |
| HP-3 | Access individual state fields | Fields accessible with correct types | Test assertions |
| HP-4 | Validate epicPrefix as non-empty string | `"wrkf"` parses successfully | Test output |
| HP-5 | Validate storyId pattern matching | `"wrkf-1010"` parses successfully | Test output |
| HP-6 | Validate artifactPaths with typed keys | Record with ArtifactType keys parses | Test output |
| HP-7 | Validate routingFlags with enum keys | Record with RoutingFlag keys parses | Test output |
| HP-8 | Validate evidenceRefs array | Array of EvidenceRef parses | Test output |
| HP-9 | Validate gateDecisions with enum values | PASS/FAIL/CONCERNS/WAIVED/PENDING parse | Test output |
| HP-10 | Import from `@repo/orchestrator` | Import resolves correctly | Import test |
| HP-11 | `validateGraphState()` returns valid state | Utility validates and returns typed state | Test output |
| HP-12 | `createInitialState()` creates valid state | Factory produces parseable state | Test output |

### Error Cases

| ID | Test Description | Expected Error | Evidence |
|----|------------------|----------------|----------|
| EC-1 | Invalid epicPrefix type (number) | ZodError: expected string | Test error output |
| EC-2 | Invalid storyId pattern | ZodError: regex mismatch | Test error output |
| EC-3 | Invalid artifactPaths structure | ZodError: invalid record | Test error output |
| EC-4 | Invalid gateDecision value | ZodError: invalid enum | Test error output |
| EC-5 | Missing required fields | ZodError: required fields | Test error output |
| EC-6 | Wrong type in evidenceRefs | ZodError: invalid array element | Test error output |
| EC-7 | `validateGraphState()` on invalid state | Throws with validation details | Test error output |

### Edge Cases

| ID | Test Description | Expected Behavior | Evidence |
|----|------------------|-------------------|----------|
| EDGE-1 | Empty string epicPrefix | ZodError: non-empty string required | Test output |
| EDGE-2 | Empty artifactPaths object | Parses successfully | Test output |
| EDGE-3 | Empty routingFlags object | Parses successfully | Test output |
| EDGE-4 | Empty evidenceRefs array | Parses successfully | Test output |
| EDGE-5 | Empty gateDecisions object | Parses successfully | Test output |
| EDGE-6 | Empty errors array | Parses successfully (default) | Test output |
| EDGE-7 | Extra unknown fields | Stripped by default | Test output |
| EDGE-8 | Case-insensitive storyId pattern | `"WRKF-1010"` parses (regex is case-insensitive) | Test output |
| EDGE-9 | All gate decisions WAIVED | Parses successfully | Test output |
| EDGE-10 | All gate decisions PENDING | Parses successfully | Test output |

### Evidence Requirements

- [ ] `pnpm test --filter @repo/orchestrator` output with all tests passing
- [ ] `pnpm check-types --filter @repo/orchestrator` with no errors
- [ ] Test coverage report showing 80%+ for `src/state/`
- [ ] Import verification test passing

---

## Demo Script

1. `cd /path/to/monorepo`
2. `pnpm build --filter @repo/orchestrator` — Verify build succeeds
3. `pnpm test --filter @repo/orchestrator` — Verify all schema tests pass
4. `pnpm check-types --filter @repo/orchestrator` — Verify type checking passes
5. Create test file importing `GraphStateSchema` from `@repo/orchestrator`:
   ```typescript
   import { GraphStateSchema, createInitialState, validateGraphState } from '@repo/orchestrator'
   const state = createInitialState({ epicPrefix: 'wrkf', storyId: 'wrkf-1010' })
   const validated = validateGraphState(state)
   ```
6. Verify test file compiles and runs

---

## Constraints

| Constraint | Value |
|------------|-------|
| Zod version | ^3.x (repo standard) |
| TypeScript strict mode | Required |
| Test framework | Vitest |
| Coverage threshold | 80% for `src/state/` |

---

## File Touch List (High-Level)

| Path | Action |
|------|--------|
| `packages/orchestrator/src/index.ts` | MODIFY — export state module |
| `packages/orchestrator/src/state/index.ts` | CREATE |
| `packages/orchestrator/src/state/graph-state.ts` | CREATE |
| `packages/orchestrator/src/state/enums/index.ts` | CREATE |
| `packages/orchestrator/src/state/enums/artifact-type.ts` | CREATE |
| `packages/orchestrator/src/state/enums/routing-flag.ts` | CREATE |
| `packages/orchestrator/src/state/enums/gate-type.ts` | CREATE |
| `packages/orchestrator/src/state/enums/gate-decision.ts` | CREATE |
| `packages/orchestrator/src/state/refs/index.ts` | CREATE |
| `packages/orchestrator/src/state/refs/evidence-ref.ts` | CREATE |
| `packages/orchestrator/src/state/refs/node-error.ts` | CREATE |
| `packages/orchestrator/src/state/validators.ts` | CREATE |
| `packages/orchestrator/src/state/utilities.ts` | CREATE |
| `packages/orchestrator/src/state/__tests__/graph-state.test.ts` | CREATE |
| `packages/orchestrator/src/state/__tests__/validators.test.ts` | CREATE |
| `packages/orchestrator/src/state/__tests__/utilities.test.ts` | CREATE |

---

## Token Budget

| Phase | Agent | Est. Tokens | Actual Tokens |
|-------|-------|-------------|---------------|
| Generation | PM | ~5,000 | — |
| Elaboration | QA | ~3,000 | ~10,425 |
| Implementation | Dev | ~8,000 | ~80,052 |
| Verification | QA | ~2,000 | (included above) |

**Implementation Breakdown:**
- Planner: ~17,728 tokens
- Plan Validator: ~9,200 tokens
- Backend Coder: ~17,306 tokens
- Verifier: ~10,896 tokens
- Proof Writer: ~15,422 tokens
- Learnings: ~9,500 tokens
- **Total Implementation:** ~80,052 tokens

**Notes:** Higher than estimated due to 24 ACs requiring 86 tests across 15 files. No fix phases needed.

---

## PM Decisions Log

The following decisions were made during story generation to remove blockers:

| # | Decision | Rationale |
|---|----------|-----------|
| 1 | Use pure Zod schemas (no LangGraph Annotation wrapper) | LangGraph TS supports generic typed state. Annotation API is optional. |
| 2 | Define RoutingFlag enum: proceed, retry, blocked, escalate, skip, complete | Covers expected control flow decisions |
| 3 | Define GateDecision enum: PASS, CONCERNS, FAIL, WAIVED, PENDING | Matches QA gate workflow outcomes |
| 4 | Define ArtifactType enum: storyDoc, elaboration, proof, codeReview, qaVerify, uiuxReview, qaGate, evidence | Covers all workflow artifact types |
| 5 | Nodes receive/return full state objects | Aligns with LangGraph pure function pattern |
| 6 | Add `errors` field for node-level error capture | Enables debugging without crashing graph |
| 7 | Include `schemaVersion` field | Enables future schema migrations |

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-23_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | EvidenceRef schema structure undefined | Added as AC-16 | Fields: type, path, timestamp, description |
| 2 | NodeError schema structure undefined | Added as AC-17 | Fields: nodeId, message, code, timestamp, stack, recoverable |
| 3 | Optional vs Required fields unclear | Added as AC-18 | Documented which fields have defaults |
| 4 | createInitialState() signature undefined | Added as AC-19 | Requires epicPrefix and storyId |
| 5 | Regex case sensitivity mismatch | Updated AC-4 | Clarified case-insensitive matching |
| 6 | Schema export strategy unclear | Updated AC-13 | Listed all exported schemas explicitly |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | State diff utility | Added as AC-20 | diffGraphState(before, after) |
| 2 | State snapshot/restore | Added as AC-21, AC-22 | serializeState, deserializeState |
| 3 | State history tracking | Added as AC-23 | Optional stateHistory field |
| 4 | Cross-field validation | Added as AC-24 | Zod refinements |

### Follow-up Stories Suggested

- None — all enhancements incorporated into this story

### Items Marked Out-of-Scope

- None

---

*Generated by PM Agent | 2026-01-23*
