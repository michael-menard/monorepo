---
status: uat
---

# wrkf-1020: Node Runner Infrastructure

## Context

The LangGraph Orchestrator requires base infrastructure for executing graph nodes consistently across all subgraphs. This includes a factory pattern for creating nodes, error handling with retry logic, structured logging, and state mutation helpers.

This story depends on **wrkf-1010: GraphState Schema** which defines the typed state object flowing through all nodes (`GraphStateSchema`, `NodeErrorSchema`, `RoutingFlagSchema`).

The node runner infrastructure will be consumed by all subsequent subgraph stories (wrkf-1030 through wrkf-1100) and adapter stories (wrkf-1110 through wrkf-1130).

---

## Goal

Provide reusable infrastructure for all LangGraph nodes — a factory pattern, error capture, retry logic, logging integration, and state mutation helpers — that enables consistent, observable, and resilient node execution.

---

## Non-Goals

- **NOT** implementing specific graph nodes (PM, QA, Dev agents)
- **NOT** implementing subgraph definitions (bootstrap_graph, pm_generate_graph, etc.)
- **NOT** implementing the StateGraph or graph execution runtime
- **NOT** implementing adapters (OpenCode, MCP tools)
- **NOT** implementing LLM-specific node types (that is adapter work)
- **NOT** defining new state fields (that is wrkf-1010's scope)

---

## Scope

### Endpoints and Surfaces

**None.** This is a pure TypeScript library package with no API endpoints.

### Packages/Apps Affected

| Package/App | Change Type |
|-------------|-------------|
| `packages/backend/orchestrator` | MODIFY — Add `src/runner/` module |
| `packages/backend/orchestrator/package.json` | MODIFY — Add `@repo/logger` dependency |

---

## Acceptance Criteria

- [ ] **AC-1:** `createNode()` factory function accepts a node config and implementation function, returns a LangGraph-compatible node with error handling, logging, and retry wrappers
- [ ] **AC-2:** Node factory signature matches LangGraph pattern: `(state: GraphState, config?: RunnableConfig) => Promise<Partial<GraphState>>` returning partial state updates
- [ ] **AC-3:** All node executions log entry/exit with `@repo/logger`, including node name, story ID, and execution duration in milliseconds
- [ ] **AC-4:** Error handler captures exceptions and populates `NodeErrorSchema` in state's `errors` array without crashing graph execution
- [ ] **AC-5:** Retry logic supports configurable strategies with `maxAttempts` and `backoffMs` per-node configuration
- [ ] **AC-6:** Retry logic respects exhaustion — after all attempts fail, node returns error in state with `routingFlags` indicating `blocked`
- [ ] **AC-7:** State mutation helpers (`updateState()`) produce partial state updates compatible with LangGraph reducer merging
- [ ] **AC-8:** State mutation helpers support all state field types: `artifactPaths`, `routingFlags`, `evidenceRefs`, `gateDecisions`, `errors`
- [ ] **AC-9:** Node factory supports both sync and async node implementations
- [ ] **AC-10:** All exports importable from `@repo/orchestrator`:
  ```typescript
  import {
    createNode,
    withNodeRetry,
    updateState,
    createNodeLogger,
    isRetryableNodeError,
    NodeConfig,
    NodeRetryConfig,
    NodeTimeoutError,
  } from '@repo/orchestrator'
  ```
- [ ] **AC-11:** Unit tests cover happy path, error capture, retry exhaustion, and logging behavior with **80%+ coverage for `src/runner/`**
- [ ] **AC-12:** TypeScript compilation passes with strict mode; node factory provides full type inference for state input/output
- [ ] **AC-13:** `@repo/logger` added to orchestrator package.json dependencies
- [ ] **AC-14:** No `console.log` statements — all logging uses `@repo/logger`
- [ ] **AC-15:** Node factory supports optional `timeoutMs` configuration. When specified, node execution is wrapped with a timeout that rejects with a `NodeTimeoutError` if exceeded. Timeout errors are captured in `state.errors` and treated as retryable by default.
- [ ] **AC-16:** `isRetryableNodeError(error): boolean` utility function classifies errors as retryable or not. Validation errors (`ZodError`) are NOT retryable. Transient errors (timeouts, network failures) ARE retryable. Retry logic consults this utility before attempting retry.

---

## Reuse Plan

### Existing Packages to Reuse

| Package | Usage |
|---------|-------|
| `@repo/logger` | Structured logging via `createLogger()` pattern |
| `zod` | Type definitions and validation |
| `@langchain/langgraph` | Node execution context (RunnableConfig) |
| `@repo/api-client` retry patterns | Reference for retry logic (adapt patterns, not import directly) |

### Patterns to Adapt

The retry implementation in `packages/core/api-client/src/retry/retry-logic.ts` provides proven patterns:
- `withRetry()` wrapper function
- `calculateRetryDelay()` with exponential backoff + jitter
- `isRetryableError()` classification

These patterns should be adapted for the orchestrator context, not imported directly (different error types, no circuit breaker needed).

### New Shared Code Created

| Export | Purpose | Consumers |
|--------|---------|-----------|
| `createNode()` | Factory for creating nodes with infrastructure wrappers | All subgraphs (wrkf-1030+) |
| `withNodeRetry()` | Retry wrapper for node execution | Used internally by createNode |
| `updateState()` | Immutable state update helper | All node implementations |
| `createNodeLogger()` | Logger factory for named nodes | All node implementations |
| `isRetryableNodeError()` | Classifies errors as retryable or terminal | Used by retry logic |
| `NodeConfig` | Node factory configuration type | All node definitions |
| `NodeRetryConfig` | Retry configuration type | Node config |
| `NodeTimeoutError` | Custom error class for timeout handling | Node factory, error handlers |

### Prohibited Patterns

- No `console.log` — use `@repo/logger`
- No TypeScript interfaces without Zod schemas (where schemas needed)
- No barrel files beyond single `index.ts` export per module
- No duplicating retry logic — adapt existing patterns

---

## Architecture Notes (Ports & Adapters)

### Package Structure

```
packages/backend/orchestrator/src/
├── index.ts                          # MODIFY — add runner exports
├── state/                            # FROM wrkf-1010
│   └── ...
└── runner/
    ├── index.ts                      # CREATE — runner module exports
    ├── node-factory.ts               # CREATE — createNode() factory
    ├── retry.ts                      # CREATE — withNodeRetry() logic
    ├── error-classification.ts       # CREATE — isRetryableNodeError() utility
    ├── timeout.ts                    # CREATE — timeout wrapper for node execution
    ├── state-helpers.ts              # CREATE — updateState() helper
    ├── logger.ts                     # CREATE — createNodeLogger() factory
    └── __tests__/
        ├── node-factory.test.ts      # CREATE — factory tests
        ├── retry.test.ts             # CREATE — retry logic tests
        ├── error-classification.test.ts # CREATE — error classification tests
        ├── timeout.test.ts           # CREATE — timeout tests
        ├── state-helpers.test.ts     # CREATE — state helper tests
        └── integration.test.ts       # CREATE — integration tests
```

### Node Factory Pattern

LangGraph nodes receive full state but return **partial updates**:

```typescript
type NodeFunction = (
  state: GraphState,
  config?: RunnableConfig
) => Promise<Partial<GraphState>>
```

The `createNode()` factory wraps node implementations with:
1. **Entry logging** — node name, storyId, timestamp
2. **Try/catch error handling** — captures to `NodeErrorSchema`
3. **Retry logic** — configurable attempts with backoff
4. **Exit logging** — duration, success/failure

### Error Handling Strategy

When a node fails:
1. Error is caught (not thrown to graph runtime)
2. Error details captured in `NodeErrorSchema` object
3. Error appended to state's `errors` array
4. `routingFlags` updated to indicate `blocked` if retries exhausted
5. Partial state returned (graph continues, downstream nodes can check errors)

This prevents graph execution from halting on recoverable errors.

### Retry Configuration (PM Decision)

```typescript
interface NodeRetryConfig {
  maxAttempts: number       // Default: 3
  backoffMs: number         // Default: 1000 (1 second)
  backoffMultiplier: number // Default: 2 (exponential)
  maxBackoffMs: number      // Default: 30000 (30 seconds)
  timeoutMs?: number        // Optional: node execution timeout
}
```

Different node types may override defaults:
- LLM nodes: higher maxAttempts (5), longer backoff (2000ms), timeoutMs: 60000
- Tool nodes: lower maxAttempts (2), shorter backoff (500ms), timeoutMs: 10000
- Validation nodes: no retry (1 attempt), timeoutMs: 5000

### Error Classification (PM Decision)

The `isRetryableNodeError()` utility determines whether a failed node should be retried:

| Error Type | Retryable | Rationale |
|------------|-----------|-----------|
| `ZodError` (validation) | NO | Schema violations indicate bad data, not transient failure |
| `NodeTimeoutError` | YES | Timeouts are transient; retry may succeed |
| `TypeError`, `ReferenceError` | NO | Programming errors won't be fixed by retry |
| Network errors | YES | Transient connectivity issues |
| Rate limit errors | YES | Backoff and retry |
| Unknown errors | YES | Default to retry for unexpected failures |

---

## Required Vercel / Infra Notes

**None.** This is a pure TypeScript library package with no deployment requirements.

---

## HTTP Contract Plan

**Not applicable.** This story does not expose or consume any HTTP endpoints.

---

## Seed Requirements

**Not applicable.** No database entities or seed data required.

---

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| ID | Test Description | Expected Outcome | Evidence |
|----|------------------|------------------|----------|
| HP-1 | Create a node using the factory pattern with valid config | Node function is created and callable | Test output |
| HP-2 | Execute a node with valid GraphState input | Node returns partial state update | Test output |
| HP-3 | Node receives correctly typed state (z.infer<GraphStateSchema>) | TypeScript compiles without errors | Type-check output |
| HP-4 | Node returns correctly typed partial state | Return type matches Partial<GraphState> | Type-check output |
| HP-5 | Logger is invoked on node entry with node name and storyId | Logger.info called with expected args | Test mock assertions |
| HP-6 | Logger is invoked on node exit with execution duration | Logger.info called with duration metric | Test mock assertions |
| HP-7 | State mutation helper updates single field immutably | Original state unchanged, partial update returned | Test output |
| HP-8 | State mutation helper updates nested field (artifactPaths) | Nested field updated correctly | Test output |
| HP-9 | State mutation helper updates routingFlags | RoutingFlag enum value set correctly | Test output |
| HP-10 | State mutation helper adds to evidenceRefs array | Evidence ref appended correctly | Test output |
| HP-11 | State mutation helper updates gateDecisions | GateDecision enum value set correctly | Test output |
| HP-12 | State mutation helper adds to errors array | NodeError appended correctly | Test output |
| HP-13 | Import node infrastructure from `@repo/orchestrator` | Import resolves correctly | Import test |
| HP-14 | Factory creates node with custom name for logging | Node name appears in log output | Test mock assertions |
| HP-15 | Retry logic succeeds on first attempt (no retry needed) | Node executes once, returns result | Test output |
| HP-16 | Node with timeoutMs completes before timeout | Node returns result without timeout error | Test output |
| HP-17 | isRetryableNodeError returns true for NodeTimeoutError | Timeout errors classified as retryable | Test output |
| HP-18 | isRetryableNodeError returns false for ZodError | Validation errors classified as non-retryable | Test output |

### Error Cases

| ID | Test Description | Expected Error | Evidence |
|----|------------------|----------------|----------|
| EC-1 | Node handler throws an error | Error captured in state.errors array | Test output |
| EC-2 | Node handler throws after all retry attempts exhausted | Final error captured, routingFlags set to 'blocked' | Test output |
| EC-3 | Node receives invalid GraphState (validation fails) | ZodError thrown with validation details | Test output |
| EC-4 | Factory called with empty node name | Error: node name required | Test output |
| EC-5 | Factory called with invalid retry config (negative retries) | Error: invalid retry configuration | Test output |
| EC-6 | Node handler returns undefined instead of partial state | Error: handler must return state update | Test output |
| EC-7 | Node handler throws non-Error object | Error wrapped and captured in state.errors | Test output |
| EC-8 | Node execution exceeds configured timeoutMs | NodeTimeoutError captured in state.errors, treated as retryable | Test output |
| EC-9 | Node throws ZodError (validation failure) | Error captured, NOT retried (non-retryable classification) | Test output |
| EC-10 | Node throws TypeError (programming error) | Error captured, NOT retried (non-retryable classification) | Test output |

### Edge Cases

| ID | Test Description | Expected Behavior | Evidence |
|----|------------------|-------------------|----------|
| EDGE-1 | Node executes with minimal GraphState (all optional fields empty) | Node executes successfully | Test output |
| EDGE-2 | Retry succeeds on second attempt after first failure | State contains error from first attempt, result from second | Test output |
| EDGE-3 | Retry succeeds on final allowed attempt | State contains all intermediate errors | Test output |
| EDGE-4 | Zero retries configured (fail immediately) | Single execution, immediate capture on failure | Test output |
| EDGE-5 | Large retry count (10+) configured | Respects configured retry count | Test output |
| EDGE-6 | Node execution time is 0ms (very fast) | Duration logged as 0 or sub-millisecond | Test output |
| EDGE-7 | State mutation helper called with same value (no-op) | State unchanged, no error | Test output |
| EDGE-8 | State mutation helper called multiple times in sequence | All mutations applied correctly | Test output |
| EDGE-9 | State.errors array already contains errors | New errors appended, existing preserved | Test output |
| EDGE-10 | Error message contains special characters | Error captured without corruption | Test output |
| EDGE-11 | Node times out on first attempt, succeeds on retry | Timeout error recorded, final result returned | Test output |
| EDGE-12 | Node has no timeoutMs configured (undefined) | Executes without timeout wrapper | Test output |
| EDGE-13 | Node times out exactly at configured timeoutMs | NodeTimeoutError thrown at boundary | Test output |
| EDGE-14 | isRetryableNodeError called with null/undefined | Returns default classification (retryable) | Test output |

### Integration Tests

| ID | Test Description | Expected Behavior | Evidence |
|----|------------------|-------------------|----------|
| INT-1 | Node runner integrates with wrkf-1010 GraphState schema | Uses types from wrkf-1010 | Test output |
| INT-2 | Node runner uses createInitialState() from wrkf-1010 | Initial state created correctly | Test output |
| INT-3 | Node runner works with all RoutingFlag enum values | proceed, retry, blocked, escalate, skip, complete | Test output |
| INT-4 | @repo/logger integration works correctly | Logger methods called with expected format | Test mock assertions |

### Evidence Requirements

- [ ] `pnpm build --filter @repo/orchestrator` completes without errors
- [ ] `pnpm check-types --filter @repo/orchestrator` completes without errors
- [ ] `pnpm test --filter @repo/orchestrator` shows all tests passing
- [ ] Test coverage report showing **80%+ for `src/runner/`**
- [ ] All exports accessible from `@repo/orchestrator`
- [ ] No `console.log` statements in codebase (grep verification)

---

## Demo Script

1. `cd /path/to/monorepo`
2. `pnpm build --filter @repo/orchestrator` — Verify build succeeds
3. `pnpm test --filter @repo/orchestrator` — Verify all tests pass
4. `pnpm check-types --filter @repo/orchestrator` — Verify type checking passes
5. Create test file verifying imports work:
   ```typescript
   import {
     createNode,
     withNodeRetry,
     updateState,
     createNodeLogger,
     isRetryableNodeError,
     NodeTimeoutError,
   } from '@repo/orchestrator'
   import { createInitialState, GraphStateSchema } from '@repo/orchestrator'
   import { z, ZodError } from 'zod'

   type GraphState = z.infer<typeof GraphStateSchema>

   // Test node creation with timeout
   const myNode = createNode(
     { name: 'test-node', retry: { maxAttempts: 2, backoffMs: 500, timeoutMs: 5000 } },
     async (state: GraphState) => {
       return { routingFlags: { ...state.routingFlags, 'test-node': 'proceed' } }
     }
   )

   const state = createInitialState({ epicPrefix: 'wrkf', storyId: 'wrkf-1020' })
   const result = await myNode(state)
   console.log('Node executed:', result)

   // Test error classification
   console.log('Timeout retryable:', isRetryableNodeError(new NodeTimeoutError('test'))) // true
   console.log('ZodError retryable:', isRetryableNodeError(new ZodError([]))) // false
   console.log('TypeError retryable:', isRetryableNodeError(new TypeError('test'))) // false
   ```
6. Verify test file compiles and runs without errors
7. Verify error classification behavior matches expectations

---

## Constraints

| Constraint | Value |
|------------|-------|
| Zod version | ^3.x (repo standard) |
| TypeScript strict mode | Required |
| Test framework | Vitest |
| Coverage threshold | 80% for `src/runner/` |
| LangGraph version | ^0.2.x (from package.json) |

---

## File Touch List (High-Level)

| Path | Action |
|------|--------|
| `packages/backend/orchestrator/package.json` | MODIFY — add @repo/logger dependency |
| `packages/backend/orchestrator/src/index.ts` | MODIFY — export runner module |
| `packages/backend/orchestrator/src/runner/index.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/node-factory.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/retry.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/error-classification.ts` | CREATE — isRetryableNodeError() utility |
| `packages/backend/orchestrator/src/runner/timeout.ts` | CREATE — NodeTimeoutError class and timeout wrapper |
| `packages/backend/orchestrator/src/runner/state-helpers.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/logger.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/__tests__/node-factory.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/__tests__/retry.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/__tests__/error-classification.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/__tests__/timeout.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/__tests__/state-helpers.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/__tests__/integration.test.ts` | CREATE |

---

## Token Budget

| Phase | Agent | Est. Tokens | Actual Tokens |
|-------|-------|-------------|---------------|
| Generation | PM | ~8,000 | — |
| Elaboration | QA | ~4,000 | ~24,222 |
| Implementation | Dev | ~12,000 | — |
| Verification | QA | ~3,000 | — |

**Elaboration Breakdown:**
- Initial Elaboration (2026-01-23): ~20,508 input, ~2,114 output
- Re-Elaboration (2026-01-24): ~20,597 input, ~3,625 output (interactive discovery)

---

## PM Decisions Log

The following decisions were made during story generation to remove blockers:

| # | Decision | Rationale |
|---|----------|-----------|
| 1 | Use pure Zod schemas (not LangGraph Annotation) | LangGraph v0.2.x supports generic typed state; aligns with wrkf-1010 decision |
| 2 | Return partial state updates from nodes | Matches LangGraph's expected node signature |
| 3 | Adapt retry patterns from @repo/api-client | Reuse proven patterns rather than duplicating |
| 4 | Use createLogger() pattern from @repo/logger | Matches codebase convention |
| 5 | Default retry config: 3 attempts, 1000ms backoff, 2x multiplier | Reasonable defaults for general node types |
| 6 | Capture errors in state.errors rather than throwing | Allows graph execution to continue, enables downstream error handling |
| 7 | Set routingFlags to 'blocked' on retry exhaustion | Signals to graph that node path is blocked |
| 8 | Add optional `timeoutMs` config to node factory | Prevents long-running nodes from blocking graph execution (QA finding) |
| 9 | Create `isRetryableNodeError()` utility | Enables intelligent retry decisions based on error type (QA finding) |
| 10 | ZodError and TypeError are NOT retryable | Validation/programming errors won't be fixed by retry |
| 11 | NodeTimeoutError IS retryable | Timeouts are transient; subsequent attempts may succeed |

---

*Generated by PM Agent | 2026-01-23*
*Revised by PM Agent | 2026-01-24 — Addressed CONDITIONAL PASS findings from ELAB-WRKF-1020.md*

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-23_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | wrkf-1010 dependency has status in-progress | Soft gate acknowledged | Implementation exists, formal verification pending |
| 2 | RunnableConfig import path not specified | Clarification added | Import from @langchain/core |
| 3 | @repo/logger workspace import | Clarification added | Workspace package, no package.json change needed |
| 4 | Partial state validation behavior | Clarification added | Partial updates bypass refinements |
| 5 | Test file naming consistency | Clarification added | state-helpers.test.ts is correct |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Node execution metrics/telemetry | Follow-up story | Similar to RetryMetrics pattern |
| 2 | Timeout handling for node execution | ✅ ADDRESSED | Added as AC-15, tests HP-16 through HP-18, EC-8, EDGE-11 through EDGE-13 |
| 3 | Node middleware/hooks pattern | Follow-up story | beforeNode, afterNode, onError hooks |
| 4 | Retryable error classification | ✅ ADDRESSED | Added as AC-16, tests EC-9, EC-10, EDGE-14 |

### Acceptance Criteria Added (from QA Elaboration)

**AC-15:** Node factory supports optional `timeoutMs` configuration. When specified, node execution is wrapped with a timeout that rejects with a `NodeTimeoutError` if exceeded. Timeout errors are captured in state.errors and treated as retryable by default.

**AC-16:** `isRetryableNodeError(error): boolean` utility function classifies errors as retryable or not. Validation errors (ZodError) are NOT retryable. Transient errors (timeouts, network failures) ARE retryable. Retry logic consults this utility before attempting retry.

### Follow-up Stories Suggested

- [x] **wrkf-1021: Node Execution Metrics** - Add structured metrics capture (execution counts, success/failure rates, duration percentiles) similar to @repo/api-client RetryMetrics → **GENERATED**
- [x] **wrkf-1022: Node Middleware Hooks** - Add extensible middleware pattern with beforeNode, afterNode, onError hooks for custom behavior injection → **GENERATED**

### Items Marked Out-of-Scope

- None

---

## Index Update Required

> ~~**NOTE:** `plans/stories/wrkf.stories.index.md` is now outdated and needs the following stories added:~~
>
> | Story ID | Title | Depends On | Status |
> |----------|-------|------------|--------|
> | wrkf-1021 | Node Execution Metrics | wrkf-1020 | backlog |
> | wrkf-1022 | Node Middleware Hooks | wrkf-1020 | backlog |
>
> ✅ **RESOLVED:** Stories generated and index updated on 2026-01-24 via `/pm-generate-followup-story wrkf-1020`

---

## QA Discovery Notes (Re-Elaboration 2026-01-24)

_Added by QA Re-Elaboration on 2026-01-24_

### Previous Conditions Resolved

| Condition | Status | Notes |
|-----------|--------|-------|
| Add AC-15 and AC-16 | ✅ RESOLVED | Timeout and error classification added to story |
| wrkf-1010 dependency status | ✅ RESOLVED | Upgraded from `in-progress` to `uat` |

### New Gaps Identified (Interactive Discovery)

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | wrkf-1010 dependency now at `uat` status | Acknowledged | Soft gate fully resolved |
| 2 | No cancellation/abort handling | Add as AC-17 | AbortSignal support via RunnableConfig.signal |
| 3 | No jitter in retry backoff | Add as AC-18 | Prevents thundering herd |
| 4 | No timeout cleanup mechanism | Add as AC-19 | onTimeout callback for resource cleanup |
| 5 | Stack trace not sanitized | Add as AC-20 | Truncation and node_modules filtering |

### Enhancement Opportunities Identified (Interactive Discovery)

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Circuit breaker pattern | Add as AC-21 | Fail-fast for persistent failures |
| 2 | Node execution context | Add as AC-22 | Observability metadata (traceId, etc.) |
| 3 | Retry event callbacks | Add as AC-23 | onRetryAttempt hook |
| 4 | Error message templates | Add as AC-24 | Consistent error codes |

### New Acceptance Criteria (for PM to Add)

**AC-17: Cancellation/Abort Handling**
Node factory supports `AbortSignal` via `RunnableConfig.signal` for graceful cancellation. When signal is aborted, node stops execution, captures `NodeCancellationError` in state.errors, and sets appropriate routing flag.

**AC-18: Retry Jitter**
Retry delay calculation includes configurable jitter (default: 0-25% random variance) to prevent thundering herd problems, following the pattern from `@repo/api-client`.

**AC-19: Timeout Cleanup Callback**
Node factory supports optional `onTimeout` cleanup callback in `NodeConfig` for resource cleanup when timeout occurs. Callback receives node name and partial execution context.

**AC-20: Stack Trace Sanitization**
Error capture includes configurable stack trace handling: `maxStackLength` (default 2000 chars), `filterNodeModules` (default true), converting absolute paths to relative.

**AC-21: Circuit Breaker**
Node factory supports optional circuit breaker configuration with `failureThreshold` (default 5), `recoveryTimeoutMs` (default 60000). When threshold exceeded, node short-circuits to `blocked` state without execution.

**AC-22: Node Execution Context**
Node factory injects `NodeExecutionContext` containing `traceId`, `graphExecutionId`, `retryAttempt` (current/max), and `parentNodeId` (if applicable) for observability.

**AC-23: Retry Event Callback**
`NodeRetryConfig` supports optional `onRetryAttempt(attempt: number, error: Error, delayMs: number)` callback fired before each retry attempt.

**AC-24: Error Message Templates**
Define error code constants (`NODE_TIMEOUT`, `RETRY_EXHAUSTED`, `VALIDATION_FAILED`, `CANCELLED`, `CIRCUIT_OPEN`) and message templates for infrastructure-level errors with consistent formatting.

### Sizing Note

Story now has 24 ACs total (16 original + 8 new). User explicitly approved adding all discoveries as ACs. All functionality remains cohesive (node runner infrastructure). No split recommended, but if implementation proves too large, consider splitting AC-21 (circuit breaker) and AC-22 (execution context) into wrkf-1023.

### Items Marked Out-of-Scope

- None

---

*Story status updated to `ready-to-work` by QA Re-Elaboration on 2026-01-24*
