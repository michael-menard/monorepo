---
status: superseded
follow_up_from: wrkf-1020
superseded_by: [wrkf-1022-A, wrkf-1022-B]
---

# wrkf-1022: Node Middleware Hooks

## Follow-up Context

This story is a follow-up from wrkf-1020 identified during QA Elaboration.

- **Parent Story:** wrkf-1020 (Node Runner Infrastructure)
- **Source:** QA Discovery Notes
- **Original Finding:** Node middleware/hooks pattern — Add extensible middleware pattern with beforeNode, afterNode, onError hooks for custom behavior injection
- **Category:** Enhancement Opportunity
- **Impact:** Medium
- **Effort:** Medium

---

## Context

The Node Runner Infrastructure (wrkf-1020) provides a solid foundation for node execution with logging, error handling, and retry logic. However, teams may need to inject custom behavior at various points in the node lifecycle:

- **beforeNode**: Inject context, validate preconditions, set up resources
- **afterNode**: Clean up resources, transform outputs, trigger side effects
- **onError**: Custom error handling, alerting, recovery logic

A middleware/hooks pattern enables this extensibility without modifying the core node factory implementation.

---

## Goal

Add an extensible middleware pattern to the Node Runner Infrastructure with `beforeNode`, `afterNode`, and `onError` hooks that allow custom behavior injection at node execution lifecycle points.

---

## Non-Goals

- **NOT** re-implementing the node factory or retry logic (that is wrkf-1020's scope)
- **NOT** implementing specific middleware implementations beyond built-in examples (auth, caching, etc.)
- **NOT** implementing async middleware chains (hooks CAN be async functions returning Promises, but are NOT chained via next() callbacks like Express/Koa)
- **NOT** implementing middleware ordering/priority systems beyond array position

---

## Scope

### Endpoints and Surfaces

**None.** This is a pure TypeScript library extension with no API endpoints.

### Packages/Apps Affected

| Package/App | Change Type |
|-------------|-------------|
| `packages/backend/orchestrator` | MODIFY — Add `src/runner/middleware/` module |
| `packages/backend/orchestrator` | MODIFY — Integrate middleware support into node factory |

---

## Acceptance Criteria

### Core Middleware Infrastructure

- [ ] **AC-1:** `NodeMiddleware` Zod schema/type defines the middleware interface with optional `beforeNode`, `afterNode`, `onError`, and `shouldRun` hooks
- [ ] **AC-2:** `beforeNode(state, config, nodeName, ctx): Promise<GraphState | void>` hook is called before node execution; can modify state or abort
- [ ] **AC-3:** `afterNode(state, result, config, nodeName, ctx): Promise<Partial<GraphState> | void>` hook is called after successful execution; can modify result
- [ ] **AC-4:** `onError(error, state, config, nodeName, ctx): Promise<NodeError | void>` hook is called on node failure; can transform or suppress error
- [ ] **AC-5:** Node factory (`createNode()`) accepts optional `middleware` array in config
- [ ] **AC-6:** Multiple middleware are executed in order: beforeNode (first→last), afterNode (last→first), onError (first→last)
- [ ] **AC-7:** Middleware is optional — nodes work without middleware configured

### Hook Behavior

- [ ] **AC-8:** If `beforeNode` returns a state object, that state is passed to the node (allows state transformation)
- [ ] **AC-9:** If `beforeNode` throws, node execution is skipped and error is captured
- [ ] **AC-10:** If `afterNode` returns a partial state, it is merged with the node's result
- [ ] **AC-11:** If `onError` returns void/undefined, the original error is used; if it returns a NodeError, that replaces the original

### Exports

- [ ] **AC-12:** All exports importable from `@repo/orchestrator`:
  ```typescript
  import {
    NodeMiddleware,
    NodeMiddlewareSchema,
    MiddlewareContext,
    createNodeMiddleware,
    composeMiddleware,
    loggingMiddleware,
    validationMiddleware,
    MiddlewareValidationError,
  } from '@repo/orchestrator'
  ```

### Testing

- [ ] **AC-13:** Unit tests cover all hook types, ordering, and error scenarios with **80%+ coverage**
- [ ] **AC-14:** Integration test verifies middleware executes during actual node execution

### Context Sharing (QA Finding G2)

- [ ] **AC-15:** Hooks receive a mutable `ctx: MiddlewareContext` object (typed as `Record<string, unknown>`) that persists across beforeNode→afterNode→onError for a single node execution, enabling data sharing between hooks

### Conditional Execution (QA Finding G3/E3)

- [ ] **AC-16:** Middleware can define optional `shouldRun(state: GraphState, nodeName: string): boolean` predicate; if present and returns `false`, middleware is skipped for that node

### Type Safety (QA Finding G4)

- [ ] **AC-17:** Node config parameter uses `NodeConfigSchema` base schema (from wrkf-1020) instead of `z.any()` for type safety; generic type parameter allows extension

### Validation (QA Finding G5)

- [ ] **AC-18:** `composeMiddleware()` validates all middleware against `NodeMiddlewareSchema` and throws `MiddlewareValidationError` with descriptive message if invalid

### Observability (QA Finding G6)

- [ ] **AC-19:** Middleware execution logs at debug level via `@repo/logger` including middleware name (or "anonymous") and node name

### State Protection (QA Finding G7)

- [ ] **AC-20:** State passed to hooks is deep-cloned before invocation to prevent accidental mutation; original state is preserved

### Built-in Middleware (QA Finding E4)

- [ ] **AC-21:** Package exports `loggingMiddleware` and `validationMiddleware` as built-in examples with full test coverage:
  - `loggingMiddleware`: Logs node entry/exit with timing at info level
  - `validationMiddleware`: Validates state against GraphStateSchema, throws on invalid

---

## Reuse Plan

### Existing Packages to Reuse

| Package | Usage |
|---------|-------|
| `zod` | Schema definitions |
| `@repo/logger` | Middleware logging |
| `@repo/orchestrator` (wrkf-1020) | NodeConfigSchema, GraphStateSchema, NodeErrorSchema |

### Patterns to Adapt

Express.js/Koa middleware patterns provide inspiration:
- Ordered execution
- Ability to short-circuit
- Error handling hooks

Adapt for LangGraph node context (state-based, not request/response).

### New Shared Code Created

| Export | Purpose | Consumers |
|--------|---------|-----------|
| `NodeMiddleware` | Type for middleware definition | All middleware implementations |
| `NodeMiddlewareSchema` | Zod schema for middleware validation | composeMiddleware, registration |
| `MiddlewareContext` | Type for ctx object | Hook implementations |
| `createNodeMiddleware()` | Helper to create typed middleware | Middleware authors |
| `composeMiddleware()` | Combines multiple middleware into one | Node configuration |
| `loggingMiddleware` | Built-in timing/logging middleware | Common use case |
| `validationMiddleware` | Built-in state validation middleware | Common use case |
| `MiddlewareValidationError` | Error class for invalid middleware | Error handling |

---

## Architecture Notes (Ports & Adapters)

### Package Structure Addition

```
packages/backend/orchestrator/src/runner/
├── middleware/
│   ├── index.ts                      # CREATE — middleware module exports
│   ├── types.ts                      # CREATE — NodeMiddleware schema and types
│   ├── compose.ts                    # CREATE — composeMiddleware() helper
│   ├── executor.ts                   # CREATE — middleware execution logic
│   ├── built-in/
│   │   ├── index.ts                  # CREATE — built-in middleware exports
│   │   ├── logging.ts                # CREATE — loggingMiddleware
│   │   └── validation.ts             # CREATE — validationMiddleware
│   └── __tests__/
│       ├── types.test.ts             # CREATE — schema tests
│       ├── compose.test.ts           # CREATE — compose tests
│       ├── executor.test.ts          # CREATE — execution tests
│       ├── logging.test.ts           # CREATE — logging middleware tests
│       └── validation.test.ts        # CREATE — validation middleware tests
```

### Middleware Interface

```typescript
import { z } from 'zod'
import { GraphStateSchema, NodeConfigSchema, NodeErrorSchema } from '../state'

// Context object shared across hooks for single execution
const MiddlewareContextSchema = z.record(z.string(), z.unknown())
type MiddlewareContext = z.infer<typeof MiddlewareContextSchema>

const NodeMiddlewareSchema = z.object({
  name: z.string().optional(),
  shouldRun: z.function()
    .args(GraphStateSchema, z.string())
    .returns(z.boolean())
    .optional(),
  beforeNode: z.function()
    .args(GraphStateSchema, NodeConfigSchema, z.string(), MiddlewareContextSchema)
    .returns(z.promise(GraphStateSchema.optional()))
    .optional(),
  afterNode: z.function()
    .args(GraphStateSchema, GraphStateSchema.partial(), NodeConfigSchema, z.string(), MiddlewareContextSchema)
    .returns(z.promise(GraphStateSchema.partial().optional()))
    .optional(),
  onError: z.function()
    .args(z.unknown(), GraphStateSchema, NodeConfigSchema, z.string(), MiddlewareContextSchema)
    .returns(z.promise(NodeErrorSchema.optional()))
    .optional(),
})

type NodeMiddleware = z.infer<typeof NodeMiddlewareSchema>
```

### Integration Point

The `createNode()` factory accepts an optional `middleware` array:

```typescript
const node = createNode({
  name: 'my-node',
  middleware: [loggingMiddleware, validationMiddleware],
}, async (state) => { ... })
```

### State Cloning Strategy

To prevent accidental mutation (AC-20):
```typescript
// Deep clone using structuredClone (Node 17+)
const clonedState = structuredClone(state)
```

---

## Test Plan

### Happy Path Tests

| ID | Test Description | Expected Outcome |
|----|------------------|------------------|
| HP-1 | Create middleware with beforeNode hook | Middleware created successfully |
| HP-2 | Create middleware with afterNode hook | Middleware created successfully |
| HP-3 | Create middleware with onError hook | Middleware created successfully |
| HP-4 | beforeNode modifies state before execution | Node receives modified state |
| HP-5 | afterNode modifies result after execution | Final result includes afterNode changes |
| HP-6 | onError transforms error | Transformed error captured in state |
| HP-7 | Multiple middleware execute in correct order | beforeNode: first→last, afterNode: last→first |
| HP-8 | Node works with empty middleware array | Executes normally |
| HP-9 | composeMiddleware combines multiple | Single middleware with all hooks |
| HP-10 | ctx object persists across hooks | Data set in beforeNode is readable in afterNode |
| HP-11 | shouldRun returns false | Middleware hooks are not called |
| HP-12 | loggingMiddleware logs entry/exit | Logger called with correct arguments |
| HP-13 | validationMiddleware validates state | Throws on invalid state |

### Error Cases

| ID | Test Description | Expected Error |
|----|------------------|----------------|
| EC-1 | beforeNode throws | Node skipped, error captured |
| EC-2 | afterNode throws | Error captured, node result preserved |
| EC-3 | onError throws | Original error preserved, middleware error logged |
| EC-4 | composeMiddleware with invalid input | Throws MiddlewareValidationError |

### Edge Cases

| ID | Test Description | Expected Behavior |
|----|------------------|-------------------|
| EDGE-1 | Middleware with only beforeNode | Other hooks not called |
| EDGE-2 | beforeNode returns void | Original state used |
| EDGE-3 | afterNode returns void | Node result unchanged |
| EDGE-4 | onError returns void | Original error used |
| EDGE-5 | Middleware array with null/undefined entries | Skipped gracefully |
| EDGE-6 | shouldRun throws | Error logged, middleware skipped, node proceeds |
| EDGE-7 | State mutation attempted in hook | Clone ensures original unchanged |

---

## Risks / Edge Cases

| Risk | Mitigation |
|------|------------|
| Middleware execution overhead | Hooks are optional, minimal overhead when not used |
| Complex debugging with many middleware | AC-19 ensures middleware name logged |
| Infinite loops in middleware | No recursive middleware calls by design |
| State mutation in hooks | AC-20 enforces deep clone before hook invocation |
| Invalid middleware registered | AC-18 validates at compose time |

---

## Open Questions

None — all design decisions resolved via QA elaboration.

---

## File Touch List

| Path | Action |
|------|--------|
| `packages/backend/orchestrator/src/runner/middleware/index.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/types.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/compose.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/executor.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/built-in/index.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/built-in/logging.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/built-in/validation.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/__tests__/types.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/__tests__/compose.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/__tests__/executor.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/__tests__/logging.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/middleware/__tests__/validation.test.ts` | CREATE |
| `packages/backend/orchestrator/src/runner/node-factory.ts` | MODIFY — add middleware support |
| `packages/backend/orchestrator/src/runner/index.ts` | MODIFY — export middleware |
| `packages/backend/orchestrator/src/index.ts` | MODIFY — re-export middleware |

---

## Token Budget

| Phase | Agent | Est. Tokens | Actual Tokens |
|-------|-------|-------------|---------------|
| Generation | PM | ~3,500 | — |
| Elaboration (Cycle 1-2) | QA | ~2,000 | ~16,243 |
| PM Fix | PM | ~2,000 | — |
| Elaboration (Cycle 3) | QA | ~2,000 | ~21,927 (input: 19,552, output: 2,375) |
| Implementation | Dev | ~10,000 | N/A (SPLIT REQUIRED) |
| Verification | QA | ~1,500 | N/A (SPLIT REQUIRED) |

---

## PM Decisions Log

| # | Decision | Rationale |
|---|----------|-----------|
| 1 | Use `structuredClone()` for state cloning | Built-in, performant, handles circular refs |
| 2 | Middleware subdirectory structure | Separates types, compose, executor, built-ins for clarity |
| 3 | `MiddlewareContext` as `Record<string, unknown>` | Flexible typing, consumers cast as needed |
| 4 | `shouldRun` as synchronous predicate | Keep fast path fast; async validation belongs in hooks |
| 5 | Built-in middleware as separate files | Independent testing, tree-shakeable |

---

*Generated by PM Agent | 2026-01-24*
*Follow-up from wrkf-1020 QA Elaboration*
*Revised by PM Agent | 2026-01-24 — Applied all ELAB-WRKF-1022.md required fixes*

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-24_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| G1 | Async vs Sync hooks contradiction — Non-Goals says "synchronous" but signatures return Promise | **RESOLVED** | Clarified Non-Goals wording |
| G2 | No context/metadata passing between hooks for same execution | **RESOLVED** | Added AC-15: ctx object |
| G3 | No middleware bypass mechanism for specific nodes | **RESOLVED** | Added AC-16: shouldRun predicate |
| G4 | Config type safety lost with z.any() | **RESOLVED** | Added AC-17: NodeConfigSchema |
| G5 | Middleware registration errors not handled | **RESOLVED** | Added AC-18: validation on compose |
| G6 | Logging integration mentioned but not enforced | **RESOLVED** | Added AC-19: structured logging |
| G7 | State immutability not enforced, risk of mutation | **RESOLVED** | Added AC-20: deep clone state |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| E1 | Named middleware debug mode | Out-of-scope | Should be handled by logging package |
| E2 | Middleware timing metrics | Out-of-scope | Belongs in wrkf-1021 metrics story |
| E3 | Dynamic shouldRun predicate | **RESOLVED** | Merged with G3 into AC-16 |
| E4 | Built-in common middleware (logging, validation) | **RESOLVED** | Added AC-21 |

### Follow-up Stories Suggested

- [ ] **wrkf-1023: Middleware Metrics Integration** — Integrate middleware timing with wrkf-1021 NodeMetricsCollector (from E2)

### Items Marked Out-of-Scope

- **E1 (Debug mode logging):** User indicated this should be handled by the logging package, not middleware-specific code
- **E2 (Timing metrics):** Belongs in wrkf-1021 Node Execution Metrics story, not this middleware infrastructure story

### PM Fix Applied

All required changes from ELAB-WRKF-1022.md have been applied:

1. **Non-Goals clarified** — Async vs sync wording updated
2. **AC-15 through AC-21 added** — All 7 new acceptance criteria integrated
3. **Test Plan updated** — HP-10 through HP-13, EC-4, EDGE-6, EDGE-7 added
4. **File Touch List updated** — New middleware subdirectory structure with 12 new files
5. **Architecture Notes updated** — Includes ctx, shouldRun, and state cloning details
6. **PM Decisions Log added** — Documents key design choices

---

## QA Discovery Notes - Cycle 3 (for PM Review)

_Added by QA Elaboration on 2026-01-24 (SPLIT REQUIRED verdict)_

### New Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| G1 | No middleware removal/unregistration mechanism | **Add as AC** | filterMiddleware utility |
| G2 | Middleware naming not unique/auto-generated | **Add as AC** | Unique or auto-generated names |
| G3 | shouldRun error handling not explicit in AC | **Add as AC** | Exceptions caught, logged, middleware skipped |
| G4 | Deep clone performance impact not addressed | **Add as AC** | skipClone configuration option |
| G5 | shouldRun evaluation timing unclear | **Add as AC** | Receives state after previous middleware |
| G6 | Middleware behavior during retry unspecified | **Add as AC** | Executes on each retry attempt |

### New Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| E1 | Middleware factory with common patterns | **Add as AC** | forNodes, whenFlag factories |
| E2 | Middleware testing utilities | **Add as AC** | createMockMiddleware, assertMiddlewareOrder |
| E3 | Advanced composition operators (pipe, parallel) | **Out-of-scope** | Array composition sufficient for V1 |
| E4 | Async shouldRun predicate | **Add as AC** | Support Promise<boolean> return |

### Split Stories Required

**SPLIT REQUIRED** — Adding 9 new ACs brings total to 30, exceeding the "too large" threshold.

**Proposed Split:**

1. **wrkf-1022-A: Core Middleware Infrastructure** (24 ACs)
   - Original AC-1 through AC-20
   - New: shouldRun error handling, evaluation timing, retry behavior, async shouldRun
   - Dependency: wrkf-1020

2. **wrkf-1022-B: Middleware Extensions & Utilities** (6 ACs)
   - AC-21 (built-in middleware)
   - New: filterMiddleware, naming, skipClone, pattern factories, testing utilities
   - Dependency: wrkf-1022-A

### Items Marked Out-of-Scope

- **E3 (Advanced composition operators):** Array composition is sufficient for V1; pipe/parallel operators are over-engineering for initial release

### Follow-up Stories Updated

- [ ] **wrkf-1022-A: Core Middleware Infrastructure** — Split from wrkf-1022
- [ ] **wrkf-1022-B: Middleware Extensions & Utilities** — Split from wrkf-1022
- [ ] **wrkf-1023: Middleware Metrics Integration** — Integrate middleware timing with wrkf-1021

### Required PM Actions

1. Add wrkf-1022-A and wrkf-1022-B to stories.index.md
2. Generate wrkf-1022-A via `/pm-generate-story wrkf-1022-A`
3. Generate wrkf-1022-B via `/pm-generate-story wrkf-1022-B`
4. Mark original wrkf-1022 as `status: superseded` after splits are created
