---
story_id: wrkf-1054
title: elab_graph Metadata & Linking
status: backlog
created: 2026-01-27
updated: 2026-01-27
epic: wrkf
feature: LangGraph Orchestrator - Elaboration Metadata
depends_on: [wrkf-1051]
split_from: wrkf-1050
split_part: 4 of 4
related_stories:
  - wrkf-1051 # elab_graph MVP (Core Implementation)
---

# wrkf-1054: elab_graph Metadata & Linking

## Split Context

This story is part of a split from wrkf-1050.
- **Original Story:** wrkf-1050 (elab_graph Subgraph)
- **Split Reason:** QA Elaboration identified 26 AC (original 8 + 18 additions), exceeding the 8-10 AC threshold. Split into 4 focused stories.
- **This Part:** 4 of 4 (Metadata & Linking)
- **Dependency:** Depends on wrkf-1051 (elab_graph MVP - Core Implementation)

**Sibling Stories:**
- wrkf-1051: elab_graph MVP (Core Implementation) - PREREQUISITE
- wrkf-1052: elab_graph Observability & Quality
- wrkf-1053: elab_graph Advanced Features

## Context

As the orchestrator ecosystem evolves, tracking template versions and maintaining bidirectional links between stories and elaborations becomes critical for:

1. **Template Versioning** - Track which elaboration template version was used to generate each elaboration, enabling template A/B testing and evolution analysis
2. **Story-Elaboration Linking** - Add bidirectional YAML references between story files and elaboration files for seamless navigation and tooling integration

These metadata enhancements enable:
- **Template Evolution** - PMs can iterate on templates and measure impact on elaboration quality
- **Workflow Integration** - CLI tools can navigate from story → elaboration → implementation artifacts
- **Quality Analysis** - Compare elaborations generated with different template versions to identify improvements

## Goal

Add template versioning and story-elaboration linking metadata to enable template evolution tracking, bidirectional navigation, and workflow integration.

**Success Criteria:**
- Elaborations include `template_version` field in YAML frontmatter
- Stories include `elaboration_path` field in YAML frontmatter
- Elaborations include `story_path` field in YAML frontmatter
- CLI tools can navigate bidirectionally (story ↔ elaboration)

## Non-goals

- Automated template versioning (PM updates version manually in template file)
- Template diffing or change tracking (use Git for template history)
- Elaboration versioning or change tracking (use Git for elaboration history)
- Migration of existing elaborations to include metadata (new elaborations only)
- Breaking changes to existing elaboration or story formats

## Scope

### Packages Affected

**Primary:**
- `packages/backend/orchestrator/src/subgraphs/elab-graph/` (extend existing)
  - `nodes/story-reader.ts` - Add linking metadata to story
  - `nodes/elaboration-writer.ts` - Add template version and story link to elaboration
  - `templates/elaboration-template.md` - Add version field to template frontmatter

**Supporting:**
- `packages/backend/orchestrator/src/utils/metadata-linker.ts` - New utility for bidirectional linking

### Endpoints

**None** - This is backend infrastructure, not HTTP API.

### Data/Storage

**Reads:**
- Story files (to extract path for linking)
- Elaboration template (to extract version)

**Writes:**
- Elaboration files (with `template_version` and `story_path` in frontmatter)
- Story files (update with `elaboration_path` in frontmatter)

## Acceptance Criteria

### AC1: Template Versioning in Elaboration
**Given** the elaboration template file includes a `template_version` field in its frontmatter
**When** the elaboration writer node generates an elaboration
**Then** the generated elaboration includes `template_version` in its YAML frontmatter
**And** the version matches the template file version
**And** the version is logged: "Generated elaboration using template version X.Y.Z"

**Validation:**
- Unit test: template parser extracts version from template file
- Integration test: elaboration frontmatter includes `template_version` field
- Version mismatch test: if template has no version, default to "1.0.0" and log warning

**Template Frontmatter Example:**
```yaml
---
template_version: 1.2.0
template_type: elaboration
---
```

**Elaboration Frontmatter Example:**
```yaml
---
story_id: wrkf-1051
template_version: 1.2.0
generated_at: 2026-01-27T10:30:00Z
---
```

### AC2: Story-Elaboration Linking
**Given** elaboration generation completes successfully
**When** the elaboration file is written
**Then** the elaboration frontmatter includes `story_path` field pointing to the original story file (relative path from repo root)
**And** the story file is updated to include `elaboration_path` field pointing to the elaboration file (relative path from repo root)
**And** both files can be navigated bidirectionally using paths

**Validation:**
- Integration test: elaboration contains `story_path`, story contains `elaboration_path`
- Path correctness test: paths are valid relative to repo root
- File update test: story file is updated atomically (no partial writes)

**Elaboration Frontmatter:**
```yaml
---
story_id: wrkf-1051
story_path: plans/stories/ready-to-work/wrkf-1051/wrkf-1051.md
template_version: 1.2.0
---
```

**Story Frontmatter (Updated):**
```yaml
---
story_id: wrkf-1051
elaboration_path: plans/stories/ready-to-work/wrkf-1051/ELAB-wrkf-1051.md
---
```

## Reuse Plan

### Existing Components to Reuse

**From wrkf-1051 (elab_graph MVP):**
- Story reader node (extend to update story with elaboration link)
- Elaboration writer node (extend to include metadata)

**From monorepo:**
- YAML frontmatter parser (to update story frontmatter)

### New Components to Create

**Metadata Linker Utility:**
- `src/utils/metadata-linker.ts` - Update story file with elaboration path

**Template Version Parser:**
- Extend template loading logic to extract `template_version`

## Architecture Notes

### Metadata Linking Flow

```
START
  ↓
(Story reader, codebase explorer, elaboration writer execute...)
  ↓
Elaboration Writer Node (extended)
  - Load template file
  - Extract template_version from template frontmatter
  - Generate elaboration content
  - Add metadata to elaboration frontmatter:
    * template_version
    * story_path (relative path to story)
  ↓
File Writer (extended)
  - Write elaboration with metadata
  - Update story file frontmatter:
    * Add elaboration_path (relative path to elaboration)
  - Both writes are atomic
  ↓
END
```

### Metadata Schema Extensions

```typescript
// Elaboration frontmatter
elaborationFrontmatter: z.object({
  story_id: z.string(),
  story_path: z.string(), // NEW
  template_version: z.string(), // NEW
  generated_at: z.string(), // ISO 8601
})

// Story frontmatter (updated)
storyFrontmatter: z.object({
  story_id: z.string(),
  elaboration_path: z.string().optional(), // NEW
  // ... other existing fields ...
})
```

## Test Plan

### Happy Path Tests

#### Test 1: Template Version Extraction
**Setup:** Template file with `template_version: 1.2.0` in frontmatter
**Action:** Execute elaboration writer
**Expected:** Elaboration includes `template_version: 1.2.0` in frontmatter
**Evidence:** Elaboration file frontmatter inspection

#### Test 2: Story-Elaboration Linking
**Setup:** Generate elaboration for story wrkf-1051
**Action:** Execute full elab_graph
**Expected:**
- Elaboration contains `story_path: plans/stories/ready-to-work/wrkf-1051/wrkf-1051.md`
- Story contains `elaboration_path: plans/stories/ready-to-work/wrkf-1051/ELAB-wrkf-1051.md`
**Evidence:** Both files contain correct relative paths in frontmatter

### Error Cases

#### Error 1: Template Missing Version
**Setup:** Template file has no `template_version` field
**Action:** Execute elaboration writer
**Expected:** Default version "1.0.0" used, warning logged
**Evidence:** Log shows "Template missing version, defaulting to 1.0.0"

#### Error 2: Story File Update Fails
**Setup:** Story file is read-only (permission denied)
**Action:** Attempt to update story with elaboration path
**Expected:** Error logged, elaboration still written (partial success)
**Evidence:** Error in GraphState, elaboration file exists, story not updated

## UI/UX Notes

**Not applicable** - This is backend infrastructure with CLI interactions only.

---

## Implementation Checklist (For Dev)

Before creating PR:
- [ ] Template version parser tested (extracts version from template)
- [ ] Elaboration frontmatter includes template_version
- [ ] Story-elaboration linking tested (bidirectional paths)
- [ ] Metadata linker utility tested (updates story atomically)
- [ ] Default version handling tested (template missing version)
- [ ] All unit tests pass
- [ ] Integration test confirms bidirectional linking works
