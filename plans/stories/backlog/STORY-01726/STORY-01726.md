---
status: backlog
split_from: STORY-0172
split_part: 2 of 3
---

# STORY-01726: Binary Upload & Finalization - Reliability & Resilience

## Split Context

This story is part of a split from STORY-0172.
- **Original Story:** STORY-0172 (Binary Upload & Finalization)
- **Split Reason:** Story expanded from 3 ACs to 21 ACs (700% growth) during elaboration. Split separates reliability and resilience hardening from core MVP (STORY-01725) and performance enhancements (STORY-01727).
- **This Part:** 2 of 3 (Z=6)
- **Dependency:** Depends on STORY-01725 (Binary Upload & Finalization - Core MVP)

## Title

Binary Upload & Finalization - Reliability & Resilience

## Context

This story builds on STORY-01725 which established working binary part upload and session finalization endpoints. While STORY-01725 delivered happy path functionality, this story addresses 10 critical gaps identified during elaboration to harden the endpoints for production use.

These gaps cover:
- **Error Recovery:** S3 retry strategies, Vercel timeout handling
- **Validation:** partNumber range validation, ETag format documentation
- **UX:** Slug conflict resolution guidance
- **Observability:** Structured logging for upload operations
- **Correctness:** Stale lock recovery testing, database transaction boundaries
- **Security:** CORS preflight handling, rate limiting

All changes maintain full API compatibility with STORY-01725. No new endpoints are added. This story focuses on making existing endpoints production-ready through defensive coding, comprehensive error handling, and operational visibility.

## Goal

Harden binary upload and finalization endpoints for production deployment by implementing robust error handling, enhanced validation, structured logging, transaction boundaries, CORS support, and rate limiting.

## Non-Goals

- Performance optimizations (STORY-01727)
- WebSocket progress tracking (STORY-01727)
- Batch upload endpoints (STORY-01727)
- Thumbnail generation (STORY-01727)
- Session cleanup jobs (STORY-018)
- New UI features (backend API only)

## Scope

### Reliability Enhancements (10 items)

1. **S3 Retry Strategy** (gap_1) - Document S3 SDK retry behavior, handle exhaustion
2. **Vercel Timeout Handling** (gap_2) - Handle 30s function timeout, client coordination
3. **PartNumber Range Validation** (gap_3) - Validate partNumber in [1, 10000]
4. **ETag Format Documentation** (gap_4) - Document multipart vs single-part ETag differences
5. **Slug Conflict UX** (gap_5) - Provide UX guidance for slug conflict resolution
6. **Upload Logging** (gap_6) - Structured logging (partNumber, size, etag)
7. **Stale Lock Recovery Testing** (gap_7) - Test 5-minute lock expiration edge case
8. **CORS Handling** (gap_8) - CORS preflight for browser uploads
9. **DB Transactions** (gap_9) - Database transaction boundary specification
10. **Rate Limiting** (gap_10) - Rate limiting for finalize endpoint

### Packages/Apps Affected

**Modify:**
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/[fileId]/parts/[partNumber].ts` (retry, timeout, validation, logging, CORS)
- `apps/api/platforms/vercel/api/mocs/uploads/finalize.ts` (transactions, rate limiting, logging, slug UX)

**Documentation:**
- Add inline code comments for S3 retry behavior
- Add inline comments for ETag format differences
- Add ADR (Architecture Decision Record) for transaction boundaries

## Acceptance Criteria

### gap_1_s3_retry: S3 Retry Strategy and Exhaustion Handling
- [ ] Document in code comments that S3 SDK has built-in exponential backoff retry (3 attempts default)
- [ ] If S3 retry exhausted, return `503 SERVICE_UNAVAILABLE` with `{ error: "S3_UNAVAILABLE", retryable: true }`
- [ ] Log S3 errors with severity: transient errors (WARN), exhaustion (ERROR)
- [ ] Client documentation: recommend exponential backoff starting at 1s, max 3 retries

### gap_2_vercel_timeout: Vercel 30s Timeout + Client Coordination
- [ ] Document that upload-part handler has 30s maxDuration
- [ ] If binary upload approaching timeout (>25s elapsed), abort and return `408 REQUEST_TIMEOUT`
- [ ] Include `{ elapsedMs, timeoutAt }` in timeout response for client debugging
- [ ] Client documentation: recommend client-side timeout of 25s with retry logic

### gap_3_partnumber_range: Validate partNumber Range [1, 10000]
- [ ] Add validation: `partNumber >= 1 && partNumber <= 10000`
- [ ] Return `400 BAD_REQUEST` with `{ error: "INVALID_PART_NUMBER", validRange: [1, 10000] }` if out of range
- [ ] Document S3 multipart upload limit (10000 parts max)

### gap_4_etag_format: Document ETag Format Differences
- [ ] Add code comment documenting ETag format:
  - Single-part upload: `"<hex-digest>"` (e.g., `"abc123"`)
  - Multipart upload: `"<hex-digest>-<part-count>"` (e.g., `"abc123-5"`)
- [ ] Log warning if ETag doesn't match expected pattern
- [ ] Document that clients should store ETags opaquely (no parsing required)

### gap_5_slug_conflict_ux: Slug Conflict UX Guidance
- [ ] When finalize returns `409 CONFLICT` for duplicate title, include:
  - `suggestedSlug` - auto-generated alternative slug
  - `retryStrategy` - `"AUTO_APPEND"` or `"PROMPT_USER"`
- [ ] Document recommended client flow:
  1. Auto-retry with `title: "{originalTitle} (1)"` OR
  2. Prompt user to modify title
- [ ] Add example to API documentation

### gap_6_upload_logging: Structured Logging Strategy
- [ ] Log upload-part success with:
  - `sessionId`, `fileId`, `partNumber`, `sizeBytes`, `etag`, `durationMs`
- [ ] Log finalize success with:
  - `sessionId`, `mocId`, `fileCount`, `totalSizeBytes`, `durationMs`
- [ ] Use `@repo/logger` with INFO level for success, ERROR for failures
- [ ] Include correlation ID for request tracing

### gap_7_lock_recovery_testing: Stale Lock Recovery Test
- [ ] Add test case: finalize session with `finalizingAt` timestamp > 5 minutes ago
- [ ] Expected behavior: new finalize ignores stale lock, proceeds with finalization
- [ ] Return `201 Created` for first completion after stale lock recovery
- [ ] Log stale lock recovery event with WARNING level

### gap_8_cors_handling: CORS Preflight for Browser Uploads
- [ ] Add OPTIONS handler for upload-part endpoint
- [ ] Return CORS headers:
  - `Access-Control-Allow-Origin: *` (or specific domain)
  - `Access-Control-Allow-Methods: PUT, OPTIONS`
  - `Access-Control-Allow-Headers: Content-Type, Authorization`
  - `Access-Control-Max-Age: 86400`
- [ ] Document that upload-part supports browser direct uploads (if enabled)
- [ ] Add configuration flag `ALLOW_BROWSER_UPLOADS` (default: false)

### gap_9_db_transactions: Database Transaction Boundary Specification
- [ ] Wrap finalize endpoint MOC creation in explicit transaction:
  1. BEGIN TRANSACTION
  2. INSERT moc_instructions
  3. INSERT moc_files (batch)
  4. UPDATE upload_sessions (set finalizedAt)
  5. COMMIT
- [ ] On error, ROLLBACK transaction and return `500 INTERNAL_ERROR`
- [ ] Document transaction isolation level: READ COMMITTED
- [ ] Add retry logic for serialization failures (PostgreSQL error 40001)

### gap_10_rate_limiting: Rate Limiting for Finalize Endpoint
- [ ] Apply rate limit: 10 finalize requests per user per minute
- [ ] Return `429 TOO_MANY_REQUESTS` with:
  - `{ error: "RATE_LIMIT_EXCEEDED", retryAfter: <seconds>, limit: 10, window: "1m" }`
- [ ] Use `@repo/rate-limit` package with Redis backend
- [ ] Exempt admin users from rate limit (check user role)

## Reuse Plan

### Existing Packages to Use

| Package | Purpose |
|---------|---------|
| `@repo/logger` | Structured logging with correlation IDs |
| `@repo/rate-limit` | Rate limiting with Redis backend |
| STORY-01725 handlers | Extend existing upload-part and finalize endpoints |

### Existing Core Code to Reference

| Path | Purpose |
|------|---------|
| STORY-015/016 Vercel handlers | Transaction patterns, CORS handling |
| `apps/api/core/config/upload.ts` | Upload configuration constants |

### New Shared Code

No new shared packages. All changes inline in Vercel handlers.

## Architecture Notes (Ports & Adapters)

### Port Interfaces (Extended)

**Part Upload Service Port:**
- `uploadPart(fileId, partNumber, binary, options: { timeout?: number }) -> { etag } | { error: "TIMEOUT" }`

**Finalize Service Port:**
- `finalizeSession(sessionId, metadata, options: { transaction: true }) -> MOC`

### Adapter Responsibilities

**S3 Adapter - Extended:**
- Handle S3 SDK retry exhaustion
- Timeout detection for long-running uploads

**Database Adapter - Extended:**
- Explicit transaction management (BEGIN/COMMIT/ROLLBACK)
- Serialization failure retry logic

**Rate Limit Adapter:**
- User-based rate limiting
- Redis state management

## Required Vercel / Infra Notes

### Environment Variables Required (New)

- `ALLOW_BROWSER_UPLOADS` - Enable CORS for browser uploads (true/false, default: false)
- `REDIS_URL` - Redis connection string for rate limiting

### No Route Changes

This story does not add new endpoints. All changes extend routes from STORY-01725.

## HTTP Contract Plan

### Required `.http` Requests

All requests are defined in `__http__/story-01726-reliability-resilience.http`:

| Request | Test ID | Description |
|---------|---------|-------------|
| `uploadPartS3Retry` | S3-HP-001 | S3 retry exhaustion scenario |
| `uploadPartTimeout` | TO-HP-001 | Timeout handling (requires slow network simulation) |
| `uploadPartInvalidRange` | VR-HP-001 | partNumber out of range [1, 10000] |
| `finalizeSlugConflict` | SC-HP-001 | Duplicate title with suggestedSlug |
| `finalizeStaleLock` | LR-HP-001 | Stale lock recovery (>5 min) |
| `finalizeRateLimit` | RL-HP-001 | Rate limit exceeded (11th request) |
| `uploadPartCORS` | CO-HP-001 | OPTIONS preflight request |

### Error Case Requests

| Request | Test ID | Expected Status |
|---------|---------|-----------------|
| S3 unavailable | S3-ERR-001 | 503 |
| Upload timeout | TO-ERR-001 | 408 |
| Invalid part number | VR-ERR-001 | 400 |
| Rate limit exceeded | RL-ERR-001 | 429 |

### Required Evidence

Captured in proof document:
- All happy path requests with responses
- Error case examples with proper status codes
- Database transaction rollback verification
- Log output showing structured events
- Redis state showing rate limit buckets

## Seed Requirements

### Test Data for Reliability Testing

```sql
-- Session with stale lock for gap_7 testing
INSERT INTO upload_sessions (id, user_id, status, part_size_bytes, finalizing_at, expires_at, created_at, updated_at)
VALUES (
  'eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee',
  'dev-user-00000000-0000-0000-0000-000000000001',
  'active',
  5242880,
  NOW() - INTERVAL '10 minutes', -- stale lock (>5 min)
  NOW() + INTERVAL '20 minutes',
  NOW() - INTERVAL '40 minutes',
  NOW()
);
```

### Seed Location

Add to `apps/api/core/database/seeds/story-01726.ts` and register in seed index.

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| Feature | Test ID | Description | Expected |
|---------|---------|-------------|----------|
| S3 Retry | S3-HP-001 | S3 SDK retry behavior | Logs transient errors, eventual success |
| Timeout | TO-HP-001 | Upload approaching 30s | Returns 408 with timing info |
| Validation | VR-HP-001 | partNumber = 10001 | Returns 400 with valid range |
| Slug Conflict | SC-HP-001 | Duplicate title | Returns 409 with suggestedSlug |
| Stale Lock | LR-HP-001 | Lock >5 min old | New finalize succeeds |
| Rate Limit | RL-HP-001 | 11th request in 1 min | Returns 429 with retryAfter |
| CORS | CO-HP-001 | OPTIONS request | Returns CORS headers |

### Error Cases

| Category | Test ID | Condition | Status | Code |
|----------|---------|-----------|--------|------|
| S3 | S3-ERR-001 | Retry exhausted | 503 | SERVICE_UNAVAILABLE |
| Timeout | TO-ERR-001 | >30s elapsed | 408 | REQUEST_TIMEOUT |
| Validation | VR-ERR-001 | partNumber < 1 | 400 | BAD_REQUEST |
| Rate Limit | RL-ERR-001 | Limit exceeded | 429 | TOO_MANY_REQUESTS |

### Edge Cases

- **S3 transient failures:** Retry succeeds on attempt 2 or 3
- **Timeout race:** Upload completes just before 30s cutoff
- **Stale lock recovery:** Multiple clients detect stale lock, first wins
- **Rate limit boundary:** 10th request succeeds, 11th fails
- **CORS preflight:** OPTIONS returns 204, PUT follows successfully

### Evidence Requirements

Per-feature proof:
- [ ] Happy path request/response for each gap
- [ ] Error case examples with proper status codes
- [ ] Database transaction verification (rollback on error)
- [ ] Log output showing structured events, correlation IDs
- [ ] Redis dump showing rate limit state

---

## Risks / Edge Cases

### Risks

1. **Rate Limiting Dependency:** Requires Redis. If Redis unavailable, fail open (allow requests) or fail closed (deny all)?
2. **Transaction Rollback Performance:** Explicit transactions may increase DB load. Monitor connection pool usage.
3. **CORS Security:** Allowing `Access-Control-Allow-Origin: *` enables any website to upload. Should require specific domain whitelist.
4. **Timeout Detection Accuracy:** Vercel doesn't expose "time remaining" API. Must track elapsed time manually, introduces drift.

### Edge Cases

- **S3 retry during timeout window:** If S3 retry takes >30s total, timeout wins
- **Stale lock edge at 5:00.001:** Lock expires at exactly 5 minutes, concurrent finalize at 5:00.001
- **Rate limit Redis failure:** If Redis down, should fail open (no limit) or fail closed (deny all)
- **Transaction serialization failure loop:** Infinite retry on high concurrency?

---

## PM Decisions (Blockers Resolved)

### Decision 1: Rate Limit Fail Mode

**Decision:** If Redis unavailable, fail open (allow requests without rate limit).

**Rationale:** Availability over security. Finalize endpoint is authenticated, worst case is user spam (not data corruption). Alert on Redis downtime.

**Alternative:** Fail closed (return 503). More secure but impacts availability.

### Decision 2: CORS Domain Whitelist

**Decision:** Use env var `ALLOWED_UPLOAD_ORIGINS` (comma-separated domains). Default: empty (CORS disabled).

**Rationale:** Security over convenience. Prevents arbitrary websites from uploading. Requires explicit configuration.

### Decision 3: S3 Retry Exhaustion Status

**Decision:** Return `503 SERVICE_UNAVAILABLE` (not `500`).

**Rationale:** Signals to client that retry may succeed (S3 is temporarily down). `500` implies server logic error.

### Decision 4: Transaction Serialization Retry

**Decision:** Retry up to 3 times on PostgreSQL error 40001 (serialization failure), then return `500`.

**Rationale:** Handles high concurrency without infinite loops. Most serialization failures resolve within 2 retries.

---

## Token Budget

| Phase | Agent | Input (est) | Output (est) |
|-------|-------|-------------|--------------|
| PM: Story Split | PM | ~15K | ~8K |
| **PM Total** | â€” | **~15K** | **~8K** |

---

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-25 | PM Split Leader | Split STORY-0172 into STORY-01725, STORY-01726, STORY-01727 | `plans/stories/backlog/STORY-01726/STORY-01726.md` |

---
