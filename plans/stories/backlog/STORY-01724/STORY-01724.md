---
status: backlog
split_from: STORY-01712
split_part: 4 of 4
---

# STORY-01724: Session & File Management - WebSocket Progress

## Split Context

This story is part of a split from STORY-01712.
- **Original Story:** STORY-01712 (Session & File Management - Advanced Features, which itself was split from STORY-0171)
- **Split Reason:** STORY-01712 elaboration identified 16 ACs (8 gap remediations + 8 enhancements) that exceeded safe story sizing boundaries. This split addresses WebSocket progress tracking integration, which has a tight coupling with STORY-019 WebSocket infrastructure.
- **This Part:** 4 of 4 (Z=4)
- **Dependency:** STORY-019 (requires WebSocket server infrastructure) AND STORY-01721 (requires gap remediations)

## Title

Multipart Upload Session Management - WebSocket Progress Tracking

## Context

This story integrates real-time WebSocket progress notifications into the multipart upload session management API. It builds on the WebSocket server infrastructure established in STORY-019 by emitting progress events at key upload lifecycle points:

- Session created
- File registered
- Part uploaded
- File completed
- Session finalized

These events enable frontend clients to display real-time upload progress to users, improving UX by showing live feedback during long upload operations.

The implementation must gracefully handle cases where the WebSocket server is unavailable (e.g., during development or if STORY-019 deployment fails). In such cases, progress hooks should no-op without blocking the upload flow.

This story is independent from upload enhancements (STORY-01722) and analytics (STORY-01723), but requires both STORY-019 (WebSocket infrastructure) and STORY-01721 (gap remediations) to be complete.

## Goal

Add WebSocket progress tracking hooks to the session management API, emitting events at key lifecycle points to enable real-time upload progress display in frontend applications. Ensure graceful degradation when WebSocket server is unavailable.

## Non-Goals

- WebSocket server infrastructure setup (STORY-019 - must be complete first)
- Upload UX enhancements (STORY-01722)
- Analytics tracking (STORY-01723 - though events may overlap)
- Binary part upload handling (STORY-0172)
- Session finalization (STORY-0172)
- Background cleanup jobs (STORY-018)
- WebSocket authentication/authorization (handled by STORY-019)
- WebSocket connection lifecycle management (handled by STORY-019)

## Scope

### WebSocket Progress Tracking (1 item)

1. **WebSocket Progress Hooks** (AC-18) - Emit progress events at key upload lifecycle points with optional WebSocket connection URL in session response

### Packages/Apps Affected

**Modify:**
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/index.ts` (add WebSocket URL in response, emit session_created)
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/index.ts` (emit file_registered)
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/[fileId]/complete.ts` (emit file_completed)

**Create:**
- `apps/api/platforms/vercel/lib/websocket-progress.ts` (WebSocket progress adapter)
- `__http__/story-01724-websocket-progress.http` (test file)

## Acceptance Criteria

### AC-18: WebSocket Progress Hooks
- [ ] Add optional WebSocket connection URL to session creation response: `{ wsUrl?: string }`
- [ ] WebSocket URL format: `wss://[websocket-api-domain]/session/{sessionId}?token={jwt}`
- [ ] WebSocket URL only included if `WEBSOCKET_SERVER_URL` env var is configured (STORY-019 dependency)
- [ ] Emit progress events at key points:
  - **session_created**: After session inserted in DB, before response sent
  - **file_registered**: After file registered, before response sent
  - **part_uploaded**: After part ETag stored (STORY-01722 integration)
  - **file_completed**: After file marked completed, before response sent
  - **session_finalized**: After session finalized (STORY-0172 integration)
- [ ] Event schema: `{ type, sessionId, fileId?, progress?, timestamp, metadata? }`
- [ ] Progress field includes: `{ partsCompleted?, partsTotal?, bytesCompleted?, bytesTotal? }`
- [ ] WebSocket adapter returns no-op if STORY-019 WebSocket server not available (env var not set or server unreachable)
- [ ] Add timeout for WebSocket emit (e.g., 500ms) to prevent blocking upload API on WebSocket failures
- [ ] Log warnings (not errors) when WebSocket emit fails - upload should succeed regardless
- [ ] Document event schema and usage in API comments

## Reuse Plan

### Existing Packages to Use

| Package | Purpose |
|---------|---------|
| `@repo/logger` | Structured logging for WebSocket emit failures |
| Core handlers from STORY-01711 | Base implementation to extend |
| Core handlers from STORY-01721 | Gap remediations |
| WebSocket infrastructure from STORY-019 | WebSocket server API endpoint |

### Existing Core Code to Reference

| Path | Purpose |
|------|---------|
| STORY-01711 handlers | Base implementation |
| STORY-01721 handlers | Extended error handling |
| STORY-019 WebSocket handlers | WebSocket connection management, broadcast API |
| `apps/api/core/config/upload.ts` | Upload configuration |

### New Shared Code

**WebSocket Progress Adapter:**
- `apps/api/platforms/vercel/lib/websocket-progress.ts` - Adapter for emitting progress events via WebSocket API

## Architecture Notes (Ports & Adapters)

### Port Interfaces (Extended)

**WebSocket Progress Service Port (New):**
- `emitProgress(sessionId, event) -> Promise<void>`
- `getWebSocketUrl(sessionId) -> string | null`

### Adapter Responsibilities

**WebSocket Adapter (New):**
- Emit progress events to WebSocket API (HTTP POST to STORY-019 broadcast endpoint)
- Generate WebSocket connection URL with JWT token
- Handle WebSocket server unavailability gracefully (no-op)
- Timeout emit requests after 500ms to prevent blocking

## Required Vercel / Infra Notes

### Environment Variables Required (New)

- `WEBSOCKET_SERVER_URL` - WebSocket server base URL from STORY-019 (e.g., `wss://ws.example.com`)
- `WEBSOCKET_API_URL` - WebSocket broadcast API endpoint (e.g., `https://api.example.com/ws/broadcast`)
- `WEBSOCKET_EMIT_TIMEOUT_MS` - Timeout for WebSocket emit (default: 500)

### No Route Changes

This story does not add new API endpoints. It extends existing session management endpoints with WebSocket integration.

## HTTP Contract Plan

### Required `.http` Requests

All requests are defined in `__http__/story-01724-websocket-progress.http`:

| Request | Test ID | Description |
|---------|---------|-------------|
| `createSessionWithWebSocket` | WS-HP-001 | Create session, receive wsUrl in response |
| `registerFileEmitsProgress` | WS-HP-002 | Register file, verify file_registered event emitted |
| `completeFileEmitsProgress` | WS-HP-003 | Complete file, verify file_completed event emitted |
| `createSessionNoWebSocket` | WS-HP-004 | Create session with WebSocket unavailable (no wsUrl) |

### Error Case Requests

| Request | Test ID | Expected Behavior |
|---------|---------|-------------------|
| WebSocket server down | WS-ERR-001 | Upload succeeds, warning logged |
| WebSocket emit timeout | WS-ERR-002 | Upload succeeds after 500ms timeout |

### Required Evidence

Captured in proof document:
- All happy path requests with responses
- WebSocket URL structure example
- WebSocket event payloads (captured via WebSocket client)
- Log output showing no-op behavior when WebSocket unavailable
- Log output showing timeout handling

## Seed Requirements

### Test Data for WebSocket Progress

```sql
-- Session for WebSocket testing (reuse existing seed data from STORY-01711)
-- No additional seed data required
```

### Seed Location

No new seed data required. Use existing seed data from STORY-01711 and STORY-01721.

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| Feature | Test ID | Description | Expected |
|---------|---------|-------------|----------|
| WebSocket URL | WS-HP-001 | Create session with WebSocket enabled | 201 with wsUrl |
| File Registered Event | WS-HP-002 | Register file | Event emitted to WebSocket |
| File Completed Event | WS-HP-003 | Complete file | Event emitted to WebSocket |
| No WebSocket | WS-HP-004 | Create session without WebSocket | 201, no wsUrl |

### Error Cases

| Category | Test ID | Condition | Behavior |
|----------|---------|-----------|----------|
| WebSocket Down | WS-ERR-001 | WebSocket server unreachable | Upload succeeds, warning logged |
| Emit Timeout | WS-ERR-002 | WebSocket emit exceeds 500ms | Upload succeeds, timeout logged |

### Edge Cases

- **WebSocket unavailable**: No-op gracefully, upload succeeds
- **WebSocket URL generation**: JWT token includes sessionId for authorization
- **Event ordering**: Events emitted in order, but WebSocket delivery is best-effort (no guaranteed ordering)
- **Broadcast failures**: If WebSocket broadcast fails (e.g., no connected clients), upload still succeeds

### Evidence Requirements

Per-feature proof:
- [ ] Happy path request/response with wsUrl
- [ ] WebSocket client captures emitted events
- [ ] Event payload structure examples
- [ ] Log output showing no-op behavior when unavailable
- [ ] Log output showing timeout handling

---

## Risks / Edge Cases

### Risks

1. **WebSocket Dependency:** This story cannot be implemented or tested until STORY-019 is complete. Consider deferring until STORY-019 is deployed.
2. **WebSocket Emit Latency:** Emitting WebSocket events adds latency to upload API responses. Timeout required to prevent blocking.
3. **WebSocket Connection Overhead:** Clients must establish WebSocket connection separately. Document connection setup flow clearly.
4. **Event Delivery Guarantees:** WebSocket events are best-effort. If client disconnects, events are lost. Document that events are advisory, not transactional.
5. **WebSocket Authentication:** JWT token must be generated securely. Ensure token includes sessionId and user context for authorization.

### Edge Cases

- **WebSocket server unavailable during development**: No-op behavior allows local development without STORY-019 deployed
- **Client disconnects mid-upload**: Events still emitted server-side, but client won't receive them
- **Multiple clients**: If multiple clients connect to same session, all receive events (broadcast behavior)
- **Event ordering**: Events emitted in order, but WebSocket delivery is async - client may receive out of order

---

## Token Budget

| Phase | Agent | Input (est) | Output (est) |
|-------|-------|-------------|--------------|
| PM: Story Split | PM Split Leader | ~20K | ~8K |
| **PM Total** | â€” | **~20K** | **~8K** |

---

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-25 | PM Split Leader | Split STORY-01712 into 4 stories (STORY-01721, STORY-01722, STORY-01723, STORY-01724) | `plans/stories/backlog/STORY-01724/STORY-01724.md` |
