---
status: backlog
---

# wrkf-1030: bootstrap_graph Subgraph

## Context

The LangGraph Orchestrator needs a subgraph to handle the `/pm-bootstrap-workflow` command. This command converts raw plans (PRDs, feature descriptions, migration outlines) into the structured story artifacts used by the multi-agent story workflow.

This story depends on **wrkf-1020: Node Runner Infrastructure** which provides `createNode()`, retry logic, error handling, and logging wrappers. It also depends on **wrkf-1010: GraphState Schema** (completed) which provides the typed state objects.

The bootstrap_graph is the **first subgraph** in the orchestrator — it establishes patterns for all subsequent subgraphs (pm_generate_graph, elab_graph, dev_implement_graph, etc.).

---

## Goal

Implement the `bootstrap_graph` subgraph that converts raw plan text into structured story artifacts: `{PREFIX}.stories.index.md`, `{PREFIX}.plan.meta.md`, and `{PREFIX}.plan.exec.md`.

---

## Non-Goals

- **NOT** implementing LLM-assisted plan analysis — this version uses pure parsing (regex/heuristics). LLM enhancement is a follow-up story.
- **NOT** implementing the parent orchestrator graph that invokes this subgraph
- **NOT** implementing other subgraphs (pm_generate_graph, etc.)
- **NOT** implementing OpenCode or MCP adapter integration
- **NOT** implementing real-time plan validation (validation happens post-parse)
- **NOT** modifying existing story artifacts in the codebase

---

## Scope

### Endpoints and Surfaces

**None.** This is a pure TypeScript library package with no API endpoints.

### Packages/Apps Affected

| Package/App | Change Type |
|-------------|-------------|
| `packages/backend/orchestrator` | MODIFY — Add `src/graphs/bootstrap/` module |
| `packages/backend/orchestrator/package.json` | MODIFY — Add `date-fns` and `date-fns-tz` dependencies |

---

## Acceptance Criteria

### Subgraph Definition

- [ ] **AC-1:** `bootstrap_graph` subgraph is defined using LangGraphJS `StateGraph` with Zod-typed state (`BootstrapStateSchema`)
- [ ] **AC-2:** Subgraph accepts required inputs via state: `rawPlan` (string), `projectName` (string), `storyPrefix` (string), `outputDirectory` (string)
- [ ] **AC-3:** Subgraph nodes are wired sequentially: plan-analyzer → story-splitter → index-generator → meta-exec-generator → file-writer → END
- [ ] **AC-4:** `createBootstrapGraph()` factory function returns a compiled graph ready for invocation

### Plan Analyzer Node

- [ ] **AC-5:** Plan analyzer node extracts overall goal from plan text (single sentence under `## Goal` heading or inferred from context)
- [ ] **AC-6:** Plan analyzer node identifies major phases/milestones (sections under `## Phase` or similar headings)
- [ ] **AC-7:** Plan analyzer node extracts individual stories (numbered or bulleted items with story-like structure)
- [ ] **AC-8:** Plan analyzer node detects explicit dependencies between stories (e.g., "depends on", "after", "blocked by")
- [ ] **AC-9:** Plan analyzer node identifies risk areas (sections under `## Risk` or items containing "risk", "complexity", "unknown")
- [ ] **AC-10:** Plan analyzer returns structured `PlanAnalysis` object in state with `goal`, `phases`, `stories`, `dependencies`, `risks` fields

### Story Splitter Node

- [ ] **AC-11:** Story splitter node respects sizing guidelines — no story exceeds 8 acceptance criteria
- [ ] **AC-12:** Story splitter node assigns correct sequential numbering: `{PREFIX}-1000`, `{PREFIX}-1010`, `{PREFIX}-1020`, etc.
- [ ] **AC-13:** Story splitter node maintains dependency relationships after splitting (updates references to new IDs)
- [ ] **AC-14:** Story splitter node validates no circular dependencies exist; captures error in state if found
- [ ] **AC-15:** Story splitter node validates all dependency references exist; captures error for missing dependencies

### Index Generator Node

- [ ] **AC-16:** Index generator node produces `{PREFIX}.stories.index.md` matching template structure from `/pm-bootstrap-workflow` command
- [ ] **AC-17:** Index generator includes Progress Summary table with status counts (completed, generated, in-progress, pending)
- [ ] **AC-18:** Index generator includes Ready to Start section listing stories with no blockers
- [ ] **AC-19:** Index generator includes per-story sections with: Status, Depends On, Feature, Goal, Risk Notes

### Meta/Exec Generator Node

- [ ] **AC-20:** Meta generator node produces `{PREFIX}.plan.meta.md` with valid YAML frontmatter (doc_type, title, status, story_prefix, created_at, updated_at, tags)
- [ ] **AC-21:** Meta generator includes Story Prefix section documenting the prefix and ID patterns
- [ ] **AC-22:** Meta generator includes Principles section with Reuse First and Package Boundary Rules
- [ ] **AC-23:** Exec generator node produces `{PREFIX}.plan.exec.md` with valid YAML frontmatter
- [ ] **AC-24:** Exec generator includes Artifact Naming Convention table mapping artifact types to filename patterns
- [ ] **AC-25:** Exec generator includes Token Budget Rule section

### File Writer Node

- [ ] **AC-26:** File writer node validates all output paths are within `outputDirectory` before writing (path traversal prevention)
- [ ] **AC-27:** File writer node creates parent directories if they don't exist
- [ ] **AC-28:** File writer node updates `artifactPaths` in state with paths to written files: `storiesIndex`, `planMeta`, `planExec`

### Infrastructure Integration

- [ ] **AC-29:** All nodes use `createNode()` factory from wrkf-1020 for logging, error handling, and retry wrappers
- [ ] **AC-30:** All nodes log entry/exit via `@repo/logger` with node name and execution duration
- [ ] **AC-31:** Errors during node execution are captured in `state.errors` array, not thrown
- [ ] **AC-32:** If plan parsing fails, subgraph returns error in state without writing partial files
- [ ] **AC-33:** On successful completion, `routingFlags.complete` is set to true in state

### Exports

- [ ] **AC-34:** All exports accessible from `@repo/orchestrator`:
  ```typescript
  import {
    createBootstrapGraph,
    BootstrapStateSchema,
    type BootstrapState,
    type PlanAnalysis,
    type ParsedStory,
    type ParsedPhase,
  } from '@repo/orchestrator'
  ```

### Testing

- [ ] **AC-35:** Unit tests cover each node with **80%+ coverage for `src/graphs/bootstrap/`**
- [ ] **AC-36:** Integration test verifies full subgraph execution produces valid artifacts
- [ ] **AC-37:** No `console.log` statements — all logging uses `@repo/logger`
- [ ] **AC-38:** TypeScript compilation passes with strict mode

---

## Reuse Plan

### Existing Packages to Reuse

| Package | Usage |
|---------|-------|
| `@repo/orchestrator` (state module) | GraphState types and utilities from wrkf-1010 |
| `@repo/orchestrator` (runner module) | `createNode()`, error handling from wrkf-1020 |
| `@repo/logger` | Structured logging via `createLogger()` |
| `zod` | Schema definitions and validation |
| `@langchain/langgraph` | StateGraph, START, END for subgraph definition |
| `date-fns` / `date-fns-tz` | Timestamp formatting (America/Denver timezone) |

### Patterns to Reference

| Source | Pattern |
|--------|---------|
| `.claude/commands/pm-bootstrap-workflow.md` | Template structure for output files |
| `plans/stories/wrkf.stories.index.md` | Existing index as reference output |
| `plans/wrkf.plan.meta.md` | Existing meta plan as reference output |
| `plans/wrkf.plan.exec.md` | Existing exec plan as reference output |

### New Shared Code Created

| Export | Purpose | Consumers |
|--------|---------|-----------|
| `createBootstrapGraph()` | Factory for bootstrap subgraph | CLI command, tests |
| `BootstrapStateSchema` | Zod schema for subgraph state | Graph definition, nodes |
| `PlanAnalysis` | Parsed plan structure type | Plan analyzer, downstream nodes |
| `ParsedStory` / `ParsedPhase` | Story/phase structure types | Splitter, generators |
| `validateOutputPath()` | Path traversal prevention utility | File writer node |

### Prohibited Patterns

- No `console.log` — use `@repo/logger`
- No TypeScript interfaces without Zod schemas (where schemas needed)
- No barrel files beyond single `index.ts` export per module
- No LLM calls in this story — pure parsing only

---

## Architecture Notes (Ports & Adapters)

### Package Structure

```
packages/backend/orchestrator/src/
├── index.ts                               # MODIFY — add graphs exports
├── state/                                 # FROM wrkf-1010
├── runner/                                # FROM wrkf-1020
└── graphs/
    ├── index.ts                           # CREATE — graphs module export
    └── bootstrap/
        ├── index.ts                       # CREATE — subgraph factory
        ├── state.ts                       # CREATE — BootstrapStateSchema
        ├── nodes/
        │   ├── plan-analyzer.ts           # CREATE — parse raw plan
        │   ├── story-splitter.ts          # CREATE — split and number stories
        │   ├── index-generator.ts         # CREATE — generate index markdown
        │   ├── meta-exec-generator.ts     # CREATE — generate meta/exec markdown
        │   └── file-writer.ts             # CREATE — write files to disk
        ├── utils/
        │   ├── markdown.ts                # CREATE — markdown parsing utilities
        │   ├── templates.ts               # CREATE — file content templates
        │   └── paths.ts                   # CREATE — path validation
        └── __tests__/
            ├── plan-analyzer.test.ts
            ├── story-splitter.test.ts
            ├── index-generator.test.ts
            ├── meta-exec-generator.test.ts
            ├── file-writer.test.ts
            ├── bootstrap-graph.test.ts    # Integration tests
            └── fixtures/
                ├── minimal-plan.txt
                ├── large-plan.txt
                └── complex-dependencies.txt
```

### Subgraph Flow

```
┌─────────────────┐
│  START          │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  plan-analyzer  │ → PlanAnalysis { goal, phases, stories, dependencies, risks }
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  story-splitter │ → ParsedStory[] with IDs, dependencies validated
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ index-generator │ → indexContent: string
└────────┬────────┘
         │
         ▼
┌──────────────────────┐
│ meta-exec-generator  │ → metaContent: string, execContent: string
└────────┬─────────────┘
         │
         ▼
┌─────────────────┐
│  file-writer    │ → artifactPaths: { storiesIndex, planMeta, planExec }
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  END            │
└─────────────────┘
```

### State Schema

```typescript
const BootstrapStateSchema = z.object({
  // Inputs (required)
  rawPlan: z.string().min(1),
  projectName: z.string().min(1),
  storyPrefix: z.string().regex(/^[a-zA-Z][a-zA-Z0-9-]*$/),
  outputDirectory: z.string().min(1),

  // Intermediate (set by nodes)
  planAnalysis: PlanAnalysisSchema.optional(),
  parsedStories: z.array(ParsedStorySchema).optional(),
  indexContent: z.string().optional(),
  metaContent: z.string().optional(),
  execContent: z.string().optional(),

  // Outputs
  artifactPaths: z.object({
    storiesIndex: z.string().optional(),
    planMeta: z.string().optional(),
    planExec: z.string().optional(),
  }).optional(),

  // Error handling (from wrkf-1020 patterns)
  errors: z.array(NodeErrorSchema).default([]),
  routingFlags: z.record(RoutingFlagSchema, z.boolean()).default({}),
})
```

### Node Pure Function Pattern

Nodes are pure functions that return partial state updates:

```typescript
const planAnalyzerNode = createNode(
  { name: 'plan-analyzer', retry: { maxAttempts: 1 } }, // No retry for parsing
  async (state: BootstrapState) => {
    const analysis = parsePlan(state.rawPlan)
    if (!analysis) {
      return {
        errors: [...state.errors, { nodeName: 'plan-analyzer', message: 'Failed to parse plan' }],
        routingFlags: { ...state.routingFlags, blocked: true },
      }
    }
    return { planAnalysis: analysis }
  }
)
```

---

## Required Vercel / Infra Notes

**None.** This is a pure TypeScript library package with no deployment requirements.

---

## HTTP Contract Plan

**Not applicable.** This story does not expose or consume any HTTP endpoints.

---

## Seed Requirements

**Not applicable.** No database entities or seed data required.

---

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| ID | Test Description | Expected Outcome | Evidence |
|----|------------------|------------------|----------|
| HP-1 | Plan analyzer node parses valid PRD with goal, phases, and stories | Returns structured PlanAnalysis in state | Unit test output |
| HP-2 | Plan analyzer extracts overall goal from plan text | `analysis.goal` contains single-sentence goal | Unit test output |
| HP-3 | Plan analyzer identifies major phases/milestones | `analysis.phases` array contains phase objects | Unit test output |
| HP-4 | Plan analyzer extracts individual stories | `analysis.stories` array contains story objects | Unit test output |
| HP-5 | Plan analyzer detects explicit dependencies | `analysis.dependencies` map populated | Unit test output |
| HP-6 | Plan analyzer identifies risk areas | `analysis.risks` array contains risk descriptions | Unit test output |
| HP-7 | Story splitter respects sizing guidelines (max 8 ACs) | No story exceeds 8 acceptance criteria | Unit test output |
| HP-8 | Story splitter assigns correct numbering | Stories: `{PREFIX}-1000`, `{PREFIX}-1010`, etc. | Unit test output |
| HP-9 | Story splitter maintains dependency relationships | Dependencies updated to reference new IDs | Unit test output |
| HP-10 | Index generator produces valid Markdown structure | Output parses as valid Markdown | Unit test output |
| HP-11 | Index generator includes Progress Summary table | Status count table present | Unit test output |
| HP-12 | Index generator includes Ready to Start section | Lists stories with no blockers | Unit test output |
| HP-13 | Index generator includes per-story sections | Each story has required fields | Unit test output |
| HP-14 | Meta plan generator produces valid YAML frontmatter | Valid doc_type, title, status, etc. | Unit test output |
| HP-15 | Meta plan generator includes Principles section | Reuse First, Package Boundary Rules | Unit test output |
| HP-16 | Exec plan generator produces valid YAML frontmatter | Valid frontmatter matching schema | Unit test output |
| HP-17 | Exec plan generator includes Artifact Naming table | Maps artifact types to patterns | Unit test output |
| HP-18 | Full bootstrap_graph produces all three files | `artifactPaths` contains all paths | Integration test |
| HP-19 | Bootstrap graph sets `routingFlags.complete` on success | Flag is true after execution | Integration test |
| HP-20 | Nodes log entry/exit with duration | Logger mock called with expected args | Unit test mocks |

### Error Cases

| ID | Test Description | Expected Error | Evidence |
|----|------------------|----------------|----------|
| EC-1 | Plan analyzer receives empty plan input | Error: "Plan input is empty" | Unit test output |
| EC-2 | Plan analyzer receives malformed text | Error indicating parsing failure | Unit test output |
| EC-3 | Story splitter receives empty stories array | Error: "No stories to split" | Unit test output |
| EC-4 | Story splitter detects circular dependency | Error: "Circular dependency detected" | Unit test output |
| EC-5 | Story splitter detects missing dependency | Error: "Dependency X does not exist" | Unit test output |
| EC-6 | Index generator receives empty prefix | Validation error, `routingFlags.blocked` set | Unit test output |
| EC-7 | File writer receives invalid output directory | Error: "Output directory not writable" | Unit test output |
| EC-8 | File writer detects path traversal attempt | Error: "Path outside output directory" | Unit test output |
| EC-9 | Story prefix contains invalid characters | Validation error in state | Unit test output |
| EC-10 | Transitive circular dependency (A → B → C → A) | Error lists full cycle | Unit test output |

### Edge Cases

| ID | Test Description | Expected Behavior | Evidence |
|----|------------------|-------------------|----------|
| EDGE-1 | Minimal plan with single story | Single story generated, all files created | Unit test output |
| EDGE-2 | Plan with 50+ stories | All processed, performance <5s | Unit test output |
| EDGE-3 | Deeply nested dependencies (10+ levels) | Dependencies correctly resolved | Unit test output |
| EDGE-4 | Story prefix already lowercase | Used as-is | Unit test output |
| EDGE-5 | Story prefix uppercase ("WRKF") | Normalized to lowercase for paths | Unit test output |
| EDGE-6 | Story prefix contains hyphen ("MY-EPIC") | Handled correctly | Unit test output |
| EDGE-7 | Plan contains Unicode characters | Preserved in output files | Unit test output |
| EDGE-8 | Story at exact threshold (8 ACs) | NOT split | Unit test output |
| EDGE-9 | Story just over threshold (9 ACs) | IS split into two stories | Unit test output |
| EDGE-10 | Output files already exist | Overwritten without error | Unit test output |
| EDGE-11 | Timestamps in America/Denver timezone | Correct format in Agent Log | Unit test output |

### Integration Tests

| ID | Test Description | Expected Behavior | Evidence |
|----|------------------|-------------------|----------|
| INT-1 | Bootstrap graph uses createNode() from wrkf-1020 | Nodes created via factory | Test mock assertions |
| INT-2 | Bootstrap graph uses GraphState types | State mutations use correct types | Type-check output |
| INT-3 | State flows correctly between nodes | Analysis → Splitter → Generators → Writer | Integration test |
| INT-4 | Bootstrap graph uses @repo/logger | No console.log in codebase | Grep verification |
| INT-5 | Partial success preserves successful outputs | Errors captured, prior outputs kept | Integration test |

### Evidence Requirements

- [ ] `pnpm build --filter @repo/orchestrator` completes without errors
- [ ] `pnpm check-types --filter @repo/orchestrator` completes without errors
- [ ] `pnpm test --filter @repo/orchestrator` shows all tests passing
- [ ] `pnpm lint --filter @repo/orchestrator` shows no errors
- [ ] Test coverage report showing **80%+ for `src/graphs/bootstrap/`**
- [ ] Generated files match expected template structure
- [ ] No `console.log` statements (grep verification)

---

## Demo Script

1. `cd /path/to/monorepo`
2. `pnpm build --filter @repo/orchestrator` — Verify build succeeds
3. `pnpm test --filter @repo/orchestrator` — Verify all tests pass
4. `pnpm check-types --filter @repo/orchestrator` — Verify type checking passes
5. Create test file verifying graph execution:
   ```typescript
   import { createBootstrapGraph, createInitialState } from '@repo/orchestrator'

   const graph = createBootstrapGraph()

   const input = {
     rawPlan: `
       # Feature: User Authentication

       ## Goal
       Implement secure user authentication with OAuth2.

       ## Stories
       1. OAuth2 Provider Setup - Configure providers
       2. Login Flow - Implement login UI and backend
       3. Token Refresh - Handle token expiration

       ## Dependencies
       - Login Flow depends on OAuth2 Provider Setup
       - Token Refresh depends on Login Flow
     `,
     projectName: 'auth-feature',
     storyPrefix: 'AUTH',
     outputDirectory: '/tmp/test-output/',
   }

   const result = await graph.invoke(input)

   console.log('Generated files:', result.artifactPaths)
   console.log('Errors:', result.errors)
   console.log('Complete:', result.routingFlags.complete)
   ```
6. Verify all three output files are generated with correct structure
7. Verify generated files match template from `/pm-bootstrap-workflow` command

---

## Constraints

| Constraint | Value |
|------------|-------|
| Zod version | ^3.x (repo standard) |
| TypeScript strict mode | Required |
| Test framework | Vitest |
| Coverage threshold | 80% for `src/graphs/bootstrap/` |
| LangGraph version | ^0.2.x (from package.json) |
| date-fns version | ^3.x or ^4.x |
| Plan analysis | Pure parsing only (no LLM) |

---

## File Touch List (High-Level)

| Path | Action |
|------|--------|
| `packages/backend/orchestrator/package.json` | MODIFY — add date-fns dependencies |
| `packages/backend/orchestrator/src/index.ts` | MODIFY — export graphs module |
| `packages/backend/orchestrator/src/graphs/index.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/index.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/state.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/nodes/plan-analyzer.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/nodes/story-splitter.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/nodes/index-generator.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/nodes/meta-exec-generator.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/nodes/file-writer.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/utils/markdown.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/utils/templates.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/utils/paths.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/__tests__/plan-analyzer.test.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/__tests__/story-splitter.test.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/__tests__/index-generator.test.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/__tests__/meta-exec-generator.test.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/__tests__/file-writer.test.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/__tests__/bootstrap-graph.test.ts` | CREATE |
| `packages/backend/orchestrator/src/graphs/bootstrap/__tests__/fixtures/*.txt` | CREATE |

---

## Token Budget

| Phase | Agent | Est. Tokens | Actual Tokens |
|-------|-------|-------------|---------------|
| Generation | PM | ~10,000 | — |
| Elaboration | QA | ~6,000 | — |
| Implementation | Dev | ~15,000 | — |
| Verification | QA | ~4,000 | — |

---

## PM Decisions Log

The following decisions were made during story generation to remove blockers:

| # | Decision | Rationale |
|---|----------|-----------|
| 1 | Use pure parsing (no LLM) for plan analysis | Deterministic, testable, no API costs; LLM enhancement deferred to follow-up story |
| 2 | Story numbering starts at 1000, increments by 10 | Matches existing wrkf- pattern in codebase |
| 3 | Separate file-writer node from generators | Nodes remain pure functions; file I/O isolated to single node |
| 4 | Add path traversal validation | Security requirement for file writes |
| 5 | Add date-fns dependencies | Required for America/Denver timestamp formatting |
| 6 | Max 8 ACs per story threshold | Matches sizing guidelines from `/pm-bootstrap-workflow` |
| 7 | Sequential node execution (no parallelism) | First subgraph — establish simple patterns before optimization |
| 8 | Errors captured in state, not thrown | Matches wrkf-1020 error handling pattern |

---

*Generated by PM Agent | 2026-01-24*
