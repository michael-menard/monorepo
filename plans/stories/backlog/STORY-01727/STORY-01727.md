---
status: backlog
split_from: STORY-0172
split_part: 3 of 3
---

# STORY-01727: Binary Upload & Finalization - Performance & Observability

## Split Context

This story is part of a split from STORY-0172.
- **Original Story:** STORY-0172 (Binary Upload & Finalization)
- **Split Reason:** Story expanded from 3 ACs to 21 ACs (700% growth) during elaboration. Split separates performance enhancements and observability features from core MVP (STORY-01725) and reliability hardening (STORY-01726).
- **This Part:** 3 of 3 (Z=7)
- **Dependency:** Depends on STORY-01726 (Binary Upload & Finalization - Reliability & Resilience)

## Title

Binary Upload & Finalization - Performance & Observability

## Context

This story builds on STORY-01725 (core MVP) and STORY-01726 (reliability) to add advanced features that improve upload user experience and operational visibility. While the previous stories delivered working, production-ready endpoints, this story optimizes performance and adds observability for the critical upload and finalization path.

These enhancements cover:
- **Real-Time UX:** WebSocket progress tracking for live upload updates
- **Performance:** Parallel file validation, batch upload-part endpoint
- **Data Integrity:** MD5/SHA checksum verification beyond magic bytes
- **Media Processing:** Auto-thumbnail generation from uploaded images
- **Integration:** Webhook notifications for asynchronous finalize completion
- **Resilience:** Upload resume from partial finalize state
- **Observability:** OpenTelemetry spans for finalize critical path

All enhancements maintain full API compatibility. Some features add new optional endpoints (batch upload) or optional response fields (checksums). No breaking changes to existing API contracts.

## Goal

Enhance binary upload and finalization endpoints with performance optimizations, real-time progress tracking, advanced validation, media processing, webhook integration, and distributed tracing.

## Non-Goals

- Session cleanup jobs (STORY-018)
- New UI components (backend API only)
- Multi-region S3 optimization (infrastructure story, out-of-scope per elaboration)
- Content-addressable storage / deduplication (significant refactor, out-of-scope per elaboration)

## Scope

### Performance & Observability Enhancements (8 items)

1. **WebSocket Progress Tracking** (enhance_1) - Real-time upload events
2. **Parallel File Validation** (enhance_2) - Parallelize HeadObject + magic bytes
3. **Checksum Validation** (enhance_3) - Optional MD5/SHA verification
4. **Batch Upload-Part Endpoint** (enhance_4) - Upload multiple parts per request
5. **Thumbnail Generation** (enhance_5) - Auto-resize first image
6. **Webhook Notifications** (enhance_6) - Post-finalize webhooks
7. **Resume from Partial Finalize** (enhance_7) - Detect and resume partial state
8. **OpenTelemetry Finalize Tracing** (enhance_8) - Distributed tracing spans

### Packages/Apps Affected

**Create:**
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/[fileId]/parts/batch.ts` (new batch endpoint)

**Modify:**
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/[fileId]/parts/[partNumber].ts` (WebSocket events, checksum)
- `apps/api/platforms/vercel/api/mocs/uploads/finalize.ts` (parallel validation, thumbnails, webhooks, telemetry, resume)

**New Dependencies:**
- `sharp` - Image processing for thumbnails
- `@opentelemetry/api` - Distributed tracing
- WebSocket server (STORY-019 dependency)

## Acceptance Criteria

### enhance_1_websocket_progress: Real-Time Progress Tracking

**Dependency:** Requires STORY-019 WebSocket server

- [ ] When upload-part succeeds, emit WebSocket event:
  ```json
  {
    "type": "upload.part.completed",
    "sessionId": "...",
    "fileId": "...",
    "partNumber": 1,
    "etag": "...",
    "totalParts": 10,
    "completedParts": 1,
    "percentComplete": 10
  }
  ```
- [ ] When finalize succeeds, emit:
  ```json
  {
    "type": "upload.session.finalized",
    "sessionId": "...",
    "mocId": "...",
    "status": "success"
  }
  ```
- [ ] Gracefully no-op if WebSocket server unavailable (log warning, continue upload)
- [ ] Document WebSocket event schema in API docs

### enhance_2_parallel_validation: Parallel File Validation

- [ ] Finalize endpoint validates files in parallel using `Promise.all()`:
  - HeadObject for each file (verify existence)
  - GetObject (first 512 bytes) for magic byte validation
- [ ] Measure latency improvement: log before/after parallel optimization
- [ ] Maintain same validation logic as STORY-01725, only parallelize execution
- [ ] Handle partial failures: if any file fails validation, abort finalize with detailed error

### enhance_3_checksum_validation: MD5/SHA Checksum Verification

- [ ] Add optional `checksums` array to register-file request:
  ```json
  {
    "fileKey": "test.pdf",
    "fileSizeBytes": 5000000,
    "checksums": {
      "md5": "abc123...",
      "sha256": "def456..."
    }
  }
  ```
- [ ] Store checksums in `upload_session_files.metadata` JSON column
- [ ] At finalize, verify S3 object ETag matches MD5 (for single-part uploads)
- [ ] For multipart uploads, optionally compute checksum from completed parts
- [ ] Return `400 CHECKSUM_MISMATCH` if validation fails
- [ ] Document that checksum verification is optional (low ROI for MVP per elaboration)

### enhance_4_batch_upload: Batch Upload-Part Endpoint

- [ ] New endpoint: `POST /api/mocs/uploads/sessions/:sessionId/files/:fileId/parts/batch`
- [ ] Accepts multipart/form-data with array of parts:
  ```
  --boundary
  Content-Disposition: form-data; name="part1"; filename="part1"
  <binary data>
  --boundary
  Content-Disposition: form-data; name="part2"; filename="part2"
  <binary data>
  --boundary--
  ```
- [ ] Uploads all parts to S3 in parallel using `Promise.all()`
- [ ] Returns array of `{ partNumber, etag }` responses
- [ ] Reduces HTTP overhead for small files (e.g., 10MB file = 2 parts instead of 2 requests)
- [ ] Document trade-offs: batch reduces round-trips but increases request size (Vercel 50MB limit)

### enhance_5_thumbnail_generation: Auto-Generate Thumbnails

- [ ] At finalize, detect first image file (MIME type image/*)
- [ ] Download image from S3 (first 10MB only, fail if larger)
- [ ] Use `sharp` library to generate thumbnail: 300x300, JPEG, quality 80
- [ ] Upload thumbnail to S3 at `{mocId}/thumbnail.jpg`
- [ ] Add `thumbnailUrl` field to MOC response
- [ ] Gracefully handle errors: log warning, continue finalize (thumbnail is optional)
- [ ] Document that thumbnail generation is asynchronous (may not be available immediately)

### enhance_6_webhook_notifications: Post-Finalize Webhooks

- [ ] After successful finalize, trigger webhook POST to configured URL:
  ```json
  POST {WEBHOOK_URL}
  {
    "event": "moc.finalized",
    "mocId": "...",
    "sessionId": "...",
    "userId": "...",
    "timestamp": "2026-01-25T12:00:00Z"
  }
  ```
- [ ] Webhook URL configured via env var `MOC_FINALIZE_WEBHOOK_URL`
- [ ] Retry webhook on failure: 3 attempts with exponential backoff (1s, 2s, 4s)
- [ ] Log webhook failures with ERROR level
- [ ] Document that webhook is fire-and-forget (finalize doesn't wait for webhook response)

### enhance_7_resume_from_failure: Upload Resume from Partial Finalize

- [ ] If finalize fails after MOC creation but before session update, detect partial state:
  - Check if `moc_instructions` record exists with matching session ID
  - If found, return existing MOC with `resumed: true` flag
- [ ] Add test case: simulate finalize failure between MOC insert and session update
- [ ] Expected behavior: second finalize detects existing MOC, returns it (not creating duplicate)
- [ ] Document that resume only works within 30-minute session window

### enhance_8_opentelemetry: Structured Finalize Telemetry

- [ ] Wrap finalize endpoint in OpenTelemetry span: `moc.upload.finalize`
- [ ] Add child spans for each operation:
  - `validate.session` - session validation
  - `validate.files` - parallel file validation
  - `create.moc` - MOC record creation
  - `create.files` - file records creation
  - `generate.thumbnail` - thumbnail generation (if enabled)
  - `send.webhook` - webhook notification (if enabled)
- [ ] Include span attributes:
  - `sessionId`, `mocId`, `userId`, `fileCount`, `totalSizeBytes`
- [ ] Export spans to configured OTLP endpoint (env var `OTEL_EXPORTER_OTLP_ENDPOINT`)
- [ ] Document that telemetry is optional (gracefully no-op if OTLP endpoint not configured)

## Reuse Plan

### Existing Packages to Use

| Package | Purpose |
|---------|---------|
| `sharp` | Image thumbnail generation |
| `@opentelemetry/api` | Distributed tracing |
| `@repo/logger` | Structured logging |
| WebSocket server (STORY-019) | Real-time progress events |
| STORY-01725, STORY-01726 handlers | Extend existing endpoints |

### Existing Core Code to Reference

| Path | Purpose |
|------|---------|
| STORY-019 WebSocket client | Emit upload events |
| `apps/api/core/config/upload.ts` | Upload configuration |

### New Shared Code

Consider extracting to `@repo/upload-utils` package (post-story refactor):
- Thumbnail generation helper
- Webhook retry logic
- Checksum validation utilities

## Architecture Notes (Ports & Adapters)

### Port Interfaces (Extended)

**Part Upload Service Port:**
- `uploadPart(fileId, partNumber, binary, options: { emitProgress: boolean, checksum?: string }) -> { etag }`
- `uploadPartsBatch(fileId, parts: Array<{ partNumber, binary }>) -> Array<{ partNumber, etag }>`

**Finalize Service Port:**
- `finalizeSession(sessionId, metadata, options: { validateChecksums: boolean, generateThumbnail: boolean, sendWebhook: boolean }) -> MOC`

### Adapter Responsibilities

**WebSocket Adapter:**
- Emit progress events to connected clients
- Graceful degradation if WebSocket unavailable

**Image Processing Adapter (Sharp):**
- Download image from S3
- Generate thumbnail (resize, compress)
- Upload thumbnail to S3

**Webhook Adapter:**
- HTTP POST to configured URL
- Retry with exponential backoff

**Telemetry Adapter (OpenTelemetry):**
- Create and manage spans
- Export to OTLP endpoint

## Required Vercel / Infra Notes

### Environment Variables Required (New)

- `MOC_FINALIZE_WEBHOOK_URL` - Webhook URL for finalize events (optional)
- `OTEL_EXPORTER_OTLP_ENDPOINT` - OpenTelemetry collector endpoint (optional)
- `ENABLE_THUMBNAIL_GENERATION` - Enable auto-thumbnail (true/false, default: false)

### New Route

- `POST /api/mocs/uploads/sessions/:sessionId/files/:fileId/parts/batch` - Batch upload endpoint

### Vercel Function Configuration

```json
// vercel.json (functions section)
{
  "functions": {
    "api/mocs/uploads/sessions/[sessionId]/files/[fileId]/parts/batch.ts": {
      "maxDuration": 60
    }
  }
}
```

## HTTP Contract Plan

### Required `.http` Requests

All requests are defined in `__http__/story-01727-performance-observability.http`:

| Request | Test ID | Description |
|---------|---------|-------------|
| `uploadPartWithWebSocket` | WS-HP-001 | Upload part, verify WebSocket event |
| `finalizeParallel` | PV-HP-001 | Finalize with parallel validation |
| `uploadPartWithChecksum` | CS-HP-001 | Upload with MD5 checksum |
| `batchUploadParts` | BU-HP-001 | Batch upload 3 parts |
| `finalizeWithThumbnail` | TH-HP-001 | Finalize, verify thumbnail generated |
| `finalizeWithWebhook` | WH-HP-001 | Finalize, verify webhook sent |
| `finalizeResume` | RF-HP-001 | Resume from partial finalize state |
| `finalizeWithTelemetry` | OT-HP-001 | Finalize, verify OTLP spans exported |

### Error Case Requests

| Request | Test ID | Expected Status |
|---------|---------|-----------------|
| Checksum mismatch | CS-ERR-001 | 400 |
| Batch upload size exceeded | BU-ERR-001 | 413 |

### Required Evidence

Captured in proof document:
- All happy path requests with responses
- WebSocket event logs showing progress updates
- S3 console showing generated thumbnails
- Webhook server logs showing POST requests
- Jaeger/Zipkin UI showing distributed traces
- Performance comparison: sequential vs parallel validation

## Seed Requirements

### Test Data for Enhancement Testing

```sql
-- Session with image files for thumbnail testing
INSERT INTO upload_sessions (id, user_id, status, part_size_bytes, expires_at, created_at, updated_at)
VALUES (
  'ffffff-ffff-ffff-ffff-ffffffffffff',
  'dev-user-00000000-0000-0000-0000-000000000001',
  'active',
  5242880,
  NOW() + INTERVAL '30 minutes',
  NOW(),
  NOW()
);

INSERT INTO upload_session_files (id, session_id, file_key, file_size_bytes, mime_type, status, created_at, updated_at)
VALUES (
  'gggggggg-gggg-gggg-gggg-gggggggggggg',
  'ffffff-ffff-ffff-ffff-ffffffffffff',
  'test-image.jpg',
  500000,
  'image/jpeg',
  'completed',
  NOW(),
  NOW()
);
```

### Seed Location

Add to `apps/api/core/database/seeds/story-01727.ts` and register in seed index.

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| Feature | Test ID | Description | Expected |
|---------|---------|-------------|----------|
| WebSocket | WS-HP-001 | Upload part with WebSocket enabled | Event emitted to connected clients |
| Parallel Validation | PV-HP-001 | Finalize with 5 files | Validation completes in parallel |
| Checksum | CS-HP-001 | Upload with MD5 | Checksum validated at finalize |
| Batch Upload | BU-HP-001 | Batch upload 3 parts | All parts uploaded, ETags returned |
| Thumbnail | TH-HP-001 | Finalize with image | Thumbnail generated, URL returned |
| Webhook | WH-HP-001 | Finalize with webhook enabled | POST sent to configured URL |
| Resume | RF-HP-001 | Partial finalize, retry | Existing MOC returned with resumed: true |
| Telemetry | OT-HP-001 | Finalize with OTLP enabled | Spans exported to collector |

### Error Cases

| Category | Test ID | Condition | Status | Code |
|----------|---------|-----------|--------|------|
| Checksum | CS-ERR-001 | MD5 mismatch | 400 | CHECKSUM_MISMATCH |
| Batch Upload | BU-ERR-001 | Batch size > 50MB | 413 | PAYLOAD_TOO_LARGE |

### Edge Cases

- **WebSocket unavailable:** Upload continues, warning logged
- **Thumbnail generation failure:** Finalize succeeds without thumbnail
- **Webhook retry exhaustion:** Finalize succeeds, webhook failure logged
- **Parallel validation partial failure:** Finalize aborts with detailed error
- **Resume race condition:** Two clients detect partial state, first wins

### Evidence Requirements

Per-feature proof:
- [ ] Happy path request/response for each enhancement
- [ ] WebSocket event logs showing real-time updates
- [ ] S3 console showing generated thumbnails
- [ ] Webhook server logs showing POST requests
- [ ] Jaeger/Zipkin traces showing finalize spans
- [ ] Performance metrics: parallel vs sequential validation

---

## Risks / Edge Cases

### Risks

1. **WebSocket Dependency:** If STORY-019 blocked, WebSocket features cannot be tested. Mitigation: graceful degradation.
2. **Thumbnail Generation Memory:** Processing large images (>10MB) may exceed Vercel memory limits. Mitigation: limit to 10MB, fail gracefully.
3. **Webhook Retry Blocking:** If webhook endpoint slow, retry delays finalize response. Mitigation: async webhook (don't wait for response).
4. **Telemetry Overhead:** OTLP export may add latency. Mitigation: async export, sampling.
5. **Batch Upload Complexity:** Multiplexing binary streams increases handler complexity. Mitigation: thorough testing.

### Edge Cases

- **Thumbnail generation on non-image:** Detect MIME type, skip gracefully
- **Webhook URL unreachable:** Retry fails, log error, continue
- **Checksum mismatch on multipart:** Requires downloading all parts to compute, expensive
- **Parallel validation race:** One file fails validation mid-execution, abort others
- **Resume with different metadata:** User changes title on retry, which title wins?

---

## PM Decisions (Blockers Resolved)

### Decision 1: WebSocket Graceful Degradation

**Decision:** If STORY-019 WebSocket server unavailable, upload-part and finalize continue without progress events.

**Rationale:** Upload functionality should not block on WebSocket availability. Log warning and proceed.

### Decision 2: Thumbnail Generation Limits

**Decision:** Only generate thumbnails for images <10MB. Skip larger images with warning log.

**Rationale:** Vercel function memory limits (1GB on Pro tier). Large image processing risks OOM.

### Decision 3: Webhook Async Execution

**Decision:** Finalize returns response immediately, webhook POST happens asynchronously.

**Rationale:** User should not wait for webhook delivery. Webhook failures don't block finalize success.

### Decision 4: Checksum Verification Optional

**Decision:** Checksum validation is opt-in (client provides checksums). Default behavior unchanged.

**Rationale:** Low ROI per elaboration. Most clients don't need checksums. Magic bytes sufficient for content validation.

### Decision 5: Batch Upload Endpoint Optional

**Decision:** Batch endpoint is new, optional. Existing single-part upload remains primary path.

**Rationale:** Batch upload adds complexity. Only useful for small files with many parts. Single-part is simpler.

---

## Token Budget

| Phase | Agent | Input (est) | Output (est) |
|-------|-------|-------------|--------------|
| PM: Story Split | PM | ~15K | ~8K |
| **PM Total** | â€” | **~15K** | **~8K** |

---

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-25 | PM Split Leader | Split STORY-0172 into STORY-01725, STORY-01726, STORY-01727 | `plans/stories/backlog/STORY-01727/STORY-01727.md` |

---
