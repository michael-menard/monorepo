---
status: backlog
split_from: STORY-01712
split_part: 3 of 4
---

# STORY-01723: Session & File Management - Analytics & Detection

## Split Context

This story is part of a split from STORY-01712.
- **Original Story:** STORY-01712 (Session & File Management - Advanced Features, which itself was split from STORY-0171)
- **Split Reason:** STORY-01712 elaboration identified 16 ACs (8 gap remediations + 8 enhancements) that exceeded safe story sizing boundaries. This split addresses 4 observability and deduplication features that are independent from core upload flow.
- **This Part:** 3 of 4 (Z=3)
- **Dependency:** STORY-01721 (requires gap remediations to be complete before adding analytics/detection)

## Title

Multipart Upload Session Management - Analytics & Detection

## Context

This story implements 4 features focused on observability, deduplication, and developer tooling for the multipart upload session management API:

1. **TypeScript SDK Generation** - Automated SDK generation from `.http` contract files using `openapi-generator`, providing typed client libraries for API consumers.

2. **Session Analytics Tracking** - Track session lifecycle events (success rate, average upload time, failure points) to provide visibility into upload system health and user experience.

3. **Duplicate File Detection** - Check for duplicate uploads before session creation using file size + hash, preventing wasted storage and bandwidth.

4. **Automatic Session Extension** - Auto-extend `expiresAt` timestamp when clients are actively uploading, reducing "session expired" errors during long uploads.

These features are independent from upload enhancements (STORY-01722) and WebSocket integration (STORY-01724). They build on gap remediations from STORY-01721.

## Goal

Add observability, deduplication, and developer experience improvements to the session management API. Analytics tracking provides insights for PM/QA, duplicate detection saves storage costs, auto-extension reduces user friction, and SDK generation simplifies API integration for frontend teams.

## Non-Goals

- Upload UX enhancements (presigned URLs, batch, resume - STORY-01722)
- WebSocket progress tracking (STORY-01724)
- Binary part upload handling (STORY-0172)
- Session finalization (STORY-0172)
- Background cleanup jobs (STORY-018)
- Analytics dashboard visualization (future enhancement)
- Global duplicate detection / anti-piracy (future enhancement, requires policy decision)

## Scope

### Analytics & Detection Features (4 items)

1. **TypeScript SDK Generation** (AC-20) - Script that reads `.http` files and generates typed SDK
2. **Session Analytics Tracking** (AC-21) - Track lifecycle events, expose admin analytics endpoint
3. **Duplicate File Detection** (AC-22) - Check for duplicates by size + hash before session creation
4. **Automatic Session Extension** (AC-23) - Extend `expiresAt` when upload activity detected

### Packages/Apps Affected

**Modify:**
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/index.ts` (add analytics tracking, duplicate detection)
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/[sessionId]/files/index.ts` (add extension logic)
- `apps/api/platforms/vercel/vercel.json` (add analytics endpoint route)

**Create:**
- `apps/api/platforms/vercel/api/mocs/uploads/sessions/analytics.ts` (analytics query endpoint)
- `scripts/generate-sdk.ts` (SDK generation script)
- `packages/sdk/upload-sessions/` (generated SDK output directory)
- `__http__/story-01723-analytics-detection.http` (test file)

**Database:**
- Add `upload_session_analytics` table for event tracking

## Acceptance Criteria

### AC-20: TypeScript SDK Generation
- [ ] Create `scripts/generate-sdk.ts` script that reads `.http` files from `__http__/` directory
- [ ] Generate TypeScript client SDK with typed request/response interfaces using `openapi-generator` or similar tool
- [ ] Output SDK to `packages/sdk/upload-sessions/` directory with proper package.json
- [ ] Include usage examples and README in SDK package
- [ ] Document SDK generation in main README (how to run, when to regenerate)
- [ ] Script should be idempotent (safe to run multiple times)

### AC-21: Session Analytics Tracking
- [ ] Create `upload_session_analytics` table with columns: `(event_id, session_id, event_type, metadata, created_at)`
- [ ] Track session lifecycle events: `session_created`, `file_registered`, `file_completed`, `session_finalized`, `session_failed`
- [ ] Include metadata: user_id, file count, total size, elapsed time, failure reason
- [ ] Add `GET /api/mocs/uploads/sessions/analytics` endpoint for admin users (requires admin role check)
- [ ] Analytics endpoint supports filters: date range, event type, user ID
- [ ] Returns metrics: session success rate (completed / created), average upload time, common failure points
- [ ] Analytics logging must not block or slow down upload flow (use async logging or background worker)
- [ ] Document analytics schema and query examples

### AC-22: Duplicate File Detection
- [ ] Add optional `fileHashes` array to session creation request: `{ files: [{ key, size, hash }] }`
- [ ] Before creating session, query `upload_session_files` for matching `(user_id, file_size_bytes, file_hash)` with `status='completed'`
- [ ] If duplicates found, return `409 CONFLICT` with response: `{ duplicates: [{ key, existingUrl }] }`
- [ ] Allow clients to bypass duplicate check with `allowDuplicates: true` flag in request
- [ ] Add composite index on `(user_id, file_size_bytes, file_hash)` for query performance
- [ ] Document that hash generation is client responsibility (SHA-256 recommended)
- [ ] Document that detection is per-user (not global anti-piracy)

### AC-23: Automatic Session Extension
- [ ] When file registration or part upload occurs, check if session `expiresAt` is within 10 minutes of NOW
- [ ] If yes, extend `expiresAt` by session TTL duration (e.g., +30 minutes from NOW)
- [ ] Log extension events with context (sessionId, old expiresAt, new expiresAt, triggered by action)
- [ ] Cap total session lifetime at configurable max (env var `MAX_SESSION_LIFETIME_HOURS`, default: 24)
- [ ] If max lifetime reached, do not extend (allow expiration)
- [ ] Document that extension only happens on active upload activity (file registration, part upload, file completion - not reads)
- [ ] Include `sessionExtended: true, newExpiresAt` in API response when extension occurs

## Reuse Plan

### Existing Packages to Use

| Package | Purpose |
|---------|---------|
| `@repo/logger` | Structured logging for analytics events |
| Core handlers from STORY-01711 | Base implementation to extend |
| Core handlers from STORY-01721 | Gap remediations |

### Existing Core Code to Reference

| Path | Purpose |
|------|---------|
| STORY-01711 handlers | Base implementation |
| STORY-01721 handlers | Extended error handling |
| `apps/api/core/config/upload.ts` | Upload configuration |
| `__http__/*.http` | Source files for SDK generation |

### New Shared Code

**SDK Package:**
- `packages/sdk/upload-sessions/` - Generated TypeScript SDK (output artifact, not manually maintained)

## Architecture Notes (Ports & Adapters)

### Port Interfaces (Extended)

**Session Service Port (Extended):**
- `createSession(userId, files, options?) -> { sessionId, partSizeBytes, expiresAt, duplicates? }`
- `checkDuplicates(userId, fileHashes) -> DuplicateFile[]`
- `extendSession(sessionId) -> { expiresAt }`

**Analytics Service Port (New):**
- `trackEvent(sessionId, eventType, metadata) -> void`
- `getAnalytics(filters) -> AnalyticsSummary`

### Adapter Responsibilities

**Database Adapter (Drizzle) - Extended:**
- Insert `upload_session_analytics` events (async, non-blocking)
- Query for duplicate files by `(user_id, size, hash)`
- Update session `expiresAt` timestamp
- Query analytics with aggregations (success rate, avg time)

**Analytics Adapter (New):**
- Emit analytics events asynchronously (use queue or async insert)
- Compute metrics from raw events

## Required Vercel / Infra Notes

### Route Rewrites (Additional)

```json
// vercel.json (rewrites section - add to existing)
[
  {
    "source": "/api/mocs/uploads/sessions/analytics",
    "destination": "/api/mocs/uploads/sessions/analytics"
  }
]
```

### Environment Variables Required (Additional)

- `MAX_SESSION_LIFETIME_HOURS` - Maximum total session lifetime before forced expiration (default: 24)
- `SESSION_EXTENSION_THRESHOLD_MINUTES` - Trigger extension when < N minutes remain (default: 10)
- `SESSION_EXTENSION_TTL_MINUTES` - How much to extend by (default: 30)

### Database Migration

**New Table: `upload_session_analytics`**

```sql
CREATE TABLE upload_session_analytics (
  event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES upload_sessions(id) ON DELETE CASCADE,
  event_type VARCHAR(50) NOT NULL, -- session_created, file_registered, file_completed, session_finalized, session_failed
  metadata JSONB, -- user_id, file_count, total_size_bytes, elapsed_time_ms, failure_reason, etc.
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_upload_session_analytics_session_id ON upload_session_analytics(session_id);
CREATE INDEX idx_upload_session_analytics_event_type ON upload_session_analytics(event_type);
CREATE INDEX idx_upload_session_analytics_created_at ON upload_session_analytics(created_at);
```

**Add Index for Duplicate Detection:**

```sql
CREATE INDEX idx_upload_session_files_duplicate_detection
ON upload_session_files(user_id, file_size_bytes, file_hash)
WHERE status = 'completed' AND file_hash IS NOT NULL;
```

## HTTP Contract Plan

### Required `.http` Requests

All requests are defined in `__http__/story-01723-analytics-detection.http`:

| Request | Test ID | Description |
|---------|---------|-------------|
| `createSessionWithDuplicateCheck` | DD-HP-001 | Create session with file hash, duplicate detected |
| `createSessionBypassDuplicate` | DD-HP-002 | Create session with allowDuplicates=true |
| `registerFileAutoExtend` | AE-HP-001 | Register file near expiration, session auto-extends |
| `getAnalytics` | AN-HP-001 | Query session analytics (admin only) |
| `getAnalyticsFiltered` | AN-HP-002 | Query analytics with date range filter |

### Error Case Requests

| Request | Test ID | Expected Status |
|---------|---------|-----------------|
| Duplicate detected | DD-ERR-001 | 409 (with existing URLs) |
| Analytics non-admin | AN-ERR-001 | 403 (Forbidden) |
| Extension max lifetime reached | AE-ERR-001 | No extension, session expires |

### Required Evidence

Captured in proof document:
- All happy path requests with responses
- Duplicate detection example with 409 response
- Database queries showing `upload_session_analytics` events
- Analytics endpoint response with metrics
- SDK generation output example (generated TypeScript files)
- Session extension log output

## Seed Requirements

### Test Data for Analytics & Detection

```sql
-- Session with files for duplicate detection testing
INSERT INTO upload_sessions (id, user_id, status, part_size_bytes, expires_at, created_at, updated_at)
VALUES (
  'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa',
  'dev-user-00000000-0000-0000-0000-000000000001',
  'completed',
  5242880,
  NOW() + INTERVAL '15 minutes',
  NOW(),
  NOW()
);

-- Completed file with hash for duplicate detection
INSERT INTO upload_session_files (id, session_id, user_id, file_key, file_size_bytes, file_hash, status, file_url, created_at, updated_at)
VALUES (
  '22222222-2222-2222-2222-222222222222',
  'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa',
  'dev-user-00000000-0000-0000-0000-000000000001',
  'test-duplicate.pdf',
  5000000,
  'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855',
  'completed',
  's3://bucket/test-duplicate.pdf',
  NOW(),
  NOW()
);

-- Session nearing expiration for auto-extension testing
INSERT INTO upload_sessions (id, user_id, status, part_size_bytes, expires_at, created_at, updated_at)
VALUES (
  'gggggggg-gggg-gggg-gggg-gggggggggggg',
  'dev-user-00000000-0000-0000-0000-000000000001',
  'active',
  5242880,
  NOW() + INTERVAL '5 minutes', -- expires soon, should trigger extension
  NOW() - INTERVAL '25 minutes',
  NOW()
);

-- Analytics events for testing
INSERT INTO upload_session_analytics (event_id, session_id, event_type, metadata, created_at)
VALUES
  ('33333333-3333-3333-3333-333333333333', 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', 'session_created', '{"user_id": "dev-user-001", "file_count": 1}', NOW() - INTERVAL '30 minutes'),
  ('44444444-4444-4444-4444-444444444444', 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', 'file_completed', '{"elapsed_time_ms": 5000}', NOW() - INTERVAL '25 minutes'),
  ('55555555-5555-5555-5555-555555555555', 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', 'session_finalized', '{"total_size_bytes": 5000000}', NOW() - INTERVAL '20 minutes');
```

### Seed Location

Add to `apps/api/core/database/seeds/story-01723.ts` and register in seed index.

## Test Plan (Happy Path / Error Cases / Edge Cases)

### Happy Path Tests

| Feature | Test ID | Description | Expected |
|---------|---------|-------------|----------|
| Duplicate Detection | DD-HP-001 | Create session with matching hash | 409 with existing URLs |
| Duplicate Bypass | DD-HP-002 | Create with allowDuplicates=true | 201, session created |
| Auto Extension | AE-HP-001 | Register near expiration | Session extended automatically |
| Analytics Query | AN-HP-001 | Query analytics as admin | 200 with metrics |
| SDK Generation | SDK-HP-001 | Run generate-sdk script | TypeScript files generated |

### Error Cases

| Category | Test ID | Condition | Status | Code |
|----------|---------|-----------|--------|------|
| Duplicate | DD-ERR-001 | Duplicate detected | 409 | DUPLICATE_FILE |
| Analytics | AN-ERR-001 | Non-admin user | 403 | Forbidden |
| Extension | AE-ERR-001 | Max lifetime reached | — | No extension |

### Edge Cases

- **Duplicate check bypass**: Clients can opt out with `allowDuplicates: true`
- **Session extension limits**: Don't extend indefinitely, cap at max session lifetime
- **Analytics async logging**: Events logged asynchronously, may not appear immediately in queries
- **SDK regeneration**: Script is idempotent, safe to run multiple times

### Evidence Requirements

Per-feature proof:
- [ ] Happy path request/response for each AC
- [ ] Duplicate detection 409 response with URLs
- [ ] Database queries showing analytics events
- [ ] Analytics endpoint response with computed metrics
- [ ] SDK generation output (directory listing, sample TypeScript file)
- [ ] Extension log output with old/new timestamps

---

## Risks / Edge Cases

### Risks

1. **Analytics Volume:** High-throughput uploads generate many analytics events. Async logging required to avoid blocking upload flow. Consider batching or using message queue.
2. **Duplicate Detection Performance:** Hash-based duplicate checks require database index. Query performance critical for session creation latency. Monitor query execution time.
3. **SDK Generation Coupling:** SDK generation depends on `.http` file format. If format changes, generation script may break. Need automated tests.
4. **Session Extension Race Condition:** Concurrent requests could trigger multiple extensions. Use database transaction to ensure single extension.
5. **Max Lifetime Enforcement:** Sessions that hit max lifetime will expire even if client is actively uploading. Document this limitation clearly.

### Edge Cases

- **Duplicate detection with missing hash**: If client doesn't provide hash, skip duplicate check (hash is optional)
- **Analytics query pagination**: For large result sets, analytics endpoint should support pagination (limit/offset)
- **Session extension threshold**: If threshold too low (e.g., 1 minute), could trigger extensions too frequently
- **SDK generation errors**: If `.http` file has syntax errors, script should fail gracefully with clear error message

---

## Token Budget

| Phase | Agent | Input (est) | Output (est) |
|-------|-------|-------------|--------------|
| PM: Story Split | PM Split Leader | ~20K | ~8K |
| **PM Total** | — | **~20K** | **~8K** |

---

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-25 | PM Split Leader | Split STORY-01712 into 4 stories (STORY-01721, STORY-01722, STORY-01723, STORY-01724) | `plans/stories/backlog/STORY-01723/STORY-01723.md` |
