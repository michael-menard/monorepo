---
schema: 2
feature_dir: "plans/future/flow-update"
prefix: "FLOW"
project_name: "flow-update"
analyzed: "2026-02-01T12:50:00Z"

overall_goal: |
  Refactor the Dev → Code Review → QA Verify cycle into a phase-leader pattern with
  evidence-driven artifacts to reduce token usage, minimize redundant reads, and enable
  deterministic resume capabilities.

phases:
  - id: 0
    name: "Audit & Analysis"
    description: "Audit existing command/agent infrastructure and propose redesigned architecture"
  - id: 1
    name: "Shared Infrastructure"
    description: "Create reusable knowledge context loader and evidence bundle infrastructure"
  - id: 2
    name: "Dev Implementation Refactor"
    description: "Refactor /dev-implement-story into 4-phase leader pattern"
  - id: 3
    name: "Code Review Refactor"
    description: "Refactor /dev-code-review into 3-phase leader pattern with diff-aware workers"
  - id: 4
    name: "QA Verify Refactor"
    description: "Refactor /qa-verify-story into 3-phase leader pattern with evidence-first verification"

stories:
  - id: "FLOW-001"
    title: "Audit Existing Dev/Review/QA Infrastructure"
    feature: "Inventory all commands and agents for dev implementation, code review, and QA verification"
    phase: 0
    depends_on: []
    endpoints: []
    infrastructure: []
    goal: "Document current command/agent architecture, identify duplication, and highlight token-risk hotspots"
    risk_notes: "Must accurately capture all existing agents and their responsibilities. Incomplete audit leads to missed optimizations."
    sizing_warning: false

  - id: "FLOW-002"
    title: "Propose Refactored Command/Agent Architecture"
    feature: "Design new phase-leader architecture with BEFORE/AFTER diagrams and migration plan"
    phase: 0
    depends_on: ["FLOW-001"]
    endpoints: []
    infrastructure: []
    goal: "Provide clear redesign proposal with token savings rationale and step-by-step migration plan"
    risk_notes: "Architecture decisions here affect all downstream stories. Needs careful validation."
    sizing_warning: false

  - id: "FLOW-003"
    title: "Create Knowledge Context Loader"
    feature: "Implement reusable load-knowledge-context node for lessons learned and ADR integration"
    phase: 1
    depends_on: ["FLOW-002"]
    endpoints: []
    infrastructure: []
    goal: "Create deterministic knowledge loader that queries KB and ADR-LOG.md based on story scope"
    risk_notes: "Must handle KB unavailability gracefully without blocking workflow"
    sizing_warning: false

  - id: "FLOW-004"
    title: "Define Evidence Bundle Schema (EVIDENCE.yaml)"
    feature: "Create EVIDENCE.yaml schema as single source of truth for implementation artifacts"
    phase: 1
    depends_on: ["FLOW-002"]
    endpoints: []
    infrastructure: []
    goal: "Define structured artifact for acceptance criteria evidence, touched files, commands run, and endpoints exercised"
    risk_notes: "Schema must be comprehensive yet concise to avoid token bloat"
    sizing_warning: false

  - id: "FLOW-005"
    title: "Define Checkpoint and Scope Schemas"
    feature: "Create CHECKPOINT.yaml and SCOPE.yaml schemas for phase tracking and scope analysis"
    phase: 1
    depends_on: ["FLOW-002"]
    endpoints: []
    infrastructure: []
    goal: "Enable deterministic resume capabilities and diff-aware agent selection"
    risk_notes: "Checkpoint schema must support iteration counters and resume hints"
    sizing_warning: false

  - id: "FLOW-006"
    title: "Define Plan, Review, and QA Schemas"
    feature: "Create PLAN.yaml, REVIEW.yaml, and QA-VERIFY.yaml schemas for phase outputs"
    phase: 1
    depends_on: ["FLOW-002"]
    endpoints: []
    infrastructure: []
    goal: "Define structured phase outputs that minimize token consumption in downstream phases"
    risk_notes: "Schemas must be diff-friendly and human-readable"
    sizing_warning: false

  - id: "FLOW-007"
    title: "Implement Dev Setup Leader"
    feature: "Create dev-setup-leader (Phase 0) to validate story state and create CHECKPOINT/SCOPE artifacts"
    phase: 2
    depends_on: ["FLOW-005"]
    endpoints: []
    infrastructure: []
    goal: "Minimal-read setup phase using haiku model to initialize story workspace"
    risk_notes: "Must correctly infer scope from minimal story frontmatter reads"
    sizing_warning: false

  - id: "FLOW-008"
    title: "Implement Dev Plan Leader"
    feature: "Create dev-plan-leader (Phase 1) to generate PLAN.yaml with knowledge context integration"
    phase: 2
    depends_on: ["FLOW-003", "FLOW-004", "FLOW-006", "FLOW-007"]
    endpoints: []
    infrastructure: []
    goal: "Generate implementation plan referencing ADR constraints and lessons applied"
    risk_notes: "Must correctly invoke knowledge loader and produce actionable PLAN.yaml"
    sizing_warning: false

  - id: "FLOW-009"
    title: "Implement Dev Execute Leader"
    feature: "Create dev-execute-leader (Phase 2) to orchestrate targeted coders and merge into EVIDENCE.yaml"
    phase: 2
    depends_on: ["FLOW-008"]
    endpoints: []
    infrastructure: []
    goal: "Spawn only impacted slice coders and aggregate results into evidence bundle"
    risk_notes: "Complex orchestration logic with multiple workers. High token consumption phase."
    sizing_warning: true

  - id: "FLOW-010"
    title: "Implement Dev Proof Leader"
    feature: "Create dev-proof-leader (Phase 3) to generate PROOF from EVIDENCE.yaml without new reasoning"
    phase: 2
    depends_on: ["FLOW-009"]
    endpoints: []
    infrastructure: []
    goal: "Validate evidence completeness and render proof document using haiku model"
    risk_notes: "Must detect missing AC evidence without reading full story"
    sizing_warning: false

  - id: "FLOW-011"
    title: "Integrate Review/Fix Loop into Dev Flow"
    feature: "Add internal /dev-code-review invocation with fix iteration support in dev-implement-story"
    phase: 2
    depends_on: ["FLOW-010", "FLOW-014"]
    endpoints: []
    infrastructure: []
    goal: "Enable automated review and fix cycles using REVIEW.yaml + EVIDENCE.yaml"
    risk_notes: "Fix loop must not reread story. Requires careful artifact passing."
    sizing_warning: false

  - id: "FLOW-012"
    title: "Implement Review Setup Leader"
    feature: "Create review-setup-leader (Phase 0) to read EVIDENCE/SCOPE and decide which workers to run"
    phase: 3
    depends_on: ["FLOW-004", "FLOW-005"]
    endpoints: []
    infrastructure: []
    goal: "Diff-aware worker selection using haiku model to minimize unnecessary review work"
    risk_notes: "Must correctly interpret SCOPE.yaml to select relevant review workers"
    sizing_warning: false

  - id: "FLOW-013"
    title: "Update Review Workers for Diff-Aware Operation"
    feature: "Modify existing review workers to use touched file lists and output YAML only"
    phase: 3
    depends_on: ["FLOW-012"]
    endpoints: []
    infrastructure: []
    goal: "Convert existing review workers to evidence-first pattern with structured output"
    risk_notes: "Multiple workers to update. Must maintain existing check quality."
    sizing_warning: true

  - id: "FLOW-014"
    title: "Implement Review Aggregate Leader"
    feature: "Create review-aggregate-leader (Phase 2) to merge worker outputs into REVIEW.yaml"
    phase: 3
    depends_on: ["FLOW-013"]
    endpoints: []
    infrastructure: []
    goal: "Produce ranked patch list from worker outputs using haiku model"
    risk_notes: "Must correctly prioritize findings across multiple review dimensions"
    sizing_warning: false

  - id: "FLOW-015"
    title: "Implement QA Verify Setup Leader"
    feature: "Create qa-verify-setup-leader (Phase 0) to validate preconditions and read EVIDENCE/REVIEW"
    phase: 4
    depends_on: ["FLOW-004", "FLOW-006"]
    endpoints: []
    infrastructure: []
    goal: "Minimal-read setup to prepare QA verification workspace using haiku model"
    risk_notes: "Must detect if review passed before allowing QA verification"
    sizing_warning: false

  - id: "FLOW-016"
    title: "Implement QA Verify Verification Leader"
    feature: "Create qa-verify-verification-leader (Phase 1) to verify ACs via EVIDENCE mapping"
    phase: 4
    depends_on: ["FLOW-015"]
    endpoints: []
    infrastructure: []
    goal: "Evidence-first AC verification that only opens detailed files when evidence is missing"
    risk_notes: "Core QA logic phase. Must maintain verification quality while reducing token usage."
    sizing_warning: true

  - id: "FLOW-017"
    title: "Implement QA Verify Completion Leader"
    feature: "Create qa-verify-completion-leader (Phase 2) to update status and trigger KB write-back"
    phase: 4
    depends_on: ["FLOW-016"]
    endpoints: []
    infrastructure: []
    goal: "Finalize QA phase with lesson deduplication and token summary using haiku model"
    risk_notes: "Must correctly dedupe lessons before KB write to avoid noise"
    sizing_warning: false

  - id: "FLOW-018"
    title: "Implement KB Writer Agent"
    feature: "Create kb-writer agent for lesson write-back with deduplication"
    phase: 1
    depends_on: ["FLOW-003"]
    endpoints: []
    infrastructure: []
    goal: "Safely write new learnings to KB without duplicating existing entries"
    risk_notes: "Must query KB to dedupe before writing. Handle KB unavailability gracefully."
    sizing_warning: false

  - id: "FLOW-019"
    title: "Update Dev Command to Use New Leaders"
    feature: "Modify /dev-implement-story command to orchestrate new phase leaders"
    phase: 2
    depends_on: ["FLOW-011"]
    endpoints: []
    infrastructure: []
    goal: "Wire new phase leaders into existing command interface"
    risk_notes: "Must preserve existing command semantics for backward compatibility"
    sizing_warning: false

  - id: "FLOW-020"
    title: "Update Code Review Command to Use New Leaders"
    feature: "Modify /dev-code-review command to orchestrate new phase leaders"
    phase: 3
    depends_on: ["FLOW-014"]
    endpoints: []
    infrastructure: []
    goal: "Wire new phase leaders into existing command interface"
    risk_notes: "Must preserve standalone code review capability"
    sizing_warning: false

  - id: "FLOW-021"
    title: "Update QA Verify Command to Use New Leaders"
    feature: "Modify /qa-verify-story command to orchestrate new phase leaders"
    phase: 4
    depends_on: ["FLOW-017"]
    endpoints: []
    infrastructure: []
    goal: "Wire new phase leaders into existing command interface"
    risk_notes: "Must preserve existing QA verification semantics"
    sizing_warning: false

  - id: "FLOW-022"
    title: "End-to-End Integration Testing"
    feature: "Test full workflow from /dev-implement-story through /qa-verify-story with new artifacts"
    phase: 4
    depends_on: ["FLOW-019", "FLOW-020", "FLOW-021"]
    endpoints: []
    infrastructure: []
    goal: "Validate complete refactored workflow produces correct artifacts and reduces token usage"
    risk_notes: "Integration testing across all phases. May reveal unforeseen edge cases."
    sizing_warning: true

dependencies:
  graph:
    "FLOW-001": []
    "FLOW-002": ["FLOW-001"]
    "FLOW-003": ["FLOW-002"]
    "FLOW-004": ["FLOW-002"]
    "FLOW-005": ["FLOW-002"]
    "FLOW-006": ["FLOW-002"]
    "FLOW-007": ["FLOW-005"]
    "FLOW-008": ["FLOW-003", "FLOW-004", "FLOW-006", "FLOW-007"]
    "FLOW-009": ["FLOW-008"]
    "FLOW-010": ["FLOW-009"]
    "FLOW-011": ["FLOW-010", "FLOW-014"]
    "FLOW-012": ["FLOW-004", "FLOW-005"]
    "FLOW-013": ["FLOW-012"]
    "FLOW-014": ["FLOW-013"]
    "FLOW-015": ["FLOW-004", "FLOW-006"]
    "FLOW-016": ["FLOW-015"]
    "FLOW-017": ["FLOW-016"]
    "FLOW-018": ["FLOW-003"]
    "FLOW-019": ["FLOW-011"]
    "FLOW-020": ["FLOW-014"]
    "FLOW-021": ["FLOW-017"]
    "FLOW-022": ["FLOW-019", "FLOW-020", "FLOW-021"]

  critical_path:
    - "FLOW-001"
    - "FLOW-002"
    - "FLOW-005"
    - "FLOW-007"
    - "FLOW-008"
    - "FLOW-009"
    - "FLOW-010"
    - "FLOW-014"
    - "FLOW-011"
    - "FLOW-019"
    - "FLOW-020"
    - "FLOW-021"
    - "FLOW-022"

  critical_path_length: 13

parallelization:
  max_parallel: 4
  groups:
    - stories: ["FLOW-001"]
      after: null
    - stories: ["FLOW-002"]
      after: "group_1"
    - stories: ["FLOW-003", "FLOW-004", "FLOW-005", "FLOW-006"]
      after: "group_2"
    - stories: ["FLOW-007", "FLOW-012", "FLOW-018"]
      after: "group_3"
    - stories: ["FLOW-008", "FLOW-013"]
      after: "group_4"
    - stories: ["FLOW-009", "FLOW-014", "FLOW-015"]
      after: "group_5"
    - stories: ["FLOW-010", "FLOW-016"]
      after: "group_6"
    - stories: ["FLOW-011", "FLOW-017"]
      after: "group_7"
    - stories: ["FLOW-019", "FLOW-020", "FLOW-021"]
      after: "group_8"
    - stories: ["FLOW-022"]
      after: "group_9"

risks:
  - id: "RISK-001"
    description: "Story context re-reading across agents consumes 30-40% of tokens per story"
    affected_stories: ["FLOW-008", "FLOW-009", "FLOW-016"]
    severity: high
    mitigation: "New architecture must implement context passing between phase leaders to avoid redundant reads"

  - id: "RISK-002"
    description: "Evidence bundle schema too verbose could negate token savings"
    affected_stories: ["FLOW-004", "FLOW-009", "FLOW-016"]
    severity: high
    mitigation: "Design EVIDENCE.yaml to be concise with references to detailed files rather than inline content"

  - id: "RISK-003"
    description: "Knowledge context loader KB dependency may fail in environments without KB tools"
    affected_stories: ["FLOW-003", "FLOW-008", "FLOW-016", "FLOW-018"]
    severity: medium
    mitigation: "Implement silent fallback to local LESSONS-LEARNED.md and ADR-LOG.md when KB unavailable"

  - id: "RISK-004"
    description: "Diff-aware worker selection complexity may miss required review checks"
    affected_stories: ["FLOW-012", "FLOW-013"]
    severity: medium
    mitigation: "Maintain conservative worker selection initially; optimize after validation"

  - id: "RISK-005"
    description: "Multiple complex orchestration stories increase implementation complexity"
    affected_stories: ["FLOW-009", "FLOW-013", "FLOW-016", "FLOW-022"]
    severity: medium
    mitigation: "Mark stories with sizing_warning and consider splitting if scope becomes unmanageable"

  - id: "RISK-006"
    description: "Backward compatibility with existing command interface may constrain optimization"
    affected_stories: ["FLOW-019", "FLOW-020", "FLOW-021"]
    severity: low
    mitigation: "Commands become thin wrappers over new leaders; internal refactor should not affect external interface"

  - id: "RISK-007"
    description: "Migration path must keep workflow operational during incremental refactor"
    affected_stories: ["FLOW-002", "FLOW-019", "FLOW-020", "FLOW-021"]
    severity: high
    mitigation: "Redesign proposal must include step-by-step migration that maintains working system"

metrics:
  total_stories: 22
  phases: 5
  max_parallel: 4
  critical_path_length: 13
  stories_with_sizing_warnings: 4
  stories_by_phase:
    phase_0: 2
    phase_1: 5
    phase_2: 7
    phase_3: 4
    phase_4: 4
