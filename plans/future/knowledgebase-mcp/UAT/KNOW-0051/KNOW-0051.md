---
story_id: KNOW-0051
title: "MCP Server Foundation + CRUD Tools"
status: uat
split_from: KNOW-005
split_part: 1 of 3
created: 2026-01-25
updated: 2026-01-25
assignee: null
story_points: 5
priority: P0
depends_on: []
blocks: [KNOW-0052, KNOW-0053, KNOW-006, KNOW-007, KNOW-008, KNOW-009, KNOW-010]
tags:
  - knowledge-base
  - mcp
  - backend
  - infrastructure
---

# KNOW-0051: MCP Server Foundation + CRUD Tools

## Split Context

This story is part of a split from KNOW-005 (MCP Server Setup).

- **Original Story:** KNOW-005
- **Split Reason:** Story exceeded sizing guidelines with 10 acceptance criteria and 10 tools. Split to reduce complexity and enable parallel development.
- **This Part:** 1 of 3 (Foundation - must complete before other splits)
- **Dependency:** No dependencies (KNOW-003 already completed)
- **Unblocks:** KNOW-0052 (Search Tools), KNOW-0053 (Admin Tool Stubs), and downstream stories

## Context

The knowledge base infrastructure (KNOW-001), embedding client (KNOW-002), CRUD operations (KNOW-003), and search implementation (KNOW-004) are complete. This story establishes the foundational MCP server infrastructure that will expose knowledge base functionality to AI agents via the Model Context Protocol.

MCP is a protocol that allows Claude Code to discover and invoke tools provided by external servers. This story focuses on the core MCP server setup and the 5 basic CRUD tools (kb_add, kb_get, kb_update, kb_delete, kb_list).

**Key Architectural Decisions:**
- MCP server acts as a thin adapter layer (Ports & Adapters pattern)
- Tool handlers are thin wrappers around existing CRUD functions from KNOW-003
- Zod schemas are the single source of truth for input validation
- Tool schemas generated programmatically from Zod (no manual duplication)
- Error sanitization layer protects sensitive information
- All logging via @repo/logger (no console.log)

## Goal

Configure MCP server using @modelcontextprotocol/sdk, register 5 basic CRUD tools with schemas, implement handlers, and integrate @repo/logger to establish the foundational infrastructure for all MCP tools.

**Primary deliverables:**
1. MCP server setup with @modelcontextprotocol/sdk
2. Tool schema generation from Zod via zod-to-json-schema
3. Tool registration for 5 CRUD operations
4. Tool handler implementations (thin wrappers around KNOW-003 functions)
5. Error sanitization layer for secure error handling
6. Environment validation and connectivity checks
7. Integration test harness simulating MCP client
8. Graceful shutdown handling
9. Tool discovery metadata with descriptions

## Non-Goals

- ❌ Search tools (kb_search, kb_get_related) - defer to KNOW-0052
- ❌ Admin tools (kb_bulk_import, kb_rebuild_embeddings, kb_stats, kb_health) - defer to KNOW-0053
- ❌ Deployment topology documentation - defer to KNOW-0052
- ❌ Performance benchmarking - defer to KNOW-0052
- ❌ Authentication/authorization - defer to KNOW-009
- ❌ Rate limiting - defer to KNOW-010
- ❌ AWS deployment (MCP server runs locally for MVP)

## Scope

### Packages Affected

**Primary:**
- `apps/api/knowledge-base/src/mcp-server/` (new directory)
  - `server.ts` - MCP server initialization and lifecycle
  - `tool-handlers.ts` - Tool handler implementations for 5 CRUD tools
  - `tool-schemas.ts` - MCP tool schema definitions (generated from Zod)
  - `error-handling.ts` - Error sanitization layer
  - `index.ts` - Entry point for MCP server process
  - `__tests__/` - Integration test suite
    - `mcp-integration.test.ts` - Full MCP protocol tests
    - `tool-handlers.test.ts` - Tool handler unit tests
    - `error-handling.test.ts` - Error sanitization tests
    - `test-helpers.ts` - Test fixtures and MCP client mock

**Secondary:**
- `apps/api/knowledge-base/package.json` - Add @modelcontextprotocol/sdk, zod-to-json-schema
- `apps/api/knowledge-base/src/crud-operations/index.ts` - Ensure exports for MCP handlers
- `~/.claude/mcp.json` - Register knowledge-base server (user config, not in repo)

### MCP Tools Implemented (5 CRUD Tools)

**1. kb_add** - Add knowledge entry
```typescript
kb_add({
  content: string,
  role: 'pm' | 'dev' | 'qa' | 'all',
  tags?: string[] | null
})
// Returns: UUID string
```

**2. kb_get** - Retrieve entry by ID
```typescript
kb_get({
  id: string
})
// Returns: KnowledgeEntry | null
```

**3. kb_update** - Update entry
```typescript
kb_update({
  id: string,
  content?: string,
  role?: 'pm' | 'dev' | 'qa' | 'all',
  tags?: string[] | null
})
// Returns: KnowledgeEntry
```

**4. kb_delete** - Delete entry (idempotent)
```typescript
kb_delete({
  id: string
})
// Returns: void
```

**5. kb_list** - List entries with filters
```typescript
kb_list({
  role?: 'pm' | 'dev' | 'qa' | 'all',
  tags?: string[],
  limit?: number
})
// Returns: KnowledgeEntry[]
```

### Database Tables

**Read-only operations:**
- All MCP tools operate via existing CRUD functions from KNOW-003
- No direct database queries in MCP layer
- Database access delegated to CRUD modules

## Acceptance Criteria

### AC1: MCP Server Registration and Discovery

**Given** Claude Code is installed and configured
**When** MCP server is registered in `~/.claude/mcp.json`
**Then**:
- ✅ Server entry includes command, args, and environment variables
- ✅ Claude Code discovers knowledge-base server at startup
- ✅ All 5 kb_* CRUD tools appear in Claude Code tool list
- ✅ Tool descriptions are clear and actionable
- ✅ Tool discovery metadata includes descriptions and usage examples

**Example `~/.claude/mcp.json` configuration:**
```json
{
  "mcpServers": {
    "knowledge-base": {
      "command": "node",
      "args": ["dist/mcp-server/index.js"],
      "cwd": "${workspaceFolder}/apps/api/knowledge-base",
      "env": {
        "DATABASE_URL": "postgresql://postgres:postgres@localhost:5432/knowledge_base",
        "OPENAI_API_KEY": "sk-..."
      }
    }
  }
}
```

---

### AC2: Tool Schema Generation from Zod

**Given** Zod schemas exist for all CRUD operations
**When** MCP tool schemas are generated
**Then**:
- ✅ Use `zod-to-json-schema` library to convert Zod schemas to JSON Schema
- ✅ MCP tool schemas match Zod validation schemas exactly
- ✅ No manual schema duplication
- ✅ Single source of truth for all input validation
- ✅ Tool schema versioning policy documented (SemVer for breaking changes)

---

### AC3: Tool Handlers Wrap Existing Functions

**Given** CRUD operations (KNOW-003) are implemented
**When** MCP tool handlers are implemented
**Then**:
- ✅ Each tool handler calls corresponding CRUD function
- ✅ Tool handlers add logging (tool invocation, success, error)
- ✅ Tool handlers sanitize errors before returning to client
- ✅ Tool handlers measure and log query_time_ms
- ✅ No business logic in tool handlers (thin adapter layer)
- ✅ Retry policy documented for transient vs permanent failures

**Example tool handler structure:**
```typescript
async function kb_add_handler(input: KbAddInput): Promise<string> {
  const startTime = Date.now()
  logger.info('kb_add tool invoked', { role: input.role, tags: input.tags })

  try {
    const entryId = await kb_add(input, { db, embeddingClient })
    const elapsed = Date.now() - startTime
    logger.info('kb_add succeeded', { entry_id: entryId, query_time_ms: elapsed })
    return entryId
  } catch (error) {
    logger.error('kb_add failed', { error, input })
    throw sanitizeError(error)
  }
}
```

---

### AC4: Error Sanitization Layer

**Given** errors occur during tool execution
**When** errors are returned to MCP client
**Then**:
- ✅ Zod validation errors include field name and constraint violated
- ✅ Database errors sanitized (no SQL, no connection strings)
- ✅ OpenAI API errors sanitized (no API keys, include retry context)
- ✅ Full errors logged server-side at error level
- ✅ Structured error format: `{ code: string, message: string, field?: string }`

**Error code conventions:**
- `VALIDATION_ERROR` - Zod validation failure
- `NOT_FOUND` - Resource not found (kb_update, kb_get non-existent)
- `DATABASE_ERROR` - Database connection or query failure
- `API_ERROR` - OpenAI API failure
- `INTERNAL_ERROR` - Unhandled exception

---

### AC5: Logging with @repo/logger

**Given** all tool invocations are logged
**When** reviewing log output
**Then**:
- ✅ Log at `info` level: Tool name, input parameters (sanitized), result count, query_time_ms
- ✅ Log at `warn` level: Retries, degraded performance
- ✅ Log at `error` level: All failures with full error context
- ✅ Log at `debug` level: Internal details (embedding generation, query execution)
- ✅ No `console.log` usage
- ✅ Sensitive data sanitization rules applied (truncate content > 200 chars, redact API keys)
- ✅ Logger writes to stderr, not stdout (MCP protocol compliance)

**Example log output:**
```
[INFO] kb_add tool invoked: { role: "dev", tags: ["validation"], content_length: 150 }
[INFO] kb_add succeeded: { entry_id: "uuid-123", query_time_ms: 1234 }
```

---

### AC6: Environment Variable Validation

**Given** MCP server starts
**When** validating environment
**Then**:
- ✅ `DATABASE_URL` must be set and valid PostgreSQL connection string
- ✅ `OPENAI_API_KEY` must be set and non-empty
- ✅ Database connectivity verified at startup
- ✅ OpenAI API connectivity verified at startup (simple health check)
- ✅ Fail fast with descriptive error if env vars missing or connectivity fails
- ✅ Log environment validation at startup (info level)

---

### AC7: Integration Test Harness

**Given** integration tests are executed
**When** simulating MCP client
**Then**:
- ✅ Test harness simulates MCP JSON-RPC protocol over stdio
- ✅ Test harness sends tool invocation requests
- ✅ Test harness receives and validates responses
- ✅ At least 2-3 end-to-end tests via MCP protocol (smoke tests)
- ✅ Remaining tests call tool handlers directly (faster, simpler)
- ✅ MCP client library created for testing (enables local dev without full Claude Code)

**Test coverage:**
- Happy path: All 5 CRUD tools invoked successfully
- Error cases: Validation errors, database errors, API errors
- Edge cases: Concurrent invocations, large content, server restart

---

### AC8: Graceful Shutdown Handling

**Given** MCP server receives shutdown signal (SIGTERM)
**When** shutting down
**Then**:
- ✅ Shutdown timeout configurable (default 30s)
- ✅ In-flight tool invocations complete or timeout gracefully
- ✅ Database connections closed cleanly
- ✅ Shutdown logged at info level
- ✅ No data corruption on shutdown

---

### AC9: Test Coverage

**Given** test suite is executed
**When** measuring coverage
**Then**:
- ✅ Minimum 80% line coverage for `mcp-server/` directory
- ✅ All happy path scenarios tested (5 tools × basic invocation)
- ✅ All error cases tested (validation, not found, API failure, database failure)
- ✅ Edge cases tested (concurrent invocations, large content, server restart)
- ✅ Integration tests verify MCP protocol communication
- ✅ Unit tests verify tool handler logic

---

## Reuse Plan

### Reusing from Existing Packages

**1. CRUD Operations (KNOW-003)**
- Location: `apps/api/knowledge-base/src/crud-operations`
- Usage: All kb_add, kb_get, kb_update, kb_delete, kb_list tools
- Benefits: Proven implementation, full test coverage (93.94%)

**2. EmbeddingClient (KNOW-002)**
- Usage: Via CRUD operations (no direct usage in MCP layer)
- Benefits: Content-hash caching, retry logic, batch processing

**3. @repo/logger**
- Location: `packages/core/logger`
- Usage: All logging in MCP server
- Benefits: Structured logging, consistent format

**4. Zod Schemas**
- Location: `apps/api/knowledge-base/src/__types__`
- Usage: Input validation for all tools
- Benefits: Runtime validation, type safety

**5. Drizzle ORM**
- Usage: Via CRUD operations (no direct usage in MCP layer)
- Benefits: Type-safe database queries

### New Dependencies Required

**1. @modelcontextprotocol/sdk**
- Purpose: MCP server implementation
- Version: Latest stable (^1.0.0)
- Install: `pnpm add @modelcontextprotocol/sdk`

**2. zod-to-json-schema**
- Purpose: Convert Zod schemas to JSON Schema for MCP tools
- Version: Latest stable (^3.0.0)
- Install: `pnpm add zod-to-json-schema`

---

## Architecture Notes

### Ports & Adapters Pattern

```
┌──────────────────────────────────────────────────────────────────┐
│                       Claude Code (Client)                        │
└──────────────────────────────────────────────────────────────────┘
                              ↓ (stdio)
┌──────────────────────────────────────────────────────────────────┐
│                    MCP Server (Adapter Layer)                     │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              Tool Handlers (5 CRUD tools)                   │ │
│  │  - Input validation (Zod)                                   │ │
│  │  - Error sanitization                                       │ │
│  │  - Logging                                                  │ │
│  │  - Performance measurement                                  │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              ↓
              ┌─────────────────────────────┐
              │    CRUD Operations          │
              │     (KNOW-003)              │
              └─────────────────────────────┘
                              ↓
         ┌─────────────────────────────────────────┐
         │     Database (PostgreSQL + pgvector)    │
         │     EmbeddingClient (OpenAI API)        │
         └─────────────────────────────────────────┘
```

### MCP Server Lifecycle

**Startup:**
1. Claude Code reads `~/.claude/mcp.json`
2. Spawns MCP server subprocess with command and environment
3. Server initializes: validates env vars, connects to database, checks OpenAI connectivity
4. Server registers 5 CRUD tools with MCP SDK
5. Server listens for JSON-RPC messages on stdin

**Tool Invocation:**
1. Claude Code sends JSON-RPC request via stdin
2. MCP SDK deserializes request and validates schema
3. Tool handler executes (validates with Zod, calls CRUD, logs, sanitizes errors)
4. MCP SDK serializes response
5. Server sends JSON-RPC response via stdout

**Shutdown:**
1. Claude Code sends shutdown signal (SIGTERM)
2. Server waits for in-flight requests (30s timeout)
3. Server closes database connections
4. Server exits gracefully

---

## Infrastructure Notes

### No New Infrastructure Required

All infrastructure provisioned in KNOW-001:
- PostgreSQL with pgvector extension (Docker Compose)
- Database schema with all necessary indexes
- Connection pooling configured

### Configuration

**Environment variables:**
```bash
# Required
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/knowledge_base
OPENAI_API_KEY=sk-...

# Optional (sensible defaults)
DB_POOL_SIZE=5              # Max connections per MCP server instance
SHUTDOWN_TIMEOUT_MS=30000   # Graceful shutdown timeout
```

**MCP Server Registration:**
Create or update `~/.claude/mcp.json`:
```json
{
  "mcpServers": {
    "knowledge-base": {
      "command": "node",
      "args": ["dist/mcp-server/index.js"],
      "cwd": "/absolute/path/to/apps/api/knowledge-base",
      "env": {
        "DATABASE_URL": "postgresql://postgres:postgres@localhost:5432/knowledge_base",
        "OPENAI_API_KEY": "sk-..."
      }
    }
  }
}
```

**Security notes for mcp.json:**
- File permissions: chmod 600 (user read/write only)
- Never commit to git
- Use environment variable references where possible
- Document secrets management migration path (KNOW-011 deferred)

---

## Test Plan

### Test Coverage Summary

**Scope:**
- MCP server setup and lifecycle
- 5 MCP CRUD tools
- Tool handler logic (validation, logging, error sanitization)
- Integration with CRUD (KNOW-003)

**Test Files:**
```
apps/api/knowledge-base/src/mcp-server/__tests__/
  mcp-integration.test.ts    # Full MCP protocol tests (end-to-end)
  tool-handlers.test.ts      # Tool handler unit tests
  error-handling.test.ts     # Error sanitization tests
  test-helpers.ts            # Test fixtures and MCP client mock
```

**Coverage targets:**
- Unit tests: >80% coverage for mcp-server/ directory
- Integration tests: All happy paths, error cases, edge cases
- MCP protocol tests: 2-3 smoke tests via actual MCP communication

### Happy Path Tests (5)

1. **kb_add Tool Invocation** - Add entry and verify UUID returned
2. **kb_get Tool Invocation** - Retrieve entry and verify all fields present
3. **kb_update Tool** - Update entry and verify content/tags changed
4. **kb_delete Tool** - Delete entry and verify idempotency
5. **kb_list Tool with Tag Filter** - List with tag filter and verify ordering

### Error Cases (6)

1. **MCP Tool Validation Failure** - Empty content rejected with Zod error
2. **OpenAI API Unavailable** - kb_add fails after retries, no DB write
3. **Database Connection Failure** - Sanitized error returned
4. **Invalid MCP Tool Schema** - Invalid role enum rejected
5. **MCP Server Not Running** - Claude Code reports unavailable
6. **Tool Handler Exception** - 500 error logged, sanitized message returned

### Edge Cases (7)

1. **Large Content (10k characters)** - kb_add succeeds, performance < 5s
2. **Concurrent Tool Invocations** - 10 parallel kb_add calls succeed
3. **Special Characters in Content** - Regex special chars handled correctly
4. **Null vs Undefined Tags** - kb_add with `tags: null` succeeds
5. **Empty Result Set** - kb_list with no matches returns empty array
6. **kb_update with No Changes** - Succeeds without re-embedding
7. **MCP Server Restart During Tool Call** - Graceful error, no corruption

---

## Risks and Mitigations

### Risk 1: MCP SDK Integration Complexity

**Risk**: @modelcontextprotocol/sdk has limited documentation. Integration patterns may require experimentation.

**Mitigation**:
- Review official MCP SDK examples
- Start with simplest tool (kb_get)
- Test incrementally
- Document all usage patterns in code comments

---

### Risk 2: Tool Schema Validation Mismatch

**Risk**: MCP tool schemas must match Zod input schemas exactly. Manual duplication risks drift.

**Mitigation**:
- Generate MCP schemas programmatically from Zod (AC2)
- Integration test verifies schema parity
- Single source of truth for all schemas

---

### Risk 3: Error Serialization Across MCP Boundary

**Risk**: Stack traces, Zod errors, database errors must serialize correctly. Unknown whether MCP SDK handles consistently.

**Mitigation**:
- Implement error sanitization layer (AC4)
- Log full errors server-side
- Test all error cases (6 error tests)

---

### Risk 4: Environment Connectivity at Startup

**Risk**: Database or OpenAI API may be unavailable when MCP server starts.

**Mitigation**:
- Add connectivity checks at startup (AC6)
- Fail fast with descriptive error
- Document troubleshooting steps

---

## Definition of Done

- [ ] MCP server setup with @modelcontextprotocol/sdk
- [ ] All 5 CRUD tools registered with JSON Schema definitions
- [ ] Tool handlers implemented (thin adapter layer)
- [ ] Error sanitization layer working
- [ ] Logging with @repo/logger (no console.log)
- [ ] Environment variable validation at startup
- [ ] Database and OpenAI connectivity checks at startup
- [ ] MCP server registered in `~/.claude/mcp.json` (documented in README)
- [ ] Integration test harness simulating MCP client
- [ ] Test suite passing with ≥80% coverage
- [ ] All happy path tests passing (5 tests)
- [ ] All error case tests passing (6 tests)
- [ ] All edge case tests passing (7 tests)
- [ ] Graceful shutdown handling implemented
- [ ] Tool schema versioning policy documented
- [ ] Sensitive data sanitization rules documented
- [ ] Retry policy documented
- [ ] mcp.json security best practices documented
- [ ] TypeScript compilation clean (no errors)
- [ ] Code follows monorepo conventions (Zod-first types, no barrel files)
- [ ] PROOF-KNOW-0051.md document created with evidence
- [ ] Story status updated to "ready-for-code-review"

---

## Related Stories

- **KNOW-003**: Core CRUD Operations (prerequisite ✅)
- **KNOW-0052**: MCP Search Tools + Deployment Topology (depends on KNOW-0051)
- **KNOW-0053**: MCP Admin Tool Stubs (depends on KNOW-0051)
- **KNOW-006**: Parsers and Seeding (blocked by KNOW-0051)
- **KNOW-007**: Admin Tools and Polish (blocked by KNOW-0051)
- **KNOW-008**: Workflow Integration (blocked by KNOW-0051)
- **KNOW-009**: MCP Tool Authorization (blocked by KNOW-0051)
- **KNOW-010**: API Rate Limiting (blocked by KNOW-0051)

---

## Agent Log

| Timestamp | Agent | Action | Notes |
|-----------|-------|--------|-------|
| 2026-01-25 | pm-story-split-leader | Story created from split | Split from KNOW-005 due to sizing issues |

---

## Token Budget

Phase tracking will be added during implementation.

<!-- Token usage will be logged here via /token-log command -->

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-25_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | stdout/stderr separation for MCP protocol compliance | Add as AC | Document that logger must write to stderr, not stdout, to avoid interfering with JSON-RPC messages on stdout. Integrate into AC5. |
| 2 | Tool schema versioning policy (SemVer) | Add as AC | Document patch for description changes, minor for new optional fields, major for breaking changes. Integrate into AC2. |
| 3 | Retry policy documentation | Add as AC | Document when to retry (transient DB/API errors) vs fail fast (validation errors, not found). Integrate into AC3. |
| 4 | Sensitive data sanitization rules for logging | Add as AC | Document rules: truncate content > 200 chars in logs, redact API keys, mask connection strings. Integrate into AC5. |
| 5 | Shutdown timeout (configurable, default 30s) | Add as AC | Specify configurable shutdown timeout in AC8 environment variables. |
| 6 | Tool discovery metadata (descriptions, examples) | Add as AC | MCP protocol supports tool descriptions and usage examples in discovery. Integrate into AC1. |
| 7 | mcp.json security documentation | Add as AC | Document file permissions (chmod 600), never commit to git, environment variable references. Integrate into Infrastructure Notes. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | MCP client library/mock for testing | Add as AC | Create reusable MCP client mock in test-helpers.ts. Enables developers to test tools without running full MCP server. Integrate into AC7. |
| 2 | Tool composition documentation | Add as AC | Document whether kb_search could internally call kb_get_related. Out of scope for foundation but worth noting. Add to Architecture Notes. |
| 3 | Performance baseline tests (p50/p95 latency) | Add as AC | Basic performance baseline tests to enable regression detection in KNOW-0052. Integrate into Test Plan. |
| 4 | Correlation IDs for multi-tool workflows | Add as AC | Add correlation ID to logging context to trace multi-tool workflows. Enables better debugging of complex agent interactions. Integrate into AC5. |
| 5 | Per-tool timeout configuration | Add as AC | Per-tool timeout configuration to prevent slow tools from blocking other requests. Add to Infrastructure Notes and AC6. |
| 6 | MCP protocol error edge case tests | Add as AC | Test malformed JSON-RPC messages, invalid tool names, schema mismatches. Ensures robust error handling. Integrate into Test Plan error cases. |
| 7 | Connection pooling strategy validation | Add as AC | Document and validate DB connection pooling strategy for MCP server instances. Integrate into AC6. |

### Follow-up Stories Suggested

- [ ] KNOW-0052 (MCP Search Tools + Deployment Topology) - blocked by KNOW-0051 completion
- [ ] KNOW-0053 (MCP Admin Tool Stubs) - blocked by KNOW-0051 completion
- [ ] KNOW-006 (Parsers and Seeding) - blocked by KNOW-0051 completion

### Items Marked Out-of-Scope

- **Deployment topology documentation**: Clarify whether MCP server is single instance or per-session. Resources limits and scaling implications. Defer to KNOW-0052 (beyond foundation scope).
