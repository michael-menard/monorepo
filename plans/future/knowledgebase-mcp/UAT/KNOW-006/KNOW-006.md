---
story_id: KNOW-006
title: "Parsers and Seeding"
status: uat
created: 2026-01-25
updated: 2026-01-25
assignee: null
story_points: 8
priority: P1
depends_on: []
blocks: [KNOW-007]
tags:
  - knowledge-base
  - parsers
  - seeding
  - bulk-import
  - mcp-tools
---

# KNOW-006: Parsers and Seeding

## Context

The knowledge base infrastructure (KNOW-001), embedding client (KNOW-002), CRUD operations (KNOW-003), and MCP server foundation (KNOW-0051) are complete. We have the capability to add individual knowledge entries, but we need to populate the knowledge base with existing organizational knowledge from markdown files and structured YAML data.

Two key sources exist and are ready for import:
1. **LESSONS-LEARNED.md** - Contains validated learnings from completed stories (token optimization, backend patterns, testing patterns, etc.)
2. **seed-data.yaml** - Structured knowledge base entries with content, roles, tags, and metadata

This story implements parsers to extract knowledge from these sources and bulk import functionality to efficiently populate the knowledge base with minimal OpenAI API costs through batch processing and embedding cache reuse.

## Goal

Build parsers and seeding infrastructure to populate the knowledge base:

1. **Parse LESSONS-LEARNED.md** - Extract atomic learnings from markdown format
2. **Parse seed-data.yaml** - Extract structured knowledge entries from YAML format
3. **Implement kb_bulk_import** - MCP tool for batch importing knowledge entries
4. **Implement kb_stats** - MCP tool for knowledge base statistics
5. **CLI seeding scripts** - Convenience wrappers for one-time imports

All functionality must:
- Use Zod validation for parsed data
- Handle malformed input gracefully with clear error messages
- Leverage EmbeddingClient batch processing for performance
- Support partial import success with detailed error reporting
- Log progress and statistics

## Non-Goals

- ❌ Semantic search functionality (KNOW-004 - already complete)
- ❌ Advanced statistics or analytics (KNOW-019)
- ❌ Web-based management UI (KNOW-024)
- ❌ Automatic format detection (only support documented formats)
- ❌ Incremental/streaming parsing (parse entire file in memory)
- ❌ Content transformation or cleanup (import as-is)
- ❌ Resume capability for interrupted imports (manual retry)
- ❌ CLI progress bars or interactive prompts (structured logging only)
- ❌ Duplicate content merging (allow duplicates, rely on embedding cache)
- ❌ Real-time embedding cost tracking (estimate only)

## Scope

### Packages Affected

**Primary (new directories):**
- `apps/api/knowledge-base/src/parsers/`
  - `parse-lessons-learned.ts` - Markdown parser
  - `parse-seed-yaml.ts` - YAML parser
  - `__types__/index.ts` - Zod schemas for parsed data
  - `__tests__/parse-lessons-learned.test.ts`
  - `__tests__/parse-seed-yaml.test.ts`
  - `index.ts` - Barrel exports

- `apps/api/knowledge-base/src/seed/`
  - `kb-bulk-import.ts` - Bulk import implementation
  - `__types__/index.ts` - Zod schemas for import results
  - `__tests__/kb-bulk-import.test.ts`
  - `index.ts`

**Modified files:**
- `apps/api/knowledge-base/src/mcp-server/tool-schemas.ts` - Add kb_bulk_import and kb_stats tool schemas
- `apps/api/knowledge-base/src/mcp-server/tool-handlers.ts` - Add handler implementations
- `apps/api/knowledge-base/src/__types__/index.ts` - Add shared types if needed

**Optional CLI scripts:**
- `apps/api/knowledge-base/scripts/seed-from-yaml.ts` - CLI wrapper for YAML import
- `apps/api/knowledge-base/scripts/seed-from-lessons.ts` - CLI wrapper for LESSONS-LEARNED import

### Database Tables

- `knowledge_entries` (write via kb_add)
- `embedding_cache` (read/write via EmbeddingClient)

### External Dependencies

- OpenAI API (via EmbeddingClient)
- PostgreSQL with pgvector extension
- `js-yaml` library for YAML parsing

## Acceptance Criteria

### AC1: Parse YAML Seed Data

**Given** a valid seed-data.yaml file
**When** `parseSeedYaml(content)` is called
**Then**:
- ✅ Parses YAML into structured array of entries
- ✅ Validates each entry with Zod schema
- ✅ Required fields: `content` (string), `roles` (array), `tags` (array)
- ✅ Optional fields: `id`, `entry_type`, `source_file`, `confidence`
- ✅ Returns array matching `ParsedEntrySchema[]`
- ✅ Throws YAMLParseError for malformed YAML with line number
- ✅ Throws ValidationError for missing required fields with entry reference
- ✅ Handles multi-line content strings correctly
- ✅ Handles special characters (quotes, unicode, emoji) correctly

**Signature:**
```typescript
function parseSeedYaml(content: string): ParsedEntry[]
```

**Field Mapping:**
- `id` → ignored (UUID auto-generated by kb_add)
- `content` → mapped directly
- `entry_type` → stored as tag (e.g., `'type:fact'`)
- `roles: [dev, pm]` → create separate entry for each role
- `tags` → merged with entry_type and source_file tags
- `source_file` → stored as tag (e.g., `'source:seed-data.yaml'`)
- `confidence` → ignored for MVP

---

### AC2: Parse LESSONS-LEARNED.md

**Given** LESSONS-LEARNED.md with documented structure
**When** `parseLessonsLearned(content)` is called
**Then**:
- ✅ Parses markdown sections with level-2 headings (`## Story XXX`)
- ✅ Extracts learnings from bullet points under each section
- ✅ Infers role from section context (e.g., "Backend Patterns" → 'dev')
- ✅ Extracts tags from content keywords
- ✅ Sets `source_file: 'LESSONS-LEARNED.md'` for all entries
- ✅ Returns array matching `ParsedEntrySchema[]`
- ✅ Handles markdown edge cases (code blocks, special chars, nested lists)
- ✅ Logs warnings for unparseable sections (continue parsing)
- ✅ Returns empty array for empty or invalid markdown

**Signature:**
```typescript
function parseLessonsLearned(content: string): ParsedEntry[]
```

**Expected Structure:**
```markdown
## Category Name
- Learning point 1
- Learning point 2

## Another Category
- Learning point 3
```

---

### AC3: kb_bulk_import - Bulk Import Entries

**Given** array of parsed knowledge entries
**When** `kb_bulk_import({ entries })` is called
**Then**:
- ✅ Validates input with Zod schema
- ✅ Processes entries in batches (leverage EmbeddingClient batch processing)
- ✅ For each entry, calls kb_add with content, role, tags
- ✅ Generates embeddings using EmbeddingClient (with caching)
- ✅ Handles duplicate content: allows multiple entries, embedding cached
- ✅ Returns detailed summary:
  ```typescript
  {
    total: number
    succeeded: number
    failed: number
    duplicates_skipped: number  // if deduplication implemented
    errors: Array<{ index: number, reason: string }>
  }
  ```
- ✅ Supports partial success: continues importing after errors
- ✅ Logs progress every 100 entries
- ✅ Logs estimated cost before starting (chars/4 × $0.00002 per 1k tokens)
- ✅ Logs actual import time and entries/second rate
- ✅ Enforces max 1000 entries per call (throws ValidationError if exceeded)

**Signature:**
```typescript
async function kb_bulk_import(input: {
  entries: ParsedEntry[]
}): Promise<BulkImportSummary>
```

**Performance Targets:**
- <5 seconds per 10 entries (including embedding generation)
- ~0.3-0.5s per entry average
- Progress logging for imports >100 entries

---

### AC4: kb_bulk_import - Error Handling

**Given** bulk import with failing entries
**When** errors occur during import
**Then**:
- ✅ OpenAI API failures: retry via EmbeddingClient, log failure, continue
- ✅ Validation failures: log error with entry index, skip entry, continue
- ✅ Database errors: log error, skip entry, continue
- ✅ Returns partial success summary with all errors listed
- ✅ Each error includes: `{ index, reason, entry_id_if_known }`
- ✅ Logs errors at ERROR level with @repo/logger
- ✅ No partial database writes (entry either fully imported or skipped)

**Rollback Behavior:**
- Partial success is acceptable (default)
- Entries 0-(N-1) committed, entry N failed, entries N+1-end attempted
- Future enhancement: `--rollback-on-error` flag for all-or-nothing

---

### AC5: kb_stats - Knowledge Base Statistics

**Given** populated knowledge base
**When** `kb_stats({})` is called
**Then**:
- ✅ Queries database for aggregated statistics
- ✅ Returns JSON with exact schema:
  ```typescript
  {
    total_entries: number
    by_role: {
      pm: number
      dev: number
      qa: number
      all: number
    }
    total_tags: number        // count of unique tags across all entries
    cache_entries: number     // count of embedding_cache entries
    database_size_mb: number  // approximate database size
  }
  ```
- ✅ Performance: <500ms query time
- ✅ Uses optimized SQL with proper indexes
- ✅ Logs query at DEBUG level

**Signature:**
```typescript
async function kb_stats(input: {}): Promise<StatsResponse>
```

**Out of Scope for MVP:**
- Cache hit/miss rate (requires tracking not yet implemented)
- Query analytics (deferred to KNOW-019)
- Performance metrics (latency percentiles, etc.)

---

### AC6: MCP Tool Registration

**Given** kb_bulk_import and kb_stats implementations
**When** MCP server starts
**Then**:
- ✅ Tools registered in tool-schemas.ts with Zod schemas
- ✅ Tool handlers implemented in tool-handlers.ts
- ✅ Tools discoverable via MCP protocol `tools/list`
- ✅ Tool schemas generated from Zod via zod-to-json-schema
- ✅ Tool descriptions include usage examples
- ✅ Input validation handled by MCP layer before handler execution

**Tool Metadata:**
- `kb_bulk_import`: "Bulk import knowledge entries from parsed data sources"
- `kb_stats`: "Get knowledge base statistics (counts, tags, cache info)"

---

### AC7: YAML Security Validation

**Given** potentially malicious YAML input
**When** `parseSeedYaml()` is called
**Then**:
- ✅ Uses `js-yaml` with `safeLoad()` (not `load()`)
- ✅ Rejects custom YAML tags (e.g., `!!python/object`)
- ✅ Validates structure immediately with Zod schema (allowlist approach)
- ✅ Sanitizes content strings (strip control characters, validate UTF-8)
- ✅ Rejects deeply nested structures (prevent DoS)
- ✅ Test case with malicious YAML input (SQL injection in tags, XSS in content)

**Security Principle:** Trust no external input, validate everything with Zod

---

### AC8: Duplicate ID Detection in YAML

**Given** YAML file with duplicate entry IDs
**When** `parseSeedYaml()` is called
**Then**:
- ✅ Detects duplicate IDs during parsing
- ✅ Throws ValidationError: "Duplicate entry ID: {id}"
- ✅ Lists all duplicate IDs in error message
- ✅ No database writes occur before validation completes

**Example:**
```yaml
- id: dup-001
  content: "First"
  roles: [dev]
  tags: []

- id: dup-001  # ERROR: duplicate
  content: "Second"
  roles: [dev]
  tags: []
```

---

### AC9: CLI Seeding Scripts (Optional)

**Given** need for one-time seed operations
**When** developer runs `pnpm seed:yaml --file=seed-data.yaml`
**Then**:
- ✅ CLI script reads file from path
- ✅ Calls `parseSeedYaml()` + `kb_bulk_import()`
- ✅ Displays progress and final summary
- ✅ Returns exit code 0 on success, non-zero on failure
- ✅ Help text: `pnpm seed:yaml --help`

**Scripts to implement:**
- `scripts/seed-from-yaml.ts` - Import from YAML file
- `scripts/seed-from-lessons.ts` - Import from LESSONS-LEARNED.md

**Note:** CLI scripts are convenience wrappers, not required for core functionality

---

### AC10: Test Coverage

**Given** parsers, bulk import, and stats implementations
**When** test suite executes
**Then**:
- ✅ Minimum 85% line coverage for `parsers/` directory
- ✅ Minimum 85% line coverage for `seed/` directory
- ✅ Minimum 80% line coverage for kb_stats
- ✅ All happy path scenarios tested
- ✅ All error cases tested (YAML errors, validation, API failures)
- ✅ Edge cases tested (large content, special chars, empty input, 1000+ entries)
- ✅ Performance tests validate targets (5s per 10 entries, 500ms for stats)
- ✅ Security tests with malicious input
- ✅ Integration tests with real database and EmbeddingClient
- ✅ Test cleanup: unique tags for test data, cleanup in afterEach

**Test Count Estimate:** 60-80 tests
- Parser tests: 30-40 (format variations, edge cases, errors)
- Bulk import tests: 20-30 (happy path, errors, performance)
- kb_stats tests: 10 (aggregations, edge cases)

---

## Reuse Plan

### Existing Packages to Reuse

1. **@repo/logger** (`packages/core/logger`)
   - Use for all logging (no console.log)
   - Log levels: info (progress), debug (queries), error (failures)

2. **Database Client** (`apps/api/knowledge-base/src/db`)
   - Drizzle ORM for queries
   - Schema from KNOW-001

3. **EmbeddingClient** (`apps/api/knowledge-base/src/embedding-client`)
   - Batch processing for efficient API usage
   - Content-hash caching to minimize API calls
   - Methods: `generateEmbeddingsBatch(texts[])`

4. **CRUD Operations** (`apps/api/knowledge-base/src/crud-operations`)
   - kb_add for individual entry creation
   - Bulk import wraps kb_add in loop with batching

5. **MCP Server Infrastructure** (`apps/api/knowledge-base/src/mcp-server`)
   - Tool registration pattern from KNOW-0051
   - Zod schema to JSON schema conversion via zod-to-json-schema
   - Tool handler pattern with error sanitization

### New Dependencies Required

- **js-yaml** (`^4.1.0`) - YAML parsing
  - Well-tested, mature library (600k+ weekly downloads)
  - Use `safeLoad()` for security

### No New Shared Packages Needed

All functionality is specific to knowledge-base and remains in `apps/api/knowledge-base/src/`.

---

## Architecture Notes

### Ports & Adapters Pattern

```
┌─────────────────────────────────────────────────────┐
│                   Parsers (Domain)                   │
│  ┌─────────────────────────────────────────────┐   │
│  │  parseSeedYaml(), parseLessonsLearned()    │   │
│  │  - YAML/Markdown parsing                    │   │
│  │  - Zod validation                            │   │
│  │  - Returns ParsedEntry[]                     │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│              Bulk Import (Application)               │
│  ┌─────────────────────────────────────────────┐   │
│  │  kb_bulk_import()                           │   │
│  │  - Batch processing logic                    │   │
│  │  - Error collection and reporting            │   │
│  │  - Progress logging                          │   │
│  └─────────────────────────────────────────────┘   │
│              ↓                   ↓                   │
│    ┌─────────────────┐  ┌─────────────────┐        │
│    │   kb_add        │  │ EmbeddingClient │        │
│    │   (CRUD)        │  │  (Batch API)    │        │
│    └─────────────────┘  └─────────────────┘        │
└─────────────────────────────────────────────────────┘
          ↓                       ↓
   PostgreSQL              OpenAI API
```

### Batch Processing Strategy

**Challenge:** Importing 1000 entries requires 1000 embedding API calls

**Solution:**
1. Group entries by unique content (deduplication)
2. Use EmbeddingClient `generateEmbeddingsBatch()` (20 entries per batch)
3. Cache hits skip API call entirely
4. Parallel batch processing (up to 5 concurrent batches)
5. Progress logging every 100 entries

**Expected Performance:**
- Cold start (no cache): ~0.5s per entry = ~8 minutes for 1000 entries
- Warm cache (50% hit rate): ~0.25s per entry = ~4 minutes for 1000 entries
- Hot cache (90% hit rate): ~0.05s per entry = <1 minute for 1000 entries

### Error Handling Strategy

**Philosophy:** Fail fast on structural errors, continue on individual entry errors

1. **Parsing Layer:**
   - YAML syntax error → fail immediately (no partial parse)
   - Validation error → fail immediately (all entries must be valid)
   - Duplicate IDs → fail immediately (data quality check)

2. **Import Layer:**
   - Entry N fails → log error, skip entry, continue with N+1
   - OpenAI API error → retry via EmbeddingClient, then skip if exhausted
   - Database error → skip entry, continue
   - Return detailed summary with all errors

3. **Logging Layer:**
   - Parse errors: ERROR level
   - Individual entry failures: WARN level
   - Progress updates: INFO level
   - Detailed operations: DEBUG level

### Transaction Boundaries

**kb_bulk_import:**
- No explicit transaction (relies on kb_add atomic operations)
- Each entry is independent unit of work
- Partial success is acceptable and expected
- Future enhancement: batch-level transactions (commit every 100 entries)

**kb_stats:**
- Read-only queries (no transaction needed)
- Use database read replica if available (future optimization)

---

## Infrastructure Notes

### Database Performance

**Indexes Used:**
- `knowledge_entries_role_idx` (for by_role counts in kb_stats)
- `knowledge_entries_created_at_idx` (not used in this story)
- Primary key index on `id` (for lookups)

**Query Optimization:**
- kb_stats uses single query with GROUP BY for role counts
- `COUNT(DISTINCT ...)` for unique tag count
- Database size query: `pg_database_size(current_database())`

### OpenAI API Cost Management

**Cost Estimation Formula:**
```typescript
const estimatedTokens = totalChars / 4
const estimatedCost = (estimatedTokens / 1000) * 0.00002  // text-embedding-3-small
```

**Cost Examples:**
- 100 entries × 500 chars = 50,000 chars = ~12,500 tokens = **$0.25**
- 1000 entries × 500 chars = 500,000 chars = ~125,000 tokens = **$2.50**

**Mitigation:**
- Log estimate before import
- Require confirmation for imports >500 entries
- Leverage embedding cache for re-imports
- Enforce max 1000 entries per call

### File Size Limits

**Recommended Limits:**
- YAML files: <1MB (prevents memory issues)
- Markdown files: <1MB
- Content per entry: <30k chars (OpenAI ~8191 token limit with margin)

**Enforcement:**
- Validate file size before parsing
- Validate content length in Zod schema
- Throw descriptive error if limits exceeded

---

## HTTP Contract Plan

**N/A** - This story implements MCP tools, not HTTP endpoints.

MCP tools added:
- `kb_bulk_import` - accessible via MCP protocol
- `kb_stats` - accessible via MCP protocol

Future: HTTP endpoints for web UI (KNOW-024) would wrap these functions.

---

## Seed Requirements

This story IS the seeding implementation. Once complete:

1. **Initial Seed:**
   ```bash
   pnpm seed:yaml --file=plans/future/knowledgebase-mcp/seed-data.yaml
   pnpm seed:lessons --file=plans/future/knowledgebase-mcp/LESSONS-LEARNED.md
   ```

2. **Verify Import:**
   ```bash
   # Via MCP tool
   kb_stats({})

   # Via SQL
   SELECT COUNT(*) FROM knowledge_entries;
   SELECT role, COUNT(*) FROM knowledge_entries GROUP BY role;
   ```

3. **Expected Result:**
   - ~150-200 entries from seed-data.yaml
   - ~50-100 entries from LESSONS-LEARNED.md
   - Total: ~200-300 entries in knowledge base

---

## Test Plan

See `_pm/TEST-PLAN.md` for comprehensive test plan with:
- 5 happy path tests
- 5 error case tests
- 7 edge case tests
- Required tooling evidence
- Performance test scenarios
- Security test scenarios

**Key Test Scenarios:**
1. Parse valid YAML → success
2. Parse LESSONS-LEARNED.md → success
3. Bulk import 100 entries → success, correct counts
4. Malformed YAML → descriptive error
5. OpenAI API failure → partial success with error report
6. Duplicate IDs in YAML → validation error
7. 1000+ entry import → performance targets met
8. Concurrent imports → no deadlock
9. kb_stats query → accurate results, <500ms
10. Security: malicious YAML → rejected safely

**Coverage Targets:**
- Parsers: 90%+ (critical path, many edge cases)
- Bulk Import: 85%+ (integration complexity)
- kb_stats: 80%+ (straightforward queries)

---

## UI/UX Notes

**N/A** - This story implements backend parsing and seeding functionality with no UI components.

See `_pm/UIUX-NOTES.md` for details (verdict: SKIPPED).

Future UI considerations (KNOW-024):
- Import progress indicator
- Validation error display
- Statistics dashboard
- Cost estimation confirmation

---

## Risks and Mitigations

### Risk 1: YAML Parsing Edge Cases

**Risk:** YAML spec complexity (multi-line strings, special chars, nested structures) may cause unexpected parsing failures.

**Mitigation:**
- Use well-tested `js-yaml` library
- Comprehensive test suite with real seed-data.yaml
- Immediate Zod validation after parsing
- Allowlist approach (reject unexpected structure)

---

### Risk 2: LESSONS-LEARNED.md Format Assumptions

**Risk:** Free-form markdown may not follow expected structure. Parser may break with future format changes.

**Mitigation:**
- Document expected format explicitly in AC
- Lenient parser: extract what's possible, log warnings
- Integration test with actual file (not synthetic fixtures)
- Version marker in markdown for future format changes

---

### Risk 3: Bulk Import Performance at Scale

**Risk:** Importing 1000+ entries may be slow (5+ minutes) and expensive ($2.50+ API cost).

**Mitigation:**
- Leverage EmbeddingClient batch processing
- Progress logging every 100 entries
- Enforce max 1000 entries per call
- Log cost estimate before import
- Test with realistic dataset (100-200 entries)

---

### Risk 4: Embedding Generation Failures During Import

**Risk:** OpenAI API rate limiting or failures could leave database in partially-imported state.

**Mitigation:**
- Partial success is acceptable (not a risk, it's a feature)
- Detailed error reporting with entry indices
- Retry logic via EmbeddingClient (3 attempts with backoff)
- Log exactly which entries succeeded vs failed
- Support re-running import (skip existing entries via deduplication)

---

### Risk 5: YAML Security Vulnerabilities

**Risk:** YAML parsers historically vulnerable to code execution, DoS, prototype pollution.

**Mitigation:**
- Use `js-yaml` with `safeLoad()` only
- Immediate Zod validation (allowlist approach)
- Reject custom tags and deep nesting
- Test with malicious YAML inputs
- Sanitize content strings before storage

---

### Risk 6: Test Data Cleanup Failures

**Risk:** Bulk import tests create hundreds of database entries. Failed cleanup pollutes subsequent test runs.

**Mitigation:**
- Use unique tag for test entries: `__test_bulk_import__`
- Cleanup in afterEach hook
- Validation in beforeAll (warn if database not empty)
- Consider database transactions for test isolation
- Document cleanup strategy in test-helpers.ts

---

### Risk 7: Ambiguous Duplicate Handling

**Risk:** Index says "no duplicate entries for identical content hashes" but behavior is unclear (skip? warn? error?).

**Mitigation:**
- PM clarifies in AC: embedding cache prevents redundant API calls
- Multiple entries with identical content are allowed
- Each entry gets unique UUID
- Cache hit logged for visibility
- Future enhancement: true deduplication with skip tracking

---

### Risk 8: YAML Field Mapping Complexity

**Risk:** seed-data.yaml has fields (id, entry_type, confidence) not in kb_add schema. Mapping is unclear.

**Mitigation:**
- Explicit mapping defined in AC1
- `entry_type` → stored as tag
- `source_file` → stored as tag
- `id` and `confidence` → ignored for MVP
- Multi-role entries → create separate entry per role
- Document mapping in parser code comments

---

## Definition of Done

- [ ] parseSeedYaml() implemented with comprehensive YAML parsing
- [ ] parseLessonsLearned() implemented with markdown parsing
- [ ] kb_bulk_import() implemented with batch processing
- [ ] kb_stats() implemented with aggregation queries
- [ ] Both MCP tools registered in tool-schemas.ts and tool-handlers.ts
- [ ] All acceptance criteria met
- [ ] Zod schemas for all parsed data and responses
- [ ] Error handling for malformed input, API failures, database errors
- [ ] Security validation (safeLoad, input sanitization)
- [ ] Logging with @repo/logger (no console.log)
- [ ] Test suite passing with ≥85% coverage
- [ ] All happy path tests passing
- [ ] All error case tests passing
- [ ] All edge case tests passing
- [ ] Security tests with malicious input passing
- [ ] Performance targets met (<5s per 10 entries, <500ms for stats)
- [ ] TypeScript compilation clean (no errors)
- [ ] ESLint clean on all new files
- [ ] Optional: CLI seeding scripts implemented
- [ ] PROOF-KNOW-006.md document created with evidence
- [ ] Story status updated to "ready-for-code-review"

---

## Related Stories

- **KNOW-001**: Package Infrastructure Setup (prerequisite ✅)
- **KNOW-002**: Embedding Client Implementation (prerequisite ✅)
- **KNOW-003**: Core CRUD Operations (prerequisite ✅)
- **KNOW-0051**: MCP Server Foundation (prerequisite ✅)
- **KNOW-007**: Admin Tools and Polish (depends on KNOW-006)
- **KNOW-008**: Workflow Integration (depends on KNOW-007)
- **KNOW-019**: Query Analytics (future enhancement)
- **KNOW-024**: Management UI (future enhancement)

---

## Agent Log

| Timestamp | Agent | Action | Notes |
|-----------|-------|--------|-------|
| 2026-01-25 | pm-story-generation-leader | Story generated | Synthesized from index entry + worker artifacts |

---

## Token Budget

Phase tracking will be added during implementation.

<!-- Token usage will be logged here via /token-log command -->

---

## Story Estimates

**Story Points:** 8

**Justification:**
- Parsers: Medium complexity (YAML library + markdown regex)
- Bulk import: Medium-high complexity (batch processing, error handling)
- kb_stats: Low complexity (simple aggregation queries)
- MCP tool registration: Low complexity (pattern established)
- Test coverage: High effort (60-80 tests, many edge cases)

**Comparison to similar stories:**
- KNOW-003 (CRUD): 5 story points, 5 operations, 60 tests
- KNOW-006 (Parsers): 8 story points, 4 operations, 60-80 tests, more complexity

**Estimated Implementation Time:** 2-3 days for dev with tests

---

## Questions for PM Review

Based on worker findings, PM should clarify:

1. **Duplicate Entry Handling (Dev Feasibility Ambiguity #1):**
   - Should kb_bulk_import skip duplicates or allow them?
   - Recommendation: Allow duplicates, embedding cache handles API cost
   - OR: Check existing entries by content hash and skip

2. **YAML Field Mapping (Dev Feasibility Ambiguity #2):**
   - Confirm mapping for `entry_type` → tag
   - Confirm mapping for `source_file` → tag
   - Confirm `id` and `confidence` are ignored
   - Confirm multi-role handling (create entry per role)

3. **Partial Import Behavior (Dev Feasibility Ambiguity #3):**
   - Confirm partial success is acceptable (recommended)
   - OR: Require all-or-nothing with transaction rollback

4. **kb_stats Output Schema (Dev Feasibility Ambiguity #4):**
   - Confirm `cache_hit_rate` is removed from MVP
   - Confirm exact schema matches AC5

5. **CLI Scripts (Dev Feasibility Ambiguity #5):**
   - Are CLI wrapper scripts required or optional?
   - Recommendation: Optional for MVP

6. **LESSONS-LEARNED.md Format (Dev Feasibility Suggestion #4):**
   - Document exact expected markdown format
   - Provide canonical example section
   - Reference SEED-STRATEGY.md for format spec

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-25_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | File size validation (max 1MB) | ADD AS AC | Prevents Node.js OOM on large YAML/Markdown files. Will add file size validation to AC1, AC2. Reject files >1MB with clear error message. |
| 2 | Tag format validation (alphanumeric + hyphen/underscore, max 50 chars) | ADD AS AC | Prevents SQL injection, XSS vectors in tags. Zod schema to validate tag format and per-tag character limit. |
| 3 | Rollback mechanism (bulk_import_session_id for group deletion) | ADD AS AC | Enables users to undo partial imports. Add bulk_import_session_id tracking and kb_rollback_bulk_import tool for future use. |
| 4 | Concurrent import test (2 concurrent imports without deadlock) | ADD AS AC | Ensures safety when multiple users/processes import simultaneously. Add AC11 with specific test requirement. |
| 5 | Content sanitization (strip control characters) | ADD AS AC | Prevents control character (0x00-0x1F) issues in database and display. Sanitize content in parsers before Zod validation. |
| 6 | Format version detection (version marker + graceful failure) | ADD AS AC | Handles future LESSONS-LEARNED.md format changes. Add version marker check (e.g., `<!-- format: v1.0 -->`) and fail gracefully on mismatch. |
| 7 | Structured logging for import completion | ADD AS AC | Enables monitoring and debugging in production. Log structured event (json) with metrics: total, succeeded, failed, duration. |
| 8 | Max tag count constraint (50 tags per entry) | ADD AS AC | Prevents performance degradation from excessive tags. Zod schema constraint: `z.array().max(50)` on tags field. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Parser plugin architecture | OUT OF SCOPE | Future sources (Google Docs, Confluence) can be added later. Not required for MVP. |
| 2 | Dry-run mode for bulk import | ADD AS AC | Valuable for validation before commit. Add `dry_run: boolean` flag to kb_bulk_import schema. Returns same summary without database writes. |
| 3 | Similarity-based deduplication (warn on 95%+ similar) | ADD AS AC | Helps identify near-duplicates leveraging existing embeddings. Add deduplication check using existing kb_get_related from KNOW-004. Log warnings in import summary. |
| 4 | Incremental import with delta detection (import_manifest table) | ADD AS AC | Supports safe re-imports of updated YAML with minimal redundant work. Track source_file + source_id mapping, compare content hash, skip unchanged. Requires new import_manifest table. |
| 5 | YAML pre-flight validation | ADD AS AC | Validates structure + required fields + duplicate IDs before generating embeddings. Saves cost on malformed data. Add optional `validate_only` mode or separate tool. |
| 6 | Tier-aware cost estimation | OUT OF SCOPE | OpenAI tier pricing changes frequently and is opaque. Simple fixed-rate estimate sufficient for MVP. |
| 7 | Auto-tagging from content analysis | OUT OF SCOPE | Requires NLP/LLM capabilities beyond scope. Can be added in future story if needed. |
| 8 | Resume capability for interrupted imports | ADD AS AC | Enables recovery from failures. Track bulk_import_session_id + last_completed_index. Use idempotent upsert strategy. Requires checkpoint table. |

### Follow-up Stories Suggested

- [ ] KNOW-006a: Query deduplication strategy (if similarity-based dedup becomes expensive)
- [ ] KNOW-006b: Import manifest and incremental sync (if delta detection is needed frequently)
- [ ] KNOW-006c: Enhanced cost estimation with volume tiers (if pricing tiers become relevant)
- [ ] KNOW-0073: Auto-tagging with LLM analysis (future enhancement)

### Items Marked Out-of-Scope

- **Parser plugin architecture**: Future extensibility (Google Docs, Confluence, Notion) deferred to separate stories
- **Tier-aware cost estimation**: OpenAI pricing tiers too volatile; fixed-rate estimate sufficient
- **Auto-tagging from content analysis**: Requires NLP/LLM capabilities beyond MVP scope
