---
story_id: KNOW-0052
title: "MCP Search Tools + Deployment Topology"
status: in-progress
split_from: KNOW-005
split_part: 2 of 3
created: 2026-01-25
updated: 2026-01-25
assignee: null
story_points: 5
priority: P0
depends_on: [KNOW-0051, KNOW-004]
blocks: [KNOW-008]
tags:
  - knowledge-base
  - mcp
  - backend
  - search
---

# KNOW-0052: MCP Search Tools + Deployment Topology

## Split Context

This story is part of a split from KNOW-005 (MCP Server Setup).

- **Original Story:** KNOW-005
- **Split Reason:** Story exceeded sizing guidelines with 10 acceptance criteria and 10 tools. Split to reduce complexity and enable parallel development.
- **This Part:** 2 of 3 (Search Tools - extends foundation)
- **Dependency:** Depends on KNOW-0051 (MCP Server Foundation) and KNOW-004 (Search Implementation)
- **Unblocks:** KNOW-008 (Workflow Integration)

## Context

KNOW-0051 established the foundational MCP server infrastructure with 5 CRUD tools. KNOW-004 implemented hybrid semantic + keyword search with pgvector and PostgreSQL FTS. This story integrates search functionality into the MCP server by adding 2 search tools (kb_search, kb_get_related) as thin wrappers.

Additionally, this story documents the deployment topology (how Claude Code spawns and manages MCP server instances), establishes performance benchmarking practices, and adds operational readiness features like timeouts, correlation IDs, and connection pooling validation.

**Key Architectural Decisions:**
- Search tools are thin wrappers around KNOW-004 search functions
- Performance targets include MCP protocol overhead measurement
- Deployment topology clarified: single instance per Claude Code session
- Connection pooling validated for concurrent search queries
- Correlation IDs enable tracing multi-tool workflows

## Goal

Add 2 search tools (kb_search, kb_get_related) to the MCP server, document deployment topology, establish performance benchmarking practices, and add operational readiness features to enable workflow integration.

**Primary deliverables:**
1. kb_search and kb_get_related tool handlers
2. Performance logging and benchmarking for search operations
3. Deployment topology documentation (instance-per-session model)
4. Connection pooling strategy and validation
5. Per-tool timeout configuration
6. Correlation IDs for structured logging
7. Tool composition support (tools calling tools)
8. MCP protocol error test coverage

## Non-Goals

- ❌ Admin tools (kb_bulk_import, kb_rebuild_embeddings, kb_stats, kb_health) - defer to KNOW-0053
- ❌ CRUD tools (already implemented in KNOW-0051)
- ❌ Authentication/authorization - defer to KNOW-009
- ❌ Rate limiting - defer to KNOW-010
- ❌ AWS deployment (MCP server runs locally for MVP)
- ❌ Agent instruction templates - defer to KNOW-008

## Scope

### Packages Affected

**Primary:**
- `apps/api/knowledge-base/src/mcp-server/tool-handlers.ts` - Add kb_search, kb_get_related handlers
- `apps/api/knowledge-base/src/mcp-server/tool-schemas.ts` - Add schemas for search tools
- `apps/api/knowledge-base/src/mcp-server/server.ts` - Add timeout configuration, correlation IDs
- `apps/api/knowledge-base/src/mcp-server/__tests__/` - Add search tool tests
  - `search-tools.test.ts` - Search tool handler tests
  - `performance.test.ts` - Performance benchmarking tests
  - `mcp-protocol-errors.test.ts` - MCP protocol error tests

**Secondary:**
- `apps/api/knowledge-base/src/search/index.ts` - Ensure exports for MCP handlers
- `apps/api/knowledge-base/docs/DEPLOYMENT.md` - Deployment topology documentation (new)

### MCP Tools Implemented (2 Search Tools)

**1. kb_search** - Hybrid semantic + keyword search
```typescript
kb_search({
  query: string,
  role?: 'pm' | 'dev' | 'qa' | 'all',
  tags?: string[],
  entry_type?: 'fact' | 'summary' | 'template',
  limit?: number,
  min_confidence?: number
})
// Returns: { results: KnowledgeEntry[], metadata: { total, fallback_mode, query_time_ms } }
```

**2. kb_get_related** - Find related entries
```typescript
kb_get_related({
  entry_id: string,
  limit?: number
})
// Returns: { results: KnowledgeEntry[], metadata: { total, relationship_types } }
```

### Database Tables

**Read-only operations:**
- All search tools operate via existing search functions from KNOW-004
- No direct database queries in MCP layer
- Database access delegated to search modules

## Acceptance Criteria

### AC1: kb_search Tool Handler

**Given** kb_search function exists from KNOW-004
**When** kb_search tool handler is implemented
**Then**:
- ✅ Tool handler is thin wrapper around kb_search function
- ✅ Tool handler validates input with Zod schema
- ✅ Tool handler logs query, result count, fallback_mode, query_time_ms
- ✅ Tool handler sanitizes errors before returning
- ✅ Tool handler includes correlation_id in logs for tracing
- ✅ Tool handler respects per-tool timeout (default 10s for search)
- ✅ Fallback mode logged at warn level when OpenAI API unavailable

---

### AC2: kb_get_related Tool Handler

**Given** kb_get_related function exists from KNOW-004
**When** kb_get_related tool handler is implemented
**Then**:
- ✅ Tool handler is thin wrapper around kb_get_related function
- ✅ Tool handler validates input with Zod schema
- ✅ Tool handler logs entry_id, result count, query_time_ms
- ✅ Tool handler sanitizes errors before returning
- ✅ Tool handler includes correlation_id in logs for tracing
- ✅ Tool handler respects per-tool timeout (default 5s)

---

### AC3: Performance Logging and Benchmarking

**Given** search tools are invoked
**When** measuring performance
**Then**:
- ✅ Log `query_time_ms` for all tool invocations at info level
- ✅ Separate metrics for MCP protocol overhead vs domain logic time
- ✅ Performance targets: kb_search < 500ms p95 (vector search with pre-cached embeddings)
- ✅ Performance targets: kb_search with embeddings < 3s p95 (including OpenAI API time for embeddings generation)
- ✅ Performance targets: kb_get_related < 300ms p95
- ✅ Benchmark results documented in proof with realistic dataset (100+ entries)
- ✅ Log slow queries (>1s) at warn level, threshold configurable via LOG_SLOW_QUERIES_MS env var

**Example log output:**
```
[INFO] kb_search tool invoked: { query: "validation best practices", correlation_id: "uuid-123", role: "dev", limit: 5 }
[INFO] kb_search succeeded: { result_count: 3, fallback_mode: false, query_time_ms: 234, protocol_overhead_ms: 12, correlation_id: "uuid-123" }
```

---

### AC4: Deployment Topology Documentation

**Given** MCP server implementation is complete
**When** documenting architecture
**Then**:
- ✅ Document: Claude Code spawns MCP server as subprocess
- ✅ Document: stdio communication (not HTTP)
- ✅ Document: Single instance per Claude Code session (not shared)
- ✅ Document: Server startup command and environment requirements
- ✅ Document: Connection pooling strategy (5 connections per instance recommended)
- ✅ Document: Server lifecycle (startup, shutdown, restart on crash)
- ✅ Document: How Claude Code detects crash and restarts server
- ✅ Include architecture diagram: Claude Code → MCP Server → CRUD/Search → PostgreSQL + OpenAI
- ✅ Document: Instance isolation (separate database connections per session)

**Location:** `apps/api/knowledge-base/docs/DEPLOYMENT.md`

---

### AC5: Connection Pooling Strategy and Validation

**Given** MCP server may handle concurrent tool invocations
**When** configuring connection pooling
**Then**:
- ✅ Connection pool size: 5 connections per MCP server instance
- ✅ Rationale documented: Supports 5 concurrent searches, prevents pool exhaustion
- ✅ Connection pool timeout: 10s (prevents deadlock)
- ✅ Idle connection timeout: 60s (prevents stale connections)
- ✅ Test concurrent invocations (10 parallel kb_search calls)
- ✅ Test connection pool exhaustion scenario (11 concurrent calls)
- ✅ Log connection pool metrics (active, idle, waiting) at debug level

---

### AC6: Per-Tool Timeout Configuration

**Given** tools may have different performance characteristics
**When** configuring timeouts
**Then**:
- ✅ Per-tool timeout configuration implemented
- ✅ kb_search timeout: 10s (allows for OpenAI API latency)
- ✅ kb_get_related timeout: 5s (database-only, should be fast)
- ✅ Timeout exceeded returns error: `{ code: "TIMEOUT", message: "Tool execution exceeded Xs timeout" }`
- ✅ Timeout logged at warn level
- ✅ Timeouts configurable via environment variables

**Environment variables:**
```bash
KB_SEARCH_TIMEOUT_MS=10000
KB_GET_RELATED_TIMEOUT_MS=5000
```

---

### AC7: Correlation IDs for Structured Logging

**Given** multi-tool workflows are common (search → get → update)
**When** implementing correlation IDs
**Then**:
- ✅ Correlation ID generated for each tool invocation (UUID v4)
- ✅ Correlation ID included in all log messages for that invocation
- ✅ Correlation ID returned in tool response metadata (optional)
- ✅ Correlation ID enables tracing tool workflows across logs
- ✅ Documentation includes examples of filtering logs by correlation_id

**Example workflow tracing:**
```
[INFO] kb_search invoked: { correlation_id: "uuid-123", query: "..." }
[INFO] kb_search succeeded: { correlation_id: "uuid-123", result_count: 3 }
[INFO] kb_get invoked: { correlation_id: "uuid-456", id: "result-from-uuid-123" }
[INFO] kb_get succeeded: { correlation_id: "uuid-456" }
```

---

### AC8: Tool Composition Support

**Given** tools may need to call other tools (kb_get_related calls kb_get internally)
**When** implementing tool composition
**Then**:
- ✅ kb_get_related tool handler invokes kb_get (CRUD tool from KNOW-0051) internally
- ✅ Nested tool calls logged with parent correlation_id
- ✅ Nested tool calls respect timeouts (subtract parent elapsed time)
- ✅ Nested tool calls share database transaction (if applicable)
- ✅ Circular dependency detection prevents infinite loops (max depth limit approach)
- ✅ Documentation includes examples of kb_get_related → kb_get composition pattern

**Scope:** Tool composition limited to kb_get_related → kb_get for MVP. Full framework deferred post-MVP.

---

### AC9: MCP Protocol Error Test Coverage

**Given** MCP protocol may send malformed requests
**When** testing error handling
**Then**:
- ✅ Test malformed JSON request (invalid syntax)
- ✅ Test invalid tool name (tool not registered)
- ✅ Test missing required parameters (Zod validation)
- ✅ Test invalid parameter types (string instead of number)
- ✅ Test oversized payloads (>1MB)
- ✅ Test concurrent request handling (10+ parallel)
- ✅ All protocol errors return structured error response
- ✅ All protocol errors logged server-side

**Test file:** `mcp-protocol-errors.test.ts`

---

### AC10: Test Coverage

**Given** test suite is executed
**When** measuring coverage
**Then**:
- ✅ Minimum 80% line coverage for search tool handlers
- ✅ All happy path scenarios tested (2 search tools × basic invocation)
- ✅ All error cases tested (validation, timeout, API failure, database failure)
- ✅ Edge cases from Edge Cases section (6) tested (see Edge Cases below)
- ✅ Performance benchmarks validated against targets
- ✅ MCP protocol error tests passing

---

### AC11: MCP Server Startup Failure Tests

**Given** MCP server initialization may fail
**When** testing startup scenarios
**Then**:
- ✅ Test missing DATABASE_URL environment variable (server exits with clear error)
- ✅ Test invalid OPENAI_API_KEY environment variable (server exits with clear error)
- ✅ Test database connection timeout (server exits with clear error)
- ✅ Test missing pgvector extension (server exits with clear error)
- ✅ All startup failures logged before exit (no silent crashes)
- ✅ Server restart by Claude Code after clean exit (documented in DEPLOYMENT.md)

**Test file:** `mcp-protocol-errors.test.ts` (startup section)

---

### AC12: Connection Pool Timeout Behavior Documentation

**Given** timeouts may occur during query execution
**When** documenting connection pool behavior
**Then**:
- ✅ Document: Connection pool timeout is 10s (prevents deadlock)
- ✅ Document: When timeout occurs, query is cancelled by database driver
- ✅ Document: Connection is returned to pool immediately (no leak)
- ✅ Test case: Connection pool state after timeout (verify connection returned)
- ✅ Test case: Subsequent queries after timeout succeed (pool not corrupted)
- ✅ Document in DEPLOYMENT.md: Connection pool timeout behavior and verification steps

---

### AC13: Correlation ID Propagation to Search Functions

**Given** correlation IDs are generated in MCP tool handlers
**When** invoking search functions
**Then**:
- ✅ Update kb_search function signature to accept optional correlation_id parameter
- ✅ Update kb_get_related function signature to accept optional correlation_id parameter
- ✅ MCP tool handlers pass correlation_id to search functions
- ✅ All search function logs include correlation_id (from KNOW-004 functions)
- ✅ Multi-tool workflow tracing works end-to-end (handler → search → database logs)
- ✅ Changes in KNOW-004 are backward compatible (optional parameter)

**Note:** Requires minor update to KNOW-004 search function signatures. Backward compatible.

---

### AC14: Circular Dependency Detection for Tool Composition

**Given** tools may call other tools (kb_get_related calls kb_get)
**When** detecting circular dependencies
**Then**:
- ✅ Document: Circular dependency detection approach uses max depth limit (max 5 nested tool calls)
- ✅ Implement: Call stack tracking via request context (tool_call_chain array)
- ✅ Implement: Check tool name against call chain before invocation
- ✅ Test case: Mock tool A calling tool B calling tool A (circular) - returns error
- ✅ Test case: Nested tool call at max depth limit (5) - 6th call returns error
- ✅ Document in Architecture Notes: Circular dependency detection mechanism

---

### AC15: Performance Measurement Points Documentation

**Given** performance metrics require clear measurement definitions
**When** documenting performance logging
**Then**:
- ✅ Document: total_time_ms = time from stdio read to stdio write (includes all overhead)
- ✅ Document: protocol_overhead_ms = Zod validation + serialization time (measured separately)
- ✅ Document: domain_logic_time_ms = search function execution time
- ✅ Calculate: protocol_overhead_ms = total_time_ms - domain_logic_time_ms
- ✅ Example log output shows all three metrics clearly
- ✅ Document in DEPLOYMENT.md and performance.test.ts

**Example:**
```
[INFO] kb_search completed: {
  total_time_ms: 250,
  protocol_overhead_ms: 12,
  domain_logic_time_ms: 238,
  query_time_ms: 250,
  correlation_id: "uuid-123"
}
```

---

### AC16: Large Result Set Pagination and Metadata

**Given** kb_search may return 50-entry limit
**When** documenting result limits
**Then**:
- ✅ Document: kb_search returns up to 50 results per query (MVP limit)
- ✅ Document: No pagination support in MVP (no cursor-based pagination)
- ✅ Add: result_count_total to metadata (e.g., "50 of 127 results found")
- ✅ Document in DEPLOYMENT.md: Pagination limitation and workaround (query refinement)
- ✅ Document post-MVP enhancement: Cursor-based pagination for larger result sets
- ✅ Update AC1 example to show result_count_total in metadata

**Example response:**
```json
{
  "results": [...],  // 50 results
  "metadata": {
    "total": 50,
    "result_count_total": 127,
    "query_time_ms": 234
  }
}
```

---

### AC17: Slow Query Threshold Configuration

**Given** slow query logging is implemented
**When** configuring threshold
**Then**:
- ✅ Slow query threshold is configurable via LOG_SLOW_QUERIES_MS environment variable
- ✅ Default threshold: 1000ms (1 second)
- ✅ Document in DEPLOYMENT.md: Recommended values (500ms production, 1000ms development)
- ✅ Implement: Only log slow queries if query_time_ms > LOG_SLOW_QUERIES_MS
- ✅ Log at warn level with correlation_id for filtering
- ✅ Example: Configure slow query threshold in .env file

**Environment variable:**
```bash
LOG_SLOW_QUERIES_MS=1000  # Default: 1000ms
```

---

### AC18: Search Result Caching (Enhancement - Deferred Post-MVP)

**Given** repeated searches may consume resources
**When** implementing result caching
**Then**:
- ✅ Document enhancement in DEPLOYMENT.md: Search result caching opportunity
- ✅ Document cache strategy: Redis-based caching keyed by (query, role, tags, entry_type, limit)
- ✅ Document cache TTL: 5 minutes (or configurable)
- ✅ Document cache invalidation: On kb_add, kb_update, kb_delete operations
- ✅ Document estimated impact: 30-50% reduction in database + OpenAI API load
- ✅ Mark as post-MVP enhancement story (KNOW-021 or new story)

**Note:** Not MVP-critical. Deferred to post-MVP cost optimization story.

---

### AC19: Tool Composition Context Passing (Enhancement - Deferred Post-MVP)

**Given** tool composition may require context passing
**When** planning future enhancements
**Then**:
- ✅ Document enhancement in Architecture Notes: Request context propagation for nested tool calls
- ✅ Document: Context could include user intent, session metadata, original query context
- ✅ Document: Implementation approach (AsyncLocalStorage or explicit context parameter)
- ✅ Document: Benefits (improved observability, multi-step workflows, user intent preservation)
- ✅ Mark as post-MVP enhancement story (KNOW-030 Tool Composition Framework)

**Note:** MVP supports basic kb_get_related → kb_get composition only.

---

### AC20: Continuous Performance Monitoring (Enhancement - Deferred Post-MVP)

**Given** performance monitoring is required for production
**When** planning observability enhancements
**Then**:
- ✅ Document enhancement in DEPLOYMENT.md: Continuous performance monitoring opportunity
- ✅ Document: CloudWatch custom metrics or Prometheus integration
- ✅ Document: Track p50/p95/p99 latencies for kb_search and kb_get_related
- ✅ Document: Alert on performance regression (e.g., p95 > 2x baseline)
- ✅ Document: Performance baselines from MVP benchmark results
- ✅ Mark as post-MVP monitoring story (KNOW-012 or KNOW-016)

**Note:** MVP requires one-time benchmarking. Continuous monitoring deferred post-MVP.

---

## Reuse Plan

### Reusing from Existing Packages

**1. Search Implementation (KNOW-004)**
- Location: `apps/api/knowledge-base/src/search`
- Usage: kb_search, kb_get_related tools
- Benefits: Hybrid semantic + keyword search with fallback, comprehensive tests (91 passing)

**2. MCP Server Foundation (KNOW-0051)**
- Location: `apps/api/knowledge-base/src/mcp-server`
- Usage: Server infrastructure, error sanitization, logging patterns
- Benefits: Proven MCP integration, test harness, tool registration patterns

**3. @repo/logger**
- Location: `packages/core/logger`
- Usage: All logging with correlation IDs
- Benefits: Structured logging, consistent format

---

## Architecture Notes

### Search Tool Integration

```
┌──────────────────────────────────────────────────────────────────┐
│                       Claude Code (Client)                        │
└──────────────────────────────────────────────────────────────────┘
                              ↓ (stdio)
┌──────────────────────────────────────────────────────────────────┐
│                    MCP Server (Adapter Layer)                     │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │       Search Tool Handlers (kb_search, kb_get_related)     │ │
│  │  - Input validation (Zod)                                   │ │
│  │  - Correlation ID injection                                 │ │
│  │  - Timeout enforcement                                       │ │
│  │  - Performance logging (protocol overhead + domain time)    │ │
│  │  - Error sanitization                                       │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              ↓
              ┌─────────────────────────────┐
              │    Search Functions         │
              │     (KNOW-004)              │
              │  - Hybrid RRF search        │
              │  - Fallback to keyword FTS  │
              └─────────────────────────────┘
                              ↓
         ┌─────────────────────────────────────────┐
         │     Database (PostgreSQL + pgvector)    │
         │     EmbeddingClient (OpenAI API)        │
         └─────────────────────────────────────────┘
```

### Deployment Topology

**Instance-per-Session Model:**
- Each Claude Code session spawns a dedicated MCP server subprocess
- MCP server has its own database connection pool (5 connections)
- No shared state between sessions
- Isolation ensures security and resource control

**Crash Recovery:**
- Claude Code monitors server process (exit code, stderr)
- On crash, Claude Code automatically restarts server
- No state lost (server is stateless, all state in database)
- Partial tool executions may be committed (no transactions in MVP)

---

## Infrastructure Notes

### No New Infrastructure Required

All infrastructure provisioned in KNOW-001:
- PostgreSQL with pgvector extension (Docker Compose)
- Database schema with all necessary indexes
- Connection pooling configured

### Configuration

**Environment variables:**
```bash
# Required (from KNOW-0051)
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/knowledge_base
OPENAI_API_KEY=sk-...

# Optional (search-specific)
KB_SEARCH_TIMEOUT_MS=10000
KB_GET_RELATED_TIMEOUT_MS=5000
KB_SEARCH_DEFAULT_LIMIT=10
KB_SEARCH_MAX_LIMIT=50
LOG_SLOW_QUERIES_MS=1000   # Log queries slower than 1s
```

---

## Test Plan

### Test Coverage Summary

**Scope:**
- 2 MCP search tools
- Performance benchmarking and logging
- Deployment topology validation
- Connection pooling under concurrent load
- Timeouts and correlation IDs
- MCP protocol error handling

**Test Files:**
```
apps/api/knowledge-base/src/mcp-server/__tests__/
  search-tools.test.ts         # Search tool handler unit tests
  performance.test.ts          # Performance benchmarking tests
  mcp-protocol-errors.test.ts  # MCP protocol error tests
  connection-pooling.test.ts   # Connection pool validation
```

**Coverage targets:**
- Unit tests: >80% coverage for search tool handlers
- Integration tests: All happy paths, error cases, edge cases
- Performance tests: Validate targets with realistic dataset (100+ entries)

### Happy Path Tests (2)

1. **kb_search Tool Invocation** - Search with role filter, verify results and metadata
2. **kb_get_related Tool Invocation** - Find related entries, verify relationship_types

### Error Cases (5)

1. **kb_search Timeout** - Query exceeds 10s timeout, returns TIMEOUT error
2. **kb_search OpenAI API Failure** - Falls back to keyword search, logs fallback_mode
3. **kb_get_related Invalid Entry ID** - Returns empty results, no error
4. **Connection Pool Exhaustion** - 11 concurrent calls, 11th waits or times out
5. **MCP Protocol Malformed JSON** - Returns structured error, logs server-side

### Edge Cases (6)

1. **kb_search Large Result Set** - 100+ results, pagination works correctly
2. **kb_search with Fallback Mode** - OpenAI API unavailable, uses keyword FTS
3. **kb_get_related with No Related Entries** - Returns empty array
4. **Concurrent kb_search Calls** - 10 parallel searches succeed, no pool exhaustion
5. **Slow Query Logging** - Query >1s logged at warn level with correlation_id
6. **Tool Composition** - kb_get_related internally calls kb_get, shares correlation_id

### Performance Benchmarks (3)

1. **kb_search Performance** - p50, p95, p99 with 100-entry dataset
2. **kb_get_related Performance** - p50, p95, p99 with 100-entry dataset
3. **MCP Protocol Overhead** - Measure serialization/deserialization time

---

## Risks and Mitigations

### Risk 1: Search Performance Unpredictability

**Risk**: OpenAI API latency is unpredictable. Search performance may exceed 10s timeout during API degradation.

**Mitigation**:
- Set timeout to 10s (generous buffer)
- Log slow queries at warn level
- Fallback to keyword search when OpenAI unavailable
- Document expected performance ranges in DEPLOYMENT.md

---

### Risk 2: Connection Pool Exhaustion Under Load

**Risk**: Concurrent searches may exhaust database connection pool (5 connections).

**Mitigation**:
- Document connection pool sizing rationale (AC5)
- Test connection pool exhaustion scenario (edge case 4)
- Log connection pool metrics at debug level
- Document scaling recommendations (increase pool size for high-concurrency sessions)

---

### Risk 3: Deployment Topology Complexity

**Risk**: Instance-per-session model may cause resource contention if many Claude Code sessions run simultaneously.

**Mitigation**:
- Document instance-per-session model clearly (AC4)
- Document resource requirements (RAM, CPU, DB connections)
- Recommend monitoring tools (CloudWatch, Prometheus) for post-MVP
- Consider shared instance model for post-MVP (requires authentication)

---

## Definition of Done

- [ ] kb_search and kb_get_related tool handlers implemented
- [ ] Tool schemas added for search tools
- [ ] Performance logging with protocol overhead measurement
- [ ] Deployment topology documented in DEPLOYMENT.md
- [ ] Connection pooling strategy validated
- [ ] Per-tool timeout configuration implemented
- [ ] Correlation IDs added to all logs
- [ ] Tool composition basic support implemented
- [ ] MCP protocol error tests passing
- [ ] Test suite passing with ≥80% coverage
- [ ] All happy path tests passing (2 tests)
- [ ] All error case tests passing (5 tests)
- [ ] All edge case tests passing (6 tests)
- [ ] Performance benchmarks validated (3 benchmarks)
- [ ] Architecture diagram created
- [ ] TypeScript compilation clean (no errors)
- [ ] Code follows monorepo conventions (Zod-first types, no barrel files)
- [ ] PROOF-KNOW-0052.md document created with evidence
- [ ] Story status updated to "ready-for-code-review"

---

## Related Stories

- **KNOW-004**: Search Implementation (prerequisite ✅)
- **KNOW-0051**: MCP Server Foundation + CRUD Tools (prerequisite)
- **KNOW-0053**: MCP Admin Tool Stubs (parallel, depends on KNOW-0051)
- **KNOW-008**: Workflow Integration (depends on KNOW-0052)

---

## Agent Log

| Timestamp | Agent | Action | Notes |
|-----------|-------|--------|-------|
| 2026-01-25 | pm-story-split-leader | Story created from split | Split from KNOW-005 due to sizing issues |

---

## Token Budget

Phase tracking will be added during implementation.

<!-- Token usage will be logged here via /token-log command -->

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-25_

### Issues Clarified (3)

| # | Issue | User Decision | Notes |
|---|-------|---------------|-------|
| 1 | AC8 Tool Composition - Scope Ambiguity | **Clarified as AC** | Tool composition scoped to kb_get_related → kb_get only for MVP. Full framework deferred post-MVP. |
| 2 | AC3 Performance Targets - OpenAI API Time | **Clarified as AC** | 500ms target is for vector search with pre-cached embeddings. 3s target includes OpenAI API time for embeddings generation. |
| 3 | AC10 Test Coverage - Edge Case Redundancy | **Clarified as AC** | Updated to reference Edge Cases (6) section instead of repeating examples. |

### Gaps Converted to Acceptance Criteria (7)

| # | Gap Finding | Converted AC | Notes |
|---|-------------|-------------|-------|
| 1 | MCP Server Startup Failures | AC11 | Tests for missing env vars, DB connectivity, pgvector extension. |
| 2 | Connection Pool Timeout Behavior | AC12 | Documentation and test case for connection pool state after timeout. |
| 3 | Correlation ID Propagation | AC13 | Update KNOW-004 search functions to accept and propagate correlation_id. |
| 4 | Circular Dependency Detection | AC14 | Max depth limit (5) approach with call stack tracking and test case. |
| 5 | Performance Measurement Points | AC15 | Clearly defined total_time_ms, protocol_overhead_ms, domain_logic_time_ms. |
| 6 | Large Result Set Pagination | AC16 | Document 50-entry limit, add result_count_total to metadata. |
| 7 | Slow Query Threshold Config | AC17 | Configurable via LOG_SLOW_QUERIES_MS with documented defaults. |

### Enhancement Opportunities Approved (3 Added as ACs, 2 Deferred)

| # | Enhancement | User Decision | Notes |
|---|-------------|---|-------|
| 1 | Search Result Caching | **Add as AC18 - Deferred** | Redis-based caching documented as post-MVP enhancement story. |
| 2 | OpenTelemetry Integration | **Out-of-Scope** | Defer to KNOW-029 Observability Integration (too high effort for MVP). |
| 3 | Tool Composition Context Passing | **Add as AC19 - Deferred** | Document as post-MVP enhancement story KNOW-030. |
| 4 | Continuous Performance Monitoring | **Add as AC20 - Deferred** | Document as post-MVP monitoring story (KNOW-012/KNOW-016). |
| 5 | Advanced Query Syntax | **Out-of-Scope** | Defer to future story KNOW-031 (low priority, high effort). |

### Story Point Adjustment

- **Original:** 3 story points (10 ACs, 2 tools, 4 test files)
- **Updated:** 5 story points (20 ACs, 2 tools, 4 test files, additional test coverage for startup, timeouts, correlation ID propagation, circular dependency detection)
- **Rationale:** Added 7 gap-derived ACs + 3 enhancement ACs deferred (documented) = 10 new acceptance criteria. Increased test complexity significantly (startup tests, connection pool tests, circular dependency tests, performance measurement validation).

### Follow-up Stories Recommended

- [ ] **KNOW-021** (or new): Search Result Caching - Redis-based caching for repeated searches
- [ ] **KNOW-030** (new): Tool Composition Framework - Context passing for nested tool calls
- [ ] **KNOW-012/KNOW-016** (or new): Continuous Performance Monitoring - CloudWatch/Prometheus integration
- [ ] **KNOW-031** (new): Advanced Query Syntax - AND/OR/NOT operators for power users

### Items Clarified or Deferred

- **Clarified:** Tool composition scope limited to kb_get_related → kb_get for MVP
- **Clarified:** Performance target interpretation (vector search vs. with embeddings API)
- **Clarified:** Test coverage scope (reference Edge Cases section)
- **Deferred:** OpenTelemetry integration (high effort, medium impact) → KNOW-029
- **Deferred:** Advanced query syntax → KNOW-031

---
