# Dynamic Data MCP Tools Specification
# Generated: 2026-01-24
#
# These tools query live data rather than static knowledge.
# Implement as MCP server tools for real-time agent access.

---

# =============================================================================
# TEST & COVERAGE TOOLS
# =============================================================================

- id: tool-test-001
  name: get_test_coverage
  description: |
    Returns current test coverage metrics for a package or the entire monorepo.
    Runs vitest with coverage and parses the output.
  parameters:
    - name: package
      type: string
      required: false
      description: "Package name (e.g., @repo/gallery-core). If omitted, runs monorepo-wide."
    - name: format
      type: enum
      values: [summary, detailed, json]
      default: summary
      description: "Output format"
  implementation: |
    ```bash
    # Summary
    pnpm --filter ${package} test -- --coverage --reporter=text-summary

    # Detailed
    pnpm --filter ${package} test -- --coverage --reporter=text

    # JSON (for programmatic use)
    pnpm --filter ${package} test -- --coverage --reporter=json
    ```
  output_schema:
    type: object
    properties:
      lines: { type: number, description: "Line coverage %" }
      branches: { type: number, description: "Branch coverage %" }
      functions: { type: number, description: "Function coverage %" }
      statements: { type: number, description: "Statement coverage %" }
      uncovered_files: { type: array, items: { type: string } }
  tags: [testing, coverage, metrics]

- id: tool-test-002
  name: get_failing_tests
  description: |
    Returns list of currently failing tests. Useful for agents to understand
    what's broken before making changes.
  parameters:
    - name: package
      type: string
      required: false
      description: "Package name. If omitted, runs monorepo-wide."
    - name: include_output
      type: boolean
      default: false
      description: "Include full error output for each failure"
  implementation: |
    ```bash
    pnpm --filter ${package} test -- --reporter=json 2>&1 | \
      jq '.testResults[] | select(.status == "failed")'
    ```
  output_schema:
    type: array
    items:
      type: object
      properties:
        file: { type: string }
        test_name: { type: string }
        error_message: { type: string }
        error_stack: { type: string }
  tags: [testing, failures, diagnostics]

- id: tool-test-003
  name: run_tests_for_files
  description: |
    Runs tests related to specific files. Useful after making changes to
    verify nothing broke.
  parameters:
    - name: files
      type: array
      items: { type: string }
      required: true
      description: "List of file paths that were changed"
  implementation: |
    ```bash
    pnpm vitest run --related ${files.join(' ')}
    ```
  output_schema:
    type: object
    properties:
      passed: { type: number }
      failed: { type: number }
      skipped: { type: number }
      failures: { type: array }
  tags: [testing, verification, incremental]

# =============================================================================
# LINT & TYPE CHECK TOOLS
# =============================================================================

- id: tool-lint-001
  name: get_lint_errors
  description: |
    Returns current ESLint errors and warnings. Can scope to specific files
    or packages.
  parameters:
    - name: files
      type: array
      items: { type: string }
      required: false
      description: "Specific files to lint"
    - name: package
      type: string
      required: false
      description: "Package to lint"
    - name: include_warnings
      type: boolean
      default: false
      description: "Include warnings in output"
  implementation: |
    ```bash
    pnpm eslint ${files.join(' ')} --format json
    ```
  output_schema:
    type: array
    items:
      type: object
      properties:
        file: { type: string }
        line: { type: number }
        column: { type: number }
        rule: { type: string }
        message: { type: string }
        severity: { type: string, enum: [error, warning] }
  tags: [lint, eslint, code-quality]

- id: tool-lint-002
  name: get_type_errors
  description: |
    Returns current TypeScript type errors. Essential before claiming
    implementation is complete.
  parameters:
    - name: package
      type: string
      required: false
      description: "Package to type-check"
  implementation: |
    ```bash
    pnpm --filter ${package} check-types 2>&1 | \
      grep -E "error TS[0-9]+"
    ```
  output_schema:
    type: array
    items:
      type: object
      properties:
        file: { type: string }
        line: { type: number }
        column: { type: number }
        code: { type: string, description: "TS error code like TS2322" }
        message: { type: string }
  tags: [typescript, types, compilation]

# =============================================================================
# GITHUB INTEGRATION TOOLS
# =============================================================================

- id: tool-github-001
  name: get_open_issues
  description: |
    Returns open GitHub issues, optionally filtered by labels or assignee.
  parameters:
    - name: labels
      type: array
      items: { type: string }
      required: false
      description: "Filter by labels"
    - name: assignee
      type: string
      required: false
      description: "Filter by assignee"
    - name: limit
      type: number
      default: 20
      description: "Maximum issues to return"
  implementation: |
    ```bash
    gh issue list --state open \
      --label "${labels.join(',')}" \
      --assignee "${assignee}" \
      --limit ${limit} \
      --json number,title,labels,assignees,createdAt
    ```
  output_schema:
    type: array
    items:
      type: object
      properties:
        number: { type: number }
        title: { type: string }
        labels: { type: array }
        assignees: { type: array }
        created_at: { type: string }
        url: { type: string }
  tags: [github, issues, tracking]

- id: tool-github-002
  name: get_open_prs
  description: |
    Returns open pull requests with review status.
  parameters:
    - name: author
      type: string
      required: false
    - name: limit
      type: number
      default: 10
  implementation: |
    ```bash
    gh pr list --state open \
      --author "${author}" \
      --limit ${limit} \
      --json number,title,author,reviewDecision,statusCheckRollup
    ```
  output_schema:
    type: array
    items:
      type: object
      properties:
        number: { type: number }
        title: { type: string }
        author: { type: string }
        review_status: { type: string }
        checks_passing: { type: boolean }
  tags: [github, prs, reviews]

- id: tool-github-003
  name: get_pr_comments
  description: |
    Returns comments on a specific PR, useful for understanding review feedback.
  parameters:
    - name: pr_number
      type: number
      required: true
  implementation: |
    ```bash
    gh api repos/{owner}/{repo}/pulls/${pr_number}/comments \
      --jq '.[] | {path, line, body, author: .user.login}'
    ```
  output_schema:
    type: array
    items:
      type: object
      properties:
        path: { type: string }
        line: { type: number }
        body: { type: string }
        author: { type: string }
  tags: [github, prs, comments, reviews]

# =============================================================================
# BUILD & DEPENDENCY TOOLS
# =============================================================================

- id: tool-build-001
  name: get_build_status
  description: |
    Returns build status for packages. Identifies which packages have
    build failures.
  parameters:
    - name: package
      type: string
      required: false
      description: "Specific package, or omit for all"
  implementation: |
    ```bash
    pnpm --filter ${package} build 2>&1
    ```
  output_schema:
    type: object
    properties:
      success: { type: boolean }
      failed_packages: { type: array, items: { type: string } }
      errors: { type: array }
  tags: [build, compilation, packages]

- id: tool-build-002
  name: get_outdated_deps
  description: |
    Returns outdated dependencies across the monorepo.
  parameters:
    - name: package
      type: string
      required: false
    - name: include_dev
      type: boolean
      default: true
  implementation: |
    ```bash
    pnpm outdated --json
    ```
  output_schema:
    type: array
    items:
      type: object
      properties:
        package: { type: string }
        current: { type: string }
        wanted: { type: string }
        latest: { type: string }
        dependent: { type: string, description: "Which workspace package uses this" }
  tags: [dependencies, outdated, maintenance]

# =============================================================================
# DATABASE TOOLS
# =============================================================================

- id: tool-db-001
  name: get_migration_status
  description: |
    Returns pending and applied database migrations.
  parameters: []
  implementation: |
    ```bash
    pnpm --filter @repo/database-schema db:status
    ```
  output_schema:
    type: object
    properties:
      applied: { type: array, items: { type: string } }
      pending: { type: array, items: { type: string } }
      last_applied_at: { type: string }
  tags: [database, migrations, status]

- id: tool-db-002
  name: get_table_schema
  description: |
    Returns schema for a specific table. Useful for understanding data model.
  parameters:
    - name: table_name
      type: string
      required: true
  implementation: |
    ```bash
    psql -c "\\d+ ${table_name}"
    ```
  output_schema:
    type: object
    properties:
      columns: { type: array }
      indexes: { type: array }
      foreign_keys: { type: array }
      constraints: { type: array }
  tags: [database, schema, introspection]

# =============================================================================
# STORY & WORKFLOW TOOLS
# =============================================================================

- id: tool-story-001
  name: get_story_status
  description: |
    Returns current status of stories in the workflow system.
  parameters:
    - name: status
      type: string
      required: false
      description: "Filter by status (pending, in-progress, done, etc.)"
    - name: epic
      type: string
      required: false
      description: "Filter by epic prefix"
  implementation: |
    ```bash
    # Parse story index file
    cat plans/stories/sets.stories.index.md | \
      grep -E "^\\| [A-Z]+-[0-9]+" | \
      awk -F'|' '{print $2, $3, $4}'
    ```
  output_schema:
    type: array
    items:
      type: object
      properties:
        story_id: { type: string }
        title: { type: string }
        status: { type: string }
        epic: { type: string }
  tags: [stories, workflow, tracking]

- id: tool-story-002
  name: get_story_details
  description: |
    Returns full details for a specific story including ACs and implementation notes.
  parameters:
    - name: story_id
      type: string
      required: true
      description: "Story ID like WRKF-1021"
  implementation: |
    ```bash
    # Find and read story file
    find plans/stories -name "${story_id}*.md" -exec cat {} \\;
    ```
  output_schema:
    type: object
    properties:
      id: { type: string }
      title: { type: string }
      description: { type: string }
      acceptance_criteria: { type: array }
      status: { type: string }
      implementation_notes: { type: string }
  tags: [stories, details, requirements]

# =============================================================================
# IMPLEMENTATION NOTES
# =============================================================================

# MCP Server Structure:
#
# packages/tools/mcp-knowledgebase/
#   src/
#     server.ts              # MCP server entry
#     tools/
#       test-coverage.ts     # tool-test-001, tool-test-002, tool-test-003
#       lint-check.ts        # tool-lint-001, tool-lint-002
#       github.ts            # tool-github-001, tool-github-002, tool-github-003
#       build.ts             # tool-build-001, tool-build-002
#       database.ts          # tool-db-001, tool-db-002
#       stories.ts           # tool-story-001, tool-story-002
#     knowledge/
#       loader.ts            # Loads YAML seed files
#       search.ts            # Semantic search over knowledge
#
# Each tool:
# 1. Validates parameters
# 2. Executes command (bash, API call, file read)
# 3. Parses output into structured schema
# 4. Returns JSON to agent
#
# Caching strategy:
# - Test/lint results: no cache (always fresh)
# - GitHub issues: 5 minute cache
# - Outdated deps: 1 hour cache
# - Migration status: no cache
