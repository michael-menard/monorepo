---
story_id: KNOW-0053
title: "MCP Admin Tool Stubs"
status: ready-to-work
split_from: KNOW-005
split_part: 3 of 3
created: 2026-01-25
updated: 2026-01-25
assignee: null
story_points: 2
priority: P0
depends_on: [KNOW-0051]
blocks: [KNOW-006, KNOW-007]
tags:
  - knowledge-base
  - mcp
  - backend
  - admin
---

# KNOW-0053: MCP Admin Tool Stubs

## Split Context

This story is part of a split from KNOW-005 (MCP Server Setup).

- **Original Story:** KNOW-005
- **Split Reason:** Story exceeded sizing guidelines with 10 acceptance criteria and 10 tools. Split to reduce complexity and enable parallel development.
- **This Part:** 3 of 3 (Admin Tools - stubs with deferred implementation)
- **Dependency:** Depends on KNOW-0051 (MCP Server Foundation)
- **Unblocks:** KNOW-006 (Parsers and Seeding), KNOW-007 (Admin Tools and Polish)

## Context

KNOW-0051 established the foundational MCP server infrastructure with 5 CRUD tools. This story adds 3 admin tools (kb_bulk_import, kb_rebuild_embeddings, kb_stats) plus 1 operational tool (kb_health) to complete the 10-tool MCP server implementation.

**Critical Scope Decision:**
- kb_bulk_import implementation is deferred to KNOW-006 (Parsers and Seeding)
- kb_rebuild_embeddings implementation is deferred to KNOW-007 (Admin Tools and Polish)
- This story implements these tools as **stubs** that return "not implemented" with clear TODO links to follow-up stories
- kb_stats has basic implementation (simple database queries)
- kb_health has full implementation (server status checking)

**Architectural Decisions:**
- Admin tools follow same thin wrapper pattern as CRUD tools
- Stubs include clear error messages directing users to follow-up stories
- Tool access control stubs added with TODOs linking to KNOW-009
- Result caching stubs added with TODOs linking to KNOW-021
- Transaction semantics documented for future bulk import implementation

## Goal

Add 4 admin/operational tools to the MCP server (kb_bulk_import, kb_rebuild_embeddings, kb_stats, kb_health) with deferred implementation for bulk import and rebuild embeddings, enabling follow-up stories to complete the functionality.

**Primary deliverables:**
1. kb_bulk_import tool stub (returns "not implemented, see KNOW-006")
2. kb_rebuild_embeddings tool stub (returns "not implemented, see KNOW-007")
3. kb_stats tool with basic implementation
4. kb_health tool with full implementation
5. Tool access control stubs with TODOs (links to KNOW-009)
6. Result caching stubs with TODOs (links to KNOW-021)
7. Transaction semantics documentation
8. Embedding regeneration transparency in responses

## Non-Goals

- ❌ Full kb_bulk_import implementation (defer to KNOW-006)
- ❌ Full kb_rebuild_embeddings implementation (defer to KNOW-007)
- ❌ YAML parsing logic (defer to KNOW-006)
- ❌ Authentication/authorization implementation (stubs only, defer to KNOW-009)
- ❌ Rate limiting implementation (defer to KNOW-010)
- ❌ Result caching implementation (stubs only, defer to KNOW-021)
- ❌ AWS deployment (MCP server runs locally for MVP)

## Scope

### Packages Affected

**Primary:**
- `apps/api/knowledge-base/src/mcp-server/tool-handlers.ts` - Add 4 admin tool handlers
- `apps/api/knowledge-base/src/mcp-server/tool-schemas.ts` - Add schemas for admin tools
- `apps/api/knowledge-base/src/mcp-server/access-control.ts` - Add access control stubs (new file)
- `apps/api/knowledge-base/src/mcp-server/__tests__/` - Add admin tool tests
  - `admin-tools.test.ts` - Admin tool handler tests
  - `access-control.test.ts` - Access control stub tests

**Secondary:**
- `apps/api/knowledge-base/docs/TRANSACTION-SEMANTICS.md` - Transaction semantics documentation (new)
- `apps/api/knowledge-base/docs/EMBEDDING-REGENERATION.md` - Embedding regeneration transparency documentation (new)

### MCP Tools Implemented (4 Admin/Operational Tools)

**1. kb_bulk_import** - Bulk import from YAML (STUB)
```typescript
kb_bulk_import({
  file_path: string
})
// Returns: { error: "NOT_IMPLEMENTED", message: "Bulk import deferred to KNOW-006", todo: "See KNOW-006 story" }
```

**2. kb_rebuild_embeddings** - Rebuild embeddings for entries (STUB)
```typescript
kb_rebuild_embeddings({
  entry_ids?: string[]  // If omitted, rebuilds all
})
// Returns: { error: "NOT_IMPLEMENTED", message: "Rebuild embeddings deferred to KNOW-007", todo: "See KNOW-007 story" }
```

**3. kb_stats** - Get knowledge base statistics (BASIC IMPLEMENTATION)
```typescript
kb_stats()
// Returns: { total_entries, by_role, by_type, top_tags }
```

**4. kb_health** - Get server status (FULL IMPLEMENTATION)
```typescript
kb_health()
// Returns: { status: "healthy" | "degraded" | "unhealthy", checks: { db, openai_api, mcp_server }, uptime_ms, version }
```

### Database Tables

**Read-only operations:**
- kb_stats queries knowledge_entries table for counts and aggregations
- kb_health checks database connectivity
- kb_bulk_import and kb_rebuild_embeddings are stubs (no database access)

## Acceptance Criteria

### AC1: kb_bulk_import Tool Stub

**Given** kb_bulk_import tool is invoked
**When** tool handler executes
**Then**:
- ✅ Tool registered with MCP server
- ✅ Tool schema includes file_path parameter
- ✅ Tool handler returns structured error: `{ error: "NOT_IMPLEMENTED", message: "Bulk import deferred to KNOW-006. Use kb_add for single entries.", todo: "See KNOW-006 story" }`
- ✅ Tool handler logs invocation at info level
- ✅ Tool handler does NOT attempt to read file or import data
- ✅ Documentation includes TODO comment linking to KNOW-006

---

### AC2: kb_rebuild_embeddings Tool Stub

**Given** kb_rebuild_embeddings tool is invoked
**When** tool handler executes
**Then**:
- ✅ Tool registered with MCP server
- ✅ Tool schema includes optional entry_ids parameter
- ✅ Tool handler returns structured error: `{ error: "NOT_IMPLEMENTED", message: "Rebuild embeddings deferred to KNOW-007. Embeddings regenerate automatically on kb_update.", todo: "See KNOW-007 story" }`
- ✅ Tool handler logs invocation at info level
- ✅ Tool handler does NOT attempt to rebuild embeddings
- ✅ Documentation includes TODO comment linking to KNOW-007

---

### AC3: kb_stats Tool Basic Implementation

**Given** knowledge base has entries
**When** kb_stats tool is invoked
**Then**:
- ✅ Tool handler queries database for statistics
- ✅ Returns total_entries count
- ✅ Returns by_role breakdown (pm, dev, qa, all counts)
- ✅ Returns by_type breakdown (fact, summary, template counts) if entry_type column exists
- ✅ Returns top_tags (top 10 most common tags with counts)
- ✅ Performance target: < 1s for dataset up to 10,000 entries
- ✅ Tool handler logs query_time_ms
- ✅ Tool handler sanitizes errors

**Example response:**
```json
{
  "total_entries": 150,
  "by_role": {
    "pm": 40,
    "dev": 60,
    "qa": 30,
    "all": 20
  },
  "by_type": {
    "fact": 80,
    "summary": 50,
    "template": 20
  },
  "top_tags": [
    { "tag": "validation", "count": 25 },
    { "tag": "testing", "count": 20 },
    { "tag": "architecture", "count": 15 }
  ]
}
```

---

### AC4: kb_health Tool Full Implementation

**Given** MCP server is running
**When** kb_health tool is invoked
**Then**:
- ✅ Tool handler checks database connectivity (simple SELECT 1 query)
- ✅ Tool handler checks OpenAI API connectivity (simple health check or cached status)
- ✅ Tool handler checks MCP server status (uptime, version)
- ✅ Returns overall status: "healthy" (all checks pass), "degraded" (some checks fail), "unhealthy" (critical checks fail)
- ✅ Returns individual check results with pass/fail and error message
- ✅ Returns uptime_ms (server uptime since startup)
- ✅ Returns version (package.json version)
- ✅ Performance target: < 500ms
- ✅ Tool handler logs health check results at debug level

**Example response:**
```json
{
  "status": "healthy",
  "checks": {
    "db": { "status": "pass", "latency_ms": 5 },
    "openai_api": { "status": "pass", "latency_ms": 200 },
    "mcp_server": { "status": "pass", "uptime_ms": 3600000 }
  },
  "uptime_ms": 3600000,
  "version": "1.0.0"
}
```

---

### AC5: Tool Access Control Stubs

**Given** tool access control is planned for KNOW-009
**When** implementing access control stubs
**Then**:
- ✅ Create `access-control.ts` module with stub functions
- ✅ Add `checkAccess(toolName, agentRole)` stub that always returns true
- ✅ Add TODO comments linking to KNOW-009
- ✅ Document planned access control matrix in stub file
- ✅ All tool handlers call `checkAccess()` stub (no-op for now)
- ✅ Tests verify stub is called (future-proofs for KNOW-009)

**Planned access control matrix (documented in stubs):**
```
| Tool                  | pm | dev | qa | all |
|-----------------------|----|-----|----|----|
| kb_add                | ✅ | ✅  | ✅ | ✅ |
| kb_get                | ✅ | ✅  | ✅ | ✅ |
| kb_update             | ✅ | ✅  | ✅ | ✅ |
| kb_delete             | ✅ | ❌  | ❌ | ❌ |
| kb_list               | ✅ | ✅  | ✅ | ✅ |
| kb_search             | ✅ | ✅  | ✅ | ✅ |
| kb_get_related        | ✅ | ✅  | ✅ | ✅ |
| kb_bulk_import        | ✅ | ❌  | ❌ | ❌ |
| kb_rebuild_embeddings | ✅ | ❌  | ❌ | ❌ |
| kb_stats              | ✅ | ✅  | ✅ | ✅ |
| kb_health             | ✅ | ✅  | ✅ | ✅ |
```

---

### AC6: Result Caching Stubs

**Given** result caching is planned for KNOW-021
**When** implementing caching stubs
**Then**:
- ✅ Add `cacheGet(key)` stub that always returns null (cache miss)
- ✅ Add `cacheSet(key, value, ttl)` stub that does nothing
- ✅ Add TODO comments linking to KNOW-021
- ✅ Document planned caching strategy in stub file
- ✅ kb_stats and kb_search handlers call caching stubs (future-proofs for KNOW-021)
- ✅ Tests verify caching stubs are called

**Planned caching strategy (documented in stubs):**
- kb_stats: Cache for 60s (infrequently changing aggregates)
- kb_search: Cache for 5s with query hash as key (reduce duplicate searches)
- kb_get_related: Cache for 60s with entry_id as key (stable relationships)

---

### AC7: Transaction Semantics Documentation

**Given** bulk import will support partial commits in KNOW-006
**When** documenting transaction semantics
**Then**:
- ✅ Create `TRANSACTION-SEMANTICS.md` documentation
- ✅ Document: kb_bulk_import uses partial commits (each entry committed individually)
- ✅ Document: Failure on entry N does NOT rollback entries 1..N-1
- ✅ Document: Failed entries returned in `failed` array with error messages
- ✅ Document: Rationale: Large imports should not fail atomically (10k entries)
- ✅ Document: Trade-off: Partial success vs full rollback
- ✅ Document: How to handle partial failures (manual cleanup, retry failed entries)

**Location:** `apps/api/knowledge-base/docs/TRANSACTION-SEMANTICS.md`

---

### AC8: Embedding Regeneration Transparency

**Given** kb_update regenerates embeddings when content changes
**When** documenting embedding regeneration behavior
**Then**:
- ✅ Create `EMBEDDING-REGENERATION.md` documentation
- ✅ Document: kb_update regenerates embeddings if content changes
- ✅ Document: kb_update does NOT regenerate if only tags or role change
- ✅ Document: kb_update response includes `embedding_regenerated: boolean` flag
- ✅ Document: kb_rebuild_embeddings (KNOW-007) forces regeneration regardless of content changes
- ✅ Document: Use cases for manual rebuild (model upgrade, cache invalidation)
- ✅ Update kb_update handler to include `embedding_regenerated` flag in response

**Location:** `apps/api/knowledge-base/docs/EMBEDDING-REGENERATION.md`

---

### AC9: Test Coverage

**Given** test suite is executed
**When** measuring coverage
**Then**:
- ✅ Minimum 80% line coverage for admin tool handlers
- ✅ All happy path scenarios tested (4 admin tools × basic invocation)
- ✅ Stub behaviors tested (kb_bulk_import, kb_rebuild_embeddings return NOT_IMPLEMENTED)
- ✅ kb_stats tested with realistic data (100+ entries)
- ✅ kb_health tested with all checks passing and failing
- ✅ Access control stubs verified (called but always return true)
- ✅ Result caching stubs verified (called but always cache miss)

---

## Reuse Plan

### Reusing from Existing Packages

**1. MCP Server Foundation (KNOW-0051)**
- Location: `apps/api/knowledge-base/src/mcp-server`
- Usage: Server infrastructure, error sanitization, logging patterns, tool registration
- Benefits: Proven MCP integration, test harness

**2. CRUD Operations (KNOW-003)**
- Location: `apps/api/knowledge-base/src/crud-operations`
- Usage: Database queries for kb_stats
- Benefits: Proven database access patterns

**3. @repo/logger**
- Location: `packages/core/logger`
- Usage: All logging
- Benefits: Structured logging, consistent format

---

## Architecture Notes

### Admin Tool Stub Pattern

**Stub Implementation:**
```typescript
async function kb_bulk_import_handler(input: KbBulkImportInput): Promise<KbBulkImportResult> {
  logger.info('kb_bulk_import tool invoked (STUB)', { file_path: input.file_path })

  // TODO: Full implementation in KNOW-006
  return {
    error: 'NOT_IMPLEMENTED',
    message: 'Bulk import deferred to KNOW-006. Use kb_add for single entries.',
    todo: 'See KNOW-006 story',
  }
}
```

**Benefits:**
- Tool is discoverable in Claude Code
- Users receive clear guidance on next steps
- Enables follow-up stories to complete implementation without refactoring
- Reduces cognitive load in KNOW-0051 (foundation story)

---

## Infrastructure Notes

### No New Infrastructure Required

All infrastructure provisioned in KNOW-001:
- PostgreSQL with pgvector extension (Docker Compose)
- Database schema with all necessary indexes

---

## Test Plan

### Test Coverage Summary

**Scope:**
- 4 MCP admin/operational tools
- Access control stubs
- Result caching stubs
- Transaction semantics documentation
- Embedding regeneration transparency

**Test Files:**
```
apps/api/knowledge-base/src/mcp-server/__tests__/
  admin-tools.test.ts       # Admin tool handler tests
  access-control.test.ts    # Access control stub tests
```

**Coverage targets:**
- Unit tests: >80% coverage for admin tool handlers
- Integration tests: All happy paths, error cases, edge cases

### Happy Path Tests (4)

1. **kb_bulk_import Stub** - Invoked, returns NOT_IMPLEMENTED
2. **kb_rebuild_embeddings Stub** - Invoked, returns NOT_IMPLEMENTED
3. **kb_stats Basic Implementation** - Returns correct statistics
4. **kb_health Full Implementation** - All checks pass, returns healthy

### Error Cases (3)

1. **kb_stats Database Error** - Connection failure, sanitized error returned
2. **kb_health Database Unreachable** - Returns degraded status
3. **kb_health OpenAI API Unreachable** - Returns degraded status

### Edge Cases (3)

1. **kb_stats with Empty Database** - Returns zero counts, no error
2. **kb_stats with 10,000 Entries** - Performance < 1s
3. **kb_health with Partial Failures** - Some checks pass, some fail, returns degraded

---

## Risks and Mitigations

### Risk 1: Stub Pattern Confusion

**Risk**: Users may be confused when kb_bulk_import and kb_rebuild_embeddings return "not implemented" errors.

**Mitigation**:
- Clear error messages with TODO links to follow-up stories
- Documentation in tool descriptions
- Log invocations at info level for visibility
- Provide workarounds in error messages (e.g., "Use kb_add for single entries")

---

### Risk 2: kb_stats Performance at Scale

**Risk**: kb_stats may be slow with 10,000+ entries if aggregation queries are not optimized.

**Mitigation**:
- Performance target: < 1s for 10,000 entries (AC3)
- Test with realistic dataset (edge case 2)
- Document scaling recommendations (consider caching for large datasets)
- Future optimization: KNOW-021 adds caching

---

### Risk 3: kb_health False Positives

**Risk**: Health checks may pass when system is degraded (e.g., OpenAI API slow but not failing).

**Mitigation**:
- Include latency_ms in health check responses
- Document expected latency ranges
- Log health checks at debug level for debugging
- Future enhancement: Add latency thresholds for "degraded" status

---

## Definition of Done

- [ ] kb_bulk_import tool stub implemented
- [ ] kb_rebuild_embeddings tool stub implemented
- [ ] kb_stats tool basic implementation complete
- [ ] kb_health tool full implementation complete
- [ ] Tool access control stubs implemented with TODO links to KNOW-009
- [ ] Result caching stubs implemented with TODO links to KNOW-021
- [ ] TRANSACTION-SEMANTICS.md documentation created
- [ ] EMBEDDING-REGENERATION.md documentation created
- [ ] kb_update response includes embedding_regenerated flag
- [ ] Test suite passing with ≥80% coverage
- [ ] All happy path tests passing (4 tests)
- [ ] All error case tests passing (3 tests)
- [ ] All edge case tests passing (3 tests)
- [ ] TypeScript compilation clean (no errors)
- [ ] Code follows monorepo conventions (Zod-first types, no barrel files)
- [ ] PROOF-KNOW-0053.md document created with evidence
- [ ] Story status updated to "ready-for-code-review"

---

## Related Stories

- **KNOW-0051**: MCP Server Foundation + CRUD Tools (prerequisite)
- **KNOW-0052**: MCP Search Tools + Deployment Topology (parallel, depends on KNOW-0051)
- **KNOW-006**: Parsers and Seeding (depends on KNOW-0053, implements kb_bulk_import)
- **KNOW-007**: Admin Tools and Polish (depends on KNOW-0053, implements kb_rebuild_embeddings)
- **KNOW-009**: MCP Tool Authorization (implements access control stubs from KNOW-0053)
- **KNOW-021**: Cost Optimization (implements result caching stubs from KNOW-0053)

---

## Agent Log

| Timestamp | Agent | Action | Notes |
|-----------|-------|--------|-------|
| 2026-01-25 | pm-story-split-leader | Story created from split | Split from KNOW-005 due to sizing issues |

---

## Token Budget

Phase tracking will be added during implementation.

<!-- Token usage will be logged here via /token-log command -->

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-25_

### Gaps Identified (Resolved as AC Enhancements)

| # | Finding | User Decision | Implementation Notes |
|---|---------|---------------|---------------------|
| 1 | kb_health OpenAI implementation approach | Add as AC | Implement as: check if OPENAI_API_KEY env var is set + optional cached status from last embedding call |
| 2 | kb_stats schema flexibility (missing entry_type column) | Add as AC | Test case verifies graceful degradation when entry_type column doesn't exist |
| 3 | kb_stats top_tags ordering specification | Add as AC | Top 10 tags ordered by count descending (DESC in SQL query) |
| 4 | kb_health uptime tracking method | Skip developer detail | Use process.uptime() * 1000 or server start timestamp |
| 5 | Tool schema versioning for stubs | Add as AC | Stubs use same schema versioning pattern as CRUD tools from KNOW-0051 |
| 6 | Caching scope clarification (kb_search in KNOW-0052) | Clarify as AC | AC6 focuses on admin tools (kb_stats, kb_health); kb_search caching handled in KNOW-0052 |
| 7 | Access control matrix scope | Clarify as AC | Stubs cover all 10 tools for future-proofing; tests validate 4 admin tools thoroughly |
| 8 | kb_health latency thresholds | Add as AC | Document thresholds: DB <50ms healthy, 50-200ms degraded, >200ms unhealthy; etc. |

### Enhancement Opportunities (Resolved as AC Additions)

| # | Finding | User Decision | Implementation Notes |
|---|---------|---------------|---------------------|
| 1 | kb_stats cache metrics | Add as AC | Add cache_stats object: { cache_hit_rate: 0-1, total_cached_embeddings: number } |
| 2 | kb_health recent errors | Add as AC | Add recent_errors object tracking error count in last 5 minutes per subsystem |
| 3 | Stub availability timeline | Add as AC | Add available_since field to stub responses: "available_since": "KNOW-006" or "KNOW-007" |
| 4 | kb_stats cache staleness indicator | Add as AC | Add when caching enabled: cached: boolean, cached_at: ISO8601 timestamp |
| 5 | Access control debug logging | Add as AC | checkAccess() logs at debug level: tool name, agent role, access decision |
| 6 | kb_bulk_import file validation | Add as AC | Stub validates file_path exists; returns specific error if not found |
| 7 | Transaction retry strategies | Add as AC | TRANSACTION-SEMANTICS.md documents retry patterns for failed bulk import entries |
| 8 | kb_rebuild_embeddings ETA | Add as AC | Add estimated_duration field to stub response based on entry count estimate |

### Items Marked Out-of-Scope

- **Full kb_bulk_import implementation**: Deferred to KNOW-006 (Parsers and Seeding)
- **Full kb_rebuild_embeddings implementation**: Deferred to KNOW-007 (Admin Tools and Polish)
- **YAML parsing logic**: Deferred to KNOW-006
- **Authentication/authorization implementation**: Stubs only, deferred to KNOW-009
- **Rate limiting implementation**: Deferred to KNOW-010
- **Result caching implementation**: Stubs only, deferred to KNOW-021
- **AWS deployment**: MCP server runs locally for MVP
