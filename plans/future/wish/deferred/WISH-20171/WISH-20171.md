---
doc_type: story
title: "WISH-20171: Backend Combined Filter + Sort Queries"
story_id: WISH-20171
story_prefix: WISH
status: deferred
split_from: WISH-2017
split_part: 1 of 2
phase: 6
created_at: "2026-01-29T00:00:00-07:00"
updated_at: "2026-01-28T20:28:00-07:00"
depends_on: [WISH-2014]
estimated_points: 3
---

# WISH-20171: Backend Combined Filter + Sort Queries

## Split Context

This story is part of a split from WISH-2017.
- **Original Story:** WISH-2017 (Advanced Multi-Sort Filtering)
- **Split Reason:** Story was oversized (20 ACs) with significant frontend AND backend work. Split enables parallel development and independent testing of backend and frontend concerns.
- **This Part:** 1 of 2 (Backend implementation)
- **Dependency:** Depends on WISH-2014 (Smart Sorting Algorithms)

## Context

This is the backend portion of WISH-2017, focusing exclusively on extending the `GET /api/wishlist` endpoint with combined filter + sort query parameters. WISH-2014 established the foundation for smart sorting algorithms (Best Value, Expiring Soon, Hidden Gems). This story extends that backend implementation to support filtering by store, priority range, and price range in combination with those sorting algorithms.

The frontend filter panel UI is implemented separately in WISH-20172, which depends on this story.

## Goal

Implement backend support for combined filtering and sorting operations on the wishlist endpoint, enabling users to apply multiple criteria simultaneously (store, priority, price range) along with smart sort algorithms.

## Non-goals

- Frontend UI implementation (handled by WISH-20172)
- Real-time collaborative filtering (deferred to Phase 7)
- Saved filter presets (deferred to Phase 5 UX Polish)
- Custom user-defined filter logic (deferred to Phase 7)
- Machine learning-based recommendations (deferred to future epic)

## Scope

### Endpoints Affected

- **Extended**: `GET /api/wishlist` with combined query parameters

### Packages Affected

1. **Backend**: `apps/api/lego-api/domains/wishlist/`
   - `types.ts` - Extend query schema to support combined filters + sort
   - `application/wishlist-service.ts` - Update service logic for combined queries
   - `adapters/wishlist-repository.ts` - Implement Drizzle queries with WHERE + ORDER BY

2. **Shared Schemas**: `packages/core/api-client/src/schemas/wishlist.ts`
   - Extend `WishlistQueryParamsSchema` to validate combined parameters

### Database Impact

- **No Schema Changes**: Uses existing fields (store, priority, price, pieceCount, releaseDate)
- **Recommended**: Review existing composite indexes for optimal query performance with combined WHERE + ORDER BY

## Acceptance Criteria

### AC0 (New): Architecture Pattern Clarification

**Criterion**: Clarify whether lego-api uses hexagonal architecture (`domains/*/application/`) and is exempt from api-layer.md pattern, or should follow `apps/api/services/wishlist/` structure.

**Verification**:
- Document the architecture pattern decision in code comments or documentation
- Ensure consistent directory structure across all domains

**Notes**: Original elaboration identified architecture terminology mismatch. This AC ensures the implementation follows the agreed-upon pattern.

---

### AC1: Query schema supports combined filter + sort parameters

**Criterion**: Schema accepts combined filter parameters with proper validation
- Schema accepts: `{ store?: string[], priority?: { min: number, max: number }, priceRange?: { min: number, max: number }, sort?: 'bestValue' | 'expiringSoon' | 'hiddenGems' }`
- Zod validation enforces parameter types (store enum array, priority 0-5, price >= 0)
- 400 error returned for invalid combinations

**Amendment**: Specify comma-separated format for array parameters: `?store=LEGO,BrickLink`

**Verification**:
- Unit tests validate schema accepts valid parameters
- Unit tests validate schema rejects invalid parameters
- API returns 400 with descriptive error for validation failures

---

### AC2: Repository layer implements combined WHERE + ORDER BY queries

**Criterion**: Single Drizzle query applies all filters before sorting
- Single Drizzle query applies all filters before sorting
- Filters applied with AND logic: `WHERE store IN (...) AND priority BETWEEN ... AND price BETWEEN ...`
- Smart sort logic applied via ORDER BY clause (from WISH-2014)
- Query execution verified with EXPLAIN ANALYZE

**Verification**:
- Integration tests verify filtering logic correctness
- EXPLAIN ANALYZE output shows efficient query plan
- Query uses existing indexes effectively

---

### AC3: Null value handling works with combined filters

**Criterion**: Null values handled correctly across all filter types
- Items with null price excluded when priceRange filter applied
- Items with null priority excluded when priority filter applied
- Items with null store treated as "Other" (or excluded based on filter)
- Null handling documented in API contract

**Verification**:
- Unit tests verify null value handling for each filter type
- Integration tests confirm API behavior with null values
- Documentation clearly describes null handling behavior

---

### AC4: Pagination works correctly with combined filters

**Criterion**: Pagination respects filter criteria
- Total count reflects filtered items only
- Page boundaries respect filter criteria
- Pagination metadata includes filter context

**Verification**:
- Integration tests verify pagination with filters applied
- Total count matches filtered result set
- Page navigation works correctly with filters

---

### AC5: Backend unit tests cover combined filter scenarios

**Criterion**: Comprehensive unit test coverage for filter combinations
- Test: Store filter + Best Value sort (10+ tests)
- Test: Priority range + Hidden Gems sort (10+ tests)
- Test: Price range + Expiring Soon sort (10+ tests)
- Test: All filters combined with each sort mode (15+ tests)
- Minimum: 45 unit tests total

**Verification**:
- All 45+ unit tests pass
- Test coverage includes edge cases and boundary conditions
- Tests verify correct query construction

---

### AC6: Integration tests verify endpoint behavior

**Criterion**: HTTP integration tests validate end-to-end behavior
- `.http` file includes combined filter + sort requests
- Response structure matches `WishlistListResponseSchema`
- Items array verified against filter + sort logic
- Evidence: Request/response examples in `.http` file

**Verification**:
- HTTP test file created with 18+ test scenarios
- All requests return expected results
- Response schemas validated

---

### AC15: Frontend and backend Zod schemas define identical filter structures

**Criterion**: Schema synchronization between frontend and backend
- Both define: `{ store?: string[], priority?: { min: number, max: number }, priceRange?: { min: number, max: number } }`
- Alignment test verifies schemas match (similar to WISH-2000 pattern)
- TypeScript compilation passes across all packages

**Verification**:
- Schema alignment test passes
- No TypeScript compilation errors
- Schemas are exported from shared location

---

### AC16: Invalid filter combinations return 400 error

**Criterion**: Proper error handling for invalid parameters
- Request: `GET /api/wishlist?priority=6` (out of range)
- Response: 400 with validation error message
- Error message lists valid ranges

**Verification**:
- Integration tests verify 400 responses for invalid inputs
- Error messages are descriptive and actionable
- All validation rules enforced

---

### AC18: Combined query performance meets requirements

**Criterion**: Performance requirements met for all filter combinations
- All filter + sort combinations complete < 2s with 1000+ items
- Database indexes reviewed and optimized for common filter combinations
- `EXPLAIN ANALYZE` output documented for query plan review

**Verification**:
- Performance tests verify < 2s response time
- Query plans analyzed and documented
- Indexes added if needed for performance

---

## Reuse Plan

### Existing Components

- âœ… `GET /api/wishlist` endpoint (extend with filter parameters)
- âœ… Smart sort algorithms: bestValue, expiringSoon, hiddenGems (from WISH-2014)
- âœ… Zod schema validation (extend existing query schema)
- âœ… Drizzle query builder for database filtering + sorting

### Existing Patterns

- âœ… Error handling patterns from WISH-2001
- âœ… Repository pattern from existing wishlist domain
- âœ… Hexagonal architecture (ports & adapters)

### New Components (to build)

- ðŸ†• Extended `ListWishlistQuerySchema` with filter parameters
- ðŸ†• Repository methods for combined WHERE + ORDER BY queries
- ðŸ†• Schema alignment tests

## Architecture Notes

### Hexagonal Architecture Compliance

**Domain Layer** (Business Logic):
- `apps/api/lego-api/domains/wishlist/application/wishlist-service.ts`
- Update `listItems()` method to accept filter parameters
- Pure business logic - no database coupling

**Adapter Layer** (Infrastructure):
- `apps/api/lego-api/domains/wishlist/adapters/wishlist-repository.ts`
- Implement Drizzle queries with combined WHERE + ORDER BY
- Handle null values using SQL CASE statements
- Use `sql` template for complex conditions

**Port Layer** (Contracts):
- `apps/api/lego-api/domains/wishlist/types.ts`
- Extend `ListWishlistQuerySchema` with filter parameters
- Define input/output contracts

**No Architecture Violations**: Story extends existing layers without coupling

### Filter Query Example

**Repository Layer**:
```typescript
// apps/api/lego-api/domains/wishlist/adapters/wishlist-repository.ts
async findByUser(userId: string, pagination, filters) {
  let query = db
    .select()
    .from(wishlistItems)
    .where(eq(wishlistItems.userId, userId))

  // Apply store filter
  if (filters.store?.length > 0) {
    query = query.where(inArray(wishlistItems.store, filters.store))
  }

  // Apply priority range filter
  if (filters.priority) {
    query = query.where(
      and(
        gte(wishlistItems.priority, filters.priority.min),
        lte(wishlistItems.priority, filters.priority.max)
      )
    )
  }

  // Apply price range filter
  if (filters.priceRange) {
    query = query.where(
      and(
        gte(wishlistItems.price, filters.priceRange.min),
        lte(wishlistItems.price, filters.priceRange.max)
      )
    )
  }

  // Apply smart sort (from WISH-2014)
  if (filters.sort === 'bestValue') {
    query = query.orderBy(
      sql`${wishlistItems.price}::numeric / NULLIF(${wishlistItems.pieceCount}, 0) ASC`
    )
  }
  // ... other sort modes

  return await query.limit(pagination.limit).offset(pagination.offset)
}
```

## HTTP Contract Plan

### Extended Endpoint: GET /api/wishlist

**Combined Query Parameters**:
```typescript
{
  // Filters
  store?: ('LEGO' | 'BrickLink' | 'Amazon' | 'Other')[]
  priority?: { min: number, max: number }  // 0-5
  priceRange?: { min: number, max: number }  // >= 0

  // Sort (from WISH-2014)
  sort?: 'bestValue' | 'expiringSoon' | 'hiddenGems'
  order?: 'asc' | 'desc'

  // Pagination (existing)
  page?: number
  limit?: number
}
```

**Example Requests**:
```http
# Store filter + Best Value sort
GET /api/wishlist?store=LEGO,BrickLink&sort=bestValue
Authorization: Bearer <token>

# Priority range + Hidden Gems sort
GET /api/wishlist?priority=3,5&sort=hiddenGems
Authorization: Bearer <token>

# All filters + Expiring Soon sort
GET /api/wishlist?store=LEGO&priority=2,4&priceRange=50,200&sort=expiringSoon
Authorization: Bearer <token>
```

**Response Format**:
```json
{
  "items": [
    {
      "id": "uuid",
      "title": "Millennium Falcon",
      "price": "149.99",
      "pieceCount": 1351,
      "releaseDate": "2018-09-01T00:00:00Z",
      "priority": 3,
      "store": "LEGO"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 12,
    "totalPages": 1
  },
  "appliedFilters": {
    "store": ["LEGO"],
    "priority": { "min": 2, "max": 4 },
    "priceRange": { "min": 50, "max": 200 },
    "sort": "expiringSoon"
  }
}
```

**Error Responses**:
```json
// 400 - Invalid filter parameter
{
  "error": "Validation failed",
  "details": {
    "fieldErrors": {
      "priority": ["min must be >= 0 and <= 5"]
    }
  }
}
```

## Test Plan

### Backend Unit Tests

**Service Layer Tests**:
1. Store filter + Best Value sort - 10 tests
2. Priority range + Hidden Gems sort - 10 tests
3. Price range + Expiring Soon sort - 10 tests
4. All filters combined - 15 tests
5. Null value handling with filters - 10 tests

**Minimum**: 45 unit tests total (extends WISH-2014's 15 tests)

### Backend Integration Tests

**HTTP Tests** (`__http__/wishlist-advanced-filtering.http`):
- Happy path: All filter combinations with each sort mode (9 requests)
- Error cases: Invalid filter values (3 requests)
- Edge cases: Empty results, null values, boundary conditions (5 requests)
- Performance: 1000+ items with all filters (1 request with timing)

**Minimum**: 18 HTTP test scenarios

## Risks & Mitigations

### MVP-Critical Risks

1. **Query Performance Degradation**
   - Risk: Combined WHERE + ORDER BY queries may be slow with 1000+ items
   - Mitigation: Review existing indexes, add composite indexes if needed (e.g., `(userId, store, priority)`)
   - Acceptance Criteria: AC18 requires < 2s query time

2. **Schema Synchronization (Frontend â†” Backend)**
   - Risk: Filter parameter schemas may diverge between frontend and backend
   - Mitigation: AC15 requires alignment test (like WISH-2000)
   - Acceptance Criteria: AC15 validates schema parity

3. **Null Value Handling**
   - Risk: Inconsistent handling of null values across filters
   - Mitigation: AC3 requires explicit null handling specification
   - Acceptance Criteria: AC3 validates null handling behavior

## Implementation Notes

### Recommended Implementation Sequence

**Phase 1: Schema Extension** (Day 1 Morning)
1. Extend Zod schemas with filter parameters
2. Implement schema alignment tests
3. Update TypeScript types

**Phase 2: Repository Implementation** (Day 1 Afternoon - Day 2)
1. Implement Drizzle queries with WHERE + ORDER BY
2. Handle null values using SQL CASE statements
3. Add 45 unit tests

**Phase 3: Integration Testing** (Day 2 Afternoon - Day 3)
1. Create `.http` test file with 18 scenarios
2. Test all filter combinations
3. Verify query performance (< 2s)
4. Document query plans with EXPLAIN ANALYZE

**Estimated Total Effort**: 3 days (1 backend developer)

## Definition of Done

- [ ] All 9 Acceptance Criteria pass (AC0, AC1, AC2, AC3, AC4, AC5, AC6, AC15, AC16, AC18)
- [ ] Backend: 45 unit tests pass
- [ ] Backend: 18 integration tests pass (`.http` file)
- [ ] Backend: Query performance < 2s for 1000+ items with all filters
- [ ] Schema alignment test passes (frontend â†” backend)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved
- [ ] Documentation updated (API docs, architecture notes)
- [ ] QA verification complete

## Open Questions

None - Backend scope is clear and implementation-ready.

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Issues Found (Require Fixes)

| # | Issue | Severity | Required Fix |
|---|-------|----------|--------------|
| 1 | **Architecture Pattern Mismatch**: Story plans `lego-api/domains/wishlist/application/` but `docs/architecture/api-layer.md` requires `apps/api/services/wishlist/` | Medium | AC0 must resolve before implementation. Recommend: Update docs (Option 1) since all 6 existing domains already use domains/ pattern |
| 2 | **Query Parameter Format Ambiguity**: AC1 amendment specifies comma-separated format for store but doesn't specify priority/priceRange format | Low | Add to AC1: Specify exact query string format. Recommend: `?priority=3,5&priceRange=50,200` parsed to `{min: 3, max: 5}` objects |

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Cursor-based pagination for large datasets | Not Reviewed | Defer to Phase 7 (Performance Optimization) |
| 2 | Filter combination validation (min <= max) | Not Reviewed | Add to future story |
| 3 | Partial filter matches (LIKE queries) | Not Reviewed | Defer to Phase 7 (Advanced Search) |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Filter preset persistence | Not Reviewed | Defer to Phase 5 (UX Polish) as noted in Non-goals |
| 2 | Query result caching (Redis) | Not Reviewed | Defer to Phase 7 (Performance Optimization) |
| 3 | GraphQL-style field selection | Not Reviewed | Defer to Phase 8 (API Evolution) |
| 4 | Faceted search counts | Not Reviewed | Defer to Phase 6 or 7 (UX enhancement) |
| 5 | Smart sort algorithm explanations | Not Reviewed | Defer to Phase 5 (UX Polish) |
| 6 | Filter analytics/telemetry | Not Reviewed | Defer to Phase 6+ (Observability) |
| 7 | Database index optimization | Not Reviewed | COVERED by AC18 |

### Follow-up Stories Suggested

_None - All findings marked as "Not Reviewed" for parallel execution. Future enhancements tracked in _implementation/FUTURE-OPPORTUNITIES.md._

### Items Marked Out-of-Scope

_None - All findings marked as "Not Reviewed" for parallel execution._
