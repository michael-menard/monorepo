---
doc_type: story
title: "WISH-20280: Audit Logging for Flag Schedule Operations"
story_id: WISH-20280
story_prefix: WISH
status: deferred
phase: 3
created_at: "2026-01-30T00:00:00-07:00"
updated_at: "2026-01-30T00:00:00-07:00"
depends_on: [WISH-2119, WISH-2019]
follow_up_from: WISH-2119
estimated_points: 2
sizing_warning: false
---

# WISH-20280: Audit Logging for Flag Schedule Operations

## Follow-up Context

**Parent Story:** WISH-2119 (Flag scheduling)
**Source:** QA Discovery Notes - Follow-up Stories Suggested (Finding #7)
**Original Finding:** "Integration with WISH-2019 (audit logging: track which admin created/cancelled schedules)"
**Category:** Enhancement Opportunity
**Impact:** Medium (security observability and admin accountability)
**Effort:** Low (extends existing audit infrastructure)

## Context

WISH-2119 implements scheduled flag updates with admin endpoints for creating, listing, and cancelling schedules. However, it lacks audit trail for admin actions - there's no record of which admin created or cancelled a schedule. This creates accountability gaps for security audits and incident investigations.

WISH-2019 provides Redis infrastructure and audit logging patterns for feature flag operations. This story integrates WISH-2119 schedule operations into the audit logging system, tracking which admin performed each action with timestamps and context.

## Goal

Add comprehensive audit logging to flag schedule operations (create, cancel) to provide security observability and admin accountability, enabling investigation of schedule-related incidents and compliance with audit requirements.

## Non-goals

- **Audit UI/Dashboard** - defer to future admin dashboard story (read-only query interface)
- **Audit log retention policy** - defer to WISH-2019 or future story
- **Audit log export API** - defer to future story
- **Real-time audit alerts** - CloudWatch logs only in MVP
- **Schedule modification audit** - MVP only tracks create/cancel, not updates
- **Bulk operation audit** - single-schedule operations only

## Scope

### Endpoints Affected

**Modified Endpoints:**
- `POST /api/admin/flags/:flagKey/schedule` - Add audit logging on schedule creation
- `DELETE /api/admin/flags/:flagKey/schedule/:scheduleId` - Add audit logging on schedule cancellation

**Reused from WISH-2019:**
- Audit logging service from `apps/api/lego-api/core/audit/`
- Redis infrastructure for distributed logging
- CloudWatch structured logging patterns

### Packages Affected

1. **Backend - Config Domain**: `apps/api/lego-api/domains/config/`
   - `application/schedule-service.ts` - Add audit logging calls (modify)
   - `routes.ts` - Pass admin user ID to service layer (modify)

2. **Backend - Audit Infrastructure**: `apps/api/lego-api/core/audit/`
   - `audit-logger.ts` - Extend with schedule event types (modify or reuse existing)

3. **Database Schema**: `packages/backend/database-schema/`
   - `src/schema/feature-flags.ts` - Add created_by, cancelled_by columns to schedules table (modify)
   - `src/migrations/app/` - Migration for new columns (new)

4. **Shared Schemas**: `packages/core/api-client/src/schemas/`
   - `feature-flags.ts` - Update schedule schemas with admin tracking fields (modify)

### Database Schema Changes

**Add to feature_flag_schedules table:**
```sql
ALTER TABLE feature_flag_schedules
  ADD COLUMN created_by VARCHAR(255),
  ADD COLUMN cancelled_by VARCHAR(255),
  ADD COLUMN cancelled_at TIMESTAMP WITH TIME ZONE;
```

**Audit Event Types:**
- `flag_schedule.created` - Admin created schedule
- `flag_schedule.cancelled` - Admin cancelled schedule
- `flag_schedule.applied` - Cron job applied schedule (automatic)
- `flag_schedule.failed` - Cron job failed to apply schedule (automatic)

## Acceptance Criteria

### Database Schema Updates

**AC1**: Add admin tracking columns to schedules table
- Migration adds `created_by`, `cancelled_by`, `cancelled_at` columns
- `created_by` populated on POST schedule (admin user ID from JWT)
- `cancelled_by` populated on DELETE schedule (admin user ID from JWT)
- `cancelled_at` populated on DELETE schedule (timestamp of cancellation)
- All columns nullable (backward compatibility with existing schedules)
- Migration applied before deploying code changes

### Audit Logging Integration

**AC2**: Log schedule creation events
- Event type: `flag_schedule.created`
- Metadata: `{ scheduleId, flagKey, scheduledAt, updates, adminUserId, adminEmail }`
- Log level: INFO
- CloudWatch structured log format
- Integration test: Create schedule, assert audit event logged with correct metadata

**AC3**: Log schedule cancellation events
- Event type: `flag_schedule.cancelled`
- Metadata: `{ scheduleId, flagKey, scheduledAt, adminUserId, adminEmail, reason: "manual_cancellation" }`
- Log level: INFO
- CloudWatch structured log format
- Integration test: Cancel schedule, assert audit event logged with correct metadata

**AC4**: Log schedule application events (cron job)
- Event type: `flag_schedule.applied`
- Metadata: `{ scheduleId, flagKey, updates, appliedAt, flagState: { enabled, rolloutPercentage } }`
- Log level: INFO
- No admin user (automatic process)
- Integration test: Cron job applies schedule, assert audit event logged

**AC5**: Log schedule failure events (cron job)
- Event type: `flag_schedule.failed`
- Metadata: `{ scheduleId, flagKey, errorMessage, failedAt }`
- Log level: ERROR
- No admin user (automatic process)
- Integration test: Simulate cron failure, assert audit event logged

### Service Layer Updates

**AC6**: Pass admin user context to service layer
- Routes extract admin user ID from JWT claims
- Routes pass `adminUserId` and `adminEmail` to service methods
- Service methods accept optional admin context parameters
- Service methods persist admin user to database columns
- Unit test: Verify service persists created_by and cancelled_by

**AC7**: Audit service integration
- Service layer calls audit logger before database commit
- Audit events include all required metadata fields
- Audit logging errors do NOT fail schedule operations (fire-and-forget)
- Log audit logging failures to CloudWatch for monitoring
- Unit test: Verify audit logger called with correct parameters

### API Response Updates

**AC8**: Include admin tracking in API responses
- GET /api/admin/flags/:flagKey/schedule returns created_by, cancelled_by, cancelled_at
- Response schema updated: `ScheduleResponseSchema` with new fields
- All fields nullable (backward compatibility)
- Integration test: Create and cancel schedule, verify fields in GET response

### Schema & Types

**AC9**: Update Zod schemas for schedules
- `ScheduleSchema` extended with `createdBy`, `cancelledBy`, `cancelledAt` (all optional)
- `ScheduleResponseSchema` includes new fields in API responses
- Type inference: `type Schedule = z.infer<typeof ScheduleSchema>`
- Schema alignment test: Frontend ↔ backend schemas match

**AC10**: Frontend/backend schema alignment
- Backend schemas updated in `apps/api/lego-api/domains/config/types.ts`
- Schemas re-exported in `packages/core/api-client/src/schemas/feature-flags.ts`
- Frontend imports from `@repo/api-client`
- Alignment test verifies schemas match

### Testing

**AC11**: Backend unit tests (minimum 8 new tests)
- Test: Create schedule logs audit event with correct metadata
- Test: Cancel schedule logs audit event with admin user
- Test: Cron job applies schedule logs automatic event (no admin)
- Test: Cron job failure logs error event
- Test: Audit logging failure does not fail schedule creation
- Test: created_by persisted to database on POST
- Test: cancelled_by persisted to database on DELETE
- Test: GET response includes admin tracking fields

**AC12**: Backend integration tests (HTTP file)
- File: `__http__/feature-flag-scheduling.http` (extend existing)
- Test: Create schedule, verify created_by in response
- Test: Cancel schedule, verify cancelled_by and cancelled_at in response
- Test: GET schedules, verify admin fields present
- CloudWatch logs verification (manual): Audit events appear in logs

**AC13**: Backward compatibility tests
- Test: Existing schedules (created_by = NULL) still function correctly
- Test: GET response handles NULL admin fields gracefully
- Test: Cron job processes schedules with NULL created_by

### Documentation

**AC14**: Update API documentation
- Document new response fields in API contract
- Document audit event types and metadata schemas
- Update HTTP examples with admin tracking fields
- Add CloudWatch Logs Insights query examples for audit trail

**AC15**: Update architecture documentation
- Document integration between WISH-2119 and WISH-2019
- Add audit logging patterns to schedule service documentation
- Document admin context flow (JWT → routes → service → database)

## Reuse Plan

### Existing Components (from WISH-2019)

- Audit logging service (`apps/api/lego-api/core/audit/audit-logger.ts`)
- CloudWatch structured logging patterns
- Redis infrastructure (if used by audit service)
- JWT claims extraction for admin user context

### Existing Components (from WISH-2119)

- Schedule service (`apps/api/lego-api/domains/config/application/schedule-service.ts`)
- Schedule repository (`apps/api/lego-api/domains/config/adapters/schedule-repository.ts`)
- Schedule routes (`apps/api/lego-api/domains/config/routes.ts`)
- Cron job handler (`apps/api/lego-api/jobs/process-flag-schedules.ts`)

### New Components

- Database migration for admin tracking columns
- Audit event type definitions (if not already in WISH-2019)

### Existing Patterns

- Hexagonal architecture (ports & adapters)
- Zod-first type definitions
- CloudWatch structured logging
- Fire-and-forget audit logging (errors don't fail operations)

## Architecture Notes

### Hexagonal Architecture Compliance

**Service Layer Updates:**
- `apps/api/lego-api/domains/config/application/schedule-service.ts`
  - Accept optional `adminContext` parameter (userId, email)
  - Call audit logger before committing database transaction
  - Persist admin user to database columns

**Adapter Layer Updates:**
- `apps/api/lego-api/domains/config/adapters/schedule-repository.ts`
  - Update INSERT/UPDATE queries to include created_by, cancelled_by
  - Update SELECT queries to return new columns

**Cron Job Updates:**
- `apps/api/lego-api/jobs/process-flag-schedules.ts`
  - Log `flag_schedule.applied` events (no admin context)
  - Log `flag_schedule.failed` events (no admin context)

**No Architecture Violations:** Story extends existing patterns from WISH-2119 and WISH-2019 without introducing new dependencies.

## Infrastructure Notes

### Audit Logging Service

**Reuse from WISH-2019:**
- Audit logger service for structured event logging
- CloudWatch Logs destination
- Event metadata schema validation
- Fire-and-forget error handling

**New Event Types:**
- `flag_schedule.created`
- `flag_schedule.cancelled`
- `flag_schedule.applied`
- `flag_schedule.failed`

### CloudWatch Logs Insights

**Sample Queries:**

Find all schedules created by specific admin:
```
fields @timestamp, scheduleId, flagKey, scheduledAt
| filter eventType = "flag_schedule.created"
| filter adminUserId = "admin-123"
| sort @timestamp desc
```

Find all cancelled schedules in time range:
```
fields @timestamp, scheduleId, flagKey, cancelledBy
| filter eventType = "flag_schedule.cancelled"
| filter @timestamp >= "2026-01-01T00:00:00Z"
| sort @timestamp desc
```

Find all failed schedule applications:
```
fields @timestamp, scheduleId, flagKey, errorMessage
| filter eventType = "flag_schedule.failed"
| sort @timestamp desc
```

## Test Plan

### Scope Summary
- **Endpoints:** 2 endpoints modified (POST, DELETE schedule)
- **UI Touched:** No (backend only)
- **Data/Storage:** Yes (database columns, audit logs in CloudWatch)
- **Infrastructure:** Audit logging service integration

### Happy Path Tests

1. **Create schedule with audit logging**: POST schedule as admin, assert created_by persisted and audit event logged
2. **Cancel schedule with audit logging**: DELETE schedule as admin, assert cancelled_by persisted and audit event logged
3. **Cron job applies schedule**: Trigger cron, assert applied event logged (no admin)
4. **GET schedules returns admin fields**: GET schedules, assert created_by, cancelled_by present in response

### Error Cases

1. **Audit logging failure**: Simulate audit service error, assert schedule creation still succeeds
2. **Missing admin context**: POST schedule without JWT claims (unexpected), verify graceful handling
3. **Cron job failure**: Simulate database error, assert failed event logged with error message

### Edge Cases

1. **Backward compatibility**: GET schedule with NULL created_by (old data), assert response valid
2. **Multiple admins**: Create schedules with different admins, verify each admin tracked separately
3. **Admin cancels another admin's schedule**: Admin B cancels Admin A's schedule, verify cancelled_by = Admin B

### Required Tooling Evidence

**Backend HTTP Tests (`__http__/feature-flag-scheduling.http`):**
- Extend existing file with 3+ new requests
- Assert created_by, cancelled_by, cancelled_at fields in responses
- Manual verification: CloudWatch logs contain audit events

**Backend Unit Tests:**
- Minimum 8 new tests covering audit logging integration
- Mock audit logger to verify event metadata
- Verify database column persistence

**Backend Integration Tests:**
- Create and cancel schedules, verify admin fields in database
- Trigger cron job, verify automatic events logged

## Risks & Mitigations

### MVP-Critical Risks

1. **Audit logging failures block operations**
   - Risk: If audit service throws errors, schedule operations fail
   - Mitigation: Fire-and-forget audit logging (errors logged but don't fail operations)
   - Severity: Low (mitigated by design)

2. **JWT claims missing admin context**
   - Risk: Admin endpoints may not have user ID in JWT claims
   - Mitigation: Verify JWT structure includes userId/email fields (coordinate with auth service)
   - Severity: Medium (may require auth middleware updates)

3. **Database migration breaks backward compatibility**
   - Risk: Old code breaks after migration if it doesn't handle new columns
   - Mitigation: All columns nullable, old code ignores new fields
   - Severity: Low (nullable columns ensure safety)

4. **Audit log volume and cost**
   - Risk: High-frequency schedule operations generate large CloudWatch logs
   - Mitigation: Audit events are INFO level only, no duplication with application logs
   - Severity: Low (acceptable cost for audit trail)

## Open Questions

- **Q1**: Does WISH-2019 audit service already support custom event types, or does it need extension?
  - **Resolution Path**: Review WISH-2019 implementation, extend if needed

- **Q2**: Do admin JWTs include userId and email claims, or do we need to extract from database?
  - **Resolution Path**: Review auth middleware implementation, add claims if missing

- **Q3**: Should we audit schedule listing (GET) operations, or only mutations (POST/DELETE)?
  - **Proposed Answer**: Only mutations in MVP (reduce log volume), defer read auditing to future

## Definition of Done

- [ ] All 15 Acceptance Criteria pass
- [ ] Backend: 8+ unit tests pass (audit logging integration)
- [ ] Backend: HTTP integration tests pass (extended `.http` file)
- [ ] Database migration created and applied (admin tracking columns)
- [ ] Schema alignment test passes (frontend ↔ backend)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] CloudWatch logs verification: Audit events appear with correct metadata
- [ ] Code review approved

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Generation | ~8k | — | — | Follow-up from WISH-2119 |
| Elaboration | ~8k | — | — | Standard audit integration |
| Implementation | ~12k | — | — | Service updates + migration + tests |
| Code Review | ~4k | — | — | Small scope story |
| **Total** | ~32k | — | — | Small-medium story |

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-30 00:00 | pm-story-followup-leader | Generated follow-up story from WISH-2119 finding #7 | WISH-20280.md |

---
