---
doc_type: story
title: "WISH-2049: Background Compression for Perceived Performance"
story_id: WISH-2049
story_prefix: WISH
status: deferred
follow_up_from: WISH-2022
phase: 4
created_at: "2026-01-29T00:00:00-07:00"
updated_at: "2026-01-31T18:00:00-07:00"
depends_on: [WISH-2022]
estimated_points: 2
---

# WISH-2049: Background Compression for Perceived Performance

## Follow-up Context

**Parent Story:** WISH-2022: Client-side Image Compression
**Source:** QA Discovery Notes - Enhancement Opportunities
**Original Finding:** Background compression - Start compressing image as soon as selected (before form is filled). By the time user submits, compression is already complete. Reduces perceived latency.
**Category:** Enhancement Opportunity
**Impact:** Medium - improves perceived performance significantly
**Effort:** Low - minor refactoring of compression timing

## Context

In WISH-2022, image compression happens synchronously after form submission, creating a sequential workflow:
1. User fills form
2. User clicks submit
3. Compression starts (shows "Compressing image... X%")
4. Upload starts (shows "Uploading... Y%")
5. Navigation to detail page

This creates perceived latency because users must wait for compression before seeing upload progress.

Background compression improves perceived performance by starting compression as soon as the user selects an image:
1. User selects image
2. Compression starts immediately in background (web worker)
3. User fills form while compression runs
4. User clicks submit
5. Compression already complete → immediate upload
6. Navigation to detail page

By the time users finish filling out the form (title, price, priority, etc.), compression is typically complete, eliminating the compression wait time from the critical path.

## Goal

Start image compression immediately when image is selected (before form submission), so compression is complete by the time the user submits the form, reducing perceived latency.

## Non-goals

- Not implementing advanced compression queue management
- Not implementing multi-image compression (WISH-2022 is single-image only)
- Not implementing compression progress UI during selection (only during upload if still in progress)
- Not re-implementing compression logic from WISH-2022
- Not implementing compression cancellation UI

## Scope

**Components Affected:**
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts` - Refactor compression trigger
- `apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx` - Trigger compression on image selection
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts` - Add state management for background compression

**Packages Affected:**
- `apps/web/app-wishlist-gallery`

## Acceptance Criteria

- [ ] AC1: Compression starts immediately when user selects an image in the file picker (onChange event)
- [ ] AC2: Compression runs in background using web worker (non-blocking UI) from browser-image-compression
- [ ] AC3: Form remains interactive during background compression (no loading state blocking form fields)
- [ ] AC4: If compression completes before form submission, skip compression step during upload flow
- [ ] AC5: If compression is still in progress when user submits, show "Compressing image... X%" and wait for completion
- [ ] AC6: Compression state is tracked: 'idle' | 'compressing' | 'complete' | 'failed'
- [ ] AC7: Image preview updates with compressed image when compression completes (even if form not submitted yet)
- [ ] AC8: If user changes image before compression completes, cancel previous compression and start new compression
- [ ] AC9: Compression failure falls back to original image upload (no change from WISH-2022)
- [ ] AC10: "High quality (skip compression)" checkbox bypasses background compression entirely
- [ ] AC11: Toast notification "Image compressed: X MB → Y MB" shows when background compression completes
- [ ] AC12: Playwright E2E tests cover: background compression happy path (compression completes before submit), slow compression (user submits before complete), image change during compression, compression failure fallback
- [ ] AC13: Test coverage includes: unit tests for compression state management, integration tests for useS3Upload hook with background compression, Playwright E2E tests for perceived performance scenarios
- [ ] AC14: Rapid image change test (< 100ms between selections): Verify AbortController successfully cancels previous compression operation and prevents stale state updates when user rapidly changes images
- [ ] AC15: Compression result tracking uses request ID or timestamp: Implement mechanism to detect and discard stale compression results when image changes during active compression, preventing outdated compressed data from being uploaded

## Reuse Plan

- Builds on compression logic from WISH-2022 (`imageCompression.ts`)
- Reuses `useS3Upload` hook from WISH-2022
- Reuses compression settings from WISH-2022 (max 1920px, quality 0.8, max 1MB)
- Reuses error handling and fallback patterns from WISH-2022
- Leverages existing `browser-image-compression` library with web worker support

## Architecture Notes

**Background Compression Flow:**
```
1. User selects image (onChange event)
2. Check "High quality" checkbox:
   - If checked: skip compression, use original
   - If unchecked: start background compression
3. Background compression runs in web worker:
   - State: 'compressing'
   - Progress updates UI (optional)
4. User fills form (non-blocking)
5. Compression completes:
   - State: 'complete'
   - Update preview with compressed image
   - Show toast: "Image compressed: X MB → Y MB"
6. User clicks submit:
   - If state === 'complete': upload compressed image immediately
   - If state === 'compressing': show progress UI, wait for completion
   - If state === 'failed': upload original image (fallback)
```

**State Management:**
```typescript
interface CompressionState {
  status: 'idle' | 'compressing' | 'complete' | 'failed';
  originalFile: File | null;
  compressedFile: File | null;
  progress: number; // 0-100
  error: Error | null;
}
```

**Cancellation on Image Change:**
```typescript
// When user selects new image:
1. Cancel previous compression (AbortController)
2. Reset state to 'idle'
3. Start new compression
```

## Test Plan

### Happy Path

1. User selects high-resolution image (5MB, 4032x3024)
2. Background compression starts immediately
3. User fills form (title, price, priority) - takes ~10 seconds
4. Compression completes in ~5 seconds (while user is typing)
5. Preview updates with compressed image
6. Toast shows: "Image compressed: 5.2 MB → 0.8 MB"
7. User submits form
8. Upload starts immediately (no compression wait)
9. Success - compression was transparent to user

### Error Cases

1. **Compression fails during background**: Show error toast, fall back to original image, continue with form submission
2. **User submits before compression complete**: Show "Compressing image... X%" progress, wait for completion, then upload
3. **Image change during compression**: Cancel previous compression, start new compression for new image
4. **Browser memory limits**: If compression throws OOM error, fall back to original image upload

### Edge Cases

1. **Very fast form submission**: User selects image and immediately submits (< 1 second). Compression in progress, show progress UI.
2. **User disables compression**: "High quality" checkbox bypasses background compression entirely (no change from WISH-2022)
3. **Small image skip logic**: If image < 500KB, skip compression (instant "complete" state)
4. **Compression increases size**: If compressed size > original, use original (edge case from WISH-2022)

## Risks / Edge Cases

1. **Compression fails before submission**: User doesn't know compression failed until form submit; mitigate with error toast when compression fails
2. **User confusion from async toast**: Toast appears while user is typing; acceptable UX (non-intrusive notification)
3. **Resource usage**: Background compression uses CPU/memory while user types; mitigated by web worker (non-blocking)
4. **Edge case: user changes image multiple times quickly**: Multiple compressions in flight; mitigate with cancellation logic (AbortController)

## Out-of-Scope Items

- **Checkbox toggle behavior during active compression**: If user rapidly toggles "High quality" checkbox while compression is running, current spec does not define expected behavior (cancel + restart vs. ignore changes). This edge case is excluded from this story and deferred to future enhancement discussion.

---

## Implementation Notes

**Key Changes from WISH-2022:**
- Move compression trigger from `onSubmit` → `onChange` (file input)
- Add compression state management (idle, compressing, complete, failed)
- Add cancellation logic for image changes (AbortController)
- Add toast notification when background compression completes
- Modify upload flow to check compression state before starting upload

**Web Worker Support:**
`browser-image-compression` already supports web workers via `useWebWorker: true` option (configured in WISH-2022), so background compression is non-blocking by default.

**Perceived Performance Improvement:**
- Sequential (WISH-2022): 5s compression + 3s upload = 8s total perceived latency
- Background (WISH-2049): 0s compression (hidden) + 3s upload = 3s perceived latency
- **62% reduction in perceived latency** for typical 5MB images

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-31_

### Gaps Identified
| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Rapid image change race condition testing (< 100ms) | Add as AC14 | Explicit test scenario added to verify AbortController cancellation prevents state corruption during rapid image selections |
| 2 | Stale compression result detection | Add as AC15 | Requires implementation of request ID or timestamp mechanism to detect and discard stale compression results when image changes during compression |

### Enhancement Opportunities
| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Visual compression indicator on image preview | Not Reviewed | UX enhancement deferred for future consideration |
| 2 | Compression time estimation | Not Reviewed | Performance enhancement deferred for future consideration |
| 3 | Compression caching for repeated selections | Not Reviewed | Performance enhancement deferred for future consideration |
| 4 | Preemptive compression quality adjustment | Not Reviewed | Performance enhancement deferred for future consideration |
| 5 | Background compression success rate tracking | Not Reviewed | Observability enhancement deferred for future consideration |
| 6 | Compression performance metrics tracking | Not Reviewed | Observability enhancement deferred for future consideration |
| 7 | Screen reader announcement for compression completion | Not Reviewed | Accessibility enhancement deferred for future consideration |
| 8 | Multi-image upload integration | Not Reviewed | Integration enhancement deferred for future consideration |

### Items Marked Out-of-Scope
- **Checkbox toggle behavior during active compression**: If user rapidly toggles "High quality" checkbox while compression is running, current spec does not define expected behavior (cancel + restart vs. ignore changes). This edge case is excluded from this story and deferred to future enhancement discussion.
