---
doc_type: story
title: "WISH-2023: Add Compression Failure Telemetry"
story_id: WISH-2023
story_prefix: WISH
status: deferred
follow_up_from: WISH-2022
phase: 4
created_at: "2026-01-29T00:00:00-07:00"
updated_at: "2026-01-31T00:00:00-07:00"
depends_on: [WISH-2022]
priority: P2
estimated_points: 2
---

# WISH-2023: Add Compression Failure Telemetry - Phase 4 UX Polish

## Follow-up Context

**Parent Story:** WISH-2022: Client-side Image Compression

**Source:** QA Discovery Notes - Gaps Identified (Follow-up Story #3)

**Original Finding:** Compression failure telemetry - Track compression failures (format, size, browser, error) via CloudWatch/analytics to identify patterns and improve fallback logic

**Category:** Gap

**Impact:** Medium (Observability improvement for compression failures)

**Effort:** Low (CloudWatch metrics + error logging)

## Context

WISH-2022 implements client-side image compression with graceful fallback to original image upload when compression fails. However, the current implementation does not track compression failures, making it difficult to:

- Identify which image formats, sizes, or browsers cause compression failures
- Measure the impact of compression failures on user experience
- Prioritize improvements to compression logic or error handling
- Detect patterns that indicate bugs or configuration issues

By adding telemetry for compression failures, we can:

- Track failure rate by image format (JPEG, PNG, HEIC, etc.)
- Track failure rate by image size bucket (< 1MB, 1-5MB, 5-10MB, > 10MB)
- Track failure rate by browser/platform (Chrome, Safari, Firefox, mobile)
- Identify error types (timeout, out-of-memory, unsupported format, etc.)
- Monitor trends over time (increasing failure rate may indicate regression)
- Provide data for WISH-2045 (HEIC support) and WISH-2048 (WebP conversion) prioritization

**Dependency Context:**
- WISH-2022: Client-side compression with fallback implemented
- CloudWatch: Existing metrics infrastructure for backend observability
- Frontend error tracking: May extend existing frontend error tracking from observability infrastructure

## Goal

Track compression failures via CloudWatch metrics and structured logs to identify patterns by format, size, browser, and error type, enabling data-driven improvements to compression logic and fallback behavior.

## Non-goals

- Not implementing real-time alerting for compression failures (monitoring deferred to Phase 5)
- Not implementing automatic compression setting adjustments based on failure rate
- Not implementing user-facing analytics dashboard
- Not implementing compression success rate tracking (focus on failures only for MVP)
- Not implementing A/B testing for compression settings
- Not implementing compression performance metrics (latency, throughput)
- Not implementing compression quality metrics (SSIM, PSNR)
- Not implementing historical trend analysis dashboard (CloudWatch Logs Insights sufficient)

## Scope

### Endpoints Affected

**None** - Frontend-only telemetry implementation

### Packages Affected

1. **Frontend - Image Compression Utility**: `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts`
   - Add error logging with structured metadata (format, size, browser, error message)
   - Send compression failure metrics to backend telemetry endpoint

2. **Frontend - S3 Upload Hook**: `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts`
   - Instrument compression failures in upload flow
   - Pass compression metadata to telemetry logger

3. **Backend - Telemetry Endpoint**: `apps/api/lego-api/domains/observability/` (new or extend existing)
   - Receive frontend compression failure events
   - Publish to CloudWatch Logs and CloudWatch Metrics
   - **Changes**: New endpoint `POST /api/observability/compression-failures`

4. **Backend - CloudWatch Integration**: `apps/api/lego-api/core/observability/`
   - Add CloudWatch Metrics namespace: `Wishlist/ImageCompression`
   - Add metrics: `CompressionFailureCount`, `CompressionFailureRate`
   - Add dimensions: `Format`, `SizeBucket`, `Browser`, `ErrorType`

### Infrastructure Impact

**CloudWatch Metrics:**
- Namespace: `Wishlist/ImageCompression`
- Metrics:
  - `CompressionFailureCount` (Count) - Total failures
  - `CompressionFailureRate` (Percent) - Failures / Total attempts
- Dimensions:
  - `Format` (JPEG, PNG, HEIC, GIF, WebP, Unknown)
  - `SizeBucket` (< 1MB, 1-5MB, 5-10MB, > 10MB)
  - `Browser` (Chrome, Safari, Firefox, Edge, Other)
  - `ErrorType` (Timeout, OutOfMemory, UnsupportedFormat, LibraryError, Unknown)

**CloudWatch Logs:**
- Log Group: `/aws/lambda/wishlist-api` (existing)
- Log Stream: Frontend errors (structured JSON)
- Log Fields: `timestamp`, `format`, `originalSize`, `browser`, `errorType`, `errorMessage`, `userAgent`, `compressionSettings`

**Cost Impact:**
- CloudWatch Metrics: ~$0.30/month for 1000 custom metrics (negligible)
- CloudWatch Logs: ~$0.50/month for 1GB of log ingestion (failure logs expected < 100MB/month)
- Total: < $1/month additional cost

## Acceptance Criteria

### AC1: Compression failure logging with structured metadata
**Requirement:**
- When browser-image-compression throws an error, log structured event to console and backend
- Log fields: `timestamp`, `format`, `originalSize`, `browser`, `errorType`, `errorMessage`, `compressionSettings`
- Error types: `Timeout`, `OutOfMemory`, `UnsupportedFormat`, `LibraryError`, `Unknown`

**Evidence:** Unit tests verify error logging with all required fields

---

### AC2: Backend telemetry endpoint for compression failures
**Requirement:**
- Create `POST /api/observability/compression-failures` endpoint
- Accept structured JSON payload with compression failure metadata
- Validate payload with Zod schema
- Publish to CloudWatch Logs and CloudWatch Metrics
- Return 204 No Content on success

**Evidence:** Integration tests verify endpoint accepts payload and publishes to CloudWatch

---

### AC3: CloudWatch Metrics for compression failures
**Requirement:**
- Publish `CompressionFailureCount` metric (Count) to CloudWatch
- Publish `CompressionFailureRate` metric (Percent) when compression attempts tracked
- Dimensions: `Format`, `SizeBucket`, `Browser`, `ErrorType`
- Namespace: `Wishlist/ImageCompression`

**Evidence:** Integration tests verify metrics published with correct dimensions

---

### AC4: Size bucket categorization
**Requirement:**
- Categorize original image size into buckets:
  - `< 1MB`: 0 - 999 KB
  - `1-5MB`: 1 MB - 4.99 MB
  - `5-10MB`: 5 MB - 9.99 MB
  - `> 10MB`: 10 MB and above
- Include size bucket in CloudWatch Metrics dimension

**Evidence:** Unit tests verify size bucket categorization logic

---

### AC5: Browser/platform detection
**Requirement:**
- Extract browser name from User-Agent string
- Categorize as: `Chrome`, `Safari`, `Firefox`, `Edge`, `Other`
- Include browser in CloudWatch Metrics dimension
- Use lightweight UA parsing (no external library for MVP)

**Evidence:** Unit tests verify browser detection from User-Agent strings

---

### AC6: Error type classification
**Requirement:**
- Classify compression errors into types:
  - `Timeout`: Compression takes > 10 seconds (WISH-2022 timeout threshold)
  - `OutOfMemory`: Browser throws out-of-memory error
  - `UnsupportedFormat`: Image format not supported by browser-image-compression
  - `LibraryError`: Error from browser-image-compression library
  - `Unknown`: Unclassified errors
- Include error type in CloudWatch Metrics dimension

**Evidence:** Unit tests verify error type classification logic

---

### AC7: CloudWatch Logs structured JSON format
**Requirement:**
- Publish compression failure events to CloudWatch Logs
- JSON format with fields: `timestamp`, `eventType: "compression-failure"`, `format`, `originalSize`, `browser`, `errorType`, `errorMessage`, `userAgent`, `compressionSettings`
- Log to existing log group: `/aws/lambda/wishlist-api`

**Evidence:** Integration tests verify CloudWatch Logs entries match expected format

---

### AC8: Frontend error handling does not block upload
**Requirement:**
- Telemetry logging is fire-and-forget (async, non-blocking)
- If telemetry endpoint fails, fallback to console.error only
- Telemetry failures do NOT prevent image upload fallback
- Telemetry request timeout: 2 seconds

**Evidence:** Unit tests verify telemetry failures do not block upload flow

---

### AC9: Privacy-conscious logging (no PII)
**Requirement:**
- Do NOT log user ID, image URL, filename, or image content
- Log only technical metadata: format, size, browser, error type, error message
- Comply with privacy policy for error logging

**Evidence:** Code review verifies no PII in telemetry payload

---

### AC10: CloudWatch Logs Insights query examples
**Requirement:**
- Document CloudWatch Logs Insights queries for common analysis patterns
- Include queries in observability documentation
- Example queries:
  - Count failures by format
  - Count failures by size bucket
  - Count failures by browser
  - Count failures by error type
  - Trend over time

**Evidence:** Queries documented in `docs/observability/compression-failures.md`

---

### AC11: Unit tests for telemetry utility functions
**Minimum Coverage:**
- Size bucket categorization (4 buckets)
- Browser detection (5 browsers + fallback)
- Error type classification (5 types + fallback)
- Telemetry payload construction
- Error handling for telemetry failures

**Test File:** `apps/web/app-wishlist-gallery/src/utils/__tests__/compressionTelemetry.test.ts`

**Evidence:** 10+ unit tests passing

---

### AC12: Integration tests for telemetry endpoint
**Minimum Coverage:**
- POST /api/observability/compression-failures returns 204
- Invalid payload returns 400 with validation errors
- Telemetry endpoint publishes to CloudWatch Logs
- Telemetry endpoint publishes to CloudWatch Metrics

**Test File:** `__http__/observability-compression-failures.http`

**Evidence:** 4+ integration tests passing

---

## Reuse Plan

### Existing Components (Extended)
- **CloudWatch Logs** - Existing log aggregation infrastructure
- **CloudWatch Metrics** - Existing metrics infrastructure
- **Observability logger** (`@repo/logger`) - Extend with compression failure logging
- **Zod schemas** - Define schema for compression failure payload
- **Error handling patterns** - Reuse patterns from WISH-2022 compression fallback

### New Components
- **Compression telemetry utility** (`apps/web/app-wishlist-gallery/src/utils/compressionTelemetry.ts`) - Frontend telemetry helpers
- **Telemetry endpoint** (`apps/api/lego-api/domains/observability/routes.ts`) - Backend endpoint for compression failures
- **CloudWatch metrics publisher** (`apps/api/lego-api/core/observability/metrics.ts`) - Publish custom metrics
- **Observability documentation** (`docs/observability/compression-failures.md`) - CloudWatch query examples

### Existing Patterns
- **Zod schema validation** - Define `CompressionFailurePayloadSchema`
- **Structured logging** - JSON log format from existing observability infrastructure
- **Fire-and-forget telemetry** - Async, non-blocking telemetry requests
- **User-Agent parsing** - Lightweight browser detection without external library

## Test Plan

### Frontend Unit Tests (10+ Tests)

**Telemetry Utility Tests** (`apps/web/app-wishlist-gallery/src/utils/__tests__/compressionTelemetry.test.ts`):
1. Size bucket categorization: < 1MB
2. Size bucket categorization: 1-5MB
3. Size bucket categorization: 5-10MB
4. Size bucket categorization: > 10MB
5. Browser detection: Chrome User-Agent
6. Browser detection: Safari User-Agent
7. Browser detection: Firefox User-Agent
8. Browser detection: Edge User-Agent
9. Browser detection: Unknown User-Agent (fallback to "Other")
10. Error type classification: Timeout error
11. Error type classification: OutOfMemory error
12. Error type classification: UnsupportedFormat error
13. Error type classification: LibraryError
14. Error type classification: Unknown error
15. Telemetry payload construction with all fields
16. Error handling: Telemetry endpoint failure does not throw

---

### Backend Integration Tests (4+ Tests)

**HTTP Test File:** `__http__/observability-compression-failures.http`

**Telemetry Endpoint Tests:**
1. POST /api/observability/compression-failures with valid payload returns 204
2. POST /api/observability/compression-failures with invalid payload returns 400
3. POST /api/observability/compression-failures publishes to CloudWatch Logs (verify log entry)
4. POST /api/observability/compression-failures publishes to CloudWatch Metrics (verify metric data point)

---

### Manual QA Testing

**QA Test Scenarios:**
1. **Compression Failure Logging:**
   - QA simulates compression failure (invalid image format or large file)
   - QA verifies CloudWatch Logs includes compression failure event with all fields
   - QA verifies CloudWatch Metrics shows `CompressionFailureCount` increment

2. **CloudWatch Logs Insights Queries:**
   - QA runs documented query examples
   - QA verifies query results include expected fields
   - QA tests "Count failures by format" query with multiple formats

3. **Telemetry Endpoint Validation:**
   - QA sends invalid payload to telemetry endpoint
   - QA verifies 400 response with Zod validation errors
   - QA sends valid payload, verifies 204 response

4. **Privacy Compliance:**
   - QA reviews CloudWatch Logs entries
   - QA verifies no PII (user ID, filename, image URL) in logs
   - QA confirms only technical metadata logged

---

## Risks & Mitigations

### MVP-Critical Risks

**Risk 1: CloudWatch Costs Higher Than Expected**
- **Severity:** Low (metrics cost ~$0.30/month for 1000 metrics)
- **Likelihood:** Low
- **Mitigation:** Monitor CloudWatch billing, use sampling if costs exceed $5/month
- **Verification:** CloudWatch billing dashboard review after 2 weeks

**Risk 2: Telemetry Endpoint Latency Impact**
- **Severity:** Medium (could slow compression flow)
- **Likelihood:** Low
- **Mitigation:** Fire-and-forget async telemetry, 2-second timeout, failures do not block upload
- **Verification:** Unit tests verify non-blocking telemetry

**Risk 3: Telemetry Payload Too Large**
- **Severity:** Low (payload < 1 KB per event)
- **Likelihood:** Low
- **Mitigation:** Limit error message to 500 characters, no image content
- **Verification:** Zod schema enforces field size limits

### Non-MVP Risks (Future Work)

- **CloudWatch Logs retention costs** - Deferred to future cost optimization story
- **High-volume telemetry spam** - Rate limiting deferred to Phase 5
- **Real-time alerting** - Deferred to monitoring story

## Open Questions

### Q1: Should we track compression success rate or only failures?

**Decision:** Failures only for MVP

**Rationale:** Success rate requires tracking total compression attempts, doubling telemetry volume. Failure tracking is sufficient for identifying issues. Success rate can be inferred from usage metrics in Phase 5.

---

### Q2: Should we use an external User-Agent parsing library?

**Decision:** No, lightweight inline parsing for MVP

**Rationale:** External library (e.g., ua-parser-js) adds bundle size (~20 KB). Simple regex parsing for 5 browsers is sufficient for MVP. Can add library later if needed.

---

### Q3: Should compression failures trigger real-time alerts?

**Decision:** No, monitoring deferred to Phase 5

**Rationale:** Compression failures are gracefully handled with fallback. Real-time alerting not critical for MVP. CloudWatch Logs Insights queries sufficient for post-hoc analysis.

---

## Definition of Done

- [ ] All 12 Acceptance Criteria pass
- [ ] Frontend: 10+ unit tests for telemetry utility functions
- [ ] Backend: 4+ integration tests for telemetry endpoint
- [ ] CloudWatch Metrics published with correct dimensions
- [ ] CloudWatch Logs structured JSON format verified
- [ ] CloudWatch Logs Insights query examples documented
- [ ] Telemetry endpoint does not block upload flow (fire-and-forget)
- [ ] No PII in telemetry payload (privacy review)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved
- [ ] QA verification complete (CloudWatch Logs and Metrics verified)

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-31_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | **No service layer specified** | Add as AC | Backend endpoint requires service layer per api-layer.md. Must add `services/observability/index.ts` with business logic functions |
| 2 | **No Zod schema for telemetry payload** | Add as AC | Backend validation impossible without schema. Must define `CompressionFailurePayloadSchema` in service layer types |
| 3 | **CloudWatch not viable on Vercel** | MAJOR CHANGE | Original story uses CloudWatch (AWS service). App now deploys to Vercel. Must replace with stdout logging (Vercel captures logs automatically). Simplify backend to receive and log telemetry data to stdout. |
| 4 | **No telemetry endpoint error handling** | Add as AC | Must specify error handling for stdout publish failures and edge cases |
| 5 | **Authentication/rate-limiting not specified** | Add as AC | Public telemetry endpoint vulnerable to spam. Must specify authentication and/or rate-limiting requirements |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | CloudWatch Logs Insights query examples | Out of Scope | Queries no longer applicable with stdout logging. Defer analysis tools to future story |
| 2 | CloudWatch Metrics dashboards | Out of Scope | Metrics infrastructure not viable on Vercel. Defer to future monitoring story |
| 3 | Real-time alerting for compression failures | Out of Scope | Originally deferred to Phase 5. Still deferred. |

### Follow-up Stories Suggested

- [ ] WISH-2023-FU1: Add service layer and Zod schema to WISH-2023 scope (architect-led, 1 point)
- [ ] WISH-2023-FU2: Add error handling and authentication to WISH-2023 (PM-led, 1 point)
- [ ] Phase 5: Implement stdout telemetry aggregation and analysis tools (defer to future)

### Items Marked Out-of-Scope

- **CloudWatch Metrics**: Application deploying to Vercel, not AWS. CloudWatch not available. Use stdout logging instead.
- **CloudWatch Logs integration**: Replaced by Vercel native log capture. No AWS credentials needed.
- **Historical trend analysis**: Defer to Phase 5 when telemetry aggregation infrastructure is in place.
- **Real-time alerting**: Defer to Phase 5 monitoring story.
- **A/B testing infrastructure**: Out of scope for MVP telemetry story.
