---
doc_type: story
title: "WISH-2017: Advanced Multi-Sort Filtering"
story_id: WISH-2017
story_prefix: WISH
status: needs-split
phase: 6
created_at: "2026-01-28T00:00:00-07:00"
updated_at: "2026-01-28T02:00:00-07:00"
depends_on: [WISH-2014]
follow_up_from: WISH-2014
estimated_points: 5
sizing_warning: true
---

# WISH-2017: Advanced Multi-Sort Filtering

## Follow-up Context

**Parent Story**: WISH-2014 (Smart Sorting Algorithms)
**Source**: QA Discovery Notes - Follow-up Story #3
**Original Finding**: Advanced Multi-Sort Filtering - Phase 6 Advanced Features
**Category**: Enhancement Opportunity
**Impact**: Medium
**Effort**: Medium-High

## Context

Follow-up story from WISH-2014 (Smart Sorting Algorithms) QA Elaboration. WISH-2014 introduced three smart sorting modes (Best Value, Expiring Soon, Hidden Gems) as single-criteria sorts. This story extends that functionality to enable **combined filtering and sorting** operations, allowing users to apply multiple criteria simultaneously for more sophisticated item discovery.

For example:
- "Show me Best Value items from the LEGO Store only"
- "Find Hidden Gems with High Priority (3+)"
- "Sort Expiring Soon items by price range $50-$200"

This represents Phase 6 advanced features that build on the sorting foundation established in WISH-2014.

## Goal

Enable users to combine smart sorting algorithms with filters (store, priority, price range) for advanced item discovery and decision-making workflows.

## Non-goals

- Real-time collaborative filtering (deferred to Phase 7)
- Machine learning-based recommendations (deferred to future epic)
- Saved filter presets (deferred to Phase 5 UX Polish)
- Filter history/undo (deferred to Phase 5)
- Custom user-defined filter logic (deferred to Phase 7)
- Cross-user filter sharing (deferred to Phase 7)
- Multi-criteria search (already covered by existing search functionality)

## Scope

### Endpoints Affected

- **Extended**: `GET /api/wishlist` with combined query parameters
- **No New Endpoints Required**

### Packages Affected

1. **Backend**: `apps/api/lego-api/domains/wishlist/`
   - `types.ts` - Extend query schema to support combined filters + sort
   - `application/wishlist-service.ts` - Update service logic for combined queries
   - `adapters/wishlist-repository.ts` - Implement Drizzle queries with WHERE + ORDER BY

2. **Shared Schemas**: `packages/core/api-client/src/schemas/wishlist.ts`
   - Extend `WishlistQueryParamsSchema` to validate combined parameters

3. **Frontend**: `apps/web/app-wishlist-gallery/`
   - `src/pages/main-page.tsx` - Add filter UI components (store filter, priority range, price range)
   - `src/components/FilterPanel/` - New component for advanced filters (or extend existing filter UI)

### Database Impact

- **No Schema Changes**: Uses existing fields (store, priority, price, pieceCount, releaseDate)
- **Recommended**: Review existing composite indexes for optimal query performance with combined WHERE + ORDER BY

### UI Surface

**Filter Panel** (new or extended):
- Store filter: Multi-select dropdown (LEGO, BrickLink, Amazon, Other)
- Priority range: Slider (0-5)
- Price range: Dual slider or min/max inputs
- "Apply Filters" button
- "Clear All" button

**Sort Dropdown** (existing):
- Continues to work with filters applied
- Smart sort options: Best Value, Expiring Soon, Hidden Gems

**Query State**:
- URL query params reflect all active filters + sort
- Deep linkable: `/wishlist?store=LEGO&priority=3-5&sort=bestValue`

## Acceptance Criteria

### Backend Implementation

**AC1**: Query schema supports combined filter + sort parameters
- Schema accepts: `{ store?: string[], priority?: { min: number, max: number }, priceRange?: { min: number, max: number }, sort?: 'bestValue' | 'expiringSoon' | 'hiddenGems' }`
- Zod validation enforces parameter types (store enum array, priority 0-5, price >= 0)
- 400 error returned for invalid combinations

**AC2**: Repository layer implements combined WHERE + ORDER BY queries
- Single Drizzle query applies all filters before sorting
- Filters applied with AND logic: `WHERE store IN (...) AND priority BETWEEN ... AND price BETWEEN ...`
- Smart sort logic applied via ORDER BY clause (from WISH-2014)
- Query execution verified with EXPLAIN ANALYZE

**AC3**: Null value handling works with combined filters
- Items with null price excluded when priceRange filter applied
- Items with null priority excluded when priority filter applied
- Items with null store treated as "Other" (or excluded based on filter)
- Null handling documented in API contract

**AC4**: Pagination works correctly with combined filters
- Total count reflects filtered items only
- Page boundaries respect filter criteria
- Pagination metadata includes filter context

**AC5**: Backend unit tests cover combined filter scenarios
- Test: Store filter + Best Value sort (10+ tests)
- Test: Priority range + Hidden Gems sort (10+ tests)
- Test: Price range + Expiring Soon sort (10+ tests)
- Test: All filters combined with each sort mode (15+ tests)
- Minimum: 45 unit tests total

**AC6**: Integration tests verify endpoint behavior
- `.http` file includes combined filter + sort requests
- Response structure matches `WishlistListResponseSchema`
- Items array verified against filter + sort logic
- Evidence: Request/response examples in `.http` file

### Frontend Implementation

**AC7**: Filter panel component renders all filter controls
- Store filter: Multi-select with checkboxes or Select primitive
- Priority range: Slider component (or dual input)
- Price range: Dual slider or min/max number inputs
- "Apply Filters" and "Clear All" buttons

**AC8**: Filter panel uses design system primitives
- Import from `@repo/app-component-library/_primitives/`
- Token-only colors (neutral-100, neutral-700, etc.)
- Consistent spacing and layout with existing UI

**AC9**: Filter state managed via URL query parameters
- URL updates when filters applied: `/wishlist?store=LEGO,BrickLink&priority=3-5&sort=bestValue`
- Deep linking works: User can bookmark or share filtered URL
- Browser back/forward navigation updates filters

**AC10**: RTK Query triggers API call with combined parameters
- `useGetWishlistQuery({ store: ['LEGO'], priority: { min: 3, max: 5 }, sort: 'bestValue' })` calls API correctly
- Loading state shown during fetch
- Items re-render after fetch completes with filtered results

**AC11**: Filter panel shows active filter count badge
- Badge displays: "3 filters active" when store + priority + price applied
- Badge hidden when no filters active
- Clicking badge expands filter panel (if collapsed)

**AC12**: "Clear All" button resets all filters
- Removes all filter query params from URL
- RTK Query refetches with no filters
- Sort mode preserved (if set)

**AC13**: Frontend component tests verify filter panel rendering
- Test: Filter controls render correctly
- Test: Apply button triggers API call with correct params
- Test: Clear All resets state
- Test: URL sync works (filter state â†” URL query params)
- Minimum: 15 component tests

**AC14**: Playwright E2E test covers combined filter + sort flow
- Test: Apply store filter + Best Value sort
- Test: Apply priority range + Hidden Gems sort
- Test: Apply all filters + sort, verify results
- Test: Clear filters, verify results reset
- Evidence: Screenshots + network HAR

### Schema Synchronization

**AC15**: Frontend and backend Zod schemas define identical filter structures
- Both define: `{ store?: string[], priority?: { min: number, max: number }, priceRange?: { min: number, max: number } }`
- Alignment test verifies schemas match (similar to WISH-2000 pattern)
- TypeScript compilation passes across all packages

### Error Handling

**AC16**: Invalid filter combinations return 400 error
- Request: `GET /api/wishlist?priority=6` (out of range)
- Response: 400 with validation error message
- Error message lists valid ranges

**AC17**: Empty result sets handled gracefully
- No items match filters: Empty array returned with 200 status
- Frontend shows: "No items match your filters. Try adjusting filters."
- "Clear All" button shown as suggested action

### Performance

**AC18**: Combined query performance meets requirements
- All filter + sort combinations complete < 2s with 1000+ items
- Database indexes reviewed and optimized for common filter combinations
- `EXPLAIN ANALYZE` output documented for query plan review

### Accessibility

**AC19**: Filter panel is keyboard navigable
- Tab focuses each filter control
- Arrow keys navigate multi-select options
- Enter applies filters
- Escape clears focus or closes panel

**AC20**: Screen reader announces filter state changes
- Filter applied: "3 filters active. 42 items found."
- Filters cleared: "Filters cleared. Showing all 150 items."
- Loading state: "Loading filtered results..."

## Reuse Plan

### Existing Components (from WISH-2014)

- âœ… `GET /api/wishlist` endpoint (extend with filter parameters)
- âœ… `useGetWishlistQuery` RTK Query hook (extend with filter params)
- âœ… Smart sort algorithms: bestValue, expiringSoon, hiddenGems
- âœ… Sort dropdown UI (continues to work with filters)

### Existing Patterns

- âœ… Zod schema validation (extend existing query schema)
- âœ… Drizzle query builder for database filtering + sorting
- âœ… RTK Query cache management (existing tags: Wishlist, WishlistItem)
- âœ… URL query parameter state management (from main-page.tsx)
- âœ… Error handling patterns from WISH-2001

### New Components (to build)

- ðŸ†• `FilterPanel` component (or extend existing filter UI)
- ðŸ†• Priority range slider component
- ðŸ†• Price range dual slider component
- ðŸ†• Active filter badge component

## Architecture Notes

### Hexagonal Architecture Compliance

**Domain Layer** (Business Logic):
- `apps/api/lego-api/domains/wishlist/application/wishlist-service.ts`
- Update `listItems()` method to accept filter parameters
- Pure business logic - no database coupling

**Adapter Layer** (Infrastructure):
- `apps/api/lego-api/domains/wishlist/adapters/wishlist-repository.ts`
- Implement Drizzle queries with combined WHERE + ORDER BY
- Handle null values using SQL CASE statements
- Use `sql` template for complex conditions

**Port Layer** (Contracts):
- `apps/api/lego-api/domains/wishlist/types.ts`
- Extend `ListWishlistQuerySchema` with filter parameters
- Define input/output contracts

**No Architecture Violations**: Story extends existing layers without coupling

### Filter Query Example

**Repository Layer**:
```typescript
// apps/api/lego-api/domains/wishlist/adapters/wishlist-repository.ts
async findByUser(userId: string, pagination, filters) {
  let query = db
    .select()
    .from(wishlistItems)
    .where(eq(wishlistItems.userId, userId))

  // Apply store filter
  if (filters.store?.length > 0) {
    query = query.where(inArray(wishlistItems.store, filters.store))
  }

  // Apply priority range filter
  if (filters.priority) {
    query = query.where(
      and(
        gte(wishlistItems.priority, filters.priority.min),
        lte(wishlistItems.priority, filters.priority.max)
      )
    )
  }

  // Apply price range filter
  if (filters.priceRange) {
    query = query.where(
      and(
        gte(wishlistItems.price, filters.priceRange.min),
        lte(wishlistItems.price, filters.priceRange.max)
      )
    )
  }

  // Apply smart sort (from WISH-2014)
  if (filters.sort === 'bestValue') {
    query = query.orderBy(
      sql`${wishlistItems.price}::numeric / NULLIF(${wishlistItems.pieceCount}, 0) ASC`
    )
  }
  // ... other sort modes

  return await query.limit(pagination.limit).offset(pagination.offset)
}
```

## HTTP Contract Plan

### Extended Endpoint: GET /api/wishlist

**Combined Query Parameters**:
```typescript
{
  // Filters
  store?: ('LEGO' | 'BrickLink' | 'Amazon' | 'Other')[]
  priority?: { min: number, max: number }  // 0-5
  priceRange?: { min: number, max: number }  // >= 0

  // Sort (from WISH-2014)
  sort?: 'bestValue' | 'expiringSoon' | 'hiddenGems'
  order?: 'asc' | 'desc'

  // Pagination (existing)
  page?: number
  limit?: number
}
```

**Example Requests**:
```http
# Store filter + Best Value sort
GET /api/wishlist?store=LEGO,BrickLink&sort=bestValue
Authorization: Bearer <token>

# Priority range + Hidden Gems sort
GET /api/wishlist?priority=3,5&sort=hiddenGems
Authorization: Bearer <token>

# All filters + Expiring Soon sort
GET /api/wishlist?store=LEGO&priority=2,4&priceRange=50,200&sort=expiringSoon
Authorization: Bearer <token>
```

**Response Format** (unchanged):
```json
{
  "items": [
    {
      "id": "uuid",
      "title": "Millennium Falcon",
      "price": "149.99",
      "pieceCount": 1351,
      "releaseDate": "2018-09-01T00:00:00Z",
      "priority": 3,
      "store": "LEGO"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 12,
    "totalPages": 1
  },
  "appliedFilters": {
    "store": ["LEGO"],
    "priority": { "min": 2, "max": 4 },
    "priceRange": { "min": 50, "max": 200 },
    "sort": "expiringSoon"
  }
}
```

**Error Responses**:
```json
// 400 - Invalid filter parameter
{
  "error": "Validation failed",
  "details": {
    "fieldErrors": {
      "priority": ["min must be >= 0 and <= 5"]
    }
  }
}
```

## Test Plan

### Backend Unit Tests

**Service Layer Tests**:
1. Store filter + Best Value sort - 10 tests
2. Priority range + Hidden Gems sort - 10 tests
3. Price range + Expiring Soon sort - 10 tests
4. All filters combined - 15 tests
5. Null value handling with filters - 10 tests

**Minimum**: 45 unit tests total (extends WISH-2014's 15 tests)

### Backend Integration Tests

**HTTP Tests** (`__http__/wishlist-advanced-filtering.http`):
- Happy path: All filter combinations with each sort mode (9 requests)
- Error cases: Invalid filter values (3 requests)
- Edge cases: Empty results, null values, boundary conditions (5 requests)
- Performance: 1000+ items with all filters (1 request with timing)

**Minimum**: 18 HTTP test scenarios

### Frontend Tests

**Component Tests** (FilterPanel):
- Rendering: All filter controls render correctly (5 tests)
- Interaction: Apply filters triggers API call (5 tests)
- State management: URL sync, Clear All (5 tests)
- Validation: Min/max range validation (5 tests)

**Minimum**: 20 component tests (extends WISH-2014's 5 tests)

**E2E Tests (Playwright)**:
- Full filter flow: Apply filters â†’ verify results â†’ clear filters (1 test)
- Combined scenarios: Store + priority + sort (1 test)
- Accessibility: Keyboard navigation (1 test)
- Deep linking: URL with filters loads correctly (1 test)

**Minimum**: 4 E2E tests

## UI/UX Notes

### MVP-Critical Requirements

**Filter Panel Design**:
- Collapsible panel (desktop: sidebar, mobile: drawer)
- "Filter" button with active count badge: "Filter (3)"
- Store filter: Checkbox group (4 options: LEGO, BrickLink, Amazon, Other)
- Priority range: Dual-handle slider (0-5) with numeric labels
- Price range: Dual number inputs (min/max) with currency symbol ($)
- Apply button: Primary style (calls API)
- Clear All button: Secondary style (resets all filters)

**Design System Compliance**:
- Import primitives from `@repo/app-component-library/_primitives/`
- Token-only colors (neutral, primary, secondary)
- Icons from lucide-react: Filter, X, TrendingDown, ArrowUpDown

**Accessibility**:
- Keyboard navigation for all controls
- Screen reader announcements for filter state changes
- Focus management: Return focus to "Filter" button after panel closes
- ARIA labels: "Filter panel", "Active filters: 3"

**Responsive Design**:
- Desktop: Sidebar filter panel (left or right)
- Tablet: Collapsible sidebar
- Mobile: Bottom drawer or modal

### Future Enhancements (Non-MVP)

**Phase 5 - UX Polish**:
- Saved filter presets ("My Budget Sets", "High Priority LEGO")
- Filter history/undo
- Animated filter transitions
- Filter auto-suggestions based on usage patterns

**Phase 7 - Advanced Features**:
- Custom filter logic builder (boolean AND/OR/NOT)
- Cross-user filter sharing
- Filter templates for common use cases
- Real-time collaborative filtering

## Risks & Mitigations

### MVP-Critical Risks

1. **Query Performance Degradation**
   - Risk: Combined WHERE + ORDER BY queries may be slow with 1000+ items
   - Mitigation: Review existing indexes, add composite indexes if needed (e.g., `(userId, store, priority)`)
   - Acceptance Criteria: AC18 requires < 2s query time

2. **URL Length Limits**
   - Risk: Long filter query strings may exceed browser URL length limits (2083 chars)
   - Mitigation: Encode filter state as base64 JSON if length > 1500 chars, or use POST for complex filters
   - Acceptance Criteria: AC9 validates deep linking works

3. **Filter State Synchronization**
   - Risk: URL state and RTK Query state may drift if not carefully managed
   - Mitigation: Single source of truth (URL), RTK Query derives from URL params
   - Acceptance Criteria: AC9 validates URL sync, AC13 validates state consistency

4. **Schema Synchronization (Frontend â†” Backend)**
   - Risk: Filter parameter schemas may diverge between frontend and backend
   - Mitigation: AC15 requires alignment test (like WISH-2000)
   - Acceptance Criteria: AC15 validates schema parity

5. **Empty Result Set UX**
   - Risk: Users may apply overly restrictive filters and see empty results
   - Mitigation: AC17 requires helpful empty state with "Clear All" CTA
   - Acceptance Criteria: AC17 validates empty state UX

### Non-MVP Risks

- Filter discoverability: Users may not notice filter panel (mitigate with onboarding tooltip in Phase 5)
- Mobile filter UX: Small screen filter panels may be cramped (mitigate with bottom drawer pattern)
- Filter complexity: Too many options may overwhelm users (mitigate with progressive disclosure in Phase 7)
- Performance at scale: 10,000+ items with complex filters (monitor P95 latency, optimize indexes as needed)

## Implementation Notes

### Recommended Implementation Sequence

**Phase 1: Backend Foundation** (Days 1-2)
1. Extend Zod schemas with filter parameters
2. Update service layer to accept filters
3. Implement repository queries with WHERE + ORDER BY
4. Add 45 unit tests

**Phase 2: Backend Integration** (Day 3)
1. Create `.http` test file with 18 scenarios
2. Test all filter combinations
3. Verify query performance (< 2s)
4. Document query plans with EXPLAIN ANALYZE

**Phase 3: Frontend UI** (Days 4-5)
1. Create FilterPanel component
2. Add filter controls (store, priority, price)
3. Implement URL state management
4. Add 20 component tests

**Phase 4: Frontend Integration** (Day 6)
1. Wire FilterPanel to RTK Query
2. Test filter + sort combinations
3. Add active filter badge
4. Implement "Clear All" functionality

**Phase 5: E2E Verification** (Day 7)
1. Add 4 Playwright tests
2. Test full filter flow
3. Verify accessibility (keyboard nav, screen reader)
4. Capture evidence (screenshots, HAR files)

**Phase 6: Code Review & Refinement** (Day 8)
1. Address review feedback
2. Optimize query performance
3. Fix edge cases
4. Update documentation

**Estimated Total Effort**: 5-8 days (1 developer) or 3-5 days (2 developers: 1 backend, 1 frontend)

## Definition of Done

- [ ] All 20 Acceptance Criteria pass
- [ ] Backend: 45 unit tests pass
- [ ] Backend: 18 integration tests pass (`.http` file)
- [ ] Backend: Query performance < 2s for 1000+ items with all filters
- [ ] Frontend: 20 component tests pass
- [ ] Frontend: 4 Playwright E2E tests pass with evidence
- [ ] Accessibility: Axe-core audit passes (0 violations)
- [ ] Accessibility: Keyboard navigation test passes
- [ ] Schema alignment test passes (frontend â†” backend)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved
- [ ] Documentation updated (API docs, UI component docs)
- [ ] QA verification complete

## Open Questions

None - Story is implementation-ready.

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Architecture ambiguity | Add as AC - Clarify lego-api uses hexagonal architecture and is exempt from api-layer.md pattern | Critical for backend implementation. Determines directory structure and package organization. |
| 2 | Filter encoding undefined | Add as AC - Specify comma-separated format: ?store=LEGO,BrickLink | Blocks frontend/backend integration. Must clarify HTTP query param encoding for array parameters. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1-15 | Non-Blocking Enhancements | Skipped - Not reviewed in interactive phase | Detailed in _implementation/FUTURE-OPPORTUNITIES.md. User approved skipping per prioritization constraints. |

### Follow-up Stories Suggested

- [ ] **WISH-2018: Filter State Persistence** (Phase 5 UX Polish)
  - Store active filters in localStorage. On page load, restore last-used filters.
  - Depends on WISH-2017-B (Frontend Filter Panel UI)
  - Effort: 2 days

### Items Marked Out-of-Scope

- Real-time collaborative filtering: Deferred to Phase 7
- Machine learning-based recommendations: Deferred to future epic
- Saved filter presets: Deferred to Phase 5 UX Polish
- Filter history/undo: Deferred to Phase 5
- Custom user-defined filter logic: Deferred to Phase 7
- Cross-user filter sharing: Deferred to Phase 7

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Elaboration | ~20k | â€” | â€” | PM orchestration + 3 workers |
| Implementation | ~18k | â€” | â€” | Frontend + Backend (larger scope than WISH-2014) |
| Code Review | ~8k | â€” | â€” | Larger scope (filter panel + backend logic) |
| **Total** | ~46k | â€” | â€” | Large-sized story |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|
