---
doc_type: story
title: "WISH-2058: Core WebP Conversion"
story_id: WISH-2058
story_prefix: WISH
status: ready-for-qa
split_from: WISH-2048
split_part: 1 of 2
phase: 4
created_at: "2026-01-31T10:00:00-07:00"
updated_at: "2026-01-31T17:00:00-07:00"
depends_on: [WISH-2022]
estimated_points: 2
---

# WISH-2058: Core WebP Conversion

## Split Context

This story is part of a split from WISH-2048 (WebP Format Conversion).

- **Original Story:** WISH-2048
- **Split Reason:** Story too large (14 ACs) with overlapping concerns between core WebP conversion and browser fallback logic
- **This Part:** 1 of 2 (Y=5) - Core WebP Conversion
- **Dependency:** Depends on WISH-2022 (Client-side Image Compression)
- **Sibling Story:** WISH-2068 (Browser Compatibility & Fallback) - depends on this story

## Follow-up Context

**Parent Story:** WISH-2022: Client-side Image Compression
**Source:** QA Discovery Notes - Enhancement Opportunities
**Original Finding:** WebP format conversion - Convert to WebP instead of JPEG for 25-35% additional size savings; supported by browser-image-compression library
**Category:** Enhancement Opportunity
**Impact:** Medium - additional storage and bandwidth savings with minimal quality loss
**Effort:** Low - simple configuration change to browser-image-compression library

## Context

WISH-2022 compresses images to JPEG format with quality 0.8, providing 60-80% size reduction. However, WebP format offers superior compression efficiency compared to JPEG:
- 25-35% smaller file sizes at equivalent visual quality
- Better compression algorithm with both lossy and lossless modes
- Supported by 97%+ of modern browsers (Chrome, Firefox, Safari 14+, Edge)
- Already supported by browser-image-compression library via configuration option

Converting to WebP format provides additional storage and bandwidth savings on top of WISH-2022's compression, without requiring major changes to the compression pipeline.

**Split Scope:** This story focuses ONLY on the core WebP conversion for modern browsers. Browser compatibility detection and fallback logic are handled by WISH-2068.

## Goal

Convert compressed images to WebP format instead of JPEG to achieve 25-35% additional size savings while maintaining acceptable visual quality in modern browsers (Chrome, Firefox, Safari 14+, Edge).

## Non-goals

- Not implementing browser compatibility detection (handled by WISH-2068)
- Not implementing JPEG fallback for older browsers (handled by WISH-2068)
- Not implementing lossless WebP compression (lossy is sufficient for wishlist images)
- Not implementing WebP animation support (out of scope for wishlist images)
- Not re-implementing the compression pipeline from WISH-2022
- Not implementing server-side WebP conversion (client-side only)

## Scope

**Components Affected:**
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts`

**Packages Affected:**
- `apps/web/app-wishlist-gallery`

**Configuration Changes:**
- Update `browser-image-compression` options from `fileType: 'image/jpeg'` to `fileType: 'image/webp'`
- Maintain existing compression settings (maxSizeMB: 1, maxWidthOrHeight: 1920, quality: 0.8)

## Acceptance Criteria

- [ ] AC1: Images are compressed to WebP format instead of JPEG by changing `fileType: 'image/webp'` in compression settings
- [ ] AC2: WebP compression quality is set to 0.8 (matching WISH-2022 JPEG quality)
- [ ] AC3: Compressed WebP images are 25-35% smaller than equivalent JPEG images at same visual quality
- [ ] AC4: Toast notification shows updated format: "Image compressed to WebP: X MB → Y MB"
- [ ] AC5: Original filename is preserved with `.webp` extension (e.g., `photo.jpg` → `photo.webp`)
- [ ] AC6: Image preview displays compressed WebP image correctly in all supported browsers
- [ ] AC7: S3 upload accepts WebP images with correct MIME type (`image/webp`)
- [ ] AC8: Backend API stores WebP image URL without modification (no format conversion)
- [ ] AC11: Unit tests verify WebP format output from imageCompression utility
- [ ] AC12: Integration tests verify useS3Upload hook uploads WebP images successfully
- [ ] AC13: Playwright E2E tests verify end-to-end WebP compression and upload workflow
- [ ] AC14: Documentation updated to reflect WebP as default output format

**Note:** AC9 (browser compatibility check) and AC10 (fallback to JPEG) are handled by WISH-2068.

## Reuse Plan

- Builds on `imageCompression.ts` utility from WISH-2022
- Leverages existing `browser-image-compression` library (WebP support built-in)
- Reuses compression progress indicator from WISH-2022
- Reuses error handling from WISH-2022 (excluding fallback logic, which goes to WISH-2068)
- Reuses toast notification system from WISH-2022

## Architecture Notes

**WebP Configuration:**
```typescript
// Updated from WISH-2022
{
  maxSizeMB: 1,
  maxWidthOrHeight: 1920,
  useWebWorker: true,
  fileType: 'image/webp', // Changed from 'image/jpeg'
  initialQuality: 0.8
}
```

**Browser Compatibility:**
- Chrome 32+ (2014)
- Firefox 65+ (2019)
- Safari 14+ (2020)
- Edge 18+ (2018)
- Coverage: 97%+ of users

**Migration Impact:**
- New uploads: Automatically compressed to WebP
- Existing images: Remain as JPEG (no retroactive conversion)
- No database schema changes required

**Fallback Strategy:**
Browser compatibility detection and fallback to JPEG are handled by WISH-2068 (sibling story). This story assumes modern browsers with WebP support.

## Test Plan

### Happy Path

1. User selects high-resolution image (5MB, 4032x3024) in Chrome/Firefox/Safari 14+
2. Compression starts automatically
3. Progress indicator shows: "Compressing image... 45%"
4. Compression completes: "Image compressed to WebP: 5.2 MB → 0.5 MB" (vs 0.8 MB JPEG)
5. Preview updates with WebP image
6. User submits form
7. WebP image uploads to S3 with `image/webp` MIME type
8. Backend API stores image URL correctly

### Error Cases

Error handling for browser compatibility and fallback scenarios is handled by WISH-2068. This story focuses on the happy path with modern browsers.

### Edge Cases

1. **Already WebP**: If user selects WebP image, compress with same settings (no conversion)
2. **Transparent images**: WebP supports transparency; PNG images with alpha channel preserve transparency
3. **HEIC/HEIF source**: If source is HEIC (from WISH-2045), convert to WebP instead of JPEG
4. **User preference**: "High quality (skip compression)" checkbox skips WebP conversion entirely

## Risks / Edge Cases

1. **Quality perception**: WebP at 0.8 quality may have different visual characteristics than JPEG; acceptable for wishlist images
2. **Compression time**: WebP encoding may be 10-20% slower than JPEG; negligible for single-image uploads
3. **File extension confusion**: Users may not recognize `.webp` extension; mitigate with toast notification

**Note:** Browser compatibility risks are handled by WISH-2068.

## Open Questions

None - all requirements are clear and non-blocking.

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-31_

### Gaps Identified

No MVP-critical gaps identified. Core journey is complete for WebP conversion of modern browsers.

### Enhancement Opportunities

None - story scope is appropriately focused.

### Follow-up Stories Suggested

- [x] WISH-2068: Browser Compatibility & Fallback (depends on this story, handles older browser fallback)

### Items Marked Out-of-Scope

- Browser compatibility detection: Handled by WISH-2068 (sibling story)
- JPEG fallback for older browsers: Handled by WISH-2068
- Lossless WebP compression: Lossy compression is sufficient for wishlist images
- WebP animation support: Out of scope for wishlist image conversion
- Server-side WebP conversion: Client-side only per story scope
