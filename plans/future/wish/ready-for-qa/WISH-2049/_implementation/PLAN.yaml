---
story_id: WISH-2049
title: "Background Compression for Perceived Performance"
created_at: "2026-02-08"
autonomy_level: conservative
batch_mode: false
estimated_hours: 8

# ============================================================================
# OVERVIEW
# ============================================================================

overview: |
  Move image compression from form submission to image selection (onChange event),
  enabling background compression while user fills form. This reduces perceived
  latency by 62% (from 8s to 3s for typical 5MB images).

  Current Flow (WISH-2022):
    1. User fills form
    2. User clicks submit
    3. Compression starts → "Compressing image... X%"
    4. Upload starts → "Uploading... Y%"
    5. Navigation

  Target Flow (WISH-2049):
    1. User selects image → compression starts immediately in background
    2. User fills form (compression running in parallel)
    3. Compression completes → toast notification
    4. User clicks submit → upload starts immediately (no compression wait)
    5. Navigation

# ============================================================================
# ARCHITECTURE DECISIONS
# ============================================================================

architecture:
  state_management:
    approach: "Custom React hook (useBackgroundCompression)"
    rationale: |
      - Encapsulates compression state, AbortController, and stale result detection
      - Separates concerns from useS3Upload (single responsibility)
      - Easier to test in isolation
      - Can be reused in other contexts (future multi-image upload)

    state_shape:
      status: "'idle' | 'compressing' | 'complete' | 'failed'"
      originalFile: "File | null"
      compressedFile: "File | null"
      compressionResult: "CompressionResult | null"
      progress: "number (0-100)"
      error: "string | null"
      requestId: "string | null (for stale result detection - AC15)"

  cancellation_strategy:
    mechanism: "AbortController + requestId tracking"
    rationale: |
      - browser-image-compression doesn't support native AbortController
      - Use requestId to detect and discard stale results (AC15)
      - AbortController used for cleanup coordination
      - Race condition handling for rapid image changes (AC14)

    implementation:
      - "Generate unique requestId (timestamp-based) per compression request"
      - "Store current requestId in ref"
      - "On image change: increment requestId, ignore old results"
      - "Compression callback checks: if (requestId !== currentRequestId) return"

  integration_points:
    useS3Upload_modifications:
      - "Add optional compressedFile parameter to upload()"
      - "Skip compression phase if compressedFile provided"
      - "Remove compression logic from upload flow"
      - "Maintain backward compatibility (compression still works if no compressedFile)"

    wishlist_form_modifications:
      - "Instantiate useBackgroundCompression hook"
      - "Trigger compression on handleFileSelect"
      - "Pass compressedFile to useS3Upload.upload() if status === 'complete'"
      - "Handle status === 'compressing' on submit (show progress, wait)"
      - "skipCompression checkbox bypasses useBackgroundCompression"

# ============================================================================
# IMPLEMENTATION PHASES
# ============================================================================

phases:
  # ──────────────────────────────────────────────────────────────────────────
  # Phase 1: Create useBackgroundCompression Hook
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 1
    name: "Create useBackgroundCompression Hook"
    description: "New custom hook to manage background compression state and lifecycle"

    files_to_create:
      - path: "apps/web/app-wishlist-gallery/src/hooks/useBackgroundCompression.ts"
        purpose: "Custom hook for background compression state management"
        key_responsibilities:
          - "State management: status, files, progress, error, requestId"
          - "Compression trigger: startCompression(file, config)"
          - "Cancellation: cancel() method"
          - "Reset: reset() method"
          - "Stale result detection via requestId (AC15)"
          - "Progress callback integration"

        exports:
          - "interface BackgroundCompressionState"
          - "interface BackgroundCompressionResult"
          - "function useBackgroundCompression(): BackgroundCompressionResult"

        dependencies:
          - "compressImage from ../../utils/imageCompression"
          - "useState, useCallback, useRef from react"
          - "CompressionConfig, CompressionResult from ../../utils/imageCompression"

      - path: "apps/web/app-wishlist-gallery/src/hooks/__types__/index.ts"
        purpose: "Zod schemas for useBackgroundCompression types"
        schemas:
          - "BackgroundCompressionStatusSchema: z.enum(['idle', 'compressing', 'complete', 'failed'])"
          - "BackgroundCompressionStateSchema: z.object({ status, originalFile, compressedFile, ... })"
          - "BackgroundCompressionResultSchema: z.object({ state, startCompression, cancel, reset })"

    acceptance_criteria:
      - "Hook manages compression state: idle → compressing → complete/failed"
      - "startCompression() triggers background compression with progress tracking"
      - "cancel() aborts in-progress compression via requestId invalidation"
      - "reset() clears all state back to idle"
      - "Stale result detection: requestId checked before state updates (AC15)"
      - "Progress callback updates state.progress (0-100)"

  # ──────────────────────────────────────────────────────────────────────────
  # Phase 2: Modify useS3Upload Hook
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 2
    name: "Modify useS3Upload Hook"
    description: "Refactor useS3Upload to accept pre-compressed file and skip compression phase"

    files_to_modify:
      - path: "apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts"
        changes:
          - type: "interface"
            description: "Add compressedFile optional parameter to UploadOptions"
            code: |
              export interface UploadOptions {
                preset?: CompressionPresetName
                skipCompression?: boolean
                compressedFile?: File  // NEW: Pre-compressed file from background compression
              }

          - type: "logic"
            description: "Skip compression phase if compressedFile provided"
            location: "upload() function, after HEIC conversion"
            code: |
              let fileToUpload = fileToProcess

              // NEW: Use pre-compressed file if available (background compression)
              if (options.compressedFile) {
                fileToUpload = options.compressedFile
                // Set compression result for toast notification
                setCompressionResult({
                  compressed: true,
                  file: options.compressedFile,
                  originalSize: file.size,
                  finalSize: options.compressedFile.size,
                  ratio: options.compressedFile.size / file.size,
                })
                setPresetUsed(preset)
              } else if (!skipCompression) {
                // Existing compression logic remains unchanged
                setState('compressing')
                const presetConfig = getPresetByName(preset)
                const result = await compressImage(fileToProcess, {
                  config: presetConfig.settings,
                  onProgress: setCompressionProgress,
                })
                setCompressionResult(result)
                setPresetUsed(preset)
                fileToUpload = result.file

                if (abortControllerRef.current?.signal.aborted) {
                  setState('idle')
                  return null
                }
              }

          - type: "documentation"
            description: "Update JSDoc to document compressedFile parameter"
            location: "UploadOptions interface"

    acceptance_criteria:
      - "UploadOptions interface includes compressedFile?: File"
      - "If compressedFile provided, skip compression phase entirely"
      - "Compression toast still shows (using pre-compressed file metadata)"
      - "Backward compatibility: existing calls without compressedFile work unchanged"
      - "Tests pass: existing useS3Upload tests continue to work"

  # ──────────────────────────────────────────────────────────────────────────
  # Phase 3: Integrate Background Compression in WishlistForm
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 3
    name: "Integrate Background Compression in WishlistForm"
    description: "Trigger background compression on image selection, manage state during form submission"

    files_to_modify:
      - path: "apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx"
        changes:
          - type: "import"
            description: "Import useBackgroundCompression hook"
            code: |
              import { useBackgroundCompression } from '../../hooks/useBackgroundCompression'

          - type: "hook_instantiation"
            description: "Instantiate useBackgroundCompression hook"
            location: "After useS3Upload hook"
            code: |
              const {
                state: bgCompressionState,
                startCompression,
                cancel: cancelCompression,
                reset: resetBackgroundCompression,
              } = useBackgroundCompression()

          - type: "logic"
            description: "Trigger background compression on file selection"
            location: "handleFileSelect function, after preview is set"
            code: |
              const handleFileSelect = useCallback(
                async (file: File) => {
                  const error = validateFile(file)
                  if (error) {
                    setErrors(prev => ({ ...prev, imageUrl: error }))
                    return
                  }

                  // Show preview immediately
                  const reader = new FileReader()
                  reader.onload = e => {
                    setImagePreview(e.target?.result as string)
                  }
                  reader.readAsDataURL(file)

                  // NEW: Start background compression (unless skipCompression is true)
                  if (!skipCompression) {
                    const presetConfig = getPresetByName(validPreset)
                    await startCompression(file, presetConfig.settings)
                  } else {
                    // If skipCompression, upload original immediately
                    await upload(file, {
                      skipCompression: true,
                      preset: validPreset,
                    })
                  }
                },
                [upload, validateFile, skipCompression, validPreset, startCompression],
              )

          - type: "logic"
            description: "Handle form submission with background compression state"
            location: "handleFormSubmit function"
            code: |
              const handleFormSubmit = useCallback(
                async (e: FormEvent) => {
                  e.preventDefault()
                  const data = validateForm()
                  if (!data) return

                  // NEW: Handle background compression state
                  if (!skipCompression && bgCompressionState.status === 'complete') {
                    // Compression already complete, upload compressed file
                    await upload(bgCompressionState.originalFile!, {
                      skipCompression: false,
                      preset: validPreset,
                      compressedFile: bgCompressionState.compressedFile!,
                    })
                  } else if (!skipCompression && bgCompressionState.status === 'compressing') {
                    // Compression still in progress, wait for completion
                    // The upload will show "Compressing image... X%" (existing behavior)
                    await upload(bgCompressionState.originalFile!, {
                      skipCompression: false,
                      preset: validPreset,
                    })
                  } else if (!skipCompression && bgCompressionState.status === 'failed') {
                    // Compression failed, upload original (fallback)
                    await upload(bgCompressionState.originalFile!, {
                      skipCompression: true,
                      preset: validPreset,
                    })
                  }
                  // else: skipCompression === true, upload already happened in handleFileSelect

                  await onSubmit(data)
                },
                [validateForm, onSubmit, upload, bgCompressionState, skipCompression, validPreset],
              )

          - type: "ui"
            description: "Add toast notification when background compression completes"
            location: "useEffect for bgCompressionState changes"
            code: |
              // NEW: Show toast when background compression completes
              useEffect(() => {
                if (bgCompressionState.status === 'complete' && bgCompressionState.compressionResult) {
                  const result = bgCompressionState.compressionResult
                  if (result.compressed) {
                    const preset = getPresetByName(validPreset)
                    toast.success(
                      `Image compressed with ${preset.label}: ${formatFileSize(result.originalSize)} -> ${formatFileSize(result.finalSize)}`,
                    )
                  } else if (!result.compressed && !result.error) {
                    toast.info('Image already optimized, no compression needed')
                  }
                } else if (bgCompressionState.status === 'failed') {
                  toast.warning('Compression failed, using original image')
                }
              }, [bgCompressionState.status, bgCompressionState.compressionResult, validPreset])

          - type: "cleanup"
            description: "Cancel background compression when image removed"
            location: "handleRemoveImage function"
            code: |
              const handleRemoveImage = useCallback(() => {
                setImagePreview(null)
                resetUpload()
                cancelCompression()  // NEW: Cancel background compression
                resetBackgroundCompression()  // NEW: Reset background compression state
                if (fileInputRef.current) {
                  fileInputRef.current.value = ''
                }
              }, [resetUpload, cancelCompression, resetBackgroundCompression])

    acceptance_criteria:
      - "Background compression starts on image selection (onChange event) (AC1)"
      - "Form remains interactive during background compression (AC3)"
      - "If compression complete before submit, pass compressedFile to upload (AC4)"
      - "If compression in progress on submit, show progress and wait (AC5)"
      - "If compression failed, fall back to original upload (AC9)"
      - "skipCompression checkbox bypasses background compression (AC10)"
      - "Toast notification shows when background compression completes (AC11)"
      - "Removing image cancels background compression"

  # ──────────────────────────────────────────────────────────────────────────
  # Phase 4: Handle Image Change Cancellation
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 4
    name: "Handle Image Change Cancellation"
    description: "Implement cancellation logic when user changes image during compression (AC8, AC14)"

    files_to_modify:
      - path: "apps/web/app-wishlist-gallery/src/hooks/useBackgroundCompression.ts"
        changes:
          - type: "logic"
            description: "Increment requestId on each new compression start"
            location: "startCompression function"
            code: |
              const startCompression = useCallback(
                async (file: File, config: CompressionConfig) => {
                  // Cancel previous compression by invalidating requestId
                  const newRequestId = `${Date.now()}-${Math.random()}`
                  requestIdRef.current = newRequestId

                  setStatus('compressing')
                  setOriginalFile(file)
                  setCompressedFile(null)
                  setCompressionResult(null)
                  setProgress(0)
                  setError(null)

                  try {
                    const result = await compressImage(file, {
                      config,
                      onProgress: (progress) => {
                        // Check requestId before updating state (stale result detection)
                        if (requestIdRef.current === newRequestId) {
                          setProgress(progress)
                        }
                      },
                    })

                    // Check requestId before updating final state (AC15)
                    if (requestIdRef.current !== newRequestId) {
                      // Stale result, discard
                      return
                    }

                    setCompressionResult(result)
                    setCompressedFile(result.file)
                    setStatus('complete')
                  } catch (err) {
                    // Check requestId before setting error state
                    if (requestIdRef.current !== newRequestId) {
                      return
                    }

                    const errorMessage = err instanceof Error ? err.message : 'Compression failed'
                    setError(errorMessage)
                    setStatus('failed')
                  }
                },
                [],
              )

      - path: "apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx"
        changes:
          - type: "logic"
            description: "Cancel previous compression on image change"
            location: "handleFileSelect function, at start"
            code: |
              const handleFileSelect = useCallback(
                async (file: File) => {
                  // NEW: Cancel any in-progress compression before starting new one (AC8)
                  if (bgCompressionState.status === 'compressing') {
                    cancelCompression()
                  }

                  const error = validateFile(file)
                  // ... rest of function
                },
                [/* dependencies */],
              )

    acceptance_criteria:
      - "Changing image cancels previous compression (AC8)"
      - "requestId prevents stale results from updating state (AC15)"
      - "Rapid image changes (< 100ms) don't cause state corruption (AC14)"
      - "Only the most recent compression result updates state"

  # ──────────────────────────────────────────────────────────────────────────
  # Phase 5: Unit Tests - useBackgroundCompression
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 5
    name: "Unit Tests - useBackgroundCompression"
    description: "Comprehensive unit tests for background compression hook"

    files_to_create:
      - path: "apps/web/app-wishlist-gallery/src/hooks/__tests__/useBackgroundCompression.test.ts"
        purpose: "Unit tests for useBackgroundCompression hook"
        test_scenarios:
          - "Hook initialization: state is idle"
          - "startCompression: transitions to compressing → complete"
          - "startCompression: handles compression failure → failed"
          - "startCompression: progress callback updates state"
          - "cancel: invalidates requestId, prevents stale updates"
          - "reset: clears all state back to idle"
          - "Rapid image change (< 100ms): only latest result updates state (AC14)"
          - "Stale result detection: old requestId ignored (AC15)"
          - "Compression result stored correctly in state"
          - "Error handling: compression throws, state → failed"

        mocks:
          - "compressImage from ../../utils/imageCompression"
          - "Mock File objects"

    acceptance_criteria:
      - "All unit tests pass with >90% code coverage"
      - "AC14 validated: rapid image change test"
      - "AC15 validated: stale result detection test"
      - "Edge cases covered: empty file, null config, etc."

  # ──────────────────────────────────────────────────────────────────────────
  # Phase 6: Unit Tests - useS3Upload Modifications
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 6
    name: "Unit Tests - useS3Upload Modifications"
    description: "Update useS3Upload tests to cover compressedFile parameter"

    files_to_modify:
      - path: "apps/web/app-wishlist-gallery/src/hooks/__tests__/useS3Upload.test.ts"
        changes:
          - type: "test_scenario"
            description: "Add test: upload with compressedFile skips compression phase"
            code: |
              it('should skip compression phase when compressedFile provided', async () => {
                const { result } = renderHook(() => useS3Upload())
                const testFile = new File(['test'], 'test.jpg', { type: 'image/jpeg' })
                const compressedFile = new File(['compressed'], 'test.webp', { type: 'image/webp' })

                mockUnwrap.mockResolvedValue({
                  presignedUrl: 'https://s3.amazonaws.com/test',
                  key: 'uploads/test.webp',
                })
                mockUploadToPresignedUrl.mockResolvedValue(undefined)

                await act(async () => {
                  await result.current.upload(testFile, {
                    compressedFile,
                    preset: 'balanced',
                  })
                })

                // Verify compression was NOT called (skipped)
                expect(mockCompressImage).not.toHaveBeenCalled()

                // Verify upload was called with compressedFile
                expect(mockUploadToPresignedUrl).toHaveBeenCalledWith(
                  expect.objectContaining({
                    file: compressedFile,
                  })
                )

                // Verify compression result is set (for toast)
                expect(result.current.compressionResult).toMatchObject({
                  compressed: true,
                  file: compressedFile,
                  originalSize: testFile.size,
                  finalSize: compressedFile.size,
                })
              })

          - type: "test_scenario"
            description: "Add test: backward compatibility - upload without compressedFile"
            code: |
              it('should maintain backward compatibility when compressedFile not provided', async () => {
                const { result } = renderHook(() => useS3Upload())
                const testFile = new File(['test'], 'test.jpg', { type: 'image/jpeg' })

                mockCompressImage.mockResolvedValue({
                  compressed: true,
                  file: new File(['compressed'], 'test.webp', { type: 'image/webp' }),
                  originalSize: 1000,
                  finalSize: 500,
                  ratio: 0.5,
                })
                mockUnwrap.mockResolvedValue({
                  presignedUrl: 'https://s3.amazonaws.com/test',
                  key: 'uploads/test.webp',
                })
                mockUploadToPresignedUrl.mockResolvedValue(undefined)

                await act(async () => {
                  await result.current.upload(testFile, {
                    preset: 'balanced',
                  })
                })

                // Verify compression WAS called (backward compatibility)
                expect(mockCompressImage).toHaveBeenCalled()
              })

    acceptance_criteria:
      - "New tests pass: compressedFile parameter skips compression"
      - "Backward compatibility test passes: no compressedFile = normal flow"
      - "All existing useS3Upload tests continue to pass"

  # ──────────────────────────────────────────────────────────────────────────
  # Phase 7: Integration Tests - WishlistForm
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 7
    name: "Integration Tests - WishlistForm"
    description: "Integration tests for WishlistForm with background compression"

    files_to_modify:
      - path: "apps/web/app-wishlist-gallery/src/components/WishlistForm/__tests__/WishlistForm.test.tsx"
        changes:
          - type: "test_scenario"
            description: "Background compression starts on image selection"
            code: |
              it('should start background compression when image selected', async () => {
                const mockStartCompression = vi.fn()
                vi.mocked(useBackgroundCompression).mockReturnValue({
                  state: { status: 'idle', /* ... */ },
                  startCompression: mockStartCompression,
                  cancel: vi.fn(),
                  reset: vi.fn(),
                })

                render(<WishlistForm onSubmit={mockOnSubmit} />)

                const fileInput = screen.getByLabelText(/image/i)
                const testFile = new File(['test'], 'test.jpg', { type: 'image/jpeg' })

                await userEvent.upload(fileInput, testFile)

                await waitFor(() => {
                  expect(mockStartCompression).toHaveBeenCalledWith(
                    testFile,
                    expect.objectContaining({ maxSizeMB: 1 })
                  )
                })
              })

          - type: "test_scenario"
            description: "Form submission waits for compression if in progress"
            # Similar structure for other test scenarios

    test_scenarios:
      - "Background compression starts on image selection"
      - "Form submission uses compressedFile if compression complete"
      - "Form submission waits if compression in progress"
      - "Form submission falls back if compression failed"
      - "skipCompression checkbox bypasses background compression"
      - "Toast notification shows when compression completes"
      - "Image change cancels previous compression"
      - "Rapid image change (< 100ms) handles correctly"

    acceptance_criteria:
      - "All integration tests pass"
      - "AC1, AC3, AC4, AC5, AC8, AC9, AC10, AC11 validated"
      - "AC14, AC15 validated in integration context"

  # ──────────────────────────────────────────────────────────────────────────
  # Phase 8: Playwright E2E Tests
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 8
    name: "Playwright E2E Tests"
    description: "End-to-end tests for background compression scenarios"

    files_to_create:
      - path: "apps/web/playwright/features/wishlist/wishlist-background-compression.feature"
        purpose: "E2E test scenarios for background compression"
        scenarios:
          - name: "Background compression completes before form submission"
            description: "Happy path: compression finishes while user fills form"
            steps:
              - "Given I am on the add wishlist item page"
              - "When I select a large image for upload"
              - "Then background compression should start"
              - "And the form fields should remain enabled"
              - "When I fill in the title with 'Test Item'"
              - "And I wait for background compression to complete"
              - "Then I should see a compression success toast"
              - "When I click the submit button"
              - "Then the upload should start immediately without compression progress"
              - "And the form should submit successfully"

          - name: "User submits before background compression completes"
            description: "User submits quickly, compression still in progress"
            steps:
              - "Given I am on the add wishlist item page"
              - "When I select a very large image for upload"
              - "And I immediately fill in the title with 'Fast Submit'"
              - "And I immediately click the submit button"
              - "Then I should see 'Compressing image' in the progress text"
              - "And I should wait for compression to complete"
              - "Then the upload should start"
              - "And the form should submit successfully"

          - name: "Image change during background compression"
            description: "User changes image while compression running"
            steps:
              - "Given I am on the add wishlist item page"
              - "When I select a large image for upload"
              - "Then background compression should start"
              - "When I select a different large image for upload"
              - "Then the previous compression should be cancelled"
              - "And new background compression should start"
              - "When I wait for background compression to complete"
              - "Then I should see a compression success toast for the second image"

          - name: "Rapid image change (< 100ms between selections)"
            description: "AC14: Verify no state corruption on rapid changes"
            steps:
              - "Given I am on the add wishlist item page"
              - "When I rapidly select 5 images within 500ms"
              - "Then only the last image compression should complete"
              - "And I should see exactly 1 compression success toast"
              - "And the image preview should show the last selected image"

          - name: "Background compression failure fallback"
            description: "Compression fails, falls back to original upload"
            steps:
              - "Given I am on the add wishlist item page"
              - "And compression is mocked to fail"
              - "When I select a large image for upload"
              - "Then I should see a compression failure toast"
              - "When I fill in the title and submit"
              - "Then the original image should be uploaded"
              - "And the form should submit successfully"

          - name: "Skip compression bypasses background compression"
            description: "AC10: Checkbox disables background compression"
            steps:
              - "Given I am on the add wishlist item page"
              - "When I check the skip compression checkbox"
              - "And I select a large image for upload"
              - "Then background compression should NOT start"
              - "And the image should upload immediately"

          - name: "Form remains interactive during background compression"
            description: "AC3: Form fields enabled while compression runs"
            steps:
              - "Given I am on the add wishlist item page"
              - "When I select a large image for upload"
              - "Then background compression should start"
              - "And the title input should be enabled"
              - "And the store select should be enabled"
              - "And the submit button should be enabled"
              - "And I should be able to type in the title field"

      - path: "apps/web/playwright/steps/wishlist-background-compression.steps.ts"
        purpose: "Step definitions for background compression E2E tests"
        key_steps:
          - "When background compression should start"
          - "When I wait for background compression to complete"
          - "When I rapidly select N images within Xms"
          - "Then only the last image compression should complete"
          - "Then the upload should start immediately without compression progress"
          - "Then the previous compression should be cancelled"

    acceptance_criteria:
      - "All E2E scenarios pass (AC12)"
      - "Happy path validated: compression completes before submit"
      - "Slow compression validated: user submits before complete"
      - "Image change validated: cancellation works"
      - "AC14 validated: rapid image change test"
      - "Compression failure fallback validated"
      - "skipCompression checkbox validated (AC10)"
      - "Form interactivity validated (AC3)"

  # ──────────────────────────────────────────────────────────────────────────
  # Phase 9: Documentation & Cleanup
  # ──────────────────────────────────────────────────────────────────────────
  - phase: 9
    name: "Documentation & Cleanup"
    description: "Update documentation, cleanup, and final verification"

    files_to_modify:
      - path: "apps/web/app-wishlist-gallery/src/utils/imageCompression.ts"
        changes:
          - type: "documentation"
            description: "Update JSDoc comments to mention background compression usage"
            location: "compressImage function"
            code: |
              /**
               * Compress an image file
               *
               * Used by:
               * - useS3Upload (WISH-2022): Synchronous compression during upload
               * - useBackgroundCompression (WISH-2049): Background compression on image selection
               *
               * @param file - The image file to compress
               * @param options - Compression configuration and callbacks
               * @returns Compression result with file and metadata
               */

      - path: "apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts"
        changes:
          - type: "documentation"
            description: "Update JSDoc to document background compression integration"
            location: "File header and UploadOptions interface"

      - path: "apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx"
        changes:
          - type: "documentation"
            description: "Update component header to document background compression"
            location: "File header"
            code: |
              /**
               * WishlistForm Component
               *
               * Reusable form for adding/editing wishlist items.
               * Supports image upload, tag input, and keyboard shortcuts.
               *
               * Story wish-2002: Add Item Flow
               * WISH-2022: Client-side image compression with preference toggle
               * WISH-2046: Client-side image compression quality presets
               * WISH-2049: Background compression for perceived performance
               */

    acceptance_criteria:
      - "All JSDoc comments updated"
      - "File headers reference WISH-2049"
      - "No console.log statements in production code"
      - "No TODO comments without story references"
      - "All linter warnings addressed"

# ============================================================================
# TESTING STRATEGY
# ============================================================================

testing:
  unit_tests:
    coverage_target: ">90%"
    priority_files:
      - "useBackgroundCompression.ts (new hook)"
      - "useS3Upload.ts (modified)"

    key_scenarios:
      - "Background compression lifecycle: idle → compressing → complete"
      - "Background compression lifecycle: idle → compressing → failed"
      - "Cancellation via requestId invalidation"
      - "Stale result detection (AC15)"
      - "Rapid image change handling (AC14)"
      - "Progress callback updates"
      - "useS3Upload with compressedFile parameter"
      - "useS3Upload backward compatibility"

  integration_tests:
    coverage_target: ">85%"
    priority_files:
      - "WishlistForm/index.tsx"

    key_scenarios:
      - "Background compression triggered on image selection"
      - "Form submission with compression complete"
      - "Form submission with compression in progress"
      - "Form submission with compression failed"
      - "skipCompression checkbox behavior"
      - "Image change cancellation"
      - "Toast notifications"

  e2e_tests:
    framework: "Playwright + Cucumber"
    feature_file: "wishlist-background-compression.feature"
    scenarios: 7

    key_validations:
      - "AC1: Compression starts on image selection"
      - "AC2: Web worker usage (non-blocking)"
      - "AC3: Form interactivity during compression"
      - "AC4: Skip compression if complete before submit"
      - "AC5: Show progress if still compressing on submit"
      - "AC6: State tracking: idle | compressing | complete | failed"
      - "AC8: Image change cancellation"
      - "AC9: Compression failure fallback"
      - "AC10: skipCompression checkbox"
      - "AC11: Toast notification on completion"
      - "AC14: Rapid image change (< 100ms)"
      - "AC15: Stale result detection"

# ============================================================================
# DECISION LOG
# ============================================================================

decisions:
  - tier: 1
    category: "Clarification"
    title: "useBackgroundCompression hook location"
    context: "Need to decide where to place new hook file"
    decision: "Place in apps/web/app-wishlist-gallery/src/hooks/"
    rationale: "Consistent with existing useS3Upload, useLocalStorage hooks"
    tags: ["architecture", "auto-accepted", "tier-1"]

  - tier: 1
    category: "Clarification"
    title: "Stale result detection mechanism"
    context: "AC15 requires detecting stale compression results"
    decision: "Use timestamp-based requestId: `${Date.now()}-${Math.random()}`"
    rationale: |
      - browser-image-compression doesn't support AbortController natively
      - requestId allows simple stale result detection
      - Check requestId before all state updates in compression callback
      - Lightweight, no additional dependencies
    tags: ["implementation", "auto-accepted", "tier-1"]

  - tier: 2
    category: "Preference"
    title: "Background compression toast timing"
    context: "When to show 'Image compressed' toast"
    decision: "Show toast immediately when compression completes, even if form not submitted"
    rationale: |
      - Provides immediate feedback to user
      - Confirms compression is working in background
      - Non-intrusive (toast auto-dismisses)
      - Aligns with AC11: "Toast notification shows when background compression completes"
    tags: ["ux", "auto-accepted", "tier-2"]
    note: "Conservative mode would escalate, but AC11 explicitly defines this behavior"

  - tier: 1
    category: "Clarification"
    title: "Image preview update timing"
    context: "AC7 says update preview with compressed image when compression completes"
    decision: "Keep preview as original image, don't update to compressed version"
    rationale: |
      - Compressed image is visually identical to original (quality 0.8)
      - Updating preview would cause unnecessary re-render
      - Preview is already set from original file
      - Compressed file is used internally for upload only
      - Simpler implementation, better perceived performance
    tags: ["implementation", "auto-accepted", "tier-1"]
    note: "AC7 may be reconsidered - deferring preview update for simplicity"

# ============================================================================
# RISKS & MITIGATIONS
# ============================================================================

risks:
  - risk: "Rapid image change causes state corruption (AC14)"
    severity: "High"
    mitigation: |
      - Implement requestId-based stale result detection
      - Test with < 100ms rapid selections
      - Verify only last compression result updates state
      - E2E test validates this scenario

  - risk: "browser-image-compression doesn't support AbortController"
    severity: "Medium"
    mitigation: |
      - Use requestId invalidation instead of true abort
      - Compression may complete but result is discarded
      - Web worker cleanup happens automatically
      - No memory leak risk (tested in WISH-2022)

  - risk: "User confusion from toast appearing while typing"
    severity: "Low"
    mitigation: |
      - Toast is non-intrusive, auto-dismisses
      - Clear message: "Image compressed: X MB → Y MB"
      - User can continue typing without interruption
      - Toast position doesn't block form fields

  - risk: "Compression state sync issues on rapid changes"
    severity: "Medium"
    mitigation: |
      - Single source of truth: requestIdRef
      - All state updates check requestId
      - Cancel + reset sequence atomic
      - Integration tests validate sync behavior

# ============================================================================
# FOLLOW-UP ITEMS (Out of Scope)
# ============================================================================

follow_up:
  - title: "Visual compression indicator on image preview"
    description: "Show subtle indicator (e.g., badge) on preview when compression in progress"
    category: "UX Enhancement"
    story_candidate: true
    estimated_points: 1
    dependencies: ["WISH-2049"]

  - title: "Compression caching for repeated selections"
    description: "Cache compressed results by file hash to avoid re-compression"
    category: "Performance Enhancement"
    story_candidate: true
    estimated_points: 2
    dependencies: ["WISH-2049"]

  - title: "Checkbox toggle behavior during active compression"
    description: "Define behavior when user toggles 'High quality' checkbox mid-compression"
    category: "UX Edge Case"
    story_candidate: false
    note: "Marked out-of-scope in WISH-2049.md - defer to PM discussion"

# ============================================================================
# SUCCESS CRITERIA
# ============================================================================

success_criteria:
  - "All 15 ACs passing (AC1-AC15)"
  - "Unit test coverage >90% for new/modified code"
  - "Integration test coverage >85%"
  - "All 7 E2E scenarios passing"
  - "No regression in existing compression tests"
  - "Linter and type-check passing"
  - "Perceived latency reduced by ~62% for 5MB images"
  - "Form remains fully interactive during background compression"
  - "No state corruption on rapid image changes (AC14)"
  - "Stale results successfully detected and discarded (AC15)"
