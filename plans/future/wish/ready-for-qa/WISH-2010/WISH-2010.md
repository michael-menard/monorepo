---
doc_type: story
title: "WISH-2010: Shared Zod schemas and types setup"
story_id: WISH-2010
story_prefix: WISH
status: uat
phase: 2
created_at: "2026-01-28T00:00:00Z"
depends_on: [WISH-2007]
estimated_points: 2
sizing_warning: false
priority: P0
updated_at: "2026-01-30T22:25:00Z"
---

# WISH-2010: Shared Zod schemas and types setup

## Context

The wishlist feature requires consistent type definitions and validation rules across both frontend (React) and backend (Hono/Lambda) layers. Currently, types may be defined separately in each layer, risking drift and inconsistent validation.

This story establishes centralized Zod schema definitions that serve as the single source of truth for:
- Wishlist item data structures
- Filter and query parameter validation
- Reorder operation payloads
- API request/response types

Following the project's Zod-first types requirement (from CLAUDE.md), all types will be derived from Zod schemas using `z.infer<>`.

## Goal

Ensure consistency in type definitions and validation rules across frontend and backend by creating a shared schema package.

## Non-goals

- API endpoint implementation (covered by WISH-2001, WISH-2002, etc.)
- Database schema changes (covered by WISH-2000)
- Runtime validation middleware (implementation detail of endpoints)
- OpenAPI spec generation (future enhancement)

## Scope

### Packages Affected

1. **API Client Schemas**: `packages/core/api-client/src/schemas/`
   - `wishlist.ts` - Wishlist item schemas and types
   - Export via `packages/core/api-client/src/schemas/index.ts`

2. **Backend Domain Types**: `apps/api/lego-api/domains/wishlist/types.ts`
   - Import shared schemas from `@repo/api-client`
   - Add backend-specific schemas if needed (e.g., internal fields)

### Schema Definitions

**WishlistItemSchema**:
```typescript
import { z } from 'zod'

export const WishlistItemSchema = z.object({
  id: z.string().uuid(),
  userId: z.string().uuid(),
  name: z.string().min(1).max(200),
  setNumber: z.string().optional(),
  store: z.string().max(100).optional(),
  price: z.number().min(0).optional(),
  pieceCount: z.number().int().min(0).optional(),
  priority: z.enum(['low', 'medium', 'high']).default('medium'),
  notes: z.string().max(1000).optional(),
  imageUrl: z.string().url().optional(),
  sortOrder: z.number().int().min(0),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
})

export type WishlistItem = z.infer<typeof WishlistItemSchema>
```

**CreateWishlistItemSchema**:
```typescript
export const CreateWishlistItemSchema = WishlistItemSchema.omit({
  id: true,
  userId: true,
  sortOrder: true,
  createdAt: true,
  updatedAt: true,
})

export type CreateWishlistItemInput = z.infer<typeof CreateWishlistItemSchema>
```

**UpdateWishlistItemSchema**:
```typescript
export const UpdateWishlistItemSchema = CreateWishlistItemSchema.partial()

export type UpdateWishlistItemInput = z.infer<typeof UpdateWishlistItemSchema>
```

**WishlistFilterSchema**:
```typescript
export const WishlistFilterSchema = z.object({
  store: z.string().optional(),
  priority: z.enum(['low', 'medium', 'high']).optional(),
  minPrice: z.number().min(0).optional(),
  maxPrice: z.number().min(0).optional(),
  search: z.string().max(100).optional(),
  sortBy: z.enum(['createdAt', 'price', 'pieceCount', 'priority', 'sortOrder']).default('sortOrder'),
  sortOrder: z.enum(['asc', 'desc']).default('asc'),
  page: z.number().int().min(1).default(1),
  limit: z.number().int().min(1).max(100).default(20),
})

export type WishlistFilter = z.infer<typeof WishlistFilterSchema>
```

**ReorderItemsSchema**:
```typescript
export const ReorderItemsSchema = z.object({
  items: z.array(z.object({
    id: z.string().uuid(),
    sortOrder: z.number().int().min(0),
  })).min(1),
})

export type ReorderItemsInput = z.infer<typeof ReorderItemsSchema>
```

**PurchaseItemSchema**:
```typescript
export const PurchaseItemSchema = z.object({
  purchaseDate: z.string().datetime().optional(),
  purchasePrice: z.number().min(0).optional(),
  purchaseStore: z.string().max(100).optional(),
  notes: z.string().max(500).optional(),
})

export type PurchaseItemInput = z.infer<typeof PurchaseItemSchema>
```

## Acceptance Criteria

### Schema Definitions

**AC1**: Create WishlistItemSchema in `packages/core/api-client/src/schemas/wishlist.ts`
- All fields from database schema represented
- Appropriate Zod validators (min, max, uuid, datetime, etc.)
- Export both schema and inferred type

**AC2**: Create CreateWishlistItemSchema
- Omit server-generated fields (id, userId, sortOrder, timestamps)
- Reuse base schema with `.omit()`
- Export both schema and inferred type

**AC3**: Create UpdateWishlistItemSchema
- All fields optional using `.partial()`
- Reuse CreateWishlistItemSchema
- Export both schema and inferred type

**AC4**: Create WishlistFilterSchema for list endpoint query params
- Support store, priority, price range filters
- Support search string
- Support sorting (sortBy, sortOrder)
- Support pagination (page, limit with defaults)
- Sensible defaults for all optional fields

**AC5**: Create ReorderItemsSchema for reorder endpoint
- Array of {id, sortOrder} pairs
- Minimum 1 item required
- UUID validation for IDs
- Non-negative integer for sortOrder

**AC6**: Create PurchaseItemSchema for "Got It" flow
- Optional purchase date, price, store, notes
- Used by WISH-2004 transition endpoint

### Integration

**AC7**: Export all schemas from `packages/core/api-client/src/schemas/index.ts`
- Named exports for each schema
- Named exports for each inferred type
- No default exports

**AC8**: Backend imports schemas from `@repo/api-client`
- `apps/api/lego-api/domains/wishlist/types.ts` imports shared schemas
- No duplicate schema definitions in backend
- Type re-exports for backend convenience

**AC9**: Frontend imports types from `@repo/api-client`
- Form components use inferred types
- RTK Query uses response types
- Validation uses schemas directly

### Validation

**AC10**: Schema validation tests in `packages/core/api-client/src/schemas/__tests__/wishlist.test.ts`
- Test valid inputs pass validation
- Test invalid inputs fail with expected errors
- Test edge cases (empty strings, boundary values, etc.)
- Minimum 15 test cases

**AC11**: Field constraint tests
- name: 1-200 characters
- notes: max 1000 characters
- price: non-negative
- pieceCount: non-negative integer
- priority: enum values only
- limit: 1-100

**AC12**: Default value tests
- priority defaults to 'medium'
- sortBy defaults to 'sortOrder'
- sortOrder defaults to 'asc'
- page defaults to 1
- limit defaults to 20

### Documentation

**AC13**: JSDoc comments on all schemas
- Describe purpose of each schema
- Document any non-obvious constraints
- Example: `/** Schema for creating a new wishlist item. Omits server-generated fields. */`

**AC14**: Type exports documented in package README
- List all exported schemas and types
- Usage examples for frontend and backend

## Test Plan

### Unit Tests (packages/core/api-client/src/schemas/__tests__/wishlist.test.ts)

**WishlistItemSchema Tests**:
1. Valid complete item passes
2. Valid item with optional fields omitted passes
3. Invalid UUID rejected
4. Empty name rejected
5. Name over 200 chars rejected
6. Negative price rejected
7. Invalid priority enum rejected
8. Invalid datetime format rejected

**CreateWishlistItemSchema Tests**:
9. Valid create input passes
10. Server fields (id, userId, etc.) not required
11. Invalid field types rejected

**WishlistFilterSchema Tests**:
12. Empty filter uses defaults
13. Valid filter with all fields passes
14. Invalid sortBy enum rejected
15. Page less than 1 rejected
16. Limit over 100 rejected

**ReorderItemsSchema Tests**:
17. Valid reorder array passes
18. Empty array rejected
19. Invalid UUID in array rejected
20. Negative sortOrder rejected

**Minimum**: 20 unit tests

### Integration Tests

**Backend Import Test**:
- Verify backend can import schemas from @repo/api-client
- Verify type inference works correctly

**Frontend Import Test**:
- Verify frontend can import types from @repo/api-client
- Verify form validation with schemas

## Architecture Notes

### Package Structure

```
packages/core/api-client/
  src/
    schemas/
      wishlist.ts          # All wishlist schemas
      index.ts             # Re-exports
      __tests__/
        wishlist.test.ts   # Schema validation tests
    index.ts               # Package exports
```

### Import Patterns

**Backend (Hono)**:
```typescript
// apps/api/lego-api/domains/wishlist/types.ts
import {
  WishlistItemSchema,
  CreateWishlistItemSchema,
  WishlistFilterSchema,
  type WishlistItem,
  type CreateWishlistItemInput,
} from '@repo/api-client/schemas'

// Re-export for domain convenience
export * from '@repo/api-client/schemas/wishlist'
```

**Frontend (React)**:
```typescript
// Form component
import { CreateWishlistItemSchema, type CreateWishlistItemInput } from '@repo/api-client'

const formSchema = CreateWishlistItemSchema
type FormData = CreateWishlistItemInput
```

### No Duplicate Definitions

The key constraint is that schemas are defined ONCE in `@repo/api-client` and imported everywhere. This ensures:
- Single source of truth for validation rules
- Type consistency across frontend/backend
- Changes propagate automatically

## Risks & Mitigations

1. **Circular dependency risk**
   - Risk: Backend package depends on api-client which might depend on backend
   - Mitigation: api-client is a pure schema package with no backend imports
   - Severity: Low

2. **Schema drift with database**
   - Risk: Zod schema diverges from Drizzle schema
   - Mitigation: Reference WISH-2000 Drizzle schema when defining Zod schema
   - Severity: Medium

3. **Build order issues**
   - Risk: Turborepo builds in wrong order
   - Mitigation: Explicit dependency in package.json
   - Severity: Low

## Definition of Done

- [ ] All 14 Acceptance Criteria pass
- [ ] 20+ unit tests pass
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Backend successfully imports schemas
- [ ] No duplicate schema definitions
- [ ] JSDoc comments on all exports
- [ ] Code review approved

## Source

Epic Elaboration - Engineering perspective

**Original Finding**: Shared Zod schemas needed for type consistency across frontend and backend.

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-28 | orchestrator | Created story from index entry | WISH-2010.md |

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Key Finding: Schemas Already Exist

**Discovery**: Schemas already exist in `packages/core/api-client/src/schemas/wishlist.ts` with 54+ tests. This story should pivot from "Create schemas from scratch" to "Schema Alignment and Documentation."

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Schema drift from database | **add_as_ac** | Add acceptance criteria requiring alignment with WISH-2000 Drizzle schema before implementation. Core CRUD will fail if schemas don't match database structure. Critical mismatches: field names (`title` vs `name`), priority type (integer 0-5 vs string enum), store enum validation. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Custom Zod error messages | **follow_up_story** | Create follow-up story for custom Zod error messages for better form UX. |
| 2 | Type-safe API client generation | **out_of_scope** | Platform-wide initiative beyond wishlist scope. |
| 3 | Schema snapshot testing, form helpers, Hono middleware, shared utils, OpenAPI generation, docs site | **out_of_scope** | Keep story focused on core schema alignment. |

### Follow-up Stories Suggested

- [x] Follow-up story for custom Zod error messages → WISH-2110

### Items Marked Out-of-Scope

- **Type-safe API client generation**: Platform-wide initiative beyond MVP.
- **Schema snapshot testing**: Can be added to regression suite later.
- **Hono middleware for validation**: Implementation detail for teams.
- **Shared form helpers**: Team-specific, out of scope.
- **OpenAPI spec generation**: Future enhancement.
- **Docs site for schemas**: JSDoc comments sufficient for MVP.

### Required Actions Before Implementation

1. ✅ **Accept CONDITIONAL PASS verdict** - Story has correct architecture but needs schema alignment
2. **Verify schema field alignment with WISH-2000**:
   - `name` → `title` (database field name)
   - `priority` type: integer 0-5 (not string enum)
   - `store` validation: enum from database definition
   - `notes` constraints: verify max length in database
3. **Add new acceptance criteria**:
   - AC-NEW-1: All WishlistItemSchema fields match WISH-2000 Drizzle schema
   - AC-NEW-2: Priority field validates as integer 0-5
4. **Confirm existing schema exports satisfy all AC7-9 requirements**

### Implementation Pivot

Instead of creating schemas from scratch:
1. Verify existing schemas in `packages/core/api-client/src/schemas/wishlist.ts` match database
2. Update field names/types where needed
3. Ensure all required schemas exported from `index.ts`
4. Backend imports schemas from `@repo/api-client`
5. Add JSDoc and README documentation
