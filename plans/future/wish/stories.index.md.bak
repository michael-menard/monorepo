---
doc_type: stories_index
title: "WISH Stories Index"
status: active
story_prefix: "WISH"
created_at: "2026-01-25T23:20:00Z"
updated_at: "2026-01-29T18:10:00Z"
---

# WISH Stories Index

All stories in this epic use the `WISH-XXX` naming convention (starting at 2000).

## Progress Summary

| Status | Count |
|--------|-------|
| completed | 5 |
| in-progress | 0 |
| review | 0 |
| ready-for-qa | 0 |
| uat | 2 |
| in-qa | 0 |
| backlog | 13 |
| elaboration | 0 |
| ready-to-work | 15 |
| pending | 9 |
| deferred | 2 |
| BLOCKED | 1 |

---

## Ready to Start

Stories with all dependencies satisfied (can be worked in parallel):

| Story | Feature | Blocked By |
|-------|---------|------------|
| WISH-2000 | Database Schema & Types | — |

---

## WISH-2000: Database Schema & Types

**Status:** Ready for Review
**Depends On:** none
**Phase:** 1 - Foundation

**Feature:** Drizzle schema for wishlist_items table with Zod schemas and TypeScript types

**Infrastructure:**
- wishlist_items PostgreSQL table
- Database indexes for userId and sortOrder

**Goal:** Create foundational data structures for wishlist feature

**Risk Notes:** None - schema definition is straightforward

---

## WISH-2007: Run Migration

**Status:** Approved
**Depends On:** WISH-2000
**Phase:** 1 - Foundation

**Feature:** Execute database migration to create wishlist_items table

**Infrastructure:**
- Database migration execution

**Goal:** Deploy wishlist schema to database

**Risk Notes:** Migration must be run after WISH-2000 schema is approved

---

## WISH-2001: Gallery MVP

**Status:** Ready for Review
**Depends On:** WISH-2007
**Phase:** 2 - Vertical Slice - Gallery MVP

**Feature:** Gallery view with filtering, pagination, and card display. Store filter tabs, search, sorting by date/price/piece count/priority. WishlistCard component using GalleryCard from @repo/gallery.

**Endpoints:**
- `GET /api/wishlist`
- `GET /api/wishlist/:id`

**Goal:** Enable users to view and filter their wishlist items in a gallery view

**Risk Notes:** Integration with shared gallery package must maintain consistency. Must implement authorization checks (see WISH-2008).

**Sizing Warning:** Yes

---

## WISH-2002: Add Item Flow

**Status:** Approved
**Depends On:** WISH-2001
**Phase:** 3 - Core Features

**Feature:** Add item page with form, image upload with S3 presigned URLs, form validation with Zod. Manual entry for all wishlist item fields.

**Endpoints:**
- `POST /api/wishlist`

**Infrastructure:**
- S3 presigned URLs for image upload
- Image storage in S3 with user-scoped prefix

**Goal:** Enable users to manually add wishlist items with images

**Risk Notes:** Image upload and S3 integration requires careful error handling. Must implement file type/size validation and virus scanning (see WISH-2013). Must implement authorization checks (see WISH-2008).

---

## WISH-2003: Detail & Edit Pages

**Status:** Done
**Depends On:** WISH-2001
**Phase:** 3 - Core Features

**Feature:** Detail page showing full item information and edit page with pre-populated form. PATCH endpoint for updates.

**Endpoints:**
- `PATCH /api/wishlist/:id`

**Goal:** Enable users to view full item details and edit wishlist items

**Risk Notes:** Must implement authorization checks and ownership verification (see WISH-2008).

---

## WISH-2004: Modals & Transitions

**Status:** completed
**Depends On:** WISH-2001
**Phase:** 3 - Core Features

**Feature:** Delete confirmation modal, 'Got It' modal with purchase details form, toast notifications with undo. Transitions items to Sets collection atomically.

**Endpoints:**
- `DELETE /api/wishlist/:id`
- `POST /api/wishlist/:id/purchased`

**Goal:** Enable users to delete items or transition them to Sets collection with purchase details

**Risk Notes:** Got it flow must be atomic - create Set before deleting Wishlist item to prevent data loss. Must implement ownership verification on purchased endpoint (see WISH-2008). Must add transaction rollback tests (see WISH-2008).

**Sizing Warning:** Yes

**Implementation Notes:** Verification story - existing implementation verified. Added Playwright E2E tests (delete-flow.spec.ts, purchase-flow.spec.ts, modal-accessibility.spec.ts). 35 new E2E tests covering AC26-30 accessibility requirements.

**QA Verdict:** PASS (2026-01-29) - All 32 ACs verified, 142 unit tests pass, architecture compliant, E2E tests created

---

## WISH-2005a: Drag-and-drop reordering with dnd-kit

**Status:** completed
**Depends On:** WISH-2002, WISH-2003, WISH-2004
**Phase:** 4 - UX Polish

**Feature:** Core drag-and-drop functionality with dnd-kit library, persisted reorder via `PATCH /api/wishlist/reorder` endpoint, awareness of pagination boundaries.

**Endpoints:**
- `PATCH /api/wishlist/reorder`

**Complexity:** Large

**Goal:** Implement drag-and-drop priority reordering with persistence

**Risk Notes:** dnd-kit integration requires careful handling of pagination context and state synchronization

---

## WISH-2005b: Optimistic updates and undo flow

**Status:** uat
**Depends On:** WISH-2005a
**Phase:** 4 - UX Polish

**Feature:** Client-side optimistic updates for reorder operations, 5-second undo window, toast notifications for feedback.

**Complexity:** Medium

**Goal:** Provide immediate visual feedback and recovery mechanism for reorder operations

**Risk Notes:** Optimistic state management requires careful handling of out-of-order operations and undo semantics

**Code Review Verdict:** PASS (2026-01-30) - All 6 review workers passed (lint, style, syntax, security, typecheck, build). 24 unit tests passed. Zod schema compliance verified.

**QA Verdict:** PASS (2026-01-31) - All 20 acceptance criteria verified, 24 unit tests pass, 12 E2E tests pass, architecture compliant with CLAUDE.md

**Story File:** `plans/future/wish/UAT/WISH-2005b/WISH-2005b.md`

---

## WISH-2006: Accessibility

**Status:** Deferred
**Depends On:** WISH-2005
**Phase:** 5 - Accessibility (Deferred to Phase 2 after core functionality)

**Feature:** Full keyboard navigation with roving tabindex, keyboard shortcuts (A, G, Delete), screen reader announcements via live regions, modal focus trap and return, WCAG AA color contrast compliance.

**Goal:** Ensure wishlist feature is fully accessible to keyboard and screen reader users

**Risk Notes:** Comprehensive accessibility scope is ambitious; defer to Phase 2 after WISH-2000 through WISH-2005 are complete

**Deferral Rationale:** Focus on core functionality first (Phase 1), then tackle accessibility in dedicated phase with dedicated testing resources

**Sizing Warning:** Yes

---

## WISH-2008: Authorization layer testing and policy documentation

**Status:** completed
**Depends On:** WISH-2001, WISH-2002, WISH-2003, WISH-2004, WISH-2005
**Phase:** 3+ - Security & Testing

**Feature:** Comprehensive authorization checks across all core endpoints (GET, POST, PATCH, DELETE). Policy documentation for ownership verification and role-based access.

**Endpoints:**
- All wishlist endpoints (GET, POST, PATCH, DELETE)

**Priority:** P0

**Goal:** Ensure all endpoints enforce proper authorization checks and document security policies

**Risk Notes:** Critical security gap across all core endpoints. Must implement ownership verification for all operations.

**Source:** Epic Elaboration - Security & QA perspective

**Story File:** `plans/future/wish/UAT/WISH-2008/WISH-2008.md`

**Implementation Notes:** Verification story completed 2026-01-29. Added 42 middleware tests (auth + rate limiting), rate limiting middleware (10 failures/5 min per IP), audit logging for 403/404 events, security policy documentation, and HTTP test file with 24+ scenarios.

**Code Review Verdict:** PASS (2026-01-29) - All 6 review workers passed (lint, style, syntax, security, typecheck, build). 217 tests passed including 42 new WISH-2008 tests.

**QA Verdict:** PASS (2026-01-30) - All 24 acceptance criteria verified with concrete evidence, 217 tests passed (42 new), security policy documented, architecture compliant, rate limiting prevents brute-force attacks.

---

## WISH-2009: Feature flag infrastructure setup for gradual wishlist rollout

**Status:** backlog
**Depends On:** WISH-2007
**Phase:** 2+ - Infrastructure

**Feature:** Feature flag infrastructure for gradual rollout of WISH-2001 through WISH-2005. Canary deployment capability.

**Priority:** P0

**Goal:** Enable safe, gradual rollout of wishlist feature to users

**Risk Notes:** Blocks safe production rollout. Required before any feature goes live.

**Source:** Epic Elaboration - Platform perspective

---

## WISH-2119: Flag scheduling (auto-enable/disable at scheduled times)

**Status:** ready-to-work
**Depends On:** WISH-2009
**Follow-up From:** WISH-2009
**Phase:** 3 - Infrastructure

### Scope

Add scheduled flag updates (auto-enable/disable at predetermined times) to feature flag infrastructure from WISH-2009. Enables automatic feature rollouts and rollbacks without manual intervention.

**Features:**
- Scheduled flag updates (one-time schedules in MVP)
- Cron job (runs every 1 minute) to process pending schedules
- Admin endpoints: create, list, cancel schedules
- Atomic flag updates with cache invalidation

**Endpoints:**
- `POST /api/admin/flags/:flagKey/schedule` - Create scheduled update
- `GET /api/admin/flags/:flagKey/schedule` - List schedules for flag
- `DELETE /api/admin/flags/:flagKey/schedule/:scheduleId` - Cancel schedule

**Packages Affected:**
- `apps/api/lego-api/domains/config/` - Schedule service and repository
- `apps/api/lego-api/jobs/` - Cron job for schedule processing
- `packages/backend/database-schema/` - feature_flag_schedules table
- `packages/core/api-client/src/schemas/` - Schedule schemas

**Infrastructure:**
- Database table: feature_flag_schedules with status tracking (pending, applied, failed, cancelled)
- Cron job: Every 1 minute, processes schedules where scheduled_at <= NOW()
- Row-level locking (FOR UPDATE SKIP LOCKED) prevents concurrent processing

**Use Cases:**
- Holiday promotions (auto-enable Dec 1, auto-disable Jan 1)
- Timed releases (auto-enable at 9am on release day)
- A/B test windows (auto-enable for 2 weeks, then disable)
- Maintenance windows (auto-disable during maintenance)

**Acceptance Criteria:** 13 ACs covering schedule CRUD, cron job processing, error handling, and concurrent processing safety.

**Complexity:** Small-Medium (cron job + database schema + admin endpoints)

**Effort:** Low (1-2 points)

**Priority:** Low (convenience feature for Phase 3+)

### Source

Follow-up from QA Elaboration of WISH-2009 (Items Marked Out-of-Scope)

**Original Finding:** Flag scheduling (auto-enable/disable at scheduled times) - Manual only in MVP. Scheduling would allow flags to auto-enable/disable at specified times (e.g., holiday promotions).

**Impact:** Low
**Effort:** Low

---

## WISH-20260: Automatic Retry Mechanism for Failed Flag Schedules

**Status:** pending
**Depends On:** WISH-2119
**Follow-up From:** WISH-2119
**Phase:** 3 - Infrastructure

### Scope

Add automatic retry mechanism with exponential backoff to flag scheduling infrastructure from WISH-2119. Failed schedules will automatically retry up to 3 times with increasing delays (2, 4, 8 minutes) before requiring manual intervention.

**Features:**
- Exponential backoff retry logic (2^(retry_count + 1) minutes)
- Configurable max retries (default: 3, via environment variable)
- Jitter to prevent thundering herd (0-30 seconds)
- Retry metadata tracking in database (retry_count, next_retry_at, last_error)
- CloudWatch logging for retry attempts and final failures

**Database Schema:**
- Add retry columns to feature_flag_schedules table: retry_count, max_retries, next_retry_at, last_error
- Index on next_retry_at for efficient cron job queries

**Packages Affected:**
- `apps/api/lego-api/jobs/` - Enhanced cron job with retry logic
- `packages/backend/database-schema/` - Migration for retry columns
- `apps/api/lego-api/domains/config/adapters/` - Schedule repository updates

**Benefits:**
- Reduces admin toil for transient failures (database errors, network issues)
- Improves reliability of critical scheduled flag updates (holiday promotions, maintenance windows)
- Prevents delays in flag updates requiring manual intervention

**Acceptance Criteria:** 10 ACs covering database migration, exponential backoff calculation, retry query logic, max retries enforcement, successful retry handling, CloudWatch logging, and comprehensive test coverage.

**Complexity:** Medium (cron job enhancement + database schema + retry logic)

**Effort:** Medium (2-3 points)

**Priority:** P2 (Operational enhancement for Phase 3+)

### Source

Follow-up from QA Elaboration of WISH-2119 (Enhancement Opportunity #4)

**Original Finding:** "Automatic retry for failed schedules - Manual intervention required for failed schedules in MVP"

**Category:** Enhancement Opportunity
**Impact:** Medium (improves reliability and reduces admin toil)
**Effort:** Medium (retry logic + database schema + backoff calculation)

**Story File:** `plans/future/wish/backlog/WISH-20260/WISH-20260.md`

---

## WISH-2120: Test utility helpers (createMockFile, mockS3Upload) for S3 upload testing

**Status:** backlog
**Depends On:** WISH-2011
**Follow-up From:** WISH-2011
**Phase:** 2 - Infrastructure

### Scope

Create reusable test utilities to reduce boilerplate in S3 upload tests. Provides `createMockFile()` for generating test File objects with configurable properties and `mockS3Upload()` for configuring common upload scenarios (success, error, timeout).

**Test Utilities:**
- `createMockFile({ name, type, size, content })` - Generate test File objects
- `mockS3Upload({ scenario, statusCode, delay, progressSteps })` - Configure upload scenarios

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/test/utils/` - New test utilities directory
- `apps/web/app-wishlist-gallery/src/hooks/__tests__/` - Refactor existing tests
- `apps/web/app-wishlist-gallery/src/components/**/__tests__/` - Refactor component tests

**Benefits:**
- Reduce test boilerplate (create mock files in 1 line instead of 3+)
- Improve test readability and maintainability
- Standardize upload test patterns across test files
- Less duplication across test files

**Acceptance Criteria:** 15 ACs covering utility creation, default values, error scenarios, timeout simulation, progress callbacks, utility tests, test refactoring, documentation, TypeScript type safety, and tree-shakability.

**Complexity:** Small (utility functions only)

**Effort:** Low (1 point)

**Priority:** P2 (Test developer experience enhancement)

### Source

Follow-up from QA Elaboration of WISH-2011 (Enhancement Opportunity #3)

**Original Finding:** Test utility helpers (createMockFile, mockS3Upload) as future enhancement after WISH-2011 validation

**Category:** Enhancement Opportunity
**Impact:** Medium (improved test developer experience)
**Effort:** Low

**Story File:** `plans/future/wish/backlog/WISH-2120/WISH-2120.md`

---

## WISH-2121: Playwright E2E MSW Setup for Browser-Mode Testing

**Status:** backlog
**Depends On:** WISH-2011
**Follow-up From:** WISH-2011
**Phase:** 5 - Advanced Testing

### Scope

Enable Playwright E2E tests to use MSW for API and S3 mocking, providing consistent mocking layer across Vitest and Playwright tests. Browser-mode MSW setup reuses handlers and fixtures from WISH-2011 without duplication.

**Packages Affected:**
- `apps/web/playwright/` - Test configuration and MSW setup
- `apps/web/app-wishlist-gallery/public/` - MSW worker script location
- `apps/web/app-wishlist-gallery/src/test/mocks/` - Reuse existing handlers
- `apps/web/app-wishlist-gallery/src/test/fixtures/` - Reuse existing fixtures

**Infrastructure:**
- MSW worker script (`mockServiceWorker.js`) served from public directory
- Browser worker registration in Playwright global setup/teardown
- Service Worker for browser-level request interception

**Benefits:**
- No real backend/S3 dependencies for E2E tests
- Consistent mocking patterns across test environments
- Faster, more reliable CI tests

**Acceptance Criteria:** 13 ACs covering worker script generation, browser worker registration, handler/fixture reuse, error injection, concurrent test isolation, debug logging, CI compatibility, and documentation.

**Complexity:** Medium (browser-mode MSW setup + Playwright integration)

**Effort:** Medium (2-3 points)

**Priority:** P2 (Advanced testing infrastructure for Phase 5)

### Source

Follow-up from QA Elaboration of WISH-2011 (Follow-up Stories Suggested - Finding #2)

**Original Finding:** "Playwright E2E MSW Setup - Browser-mode MSW support explicitly deferred to future"

**Category:** Enhancement Opportunity
**Impact:** Medium (enables E2E testing without external dependencies)
**Effort:** Medium (browser-mode configuration + worker script setup)

**Story File:** `plans/future/wish/backlog/WISH-2121/WISH-2121.md`

---

## WISH-2010: Shared Zod schemas and types setup

**Status:** ready-to-work
**Depends On:** WISH-2007
**Phase:** 2 - Foundation

**Feature:** Centralized schema definitions for wishlist items, filters, reorder operations. Shared between frontend validation and backend API layer. Pivot: Align existing schemas with database, update exports, add documentation.

**Priority:** P0

**Goal:** Ensure consistency in type definitions and validation rules across frontend and backend

**Risk Notes:** Critical for maintaining type safety and validation consistency.

**Source:** Epic Elaboration - Engineering perspective

**Key Discovery:** Schemas already exist in `packages/core/api-client/src/schemas/wishlist.ts` with 54+ tests. Story pivots from creation to alignment with WISH-2000 Drizzle schema.

---

## WISH-2110: Custom Zod error messages for better form UX

**Status:** backlog
**Depends On:** WISH-2010
**Follow-up From:** WISH-2010
**Phase:** 2 - Foundation

### Scope

Replace generic Zod validation error messages with user-friendly, field-specific messages for better form UX. Updates all wishlist schemas from WISH-2010 with custom error messages using Zod's error message options.

**Examples:**
- `"String must contain at least 1 character(s)"` → `"Title is required"`
- `"Invalid enum value"` → `"Priority must be low, medium, or high"`
- `"Number must be greater than or equal to 0"` → `"Price cannot be negative"`

**Packages Affected:**
- `packages/core/api-client/src/schemas/wishlist.ts` - Add custom messages to all schemas
- `packages/core/api-client/src/schemas/__tests__/wishlist.test.ts` - Update tests to assert specific messages

**Acceptance Criteria:** 13 ACs covering custom error messages for all schema fields, validation testing, frontend/backend integration, and documentation updates.

**Complexity:** Small (error message customization only)

**Effort:** Low (1 point)

**Priority:** P2 (UX enhancement for Phase 2+)

### Source

Follow-up from QA Elaboration of WISH-2010 (Enhancement Opportunity #1)

**Original Finding:** Custom Zod error messages for better form UX

**Category:** Enhancement Opportunity
**Impact:** Medium (better UX for form validation)
**Effort:** Low

---

## WISH-2011: Test infrastructure for MSW mocking of S3 and API calls

**Status:** Ready to Work
**Depends On:** WISH-2007
**Phase:** 2 - Infrastructure

**Feature:** Mock Service Worker (MSW) handlers for S3 presigned URL generation, S3 upload responses, API endpoints. Integration test fixtures for upload flows.

**Priority:** P0

**Goal:** Enable reliable integration tests without external S3 dependencies

**Risk Notes:** Needed for reliable, fast integration tests. Must mock both API and S3 interactions accurately.

**Source:** Epic Elaboration - QA perspective

**Story File:** `plans/future/wish/elaboration/WISH-2011/WISH-2011.md`

---

## WISH-2012: Accessibility testing harness setup

**Status:** ready-to-work
**Depends On:** WISH-2001
**Phase:** 2 - Infrastructure

**Feature:** Test infrastructure for accessibility testing: axe-core integration, automated WCAG AA checks, keyboard navigation test utilities, screen reader testing guides.

**Priority:** P0

**Goal:** Enable accessibility testing for WISH-2006 when resumed

**Risk Notes:** Needed for WISH-2006 when resumed. Requires setup before accessibility work can begin.

**Source:** Epic Elaboration - UX perspective

**Elaboration Notes:** CONDITIONAL PASS - Two clarification items added as acceptance criteria (AC16: Evaluate @repo/accessibility package reuse), (AC17: Clarify Playwright integration scope and WISH-2121 dependency). No MVP blockers identified.

**Story File:** `plans/future/wish/ready-to-work/WISH-2012/WISH-2012.md`

---


## WISH-2123: Content Moderation - AI/ML Image Scanning

**Status:** backlog
**Depends On:** WISH-2013
**Follow-up From:** WISH-2013
**Phase:** 4 - Security Enhancements

### Scope

AI/ML-based content moderation to automatically detect and flag inappropriate, offensive, or adult content in uploaded wishlist images. Provides admin tooling for content review, user notification, and policy enforcement.

**Features:**
- AWS Rekognition DetectModerationLabels integration
- Automatic flagging based on confidence thresholds (≥90% auto-flag, <50% auto-approve)
- Admin moderation queue for manual review
- Approve/Reject workflow with audit logging
- Moderation status tracking in database

**Endpoints:**
- `GET /api/admin/moderation/queue` - Get pending moderation items
- `POST /api/admin/moderation/:id/approve` - Approve flagged content
- `POST /api/admin/moderation/:id/reject` - Reject and remove flagged content
- `GET /api/admin/moderation/stats` - Moderation metrics and trends

**Packages Affected:**
- `apps/api/lego-api/domains/wishlist/` - Integrate moderation into upload flow
- `apps/api/lego-api/core/moderation/` - AI/ML moderation service (new)
- `apps/api/lego-api/domains/admin/` - Admin moderation review endpoints (new)
- `apps/web/admin-dashboard/` - Admin moderation review UI (new or extend existing)
- `packages/backend/database-schema/` - Moderation results table, audit log

**Infrastructure:**
- Database table: `moderation_results` with labels, confidence scores, review status
- Database column: `wishlist_items.moderation_status` ('pending-scan', 'clean', 'pending-review', 'approved', 'rejected')
- AWS Rekognition IAM policy for DetectModerationLabels API (~$0.001 per image)

**Acceptance Criteria:** 15 ACs covering AI/ML integration, automatic flagging, admin queue, image preview, approve/reject workflow, database schema, metrics dashboard, adapter pattern, async moderation, authorization, and MSW test coverage.

**Complexity:** Large (AI/ML integration + admin UI + workflow)

**Effort:** High (5-8 points)

**Priority:** P2 (Trust & Safety requirement for production platform)

**Goal:** Implement AI/ML-based content moderation to automatically detect and flag inappropriate content in uploaded wishlist images

**Risks:**
- High false positive rate from AWS Rekognition (mitigate with conservative thresholds ≥90%)
- Moderation costs scale with user growth (~$0.001/image)
- Async moderation creates UX gap for flagged content (mitigate with "Processing" badges)
- Admin review backlog grows faster than capacity (mitigate with queue monitoring and SLA)

### Source

Follow-up from QA Elaboration of WISH-2013 (Follow-up Stories Suggested - Finding #1)

**Original Finding:** "Content Moderation - AI/ML-based scanning for inappropriate/offensive images"

**Category:** Enhancement Opportunity
**Impact:** Medium (Trust & Safety requirement for production platform)
**Effort:** High (AI/ML pipeline integration, moderation workflow, review tooling)

---

## WISH-2013: File upload security hardening

**Status:** ready-to-work
**Depends On:** WISH-2011, WISH-2002
**Follow-up From:** WISH-2011
**Phase:** 3 - Security

**Feature:** Virus scanning integration for uploaded images, strict file type validation (whitelist), file size limits (max 10MB), S3 security: IAM policy, bucket policy, CORS configuration, presigned URL TTL (15 min).

**Priority:** P0

**Goal:** Secure user file uploads and prevent malicious content

**Risk Notes:** Critical security requirement for WISH-2002. Must include virus scanning and file type validation. Benefits from MSW fixtures and handlers established in WISH-2011.

**Source:** Follow-up from QA Elaboration of WISH-2011 (Finding #1)

**Story File:** `plans/future/wish/ready-to-work/WISH-2013/WISH-2013.md`

**Elaboration Notes:** CONDITIONAL PASS - Three MVP-critical gaps addressed via additional acceptance criteria (AC18: server-side file size validation), clarified existing criteria (AC5: async virus scanning via S3 event trigger Lambda), and enhanced existing criteria (AC16: structured CloudWatch logging with specific fields).

---

## WISH-2015: Sort Mode Persistence (localStorage)

**Status:** completed
**Depends On:** WISH-2001
**Follow-up From:** WISH-2001
**Phase:** 4 - UX Polish

### Scope

Automatically persist wishlist sort mode preference to localStorage and restore it when users return, providing personalized sorting experience across sessions.

**Features:**
- Save sort preference to localStorage on user selection
- Restore sort mode on page load if previously set
- Clear localStorage on logout
- Handle invalid values gracefully with Zod validation
- Support incognito mode with fallback

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/hooks/useLocalStorage.ts` (created)
- `apps/web/app-wishlist-gallery/src/hooks/useWishlistSortPersistence.ts` (created)
- `apps/web/app-wishlist-gallery/src/pages/main-page.tsx` (modified)

**Acceptance Criteria:** 14 ACs covering persistence, restoration, error handling, accessibility, and test coverage.

**Complexity:** Small

**Effort:** 2 points

**Priority:** P2 (UX enhancement)

**QA Verdict:** PASS (2026-01-29) - All 11/14 ACs verified. 2 ACs acceptable partial (logout integration, E2E tests). 33 unit tests pass, TypeScript compilation pass, architecture compliant.

**Story File:** `plans/future/wish/UAT/WISH-2015/WISH-2015-new/WISH-2015.md`

---

## WISH-2016: Image Optimization - Automatic Resizing, Compression, and Watermarking

**Status:** ready-to-work
**Depends On:** WISH-2013
**Follow-up From:** WISH-2013
**Phase:** 4 - Performance & UX Polish

### Scope

Automatically optimize uploaded images to reduce storage costs, improve page load performance, and enhance mobile user experience. Provides multiple image sizes (thumbnail, medium, large) for responsive display and applies subtle watermarking for copyright protection.

**Features:**
- Automatic resizing: Generate three sizes (thumbnail 200x200, medium 800x800, large 1600x1600)
- Compression: Apply 85% quality lossy compression (90-95% file size reduction)
- Format conversion: WebP format with JPEG fallback for browser compatibility
- Watermarking: Subtle watermark on large images only (10% opacity, bottom-right corner)
- Async processing: S3 event trigger Lambda with Sharp library

**Packages Affected:**
- `apps/api/lego-api/core/image-processing/` - Image optimization service (new)
- `apps/api/lego-api/functions/image-processor/` - S3 event handler Lambda (new)
- `packages/backend/database-schema/` - Add image_variants column (JSONB)
- `apps/web/app-wishlist-gallery/src/components/WishlistCard/` - Responsive images with srcset
- `apps/web/app-wishlist-gallery/src/pages/` - Optimized image display

**Infrastructure:**
- S3 event trigger on `uploads/wishlist/*`
- Lambda with Sharp library layer (~50MB)
- Database migration: image_variants column
- CloudWatch metrics for cost savings tracking

**Cost Savings:**
- Storage reduction: ~97% (from 10MB to < 1MB total per image)
- Monthly savings: ~$20-50/month for 1000 images (storage + egress)
- Page load improvement: Gallery view from 200MB → 2MB (100x faster on mobile)

**Acceptance Criteria:** 15 ACs covering image resizing, compression, WebP conversion, watermarking, database schema, S3 event trigger, Lambda performance, frontend responsive images, fallback for legacy items, error handling, test coverage, and documentation.

**Complexity:** Medium (Image processing pipeline + Lambda layer + S3 events)

**Effort:** 3-5 points

**Priority:** P2 (Performance & UX enhancement for Phase 4)

### Source

Follow-up from QA Elaboration of WISH-2013 (Follow-up Stories Suggested - Finding #2)

**Original Finding:** "WISH-2016: Image Optimization - Automatic resizing, compression, watermarking (deferred to future story)"

**Category:** Enhancement Opportunity
**Impact:** Medium (Performance optimization, cost reduction, improved UX)
**Effort:** Medium (Image processing pipeline)

---

## WISH-2122: Usage Quotas - Per-User Storage Quotas and Upload Rate Limits

**Status:** backlog
**Depends On:** WISH-2013
**Follow-up From:** WISH-2013
**Phase:** 4 - Resource Management

### Scope

Implement per-user storage quotas and upload rate limits to control S3 costs, prevent abuse, and enable tier-based resource allocation. Provides quota tracking, enforcement in presign endpoint, and user visibility via QuotaUsageWidget.

**Features:**
- Per-user storage quotas (default: 100MB for free tier, configurable by tier)
- Upload rate limits (default: 10 uploads/hour, configurable by tier)
- Real-time quota tracking in database (used_bytes, file_count)
- Quota enforcement on presign requests (reject when quota exceeded or rate limit hit)
- QuotaUsageWidget displaying current usage and remaining quota
- Sliding window rate limiting algorithm (60-minute window)
- Migration script to backfill quotas for existing users

**Endpoints:**
- `GET /api/wishlist/quota` - Get current quota usage
- Enhanced `POST /api/wishlist/images/presign` - Reject when quota/rate limit exceeded (429)

**Database:**
- New table: `user_storage_quotas` (user_id, tier, total_quota_bytes, used_bytes, file_count)
- New table: `upload_rate_limits` (user_id, window_start, upload_count)

**Packages Affected:**
- `apps/api/lego-api/domains/wishlist/` - Quota enforcement in presign endpoint
- `apps/api/lego-api/core/quotas/` - Quota service (new)
- `apps/api/lego-api/core/rate-limit/` - Upload rate limiter (new or extend existing)
- `packages/backend/database-schema/` - New quota tables
- `apps/web/app-wishlist-gallery/src/components/QuotaUsageWidget/` - Quota UI component (new)

**Acceptance Criteria:** 17 ACs covering quota initialization, enforcement, tracking accuracy, rate limiting, UI display, client error handling, tier configuration, concurrent safety, audit logging, migration, and documentation.

**Complexity:** Medium (Database tracking + enforcement logic + rate limiting)

**Effort:** 3-5 points

**Priority:** P2 (Cost control and abuse prevention for Phase 4+)

### Source

Follow-up from QA Elaboration of WISH-2013 (Follow-up Stories Suggested - Finding #3)

**Original Finding:** "User Quota Management: Per-user storage quotas or upload rate limits (deferred to future story)"

**Category:** Enhancement Opportunity
**Impact:** Medium (Cost control and abuse prevention)
**Effort:** Medium (Database tracking + enforcement logic + rate limiting)

---

## WISH-20171: Backend Combined Filter + Sort Queries

**Status:** ready-to-work
**Depends On:** WISH-2014
**Split From:** WISH-2017
**Phase:** 6 - Advanced Features

### Scope

Extend backend GET /api/wishlist endpoint with combined filter + sort query parameters. Implement repository layer with combined WHERE + ORDER BY queries, handle null values, pagination, and error validation. Focus on backend-only implementation with 45 unit tests and 18 integration tests.

### Acceptance Criteria (from parent)

AC1, AC2, AC3, AC4, AC5, AC6, AC15, AC16, AC18 (9 ACs)

---

## WISH-20172: Frontend Filter Panel UI

**Status:** ready-to-work
**Depends On:** WISH-20171
**Split From:** WISH-2017
**Phase:** 6 - Advanced Features

### Scope

Create FilterPanel component with store, priority, and price range controls. Implement URL query parameter state management, RTK Query integration with filter params, active filter badge, and Clear All button. Focus on frontend-only implementation with 20 component tests and 4 Playwright E2E tests.

### Acceptance Criteria (from parent)

AC7, AC8, AC9, AC10, AC11, AC12, AC13, AC14, AC17, AC19, AC20 (11 ACs)

---

## WISH-2018: CDN Integration for Image Performance Optimization

**Status:** ready-to-work
**Depends On:** WISH-2013
**Follow-up From:** WISH-2013
**Phase:** 5 - Performance

### Scope

Integrate Amazon CloudFront as a CDN to serve wishlist images from edge locations worldwide, reducing latency for global users and lowering bandwidth costs. Ensures seamless migration from S3 URLs to CloudFront URLs without breaking existing images.

**Features:**
- CloudFront distribution with S3 origin configuration
- Origin Access Identity (OAI) for secure S3-CloudFront integration
- HTTPS-only access enforcement with automatic HTTP redirect
- 24-hour edge cache TTL with configurable cache behaviors
- CloudFront URL generation utilities (backend)
- API layer returns CloudFront URLs (GET /api/wishlist, GET /api/wishlist/:id)
- Backward compatibility: convert legacy S3 URLs to CloudFront URLs on-the-fly
- Presigned URL uploads still use S3 (CloudFront is read-only CDN)
- Cache invalidation strategy via versioned URLs (append ?v={timestamp})
- CloudFront access logs for performance monitoring and cost analysis

**Endpoints:**
- Enhanced GET /api/wishlist - Returns CloudFront URLs instead of S3 URLs
- Enhanced GET /api/wishlist/:id - Returns CloudFront URL for image

**Packages Affected:**
- `apps/api/lego-api/domains/wishlist/` - Update presign endpoint responses
- `apps/api/lego-api/core/cdn/` - CloudFront URL generation utilities (new)
- `apps/web/app-wishlist-gallery/src/components/` - Transparent (uses imageUrl as-is)
- Infrastructure: CloudFront distribution, OAI, S3 bucket policy updates

**Performance Improvements:**
- US East: 25% faster (80ms → 60ms)
- Europe: 70% faster (400ms → 120ms)
- Asia: 67% faster (600ms → 200ms)
- Cache hit ratio > 80% after warmup

**Cost Savings:**
- 29% cost reduction for US traffic (S3: $1.33/month → CloudFront: $0.95/month)
- Higher savings for international traffic due to lower CloudFront data transfer costs

**Acceptance Criteria:** 15 ACs covering CloudFront distribution creation, HTTPS enforcement, cache behavior, URL generation, API responses, frontend rendering, backward compatibility, upload flow, cache invalidation, access logs, cost monitoring, integration tests, performance benchmarking, and OAI security.

**Complexity:** Medium (CloudFront setup + S3 origin configuration + URL migration)

**Effort:** Medium (3-5 points)

**Priority:** P2 (Performance enhancement for Phase 5)

### Source

Follow-up from QA Elaboration of WISH-2013 (Follow-up Stories Suggested - Finding #4)

**Original Finding:** "WISH-2018: CDN Integration - CloudFront or image CDN for performance"

**Category:** Enhancement Opportunity
**Impact:** Medium (Performance improvement for global users)
**Effort:** Medium (CloudFront distribution + S3 origin configuration)

---

## WISH-2019: Redis infrastructure setup and migration from in-memory cache

**Status:** ready-to-work
**Depends On:** WISH-2009
**Follow-up From:** WISH-2009
**Phase:** 2 - Infrastructure

### Scope

Migrate feature flag caching from in-memory Map to Redis for production-ready distributed caching. Sets up Redis infrastructure (ElastiCache or local Docker) and migrates the cache adapter with minimal code changes.

**Packages Affected:**
- `apps/api/lego-api/domains/config/adapters/` - Cache adapter migration
- `apps/api/lego-api/core/cache/` - Redis client singleton
- `apps/api/lego-api/domains/config/application/feature-flag-service.ts` - Service layer wiring
- `apps/api/lego-api/domains/config/index.ts` - DI container setup
- Infrastructure: AWS ElastiCache (t3.micro) or Docker Compose Redis
- Environment: REDIS_URL configuration

**Infrastructure:**
- Redis 7.x instance with 1 GB memory
- Connection pooling (max 10 connections)
- Fallback to database if Redis unavailable
- 5-minute TTL matching WISH-2009 spec

**Acceptance Criteria:** 16 ACs covering Redis provisioning, adapter migration, service layer wiring, cache key patterns, environment configuration, testing, and documentation

**Risks:**
- Lambda cold start Redis connection failures (mitigated with retry + fallback)
- VPC/security group misconfiguration blocking connectivity
- Increased infrastructure cost ~$15-30/month (acceptable for production scaling)

**Elaboration Notes:** APPROVED - All critical gaps resolved:
- AC 14: Service layer wiring (feature-flag-service.ts + DI container)
- AC 15: Cache key pattern alignment with WISH-2009 (feature_flags:{environment}:{flagKey})
- AC 16: REDIS_URL environment variable paths (apps/api/lego-api/.env.local)
- Path inconsistencies corrected in Scope and Reuse Plan sections

**Story File:** `plans/future/wish/ready-to-work/WISH-2019/WISH-2019.md`

### Source

Follow-up from QA Elaboration of WISH-2009 (Enhancement Opportunity #1)

**Original Finding:** Redis infrastructure setup and migration from in-memory cache - WISH-2009 AC 17 uses in-memory cache for MVP. When production scaling requires it, migrate to Redis for distributed caching. The adapter pattern in AC 17 ensures minimal code changes.

**Impact:** High (production scaling)
**Effort:** Medium (new infrastructure)

---

## WISH-2029: Update architecture documentation for lego-api/domains/ pattern

**Status:** ready-to-work
**Depends On:** WISH-2009
**Follow-up From:** WISH-2009
**Phase:** 2 - Infrastructure

### Scope

Update `docs/architecture/api-layer.md` to document `apps/api/lego-api/domains/` as the canonical location for backend domain modules. All existing domains (gallery, wishlist, health, instructions, sets, parts-lists) use this pattern with hexagonal architecture (ports & adapters), but documentation still references the old `services/{domain}/` pattern.

**Documentation Files Affected:**
- `docs/architecture/api-layer.md` - Main architecture documentation (primary update)
- Verification: Review all 6 existing domains for pattern consistency

**Documentation Content:**
- Directory structure tree (application/, adapters/, routes.ts, types.ts, __tests__/)
- Subdirectory responsibilities (business logic vs infrastructure)
- Hexagonal architecture explanation (ports, adapters, separation of concerns)
- Examples from existing domains (gallery, wishlist, config from WISH-2009)
- "Creating a New Domain" step-by-step guide
- Hono framework usage patterns
- Shared schema patterns (backend owns, frontend imports via @repo/api-client)
- Migration notes for legacy patterns
- Architecture decision rationale

**Acceptance Criteria:** 14 ACs covering documentation updates, examples, verification, and quality checks

**Risks:**
- Documentation drift as code evolves (mitigate with "Last Verified" dates)
- Contradictions with CLAUDE.md guidelines (cross-check during writing)

### Source

Follow-up from QA Elaboration of WISH-2009 (Gap #2 - AC 18 follow-up)

**Original Finding:** Update docs/architecture/api-layer.md to document lego-api/domains/ as canonical pattern

**Category:** Technical Debt / Documentation
**Impact:** Medium (prevents architecture confusion)
**Effort:** Low (documentation only)

---

## WISH-2039: User-level targeting for feature flags

**Status:** BLOCKED
**Depends On:** WISH-2009
**Follow-up From:** WISH-2009
**Phase:** 3 - Infrastructure

### Scope

Add user-level targeting to feature flag infrastructure with explicit inclusion/exclusion lists. Enables beta tester programs, VIP access, support debugging, and exclusion of problematic users.

**Endpoints:**
- `POST /api/admin/flags/:flagKey/users` - Add users to include/exclude list
- `DELETE /api/admin/flags/:flagKey/users/:userId` - Remove user from targeting
- `GET /api/admin/flags/:flagKey/users` - List all user overrides for flag

**Database:**
- New table: `feature_flag_user_overrides` (flag_id, user_id, override_type, reason, created_by)
- Evaluation priority: Exclusion > Inclusion > Percentage-based rollout

**Packages Affected:**
- `apps/api/lego-api/domains/config/` - Update flag evaluation logic
- `packages/backend/database-schema/` - User overrides table schema
- `packages/core/api-client/src/schemas/` - User override schemas

**Acceptance Criteria:** 12 ACs covering database schema, user override endpoints, evaluation logic updates, caching, rate limiting, testing, and documentation updates.

**Complexity:** Medium - Extends WISH-2009 with new table and evaluation logic

**Risks:**
- Large include/exclude lists slow evaluation (mitigate with caching and indexes)
- Cache invalidation lag up to 5 minutes (acceptable for admin operations)
- Security: Admin-only endpoints (reuse WISH-2009 auth middleware)

### Source

Follow-up from QA Elaboration of WISH-2009 (Enhancement Opportunity - Non-goals deferred item)

**Original Finding:** User-level targeting (beyond percentage-based rollout) - MVP is percentage-based only. User-level targeting would allow specific users to be included/excluded from flags.

**Category:** Feature Enhancement
**Impact:** Medium (enables targeted rollout)
**Effort:** Medium (user overrides table)

---

## WISH-2047: IP/Geolocation Logging for Authorization Events

**Status:** deferred
**Deferral Reason:** Not MVP - observability enhancement, defer to post-launch
**Depends On:** WISH-2008
**Follow-up From:** WISH-2008
**Phase:** 5 - Observability

### Scope

Enrich authorization failure audit logs (403/404 events) with IP address and geolocation data (country, region, city) to enable detection of suspicious access patterns, geographic anomalies, and potential security threats.

**Features:**
- IP extraction from request headers (X-Forwarded-For, X-Real-IP, socket)
- MaxMind GeoLite2 geolocation lookup (country, region, city, lat/long)
- Privacy-conscious logging (403/404 only, not 200/201 requests)
- CloudWatch Logs Insights query examples for security analysis
- Shared IP extraction utility (integration with rate limiting from WISH-2008 AC 24)

**Packages Affected:**
- `apps/api/lego-api/core/observability/` - Logger enrichment with IP/geolocation
- `apps/api/lego-api/core/geolocation/` - MaxMind GeoIP2 lookup service (new)
- `apps/api/lego-api/core/utils/` - IP extraction utility (new, shared)
- `apps/api/lego-api/middleware/` - Reuse IP extraction in auth/rate-limit middleware
- `apps/api/lego-api/domains/wishlist/` - Pass IP from context to logger

**Infrastructure:**
- MaxMind GeoLite2 City database (~50 MB) added to Lambda layer
- Environment variable: `GEOIP_DATABASE_PATH=/opt/geolite2-city.mmdb`
- Lambda memory increase: +128 MB for in-memory database caching

**Acceptance Criteria:** 12 ACs covering IP extraction, geolocation lookup, enriched logging, privacy controls, CloudWatch query examples, Lambda layer setup, performance requirements, error handling, rate limiting integration, and documentation updates.

**Complexity:** Small-Medium (IP extraction + geolocation lookup + logging enrichment)

**Effort:** Low-Medium (2 points)

**Priority:** P2 (Observability enhancement for Phase 5)

### Source

Follow-up from QA Elaboration of WISH-2008 (Enhancement Opportunity #9)

**Original Finding:** IP/geolocation logging for suspicious access patterns - Log IP address and country for 403/404 events to detect suspicious access patterns

**Category:** Enhancement Opportunity
**Impact:** Medium (Security observability improvement)
**Effort:** Medium (IP extraction + geolocation lookup + log enrichment)

---

## WISH-2022: Client-side Image Compression

**Status:** ready-to-work
**Depends On:** WISH-2002
**Follow-up From:** WISH-2002
**Phase:** 4 - UX Polish

### Scope

Automatically compress images on the client side before uploading to S3, reducing upload time and storage costs while maintaining acceptable visual quality. Uses browser-image-compression library.

**Features:**
- Auto-compress images before S3 upload using browser-image-compression library
- Compression settings: max width 1920px, max height 1920px, quality 0.8, max size 1MB
- Progress indicator: "Compressing image... X%"
- Toast notification: "Image compressed: X MB → Y MB"
- "High quality (skip compression)" checkbox
- Skip compression if image already small (< 500KB)
- Graceful fallback on compression failure

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts`
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts` (new)
- `apps/web/app-wishlist-gallery/src/components/WishlistForm/`

**Acceptance Criteria:** 10 ACs covering auto-compression, settings, progress indicator, filename preservation, skip logic, graceful fallback, checkbox toggle, timing, toast notification, and preview update.

**Complexity:** Medium (library integration + hook modification + UI updates)

**Effort:** 3 points

**Priority:** P2 (UX enhancement for Phase 4)

**Story File:** `plans/future/wish/elaboration/WISH-2022/WISH-2022.md`

### Source

Follow-up from QA Elaboration of WISH-2002 (Enhancement Opportunity)

**Original Finding:** Client-side image compression - compress images before S3 upload to reduce upload time and storage costs

**Category:** Enhancement Opportunity
**Impact:** High (significantly reduces upload time and S3 storage costs)
**Effort:** Medium (library integration + upload flow modification)

---


## WISH-2023: Add Compression Failure Telemetry

**Status:** backlog
**Depends On:** WISH-2022
**Follow-up From:** WISH-2022
**Phase:** 4 - UX Polish

### Scope

Track compression failures via CloudWatch metrics and structured logs to identify patterns by format, size, browser, and error type. Enables data-driven improvements to compression logic and fallback behavior from WISH-2022.

**Features:**
- Compression failure logging with structured metadata (format, size, browser, error type)
- Backend telemetry endpoint `POST /api/observability/compression-failures`
- CloudWatch Metrics namespace: `Wishlist/ImageCompression`
- Metrics: `CompressionFailureCount`, `CompressionFailureRate`
- Dimensions: `Format`, `SizeBucket`, `Browser`, `ErrorType`
- CloudWatch Logs structured JSON format
- Fire-and-forget telemetry (non-blocking, 2-second timeout)

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/utils/compressionTelemetry.ts` (new) - Frontend telemetry helpers
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts` - Add error logging
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts` - Instrument failures
- `apps/api/lego-api/domains/observability/routes.ts` - Telemetry endpoint
- `apps/api/lego-api/core/observability/metrics.ts` - CloudWatch metrics publisher

**Acceptance Criteria:** 12 ACs covering error logging, telemetry endpoint, CloudWatch Metrics/Logs, size bucketing, browser detection, error classification, privacy compliance, and documentation.

**Complexity:** Small-Medium (telemetry endpoint + CloudWatch integration)

**Effort:** 2 points

**Priority:** P2 (Observability enhancement for Phase 4)

### Source

Follow-up from QA Elaboration of WISH-2022 (Gaps Identified - Finding #3)

**Original Finding:** Compression failure telemetry - Track compression failures (format, size, browser, error) via CloudWatch/analytics to identify patterns and improve fallback logic

**Category:** Gap
**Impact:** Medium (Observability improvement for compression failures)
**Effort:** Low (CloudWatch metrics + error logging)

**Story File:** `plans/future/wish/backlog/WISH-2023/WISH-2023.md`

---
## WISH-2046: Client-side Image Compression Quality Presets

**Status:** pending
**Depends On:** WISH-2022
**Follow-up From:** WISH-2022
**Phase:** 4 - UX Polish

### Scope

Add user-selectable compression quality presets to the client-side image compression feature from WISH-2022. Enables users to choose between "Low bandwidth" (0.6 quality, 1200px), "Balanced" (0.8 quality, 1920px - default), and "High quality" (0.9 quality, 2400px) presets based on their needs.

**Features:**
- Three compression quality presets: Low bandwidth, Balanced (default), High quality
- Preset selector UI in upload form (radio buttons or dropdown)
- Estimated file size display for each preset
- localStorage persistence of selected preset
- Toast notification showing which preset was used
- "Skip compression" checkbox overrides preset selection

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts` - Preset definitions
- `apps/web/app-wishlist-gallery/src/components/WishlistForm/` - Preset selector UI
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts` - Pass preset to compression

**Acceptance Criteria:** 14 ACs covering preset definitions, UI selector, localStorage persistence, compression settings application, toast notifications, and test coverage

**Complexity:** Small (extends WISH-2022 compression logic)

**Effort:** 2 points

**Priority:** P2 (UX enhancement for Phase 4)

### Source

Follow-up from QA Elaboration of WISH-2022 (Gaps Identified - Finding #2)

**Original Finding:** Compression quality presets - Add user-selectable presets for different use cases (mobile data plans, quality prioritization, slow connections)

**Category:** Gap
**Impact:** Medium (enables user control over quality/size trade-offs)
**Effort:** Low (extends existing compression logic)

---

## WISH-2027: Enum Modification Procedure for Wishlist Stores and Currencies

**Status:** ready-to-work
**Depends On:** WISH-2007
**Follow-up From:** WISH-2007
**Phase:** 1 - Foundation

**Feature:** Document and validate safe procedure for evolving PostgreSQL ENUMs in wishlist schema. Provides runbooks for adding/deprecating stores and currencies with rollback strategies.

**Packages Affected:**
- `packages/backend/database-schema/docs/` - Enum evolution documentation

**Goal:** Prevent production issues from enum modification mistakes and enable safe schema evolution

**Risk Notes:** PostgreSQL ENUMs are immutable. ALTER TYPE ... ADD VALUE cannot be rolled back, requires careful staging and documentation.

**Source:** Follow-up from QA Elaboration of WISH-2007 (Finding #2)

**Story File:** `plans/future/wish/ready-to-work/WISH-2027/WISH-2027.md`

**Elaboration Notes:** PASS - Story is well-structured documentation task with 15 acceptance criteria. All audit checks pass, no MVP blockers identified, scope boundaries clear.

---

## WISH-2057: Schema Evolution Policy and Versioning Strategy

**Status:** ready-to-work
**Depends On:** WISH-2007
**Follow-up From:** WISH-2007
**Phase:** 1 - Foundation

**Feature:** Document comprehensive schema evolution policies, versioning strategy, and procedures for safe database schema modifications across all environments. Establish governance for schema changes and provide runbooks for common scenarios.

**Packages Affected:**
- `packages/backend/database-schema/docs/` - 4 new documentation files (SCHEMA-EVOLUTION-POLICY.md, ENUM-MODIFICATION-RUNBOOK.md, SCHEMA-VERSIONING.md, SCHEMA-CHANGE-SCENARIOS.md)

**Goal:** Document comprehensive schema evolution policies and procedures before any future schema modifications occur to prevent production issues and ensure safe schema evolution.

**Risk Notes:** PostgreSQL enums are immutable and present unique challenges. Without documented strategy, developers may introduce breaking changes or require emergency rollbacks.

**Source:** QA Discovery Notes from WISH-2007 Elaboration (Enhancement Opportunity #6)

**Story File:** `plans/future/wish/ready-to-work/WISH-2057/WISH-2057.md`

**Elaboration Notes:** CONDITIONAL PASS (2026-01-29) - Story is well-structured with clear scope and 20 acceptance criteria. All audit checks pass. One minor issue identified: existing `packages/backend/database-schema/docs/WISHLIST-SCHEMA-EVOLUTION.md` (155 lines) already addresses some schema evolution concerns. Implementation should clarify relationship (replace, extend, or coexist).

**Sizing:** 20 Acceptance Criteria covering policy documentation, enum modification runbooks, versioning strategy, common scenarios, and governance

---

## WISH-20180: CI Job to Validate Schema Changes Against Policy

**Status:** pending
**Depends On:** WISH-2057
**Follow-up From:** WISH-2057
**Phase:** 2 - Infrastructure

### Scope

Implement automated CI validation of database schema changes against schema evolution policies from WISH-2057. Provide developers with immediate feedback on policy violations during PR submission, reducing manual review burden and preventing policy violations from reaching production.

**Features:**
- GitHub Actions workflow triggered on schema changes
- Validation script for migration naming, breaking changes, and policy compliance
- PR comment with validation results
- CI pass/fail based on violation severity
- Breaking change detection (column/table drops, enum removals, type changes)
- Non-breaking change validation (optional columns, enum additions, indexes)
- Migration journal validation

**Packages Affected:**
- `.github/workflows/` - New CI workflow for schema validation
- `packages/backend/database-schema/scripts/` - Validation script implementation
- `packages/backend/database-schema/docs/` - CI validation documentation

**Acceptance Criteria:** 20 ACs covering CI workflow setup, migration file validation, breaking change detection, non-breaking change validation, and governance documentation

**Complexity:** Medium (CI workflow + SQL parsing + validation logic)

**Effort:** 3 points

**Priority:** P1 (Automated governance for Phase 2)

**Story File:** `plans/future/wish/backlog/WISH-20180/WISH-20180.md`

### Source

Follow-up from QA Elaboration of WISH-2057 (Follow-up Stories Suggested - Finding #1)

**Original Finding:** "CI job to validate schema changes against policy (automated governance)"

**Category:** Enhancement Opportunity
**Impact:** High (prevents policy violations from reaching production)
**Effort:** Medium (CI workflow + validation script)

---

## WISH-20190: Schema Drift Detection Tool (db:check command)

**Status:** pending
**Depends On:** WISH-2057
**Follow-up From:** WISH-2057
**Phase:** 1 - Foundation

### Scope

Implement a `db:check` command that compares the current database schema against the expected schema from Drizzle migrations, detecting drift and reporting mismatches for manual review and remediation. Provides proactive detection of schema inconsistencies across development, staging, and production environments.

**Features:**
- CLI command `pnpm db:check` with environment flag support
- Schema introspection using Drizzle introspection API
- Drift detection categories: missing/extra tables, column mismatches, type differences, constraint differences, enum value differences, index differences
- Human-readable and JSON output modes for CI integration
- Exit code 0 for no drift, exit code 1 for drift detected
- Remediation suggestions in output

**Packages Affected:**
- `packages/backend/database-schema/scripts/check-schema-drift.ts` - Main drift detection script (new)
- `packages/backend/database-schema/src/drift-detector/` - Drift detection utilities (new)
- `packages/backend/database-schema/docs/SCHEMA-DRIFT-DETECTION.md` - Usage documentation (new)
- `packages/backend/database-schema/package.json` - Add `db:check` script

**Acceptance Criteria:** 20 ACs covering core functionality, output formatting, enum/constraint detection, error handling, edge cases, documentation, and testing

**Complexity:** Medium (CLI script + Drizzle introspection + schema comparison)

**Effort:** 3 points

**Priority:** P1 (Critical operational tool for Phase 1)

**Story File:** `plans/future/wish/backlog/WISH-20190/WISH-20190.md`

### Source

Follow-up from QA Elaboration of WISH-2057 (Follow-up Stories Suggested - Finding #2)

**Original Finding:** "Schema drift detection tool (`db:check` command from WISH-2007 Enhancement #3)"

**Category:** Enhancement Opportunity
**Impact:** High (proactive detection of schema inconsistencies)
**Effort:** Medium (CLI script + introspection + comparison logic)

---

## WISH-20200: Automated Rollback Script Generation

**Status:** pending
**Depends On:** WISH-2057
**Follow-up From:** WISH-2057
**Phase:** 2 - Infrastructure

### Scope

Automate the generation of rollback scripts from migration metadata to reduce manual error risks, improve incident response time, and ensure consistent rollback procedures across all environments. Extends the `schema_versions` metadata table from WISH-2057 with rollback script storage and provides CLI commands for preview and execution.

**Features:**
- PostgreSQL AST parser to analyze migration SQL and generate inverse operations
- Rollback script generation for supported operations (ADD COLUMN → DROP COLUMN, CREATE INDEX → DROP INDEX, etc.)
- Storage of generated scripts in `schema_versions.rollback_script` column
- CLI commands: `pnpm db:rollback --version=X.Y.Z` (preview), `pnpm db:rollback --version=X.Y.Z --execute` (execute)
- Safety validations: rollback_safe boolean, confirmation prompts, error handling
- Warnings for unsafe migrations (DROP COLUMN, enum modifications, etc.)

**Packages Affected:**
- `packages/backend/database-schema/src/rollback/` - Rollback generator (new)
- `packages/backend/database-schema/src/cli/` - Rollback CLI command (new)
- `packages/backend/database-schema/src/migrations/` - Schema updates for rollback metadata

**Infrastructure:**
- Database schema: Add `rollback_script` (TEXT) and `rollback_applied_at` (TIMESTAMP) columns to `schema_versions` table
- npm dependency: `pgsql-parser` for PostgreSQL SQL parsing

**Acceptance Criteria:** 20 ACs covering rollback script generation, CLI commands, database schema updates, integration with migration flow, safety validations, and comprehensive test coverage

**Complexity:** Medium (AST parsing + CLI tooling + database schema updates)

**Effort:** 3 points

**Priority:** P2 (Infrastructure enhancement for Phase 2)

**Story File:** `plans/future/wish/backlog/WISH-20200/WISH-20200.md`

### Source

Follow-up from QA Elaboration of WISH-2057 (Follow-up Stories Suggested - Finding #3)

**Original Finding:** "Automated rollback script generation based on migration metadata"

**Category:** Enhancement Opportunity
**Impact:** High (reduces manual error risks, improves incident response time)
**Effort:** Medium (AST parser integration + CLI + database schema)

---

## WISH-2032: Optimistic UI for Form Submission

**Status:** ready-to-work
**Depends On:** WISH-2002
**Follow-up From:** WISH-2002
**Phase:** 4 - UX Polish

### Scope

Implement optimistic UI for wishlist item creation to provide immediate feedback and navigation, with graceful rollback on failure. Shows success toast and navigates to detail page immediately, with rollback if API call fails.

**Features:**
- Immediate success toast on form submit
- Navigate to detail page before API response
- Temporary item in RTK Query cache with optimistic ID
- Detail page loading skeleton for temporary items
- Replace temporary item with real item on API success
- Graceful rollback on API failure with error toast and retry button
- Form state preservation on rollback

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/pages/AddItemPage.tsx`
- `apps/web/app-wishlist-gallery/src/components/WishlistForm.tsx`
- `packages/core/api-client/src/rtk/wishlist-api.ts`

**Acceptance Criteria:** 10 ACs covering optimistic cache updates, immediate navigation, loading states, error rollback, retry functionality, and form state preservation.

**Complexity:** Medium (RTK Query optimistic updates + navigation state management)

**Effort:** 3 points

**Priority:** P2 (UX enhancement for Phase 4)

**Story File:** `plans/future/wish/backlog/WISH-2032/WISH-2032.md`

### Source

Follow-up from QA Elaboration of WISH-2002 (Enhancement Opportunity)

**Original Finding:** Optimistic UI for form submission - show success toast and navigate immediately, with rollback if API call fails. Aligns with WISH-2005 patterns.

**Category:** Enhancement Opportunity
**Impact:** High (significantly improves perceived performance and user experience)
**Effort:** Medium (requires careful state management and error recovery)

---

## WISH-2045: HEIC/HEIF Image Format Support

**Status:** backlog
**Depends On:** WISH-2022
**Follow-up From:** WISH-2022
**Phase:** 4 - UX Polish

### Scope

Enable HEIC/HEIF image uploads with automatic conversion to JPEG during the compression workflow. Modern iPhones (iOS 11+) default to HEIC format, which is not supported by browser-image-compression library from WISH-2022.

**Features:**
- HEIC/HEIF file detection by MIME type and file extension
- Automatic HEIC to JPEG conversion using `heic2any` library
- Conversion progress indicator: "Converting HEIC to JPEG... X%"
- Seamless integration with existing compression workflow from WISH-2022
- Fallback to original HEIC upload on conversion failure
- Browser compatibility detection and graceful degradation

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts` - Add HEIC detection and conversion
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts` - Update upload flow

**Infrastructure:**
- New dependency: `heic2any` npm package (MIT license, 500KB)

**Acceptance Criteria:** 16 ACs covering HEIC detection, conversion workflow, error handling, browser compatibility, progress indicators, filename preservation, test coverage, and documentation.

**Complexity:** Medium (library integration + conversion workflow + error handling)

**Effort:** 3 points

**Priority:** P1 (Blocks iPhone users from compression benefits in WISH-2022)

### Source

Follow-up from QA Elaboration of WISH-2022 (Gap #1)

**Original Finding:** Modern iPhones use HEIC by default; browser-image-compression needs plugin or server fallback for HEIC conversion

**Category:** Gap
**Impact:** High (Modern iPhone users cannot use compression workflow)
**Effort:** Medium (requires additional library integration)

**Story File:** `plans/future/wish/backlog/WISH-2045/WISH-2045.md`

---

## WISH-2049: Background Compression for Perceived Performance

**Status:** backlog
**Depends On:** WISH-2022
**Follow-up From:** WISH-2022
**Phase:** 4 - UX Polish

### Scope

Start compressing images immediately when selected (before form is filled), so compression runs in background while user fills form. By the time user submits, compression is already complete, eliminating compression wait time from the critical path.

**Features:**
- Compression starts on image selection (onChange event)
- Background compression using web worker (non-blocking)
- Form remains interactive during compression
- Preview updates when compression completes
- Skip compression step during upload if already complete
- Toast notification when background compression completes
- Cancellation logic for image changes

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts`
- `apps/web/app-wishlist-gallery/src/components/WishlistForm/`
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts`

**Acceptance Criteria:** 13 ACs covering background compression trigger, web worker integration, compression state management, image change handling, preview updates, toast notifications, and E2E test coverage.

**Complexity:** Small-Medium (Refactor compression timing + state management)

**Effort:** 2 points

**Priority:** P2 (UX enhancement for Phase 4)

**Story File:** `plans/future/wish/backlog/WISH-2049/WISH-2049.md`

### Source

Follow-up from QA Elaboration of WISH-2022 (Enhancement Opportunity #2)

**Original Finding:** Background compression - Start compressing image as soon as selected (before form is filled). By the time user submits, compression is already complete. Reduces perceived latency.

**Category:** Enhancement Opportunity
**Impact:** Medium (62% reduction in perceived latency for typical 5MB images)
**Effort:** Low (Minor refactoring of compression timing from WISH-2022)

---

## WISH-2050: Compression Preview Comparison

**Status:** backlog
**Depends On:** WISH-2022
**Follow-up From:** WISH-2022
**Phase:** 5 - UX Polish

### Scope

Provide a visual comparison of original vs. compressed images to help users understand quality trade-offs and build trust in the compression feature. Implements side-by-side or slider comparison UI after compression completes.

**Features:**
- Slider comparison UI showing original (left) vs. compressed (right) images
- File size and dimensions labels for both versions
- Keyboard-accessible slider with arrow key control
- Toggle on/off with "Show comparison" checkbox (localStorage preference)
- Responsive layout: vertical stack on mobile (< 768px)
- Tooltips explaining quality trade-offs

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/components/ImageComparisonPreview/` (new)
- `apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx`
- `apps/web/app-wishlist-gallery/src/pages/AddItemPage.tsx`

**Acceptance Criteria:** 12 ACs covering comparison UI rendering, slider interaction, file size/dimension labels, keyboard accessibility, localStorage preference persistence, responsive layout, and test coverage.

**Complexity:** Medium (Comparison UI + responsive design + preference persistence)

**Effort:** 3 points

**Priority:** P2 (Trust-building UX enhancement for Phase 5)

**Story File:** `plans/future/wish/backlog/WISH-2050/WISH-2050.md`

### Source

Follow-up from QA Elaboration of WISH-2022 (Enhancement Opportunities - Finding #3)

**Original Finding:** Compression preview comparison - Side-by-side or slider comparison of original vs compressed image. Helps users understand quality trade-offs and builds trust in compression feature.

**Category:** Enhancement Opportunity
**Impact:** Medium (improves user understanding and trust in compression)
**Effort:** Medium (dual image preview and comparison UI)

**Note:** Marked out-of-scope during WISH-2022 elaboration due to UI complexity, but documented as follow-up for future consideration.

---

## WISH-2048: WebP Format Conversion

**Status:** pending
**Depends On:** WISH-2022
**Follow-up From:** WISH-2022
**Phase:** 4 - UX Polish

### Scope

Convert compressed images to WebP format instead of JPEG to achieve 25-35% additional size savings while maintaining acceptable visual quality. Simple configuration change to browser-image-compression library from WISH-2022.

**Features:**
- Change output format from JPEG to WebP in compression settings
- Maintain existing compression quality (0.8) and dimensions (1920px)
- 25-35% smaller file sizes compared to JPEG at equivalent visual quality
- Browser compatibility check with fallback to JPEG for Safari < 14
- WebP support: Chrome 32+, Firefox 65+, Safari 14+, Edge 18+ (97%+ coverage)

**Packages Affected:**
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts` - Update fileType to 'image/webp'

**Benefits:**
- Additional storage cost savings (25-35% beyond WISH-2022's compression)
- Faster page loads with smaller image files
- Better compression efficiency than JPEG
- Already supported by browser-image-compression library

**Acceptance Criteria:** 14 ACs covering WebP conversion, quality settings, file size comparison, toast notifications, filename handling, browser compatibility, fallback logic, and test coverage.

**Complexity:** Small (configuration change only)

**Effort:** Low (2 points)

**Priority:** P2 (Performance enhancement for Phase 4)

**Story File:** `plans/future/wish/backlog/WISH-2048/WISH-2048.md`

### Source

Follow-up from QA Elaboration of WISH-2022 (Enhancement Opportunity #1)

**Original Finding:** WebP format conversion - Convert to WebP instead of JPEG for 25-35% additional size savings; supported by browser-image-compression library

**Category:** Enhancement Opportunity
**Impact:** Medium (additional storage and bandwidth savings)
**Effort:** Low (simple configuration change)

---

## WISH-20210: Schema Change Impact Analysis Tool

**Status:** pending
**Depends On:** WISH-2057
**Follow-up From:** WISH-2057
**Phase:** 3 - Infrastructure

### Scope

Build an automated CLI tool (`pnpm db:impact-analysis`) that analyzes proposed database schema changes and generates comprehensive impact reports identifying all affected services, endpoints, frontend components, and test files across the monorepo.

**Features:**
- CLI tool accepting `--table`, `--enum`, and `--change` flags
- AST-based code analysis using TypeScript Compiler API (ts-morph)
- Analyzes column changes (add, remove, rename, type change)
- Analyzes enum changes (add value, remove value, rename value)
- Generates Markdown impact reports with categorized findings
- Risk assessment (Breaking/Non-breaking, Rollback Safety)
- Actionable recommendations for each affected file

**Analysis Categories:**
- Backend Services (application layer, repositories, routes)
- Zod Schemas (shared validation logic)
- Frontend Components (React components, pages)
- API Hooks (RTK Query definitions)
- Test Files (unit tests, integration tests)

**Packages Affected:**
- `packages/backend/database-schema/scripts/` - New `impact-analysis.ts` CLI tool
- `packages/backend/database-schema/src/` - Drizzle schema introspection utilities

**Infrastructure:**
- Reports stored in `packages/backend/database-schema/impact-reports/`
- Exit code 0 for low-impact changes, code 1 for high-impact (CI integration)

**Benefits:**
- Prevents missed dependencies during schema migrations
- Provides confidence before applying schema changes
- Complements WISH-2057 policies with automated verification
- Reduces manual code review burden

**Acceptance Criteria:** 22 ACs covering CLI tool basics, column/enum analysis, impact report quality, test coverage, and documentation.

**Complexity:** Medium (CLI tool + AST analysis + report generation)

**Effort:** 5 points

**Priority:** P2 (Developer productivity enhancement for Phase 3)

### Source

Follow-up from QA Elaboration of WISH-2057 (Follow-up Stories Suggested - Finding #4)

**Original Finding:** "Schema change impact analysis tool (which services/endpoints affected?)"

**Category:** Enhancement Opportunity
**Impact:** High (prevents missed dependencies and runtime failures)
**Effort:** Medium (CLI tool development + AST parsing)

**Story File:** `plans/future/wish/backlog/WISH-20210/WISH-20210.md`


## WISH-20220: Schedule UI/UX (admin dashboard for schedule management)

**Status:** backlog
**Depends On:** WISH-2119
**Follow-up From:** WISH-2119
**Phase:** 3 - Infrastructure

### Scope

Provide admins with a visual, user-friendly dashboard for creating, viewing, and canceling scheduled flag updates. Implements calendar view, timeline visualization, schedule creation forms, and real-time status updates with polling.

**Features:**
- Schedule management dashboard page at `/admin/feature-flags/:flagKey/schedules`
- Calendar view showing all schedules with color-coded markers (pending, applied, failed, cancelled)
- Timeline view with chronological schedule list and countdown timers
- CreateScheduleForm modal with date/time picker and validation
- Schedule cards with cancel functionality for pending schedules
- Auto-refresh polling (60-second interval) for real-time status updates

**Pages Affected:**
- `/admin/feature-flags/:flagKey/schedules` - Schedule management dashboard (new)
- `/admin/feature-flags/:flagKey` - Add "Schedules" tab to flag detail page
- `/admin/feature-flags` - Add "Manage Schedules" button to flag list

**Packages Affected:**
- `apps/web/admin-dashboard/src/pages/ScheduleManagementPage.tsx` - Main dashboard page (new)
- `apps/web/admin-dashboard/src/components/ScheduleCalendar/` - Calendar view component (new)
- `apps/web/admin-dashboard/src/components/ScheduleTimeline/` - Timeline visualization (new)
- `apps/web/admin-dashboard/src/components/CreateScheduleForm/` - Schedule form (new)
- `apps/web/admin-dashboard/src/components/ScheduleCard/` - Schedule card (new)
- `packages/core/api-client/src/rtk/feature-flags-api.ts` - RTK Query endpoints (extend)

**Acceptance Criteria:** 20 ACs covering dashboard navigation, calendar/timeline views, schedule creation, cancel functionality, auto-refresh, authorization, and accessibility.

**Complexity:** Medium (UI components + calendar/timeline + forms + RTK Query integration)

**Effort:** 3 points

**Priority:** P2 (Admin UX enhancement for Phase 3)

### Source

Follow-up from QA Elaboration of WISH-2119 (Enhancement Opportunity #6)

**Original Finding:** "Admin dashboard for schedule management - Deferred to Phase 3+ follow-up story"

**Category:** Enhancement Opportunity
**Impact:** Medium (improves admin experience for managing scheduled flag updates)
**Effort:** Medium (admin UI components + calendar/timeline views + integration with backend endpoints)

**Story File:** `plans/future/wish/backlog/WISH-20220/WISH-20220.md`

---
---

## WISH-20240: Schedule preview endpoint (simulate flag state before schedule applies)

**Status:** pending
**Depends On:** WISH-2119
**Follow-up From:** WISH-2119
**Phase:** 4 - Infrastructure Enhancements

### Scope

Enable admins to preview the exact flag state that will result from a scheduled update before it executes. Read-only endpoint simulates applying pending schedules in chronological order and returns the resulting flag state without modifying flags or schedules.

**Features:**
- GET /api/admin/flags/:flagKey/schedule/preview endpoint (admin only)
- Fetches current flag state and all pending schedules
- Simulates applying schedules in chronological order
- Returns currentState, previewedState, pendingSchedules array, stateChanged boolean
- Handles partial updates (enabled or rolloutPercentage only)
- Read-only operation (no side effects)

**Packages Affected:**
- `apps/api/lego-api/domains/config/` - Add previewSchedules method to schedule service
- `packages/core/api-client/src/schemas/` - Preview response schema

**Use Cases:**
- Verify complex scheduling scenarios before execution
- Identify conflicting schedules that may produce unexpected flag states
- Build admin confidence when scheduling critical flag changes
- Debug scheduling issues without affecting live flags

**Acceptance Criteria:** 12 ACs covering preview endpoint, simulation logic, schema alignment, and testing

**Complexity:** Small (read-only simulation logic)

**Effort:** 2 points

**Priority:** P2 (Admin tooling enhancement for Phase 4)

### Source

Follow-up from QA Elaboration of WISH-2119 (Enhancement Opportunity #2)

**Original Finding:** "Schedule preview endpoint (simulate flag state before schedule applies)"

**Category:** Enhancement Opportunity
**Impact:** Medium (improves admin confidence and reduces configuration errors)
**Effort:** Low (2 points - read-only simulation logic)

**Story File:** `plans/future/wish/backlog/WISH-20240/WISH-20240.md`

---

## WISH-20250: Bulk schedule creation (multiple schedules in single API call)

**Status:** pending
**Depends On:** WISH-2119
**Follow-up From:** WISH-2119
**Phase:** 4 - Infrastructure

### Scope

Enable admins to create multiple flag schedules in a single atomic API call, reducing operational overhead and ensuring consistency for coordinated rollout scenarios.

**Features:**
- Bulk schedule creation endpoint accepting array of schedules
- Atomic transaction processing (all-or-nothing)
- Duplicate time detection within batch
- Maximum batch size: 50 schedules per request
- Batch INSERT for database efficiency

**Endpoints:**
- `POST /api/admin/flags/:flagKey/schedule/bulk` - Create multiple schedules atomically

**Packages Affected:**
- `apps/api/lego-api/domains/config/` - Extend schedule service with bulk creation
- `packages/core/api-client/src/schemas/` - Bulk schedule schemas

**Use Cases:**
- Phased rollouts: Create 5 schedules to gradually increase rollout percentage (0% → 25% → 50% → 75% → 100%)
- Multi-flag coordination: Enable multiple related flags simultaneously
- Time-windowed features: Create enable/disable schedule pairs for temporary features
- Multi-environment rollouts: Schedule same flag changes across dev/staging/production

**Acceptance Criteria:** 10 ACs covering bulk endpoint validation, atomic batch creation, duplicate detection, authorization, schema alignment, and comprehensive test coverage.

**Complexity:** Small (Extension of existing schedule creation endpoint)

**Effort:** 2 points

**Priority:** P2 (Operational efficiency enhancement for Phase 4)

### Source

Follow-up from QA Elaboration of WISH-2119 (Enhancement Opportunity #3)

**Original Finding:** "Bulk schedule creation (multiple schedules in single API call)"

**Category:** Enhancement Opportunity
**Impact:** Medium (Operational efficiency for admins managing complex rollout schedules)
**Effort:** Low (Extension of existing schedule creation endpoint)

**Story File:** `plans/future/wish/backlog/WISH-20250/WISH-20250.md`

---

## WISH-20280: Audit Logging for Flag Schedule Operations

**Status:** backlog
**Depends On:** WISH-2119, WISH-2019
**Follow-up From:** WISH-2119
**Phase:** 3 - Infrastructure

### Scope

Add comprehensive audit logging to flag schedule operations (create, cancel) to provide security observability and admin accountability. Integrates WISH-2119 schedule operations into WISH-2019 audit logging infrastructure, tracking which admin performed each action with timestamps and context.

**Features:**
- Audit logging for schedule creation (created_by field)
- Audit logging for schedule cancellation (cancelled_by, cancelled_at fields)
- Audit logging for automatic schedule application (cron job events)
- CloudWatch structured logging with admin context
- Database schema updates for admin tracking

**Database Schema:**
- Add created_by, cancelled_by, cancelled_at columns to feature_flag_schedules table
- Audit event types: flag_schedule.created, flag_schedule.cancelled, flag_schedule.applied, flag_schedule.failed

**Packages Affected:**
- `apps/api/lego-api/domains/config/` - Schedule service and routes updates
- `apps/api/lego-api/core/audit/` - Audit logging integration
- `packages/backend/database-schema/` - Migration for admin tracking columns
- `packages/core/api-client/src/schemas/` - Schema updates for admin fields

**Acceptance Criteria:** 15 ACs covering database schema updates, audit logging integration, service layer updates, API response updates, schema alignment, testing, and documentation.

**Complexity:** Small (extends existing audit patterns from WISH-2019)

**Effort:** 2 points

**Priority:** P1 (Security and compliance requirement for Phase 3)

### Source

Follow-up from QA Elaboration of WISH-2119 (Follow-up Stories Suggested - Finding #7)

**Original Finding:** "Integration with WISH-2019 (audit logging: track which admin created/cancelled schedules)"

**Category:** Enhancement Opportunity
**Impact:** Medium (security observability and admin accountability)
**Effort:** Low (extends existing audit infrastructure)

**Story File:** `plans/future/wish/backlog/WISH-20280/WISH-20280.md`

---

## WISH-20270: Schedule cleanup cron job (retention policy enforcement)

**Status:** backlog
**Depends On:** WISH-2119
**Follow-up From:** WISH-2119
**Phase:** 3 - Infrastructure

### Scope

Implement automated retention policy enforcement for feature flag schedules through a nightly cron job, preventing unbounded table growth while preserving failed schedules for manual review. Enforces WISH-2119's retention policies automatically.

**Features:**
- Nightly cron job (2:00 AM UTC) to delete expired schedules
- Delete applied schedules older than 90 days
- Delete cancelled schedules older than 30 days
- Preserve failed schedules indefinitely for manual review
- CloudWatch metrics for deleted count and execution time
- Structured logging with deletion counts and error handling

**Packages Affected:**
- `apps/api/lego-api/jobs/cleanup-flag-schedules.ts` - Cron job handler (new)
- `apps/api/lego-api/domains/config/adapters/schedule-repository.ts` - deleteExpiredSchedules() method

**Infrastructure:**
- Lambda function triggered by EventBridge (daily cron)
- CloudWatch Metrics: SchedulesDeletedCount, CleanupExecutionTime
- CloudWatch Logs: Deletion audit trail

**Acceptance Criteria:** 13 ACs covering repository deletion logic, cron job implementation, monitoring, testing, and documentation

**Complexity:** Small (cron job + repository method)

**Effort:** 1 point

**Priority:** P2 (Operational housekeeping for Phase 3)

### Source

Follow-up from QA Elaboration of WISH-2119 (Follow-up Stories Suggested - Finding #6)

**Original Finding:** "Schedule cleanup cron job (retention policy enforcement, automatic purging of old schedules)"

**Category:** Enhancement Opportunity
**Impact:** Low (operational housekeeping, prevents unbounded table growth)
**Effort:** Low (1 point - simple cron job reusing existing patterns)

**Story File:** `plans/future/wish/backlog/WISH-20270/WISH-20270.md`

---
