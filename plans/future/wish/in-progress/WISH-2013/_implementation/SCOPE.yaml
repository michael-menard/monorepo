schema: 1
story_id: WISH-2013
timestamp: '2026-02-08T00:00:00Z'

touches:
  backend: true
  frontend: true
  packages: true
  db: false
  contracts: true
  ui: true
  infra: true

touched_paths_globs:
  - apps/api/lego/**
  - apps/web/app/**
  - apps/web/playwright/features/api/wishlist/**
  - apps/web/playwright/steps/api/**

risk_flags:
  auth: true
  payments: false
  migrations: false
  external_apis: true
  security: true
  performance: false

summary: File Upload Security Hardening - server-side/client-side validation, virus scanning, presigned URL restrictions, and security audit logging with comprehensive E2E test coverage

scope_details:
  backend_changes:
    - File validation utilities (MIME type, size)
    - Virus scanner port and ClamAV adapter
    - Presigned URL TTL enforcement (15 minutes)
    - Security audit logging
    - Enhanced error handling and validation responses

  frontend_changes:
    - Client-side file validation in useS3Upload hook
    - Error display improvements in WishlistForm
    - User feedback for validation failures

  infra_changes:
    - S3 bucket policies (documented, not deployed)
    - IAM policies (documented, not deployed)
    - CORS configuration (documented, not deployed)
    - ClamAV Lambda layer setup (documented, not deployed)

  test_coverage:
    - 30+ E2E test scenarios
    - File type validation: 9 scenarios
    - File size validation: 4 scenarios
    - Presigned URL behavior: 5 scenarios
    - Authorization checks: 2 scenarios
    - Edge cases: 5+ scenarios

dependencies:
  - WISH-2011 (MSW infrastructure for test mocking)
  - WISH-2002 (prior upload work)
