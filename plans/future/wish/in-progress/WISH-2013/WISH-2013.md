---
status: in-progress
e2e_required: true
follow_up_from: WISH-2011
created: 2026-01-28
updated_at: 2026-01-31
story_id: WISH-2013
title: File Upload Security Hardening
epic: Wishlist Feature
phase: 3 - Security
priority: P0
depends_on: [WISH-2011, WISH-2002]
complexity: Medium
effort: 2-3 points
---

# WISH-2013: File Upload Security Hardening

## Follow-up Context

**Parent Story:** WISH-2011 (Test infrastructure for MSW mocking of S3 and API calls)

**Source:** QA Discovery Notes - Follow-up Stories Suggested

**Original Finding:** "WISH-2013: File Upload Security - Will benefit from MSW fixtures and handlers established in WISH-2011"

**Category:** Enhancement Opportunity

**Impact:** High (Critical security requirement)

**Effort:** Medium (Virus scanning + file validation + S3 security hardening)

---

## Context

The wishlist feature's Add Item Flow (WISH-2002) includes image upload functionality using S3 presigned URLs. While the basic upload flow is functional, it lacks critical security controls to prevent malicious file uploads, oversized files, and unauthorized access to uploaded content.

This story implements comprehensive security hardening for file uploads:

1. **File Type Validation:** Whitelist-based MIME type validation to prevent executable files and scripts
2. **File Size Limits:** Enforce maximum 10MB file size on both client and server
3. **Virus Scanning:** Integration with virus scanning service to detect malware
4. **S3 Security:** Proper IAM policies, bucket policies, CORS configuration
5. **Presigned URL Security:** Short TTL (15 minutes), HTTPS-only, restricted actions

### Background

**Current State (WISH-2002):**
- Basic presigned URL generation for S3 uploads
- Client-side file type checking (can be bypassed)
- No virus scanning
- No server-side file size validation
- Generic S3 bucket configuration

**Security Risks Without This Story:**
- Users could upload malicious files (viruses, trojans, scripts)
- Large file uploads could consume excessive S3 storage and bandwidth costs
- Insufficient S3 bucket policies could allow unauthorized access
- Long-lived presigned URLs increase exposure window

**MSW Infrastructure Benefits (from WISH-2011):**
- Test fixtures for upload flows already established
- MSW handlers for presign and S3 PUT requests available
- Integration test patterns proven and reusable
- Can mock virus scanning responses for comprehensive security testing

---

## Goal

Secure user file uploads to prevent malicious content, enforce size limits, and protect stored files from unauthorized access. Ensure all security validations are testable using MSW infrastructure from WISH-2011.

---

## Non-goals

- **Content Moderation:** Scanning for inappropriate/offensive images is out of scope (defer to future moderation story)
- **Image Processing:** Automatic resizing, compression, or watermarking is out of scope
- **CDN Integration:** CloudFront or image CDN setup is out of scope
- **Advanced Threat Detection:** AI/ML-based threat analysis is out of scope
- **User Quota Management:** Per-user storage quotas or upload limits is out of scope

---

## Scope

### Packages Affected

- `apps/api/lego-api/domains/wishlist/` - Presign endpoint security enhancements
- `apps/api/lego-api/core/security/` - Virus scanning service (new)
- `apps/api/lego-api/core/storage/` - S3 security configuration
- `apps/web/app-wishlist-gallery/src/hooks/` - Client-side file validation
- `apps/web/app-wishlist-gallery/src/test/` - Security test fixtures (extends WISH-2011)
- Infrastructure: S3 bucket policy, IAM policy, virus scanning integration

### Files to Create

1. **Virus Scanning Service:**
   - `apps/api/lego-api/core/security/virus-scanner.ts` - Virus scanning adapter
   - `apps/api/lego-api/core/security/__tests__/virus-scanner.test.ts` - Unit tests

2. **File Validation Utilities:**
   - `apps/api/lego-api/core/utils/file-validation.ts` - MIME type whitelist, size validation
   - `apps/api/lego-api/core/utils/__tests__/file-validation.test.ts` - Validation tests

3. **Test Fixtures (extends WISH-2011):**
   - `apps/web/app-wishlist-gallery/src/test/fixtures/security-mocks.ts` - Virus scan responses
   - `apps/web/app-wishlist-gallery/src/test/fixtures/malicious-files.ts` - Test files for validation

4. **Infrastructure:**
   - S3 bucket policy updates (JSON configuration)
   - IAM policy for Lambda S3 access (JSON configuration)
   - CORS configuration for S3 bucket

### Files to Modify

1. **API Layer:**
   - `apps/api/lego-api/domains/wishlist/application/wishlist-service.ts` - Add virus scanning to presign flow
   - `apps/api/lego-api/domains/wishlist/routes.ts` - Add file validation middleware

2. **Client Layer:**
   - `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts` - Add client-side file validation
   - `apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx` - Display validation errors

3. **Test Infrastructure:**
   - `apps/web/app-wishlist-gallery/src/test/mocks/handlers.ts` - Add virus scanning mock handlers

---

## Acceptance Criteria

### AC1: File Type Whitelist Validation (Server-Side)
**Given** a user requests a presigned URL for file upload
**When** the presign endpoint receives the request with MIME type
**Then** the endpoint validates the MIME type against whitelist (image/jpeg, image/png, image/webp)
**And** rejects requests with non-whitelisted types (application/x-executable, text/html, etc.)
**And** returns 400 Bad Request with error message "Unsupported file type"

### AC2: File Type Validation (Client-Side)
**Given** a user selects a file for upload in WishlistForm
**When** the file input onChange event fires
**Then** the client validates MIME type against the same whitelist
**And** displays inline error message for invalid types before upload begins
**And** prevents presign request for invalid files

### AC3: File Size Limit Validation (Server-Side)
**Given** a user requests a presigned URL with file size parameter
**When** the presign endpoint receives the request
**Then** the endpoint validates file size does not exceed 10MB (10,485,760 bytes)
**And** rejects oversized files with 400 Bad Request
**And** returns error message "File size exceeds maximum limit of 10MB"

### AC4: File Size Limit Validation (Client-Side)
**Given** a user selects a file for upload
**When** the file size exceeds 10MB
**Then** the client displays inline error message
**And** prevents presign request before upload begins

### AC5: Virus Scanning Integration (Post-Upload)
**Given** a file has been successfully uploaded to S3
**When** the upload completes and backend registers the file
**Then** the virus scanning service scans the file asynchronously
**And** quarantines or deletes files with detected malware
**And** logs virus detection events with file metadata

### AC6: Presigned URL TTL Restriction
**Given** a presigned URL is generated
**When** the endpoint creates the S3 presigned URL
**Then** the URL expires after 15 minutes (900 seconds)
**And** includes HTTPS-only enforcement
**And** restricts to PUT operation only

### AC7: S3 Bucket Policy Enforces HTTPS
**Given** S3 bucket policy is configured
**When** any request attempts HTTP access
**Then** the bucket policy denies the request
**And** only HTTPS requests are allowed

### AC8: S3 Bucket Policy Restricts Public Access
**Given** S3 bucket policy is configured
**When** any unauthenticated request attempts to access objects
**Then** the bucket policy denies public read/write access
**And** only authenticated IAM roles can access objects

### AC9: IAM Policy Grants Minimal S3 Permissions
**Given** Lambda IAM role for wishlist service
**When** the Lambda attempts S3 operations
**Then** the IAM policy grants only PutObject and GetObject permissions
**And** restricts access to specific S3 prefix (e.g., `uploads/wishlist/*`)
**And** denies DeleteObject and ListBucket permissions

### AC10: CORS Configuration Allows Frontend Origins
**Given** S3 bucket CORS configuration
**When** the frontend makes a PUT request from allowed origin
**Then** CORS headers allow the request
**And** only whitelisted origins are permitted (dev, staging, prod domains)
**And** allowed methods are PUT only

### AC11: Virus Scanning Test Coverage (MSW Mocks)
**Given** MSW handlers from WISH-2011 are extended
**When** integration tests run for upload security
**Then** MSW mocks virus scanning responses (clean, infected, scan failure)
**And** tests verify quarantine behavior for infected files
**And** tests verify error handling for scan failures

### AC12: Malicious File Upload Test
**Given** test fixtures include malicious file samples
**When** integration test attempts to upload executable or script file
**Then** presign request is rejected with 400 Bad Request
**And** no presigned URL is generated
**And** audit log records rejected file type

### AC13: Oversized File Upload Test
**Given** test fixtures include 11MB file
**When** integration test attempts to upload oversized file
**Then** presign request is rejected with 400 Bad Request
**And** client-side validation prevents request
**And** error message displays file size limit

### AC14: Expired Presigned URL Test
**Given** a presigned URL is generated with 15-minute TTL
**When** a test simulates upload after expiration
**Then** S3 returns 403 Forbidden
**And** client displays appropriate error message
**And** user is prompted to retry upload

### AC15: Concurrent Upload Security Test
**Given** two users upload files concurrently
**When** both uploads complete successfully
**Then** each file is scanned independently
**And** one user's infected file does not affect the other user's upload
**And** no cross-contamination occurs

### AC16: Security Audit Logging
**Given** file upload security events occur
**When** validation failures, virus detections, or policy denials happen
**Then** security events are logged to CloudWatch with structured metadata
**And** logs include userId, fileName, rejectionReason, timestamp, IP address
**And** logs are queryable for security analysis

### AC17: Documentation Updates
**Given** new security infrastructure is implemented
**When** developers need to understand upload security
**Then** documentation includes:
  - File type whitelist with rationale
  - File size limits and S3 cost justification
  - Virus scanning integration architecture
  - S3 security policy explanations
  - Testing guide for security scenarios

---

## Test Plan

*Comprehensive test coverage building on MSW infrastructure from WISH-2011.*

### Happy Path Tests:

1. **Valid Image Upload (JPEG):**
   - Client validates MIME type (image/jpeg) and size (< 10MB)
   - Presign request succeeds with 15-minute TTL URL
   - S3 upload succeeds
   - Virus scan returns clean result
   - File is accessible in wishlist

2. **Valid Image Upload (PNG):**
   - Client validates MIME type (image/png) and size (< 10MB)
   - Upload flow completes successfully
   - Virus scan returns clean

3. **Valid Image Upload (WebP):**
   - Client validates MIME type (image/webp) and size (< 10MB)
   - Upload flow completes successfully
   - Virus scan returns clean

### Error Cases:

1. **Invalid File Type (Executable):**
   - Client rejects `.exe` file before upload
   - If client-side bypassed, server rejects presign request
   - Audit log records rejection

2. **Invalid File Type (HTML):**
   - Client rejects `.html` file
   - Server rejects if client-side bypassed

3. **Oversized File (11MB):**
   - Client displays error before upload
   - Server rejects presign request if client-side bypassed

4. **Virus Detected:**
   - File uploads successfully (presign + S3 PUT)
   - Virus scanner detects malware
   - File is quarantined or deleted
   - User is notified of security issue

5. **Virus Scan Service Failure:**
   - File uploads successfully
   - Virus scanner service is unavailable
   - File is quarantined pending manual review
   - Alert is triggered for operations team

6. **Expired Presigned URL:**
   - User delays upload beyond 15 minutes
   - S3 returns 403 Forbidden
   - Client prompts user to retry upload

7. **HTTP Upload Attempt (S3 Bucket Policy):**
   - Simulated HTTP request to S3
   - Bucket policy denies request
   - HTTPS-only enforcement verified

### Edge Cases:

1. **0-Byte File:**
   - Client validates file size > 0
   - Server rejects 0-byte files

2. **Exact 10MB File (Boundary):**
   - Client allows 10,485,760 bytes
   - Server allows exact limit
   - Upload succeeds

3. **10MB + 1 Byte File:**
   - Client rejects 10,485,761 bytes
   - Server rejects if client-side bypassed

4. **Concurrent Uploads (Same User):**
   - User uploads two images simultaneously
   - Both presign requests succeed
   - Both virus scans complete independently
   - No race conditions or state collisions

5. **Concurrent Uploads (Different Users):**
   - Two users upload files at the same time
   - Each user's file is isolated (user-scoped S3 prefix)
   - No cross-user access or contamination

### Required Evidence:

- 20+ unit tests for file validation utilities
- 15+ integration tests using MSW mocks from WISH-2011
- Virus scanning mock handlers validate all scenarios (clean, infected, failure)
- S3 bucket policy validated in AWS console or IaC tests
- IAM policy validated for least-privilege compliance
- Security audit logs verified in CloudWatch Logs

---

## Reuse Plan

### Reuse from WISH-2011 (Test Infrastructure)

1. **MSW Handlers:**
   - Extend existing presign handler to include validation responses
   - Extend S3 PUT handler to simulate virus scanning triggers
   - Add new virus scanning API mock handlers

2. **Test Fixtures:**
   - Reuse sample files from WISH-2011 (JPEG, PNG, WebP)
   - Add malicious file samples (executable, HTML, oversized)
   - Add virus scan response fixtures (clean, infected, error)

3. **Integration Test Patterns:**
   - Follow existing upload test structure from `useS3Upload.test.ts`
   - Reuse MSW server lifecycle and configuration
   - Extend component tests (WishlistForm, AddItemPage)

### Reuse from WISH-2002 (Add Item Flow)

1. **Presign Endpoint:**
   - Add validation middleware to existing presign route
   - Integrate virus scanning into existing upload flow
   - No API contract changes (additional validation only)

2. **Client Upload Hook:**
   - Extend `useS3Upload` with client-side validation
   - Add validation error states
   - Maintain existing upload progress tracking

### Reusable Components for Future Stories

1. **File Validation Utilities:**
   - `file-validation.ts` can be reused for other upload features (MOC instructions, gallery)
   - MIME type whitelist is extensible for future file types

2. **Virus Scanning Service:**
   - Adapter pattern allows swapping virus scanning providers (ClamAV, AWS GuardDuty, third-party)
   - Reusable for any file upload feature in the platform

3. **Security Test Fixtures:**
   - Malicious file samples reusable across all upload test suites
   - Virus scan mock handlers reusable for MOC instructions uploads

---

## Architecture Notes

### Hexagonal Architecture (Ports & Adapters)

**Ports (Interfaces):**

1. **Virus Scanner Port:**
   ```typescript
   export interface VirusScanner {
     scanFile(s3Key: string): Promise<ScanResult>
   }

   export type ScanResult =
     | { status: 'clean' }
     | { status: 'infected'; threats: string[] }
     | { status: 'error'; reason: string }
   ```

2. **File Validator Port:**
   ```typescript
   export interface FileValidator {
     validateMimeType(mimeType: string): ValidationResult
     validateFileSize(sizeBytes: number): ValidationResult
   }

   export type ValidationResult =
     | { valid: true }
     | { valid: false; error: string }
   ```

**Adapters (Implementations):**

1. **ClamAV Virus Scanner Adapter:**
   - Integrates with ClamAV service (or AWS-compatible alternative)
   - Implements `VirusScanner` port
   - Handles connection pooling, retries, timeouts

2. **Whitelist File Validator Adapter:**
   - Implements `FileValidator` port
   - Configurable MIME type whitelist
   - Configurable file size limits

3. **S3 Security Adapter:**
   - Generates presigned URLs with security constraints (TTL, HTTPS-only, PUT-only)
   - Enforces IAM policy restrictions
   - Validates bucket policy compliance

### Security Validation Flow

```
1. Client selects file
   ↓
2. Client validates MIME type and size
   ↓ (if valid)
3. Client requests presign URL (POST /api/wishlist/images/presign)
   ↓
4. Server validates MIME type and size (AC1, AC3)
   ↓ (if valid)
5. Server generates presigned URL with 15-min TTL (AC6)
   ↓
6. Client uploads to S3 using presigned URL
   ↓ (S3 enforces HTTPS and CORS - AC7, AC10)
7. Client notifies backend of upload completion
   ↓
8. Server triggers async virus scan (AC5)
   ↓
9. Virus scan result:
   - Clean → File available in wishlist
   - Infected → File quarantined, user notified
   - Error → File quarantined pending manual review
```

### Virus Scanning Integration Options

**Option 1: ClamAV on Lambda Layer (Recommended for MVP):**
- Pros: No external dependencies, cost-effective, Lambda-compatible
- Cons: Requires ClamAV Lambda layer (~100MB), slower cold starts

**Option 2: AWS GuardDuty Malware Protection:**
- Pros: AWS-managed service, automatic updates, integrated with S3
- Cons: Additional cost (~$1/GB scanned), requires EBS volumes

**Option 3: Third-Party API (VirusTotal, MetaDefender):**
- Pros: Advanced threat detection, multi-engine scanning
- Cons: External API dependency, per-request costs, privacy concerns

**MVP Recommendation:** Start with ClamAV on Lambda layer for cost control and simplicity. Defer to Option 2 or 3 if advanced threat detection is needed.

---

## Infrastructure Notes

### S3 Bucket Policy (HTTPS-Only + No Public Access)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyInsecureTransport",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::lego-moc-wishlist-uploads/*"
      ],
      "Condition": {
        "Bool": {
          "aws:SecureTransport": "false"
        }
      }
    },
    {
      "Sid": "DenyPublicAccess",
      "Effect": "Deny",
      "Principal": "*",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::lego-moc-wishlist-uploads/*",
      "Condition": {
        "StringNotEquals": {
          "aws:PrincipalArn": [
            "arn:aws:iam::ACCOUNT_ID:role/WishlistLambdaRole"
          ]
        }
      }
    }
  ]
}
```

### IAM Policy (Least-Privilege S3 Access)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "WishlistS3Access",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3:::lego-moc-wishlist-uploads/uploads/wishlist/*"
    }
  ]
}
```

### S3 CORS Configuration

```json
[
  {
    "AllowedOrigins": [
      "https://app.lego-moc.com",
      "https://staging.lego-moc.com",
      "http://localhost:3000"
    ],
    "AllowedMethods": ["PUT"],
    "AllowedHeaders": ["*"],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3000
  }
]
```

### ClamAV Lambda Layer

- Layer ARN: `arn:aws:lambda:us-east-1:123456789012:layer:clamav:1`
- Size: ~100MB (ClamAV binary + virus definitions)
- Update frequency: Weekly (automated CI job updates virus definitions)

---

## HTTP Contract Plan

### No New Endpoints Created

This story enhances existing presign endpoint from WISH-2002 with additional validation. No new HTTP routes.

### Enhanced Presign Endpoint (Existing)

**Endpoint:** `POST /api/wishlist/images/presign`

**Request (No Changes):**
```json
{
  "fileName": "lego-set-12345.jpg",
  "mimeType": "image/jpeg",
  "fileSize": 1048576
}
```

**Response - Success (No Changes):**
```json
{
  "presignedUrl": "https://s3.amazonaws.com/...",
  "key": "uploads/wishlist/user-123/lego-set-12345.jpg",
  "expiresIn": 900
}
```

**Response - New Validation Errors:**

```json
// Invalid MIME type
{
  "error": "Unsupported file type",
  "allowedTypes": ["image/jpeg", "image/png", "image/webp"]
}

// File too large
{
  "error": "File size exceeds maximum limit of 10MB",
  "maxSizeBytes": 10485760
}
```

**Contract Compatibility:** Fully backward compatible. Existing clients receive new validation errors but success response unchanged.

---

## Seed Requirements

**Not applicable.** Security infrastructure does not require database seeds.

**Test Seeds:**
- Malicious file samples stored in `src/test/fixtures/` for testing
- No database seed data required

---

## UI/UX Notes

### User-Facing Changes

1. **Inline Validation Errors:**
   - WishlistForm displays file type errors: "Only JPEG, PNG, and WebP images are allowed"
   - WishlistForm displays file size errors: "File size must not exceed 10MB"

2. **Upload Error Messages:**
   - If virus detected: "Your file could not be uploaded due to a security issue. Please try a different file."
   - If presigned URL expired: "Your upload session has expired. Please try again."

3. **Error Placement:**
   - File input field: Inline error message below file picker
   - Toast notification for virus detection (post-upload)

### Accessibility Considerations

- Error messages announced via `aria-live="polite"` region
- File input validation errors linked via `aria-describedby`
- Error text has WCAG AA contrast ratio (4.5:1 minimum)

### No Design System Changes

This story uses existing error message components from `@repo/ui`. No new components needed.

---

## Dependencies

### Blocked By:

- **WISH-2011** (Test infrastructure for MSW mocking) - Required for security test coverage
  - MSW handlers and fixtures must be established before security tests can be written
- **WISH-2002** (Add Item Flow) - Required for presign endpoint to exist
  - Security enhancements extend existing upload flow

### Blocks:

- Future upload features that require security validation (MOC instructions upload, gallery upload)
- Production deployment of wishlist feature (P0 security requirement)

### Internal Package Dependencies:

- `@repo/api-client` - Zod schemas for validation errors
- `@repo/upload-client` - Upload utilities (no changes)
- `@repo/logger` - Security audit logging
- `msw` - Test mocking (extends WISH-2011 handlers)

### External Dependencies:

- **ClamAV Lambda Layer:** Required for virus scanning
  - Source: AWS Serverless Application Repository or custom build
  - Size: ~100MB
  - Update mechanism: CI job for weekly virus definition updates

---

## Risks & Mitigations

### Risk 1: ClamAV Lambda Layer Size Increases Cold Start Time

**Description:** ClamAV Lambda layer adds ~100MB to deployment package, potentially increasing Lambda cold start time from ~1s to ~3s.

**Likelihood:** High
**Impact:** Medium (User experience degradation on first upload)

**Mitigation:**
- Use provisioned concurrency for presign Lambda (1 instance always warm)
- Monitor cold start metrics in CloudWatch
- If degradation is unacceptable, defer to AWS GuardDuty Malware Protection (Option 2)

---

### Risk 2: Virus Scanning Introduces Upload Latency

**Description:** Synchronous virus scanning could add 2-5 seconds to upload flow, degrading user experience.

**Likelihood:** Medium
**Impact:** High (User frustration)

**Mitigation:**
- **Make virus scanning asynchronous** (recommended in AC5)
- File is uploaded to S3 first, then scanned in background
- User sees upload success immediately
- If virus detected later, file is quarantined and user notified via toast/email
- Async approach eliminates user-facing latency

---

### Risk 3: False Positives from Virus Scanner

**Description:** ClamAV may flag legitimate LEGO instruction PDFs or images as malicious, blocking valid uploads.

**Likelihood:** Low
**Impact:** High (User frustration, blocked legitimate use cases)

**Mitigation:**
- Whitelist known false positives in ClamAV configuration
- Provide admin override mechanism for quarantined files (manual review)
- Log all virus detections for analysis and tuning
- If false positive rate > 1%, switch to alternative scanner (Option 3)

---

### Risk 4: S3 Bucket Policy Misconfiguration Blocks Uploads

**Description:** Overly restrictive S3 bucket policy could deny legitimate presigned URL uploads, breaking upload flow.

**Likelihood:** Low
**Impact:** High (Feature outage)

**Mitigation:**
- Validate bucket policy in staging environment before production deployment
- Add integration test to verify presigned URL uploads succeed (AC11-AC15)
- Use IaC (Terraform/CloudFormation) for policy management to prevent manual errors
- Rollback plan: Revert to previous bucket policy within 5 minutes

---

### Risk 5: CORS Configuration Blocks Frontend Uploads

**Description:** Missing or incorrect CORS configuration could prevent frontend PUT requests to S3, causing all uploads to fail.

**Likelihood:** Medium
**Impact:** High (Feature outage)

**Mitigation:**
- Add CORS test to verify frontend domain is allowed (AC10)
- Include localhost in CORS config for local development testing
- Monitor CORS errors in browser console and CloudWatch logs
- Pre-deployment checklist includes CORS validation

---

## Definition of Done

- [ ] File type whitelist validation implemented (server-side) (AC1)
- [ ] File type validation implemented (client-side) (AC2)
- [ ] File size limit validation implemented (server-side) (AC3)
- [ ] File size limit validation implemented (client-side) (AC4)
- [ ] Virus scanning integration implemented (async) (AC5)
- [ ] Presigned URL TTL restricted to 15 minutes (AC6)
- [ ] S3 bucket policy enforces HTTPS (AC7)
- [ ] S3 bucket policy restricts public access (AC8)
- [ ] IAM policy grants minimal S3 permissions (AC9)
- [ ] CORS configuration allows frontend origins (AC10)
- [ ] Virus scanning test coverage with MSW mocks (AC11)
- [ ] Malicious file upload test added (AC12)
- [ ] Oversized file upload test added (AC13)
- [ ] Expired presigned URL test added (AC14)
- [ ] Concurrent upload security test added (AC15)
- [ ] Security audit logging implemented (AC16)
- [ ] Documentation updated (AC17)
- [ ] All unit tests pass (20+ for file validation)
- [ ] All integration tests pass (15+ using MSW from WISH-2011)
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] Code reviewed and approved
- [ ] Infrastructure changes deployed (S3 policy, IAM policy, ClamAV layer)
- [ ] Staging environment validation complete
- [ ] Security review approved

---

## Out of Scope (Future Work)

- **Content Moderation:** AI/ML-based scanning for inappropriate images → Defer to WISH-2123 (Content Moderation)
- **Image Processing:** Automatic resizing, compression, watermarking → Defer to WISH-2016 (Image Optimization)
- **CDN Integration:** CloudFront or image CDN setup → Defer to performance story
- **Advanced Threat Detection:** Multi-engine virus scanning, sandboxing → Defer to future security story
- **User Quota Management:** Per-user storage quotas or upload rate limits → Defer to WISH-2122 (Usage Quotas)

---

## Notes

### Implementation Approach (Recommended):

1. **Start with Infrastructure (S3 + IAM):**
   - Deploy S3 bucket policy updates first (HTTPS-only, no public access)
   - Update IAM policy for least-privilege access
   - Configure CORS for frontend domains
   - Validate with manual presigned URL test

2. **Add File Validation (Server + Client):**
   - Implement file validation utilities (MIME type, size)
   - Add validation middleware to presign endpoint
   - Add client-side validation in `useS3Upload` hook
   - Write unit tests for validation logic (20+ tests)

3. **Integrate Virus Scanning:**
   - Deploy ClamAV Lambda layer
   - Implement virus scanner adapter
   - Add async scanning trigger post-upload
   - Add quarantine logic for infected files

4. **Extend MSW Test Infrastructure:**
   - Reuse MSW handlers from WISH-2011
   - Add virus scanning mock handlers
   - Create malicious file test fixtures
   - Write integration tests (15+ tests)

5. **Security Audit Logging:**
   - Add structured logging for validation failures
   - Add logging for virus detections
   - Add logging for S3 policy denials
   - Verify logs in CloudWatch

6. **Staging Validation:**
   - Deploy to staging environment
   - Manually test upload flows (happy path + error cases)
   - Validate S3 bucket policy with various scenarios
   - Verify virus scanning triggers and quarantine

### Quality Gates:

- All security tests pass without errors
- S3 bucket policy validated in AWS console
- IAM policy validated for least-privilege
- Virus scanning cold start time < 3s (with provisioned concurrency)
- Security audit logs verified in CloudWatch

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified & Resolved

| # | Finding | User Decision | Action Taken |
|---|---------|---------------|--------------|
| 1 | File size validation not enforced server-side | Add as AC | **AC18 Added:** Server-side file size validation must validate `fileSize` parameter in presign request body and reject requests exceeding 10MB with 400 Bad Request before generating presigned URL. Prevents users from bypassing client-side checks to upload oversized files and incur excessive S3 costs. |
| 2 | Virus scanner integration mechanism not specified | Clarify AC5 | **AC5 Enhanced:** Virus scanning is asynchronous via S3 event trigger Lambda. Lambda is invoked automatically when file is uploaded to S3, retrieves file, scans it, quarantines/deletes if infected. If scan service unavailable, file is quarantined pending manual review with alert triggered. Implementation mechanism now explicit. |
| 3 | Security audit logging missing implementation details | Enhance AC16 | **AC16 Enhanced:** Security events logged to CloudWatch with structured format: {userId, fileName, rejectionReason, fileSize, mimeType, timestamp, ipAddress, sourceMethod}. Logs use @repo/logger with 'security' namespace. CloudWatch Insights queries: 'validation_failures', 'virus_detections', 's3_policy_denials'. 90-day retention. Now implementation-ready. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | False positives from ClamAV scanning | Not Reviewed | Mitigated by: whitelist known false positives, admin override for manual review, monitoring < 1% false positive threshold, escalation to AWS GuardDuty if threshold exceeded |
| 2 | Cold start time impact from ClamAV layer | Not Reviewed | Mitigated by: provisioned concurrency (1 warm instance), CloudWatch monitoring, escalation if > 3s cold start, alternative AWS GuardDuty if unacceptable |
| 3 | Async virus scanning UX gap | Not Reviewed | User sees upload success immediately, file visible in wishlist. If virus detected later, file is quarantined and user notified via toast/email. No blocking user experience. |

### Follow-up Stories Suggested

- [x] **WISH-2123**: Content Moderation - AI/ML-based scanning for inappropriate/offensive images → WISH-2123
- [x] **WISH-2016**: Image Optimization - Automatic resizing, compression, watermarking → WISH-2016
- [x] **WISH-2122**: Usage Quotas - Per-user storage quotas and upload rate limits → WISH-2122
- [x] **WISH-2018**: CDN Integration - CloudFront or image CDN for performance → WISH-2018

### Items Marked Out-of-Scope

- **Content Moderation:** Separate concern from security, requires ML pipeline, deferred to WISH-2123
- **Image Processing:** Performance optimization, not security-critical, deferred to WISH-2016
- **CDN Integration:** Infrastructure optimization, not MVP-required, deferred to WISH-2018
- **Advanced Threat Detection:** ClamAV sufficient for MVP, escalation available if threat landscape changes
- **User Quota Management:** Feature policy, not security requirement, deferred to WISH-2122

---
