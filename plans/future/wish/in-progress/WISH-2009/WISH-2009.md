---
doc_type: story
title: "WISH-2009: Feature flag infrastructure setup for gradual wishlist rollout"
story_id: WISH-2009
story_prefix: WISH
status: ready-to-work
phase: 2
created_at: "2026-01-28T00:00:00-07:00"
updated_at: "2026-01-29T03:00:00Z"
depends_on: [WISH-2007]
estimated_points: 2
sizing_warning: false
---

# WISH-2009: Feature flag infrastructure setup for gradual wishlist rollout

## Goal

Enable safe, gradual rollout of wishlist features to users through feature flag infrastructure supporting canary deployments and percentage-based rollouts.

## Feature

Feature flag infrastructure for gradual rollout of WISH-2001 through WISH-2005. Provides canary deployment capability, percentage-based rollout, and instant kill-switch functionality.

## Phase

Phase 2+ - Infrastructure

## Context

The wishlist feature requires controlled rollout to production users. Instead of deploying all features at once, feature flags enable:
- Canary deployments (1% -> 5% -> 25% -> 100%)
- A/B testing capability for UX variations
- Instant rollback without redeployment
- Per-feature toggles for independent release

This story establishes the feature flag infrastructure before any wishlist feature goes live, reducing production risk significantly.

## Non-goals

- Third-party feature flag service integration (LaunchDarkly, Flagsmith) - use simple in-house solution
- Real-time flag updates via WebSocket - poll-based or on-request evaluation only
- Flag analytics/usage metrics - defer to future story
- User-level targeting (e.g., specific users) - percentage-based only in MVP
- Multi-environment flag sync - flags configured per environment
- Flag audit logging - defer to future story
- Flag scheduling (scheduled enable/disable) - manual only in MVP

## Scope

### Endpoints Affected

**New Endpoints**:
- `GET /api/config/flags` - Return current feature flag states for client
- `GET /api/config/flags/:flagKey` - Return single flag state with metadata
- `POST /api/admin/flags/:flagKey` - Update flag state (admin only)

### Packages Affected

1. **Backend - Feature Flag Service**: `apps/api/lego-api/domains/config/`
   - `application/feature-flag-service.ts` - Flag evaluation logic
   - `adapters/feature-flag-repository.ts` - Redis cache adapter for flags
   - `routes.ts` - Flag endpoints
   - `types.ts` - Feature flag schemas

2. **Backend - Middleware**: `apps/api/lego-api/middleware/`
   - `feature-flag.ts` - Request middleware for flag injection

3. **Shared Schemas**: `packages/core/api-client/src/schemas/`
   - `feature-flags.ts` - Feature flag schemas shared with frontend

4. **Frontend Context**: `apps/web/app-wishlist-gallery/`
   - `src/contexts/FeatureFlagContext.tsx` - React context for flags
   - `src/hooks/useFeatureFlag.ts` - Hook for flag access

5. **Database**: `packages/backend/database-schema/`
   - `src/schema/feature-flags.ts` - Feature flag table schema

### Infrastructure Impact

**Redis Cache**:
- Cache key: `feature_flags:{environment}` - All flags for environment
- Cache key: `feature_flags:{environment}:{flagKey}` - Single flag
- TTL: 5 minutes for flag cache (allows near-instant updates)

**Database Schema**:
```sql
CREATE TABLE feature_flags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  flag_key VARCHAR(100) UNIQUE NOT NULL,
  enabled BOOLEAN DEFAULT false,
  rollout_percentage INTEGER DEFAULT 0 CHECK (rollout_percentage >= 0 AND rollout_percentage <= 100),
  description TEXT,
  environment VARCHAR(20) DEFAULT 'production',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Acceptance Criteria

### Backend - Feature Flag Service

**AC1**: Create feature flag database schema
- Table: `feature_flags` with columns: id, flag_key, enabled, rollout_percentage, description, environment, created_at, updated_at
- Index on flag_key for fast lookups
- Unique constraint on (flag_key, environment)
- Drizzle migration created and applied

**AC2**: Create feature flag service with evaluation logic
- Method: `evaluateFlag(flagKey: string, userId?: string): Promise<boolean>`
- If `enabled = false`: Return false
- If `enabled = true` and `rollout_percentage = 100`: Return true
- If `enabled = true` and `rollout_percentage < 100`: Hash userId to determine inclusion
- If no userId provided: Return true (logged-in check only)

**AC3**: Implement deterministic rollout based on user ID
- Use consistent hashing (murmurhash3 or similar) on userId
- Same userId always gets same result for same percentage
- Example: 25% rollout means users with hash 0-24 are included

**AC4**: Add `GET /api/config/flags` endpoint
- Returns all flags for current environment as object
- Response: `{ "wishlist-gallery": true, "wishlist-add-item": false, ... }`
- No auth required (public endpoint for client)
- Zod schema: `FeatureFlagsResponseSchema`

**AC5**: Add `GET /api/config/flags/:flagKey` endpoint
- Returns single flag with metadata
- Response: `{ key: "wishlist-gallery", enabled: true, rolloutPercentage: 50 }`
- No auth required
- Zod schema: `FeatureFlagDetailResponseSchema`

**AC6**: Add `POST /api/admin/flags/:flagKey` endpoint (admin only)
- Updates flag state
- Request body: `{ enabled: boolean, rolloutPercentage?: number }`
- Requires admin role (authorization check)
- Invalidates Redis cache on update
- Returns updated flag state

**AC7**: Implement Redis caching for flags
- Cache all flags per environment with 5-minute TTL
- Cache invalidation on flag update
- Fallback to database if Redis unavailable
- Log warning if serving from database (cache miss)

**AC8**: Create feature flag middleware
- Middleware injects current flags into request context
- Flags available as `req.featureFlags` in handlers
- Evaluates flags once per request (not per check)

**AC9**: Backend unit tests for feature flag service
- Test flag evaluation (enabled/disabled)
- Test percentage rollout with deterministic hashing
- Test cache hit/miss scenarios
- Test admin update with cache invalidation
- Minimum: 10 unit tests

### Frontend - Feature Flag Context

**AC10**: Create FeatureFlagProvider context
- Fetches flags from `GET /api/config/flags` on mount
- Provides `isFeatureEnabled(flagKey)` method
- Refreshes flags on window focus (stale-while-revalidate)
- Uses RTK Query with 5-minute cache

**AC11**: Create useFeatureFlag hook
- Hook: `useFeatureFlag(flagKey: string): boolean`
- Returns true if flag enabled, false otherwise
- Returns false while loading (safe default)

**AC12**: Frontend component tests for feature flag hook
- Test flag enabled returns true
- Test flag disabled returns false
- Test loading state returns false
- Test context provides correct values
- Minimum: 5 component tests

### Initial Flag Configuration

**AC13**: Seed initial wishlist feature flags
- Flags to create:
  - `wishlist-gallery` - Gallery view (WISH-2001)
  - `wishlist-add-item` - Add item form (WISH-2002)
  - `wishlist-edit-item` - Edit/delete item (WISH-2003)
  - `wishlist-got-it` - Got It flow (WISH-2004)
  - `wishlist-reorder` - Drag-and-drop reorder (WISH-2005)
- All flags: `enabled = false`, `rolloutPercentage = 0`
- Seed script creates flags if not exist

### Integration Testing

**AC14**: Backend integration tests for flag endpoints
- `.http` file: `__http__/feature-flags.http`
- Test: GET /api/config/flags (returns all flags)
- Test: GET /api/config/flags/wishlist-gallery (returns single flag)
- Test: POST /api/admin/flags/wishlist-gallery (update flag)
- Minimum: 4 HTTP requests

**AC15**: Verify flag checks work in wishlist endpoints
- Add flag check to GET /api/wishlist endpoint
- If `wishlist-gallery` disabled: Return 404 with message "Feature not available"
- If enabled: Return normal response
- Test with flag on/off

### Schema Synchronization

**AC16**: Frontend and backend Zod schemas aligned
- Both define identical `FeatureFlagSchema`
- Both define identical `FeatureFlagsResponseSchema`
- Alignment test verifies schemas match
- TypeScript compilation passes

## Reuse Plan

### Existing Components (Extended)
- Redis cache from `apps/api/lego-api/core/cache/redis.ts`
- Auth middleware from `apps/api/lego-api/middleware/auth.ts`
- Zod schema patterns from existing schemas

### New Components
- `feature-flag-service.ts` - Flag evaluation logic
- `feature-flag-repository.ts` - Database/cache adapter
- `FeatureFlagContext.tsx` - React context provider
- `useFeatureFlag.ts` - React hook for flags

### Existing Patterns
- Hexagonal architecture (ports & adapters)
- Zod schema validation
- RTK Query for frontend data fetching
- Redis caching with TTL

## Architecture Notes (Ports & Adapters)

### Hexagonal Architecture Compliance

**Domain Layer** (Business Logic):
- `apps/api/lego-api/domains/config/application/feature-flag-service.ts`
  - Flag evaluation logic
  - Percentage rollout calculation
  - Pure business logic - no HTTP/Redis coupling

**Adapter Layer** (Infrastructure):
- `apps/api/lego-api/domains/config/adapters/feature-flag-repository.ts`
  - Redis cache adapter for flags
  - Database adapter for flag storage
  - Cache invalidation logic

**Port Layer** (Contracts):
- `apps/api/lego-api/domains/config/types.ts`
  - Define `FeatureFlag`, `FeatureFlagsResponse` types
  - Define Zod schemas

**No Architecture Violations**: Story creates new domain (config) following existing patterns

## Test Plan

### Backend Unit Tests

**Feature Flag Service Tests**:
1. evaluateFlag with disabled flag returns false
2. evaluateFlag with enabled flag (100%) returns true
3. evaluateFlag with 50% rollout includes user consistently
4. evaluateFlag with 0% rollout excludes all users
5. evaluateFlag with no userId defaults to enabled (if flag enabled)
6. updateFlag invalidates cache
7. getFlags returns all flags for environment
8. getFlag returns single flag with metadata
9. Cache hit returns cached flags
10. Cache miss fetches from database

**Minimum**: 10 unit tests

### Backend Integration Tests

**HTTP Tests** (`__http__/feature-flags.http`):
- GET /api/config/flags - list all flags
- GET /api/config/flags/wishlist-gallery - single flag
- POST /api/admin/flags/wishlist-gallery - update flag
- GET /api/wishlist with flag disabled - returns 404

**Minimum**: 4 HTTP requests

### Frontend Tests

**Component Tests**:
- FeatureFlagProvider renders children
- useFeatureFlag returns correct value
- Loading state handled correctly
- Context re-fetches on focus
- Multiple flags evaluated correctly

**Minimum**: 5 component tests

## UI/UX Notes

### MVP-Critical Requirements

**No User-Facing UI**: This is infrastructure-only story. Feature flags are evaluated server-side and control feature availability.

**Admin UI (Future)**: Admin dashboard for flag management is out of scope for MVP. Use database/API directly.

**Feature Gating Pattern**:
```tsx
function WishlistPage() {
  const isGalleryEnabled = useFeatureFlag('wishlist-gallery')

  if (!isGalleryEnabled) {
    return <FeatureNotAvailable message="Wishlist coming soon!" />
  }

  return <WishlistGallery />
}
```

## Risks & Mitigations

### MVP-Critical Risks

1. **Flag Evaluation Performance**
   - Risk: Flag checks add latency to every request
   - Mitigation: Cache flags in Redis with 5-min TTL, evaluate once per request
   - Severity: Low

2. **Inconsistent Rollout Experience**
   - Risk: Users get different features on different requests
   - Mitigation: Deterministic hashing on userId ensures consistency
   - Severity: Medium

3. **Flag Cache Staleness**
   - Risk: Flag updates take up to 5 minutes to propagate
   - Mitigation: Acceptable for MVP; add manual cache invalidation endpoint for urgent changes
   - Severity: Low

4. **No Audit Trail**
   - Risk: No visibility into who changed flags when
   - Mitigation: Log flag updates to structured logs; defer audit table to future story
   - Severity: Low

## Open Questions

None - all decisions finalized for MVP scope.

## Definition of Done

- [ ] All 16 Acceptance Criteria pass
- [ ] Backend: 10 unit tests pass (feature flag service)
- [ ] Backend: 4 HTTP integration tests pass
- [ ] Frontend: 5 component tests pass
- [ ] Database migration created and applied
- [ ] Seed script creates initial flags
- [ ] Schema alignment test passes (frontend ↔ backend)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved

## Follow-up Stories (Future)

### Phase 3+
- Admin UI for flag management
- Flag audit logging
- User-level targeting (specific users)
- Flag scheduling (auto-enable at time)
- Flag analytics (usage metrics)

### Infrastructure
- Third-party integration (LaunchDarkly, etc.)
- Real-time flag updates via WebSocket
- Multi-environment flag sync

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Elaboration | ~15k | — | — | Standard infrastructure story |
| Implementation | ~12k | — | — | Backend + Frontend + Migration |
| Code Review | ~5k | — | — | Infrastructure story |
| **Total** | ~32k | — | — | Medium-sized story |

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-28 00:00 | Orchestrator | Created story from index entry | WISH-2009.md |
| 2026-01-29 02:45 | elab-analyst | Completed audit - found 7 issues (4 critical/high) | ANALYSIS.md |
| 2026-01-29 03:00 | elab-completion-leader | Converted issues to ACs, finalized scope | ELAB-WISH-2009.md, QA Discovery Notes |

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-29_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Redis infrastructure not available in codebase | Add as AC 17 | Use in-memory cache (Map with TTL) for MVP; provides same interface as Redis adapter but simpler for MVP; migrate to Redis in follow-up story |
| 2 | Architecture pattern conflict: lego-api/domains/ vs services/{domain}/ | Add as AC 18 | `lego-api/domains/` is currently canonical (existing gallery, wishlist, health domains use this pattern); update docs/architecture/api-layer.md in follow-up story |
| 3 | stories.index.md lacks detailed scope for WISH-2009 | Add as AC 19 | Index entry must be updated with full scope: 3 endpoints, 5 packages, feature flag database schema, in-memory cache layer |
| 4 | Backend schema ownership unclear (shared vs local) | Add as AC 20 | Backend owns FeatureFlagSchema in apps/api/lego-api/domains/config/types.ts; frontend imports from @repo/api-client via schema re-export |
| 5 | Middleware injection point not specified | Add as AC 21 | Global middleware in apps/api/lego-api/middleware/feature-flag.ts; injects flags evaluated per-request into req.featureFlags context |
| 6 | Admin role validation not specified | Add as AC 22 | Reference existing auth middleware from apps/api/lego-api/middleware/auth.ts; extract admin role from JWT and enforce on POST /api/admin/flags/:flagKey |
| 7 | Hashing algorithm choice deferred | Add as AC 23 | Use Node.js crypto.createHash('sha256') for deterministic user ID hashing; provides consistent rollout behavior |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Redis migration strategy | Document in follow-up story | Once Redis infrastructure available, migrate in-memory cache to Redis with minimal code changes (adapter pattern) |
| 2 | Architecture documentation | Follow-up story created | Update docs/architecture/api-layer.md to document lego-api/domains/ pattern as canonical (after reviewing all existing domains) |
| 3 | Admin UI for flag management | Keep as documented in Follow-up Stories section | Defer to Phase 3+; MVP uses database/API directly for admin operations |

### Follow-up Stories Suggested

- [x] Update docs/architecture/api-layer.md to document lego-api/domains/ as canonical pattern (AC 18 follow-up) → WISH-2029
- [x] Redis infrastructure setup and migration from in-memory cache (when Redis needed for production scaling) → WISH-2019
- [x] Admin UI for feature flag management → WISH-2016
- [x] Flag audit logging with timestamp and admin user tracking → WISH-2019
- [x] User-level targeting (beyond percentage-based rollout) → WISH-2039

### Items Marked Out-of-Scope

- Admin UI for flag management: Use database/API directly in MVP; defer dashboard to Phase 3+
- Third-party feature flag service integration (LaunchDarkly, Flagsmith): Use simple in-house solution for MVP
- Real-time flag updates via WebSocket: Poll-based or on-request evaluation only
- Flag analytics/usage metrics: Defer to future story
- User-level targeting: Percentage-based only in MVP
- Multi-environment flag sync: Flags configured per environment
- Flag audit logging: Defer to future story → WISH-2019
- Flag scheduling: Manual only in MVP → WISH-2119
