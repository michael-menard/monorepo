---
doc_type: story
title: "WISH-2022: Client-side Image Compression"
story_id: WISH-2022
story_prefix: WISH
status: in-progress
e2e_required: true
follow_up_from: WISH-2002
phase: 4
created_at: "2026-01-27T00:00:00-07:00"
updated_at: "2026-01-31T16:50:00-07:00"
depends_on: [WISH-2002]
estimated_points: 3
---

# WISH-2022: Client-side Image Compression

## Follow-up Context

**Parent Story:** WISH-2002: Add Item Flow
**Source:** QA Discovery Notes - Enhancements Integrated
**Original Finding:** Client-side image compression - compress images before S3 upload to reduce upload time and storage costs. Use browser-image-compression library.
**Category:** Enhancement Opportunity
**Impact:** High - significantly reduces upload time and S3 storage costs
**Effort:** Medium - requires integration with compression library and upload flow

## Context

Users uploading high-resolution images (e.g., 4032x3024 photos from modern smartphones) may experience slow upload times and consume unnecessary S3 storage. The WISH-2002 implementation accepts files up to 10MB, but most wishlist images don't need full resolution.

Client-side compression before S3 upload can:
- Reduce upload time by 60-80% for typical phone photos
- Reduce S3 storage costs significantly
- Improve perceived performance
- Reduce bandwidth costs for users on mobile data

This enhancement integrates compression into the existing image upload flow from WISH-2002 without changing the backend API.

## Goal

Automatically compress images on the client side before uploading to S3, reducing upload time and storage costs while maintaining acceptable visual quality.

## Non-goals

- Not implementing server-side image processing or resizing
- Not implementing multiple image size variants (thumbnail, medium, large)
- Not implementing progressive JPEG or advanced format optimization
- Not re-implementing the S3 upload flow from WISH-2002
- Not implementing compression for other file types (PDFs, etc.)

## Scope

**Components Affected:**
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts`
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts` (new)

**Packages Affected:**
- `apps/web/app-wishlist-gallery`

**New Dependencies:**
- `browser-image-compression` package

## Acceptance Criteria

- [ ] Images are automatically compressed before S3 upload using browser-image-compression library
- [ ] Compression settings: max width 1920px, max height 1920px, quality 0.8, max size 1MB
- [ ] Compression shows progress indicator: "Compressing image... X%"
- [ ] Original filename and MIME type are preserved after compression
- [ ] Compression can be skipped if image is already small (< 500KB)
- [ ] Compression failures gracefully fall back to original image upload
- [ ] User can toggle "High quality (skip compression)" checkbox in upload form
- [ ] Compression happens before requesting S3 presigned URL
- [ ] Toast notification shows: "Image compressed: X MB → Y MB" after successful compression
- [ ] Compressed image preview updates in form before upload
- [ ] Playwright E2E tests cover: compression flow happy path, skip compression logic for small images, fallback on compression failure, user preference toggle persistence
- [ ] Test coverage includes: unit tests for imageCompression.ts utility functions, integration tests for useS3Upload hook modifications, Playwright E2E tests for full compression workflow
- [ ] localStorage preference key is clarified: `wishlist:preferences:imageCompression` stores boolean (user preference), applies globally to all image uploads in the app
- [ ] Compression progress integration is clarified: compression progress shows first ("Compressing image... X%"), upload progress shows after presigned URL is obtained ("Uploading... Y%"); both are sequential, not combined

## Reuse Plan

- Builds on `useS3Upload` hook from WISH-2002
- Leverages existing upload progress indicator from WISH-2002
- Uses `browser-image-compression` library (MIT license, widely used)
- Can reuse error handling patterns from WISH-2002

## Architecture Notes

**Compression Flow:**
```
1. User selects image file
2. Check file size:
   - If < 500KB and dimensions < 1920x1920: skip compression
   - Otherwise: compress with browser-image-compression
3. Show "Compressing image... X%" progress
4. Generate compressed blob
5. Update preview with compressed image
6. Request presigned S3 URL (existing flow)
7. Upload compressed blob to S3 (existing flow)
```

**Compression Settings:**
```typescript
{
  maxSizeMB: 1,
  maxWidthOrHeight: 1920,
  useWebWorker: true,
  fileType: 'image/jpeg', // convert all to JPEG for consistency
  initialQuality: 0.8
}
```

**Configuration Options:**
- User preference: "High quality (skip compression)" checkbox
- Stored in localStorage: `wishlist:preferences:imageCompression`
- Default: compression enabled

## Test Plan

### Happy Path

1. User selects high-resolution image (5MB, 4032x3024)
2. Compression starts automatically
3. Progress indicator shows: "Compressing image... 45%"
4. Compression completes: "Image compressed: 5.2 MB → 0.8 MB"
5. Preview updates with compressed image
6. User submits form
7. Compressed image uploads to S3

### Error Cases

1. **Compression fails**: If browser-image-compression throws error, fall back to original image upload with warning toast
2. **Unsupported format**: If image format can't be compressed (e.g., animated GIF), skip compression
3. **Browser compatibility**: If browser doesn't support canvas/blob APIs, fall back to original upload
4. **Compression timeout**: If compression takes > 10 seconds, show warning and allow user to skip

### Edge Cases

1. **Already small images**: Skip compression if < 500KB and dimensions < 1920x1920
2. **Very large images**: Images > 20MB may cause browser memory issues; show warning
3. **User disables compression**: "High quality" checkbox skips compression entirely
4. **Compression increases size**: If compressed size > original, use original (rare edge case)

## Risks / Edge Cases

1. **Browser memory limits**: Very large images (> 20MB) may cause out-of-memory errors in browser; mitigate with size warning
2. **Quality degradation**: JPEG compression at 0.8 quality is noticeable on close inspection; acceptable for wishlist images
3. **HEIC/HEIF support**: Modern iPhone photos in HEIC format may not be supported by browser-image-compression; need fallback
4. **Web worker overhead**: Compression in web worker adds latency but prevents UI blocking; net benefit for large images

## Open Questions

None - all requirements are clear and non-blocking.

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-29_

### Issues Identified (Added to ACs)

| # | Issue | Decision | Notes |
|---|-------|----------|-------|
| 1 | Missing Playwright test specification | Add as AC | Playwright E2E test scenarios now explicit in AC 11 |
| 2 | Missing test coverage AC | Add as AC | Test coverage requirements now specified in AC 12 |
| 3 | localStorage preference key clarity | Add as AC | Key semantics and scope clarified in AC 13 |
| 4 | Progress callback integration detail | Add as AC | Compression + upload progress sequencing now clarified in AC 14 |

### Gaps Identified (Follow-up Stories)

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | HEIC/HEIF format support | Follow-up story (WISH-2045) | Modern iPhones use HEIC by default; browser-image-compression needs plugin or server-side fallback |
| 2 | Compression quality presets | Follow-up story (WISH-2046) | Add user-selectable presets: "Low bandwidth" (0.6, 1200px), "Balanced" (0.8, 1920px), "High quality" (0.9, 2400px) |
| 3 | Compression failure telemetry | Follow-up story (WISH-2047) | Track compression failures via CloudWatch to identify patterns and improve fallback logic |

### Enhancement Opportunities (Follow-up Stories)

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | WebP format conversion | Follow-up story (WISH-2048) | Convert to WebP instead of JPEG for 25-35% additional size savings; supported by browser-image-compression |
| 2 | Background compression | Follow-up story (WISH-2049) | Start compression when image selected (before form submission); reduces perceived latency |
| 3 | Compression preview comparison | Out-of-scope | Side-by-side comparison adds UI complexity; compression quality is acceptable at 0.8 for wishlist images |

### Items Marked Out-of-Scope

- **Original image preservation option**: Doubles S3 storage cost; not justified for wishlist use case
- **Progressive JPEG encoding**: Additional configuration complexity; standard sequential JPEG sufficient
- **Client-side image cropping/rotation**: Out of scope for Phase 4 (UX Polish); consider for future image editor enhancement
- **Bulk upload compression**: Not required for MVP; compression handles single-image uploads efficiently
- **Compression analytics dashboard**: Gamification feature; out of scope for Phase 4
- **Smart quality selection**: Requires ML/heuristics; over-engineering for image compression optimization
- **Offline compression queue**: PWA feature; requires service worker integration; out of scope

### Follow-up Stories Suggested

- [x] **WISH-2045**: Add HEIC/HEIF format support via browser-image-compression plugin or server-side conversion → WISH-2045
- [x] **WISH-2046**: Implement compression quality presets for user control → WISH-2046
- [x] **WISH-2023**: Add compression failure telemetry to CloudWatch metrics → WISH-2023
- [x] **WISH-2048**: Implement WebP format conversion for additional size savings → WISH-2048
- [x] **WISH-2049**: Add background compression to improve perceived performance → WISH-2049
- [x] **WISH-2050**: Implement compression preview comparison (side-by-side or slider) → WISH-2050
