---
doc_type: story
title: "WISH-2015: Sort Mode Persistence (localStorage)"
story_id: WISH-2015
story_prefix: WISH
status: in-qa
phase: 5
created_at: "2026-01-28T02:20:00-07:00"
updated_at: "2026-01-29T18:15:00-07:00"
depends_on: [WISH-2014]
follow_up_from: WISH-2014
estimated_points: 2
sizing_warning: false
---

# WISH-2015: Sort Mode Persistence (localStorage)

## Follow-up Context

**Parent Story**: WISH-2014 (Smart Sorting Algorithms)
**Source**: QA Discovery Notes - Follow-up Story Suggestion
**Original Finding**: "Sort Mode Persistence (localStorage) - Phase 5 UX Polish"
**Category**: Enhancement Opportunity
**Impact**: Medium - Improves user experience by remembering sort preferences
**Effort**: Low - Frontend-only localStorage implementation

## Context

Follow-up story from WISH-2014 QA Elaboration. After implementing three smart sorting modes (Best Value, Expiring Soon, Hidden Gems), users should not lose their preferred sort mode when navigating away from the wishlist gallery or refreshing the page. This story adds localStorage persistence to remember the user's last selected sort mode across sessions.

This is a common UX pattern found in e-commerce and gallery applications where users expect their view preferences to persist.

## Goal

Persist the user's selected sort mode to localStorage and restore it automatically when they return to the wishlist gallery, providing a consistent browsing experience across sessions.

## Non-goals

- Persisting other filter/view state (store filter, search query, pagination) - deferred to future story
- Server-side sort preference storage - deferred to Phase 6 (User Preferences Backend)
- Multi-device sync of sort preferences - deferred to Phase 6
- Sort mode analytics tracking - deferred to future story (WISH-2005g pattern)
- Sort history or "recently used sorts" - deferred to future story

## Scope

### Packages Affected

1. **Frontend**: `apps/web/app-wishlist-gallery/`
   - `src/pages/main-page.tsx` - Add localStorage read/write on sort change
   - `src/hooks/useLocalStorage.ts` - Generic localStorage hook (create if missing)
   - `src/hooks/__tests__/useLocalStorage.test.ts` - Hook unit tests

### No Backend Changes

This is a **frontend-only** story. The backend already supports all sort modes from WISH-2014.

## Acceptance Criteria

### localStorage Integration

**AC1**: Sort mode saved to localStorage on user selection
- Key: `wishlist_sort_mode` (scoped to app)
- Value: Current sort mode string (e.g., "bestValue", "expiringSoon", "hiddenGems")
- Save occurs immediately on dropdown selection (no debounce needed)
- Existing sort modes also persisted (createdAt, title, price, pieceCount, sortOrder, priority)

**AC2**: Sort mode restored from localStorage on page load
- On component mount, read `wishlist_sort_mode` from localStorage
- If valid sort mode found, set as initial dropdown value
- If no value or invalid value, fall back to default sort (createdAt)
- Restoration happens before first API call (to avoid double-fetch)

**AC3**: localStorage cleared on logout or explicit user action
- Integration with existing logout flow (if exists)
- Optional: Add "Reset to default" button in UI to clear preference
- Clear only wishlist-specific keys, not entire localStorage

### Validation & Error Handling

**AC4**: Invalid localStorage values handled gracefully
- If localStorage contains invalid sort value, fall back to default
- Schema validation using Zod (reuse existing `WishlistQueryParamsSchema.shape.sort`)
- No 500 errors or console warnings for invalid values
- Invalid value replaced with default on next save

**AC5**: localStorage quota exceeded handled gracefully
- Try-catch around localStorage.setItem()
- If quota exceeded, log warning and continue with session-only state
- User experience not degraded (sort still works, just not persisted)
- Error logged to @repo/logger with context

**AC6**: Private/incognito mode compatibility
- Test in Chrome/Firefox/Safari incognito mode
- Graceful fallback if localStorage disabled
- No blocking errors or broken functionality

### User Experience

**AC7**: Sort dropdown reflects persisted value on page load
- Visual state of dropdown matches localStorage value
- No "flash" of default sort before restoration
- RTK Query initial fetch uses persisted sort mode

**AC8**: Sort mode persists across page refreshes
- Set sort mode to "bestValue"
- Refresh page
- Verify dropdown shows "bestValue" and API called with correct param
- Items displayed in correct order without re-selecting

**AC9**: Sort mode persists across navigation
- Navigate from wishlist to another page
- Navigate back to wishlist
- Verify sort mode restored (both dropdown and API call)
- Verify items displayed in persisted sort order

**AC10**: Multiple tabs respect shared localStorage
- Open wishlist in Tab A, set sort to "hiddenGems"
- Open wishlist in Tab B
- Verify Tab B uses "hiddenGems" sort mode
- Note: Real-time sync across open tabs (storage event) deferred to future story

### Testing

**AC11**: Unit tests for localStorage hook
- Test: Save value to localStorage
- Test: Retrieve value from localStorage
- Test: Handle missing key (return default)
- Test: Handle invalid JSON
- Test: Handle quota exceeded error
- Minimum: 5 unit tests

**AC12**: Component tests verify persistence logic
- Test: Initial sort mode loaded from localStorage
- Test: Sort mode saved on dropdown change
- Test: Invalid localStorage value falls back to default
- Test: Missing localStorage falls back to default
- Minimum: 4 component tests

**AC13**: Playwright E2E test verifies persistence flow
- Test: Set sort mode, refresh page, verify persisted
- Test: Set sort mode, navigate away, return, verify persisted
- Evidence: Screenshots + localStorage inspection
- No console errors

### Accessibility

**AC14**: Screen reader announces current sort mode on restoration
- When sort mode restored from localStorage, announce to screen reader
- Example: "Sort mode set to Best Value"
- Use aria-live region or toast notification
- Only announce if sort mode differs from default

## Reuse Plan

### Existing Components
- ✅ Sort dropdown from WISH-2014 (no changes needed)
- ✅ RTK Query `useGetWishlistQuery` hook (accepts initial sort param)
- ✅ Zod schema `WishlistQueryParamsSchema.shape.sort` for validation

### Existing Patterns
- ✅ localStorage access patterns (check if exists in codebase)
- ✅ Error handling with @repo/logger
- ✅ React hooks for state management

### New Components (Create if Missing)
- `useLocalStorage` hook (generic reusable hook)
- `useWishlistSortPersistence` hook (wishlist-specific hook using useLocalStorage)

## Architecture Notes

### Hexagonal Architecture Compliance

**Frontend-Only Story**: No backend changes required.

**Adapter Layer** (Infrastructure):
- `src/hooks/useLocalStorage.ts` - Browser localStorage adapter
- Abstracts localStorage API behind React hook
- Handles browser compatibility and errors

**Domain Logic**:
- `src/hooks/useWishlistSortPersistence.ts` - Wishlist-specific persistence logic
- Uses `useLocalStorage` adapter
- Validates sort mode against Zod schema
- Manages fallback behavior

**UI Layer**:
- `src/pages/main-page.tsx` - Consumes `useWishlistSortPersistence`
- Updates dropdown and RTK Query on mount
- No direct localStorage coupling in UI components

**No Architecture Violations**: Clear separation between adapter (useLocalStorage), domain (useWishlistSortPersistence), and UI (main-page).

### localStorage Key Strategy

**Namespacing**:
```typescript
const STORAGE_KEYS = {
  WISHLIST_SORT_MODE: 'app.wishlist.sortMode',  // Scoped to app
  // Future keys:
  // WISHLIST_FILTERS: 'app.wishlist.filters',
  // WISHLIST_VIEW_MODE: 'app.wishlist.viewMode',
} as const
```

**Rationale**: Prefix with `app.wishlist.` to avoid collisions with other features or third-party libraries.

### Hook Design Pattern

**Generic Hook** (`useLocalStorage`):
```typescript
function useLocalStorage<T>(
  key: string,
  defaultValue: T,
  schema?: z.ZodSchema<T>
): [T, (value: T) => void] {
  // Generic localStorage logic
  // Optional Zod validation
  // Error handling
}
```

**Wishlist-Specific Hook** (`useWishlistSortPersistence`):
```typescript
function useWishlistSortPersistence() {
  const sortSchema = WishlistQueryParamsSchema.shape.sort
  const [sortMode, setSortMode] = useLocalStorage(
    STORAGE_KEYS.WISHLIST_SORT_MODE,
    'createdAt',  // Default
    sortSchema
  )
  return { sortMode, setSortMode }
}
```

**Reuse Strategy**: `useLocalStorage` hook can be reused for future localStorage needs (filters, view mode, etc.)

## Test Plan

### Happy Path

1. **Initial Persistence**
   - User opens wishlist (default sort: createdAt)
   - User selects "Best Value" from dropdown
   - Verify: localStorage contains `{ "app.wishlist.sortMode": "bestValue" }`
   - Evidence: localStorage inspector screenshot

2. **Restoration After Refresh**
   - localStorage contains `bestValue`
   - User refreshes page
   - Verify: Dropdown shows "Best Value"
   - Verify: API called with `sort=bestValue`
   - Verify: Items displayed in Best Value order
   - Evidence: Network HAR + screenshot

3. **Restoration After Navigation**
   - localStorage contains `hiddenGems`
   - User navigates to different page
   - User navigates back to wishlist
   - Verify: Sort mode restored to "Hidden Gems"
   - Evidence: Screenshot of restored state

### Error Cases

1. **Invalid localStorage Value**
   - Set localStorage to `{ "app.wishlist.sortMode": "invalidSort" }`
   - User opens wishlist
   - Verify: Falls back to default (createdAt)
   - Verify: No console errors
   - Verify: Next selection overwrites invalid value
   - Evidence: Console log screenshot

2. **localStorage Quota Exceeded**
   - Mock localStorage.setItem() to throw QuotaExceededError
   - User selects sort mode
   - Verify: Warning logged to console
   - Verify: Sort mode still applied (session-only)
   - Verify: No UI errors
   - Evidence: Console warning screenshot

3. **Incognito Mode / localStorage Disabled**
   - Open wishlist in incognito mode
   - Attempt to save sort mode
   - Verify: Graceful fallback (session-only state)
   - Verify: No errors
   - Evidence: Incognito mode screenshot

### Edge Cases

1. **First Visit (No localStorage)**
   - Clear all localStorage
   - Open wishlist
   - Verify: Default sort mode (createdAt) applied
   - Verify: No errors
   - Evidence: Initial state screenshot

2. **Corrupted localStorage JSON**
   - Set localStorage to malformed JSON: `{ "app.wishlist.sortMode": "{bad json" }`
   - Open wishlist
   - Verify: Falls back to default
   - Verify: Corrupted value replaced on next save
   - Evidence: Console log + localStorage inspector

3. **Multiple Tabs (Shared State)**
   - Tab A: Set sort to "expiringSoon"
   - Tab B: Open wishlist
   - Verify: Tab B uses "expiringSoon" sort
   - Note: Real-time sync not required (deferred to future story)
   - Evidence: Multi-tab screenshot

### Test Evidence Requirements

**Unit Tests**:
- `useLocalStorage.test.ts` - 5+ tests covering save, retrieve, error handling
- `useWishlistSortPersistence.test.ts` - 4+ tests covering integration

**E2E Tests** (Playwright):
- `wishlist-sort-persistence.spec.ts` - 3 scenarios (persistence, navigation, refresh)
- Evidence: Screenshots, localStorage inspection, network HAR

## Risks / Edge Cases

### MVP-Critical Risks

1. **localStorage Browser Compatibility**
   - **Risk**: Safari private mode throws on localStorage access
   - **Mitigation**: Try-catch with feature detection, graceful fallback
   - **Severity**: Low (AC6 requires compatibility testing)

2. **Schema Drift Between Frontend and localStorage**
   - **Risk**: Code updated with new sort modes, old localStorage values invalid
   - **Mitigation**: Zod schema validation (AC4), fallback to default
   - **Severity**: Low (handled by validation)

3. **localStorage Quota Limits**
   - **Risk**: User's localStorage quota full, setItem() throws
   - **Mitigation**: Try-catch with logger warning (AC5), continue with session state
   - **Severity**: Low (rare occurrence)

### Non-MVP Risks (Future Consideration)

- Real-time sync across open tabs (storage event listener) - deferred to future story
- Server-side preference sync for multi-device users - deferred to Phase 6
- localStorage pollution from old/deprecated keys - plan cleanup strategy in Phase 6
- Performance impact of localStorage reads on mount - negligible for single key

## Open Questions

None - all decisions made during story creation.

## Definition of Done

- [ ] All 14 Acceptance Criteria pass
- [ ] `useLocalStorage` hook implemented and tested (5+ unit tests)
- [ ] `useWishlistSortPersistence` hook implemented and tested (4+ unit tests)
- [ ] `main-page.tsx` integrated with persistence hooks
- [ ] Playwright E2E test passes (3 scenarios with evidence)
- [ ] Incognito mode tested (Chrome, Firefox, Safari)
- [ ] localStorage quota error handling tested
- [ ] Invalid value fallback tested
- [ ] Accessibility: Screen reader announces restored sort mode
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved
- [ ] QA verification complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Implementation | ~5k | — | — | Frontend hooks + tests |
| Code Review | ~3k | — | — | Small scope |
| **Total** | ~8k | — | — | Small-sized story |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-28 02:20 | pm-story-followup-leader | Created follow-up story from WISH-2014 finding #1 | WISH-2015.md |

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| — | No gaps identified | — | Story comprehensively defines localStorage persistence with all acceptance criteria, test plan, risk mitigation, and architecture patterns documented. |

### Enhancement Opportunities

| # | Finding | Impact | Effort | Notes |
|---|---------|--------|--------|-------|
| 1 | Real-time multi-tab sync via storage event | Low | Low | Add storage event listener to sync sort mode across open tabs in real-time |
| 2 | Persist other filter/view state | Medium | Medium | Extend localStorage persistence to full filter state for seamless browsing experience |
| 3 | Sort history or "recently used sorts" | Low | Low | Track last 3-5 sort selections for quick access via dropdown |
| 4 | User preference settings page | Low | Medium | Add settings page for managing persisted preferences with toggles and reset options |

### Follow-up Stories Suggested

- [ ] WISH-2015a: Real-time Multi-Tab Sync (storage event listener for cross-tab updates)
- [ ] WISH-2015b: Full Filter State Persistence (extend to all filter/view state)
- [ ] WISH-2015c: Sort History / Recently Used Sorts (LRU dropdown enhancement)
- [ ] WISH-2015d: User Preferences Settings Page (comprehensive preference management UI)

### Items Marked Out-of-Scope

- **Server-side preference storage**: Deferred to Phase 6 (User Preferences Backend) - enables multi-device sync via Cognito
- **Multi-device sync**: Deferred to Phase 6 with Cognito user profiles
- **Real-time cross-tab sync**: Deferred to follow-up story (storage event listener approach)
- **Sort mode analytics**: Deferred to future story following WISH-2005g pattern
