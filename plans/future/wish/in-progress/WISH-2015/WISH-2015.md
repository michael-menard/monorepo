---
doc_type: story
title: "WISH-2015: Form Autosave to localStorage"
story_id: WISH-2015
story_prefix: WISH
status: ready-to-work
follow_up_from: WISH-2002
phase: 4
created_at: "2026-01-27T00:00:00-07:00"
updated_at: "2026-01-28T00:00:00-07:00"
depends_on: [WISH-2002]
estimated_points: 2
---

# WISH-2015: Form Autosave to localStorage

## Follow-up Context

**Parent Story:** WISH-2002: Add Item Flow
**Source:** QA Discovery Notes - Gaps Addressed
**Original Finding:** Form autosave to localStorage - save form draft during typing, restore on page reload. Prevents data loss.
**Category:** Gap
**Impact:** Medium - improves user experience and prevents frustration from lost data
**Effort:** Low - straightforward localStorage integration with existing form

## Context

Users creating wishlist items may lose their work if they accidentally navigate away, refresh the page, or experience a browser crash while filling out the add item form. This is particularly frustrating when they've already uploaded an image or filled in many fields. An autosave feature would preserve form state in the browser's localStorage and restore it when they return to the form.

This enhancement builds on the form infrastructure from WISH-2002 and adds resilience to the user experience without requiring backend changes.

## Goal

Automatically save form state during user input and restore it when the user returns to the form, preventing data loss from accidental navigation or browser issues.

## Non-goals

- Not re-implementing the form submission logic from WISH-2002
- Not implementing server-side draft storage (using localStorage only)
- Not implementing cross-device draft synchronization
- Not implementing draft expiration or cleanup (user can manually clear)
- Not implementing autosave for edit form (edit already loads from server)
- Not supporting multiple currencies (all prices stored in USD; assumption documented)

## Scope

**Pages Affected:**
- `apps/web/app-wishlist-gallery/src/pages/AddItemPage.tsx`

**Components Affected:**
- `apps/web/app-wishlist-gallery/src/components/WishlistForm.tsx`
- `apps/web/app-wishlist-gallery/src/hooks/useFormAutosave.ts` (new)

**Packages Affected:**
- `apps/web/app-wishlist-gallery`

## Acceptance Criteria

- [ ] Form state is saved to localStorage on every field change (debounced 500ms)
- [ ] Saved state includes all form fields except image (S3 URL saved but not binary data)
- [ ] When user returns to add item page, form auto-populates from localStorage
- [ ] "Resume draft" banner shows when restoring from localStorage with option to "Start fresh"
- [ ] Draft is cleared from localStorage on successful form submission
- [ ] Draft is cleared when user clicks "Start fresh"
- [ ] localStorage key is scoped to user ID extracted from Cognito JWT token (different users don't share drafts)
- [ ] Image URL from localStorage is validated (S3 presigned URLs may expire)
- [ ] Form debounce prevents excessive localStorage writes (max 2 writes/second)
- [ ] **[QA Gap #3]** releaseDate field exists in form and is included in autosaved draft when present
- [ ] **[QA Gap #4]** User ID is extracted from Cognito JWT token in auth context for localStorage key scoping
- [ ] **[QA Gap #1]** Playwright E2E tests verify autosave/restore flow: (1) typing triggers autosave, (2) page reload restores draft, (3) successful submit clears draft, (4) "Start fresh" clears draft

## Reuse Plan

- Builds on `WishlistForm` component from WISH-2002
- Leverages existing form state management from WISH-2002
- Uses standard browser localStorage API (no additional dependencies)
- Can reuse debounce utility from `@repo/core/utils` if available

## Architecture Notes

**localStorage Key Structure:**
```
wishlist:draft:${userSub}:add-item
```
Where `userSub` is extracted from the Cognito JWT token in the auth context.

**Auth Integration:**
- Extract user `sub` claim from Cognito JWT token (available via auth context from WISH-2002)
- Fall back to disabling autosave if `sub` is unavailable
- This ensures different users don't share drafts on shared devices

**Stored Data Shape:**
```typescript
{
  timestamp: number,
  formData: {
    title: string,
    store: string,
    setNumber?: string,
    sourceUrl?: string,
    imageUrl?: string,
    price?: number,  // USD always
    pieceCount?: number,
    releaseDate?: string,
    tags?: string[],
    priority?: number,
    notes?: string
  }
}
```

**Restoration Logic:**
1. On mount, extract `userSub` from Cognito JWT token
2. Check localStorage for key `wishlist:draft:${userSub}:add-item`
3. If found and timestamp < 7 days old, show "Resume draft" banner
4. User can accept (populate form) or decline (clear localStorage)
5. Validate imageUrl if present (may be expired S3 URL)

## Test Plan

### Happy Path

1. User starts filling out add item form
2. User types in title field
3. Form state saves to localStorage after 500ms debounce
4. User accidentally closes browser tab
5. User navigates back to add item page
6. "Resume draft" banner appears
7. User clicks "Resume draft"
8. Form populates with saved data
9. User completes form and submits
10. Draft is cleared from localStorage

### Error Cases

1. **Expired image URL**: If imageUrl in draft is expired, show warning and allow user to re-upload
2. **localStorage full**: If localStorage quota exceeded, show warning but don't block form submission
3. **Invalid JSON**: If stored data is corrupted, silently clear and show fresh form
4. **User switched accounts**: If userId in key doesn't match current user, don't restore draft

### Edge Cases

1. **Multiple tabs**: If user has multiple tabs open, last write wins (acceptable tradeoff)
2. **Old drafts**: Drafts older than 7 days are ignored but not auto-deleted
3. **Rapid typing**: Debounce ensures localStorage writes don't block UI thread
4. **Form validation errors**: Draft saves even with validation errors present

## Risks / Edge Cases

1. **localStorage quota limits**: Browser localStorage typically 5-10MB, should be sufficient for form data
2. **S3 URL expiration**: Presigned URLs from previous session may be expired; need validation
3. **Race conditions**: Multiple tabs could overwrite each other; document as known limitation
4. **Privacy**: Form data stored in plaintext in localStorage; acceptable for non-sensitive wishlist data

## Open Questions

None - all requirements are clear and non-blocking.

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Missing test specification | Add as AC | Added AC requiring Playwright E2E tests for autosave/restore flow (typing triggers autosave, reload restores draft, submit clears draft, start fresh clears draft) |
| 2 | Missing currency field | Out-of-scope | All currency is USD; removed currency from stored data shape; documented USD assumption in non-goals section |
| 3 | Missing release date field | Add as AC | Added AC to verify releaseDate field exists in form and is included in autosaved draft when present |
| 4 | Missing userId extraction | Add as AC | Updated to use Cognito JWT user `sub` for user identification instead of generic userId pattern |
| 5 | Auth context integration (MVP-Critical) | Add as AC | Added AC to extract user `sub` from Cognito JWT token for localStorage key scoping; updated Architecture Notes with auth integration pattern |

### Enhancement Opportunities

None identified.

### Follow-up Stories Suggested

None at this time.

### Items Marked Out-of-Scope

- **Multiple currency support**: All prices stored in USD. Currency field removed from stored data shape. This is acceptable for MVP as the platform operates in USD only.
