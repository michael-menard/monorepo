---
doc_type: story
title: "WISH-2047: IP/Geolocation Logging for Authorization Events"
story_id: WISH-2047
story_type: infra
story_prefix: WISH
status: uat
phase: 5
created_at: "2026-01-28T00:00:00-07:00"
updated_at: "2026-01-31T17:35:00Z"
depends_on: [WISH-2008]
follow_up_from: WISH-2008
priority: P2
estimated_points: 2
sizing_warning: false
---

# WISH-2047: IP/Geolocation Logging for Authorization Events - Phase 5 Observability

## Follow-up Context

**Parent Story**: WISH-2008 (Authorization Layer Testing and Policy Documentation)

**Source**: QA Discovery Notes - Enhancement Opportunity #9

**Original Finding**: IP/geolocation logging for suspicious access patterns - Log IP address and country for 403/404 events to detect suspicious access patterns

**Category**: Enhancement Opportunity

**Impact**: Medium (Security observability improvement)

**Effort**: Medium (IP extraction + geolocation lookup + log enrichment)

## Context

WISH-2008 implemented comprehensive authorization testing and audit logging for all wishlist endpoints, logging unauthorized access attempts (403/404 responses) with userId, itemId, endpoint, and timestamp. However, the logs do not include IP address or geographic location information, which limits the ability to detect and respond to suspicious access patterns such as:

- Brute-force attacks from specific IP ranges
- Credential stuffing attempts from known bot networks
- Geographic anomalies (e.g., user accessing from multiple countries simultaneously)
- Distributed denial-of-service (DDoS) patterns
- Account takeover attempts

By enriching authorization failure logs with IP address and geolocation data (country, region, city), security teams and automated monitoring systems can identify and mitigate threats more effectively.

**Dependency Context:**
- WISH-2008: Audit logging for 403/404 events already implemented with structured JSON format
- Rate limiting (AC 24 in WISH-2008): IP-based rate limiting already tracks IP addresses
- CloudWatch Logs: Existing log aggregation infrastructure for structured logs

## Goal

Enrich authorization failure audit logs (403/404 events) with IP address and geolocation data (country, region, city) to enable detection of suspicious access patterns, geographic anomalies, and potential security threats through CloudWatch Logs Insights queries and monitoring dashboards.

## Non-goals

- Real-time threat detection or automated IP blocking - deferred to future security automation story
- VPN/proxy detection - out of scope for MVP
- IP reputation scoring (e.g., checking against threat intelligence feeds) - deferred to Phase 6
- Historical geolocation analysis dashboard - deferred to Phase 5 audit log viewer UI (WISH-XXXX)
- GDPR compliance review for IP logging - assumes existing privacy policy covers logging for security purposes
- IPv6 geolocation (focus on IPv4 for MVP, IPv6 support deferred if needed)
- ISP/ASN information - country/region/city sufficient for MVP
- Custom geolocation database updates - use publicly available MaxMind GeoLite2 database

## Scope

### Endpoints Affected

**All Wishlist Endpoints** (inherits from WISH-2008):
- \`GET /api/wishlist\` - Log IP for userId filtering failures
- \`GET /api/wishlist/:id\` - Log IP for cross-user access attempts
- \`POST /api/wishlist\` - Log IP for unauthenticated requests
- \`PATCH /api/wishlist/:id\` - Log IP for cross-user update attempts
- \`DELETE /api/wishlist/:id\` - Log IP for cross-user delete attempts
- \`PUT /api/wishlist/reorder\` - Log IP for unauthorized reorder attempts
- \`POST /api/wishlist/:id/purchased\` - Log IP for cross-user purchase attempts
- \`GET /api/wishlist/images/presign\` - Log IP for unauthorized presigned URL requests

**Note**: IP logging applies only to 403/404 responses (authorization failures), not successful 200/201 requests (privacy consideration).

### Packages Affected

1. **Backend - Observability**: \`apps/api/lego-api/core/observability/\`
   - \`logger.ts\` - Add IP extraction utility and geolocation enrichment
   - **Changes**: New functions \`extractClientIp()\` and \`enrichWithGeolocation()\`

2. **Backend - Middleware**: \`apps/api/lego-api/middleware/\`
   - \`auth.ts\` - Extract IP from request headers and attach to context
   - \`rate-limit.ts\` - Reuse IP extraction logic from auth middleware
   - **Changes**: Refactor IP extraction into shared utility

3. **Backend - Geolocation Service**: \`apps/api/lego-api/core/geolocation/\`
   - \`geoip.ts\` - New geolocation lookup service using MaxMind GeoLite2
   - \`types.ts\` - Zod schemas for geolocation data
   - **Changes**: New files (~200 lines)

4. **Backend - Wishlist Domain**: \`apps/api/lego-api/domains/wishlist/\`
   - \`routes.ts\` - Pass IP from context to logger
   - **Changes**: Minor updates to pass IP through to logging calls

5. **Infrastructure - Lambda Layer**: \`apps/api/platforms/aws/layers/\`
   - Add MaxMind GeoLite2 database to Lambda layer for offline lookups
   - **Changes**: Update layer build script to include .mmdb file

### Infrastructure Impact

**New Dependencies:**
- \`@maxmind/geoip2-node\` - MaxMind GeoIP2 Node.js SDK (MIT license)
- MaxMind GeoLite2 Country/City database (free tier, updated monthly)

**Lambda Configuration:**
- Environment variable: \`GEOIP_DATABASE_PATH=/opt/geolite2-city.mmdb\`
- Lambda layer size increase: ~50 MB (GeoLite2 database)
- Memory increase: +128 MB for in-memory database caching

**CloudWatch Logs:**
- No schema changes (log format remains JSON)
- Additional fields: \`ip\`, \`country\`, \`region\`, \`city\`, \`latitude\`, \`longitude\`

## Acceptance Criteria

### AC1: IP address extraction from request headers
**Requirement:**
- Extract client IP from \`X-Forwarded-For\` header (API Gateway/CloudFront)
- Fallback to \`X-Real-IP\` header if \`X-Forwarded-For\` unavailable
- Fallback to \`req.socket.remoteAddress\` if no headers present
- Handle comma-separated IP lists (take leftmost/original client IP)

**Evidence:** Unit tests for IP extraction with various header combinations

---

### AC2: Geolocation lookup using MaxMind GeoLite2
**Requirement:**
- Install \`@maxmind/geoip2-node\` package
- Download MaxMind GeoLite2 City database (.mmdb file)
- Implement geolocation lookup function returning country, region, city, lat/long
- Cache database in memory for Lambda warm starts (singleton pattern)

**Evidence:** Unit tests with known IP addresses (e.g., 8.8.8.8 â†’ US)

---

### AC3: Enriched log format for 403/404 events
**Requirement:**
- Extend existing audit log structure from WISH-2008
- Add fields: \`ip\`, \`country\`, \`region\`, \`city\`, \`latitude\`, \`longitude\`
- Fallback gracefully if geolocation lookup fails (log IP only)

**Evidence:** Integration tests verify log entries include geolocation fields

---

### AC4: Privacy-conscious logging (403/404 only)
**Requirement:**
- IP/geolocation logging ONLY for authorization failures (403/404)
- NO IP logging for successful requests (200/201) to minimize PII collection
- Document privacy rationale in security policy

**Verification:**
- Successful GET /api/wishlist requests do NOT log IP/geolocation
- Failed GET /api/wishlist/456 (cross-user) logs IP/geolocation

**Evidence:** Integration tests verify IP logged only on 403/404, not 200/201

---

### AC5: CloudWatch Logs Insights query examples
**Requirement:**
- Document CloudWatch Logs Insights queries for common security patterns
- Include queries in security policy document

**Evidence:** Queries documented in \`wishlist-authorization-policy.md\`

---

### AC6: Lambda layer includes GeoLite2 database
**Requirement:**
- Download MaxMind GeoLite2 City database (.mmdb file)
- Include database in Lambda layer build script
- Set environment variable \`GEOIP_DATABASE_PATH\` in Lambda configuration

**Evidence:** Layer deployment includes .mmdb file, Lambda environment variable set

---

### AC7: Geolocation lookup performance < 10ms
**Requirement:**
- Geolocation lookup adds minimal latency to authorization failures
- In-memory database caching for Lambda warm starts
- Fallback to logging IP only if lookup takes > 10ms

**Evidence:** Unit tests verify lookup latency < 10ms

---

### AC8: Error handling for geolocation failures
**Requirement:**
- If geolocation lookup fails (invalid IP, database unavailable), log IP without geolocation
- Log warning for geolocation failures (not error, non-critical)
- Authorization logic NOT blocked by geolocation failures

**Evidence:** Integration tests with invalid IPs verify graceful fallback

---

### AC9: Integration with rate limiting (WISH-2008 AC 24)
**Requirement:**
- Reuse IP extraction logic from rate limiting middleware (WISH-2008 AC 24)
- Ensure IP extraction is consistent across rate limiting and audit logging
- No duplicate IP extraction logic

**Refactoring:**
- Extract IP utility function into \`apps/api/lego-api/core/utils/ip.ts\`
- Import in both \`auth.ts\` and \`rate-limit.ts\`

**Evidence:** Code review confirms shared utility, no duplication

---

### AC10: Unit tests for IP extraction utility
**Minimum Coverage:**
- X-Forwarded-For header with single IP
- X-Forwarded-For header with comma-separated IPs
- X-Real-IP header fallback
- Socket remoteAddress fallback
- No headers present (returns null)
- IPv4 and IPv6 addresses

**Test File:** \`apps/api/lego-api/core/utils/__tests__/ip.test.ts\`

**Evidence:** 6+ unit tests passing

---

### AC11: Integration tests for enriched logs
**Minimum Coverage:**
- Cross-user GET access logs IP/geolocation
- Cross-user PATCH access logs IP/geolocation
- Unauthenticated request logs IP/geolocation
- Successful request does NOT log IP/geolocation

**Test File:** \`__http__/wishlist-ip-geolocation-logging.http\` (extends \`wishlist-authorization.http\`)

**Evidence:** 4+ integration tests verify log enrichment

---

### AC12: Update security policy documentation
**Requirement:**
- Add section to \`wishlist-authorization-policy.md\` (from WISH-2008)
- Document IP/geolocation logging for 403/404 events
- Include privacy rationale (security purposes only, 403/404 only)
- Document CloudWatch Logs Insights query examples

**Evidence:** Documentation section added and reviewed

---

## Reuse Plan

### Existing Components (Extended)
- **Logger utility** (\`@repo/logger\`) - Extend with IP/geolocation enrichment
- **Auth middleware** (\`auth.ts\`) - Extract IP from headers and attach to context
- **Rate limiting middleware** (\`rate-limit.ts\`) - Reuse IP extraction logic
- **Audit logging** (WISH-2008) - Extend log format with IP/geolocation fields
- **CloudWatch Logs** - Existing log aggregation infrastructure

### New Components
- **Geolocation service** (\`apps/api/lego-api/core/geolocation/geoip.ts\`) - MaxMind GeoIP2 lookup
- **IP extraction utility** (\`apps/api/lego-api/core/utils/ip.ts\`) - Shared IP extraction logic
- **GeoLite2 database** - Lambda layer includes .mmdb file
- **CloudWatch Logs Insights queries** - Documented security query examples

### Existing Patterns
- **Zod schema validation** - Define schemas for \`GeolocationData\` type
- **Structured logging** - Reuse JSON log format from WISH-2008
- **Lambda layers** - Include GeoLite2 database in standard layer
- **Environment variables** - Configure \`GEOIP_DATABASE_PATH\` for Lambda

## Test Plan

### Backend Unit Tests (10+ Tests)

**IP Extraction Tests** (\`apps/api/lego-api/core/utils/__tests__/ip.test.ts\`):
1. Extract IP from \`X-Forwarded-For\` header (single IP)
2. Extract IP from \`X-Forwarded-For\` header (comma-separated list, take first)
3. Extract IP from \`X-Real-IP\` header (fallback)
4. Extract IP from \`req.socket.remoteAddress\` (fallback)
5. Return null if no IP sources available
6. Handle IPv4 addresses correctly
7. Handle IPv6 addresses correctly

**Geolocation Lookup Tests** (\`apps/api/lego-api/core/geolocation/__tests__/geoip.test.ts\`):
8. Lookup known IP (8.8.8.8) returns US geolocation
9. Lookup invalid IP returns null gracefully
10. Lookup performance < 10ms (warm cache)
11. Database initialization singleton pattern
12. Error handling for missing database file

**Logger Enrichment Tests** (\`apps/api/lego-api/core/observability/__tests__/logger.test.ts\`):
13. Enrich log with IP and geolocation fields
14. Fallback to IP-only if geolocation lookup fails
15. Privacy check: IP logged only for 403/404, not 200/201

---

### Backend Integration Tests (5+ Tests)

**HTTP Test File:** \`__http__/wishlist-ip-geolocation-logging.http\`

**Enriched Logging Tests:**
1. Cross-user GET access logs IP/geolocation (404 response)
2. Cross-user PATCH access logs IP/geolocation (404 response)
3. Unauthenticated request logs IP/geolocation (401 response)
4. Successful GET request does NOT log IP/geolocation (200 response, privacy check)
5. Invalid IP address logs IP only (geolocation null)

**CloudWatch Logs Verification:**
6. Verify log structure includes \`ip\`, \`country\`, \`region\`, \`city\` fields
7. Run CloudWatch Logs Insights query to count failed attempts by country

---

### Manual QA Testing

**QA Test Scenarios:**
1. **IP Extraction Verification:**
   - QA makes API request with \`X-Forwarded-For\` header
   - QA verifies CloudWatch log includes correct IP address
   - QA tests with comma-separated IP list, verifies leftmost IP extracted

2. **Geolocation Accuracy:**
   - QA makes unauthorized request from known location
   - QA verifies CloudWatch log includes correct country/city
   - QA tests with VPN (different country), verifies geolocation reflects VPN exit node

3. **Privacy Compliance:**
   - QA makes successful GET request (200 OK)
   - QA verifies CloudWatch log does NOT include IP/geolocation
   - QA makes failed request (404), verifies IP/geolocation logged

4. **CloudWatch Logs Insights Queries:**
   - QA runs documented query examples
   - QA verifies query results include IP/geolocation data
   - QA tests "Top attacking IPs" query with multiple failed attempts

---

## Risks & Mitigations

### MVP-Critical Risks

**Risk 1: MaxMind GeoLite2 Database Unavailable**
- **Severity:** Medium (graceful degradation available)
- **Likelihood:** Low
- **Mitigation:** Fallback to logging IP only if database unavailable or lookup fails
- **Verification:** Unit tests verify fallback behavior

**Risk 2: Lambda Layer Size Limit**
- **Severity:** Low (GeoLite2 database ~50 MB, well under 250 MB limit)
- **Likelihood:** Low
- **Mitigation:** Use GeoLite2-City database, not larger GeoIP2-City (commercial)
- **Verification:** Layer deployment succeeds in CI/CD

**Risk 3: Geolocation Lookup Performance Impact**
- **Severity:** Medium (could slow authorization failures)
- **Likelihood:** Low
- **Mitigation:** In-memory database caching, async lookup (non-blocking)
- **Verification:** Unit tests verify lookup < 10ms

**Risk 4: GDPR Compliance for IP Logging**
- **Severity:** High (privacy violation)
- **Likelihood:** Low
- **Mitigation:** Log IP only for security purposes (legitimate interest), only for 403/404
- **Verification:** Privacy policy review, legal sign-off

### Non-MVP Risks (Future Work)

- **MaxMind database updates** - Deferred to future automation story
- **IPv6 geolocation accuracy** - IPv4 prioritized for MVP
- **VPN/proxy detection** - Deferred to Phase 6 security enhancements
- **IP reputation scoring** - Deferred to threat intelligence integration

## Open Questions

### Q1: Should IP/geolocation be logged for successful requests (200/201) as well?

**Decision:** No (privacy-conscious logging for 403/404 only)

**Rationale:** Logging IP for all requests increases PII collection without proportional security benefit. Authorization failures (403/404) are the primary security signal.

---

### Q2: Should we use GeoLite2-Country (3 MB) or GeoLite2-City (50 MB)?

**Decision:** GeoLite2-City (50 MB)

**Rationale:** City-level precision enables better anomaly detection (e.g., user accessing from San Francisco then New York within 1 hour). Lambda layer size limit (250 MB) accommodates 50 MB database.

---

### Q3: How should we handle IPv6 geolocation?

**Decision:** Best-effort IPv6 support via GeoLite2 database

**Rationale:** GeoLite2 City database includes IPv6 lookup support. MaxMind SDK handles IPv4/IPv6 transparently.

---

## Definition of Done

- [ ] All 12 Acceptance Criteria pass
- [ ] Backend: 15+ unit tests for IP extraction, geolocation lookup, and logger enrichment
- [ ] Backend: 5+ integration tests for enriched logging (HTTP file)
- [ ] MaxMind GeoLite2 database included in Lambda layer
- [ ] CloudWatch Logs Insights query examples documented
- [ ] Security policy updated with IP/geolocation logging section
- [ ] Integration with rate limiting (shared IP extraction utility)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved
- [ ] QA verification complete (manual testing with CloudWatch Logs)
