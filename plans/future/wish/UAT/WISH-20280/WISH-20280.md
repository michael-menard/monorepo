---
doc_type: story
title: "WISH-20280: Audit Logging for Flag Schedule Operations"
story_id: WISH-20280
story_prefix: WISH
status: uat
phase: 4
priority: P2
created_at: "2026-02-09T00:00:00-07:00"
updated_at: "2026-02-10T04:35:00Z"
depends_on: [WISH-2119]
follow_up_from: WISH-2119
estimated_points: 2
sizing_warning: false
experiment_variant: control
---

# WISH-20280: Audit Logging for Flag Schedule Operations

## Follow-up Context

**Parent Story:** WISH-2119 (Flag scheduling infrastructure)
**Source:** QA Discovery Notes - Follow-up Stories Suggested (Finding #7)
**Original Finding:** "Integration with audit logging to track which admin created/cancelled schedules"
**Category:** Enhancement Opportunity (Security & Compliance)
**Impact:** Medium (Security observability and admin accountability)
**Effort:** Low (Extends existing patterns from admin domain)

**Dependency Clarification:**
The original follow-up reference mentioned "WISH-2019 (audit logging infrastructure)" but WISH-2019 is actually about Redis caching, not audit logging. The actual audit infrastructure exists in the admin domain (`apps/api/lego-api/domains/admin/`, `admin_audit_log` table patterns). This story creates a new lightweight audit logger in `core/audit/` that adapts admin domain patterns for schedule operations.

---

## Context

WISH-2119 implements scheduled flag updates with admin endpoints for creating, listing, and cancelling schedules. However, it lacks audit trail for admin actions - there's no record of which admin created or cancelled a schedule, creating accountability gaps for security audits and incident investigations.

The admin domain already provides audit logging infrastructure (`admin_audit_log` table, AuditLogRepository pattern) that tracks admin user management operations. This story extends similar patterns to flag schedule operations, providing security observability and compliance.

**Problem:**
- No database tracking of which admin created/cancelled schedules
- No structured CloudWatch logs for schedule operations
- No audit trail for cron job automatic schedule applications
- Security and compliance gap for incident investigations

**Proposed Solution:**
1. **Database Schema Updates**: Add `created_by`, `cancelled_by`, `cancelled_at` columns to `feature_flag_schedules` table
2. **Audit Logging Service**: Create lightweight audit logger in `apps/api/lego-api/core/audit/` for schedule events (separate from admin domain)
3. **Service Layer Integration**: Update schedule service to log events before database commits
4. **Cron Job Logging**: Log automatic schedule application/failure events
5. **Admin Context Flow**: Extract admin user from JWT claims → routes → service → database

---

## Goal

Add comprehensive audit logging to flag schedule operations (create, cancel) to provide security observability and admin accountability, enabling investigation of schedule-related incidents and compliance with audit requirements.

---

## Non-goals

1. **Audit UI/Dashboard** - Defer to future admin dashboard story (read-only query interface)
2. **Audit log retention policy** - Defer to separate infrastructure story
3. **Audit log export API** - Defer to future story
4. **Real-time audit alerts** - CloudWatch logs only in MVP
5. **Schedule modification audit** - MVP only tracks create/cancel, not updates
6. **Bulk operation audit** - Single-schedule operations only
7. **Reusing admin domain audit table** - Create separate audit service for schedule domain (CloudWatch only, no database persistence in MVP)

---

## Scope

### Endpoints Affected

**Modified Endpoints:**
- `POST /api/admin/flags/:flagKey/schedule` - Add audit logging on schedule creation
- `DELETE /api/admin/flags/:flagKey/schedule/:scheduleId` - Add audit logging on schedule cancellation
- `GET /api/admin/flags/:flagKey/schedule` - Return admin tracking fields in response

**No New Endpoints** - Extends existing WISH-2119 endpoints only

---

### Packages Affected

1. **Backend - Config Domain**: `apps/api/lego-api/domains/config/`
   - `application/schedule-service.ts` - Add audit logging calls (modify)
   - `adapters/schedule-repository.ts` - Update INSERT/UPDATE queries for admin tracking columns (modify)
   - `routes.ts` - Pass admin user ID to service layer (modify)
   - `types.ts` - Extend schedule Zod schemas with admin tracking fields (modify)

2. **Backend - Audit Infrastructure**: `apps/api/lego-api/core/audit/` (NEW)
   - `audit-logger.ts` - Lightweight CloudWatch logger for schedule events (new)
   - `types.ts` - Audit event type definitions and Zod schemas (new)
   - `__tests__/audit-logger.test.ts` - Unit tests for audit service (new)

3. **Cron Job**: `apps/api/lego-api/jobs/`
   - `process-flag-schedules.ts` - Add audit logging for applied/failed events (modify)

4. **Database Schema**: `packages/backend/database-schema/`
   - `src/schema/feature-flags.ts` - Add created_by, cancelled_by, cancelled_at columns to schedules table (modify)
   - `src/migrations/app/` - Migration for new columns (new)

5. **Shared Schemas**: `packages/core/api-client/src/schemas/`
   - `feature-flags.ts` - Update schedule schemas with admin tracking fields (modify)

---

### Database Schema Changes

**Add to feature_flag_schedules table:**
```sql
ALTER TABLE feature_flag_schedules
  ADD COLUMN created_by VARCHAR(255),
  ADD COLUMN cancelled_by VARCHAR(255),
  ADD COLUMN cancelled_at TIMESTAMP WITH TIME ZONE;
```

**Audit Event Types (CloudWatch only):**
- `flag_schedule.created` - Admin created schedule
- `flag_schedule.cancelled` - Admin cancelled schedule
- `flag_schedule.applied` - Cron job applied schedule (automatic)
- `flag_schedule.failed` - Cron job failed to apply schedule (automatic)

---

## Acceptance Criteria

### Database Schema Updates

**AC1**: Add admin tracking columns to schedules table
- Migration adds `created_by`, `cancelled_by`, `cancelled_at` columns
- `created_by` populated on POST schedule (admin user ID from JWT)
- `cancelled_by` populated on DELETE schedule (admin user ID from JWT)
- `cancelled_at` populated on DELETE schedule (timestamp of cancellation)
- All columns nullable (backward compatibility with existing schedules)
- Migration applied before deploying code changes

---

### Audit Logging Integration

**AC2**: Log schedule creation events
- Event type: `flag_schedule.created`
- Metadata: `{ scheduleId, flagKey, scheduledAt, updates, adminUserId, adminEmail }`
- Log level: INFO
- CloudWatch structured log format
- Integration test: Create schedule, verify audit event logged with correct metadata

**AC3**: Log schedule cancellation events
- Event type: `flag_schedule.cancelled`
- Metadata: `{ scheduleId, flagKey, scheduledAt, adminUserId, adminEmail, reason: "manual_cancellation" }`
- Log level: INFO
- CloudWatch structured log format
- Integration test: Cancel schedule, verify audit event logged with correct metadata

**AC4**: Log schedule application events (cron job)
- Event type: `flag_schedule.applied`
- Metadata: `{ scheduleId, flagKey, updates, appliedAt, flagState: { enabled, rolloutPercentage } }`
- Log level: INFO
- No admin user (automatic process)
- Integration test: Cron job applies schedule, verify audit event logged

**AC5**: Log schedule failure events (cron job)
- Event type: `flag_schedule.failed`
- Metadata: `{ scheduleId, flagKey, errorMessage, failedAt }`
- Log level: ERROR
- No admin user (automatic process)
- Integration test: Simulate cron failure, verify audit event logged

---

### Service Layer Updates

**AC6**: Pass admin user context to service layer
- Routes extract admin user ID from JWT claims
- Routes pass `adminUserId` and `adminEmail` to service methods
- Service methods accept optional admin context parameters
- Service methods persist admin user to database columns
- Unit test: Verify service persists created_by and cancelled_by

**AC7**: Audit service integration
- Service layer calls audit logger before database commit
- Audit events include all required metadata fields
- Audit logging errors do NOT fail schedule operations (fire-and-forget)
- Log audit logging failures to CloudWatch for monitoring
- Unit test: Verify audit logger called with correct parameters

---

### API Response Updates

**AC8**: Include admin tracking in API responses
- GET /api/admin/flags/:flagKey/schedule returns created_by, cancelled_by, cancelled_at
- Response schema updated: `ScheduleResponseSchema` with new fields
- All fields nullable (backward compatibility)
- Integration test: Create and cancel schedule, verify fields in GET response

---

### Schema & Types

**AC9**: Update Zod schemas for schedules
- `ScheduleSchema` extended with `createdBy`, `cancelledBy`, `cancelledAt` (all optional)
- `ScheduleResponseSchema` includes new fields in API responses
- Type inference: `type Schedule = z.infer<typeof ScheduleSchema>`
- Schema alignment test: Frontend ↔ backend schemas match

**AC10**: Frontend/backend schema alignment
- Backend schemas updated in `apps/api/lego-api/domains/config/types.ts`
- Schemas re-exported in `packages/core/api-client/src/schemas/feature-flags.ts`
- Frontend imports from `@repo/api-client`
- Alignment test verifies schemas match

---

### Testing

**AC11**: Backend unit tests (minimum 8 new tests)
- Test: Create schedule logs audit event with correct metadata
- Test: Cancel schedule logs audit event with admin user
- Test: Cron job applies schedule logs automatic event (no admin)
- Test: Cron job failure logs error event
- Test: Audit logging failure does not fail schedule creation
- Test: created_by persisted to database on POST
- Test: cancelled_by persisted to database on DELETE
- Test: GET response includes admin tracking fields

**AC12**: Backend integration tests (HTTP file)
- File: `__http__/feature-flag-scheduling.http` (extend existing)
- Test: Create schedule, verify created_by in response
- Test: Cancel schedule, verify cancelled_by and cancelled_at in response
- Test: GET schedules, verify admin fields present
- CloudWatch logs verification (manual): Audit events appear in logs

**AC13**: Backward compatibility tests
- Test: Existing schedules (created_by = NULL) still function correctly
- Test: GET response handles NULL admin fields gracefully
- Test: Cron job processes schedules with NULL created_by

---

### Documentation

**AC14**: Update API documentation
- Document new response fields in API contract
- Document audit event types and metadata schemas
- Update HTTP examples with admin tracking fields
- Add CloudWatch Logs Insights query examples for audit trail

**AC15**: Update architecture documentation
- Document audit logging patterns in schedule service
- Document admin context flow (JWT → routes → service → database)
- Add audit event type reference

---

## Reuse Plan

### Existing Components

**From Admin Domain:**
- Audit logging patterns (`apps/api/lego-api/domains/admin/adapters/repositories.ts` - AuditLogRepository interface)
- Fire-and-forget audit pattern (errors don't fail operations)
- JWT claims extraction patterns (admin middleware)
- CloudWatch structured logging patterns

**From WISH-2119:**
- Schedule service (`apps/api/lego-api/domains/config/application/schedule-service.ts`)
- Schedule repository (`apps/api/lego-api/domains/config/adapters/schedule-repository.ts`)
- Schedule routes (`apps/api/lego-api/domains/config/routes.ts`)
- Cron job handler (`apps/api/lego-api/jobs/process-flag-schedules.ts`)

**From Shared Packages:**
- `@repo/logger` for CloudWatch structured logging
- `@repo/api-core` for Result types
- `drizzle-orm` for database migrations and schema

---

### New Components

**Audit Infrastructure:**
- `apps/api/lego-api/core/audit/audit-logger.ts` - Lightweight CloudWatch logger
- `apps/api/lego-api/core/audit/types.ts` - Event type definitions

**Database:**
- Migration script for admin tracking columns (3 nullable columns)

---

### Existing Patterns

**Architecture Patterns:**
- Hexagonal architecture (ports & adapters) - audit logger as port injected into service
- Zod-first type definitions (schemas before types)
- Result type pattern for error handling
- Fire-and-forget audit logging (errors don't fail operations)

**Service Layer Patterns:**
- Constructor injection for audit repository
- Admin context extraction from JWT
- Service orchestration (audit before database commit)

**Database Patterns:**
- Drizzle ORM schema definitions
- Migration pattern with timestamp-based filenames
- Nullable columns for backward compatibility

---

## Architecture Notes

### Hexagonal Architecture Compliance

**Service Layer (Application Core):**
- `schedule-service.ts` accepts optional `adminContext` parameter (userId, email)
- Service calls audit logger port before committing database transaction
- Service persists admin user to database columns
- No direct coupling to audit implementation details

**Adapter Layer (Infrastructure):**
- `schedule-repository.ts` updates INSERT/UPDATE queries to include created_by, cancelled_by
- `audit-logger.ts` implements audit port (CloudWatch adapter)
- Audit logger failure does not propagate to service layer (fire-and-forget)

**Routes Layer (API Gateway):**
- Extract admin context from JWT claims
- Pass admin context to service methods
- No audit logic in routes (orchestration only in service layer)

**Cron Job (Infrastructure):**
- Calls audit logger directly (no admin context)
- Logs `flag_schedule.applied` and `flag_schedule.failed` events

**No Architecture Violations:** Story extends existing patterns from WISH-2119 and admin domain without introducing new dependencies.

---

## Infrastructure Notes

### Audit Logging Service

**Implementation Approach:**
- Create new `apps/api/lego-api/core/audit/` directory (separate from admin domain)
- CloudWatch structured logging only (no database persistence in MVP)
- Use `@repo/logger` for structured logging
- Fire-and-forget error handling (audit failures don't block operations)

**Event Types:**
- `flag_schedule.created` - Admin created schedule
- `flag_schedule.cancelled` - Admin cancelled schedule
- `flag_schedule.applied` - Cron job applied schedule (automatic)
- `flag_schedule.failed` - Cron job failed to apply schedule (automatic)

**Event Metadata Schema:**
```typescript
const AuditEventSchema = z.object({
  eventType: z.enum(['flag_schedule.created', 'flag_schedule.cancelled', 'flag_schedule.applied', 'flag_schedule.failed']),
  timestamp: z.string().datetime(),
  metadata: z.object({
    scheduleId: z.string().uuid(),
    flagKey: z.string(),
    adminUserId: z.string().optional(), // Present for manual operations
    adminEmail: z.string().email().optional(), // Present for manual operations
    scheduledAt: z.string().datetime().optional(),
    updates: z.record(z.unknown()).optional(),
    appliedAt: z.string().datetime().optional(),
    failedAt: z.string().datetime().optional(),
    errorMessage: z.string().optional(),
    reason: z.string().optional(),
    flagState: z.object({
      enabled: z.boolean(),
      rolloutPercentage: z.number().optional(),
    }).optional(),
  }),
})
```

---

### CloudWatch Logs Insights

**Sample Queries for Audit Trail:**

Find all schedules created by specific admin:
```
fields @timestamp, scheduleId, flagKey, scheduledAt
| filter eventType = "flag_schedule.created"
| filter metadata.adminUserId = "admin-123"
| sort @timestamp desc
```

Find all cancelled schedules in time range:
```
fields @timestamp, scheduleId, flagKey, metadata.cancelledBy as cancelledBy
| filter eventType = "flag_schedule.cancelled"
| filter @timestamp >= "2026-01-01T00:00:00Z"
| sort @timestamp desc
```

Find all failed schedule applications:
```
fields @timestamp, scheduleId, flagKey, metadata.errorMessage as errorMessage
| filter eventType = "flag_schedule.failed"
| sort @timestamp desc
```

Audit trail for specific schedule:
```
fields @timestamp, eventType, metadata.adminUserId as adminUserId
| filter metadata.scheduleId = "schedule-uuid-here"
| sort @timestamp asc
```

---

## Test Plan

(See `_pm/TEST-PLAN.md` for comprehensive test scenarios)

### Scope Summary
- **Endpoints:** 2 endpoints modified (POST, DELETE schedule), 1 endpoint extended (GET schedule)
- **UI Touched:** No (backend only)
- **Data/Storage:** Yes (database columns, CloudWatch logs)
- **Infrastructure:** Audit logging service integration

### Happy Path Tests

1. **Create schedule with audit logging**: POST schedule as admin, assert created_by persisted and audit event logged
2. **Cancel schedule with audit logging**: DELETE schedule as admin, assert cancelled_by persisted and audit event logged
3. **Cron job applies schedule**: Trigger cron, assert applied event logged (no admin)
4. **GET schedules returns admin fields**: GET schedules, assert created_by, cancelled_by present in response

### Error Cases

1. **Audit logging failure**: Simulate audit service error, assert schedule creation still succeeds
2. **Missing admin context**: POST schedule without JWT claims, verify graceful handling
3. **Cron job failure**: Simulate database error, assert failed event logged with error message

### Edge Cases

1. **Backward compatibility**: GET schedule with NULL created_by (old data), assert response valid
2. **Multiple admins**: Create schedules with different admins, verify each admin tracked separately
3. **Admin cancels another admin's schedule**: Admin B cancels Admin A's schedule, verify cancelled_by = Admin B

### Required Tooling Evidence

**Backend HTTP Tests (`__http__/feature-flag-scheduling.http`):**
- Extend existing file with 3+ new requests
- Assert created_by, cancelled_by, cancelled_at fields in responses
- Manual verification: CloudWatch logs contain audit events

**Backend Unit Tests:**
- Minimum 8 new tests covering audit logging integration
- Mock audit logger to verify event metadata
- Verify database column persistence

**Backend Integration Tests:**
- Create and cancel schedules, verify admin fields in database
- Trigger cron job, verify automatic events logged

---

## Dev Feasibility Review

(See `_pm/DEV-FEASIBILITY.md` for detailed architecture review)

### Feasibility Summary

**Feasible for MVP:** Yes

**Confidence:** High

**Why:**
- Story extends well-established patterns from admin domain audit infrastructure and WISH-2119 schedule service
- No architecture changes required - fits within existing hexagonal architecture
- Clean separation of concerns - audit logging doesn't touch core schedule logic
- Database migration is backward-compatible (nullable columns)
- Fire-and-forget audit pattern proven in admin domain

### MVP-Critical Risks

**Risk 1: JWT Claims Missing Admin Context**
- Mitigation: Verify JWT structure early, add userId/email claims if missing
- Fallback: Log warning and set created_by = NULL if claims unavailable

**Risk 2: Audit Logging Errors Block Schedule Operations**
- Mitigation: Implement fire-and-forget pattern (wrap audit calls in try-catch)
- Follow admin domain pattern (proven implementation available)

**Risk 3: Database Migration Breaks Backward Compatibility**
- Mitigation: All admin tracking columns MUST be nullable
- Test: Insert schedule with NULL admin fields, verify GET response handles gracefully

---

## Risk Predictions

(Generated by pm-story-risk-predictor worker - WKFL-007)

**Split Risk:** 0.2 (Low)
- Reasoning: Backend-only story, extends proven patterns, small surface area (3 endpoints modified)
- Risk factors: 18 ACs suggest medium scope, but many are documentation/testing ACs

**Review Cycles:** 1-2 cycles
- Reasoning: Service layer integration straightforward, fire-and-forget pattern proven
- Potential friction: CloudWatch logs verification manual, audit event metadata structure needs review

**Token Estimate:** ~35,000 tokens
- Breakdown: Implementation (~20k), code review (~5k), rework (~10k)

**Confidence:** High
- Based on: WISH-2119 similarity (0.9), admin domain patterns, heuristic analysis

**Similar Stories:**
- WISH-2119 (Flag Scheduling Infrastructure) - 0.9 similarity, 2 review cycles, 45k tokens
- Admin domain audit logging - 0.85 similarity (reusable patterns)

---

## Future Opportunities

(See `_pm/FUTURE-RISKS.md` for detailed non-MVP enhancements)

### Post-MVP Enhancements

1. **Audit UI/Dashboard** (Phase 5): Build admin dashboard with audit log viewer, display schedule creator/canceller in UI
2. **Audit Log Retention Policy** (Phase 4): Define CloudWatch retention (e.g., 90 days), archive to S3 for long-term storage
3. **Audit Log Export API** (Phase 6): Build API for bulk export (CSV/JSON formats)
4. **Real-Time Audit Alerts** (Phase 7): Implement CloudWatch Alarms for suspicious patterns
5. **Schedule Modification Audit** (Phase 8): Extend audit logging to `flag_schedule.modified` events
6. **Bulk Operation Audit** (Future epic): Implement bulk event types with correlation IDs

---

## Open Questions

### Q1: Should audit events use existing `admin_audit_log` table or CloudWatch only?
**Resolution:** CloudWatch only in MVP (no database persistence). Defer database audit table to future story for cost and simplicity.

### Q2: Do admin JWTs include userId and email claims?
**Resolution Path:** Review auth middleware early in Phase 1, add claims if missing. Fallback: graceful degradation (NULL created_by).

### Q3: Should we audit schedule listing (GET) operations, or only mutations (POST/DELETE)?
**Resolution:** Only mutations in MVP (reduce log volume). Defer read operation auditing to Phase 9 or separate story.

---

## Definition of Done

- [ ] All 15 Acceptance Criteria pass
- [ ] Backend: 8+ unit tests pass (audit logging integration)
- [ ] Backend: HTTP integration tests pass (extended `.http` file)
- [ ] Database migration created and applied (admin tracking columns)
- [ ] Schema alignment test passes (frontend ↔ backend)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] CloudWatch logs verification: Audit events appear with correct metadata (manual check)
- [ ] Code review approved
- [ ] Story file and worker artifacts committed to git

---

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Generation | ~10k | — | — | PM leader + 3 workers |
| Elaboration | ~8k | — | — | Standard audit integration elaboration |
| Implementation | ~20k | — | — | Service updates + migration + tests |
| Code Review | ~5k | — | — | Small scope story |
| Rework | ~10k | — | — | Minor fixes (JWT claims, error handling) |
| **Total** | ~53k | — | — | Medium story (2 points) |

---

## Reality Baseline

### Existing Infrastructure Used

**Admin Domain Audit Patterns:**
- Location: `apps/api/lego-api/domains/admin/`
- AuditLogRepository interface pattern
- Fire-and-forget audit logging (errors don't fail operations)
- CloudWatch structured logging integration

**WISH-2119 Schedule Service:**
- Location: `apps/api/lego-api/domains/config/`
- Schedule service with hexagonal architecture
- Schedule repository for database operations
- Cron job for automatic schedule processing

**Database Schema:**
- Table: `feature_flag_schedules` (established in WISH-2119)
- Migration pattern: Drizzle ORM with timestamp-based filenames

---

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-02-09 19:15 | pm-story-generation-leader | Generated story from seed + worker artifacts | WISH-20280.md, TEST-PLAN.md, DEV-FEASIBILITY.md, FUTURE-RISKS.md |
| 2026-02-09 19:15 | pm-draft-test-plan | Drafted comprehensive test plan | _pm/TEST-PLAN.md |
| 2026-02-09 19:15 | pm-dev-feasibility-review | Reviewed dev feasibility (high confidence) | _pm/DEV-FEASIBILITY.md, _pm/FUTURE-RISKS.md |
| 2026-02-09 19:15 | pm-story-risk-predictor | Generated risk predictions (split_risk: 0.2, review_cycles: 1-2, tokens: 35k) | Predictions YAML (inline) |

---

**STORY COMPLETE - READY FOR BACKLOG**

---

## QA Discovery Notes (Auto-Generated)

_Added by Autonomous Elaboration on 2026-02-09_

### MVP Gaps Resolved

| # | Finding | Resolution | ACs Affected |
|---|---------|------------|-------------|
| None | No MVP-critical gaps identified | All 15 ACs cover complete audit logging journey | AC1-AC15 |

### Non-Blocking Items (Logged to KB)

| # | Finding | Category | Priority |
|---|---------|----------|----------|
| 1 | Audit event schema validation | Edge Cases | Post-MVP |
| 2 | Automated CloudWatch logs verification | Observability | Testing Infrastructure |
| 3 | Admin email fallback if JWT missing | Edge Cases | Post-MVP |
| 4 | Audit logger retry mechanism | Resilience | Post-MVP |
| 5 | Batch audit logging for cron job | Performance | Post-MVP |
| 6 | Audit log database persistence | Infrastructure | Phase 5+ |
| 7 | Admin dashboard audit viewer | UX Polish | Phase 6+ |
| 8 | Real-time audit alerts | Observability | Phase 7+ |
| 9 | Audit log export API | Integrations | Phase 6+ |
| 10 | Schedule modification audit | Feature Extension | Post-MVP |
| 11 | Audit event correlation IDs | Observability | Phase 8+ |
| 12 | Audit log retention policy | Infrastructure | Phase 4+ |
| 13 | User-friendly admin context in logs | UX Polish | Post-MVP |

### Implementation Refinements Required

| # | Refinement | Severity | Guidance |
|---|-----------|----------|----------|
| 1 | Define AuditLoggerPort interface | Medium | Create `AuditLoggerPort` interface in `apps/api/lego-api/core/audit/ports.ts` before implementation. Service layer should depend on interface, not concrete CloudWatch logger. Follow hexagonal pattern from admin domain. |
| 2 | Specify admin context extraction | Low | Explicitly reference auth middleware pattern in AC6 for extracting `userId` and `email` from JWT claims. See `apps/api/lego-api/middleware/auth.ts`. |
| 3 | Clarify schema alignment test | Low | Define Vitest schema comparison test in `packages/core/api-client/__tests__/schema-alignment.test.ts` for AC10 verification. |

### Summary

- **ACs Added**: 0 (story complete as written)
- **Non-Blocking Findings**: 13 (8 enhancements + 5 gaps, all logged to KB)
- **Implementation Refinements**: 3 (architectural clarifications, not scope changes)
- **Mode**: autonomous
- **Verdict**: CONDITIONAL PASS
