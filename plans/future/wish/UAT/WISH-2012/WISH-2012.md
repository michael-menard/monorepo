---
status: uat
created: 2026-01-28
updated_at: 2026-01-31
story_id: WISH-2012
title: Accessibility Testing Harness Setup
epic: Wishlist Feature
phase: 2 - Infrastructure
priority: P0
depends_on: [WISH-2001]
complexity: Small-Medium
effort: 1-2 points
---

# WISH-2012: Accessibility Testing Harness Setup

## Context

The wishlist feature includes accessibility requirements (WISH-2006) that are currently deferred to Phase 2 after core functionality is complete. Before accessibility work can begin, we need a comprehensive testing infrastructure to validate WCAG AA compliance and ensure keyboard navigation and screen reader support work correctly.

This story establishes the testing harness that will be used to verify accessibility throughout WISH-2006 implementation:

1. **axe-core Integration:** Automated WCAG AA violation detection in unit and integration tests
2. **Keyboard Navigation Testing:** Utilities for testing keyboard interaction patterns (tabindex, focus management)
3. **Screen Reader Testing:** Guides and mock utilities for screen reader compatibility testing
4. **Accessibility Fixtures:** Test data and configurations for repeatable a11y test scenarios

### Background

**Current State (WISH-2001 through WISH-2005):**
- Wishlist feature UI is implemented
- Accessibility is not yet tested
- No a11y testing infrastructure in place

**Accessibility Gaps Without This Story:**
- WCAG AA violations go undetected (color contrast, ARIA labels, semantic HTML)
- Keyboard navigation bugs only discovered by manual testing
- Screen reader support unmeasured and untested
- No automated CI/CD gates for accessibility compliance
- WISH-2006 has no testing framework to work with

**Why This Story Comes Before WISH-2006:**
- WISH-2006 work will be more efficient with testing infrastructure in place
- Developers can write tests alongside implementation
- CI/CD can enforce accessibility standards automatically
- Reduces manual QA burden

---

## Goal

Establish a comprehensive accessibility testing infrastructure that enables WISH-2006 implementation and provides automated WCAG AA compliance checking for the entire wishlist feature.

---

## Non-goals

- **Actual Accessibility Fixes:** This story sets up testing only; WISH-2006 implements fixes
- **Third-Party Tools:** Integration with paid accessibility testing services (e.g., Accessibility Insights, Deque axe Pro)
- **Internationalization Testing:** Language/locale-specific accessibility concerns defer to future stories
- **Mobile Accessibility:** Touch and mobile-specific a11y patterns defer to future stories
- **Advanced Testing:** Automated screen reader testing beyond mock utilities (complex infrastructure)

---

## Scope

### Packages Affected

- `apps/web/app-wishlist-gallery/src/test/` - Accessibility test utilities (new)
- `apps/web/app-wishlist-gallery/src/test/__tests__/` - a11y setup validation tests (new)
- `apps/web/app-wishlist-gallery/vitest.config.ts` - a11y plugin configuration (update)
- `packages/core/accessibility/` - Shared a11y utilities (enhance if needed)

### Files to Create

1. **Keyboard Navigation Test Utilities:**
   - `apps/web/app-wishlist-gallery/src/test/a11y/keyboard.ts` - Tab, Enter, Escape, arrow key helpers
   - `apps/web/app-wishlist-gallery/src/test/a11y/__tests__/keyboard.test.ts` - Utility tests

2. **axe-core Integration:**
   - `apps/web/app-wishlist-gallery/src/test/a11y/axe.ts` - axe-core setup and helpers
   - `apps/web/app-wishlist-gallery/src/test/a11y/__tests__/axe.test.ts` - Integration tests

3. **Accessibility Fixtures:**
   - `apps/web/app-wishlist-gallery/src/test/fixtures/a11y-mocks.ts` - Mock ARIA attributes, focus states
   - `apps/web/app-wishlist-gallery/src/test/fixtures/a11y-data.ts` - Test data with accessible labels

4. **Screen Reader Testing Guide:**
   - `apps/web/app-wishlist-gallery/docs/a11y-testing-guide.md` - Manual testing guide for screen readers

5. **Configuration:**
   - `apps/web/app-wishlist-gallery/src/test/a11y/config.ts` - WCAG level, exception rules, ignored elements

### Files to Modify

1. **Test Setup:**
   - `apps/web/app-wishlist-gallery/src/test/setup.ts` - Register axe-core and add a11y helpers
   - `apps/web/app-wishlist-gallery/vitest.config.ts` - Add axe-core plugin

---

## Acceptance Criteria

### AC1: axe-core Integration in Tests
**Given** axe-core integration is configured
**When** unit or integration tests run with accessibility checks enabled
**Then** axe-core automatically scans rendered components
**And** reports WCAG AA violations as test failures
**And** violations include rule ID, description, and suggested fix

### AC2: Keyboard Navigation Test Utilities
**Given** keyboard navigation utilities are implemented
**When** tests need to simulate keyboard interactions
**Then** utilities provide helpers for Tab, Shift+Tab, Enter, Escape, arrow keys
**And** helpers track focus movement and element state changes
**And** assertions validate expected focus order and behavior

### AC3: Screen Reader Announcements Testing
**Given** screen reader testing setup is available
**When** tests check for screen reader compatibility
**Then** utilities validate ARIA labels, live regions, and semantic HTML
**And** tests can assert expected announcements (role, state, properties)
**And** mock utilities simulate screen reader API access

### AC4: Focus Management Testing
**Given** focus management utilities are available
**When** tests verify focus behavior (modals, dropdowns, roving tabindex)
**Then** assertions validate initial focus placement
**And** assertions validate focus trap in modals
**And** assertions validate focus restoration on close

### AC5: Color Contrast Checking
**Given** axe-core integration includes color contrast rules
**When** components have text with colored backgrounds
**Then** axe-core automatically checks WCAG AA contrast ratio (4.5:1)
**And** violations report actual vs required contrast ratio
**And** suggestions include compliant color combinations

### AC6: ARIA Attribute Validation
**Given** ARIA validation utilities are available
**When** tests check ARIA attributes (aria-label, aria-labelledby, aria-live)
**Then** utilities validate ARIA attributes match element roles
**And** utilities detect missing required ARIA attributes
**And** utilities validate aria-live region values

### AC7: Semantic HTML Validation
**Given** semantic HTML validation is enabled
**When** components render
**Then** tests validate use of semantic elements (button, nav, main, section)
**And** tests detect div elements incorrectly replacing semantic elements
**And** tests validate heading hierarchy (h1 → h2 → h3, no gaps)

### AC8: Fixture-Based Test Data
**Given** accessibility fixtures are created
**When** tests use a11y-mocks and a11y-data fixtures
**Then** fixtures provide consistent accessible element states
**And** fixtures include proper ARIA labels, roles, descriptions
**And** fixtures can be reused across multiple test files

### AC9: Configuration for WCAG Levels
**Given** a11y config is implemented
**When** accessibility checks run
**Then** configuration defaults to WCAG AA compliance level
**And** configuration allows disabling specific rules (with justification comments)
**And** configuration specifies ignored elements (e.g., third-party widgets)

### AC10: Integration Test Pattern
**Given** accessibility integration tests are examples
**When** developers add new components
**Then** pattern shows how to test keyboard navigation + axe-core + screen reader support
**And** examples cover common patterns (buttons, dropdowns, modals, forms)
**And** examples show how to assert accessibility violations

### AC11: Pre-commit Hook Validation
**Given** accessibility tests are part of test suite
**When** developers commit code
**Then** pre-commit hooks run accessibility tests
**And** tests fail if WCAG AA violations are introduced
**And** developers cannot commit inaccessible code

### AC12: CI/CD Enforcement
**Given** accessibility tests are configured
**When** code is pushed to main branch
**Then** CI/CD pipeline runs all accessibility tests
**And** pipeline fails if WCAG AA violations are found
**And** pipeline report includes violation details and remediation steps

### AC13: Documentation and Examples
**Given** a11y testing infrastructure is documented
**When** developers need to test accessibility
**Then** documentation includes setup instructions
**And** documentation includes examples for each test pattern (keyboard, screen reader, ARIA)
**And** documentation includes list of resources (WCAG 2.1, axe documentation, WebAIM)

### AC14: Performance Baseline
**Given** axe-core integration is active
**When** test suite runs with accessibility checks
**Then** test performance impact is measured
**And** axe-core scanning adds < 500ms per component test
**And** baseline is documented for future optimization

### AC15: Customization for Wishlist Patterns
**Given** a11y testing setup is complete
**When** wishlist-specific patterns are identified (tabs, card lists, priority input)
**Then** utilities include helpers for these patterns
**And** fixtures include accessible examples of wishlist components
**And** documentation covers testing these patterns

---

## Test Plan

*Comprehensive test coverage for the testing harness itself.*

### Happy Path Tests:

1. **axe-core Detects WCAG AA Violations:**
   - Render component with insufficient color contrast
   - axe-core scanning detects violation
   - Test fails with clear violation message

2. **Keyboard Navigation Testing:**
   - Render modal component
   - Simulate Tab key press
   - Assert focus moves to first focusable element
   - Simulate Escape key
   - Assert modal closes and focus returns to trigger button

3. **Screen Reader Announcement Testing:**
   - Render button with aria-label
   - Assert screen reader would announce "Add item" (or provided label)
   - Render live region
   - Assert aria-live="polite" is set correctly

4. **ARIA Validation:**
   - Render combobox with aria-expanded
   - Assert aria-expanded matches open/closed state
   - Assert aria-owns or aria-controls points to listbox

5. **Semantic HTML Validation:**
   - Render form with proper semantic elements
   - Assert no "div as button" patterns
   - Assert heading hierarchy is valid

### Error Cases:

1. **Color Contrast Violation:**
   - Render text with insufficient contrast
   - axe-core fails test with violation details

2. **Missing ARIA Label:**
   - Render button without accessible label
   - axe-core fails test (no accessible name)

3. **Incorrect Focus Management:**
   - Render modal that doesn't focus first element on open
   - Focus management test fails
   - Document expected behavior

4. **Broken Heading Hierarchy:**
   - Render page with h1 → h3 (skips h2)
   - Semantic HTML test fails with warning

5. **Duplicate ARIA IDs:**
   - Render multiple elements with same aria-labelledby ID
   - ARIA validation test fails

### Edge Cases:

1. **Dynamic Content + Screen Reader Announcements:**
   - Render list that updates dynamically
   - Verify aria-live region captures updates
   - Assert announcements use appropriate politeness level

2. **Nested Focus Contexts:**
   - Render modal within dropdown within page
   - Verify focus trap at correct level
   - Verify focus restoration works correctly

3. **Roving Tabindex Pattern:**
   - Render list with roving tabindex
   - Verify only one item in tab sequence
   - Verify arrow keys navigate items
   - Verify tab moves focus out of list

### Required Evidence:

- 15+ axe-core integration tests (utility tests)
- 10+ keyboard navigation tests
- 8+ screen reader announcement tests
- 5+ focus management tests
- 5+ semantic HTML validation tests
- 5+ WCAG AA color contrast tests
- Example integration tests for each pattern (buttons, dropdowns, modals, forms)
- Performance baseline documented

---

## Reuse Plan

### Reuse from RTL and Vitest Setup

1. **Testing Framework:**
   - Leverage existing React Testing Library and Vitest setup
   - axe-core integrates with RTL and Vitest without friction
   - Reuse existing test fixtures and utilities

2. **Mock Utilities:**
   - Extend existing MSW mocks (from WISH-2011 setup) with a11y fixtures
   - Reuse test data patterns established for other tests

### Reusable Components for Future Stories

1. **Keyboard Navigation Utilities:**
   - Can be reused for any interactive component tests
   - Applicable to wishlist, gallery, instructions, sets features

2. **axe-core Configuration:**
   - Single configuration file used across all wishlist tests
   - Can be extended to other app-specific features

3. **Screen Reader Mock Utilities:**
   - Reusable across all features requiring screen reader testing
   - Foundation for Playwright E2E a11y testing in future

---

## Architecture Notes

### axe-core Integration Pattern

```typescript
import { axe, toHaveNoViolations } from 'jest-axe'
import { render, screen } from '@testing-library/react'
import { describe, it, expect } from 'vitest'

describe('WishlistCard accessibility', () => {
  it('should not have accessibility violations', async () => {
    const { container } = render(
      <WishlistCard item={mockWishlistItem} />,
    )
    const results = await axe(container)
    expect(results).toHaveNoViolations()
  })
})
```

### Keyboard Navigation Testing Pattern

```typescript
import { userEvent } from '@testing-library/user-event'

it('should navigate modal with keyboard', async () => {
  const user = userEvent.setup()
  render(<WishlistModal isOpen={true} onClose={jest.fn()} />)

  // Verify initial focus
  expect(screen.getByRole('button', { name: /save/i })).toHaveFocus()

  // Navigate with Tab
  await user.tab()
  expect(screen.getByRole('button', { name: /cancel/i })).toHaveFocus()

  // Close with Escape
  await user.keyboard('{Escape}')
  expect(screen.queryByRole('dialog')).not.toBeInTheDocument()
})
```

### Screen Reader Testing Pattern

```typescript
it('should announce live region updates', () => {
  const { rerender } = render(
    <div aria-live="polite" aria-label="Status updates">
      Ready
    </div>,
  )

  // Verify ARIA attributes
  expect(screen.getByRole('status')).toHaveAttribute('aria-live', 'polite')

  // Update and verify screen reader would announce
  rerender(
    <div aria-live="polite" aria-label="Status updates">
      Item added successfully
    </div>,
  )

  expect(screen.getByText('Item added successfully')).toBeInTheDocument()
})
```

---

## Dependencies

### Blocked By:

- None - This is independent infrastructure work

### Blocks:

- **WISH-2006** (Accessibility fixes) - Requires this testing harness
- Future accessibility work across other features

### Internal Package Dependencies:

- `@testing-library/react` - Component testing
- `@testing-library/user-event` - Keyboard and user interaction simulation
- `axe-core` - WCAG violation detection
- `jest-axe` - axe-core + Jest integration
- `vitest` - Test runner

### External Dependencies:

- **axe-core:** Open source WCAG checker
  - Current: v4.x or later
  - Maintained by Deque Systems
  - No special setup required (npm package)

---

## Risks & Mitigations

### Risk 1: axe-core False Positives

**Description:** axe-core may report violations that are incorrect or not applicable to wishlist feature, causing noisy test failures.

**Likelihood:** Medium
**Impact:** Low (Easy to suppress with configuration)

**Mitigation:**
- Document known false positives in config
- Use rule exceptions with justification comments
- Regular review of axe-core updates for improved accuracy

---

### Risk 2: Keyboard Navigation Testing Brittleness

**Description:** Focus management tests may be fragile if DOM changes slightly, breaking unrelated tests.

**Likelihood:** Low
**Impact:** Medium (Maintenance burden)

**Mitigation:**
- Use semantic selectors (getByRole) rather than class-based selectors
- Keep focus assertions simple and focused
- Create reusable patterns to reduce duplication

---

### Risk 3: Screen Reader Testing Lacks Real Device Testing

**Description:** Mock screen reader testing may miss real screen reader behavior quirks (NVDA, JAWS, VoiceOver differences).

**Likelihood:** High
**Impact:** Medium (Defer to WISH-2121 for E2E testing)

**Mitigation:**
- Document mock limitations in guides
- Include manual testing checklist for real screen readers
- Defer comprehensive E2E a11y testing to WISH-2121 (Playwright MSW setup)

---

### Risk 4: Performance Overhead from axe-core

**Description:** axe-core scanning on every test could significantly slow test suite.

**Likelihood:** Medium
**Impact:** Low (Easy to mitigate)

**Mitigation:**
- Run axe-core selectively (on key components)
- Measure baseline performance (AC14)
- Consider parallelization if tests become slow
- Option to disable in CI for faster feedback loop

---

## Definition of Done

- [ ] axe-core integration implemented in test setup (AC1)
- [ ] Keyboard navigation test utilities created (AC2)
- [ ] Screen reader testing utilities implemented (AC3)
- [ ] Focus management test helpers created (AC4)
- [ ] Color contrast validation working (AC5)
- [ ] ARIA attribute validation utilities (AC6)
- [ ] Semantic HTML validation utilities (AC7)
- [ ] Accessibility fixtures created (AC8)
- [ ] Configuration for WCAG AA compliance (AC9)
- [ ] Integration test patterns documented (AC10)
- [ ] Pre-commit hooks enforce accessibility tests (AC11)
- [ ] CI/CD pipeline includes accessibility tests (AC12)
- [ ] Documentation complete with examples (AC13)
- [ ] Performance baseline measured (AC14)
- [ ] Wishlist-specific patterns covered (AC15)
- [ ] All utility tests pass (15+ axe-core tests)
- [ ] All navigation tests pass (10+ keyboard tests)
- [ ] All announcement tests pass (8+ screen reader tests)
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] Example tests show expected pattern
- [ ] Documentation reviewed and complete
- [ ] Ready to hand off to WISH-2006

---

## Notes

### Why Before WISH-2006

WISH-2006 implementation will be more efficient when testing infrastructure is ready:

1. **Faster Development:** Developers test accessibility as they code, not after
2. **Reduced Rework:** Issues caught early via automated tests
3. **CI/CD Safety:** Automated gates prevent accessibility regressions
4. **Knowledge Base:** Examples guide developers on proper patterns

### Integration Points

This harness will be used by:
- **WISH-2006:** Accessibility implementation uses all utilities
- **Future a11y stories:** Gallery, instructions, sets features
- **PR reviews:** CI/CD gates enforce accessibility compliance

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Missing reuse evaluation for @repo/accessibility | Add as AC16 | Must explicitly evaluate existing package during implementation. Ensures reuse-first principle is applied and prevents duplicate utilities. |
| 4 | Playwright integration gap | Add as AC17 | Clarifies scope of automated vs manual testing and explicit dependency on WISH-2121 for E2E browser mode testing. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 2 | Missing dependency version specifications | Skip | Not critical for MVP - versions can be documented during implementation planning phase. |
| 3 | Pre-commit hook assumption | Out-of-scope | Performance optimization decision (pre-commit vs pre-push) deferred to implementation phase. Current AC11 assumption is acceptable. |

### Follow-up Stories Suggested

- [ ] AC16: Evaluate @repo/accessibility package enhancements during WISH-2012 implementation
- [ ] AC17: Document manual screen reader testing requirements and explicit WISH-2121 dependency

### Items Marked Out-of-Scope

- **Dependency version specifications:** Implementation team will establish compatibility matrix during setup phase per established practices
- **Pre-commit vs pre-push optimization:** Performance trade-offs to be evaluated during hook implementation based on team feedback
