---
id: WISH-20290
title: "Coverage metrics integration for test utilities"
status: uat
created: 2026-02-08
updated: 2026-02-09
depends_on:
  - WISH-2120
follow_up_from: WISH-2120
phase: "2 - Infrastructure"
priority: P2
complexity: Small
effort: 1
category: Test Infrastructure
experiment_variant: control
surfaces:
  - test_infrastructure
touches_backend: false
touches_frontend: false
touches_database: false
touches_infra: false
predictions:
  split_risk: 0.1
  review_cycles: 1
  token_estimate: 50000
  confidence: medium
  similar_stories: []
  generated_at: "2026-02-08T00:00:00Z"
  model: haiku
  wkfl_version: "007-v1"
---

# WISH-20290: Coverage metrics integration for test utilities

## Follow-up Context

**Parent Story:** WISH-2120
**Source:** QA Discovery Notes (Gaps Identified - Finding #1)
**Original Finding:** Coverage metrics integration - Add coverage threshold enforcement (e.g., 80%) for test utility files via vitest.config.ts
**Category:** Gap
**Impact:** Low
**Effort:** Low (1 point - configuration only)

## Context

WISH-2120 established test utility helpers (`createMockFile`, `mockS3Upload`) that reduce S3 upload test boilerplate. These utilities currently have 100% test coverage (verified: 34 passing tests in `src/test/utils/__tests__/`), but there is no automated enforcement to prevent future coverage regressions.

**Reality Check (2026-02-08):**
- Parent story WISH-2120 is in UAT status with test utilities complete and tested
- Test utilities achieved 100% coverage during implementation
- Project uses Vitest 3.0.5 with v8 coverage provider (already installed and configured)
- Existing test script infrastructure works without modification
- No new dependencies required

**Problem:**
Without coverage threshold enforcement in `vitest.config.ts`, developers might:
- Add new utility functions without corresponding tests
- Modify existing utilities and miss edge cases
- Reduce coverage accidentally through refactoring

This represents technical debt that should be addressed before test utilities proliferate across the codebase (WISH-2121 for Playwright, potential future utility expansions).

## Goal

Add Vitest coverage threshold enforcement (minimum 80%) specifically for `src/test/utils/**/*.ts` files. This creates a two-tier coverage strategy:
1. **Global coverage (45%)**: Production code and existing tests maintain current thresholds
2. **Test utilities (80%)**: Higher bar for test infrastructure to ensure reliability

The 80% threshold is chosen to balance rigor with pragmatism, allowing some uncovered edge cases while preventing significant coverage drops.

## Non-goals

- **Coverage enforcement for production code**: Separate concern outside this story's scope
- **Coverage enforcement for E2E tests**: Playwright does not use Vitest coverage
- **Changing the test utilities themselves**: WISH-2120 scope only, utilities are complete
- **Retroactive coverage enforcement for existing non-utility test files**: Only applies to `src/test/utils/`
- **Modifying global coverage thresholds**: 45% global threshold remains unchanged

## Scope

### Vitest Configuration Updates

**Package:** `apps/web/app-wishlist-gallery`

**File Modified:** `vitest.config.ts`

Add per-directory coverage thresholds using Vitest's glob pattern matching:

```typescript
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
        '**/*.config.*',
        'dist/',
      ],
      thresholds: {
        // Per-directory threshold for test utilities
        'src/test/utils/**/*.ts': {
          lines: 80,
          functions: 80,
          branches: 80,
          statements: 80,
        },
      },
    },
  },
})
```

### Documentation

**File Created:** `apps/web/app-wishlist-gallery/src/test/utils/README.md`

Document the 80% coverage requirement, commands for running coverage checks locally, and guidance on maintaining coverage when adding new utilities.

### Packages Affected

| Package | Change Type | Description |
|---------|-------------|-------------|
| `apps/web/app-wishlist-gallery` | **Modified** | Update `vitest.config.ts` with per-directory thresholds |
| `src/test/utils/` | **Documentation** | Add README.md documenting coverage requirements |

### Change Surface

**Modified Files:**
- `apps/web/app-wishlist-gallery/vitest.config.ts`

**New Files:**
- `apps/web/app-wishlist-gallery/src/test/utils/README.md`

**No changes to:**
- Test utilities themselves (already complete in WISH-2120)
- Global coverage thresholds (remain at 45%)
- Test scripts in `package.json` (existing commands work unchanged)
- Coverage provider configuration (v8 already configured)

---

## Acceptance Criteria

### Coverage Threshold Enforcement

- [ ] **AC1:** `vitest.config.ts` defines coverage thresholds of 80% (lines, functions, branches, statements) for `src/test/utils/**/*.ts`
- [ ] **AC2:** Running `pnpm test:coverage` (or `pnpm vitest run --coverage`) fails if test utility coverage drops below 80%
- [ ] **AC3:** Coverage thresholds apply only to `src/test/utils/` directory, not global test files
- [ ] **AC4:** Coverage report shows test utility coverage separately in terminal output
- [ ] **AC5:** Existing global coverage configuration remains unchanged (no impact on current 45% global approach)

### Documentation

- [ ] **AC6:** Create `src/test/utils/README.md` documenting the 80% coverage requirement
- [ ] **AC7:** README includes command to run coverage checks locally: `pnpm test:coverage` or `pnpm vitest run src/test/utils --coverage`
- [ ] **AC8:** README explains how to view detailed coverage reports (HTML output in `coverage/index.html`)
- [ ] **AC9:** README provides guidance on maintaining coverage when adding new utilities

### Validation

- [ ] **AC10:** All test utilities from WISH-2120 (`createMockFile`, `mockS3Upload`) meet 80% threshold (verified: currently at 100%)
- [ ] **AC11:** CI pipeline enforces coverage thresholds and fails PR if violated
- [ ] **AC12:** Coverage report includes clear error messages when thresholds are not met

---

## Reuse Plan

### Existing Patterns

| Pattern | Source | Usage in This Story |
|---------|--------|---------------------|
| Vitest coverage configuration | `vitest.config.ts` (existing) | Extend with per-directory thresholds |
| Per-directory thresholds | Vitest documentation | Use glob pattern matching for `src/test/utils/**/*.ts` |
| Test script commands | `package.json` scripts | Reuse existing `test:coverage` script |
| Coverage provider v8 | `@vitest/coverage-v8` (installed) | Already configured, no changes needed |
| README documentation | `apps/web/app-wishlist-gallery/README.md` | Follow similar structure |

### No New Dependencies

All changes leverage existing infrastructure:
- **vitest** (already installed and configured)
- **@vitest/coverage-v8** (already installed and configured)
- No new npm packages required

---

## Test Plan

### Scope Summary

- **Endpoints touched:** None (test infrastructure only)
- **UI touched:** No
- **Data/storage touched:** No
- **Configuration touched:** Yes (`vitest.config.ts`)
- **Documentation touched:** Yes (`README.md` added)

### Happy Path Tests

**Test 1: Coverage passes for existing utilities**
- **Setup:** No changes needed (utilities already at 100% coverage from WISH-2120)
- **Action:** Run `pnpm --filter app-wishlist-gallery vitest run src/test/utils --coverage`
- **Expected outcome:** Exit code 0, coverage report shows ≥80% for all metrics (lines, functions, branches, statements)
- **Evidence:** Terminal output showing coverage percentages, all green/passing thresholds

**Test 2: Coverage report shows per-directory breakdown**
- **Setup:** Same as Test 1
- **Action:** Run full coverage suite: `pnpm --filter app-wishlist-gallery vitest run --coverage`
- **Expected outcome:** Coverage report includes separate section for `src/test/utils/` with 80% thresholds clearly indicated
- **Evidence:** Terminal output with formatted table showing test utility coverage vs global coverage

**Test 3: HTML coverage report generation**
- **Setup:** Run coverage as above
- **Action:** Open `apps/web/app-wishlist-gallery/coverage/index.html` in browser
- **Expected outcome:** HTML report displays test utilities with per-directory threshold badges, all passing
- **Evidence:** Screenshot of HTML report showing test utility coverage metrics

### Error Cases

**Test 4: Coverage failure with clear error message**
- **Setup:** Temporarily comment out several test cases in `src/test/utils/__tests__/createMockFile.test.ts` to drop coverage below 80%
- **Action:** Run `pnpm --filter app-wishlist-gallery vitest run src/test/utils --coverage`
- **Expected outcome:**
  - Exit code 1 (failure)
  - Clear error message indicating which threshold was violated (e.g., "Coverage for lines (75%) does not meet threshold (80%)")
  - Error includes file path `src/test/utils/createMockFile.ts`
- **Evidence:** Terminal output showing error message with violated threshold details
- **Cleanup:** Restore commented test cases

**Test 5: CI pipeline enforcement**
- **Setup:** Create test PR with coverage below threshold (same setup as Test 4)
- **Action:** Push PR and observe CI pipeline
- **Expected outcome:**
  - CI fails on coverage check step
  - PR status check marked as failed
  - CI logs include clear error message from Vitest
- **Evidence:** CI pipeline logs, GitHub PR status check failure
- **Cleanup:** Close/abandon test PR

### Edge Cases

**Test 6: Global coverage unaffected**
- **Setup:** No changes
- **Action:** Run `pnpm --filter app-wishlist-gallery vitest run --coverage` (full test suite)
- **Expected outcome:**
  - Global coverage thresholds still at 45%
  - Non-utility files not subject to 80% threshold
  - Overall coverage report passes with existing baselines
- **Evidence:** Coverage summary showing global thresholds unchanged

**Test 7: Glob pattern accuracy**
- **Setup:** Add a new file `src/test/mocks/newMock.ts` (not under `utils/`)
- **Action:** Run coverage for both directories
- **Expected outcome:**
  - `src/test/utils/**/*.ts` subject to 80% threshold
  - `src/test/mocks/**/*.ts` NOT subject to 80% threshold (uses global 45%)
- **Evidence:** Coverage report showing different thresholds applied to different directories
- **Cleanup:** Remove test file

**Test 8: README documentation completeness**
- **Setup:** No changes
- **Action:** Read `src/test/utils/README.md`
- **Expected outcome:**
  - Clearly documents 80% coverage requirement
  - Includes copy-pasteable commands for local coverage checks
  - Explains HTML report location and how to open it
  - Provides guidance on maintaining coverage when adding utilities
- **Evidence:** Markdown file content meets all documentation ACs (AC6-AC9)

### Required Tooling Evidence

**Backend:**
- N/A (no backend changes)

**Frontend:**
- **Commands:**
  ```bash
  # Run test utility coverage
  pnpm --filter app-wishlist-gallery vitest run src/test/utils --coverage

  # Run full coverage suite
  pnpm --filter app-wishlist-gallery vitest run --coverage

  # View HTML coverage report (macOS)
  open apps/web/app-wishlist-gallery/coverage/index.html

  # View HTML coverage report (Linux)
  xdg-open apps/web/app-wishlist-gallery/coverage/index.html
  ```
- **Assertions:**
  - Coverage percentages ≥80% for `src/test/utils/**/*.ts`
  - Coverage report includes per-directory breakdown
  - HTML report generated at `coverage/index.html`
  - Error messages when thresholds violated include file paths and specific metrics

**CI/CD:**
- Verify coverage check runs as part of PR validation
- Verify coverage failures properly fail the build
- Check CI logs for clear error reporting

### Risks to Call Out

- **Risk:** Vitest configuration syntax errors could break all tests
  - **Mitigation:** Test configuration locally before commit, validate with `pnpm vitest --version` to confirm config loads

- **Risk:** Glob pattern might not match intended files
  - **Mitigation:** Test with explicit file path patterns, verify with Test 7 (edge case testing)

- **Risk:** CI integration might not respect new thresholds
  - **Mitigation:** Test CI behavior with Test PR (Test 5)

---

## Architecture Notes

### Coverage Threshold Strategy

This story establishes a **two-tier coverage strategy**:

1. **Global coverage (45%):** Production code and existing tests maintain current thresholds
2. **Test utilities (80%):** Higher bar for test infrastructure to ensure reliability

**Rationale:**
- Test utilities are critical infrastructure used across many test files
- High coverage prevents cascading failures when utilities have bugs
- 80% threshold balances rigor with pragmatism (allows some edge cases)
- Per-directory thresholds keep global coverage flexible while enforcing quality on critical paths

### Vitest Configuration Pattern

Using Vitest's `thresholds` object with glob patterns:

```typescript
thresholds: {
  'src/test/utils/**/*.ts': {
    lines: 80,
    functions: 80,
    branches: 80,
    statements: 80,
  },
}
```

This pattern:
- Applies thresholds only to matching files
- Does not affect global coverage calculations
- Supports multiple per-directory rules (extensible for future critical paths)
- Works with existing v8 coverage provider

### Future Expansion

This pattern can be extended to other critical paths:
- `src/hooks/**/*.ts` (custom React hooks)
- `src/utils/**/*.ts` (shared utilities)
- `src/lib/**/*.ts` (core library code)

Each can have independent threshold requirements based on criticality.

---

## Infrastructure Notes

**No infrastructure changes required.**

This is a configuration-only story:
- Existing Vitest infrastructure (3.0.5) supports per-directory thresholds
- Coverage provider v8 already installed and configured
- Test scripts in `package.json` work without modification
- CI pipeline uses existing test commands (no CI config changes needed)

---

## Dev Feasibility

### Feasibility Summary

- **Feasible for MVP:** Yes
- **Confidence:** High
- **Why:** Straightforward Vitest configuration change with existing infrastructure. No code changes, no new dependencies, low technical risk.

### Likely Change Surface (Core Only)

**Configuration:**
- `apps/web/app-wishlist-gallery/vitest.config.ts` (add `thresholds` object)

**Documentation:**
- `apps/web/app-wishlist-gallery/src/test/utils/README.md` (new file)

**No changes to:**
- Test utilities (already complete)
- Test scripts
- Coverage provider
- CI configuration (uses existing test commands)

### MVP-Critical Risks

**None identified.** This is a configuration-only change with minimal risk:
- Vitest 3.0.5 fully supports per-directory coverage thresholds
- Existing test utilities already exceed 80% threshold (currently at 100%)
- Configuration syntax is well-documented in Vitest docs
- No cross-team dependencies or deployment touchpoints

### Missing Requirements for MVP

**None.** All requirements clearly specified in seed and acceptance criteria.

### MVP Evidence Expectations

**Configuration Evidence:**
- `vitest.config.ts` diff showing `thresholds` object added
- Coverage report showing per-directory thresholds applied

**Documentation Evidence:**
- `README.md` created with all required sections (commands, HTML report, guidance)

**Validation Evidence:**
- Terminal output showing coverage pass/fail scenarios
- CI logs demonstrating coverage enforcement
- HTML coverage report screenshots

---

## Future Risks

*(Non-MVP concerns tracked separately)*

### Potential Future Enhancements

1. **Extend pattern to other critical paths:**
   - Add 80% thresholds for `src/hooks/**/*.ts`
   - Add 80% thresholds for `src/utils/**/*.ts`
   - Timeline: Post-WISH-2120, as utility libraries grow

2. **Coverage reporting improvements:**
   - Integrate coverage badges in PR comments
   - Add coverage trends over time
   - Timeline: Future infrastructure work

3. **Developer experience:**
   - Add coverage pre-commit hook for faster feedback
   - Create VSCode task for coverage checks
   - Timeline: Developer tooling sprint

### Scope Tightening Suggestions

- Focus only on `src/test/utils/` for this story
- Defer other directory thresholds to follow-up stories
- Keep global thresholds unchanged (avoid scope creep)

---

## Reality Baseline

*(Snapshot of existing state from WISH-2120 parent story)*

### Test Utility Infrastructure (WISH-2120)

**Location:** `apps/web/app-wishlist-gallery/src/test/utils/`

**Utilities:**
- `createMockFile.ts` - Factory for File/Blob test objects
- `mockS3Upload.ts` - S3 upload scenario mocking
- `index.ts` - Re-exports for clean imports

**Current Coverage:**
- 34 passing tests in `__tests__/` directory
- 100% coverage achieved (verified in WISH-2120 UAT)

**Test Infrastructure:**
- Vitest 3.0.5
- Coverage provider: v8 (`@vitest/coverage-v8`)
- Reporters: text, json, html
- Global threshold: 45%

**Usage:**
- Used by S3 upload tests in `src/hooks/__tests__/useS3Upload.test.ts`
- Reduces test boilerplate by 60% (per WISH-2120 metrics)

### Vitest Configuration Baseline

**File:** `apps/web/app-wishlist-gallery/vitest.config.ts`

**Current Coverage Config:**
```typescript
coverage: {
  provider: 'v8',
  reporter: ['text', 'json', 'html'],
  exclude: [
    'node_modules/',
    'src/test/',
    '**/*.d.ts',
    '**/*.config.*',
    'dist/',
  ],
  // No thresholds object currently defined
}
```

**Test Scripts (package.json):**
```json
{
  "scripts": {
    "test": "vitest",
    "test:coverage": "vitest run --coverage"
  }
}
```

### Dependencies Baseline

- `vitest@3.0.5` (installed)
- `@vitest/coverage-v8@3.0.5` (installed)
- No additional packages required for this story

### Related Stories

- **WISH-2120** (UAT): Parent story, test utilities complete with 100% coverage
- **WISH-2121** (Future): Playwright test utilities - may follow similar coverage pattern

---

## Open Questions

**None.** All requirements clear from WISH-2120 context and Vitest documentation.

---

## Source

Follow-up from QA Elaboration of WISH-2120 (Gaps Identified - Finding #1)

**Original Finding:** Coverage metrics integration - Add coverage threshold enforcement (e.g., 80%) for test utility files via vitest.config.ts. Non-MVP: existing tests work fine without this.

**Elaboration Source:** `plans/future/wish/deferred/WISH-20290/_pm/STORY-SEED.md` (generated 2026-02-08)

**Category:** Gap (Technical Debt)
**Impact:** Low (prevents future coverage regressions)
**Effort:** Low (1 point - configuration only)

---

## Predictions

This section contains AI-generated predictions for planning purposes. Predictions are advisory only and do not constrain implementation.

- **Split Risk:** 0.1 (10% chance of story splitting)
  - Very low complexity, configuration-only change
  - Clear scope with no cross-domain dependencies
  - Parent story complete and tested

- **Review Cycles:** 1 (expected code review iterations)
  - Simple configuration change
  - No complex logic to review
  - Clear documentation requirements

- **Token Estimate:** 50,000 tokens
  - Minimal implementation scope
  - Straightforward configuration update
  - Documentation writing is primary work

- **Confidence:** Medium
  - No similar configuration-only stories in knowledge base
  - Fallback to heuristics-only prediction
  - Low risk profile supports medium confidence

- **Similar Stories:** None found
  - No prior coverage enforcement stories in KB
  - First story of this pattern type

---

## Experiment Assignment

This story was assigned to the **control** group (no active experiments).

- **Experiment Variant:** control
- **Reason:** No active experiments in experiments.yaml
- **Workflow:** Standard PM generation workflow

---

## QA Discovery Notes (Auto-Generated)

_Added by Autonomous Elaboration on 2026-02-08_

### MVP Gaps Resolved

| # | Finding | Resolution | AC Added |
|---|---------|------------|----------|
| — | None - all requirements satisfied | N/A | 0 |

### Non-Blocking Items (Logged to KB)

| # | Finding | Category | KB Entry |
|---|---------|----------|----------|
| 1 | Coverage threshold documentation in root README | documentation | deferred |
| 2 | Pre-commit coverage hooks | developer-experience | deferred |
| 3 | Coverage trend tracking | observability | deferred |
| 4 | Extend pattern to other critical paths (src/hooks, src/utils, src/lib) | coverage-strategy | deferred |
| 5 | CI/CD coverage badge integration | ci-cd-integration | deferred |
| 6 | VSCode tasks for coverage checks | developer-experience | deferred |
| 7 | Coverage exemptions framework | coverage-strategy | deferred |
| 8 | Per-function coverage reporting | observability | deferred |
| 9 | Coverage regression detection in CI | ci-cd-integration | deferred |

### Summary

- **ACs added:** 0 (no MVP-critical gaps found)
- **KB entries created:** 0 (KB tools unavailable - 9 findings deferred for processing when tools available)
- **Mode:** autonomous
- **Verdict:** PASS - ready to proceed to ready-to-work status

**Autonomous Elaboration Details:**
- All 8 audit checks passed
- No MVP-critical gaps or blockers identified
- Parent story (WISH-2120) in UAT with 100% test coverage
- Configuration-only change with minimal risk
- 12 acceptance criteria clearly defined
- Comprehensive test plan with 8 scenarios

**Deferred KB Processing:**
All 9 non-blocking enhancements have been identified and logged for future KB entry creation when knowledge base tools become available. These are categorized as: documentation, developer-experience, observability, and coverage-strategy enhancements that can be addressed in follow-up infrastructure work.
