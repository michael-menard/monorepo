---
doc_type: story
title: "WISH-2015: Form Autosave via RTK Slice with localStorage Persistence"
story_id: WISH-2015
story_prefix: WISH
status: ready-to-work
follow_up_from: WISH-2002
phase: 4
created_at: "2026-01-27T00:00:00-07:00"
updated_at: "2026-02-08T00:00:00-07:00"
depends_on: [WISH-2002]
estimated_points: 2
---

# WISH-2015: Form Autosave via RTK Slice with localStorage Persistence

## Follow-up Context

**Parent Story:** WISH-2002: Add Item Flow
**Source:** QA Discovery Notes - Gaps Addressed
**Original Finding:** Form autosave to localStorage - save form draft during typing, restore on page reload. Prevents data loss.
**Category:** Gap
**Impact:** Medium - improves user experience and prevents frustration from lost data
**Effort:** Low - RTK slice with localStorage persistence middleware, integrated with existing form

## Context

Users creating wishlist items may lose their work if they accidentally navigate away, refresh the page, or experience a browser crash while filling out the add item form. This is particularly frustrating when they've already uploaded an image or filled in many fields. An autosave feature would preserve form state and restore it when they return to the form.

This enhancement builds on the form infrastructure from WISH-2002 and uses the project's established RTK state management pattern. Draft state lives in a Redux slice and is persisted to localStorage via middleware, keeping the architecture consistent with how `authSlice`, `themeSlice`, and other client-side state is managed.

## Goal

Automatically save form state during user input and restore it when the user returns to the form, preventing data loss from accidental navigation or browser issues. Use RTK as the state management layer with localStorage as the persistence backend.

## Non-goals

- Not re-implementing the form submission logic from WISH-2002
- Not implementing server-side draft storage (RTK slice + localStorage only)
- Not implementing cross-device draft synchronization
- Not implementing draft expiration or cleanup (user can manually clear)
- Not implementing autosave for edit form (edit already loads from server)
- Not supporting multiple currencies (all prices stored in USD; assumption documented)
- Not adding `redux-persist` as a dependency (custom lightweight middleware instead)

## Scope

**Pages Affected:**
- `apps/web/app-wishlist-gallery/src/pages/AddItemPage.tsx`

**Components Affected:**
- `apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx`

**Store Changes:**
- `apps/web/app-wishlist-gallery/src/store/slices/wishlistDraftSlice.ts` (new)
- `apps/web/app-wishlist-gallery/src/store/middleware/draftPersistenceMiddleware.ts` (new)
- `apps/web/app-wishlist-gallery/src/store/index.ts` (modified - add slice + middleware)

**Test Files (new):**
- `apps/web/app-wishlist-gallery/src/store/slices/__tests__/wishlistDraftSlice.test.ts`
- `apps/web/app-wishlist-gallery/src/store/middleware/__tests__/draftPersistenceMiddleware.test.ts`
- `apps/web/app-wishlist-gallery/src/pages/__tests__/AddItemPage.autosave.test.tsx`
- `apps/web/playwright/features/wishlist/wishlist-form-autosave.feature`
- `apps/web/playwright/steps/wishlist-form-autosave.steps.ts`

**Packages Affected:**
- `apps/web/app-wishlist-gallery`
- `apps/web/playwright`

## Acceptance Criteria

- [ ] Draft form state is managed via an RTK `wishlistDraftSlice` with actions for updating fields, restoring draft, and clearing draft
- [ ] A lightweight persistence middleware debounces (500ms) and writes the draft slice state to localStorage on changes
- [ ] On store initialization, draft state is rehydrated from localStorage if a valid draft exists
- [ ] Saved state includes all form fields except image binary (S3 URL saved but not binary data)
- [ ] When user returns to add item page, form auto-populates from RTK store (which was rehydrated from localStorage)
- [ ] "Resume draft" banner shows when a restored draft exists, with option to "Start fresh"
- [ ] Draft is cleared (both RTK state and localStorage) on successful form submission
- [ ] Draft is cleared when user clicks "Start fresh"
- [ ] localStorage key is scoped to user ID from auth state (`state.auth.user.id`) so different users don't share drafts
- [ ] Image URL from restored draft is validated (S3 presigned URLs may expire)
- [ ] Middleware debounce prevents excessive localStorage writes (max 2 writes/second)
- [ ] **[QA Gap #3]** releaseDate field exists in form and is included in autosaved draft when present
- [ ] **[QA Gap #4]** User ID sourced from RTK auth state (`selectUser` selector) for localStorage key scoping
- [ ] **[Testing]** Unit tests for `wishlistDraftSlice` (reducers, selectors, initial state, edge cases)
- [ ] **[Testing]** Unit tests for `draftPersistenceMiddleware` (debounce, localStorage read/write, quota exceeded, invalid JSON, user scoping)
- [ ] **[Testing]** Integration tests for draft restore + "Resume draft" banner UX in AddItemPage
- [ ] **[Testing]** Cucumber feature file `wishlist-form-autosave.feature` with Gherkin scenarios covering happy path, restore, clear, and error flows
- [ ] **[Testing]** Playwright E2E step definitions in `wishlist-form-autosave.steps.ts` wired to the feature file
- [ ] **[Testing]** E2E tests run in live mode against real app (no MSW mocking for autosave persistence)

## Reuse Plan

- Builds on `WishlistForm` component from WISH-2002
- Leverages existing form state management from WISH-2002
- Follows existing RTK slice pattern from `authSlice`, `themeSlice`, `navigationSlice`, `globalUISlice`
- Uses existing `selectUser` selector from `authSlice` for user ID scoping
- Reuses the wishlist gallery store at `apps/web/app-wishlist-gallery/src/store/index.ts`
- Existing `useLocalStorage` hook (from prior WISH-2015 sort persistence work) available but not needed - RTK middleware handles persistence directly

## Architecture Notes

**RTK Slice Design (`wishlistDraftSlice`):**
```typescript
// Actions:
// - updateDraftField(field, value) - update a single field
// - setDraft(formData) - bulk set all fields (for rehydration)
// - clearDraft() - clear draft state + localStorage
// - setDraftRestored(boolean) - track if draft was restored from localStorage

// Selectors:
// - selectDraft - full draft state
// - selectDraftFormData - just the form data
// - selectIsDraftRestored - whether showing "Resume draft" banner
// - selectHasDraft - whether any draft data exists
```

**Persistence Middleware:**
```typescript
// Listens for wishlistDraft/* actions
// Debounces 500ms before writing to localStorage
// Reads user ID from state.auth.user.id for key scoping
// Key format: wishlist:draft:${userId}:add-item
// Handles: quota exceeded, incognito mode, invalid JSON
```

**Rehydration Flow:**
1. Store initializes with empty draft state
2. Middleware reads localStorage on store creation (preloadedState pattern)
3. If valid draft found (timestamp < 7 days), dispatches `setDraft()` + `setDraftRestored(true)`
4. AddItemPage reads `selectIsDraftRestored` to show "Resume draft" banner
5. User accepts → form populates from `selectDraftFormData`
6. User declines → dispatches `clearDraft()`

**localStorage Key Structure:**
```
wishlist:draft:${userId}:add-item
```
Where `userId` is `state.auth.user.id` from the RTK auth slice.

**Auth Integration:**
- User ID sourced from RTK `selectUser` selector (already in store from auth flow)
- Falls back to disabling autosave if user is not authenticated
- This ensures different users don't share drafts on shared devices

**Stored Data Shape (in localStorage):**
```typescript
{
  timestamp: number,
  formData: {
    title: string,
    store: string,
    setNumber?: string,
    sourceUrl?: string,
    imageUrl?: string,
    price?: number,  // USD always
    pieceCount?: number,
    releaseDate?: string,
    tags?: string[],
    priority?: number,
    notes?: string
  }
}
```

**Why RTK middleware instead of `redux-persist`:**
- Only one slice needs persistence (overkill to add a dependency)
- Custom middleware gives control over debouncing, user-scoped keys, and draft expiry
- Keeps the approach consistent with project philosophy of minimal dependencies
- ~30 lines of middleware vs. a new package dependency

## Test Plan

### 1. Unit Tests

**`wishlistDraftSlice.test.ts`** (RTK slice tests):
- `updateDraftField` updates a single field in state
- `setDraft` bulk-sets all form fields (rehydration path)
- `clearDraft` resets state to initial empty values
- `setDraftRestored(true/false)` toggles restored flag
- `selectDraftFormData` returns only the form data portion
- `selectHasDraft` returns true when any field is non-empty
- `selectIsDraftRestored` reflects restored banner state
- Initial state has all fields empty and `isRestored: false`

**`draftPersistenceMiddleware.test.ts`** (middleware tests):
- Writes to localStorage after 500ms debounce on `updateDraftField`
- Does not write on non-draft actions (passthrough)
- Reads user ID from `state.auth.user.id` for localStorage key
- Skips persistence when user is not authenticated
- Catches `QuotaExceededError` and logs warning via `@repo/logger`
- Handles invalid JSON in localStorage gracefully (clears and continues)
- `clearDraft` action removes the localStorage entry
- Rehydrates draft from localStorage on initialization when valid draft exists
- Skips rehydration when draft timestamp > 7 days old
- Validates rehydrated data against Zod schema

### 2. Integration Tests (RTL)

**`AddItemPage.autosave.test.tsx`** (component integration):
- Form fields dispatch `updateDraftField` actions on change
- "Resume draft" banner renders when `selectIsDraftRestored` is true
- Clicking "Resume draft" populates form fields from store
- Clicking "Start fresh" dispatches `clearDraft()` and hides banner
- Successful form submission dispatches `clearDraft()`
- Banner does not render when no draft exists
- Expired image URL shows warning with re-upload option

### 3. Cucumber Feature File

**`apps/web/playwright/features/wishlist/wishlist-form-autosave.feature`**

```gherkin
@wishlist @autosave @wish-2015
Feature: Wishlist Form Autosave
  As a user creating a wishlist item
  I want my form progress to be saved automatically
  So that I don't lose my work if I navigate away or refresh

  Background:
    Given I am logged in as a test user
    And I navigate to the add item page

  @smoke @happy-path
  Scenario: Form draft is saved and restored after page reload
    When I fill in the "Title" field with "LEGO Millennium Falcon"
    And I fill in the "Store" field with "LEGO.com"
    And I fill in the "Price" field with "849.99"
    And I wait for the autosave debounce
    And I reload the page
    Then I should see the "Resume draft" banner
    When I click "Resume draft"
    Then the "Title" field should contain "LEGO Millennium Falcon"
    And the "Store" field should contain "LEGO.com"
    And the "Price" field should contain "849.99"

  @smoke
  Scenario: Draft is cleared on successful form submission
    When I fill in the "Title" field with "LEGO AT-AT"
    And I fill in the "Store" field with "Amazon"
    And I wait for the autosave debounce
    And I reload the page
    Then I should see the "Resume draft" banner
    When I click "Resume draft"
    And I complete and submit the form
    Then the form should be submitted successfully
    When I navigate to the add item page
    Then I should not see the "Resume draft" banner
    And all form fields should be empty

  @smoke
  Scenario: User can discard draft with "Start fresh"
    When I fill in the "Title" field with "LEGO Star Destroyer"
    And I wait for the autosave debounce
    And I reload the page
    Then I should see the "Resume draft" banner
    When I click "Start fresh"
    Then I should not see the "Resume draft" banner
    And all form fields should be empty
    When I reload the page
    Then I should not see the "Resume draft" banner

  Scenario: All form fields are preserved in draft
    When I fill in the "Title" field with "Test Set"
    And I fill in the "Store" field with "BrickLink"
    And I fill in the "Set Number" field with "75192"
    And I fill in the "Price" field with "199.99"
    And I fill in the "Piece Count" field with "7541"
    And I fill in the "Notes" field with "Birthday gift idea"
    And I wait for the autosave debounce
    And I reload the page
    And I click "Resume draft"
    Then the "Title" field should contain "Test Set"
    And the "Store" field should contain "BrickLink"
    And the "Set Number" field should contain "75192"
    And the "Price" field should contain "199.99"
    And the "Piece Count" field should contain "7541"
    And the "Notes" field should contain "Birthday gift idea"

  Scenario: No draft banner on first visit
    Then I should not see the "Resume draft" banner
    And all form fields should be empty

  @error-handling
  Scenario: Corrupted localStorage data is handled gracefully
    Given localStorage contains corrupted draft data
    When I navigate to the add item page
    Then I should not see the "Resume draft" banner
    And all form fields should be empty

  @edge-case
  Scenario: Draft older than 7 days is ignored
    Given localStorage contains a draft older than 7 days
    When I navigate to the add item page
    Then I should not see the "Resume draft" banner
```

### 4. Playwright Step Definitions

**`apps/web/playwright/steps/wishlist-form-autosave.steps.ts`**

Steps to implement:
- `I navigate to the add item page` - navigates to add-item route
- `I fill in the {string} field with {string}` - fills form field by label
- `I wait for the autosave debounce` - waits 600ms for debounce to flush
- `I should see the "Resume draft" banner` - asserts banner visibility
- `I should not see the "Resume draft" banner` - asserts banner hidden
- `I click "Resume draft"` / `I click "Start fresh"` - clicks banner button
- `the {string} field should contain {string}` - asserts form field value
- `all form fields should be empty` - asserts all fields at default
- `I complete and submit the form` - fills remaining required fields and submits
- `the form should be submitted successfully` - asserts success state
- `localStorage contains corrupted draft data` - injects bad JSON via `page.evaluate`
- `localStorage contains a draft older than 7 days` - injects expired draft via `page.evaluate`

### 5. Test Execution

**Unit + Integration** (Vitest):
```bash
pnpm --filter app-wishlist-gallery test -- --run
```

**E2E Cucumber** (Playwright, live mode):
```bash
cd apps/web/playwright
pnpm bdd:gen
pnpm playwright test --project=chromium-live --grep @wish-2015
```

### Error Cases

1. **Expired image URL**: If imageUrl in draft is expired, show warning and allow user to re-upload
2. **localStorage full**: Middleware catches quota exceeded, logs warning via `@repo/logger`, draft remains in RTK state (in-memory only)
3. **Invalid JSON in localStorage**: Middleware silently clears invalid data, store starts fresh
4. **User not authenticated**: Middleware skips persistence (no user ID for key scoping)

### Edge Cases

1. **Multiple tabs**: Last write wins via localStorage (acceptable tradeoff); RTK state is per-tab
2. **Old drafts**: Drafts older than 7 days are ignored during rehydration but not auto-deleted
3. **Rapid typing**: Middleware debounce ensures max 2 localStorage writes/second
4. **Form validation errors**: Draft saves even with validation errors present
5. **Logout**: `clearDraft()` should be dispatched on logout to prevent stale user-scoped data

## Risks / Edge Cases

1. **localStorage quota limits**: Browser localStorage typically 5-10MB, should be sufficient for form data
2. **S3 URL expiration**: Presigned URLs from previous session may be expired; need validation
3. **Race conditions**: Multiple tabs could overwrite each other in localStorage; RTK state is per-tab so in-memory state is always consistent
4. **Privacy**: Form data stored in plaintext in localStorage; acceptable for non-sensitive wishlist data

## Open Questions

None - all requirements are clear and non-blocking.

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Missing test specification | Add as AC | Added AC requiring Playwright E2E tests for autosave/restore flow (typing triggers autosave, reload restores draft, submit clears draft, start fresh clears draft) |
| 2 | Missing currency field | Out-of-scope | All currency is USD; removed currency from stored data shape; documented USD assumption in non-goals section |
| 3 | Missing release date field | Add as AC | Added AC to verify releaseDate field exists in form and is included in autosaved draft when present |
| 4 | Missing userId extraction | Add as AC | Updated to use Cognito JWT user `sub` for user identification instead of generic userId pattern |
| 5 | Auth context integration (MVP-Critical) | Add as AC | Added AC to extract user `sub` from Cognito JWT token for localStorage key scoping; updated Architecture Notes with auth integration pattern |

### Enhancement Opportunities

None identified.

### Follow-up Stories Suggested

None at this time.

### Items Marked Out-of-Scope

- **Multiple currency support**: All prices stored in USD. Currency field removed from stored data shape. This is acceptable for MVP as the platform operates in USD only.
