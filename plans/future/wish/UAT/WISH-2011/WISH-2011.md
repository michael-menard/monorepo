---
status: uat
created: 2026-01-28
updated_at: 2026-01-30
story_id: WISH-2011
title: Test infrastructure for MSW mocking of S3 and API calls
epic: Wishlist Feature
phase: 2 - Infrastructure
priority: P0
depends_on: [WISH-2007]
complexity: Small
effort: 1-2 points
---

# WISH-2011: Test infrastructure for MSW mocking of S3 and API calls

## Context

The wishlist feature requires reliable integration tests for image upload flows without depending on actual S3 infrastructure or AWS credentials. Currently, `useS3Upload.test.ts` contains comprehensive tests (16+ tests) that mock S3 and API interactions, but the mocking patterns are not formalized or reusable across other test files.

This story formalizes MSW (Mock Service Worker) handlers for:
- S3 presigned URL generation (`/wishlist/images/presign`)
- S3 upload responses (PUT requests to `*.amazonaws.com`)
- Reusable test fixtures for consistent mocking

### Background

**MSW Status:** Already integrated in the repo
- `apps/web/app-wishlist-gallery/src/test/setup.ts` configures MSW server
- `apps/web/app-wishlist-gallery/src/test/mocks/handlers.ts` contains basic handlers
- Tests run with `onUnhandledRequest: 'error'` to catch missing mocks

**Existing Tests:**
- `useS3Upload.test.ts` has 16+ tests covering upload flows
- Tests mock `@repo/upload-client` and RTK Query hooks directly
- No centralized fixtures or MSW handlers for S3

**Goal:** Standardize mocking patterns so all integration tests can rely on shared MSW handlers and fixtures instead of ad-hoc mocks.

---

## Goal

Enable reliable, fast integration tests for S3 upload flows without external dependencies:
- Developers can write integration tests without AWS credentials
- Tests run consistently in local development and CI
- No actual S3 or backend calls during test execution
- Mocking patterns are reusable across component and hook tests

---

## Non-goals

- **Playwright E2E MSW Setup:** Browser-mode MSW for Playwright is out of scope. Defer to future story.
- **Visual Regression Tests:** Chromatic snapshots of upload progress are out of scope.
- **Real S3 Integration Tests:** End-to-end tests against actual S3 (dev environment) are out of scope.
- **Load Testing:** Stress testing with 10+ concurrent uploads is out of scope.
- **Implementation Changes:** No changes to production code (hooks, components, API). Test infrastructure only.

---

## Scope

### Packages Affected

- `apps/web/app-wishlist-gallery/src/test/mocks/` - MSW handler updates
- `apps/web/app-wishlist-gallery/src/test/fixtures/` - New test fixtures (create)
- `apps/web/app-wishlist-gallery/src/hooks/__tests__/` - Verify existing tests pass
- `apps/web/app-wishlist-gallery/src/components/**/__tests__/` - Add component integration tests

### Files to Create

1. **Test Fixtures:**
   - `apps/web/app-wishlist-gallery/src/test/fixtures/s3-mocks.ts` - Presign and S3 response fixtures
   - `apps/web/app-wishlist-gallery/src/test/fixtures/index.ts` - Re-export all fixtures

2. **Documentation (Optional but Recommended):**
   - `apps/web/app-wishlist-gallery/src/test/fixtures/README.md` - Fixture documentation

### Files to Modify

1. **MSW Handlers:**
   - `apps/web/app-wishlist-gallery/src/test/mocks/handlers.ts` - Add presign and S3 PUT handlers

2. **Integration Tests:**
   - `apps/web/app-wishlist-gallery/src/hooks/__tests__/useS3Upload.test.ts` - Verify all tests pass with MSW handlers
   - `apps/web/app-wishlist-gallery/src/components/WishlistForm/__tests__/WishlistForm.test.tsx` - Add image upload test
   - `apps/web/app-wishlist-gallery/src/pages/__tests__/AddItemPage.test.tsx` - Add full upload flow test

---

## Acceptance Criteria

### AC1: MSW Presign Handler Created
**Given** the MSW server is running in test mode
**When** a test calls `useGetWishlistImagePresignUrlMutation` with `fileName` and `mimeType`
**Then** the MSW handler intercepts the request
**And** returns a mock presigned URL and S3 key
**And** the response validates against `PresignResponseSchema`
**And** no actual API call reaches the backend

### AC2: MSW S3 PUT Handler Created
**Given** the MSW server is running in test mode
**When** a test calls `uploadToPresignedUrl` with a presigned URL
**Then** the MSW handler intercepts the S3 PUT request
**And** returns 200 OK status
**And** simulates progress callbacks (0%, 50%, 100%)
**And** no actual S3 upload occurs

### AC3: Presign Handler Supports Error Injection
**Given** a test needs to simulate a presign failure
**When** the MSW handler is configured to return 500 error
**Then** the handler returns an error response
**And** the test can verify error handling behavior

### AC4: S3 PUT Handler Supports Error Injection
**Given** a test needs to simulate an S3 upload failure
**When** the MSW handler is configured to return 403 Forbidden
**Then** the handler returns 403 status
**And** the test can verify error handling behavior

### AC5: Test Fixtures Created for Presign Responses
**Given** developers need consistent mock data
**When** they import from `src/test/fixtures/s3-mocks.ts`
**Then** they can access at least 3 presign response fixtures:
  - Success response with valid presignedUrl and key
  - 500 error response
  - Timeout simulation
**And** all fixtures validate against `PresignResponseSchema`

### AC6: Test Fixtures Created for Sample Files
**Given** developers need test files for upload tests
**When** they import from `src/test/fixtures/s3-mocks.ts`
**Then** they can access at least 4 sample files:
  - Valid JPEG file
  - Valid PNG file
  - Valid WebP file
  - Invalid text file (.txt)
**And** files have correct MIME types

### AC7: Existing useS3Upload Tests Pass
**Given** MSW handlers are active
**When** the test suite runs `useS3Upload.test.ts`
**Then** all 16+ existing tests pass
**And** no tests require AWS credentials
**And** no actual network requests are made

### AC8: Concurrent Upload Test Added
**Given** the MSW S3 PUT handler supports concurrent requests
**When** two uploads are triggered simultaneously
**Then** both complete successfully
**And** each gets a unique S3 key
**And** no state interference occurs between uploads

### AC9: 0-Byte File Test Added
**Given** the upload validation logic
**When** a test attempts to upload a 0-byte file
**Then** the test verifies either validation error OR upload error
**And** no partial upload state occurs

### AC10: WishlistForm Integration Test Added
**Given** the WishlistForm component with image upload
**When** a test renders the form and triggers image upload
**Then** the presign request is intercepted by MSW
**And** the S3 PUT request is intercepted by MSW
**And** the form state updates correctly
**And** no actual backend or S3 calls are made

### AC11: AddItemPage Integration Test Added
**Given** the AddItemPage with full add item flow
**When** a test renders the page and submits with image
**Then** the presign + upload flow completes using MSW
**And** the page state updates correctly
**And** no actual backend or S3 calls are made

### AC12: Fixture Validation Test Added
**Given** test fixtures may drift from production schemas
**When** the fixture validation test runs
**Then** all presign response fixtures validate against `PresignResponseSchema`
**And** the test fails if any fixture is invalid
**And** developers are alerted to schema drift

### AC13: CI Runs Tests Without AWS Credentials
**Given** the CI environment has no AWS credentials
**When** the full test suite runs
**Then** all tests pass
**And** no tests fail due to missing credentials
**And** MSW handles all S3 and API requests

### AC14: MSW Logs Show Request Interception
**Given** tests run in verbose mode
**When** an upload test executes
**Then** MSW request logs show intercepted requests
**And** logs include presign and S3 PUT requests
**And** no unhandled network requests are logged

### AC15: Fixtures Use TypeScript `satisfies` for Type Safety
**Given** fixtures may have typos or type mismatches
**When** fixtures are defined with `satisfies z.infer<typeof PresignResponseSchema>`
**Then** TypeScript catches type errors at compile time
**And** fixtures are guaranteed to match schema types

---

## Test Plan

*See `_pm/TEST-PLAN.md` for comprehensive test coverage.*

### Summary:

**Happy Path Tests:**
- MSW presign handler intercepts and returns mock response
- MSW S3 PUT handler intercepts and returns 200 OK
- Combined presign + upload flow completes end-to-end
- Test fixtures are imported and used correctly

**Error Cases:**
- Presign request failure (500)
- S3 upload failure (403 Forbidden)
- Network timeout (AbortError)
- Invalid file type validation

**Edge Cases:**
- Large file (9.9 MB, just under limit)
- Concurrent uploads (no state collision)
- Cancel upload mid-progress
- Empty file (0 bytes)

**Required Evidence:**
- All existing `useS3Upload.test.ts` tests pass (16+ tests)
- At least 2 component tests use MSW handlers (WishlistForm, AddItemPage)
- No tests require AWS credentials
- MSW request logs verify interception

---

## Reuse Plan

### Reuse Existing Infrastructure

1. **MSW Setup:**
   - Extend existing `src/test/setup.ts` (already configures MSW server)
   - Add handlers to existing `src/test/mocks/handlers.ts` file
   - Follow existing handler patterns (see health check handler)

2. **Test Patterns:**
   - Follow existing test structure in `useS3Upload.test.ts`
   - Reuse MSW server lifecycle (beforeAll, afterEach, afterAll)
   - Use existing `onUnhandledRequest: 'error'` configuration

3. **Zod Schemas:**
   - Import `PresignResponseSchema` from `@repo/api-client/schemas/wishlist`
   - Validate fixtures against existing schemas
   - No new schema definitions needed

### Reusable Components for Future Stories

1. **Fixtures:**
   - Can be extended for future upload scenarios (WISH-2013 file validation)
   - Reusable across all wishlist-related tests
   - Can be imported by other apps/packages if needed

2. **MSW Handlers:**
   - Can be extended for additional S3 operations (DELETE, LIST)
   - Error injection patterns reusable for other API mocking
   - S3 PUT handler pattern reusable for other S3-backed features

3. **Test Utilities (Future):**
   - Consider creating `createMockFile()` utility for generating test files
   - Consider creating `mockS3Upload()` helper for common upload test setups

---

## Architecture Notes

### Hexagonal Architecture (Ports & Adapters)

This story does not modify production code, so no hexagonal architecture changes. However, test infrastructure follows the same principles:

**Ports (Test Interfaces):**
- Vitest test framework
- MSW interception layer
- Zod schema validation

**Adapters (Test Implementations):**
- MSW handlers (mock API and S3 responses)
- Test fixtures (mock data)
- Test utilities (setup, teardown)

### MSW Handler Implementation

**Presign Handler Pattern:**
```typescript
http.get(`${API_BASE_URL}/wishlist/images/presign`, ({ request }) => {
  const url = new URL(request.url)
  const fileName = url.searchParams.get('fileName')

  return HttpResponse.json({
    presignedUrl: `https://mock-s3.amazonaws.com/lego-moc-bucket/uploads/${fileName}`,
    key: `uploads/${fileName}`,
  })
})
```

**S3 PUT Handler Pattern:**
```typescript
http.put('https://*.amazonaws.com/*', () => {
  return new HttpResponse(null, { status: 200 })
})
```

### Fixture Structure

**Fixtures validate against Zod schemas:**
```typescript
export const mockPresignSuccess = {
  presignedUrl: 'https://mock-s3.amazonaws.com/lego-moc-bucket/uploads/test.jpg',
  key: 'uploads/test.jpg',
} satisfies z.infer<typeof PresignResponseSchema>
```

---

## Infrastructure Notes

**No infrastructure changes.** This story is test-only.

### Test Environment Requirements:

1. **MSW:** Already installed (see `package.json`)
2. **Vitest:** Already configured (see `vitest.config.ts`)
3. **Node.js:** Existing version (no changes)

### CI Configuration:

- Tests must run without AWS credentials in environment
- MSW server lifecycle managed by test setup/teardown
- No additional CI dependencies required

---

## HTTP Contract Plan

**Not applicable.** This story does not modify API endpoints. It mocks existing endpoints for testing purposes.

### Mocked Endpoints:

- `GET /wishlist/images/presign` (mocked by MSW)
- `PUT https://*.amazonaws.com/*` (mocked by MSW)

**Note:** Actual endpoint implementation is covered in WISH-2002 (Add Item Flow).

---

## Seed Requirements

**Not applicable.** Test infrastructure does not require database seeds.

Test fixtures are defined in TypeScript files, not database seeds.

---

## UI/UX Notes

*See `_pm/UIUX-NOTES.md` for full UI/UX review.*

**Verdict:** SKIPPED - No user-facing UI changes

**Justification:** This story is test infrastructure only. No components, pages, or design system changes. Users will not see any differences.

**Future Considerations:** If future stories use this infrastructure for upload UX improvements (progress bars, error messages), those stories should undergo UI/UX review.

---

## Dependencies

### Blocked By:
- **WISH-2007** (Run Migration) - Required for presign endpoint to exist in backend
  - **Note:** This story can proceed independently since it only mocks the endpoint. No actual backend dependency for test infrastructure.

### Blocks:
- **WISH-2013** (File Upload Security) - Security tests will benefit from MSW fixtures
- Future upload-related stories that need reliable integration tests

### Internal Package Dependencies:
- `@repo/api-client` - Zod schemas (`PresignResponseSchema`, etc.)
- `@repo/upload-client` - Upload utility (`uploadToPresignedUrl`)
- `msw` - Already installed
- `vitest` - Already configured

### External Dependencies:
**None.** All required packages already installed.

---

## Risks & Mitigations

### Risk 1: S3 URL Pattern Matching
**Description:** MSW must correctly match S3 presigned URL patterns, which include query params (AWSAccessKeyId, Signature, etc.). Incorrect pattern matching could cause MSW to miss S3 requests.

**Likelihood:** Low
**Impact:** Medium (tests would fail or make real S3 calls)

**Mitigation:**
- Use wildcard patterns: `https://*.amazonaws.com/*` to catch all S3 requests
- Verify MSW request logs show S3 PUT interceptions in all upload tests
- Add test assertion to verify no unhandled requests

---

### Risk 2: Real S3 Calls Leaking in Tests
**Description:** If MSW handlers are not configured correctly, tests might make actual S3 calls, causing test failures in CI or requiring AWS credentials.

**Likelihood:** Low
**Impact:** High (CI failures, security risk)

**Mitigation:**
- MSW is already set to `onUnhandledRequest: 'error'` mode (configured in `setup.ts`)
- Verify no AWS credentials are required to run tests
- Add CI verification that tests pass without AWS credentials
- MSW will error if any unhandled network request occurs

---

### Risk 3: Fixture Drift from Production Schemas
**Description:** Mock presign responses in fixtures might drift from actual backend responses, causing false positives in tests.

**Likelihood:** Medium
**Impact:** Medium (tests pass but production fails)

**Mitigation:**
- Validate all fixtures against Zod schemas from `@repo/api-client`
- Add fixture validation test (AC12)
- Use TypeScript `satisfies` to catch type mismatches at compile time (AC15)
- Document fixture update process in README

---

### Risk 4: MSW Performance Overhead
**Description:** MSW adds overhead to test execution. Large test suites might become slow.

**Likelihood:** Low
**Impact:** Low (developer experience degradation)

**Mitigation:**
- MSW is already used in the repo (minimal overhead)
- Overhead is acceptable for integration tests
- If performance degrades, consider selective MSW usage (only for upload tests)
- Monitor test execution time (< 30s target for unit + integration tests)

---

## Definition of Done

- [ ] MSW presign handler created in `handlers.ts` (AC1)
- [ ] MSW S3 PUT handler created in `handlers.ts` (AC2)
- [ ] Handlers support error injection (500, 403, timeout) (AC3, AC4)
- [ ] Test fixtures created at `src/test/fixtures/s3-mocks.ts` (AC5, AC6)
- [ ] Fixtures include 3 presign responses (success, error, timeout) (AC5)
- [ ] Fixtures include 4 sample files (JPEG, PNG, WebP, .txt) (AC6)
- [ ] All existing `useS3Upload.test.ts` tests pass (16+) (AC7)
- [ ] Concurrent upload test added (AC8)
- [ ] 0-byte file test added (AC9)
- [ ] WishlistForm integration test added (AC10)
- [ ] AddItemPage integration test added (AC11)
- [ ] Fixture validation test added (AC12)
- [ ] CI runs tests without AWS credentials successfully (AC13)
- [ ] MSW logs show request interception in verbose mode (AC14)
- [ ] Fixtures use TypeScript `satisfies` for type safety (AC15)
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] All tests pass locally and in CI
- [ ] Code reviewed and approved
- [ ] Documentation updated (optional README for fixtures)

---

## Out of Scope (Future Work)

- **Playwright E2E MSW Setup:** Browser-mode MSW for Playwright E2E tests → Defer to WISH-2014
- **Visual Regression Tests:** Chromatic snapshots of upload progress → Defer to UX polish story
- **Real S3 Integration Tests:** End-to-end tests against actual S3 (dev environment) → Out of scope
- **Load Testing:** Stress test with 10+ concurrent uploads → Defer to performance story

---

## Notes

### Implementation Approach (Recommended):

1. **Create Fixtures First:**
   - Reduces duplication across tests
   - Provides clear examples of expected responses
   - Validates against Zod schemas early

2. **Add MSW Handlers:**
   - Use fixtures in handlers for consistency
   - Test handlers in isolation (verify they return correct responses)

3. **Update Integration Tests:**
   - Verify existing `useS3Upload.test.ts` tests still pass
   - Add missing edge case tests (concurrent uploads, 0-byte file)

4. **Add Component Tests:**
   - WishlistForm test: Form submission with image upload
   - AddItemPage test: Full add item flow with image upload

5. **Verify CI:**
   - Run tests in CI without AWS credentials
   - Verify no unhandled network requests

### Developer Experience:

- Fixtures should be well-documented (README recommended)
- MSW handlers should be easy to extend for future upload scenarios
- Error injection should be straightforward (configure handler to return error)

### Quality Gates:

- All tests pass without AWS credentials
- No unhandled network requests in test logs
- Fixtures validate against production schemas
- TypeScript `satisfies` ensures type safety

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified
| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Fixture examples in Architecture Notes don't match schema | Not Reviewed | Missing `expiresIn` field in presign fixture example (lines 316-320) |
| 2 | TypeScript version requirement for `satisfies` operator not documented | Not Reviewed | AC15 uses `satisfies` operator which requires TS 4.9+; add to prerequisites |

### Enhancement Opportunities
| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Consider creating reusable `createMockFile()` utility | Not Reviewed | Story mentions as future enhancement (lines 269-270) |
| 2 | Consider `mockS3Upload()` helper for common test setups | Not Reviewed | Story mentions as future enhancement (line 270) |
| 3 | Monitor test execution time for MSW performance | Not Reviewed | Risk 4 mitigation suggests monitoring; target < 30s for unit + integration |

### Follow-up Stories Suggested
- [x] WISH-2013: File Upload Security - Will benefit from MSW fixtures and handlers → WISH-2013
- [x] Playwright E2E MSW Setup - Browser-mode MSW explicitly deferred → WISH-2121
- [x] Consider: Test utility helpers (`createMockFile`, `mockS3Upload`) as future enhancement → WISH-2120

### Items Marked Out-of-Scope
- **Playwright E2E MSW Setup**: Browser-mode MSW for Playwright deferred to future story
- **Visual Regression Tests**: Chromatic snapshots out of scope; no design system changes
- **Real S3 Integration Tests**: End-to-end tests against actual S3 explicitly out of scope
- **Load Testing**: Stress testing deferred to performance story
- **Implementation Changes**: Test infrastructure only; no production code changes
