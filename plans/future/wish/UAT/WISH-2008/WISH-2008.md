---
doc_type: story
title: "WISH-2008: Authorization Layer Testing and Policy Documentation"
story_id: WISH-2008
story_type: infra
story_prefix: WISH
status: uat
phase: 3
created_at: "2026-01-28T00:00:00-07:00"
updated_at: "2026-01-30T19:45:00Z"
depends_on: [WISH-2001, WISH-2002, WISH-2003, WISH-2004, WISH-2005]
priority: P0
estimated_points: 3
sizing_warning: false
---

# WISH-2008: Authorization Layer Testing and Policy Documentation - Phase 3 Security & Testing

## Context

The wishlist feature (WISH-2001 through WISH-2005) implemented comprehensive CRUD operations, image uploads, reordering, and purchase workflows. However, these stories focused on happy-path functionality and did not include systematic authorization testing or security policy documentation.

**Critical Security Gap Identified:**
During epic elaboration, the Security & QA perspectives identified that all core wishlist endpoints lack comprehensive authorization verification:
- No systematic testing of cross-user access prevention
- Authorization middleware consistency not verified across all endpoints
- Database queries may be missing userId filters in WHERE clauses
- S3 presigned URL path isolation not formally tested
- No audit logging for unauthorized access attempts
- Security policies undocumented

Without proper authorization checks, users could potentially access, modify, or delete other users' wishlist items, violating data privacy and security requirements.

**Dependency Context:**
- WISH-2000: Database schema includes userId, createdBy, updatedBy audit fields
- WISH-2001: Gallery MVP with GET /api/wishlist and GET /api/wishlist/:id
- WISH-2002: Add item flow with POST /api/wishlist and S3 presigned URLs
- WISH-2003: Detail & edit with PATCH /api/wishlist/:id
- WISH-2004: Delete and purchase flows (split into WISH-2041, WISH-2042)
- WISH-2005: Reorder flow with PUT /api/wishlist/reorder

All these endpoints require ownership verification to ensure users can only access their own data.

## Goal

Verify and document that all wishlist endpoints enforce proper authorization checks through comprehensive testing and security policy documentation, preventing cross-user data access and establishing a foundation for future role-based access control.

## Non-goals

- Implementing new authorization features (middleware already exists)
- Role-based access control (admin users) - deferred to Phase 4
- Rate limiting or DDoS protection - separate story (WISH-XXXX)
- OAuth provider integration - out of scope
- Multi-tenant architecture changes - single-user ownership model sufficient for MVP
- Frontend authorization checks - API layer enforcement only
- Historical audit log viewer UI - deferred to Phase 5
- Penetration testing - manual QA security testing sufficient for MVP

## Scope

### Endpoints Affected

**All Wishlist Endpoints (Authorization Verification):**
- `GET /api/wishlist` - Verify userId filter in list query
- `GET /api/wishlist/:id` - Verify userId filter for item retrieval
- `POST /api/wishlist` - Verify userId injected from JWT on creation
- `PATCH /api/wishlist/:id` - Verify userId filter for update authorization
- `DELETE /api/wishlist/:id` - Verify userId filter for delete authorization
- `PUT /api/wishlist/reorder` - Verify userId filter for all itemIds in reorder
- `POST /api/wishlist/:id/purchased` - Verify userId filter for purchase authorization
- `GET /api/wishlist/images/presign` - Verify S3 path includes userId prefix

### Packages Affected

1. **Backend - Wishlist Domain**: `apps/api/lego-api/domains/wishlist/`
   - `routes.ts` - Verify auth middleware applied to all routes
   - `repositories.ts` - Audit all queries for userId WHERE clauses
   - `services.ts` - Verify userId extracted from JWT context
   - **Changes:** Code audit + minor fixes for missing userId filters

2. **Backend - Auth Middleware**: `apps/api/lego-api/middleware/`
   - `auth.ts` - Review Cognito JWT validation and sub claim extraction
   - **Changes:** Documentation only (middleware likely already correct)

3. **Backend - Observability**: `apps/api/lego-api/core/observability/`
   - `logger.ts` - Add structured logging for authorization failures
   - **Changes:** 5-10 new log statements for 403/404 audit trail

4. **Documentation**: `packages/backend/database-schema/docs/`
   - `wishlist-authorization-policy.md` - New security policy document
   - **Changes:** New file creation (~200 lines)

5. **Integration Tests**: `__http__/`
   - `wishlist-authorization.http` - New test file with 20+ authorization scenarios
   - **Changes:** New file creation (~400 lines)

### Infrastructure Impact

**No infrastructure changes required:**
- Authorization middleware already deployed
- Cognito JWT validation already configured
- CloudWatch logging already set up
- Database schema already includes userId foreign key

**Testing Requirements:**
- Multi-user seed data (User A, User B with distinct wishlist items)
- Valid Cognito JWT tokens for test users
- Local S3 (MinIO/localstack) for presigned URL testing

## Acceptance Criteria

### AC1: All repository methods include userId filters
**Verify:**
- Every SELECT query in `wishlist-repository.ts` includes `WHERE userId = ?`
- Every UPDATE query includes `WHERE id = ? AND userId = ?`
- Every DELETE query includes `WHERE id = ? AND userId = ?`
- Reorder query validates all itemIds belong to authenticated user

**Evidence:** Code review + unit tests asserting WHERE clause structure

---

### AC2: Auth middleware consistently applied to all routes
**Verify:**
- All 8 wishlist routes use auth middleware
- Middleware extracts Cognito JWT `sub` claim as userId
- Middleware attaches userId to request context

**Test:** HTTP requests without Authorization header return 401 Unauthorized

**Evidence:** Integration tests + middleware unit tests

---

### AC3: Cross-user GET access returns 404 Not Found
**Scenario:**
- User A authenticated
- User B has item with id=456

**Test:**
```http
GET /api/wishlist/456
Authorization: Bearer {USER_A_TOKEN}
```

**Expected:** 404 Not Found (item not found for User A's userId)

**Evidence:** Integration test + audit log entry for unauthorized attempt

---

### AC4: Cross-user PATCH access returns 404 Not Found
**Scenario:**
- User A authenticated
- User B has item with id=456

**Test:**
```http
PATCH /api/wishlist/456
Authorization: Bearer {USER_A_TOKEN}
Content-Type: application/json
{ "price": 999.99 }
```

**Expected:** 404 Not Found, item NOT updated

**Evidence:** Integration test + database verification (item unchanged)

---

### AC5: Cross-user DELETE access returns 404 Not Found
**Scenario:**
- User A authenticated
- User B has item with id=456

**Test:**
```http
DELETE /api/wishlist/456
Authorization: Bearer {USER_A_TOKEN}
```

**Expected:** 404 Not Found, item NOT deleted

**Evidence:** Integration test + database verification (item still exists)

---

### AC6: Unauthenticated requests return 401 Unauthorized
**Test all 8 endpoints without Authorization header:**
```http
GET /api/wishlist
# No Authorization header
```

**Expected:** 401 Unauthorized, error message: "Authentication required"

**Evidence:** Integration tests for all endpoints

---

### AC7: Expired JWT tokens return 401 Unauthorized
**Test:**
```http
GET /api/wishlist
Authorization: Bearer {EXPIRED_TOKEN}
```

**Expected:** 401 Unauthorized, error message: "Token expired"

**Evidence:** Integration test + JWT middleware unit test

---

### AC8: Invalid JWT signatures return 401 Unauthorized
**Test:**
```http
GET /api/wishlist
Authorization: Bearer {INVALID_SIGNATURE_TOKEN}
```

**Expected:** 401 Unauthorized, error message: "Invalid token"

**Evidence:** Integration test + JWT middleware unit test

---

### AC9: POST creates item with authenticated user's userId
**Test:**
```http
POST /api/wishlist
Authorization: Bearer {USER_A_TOKEN}
Content-Type: application/json
{
  "title": "UCS Millennium Falcon",
  "setNumber": "75192",
  "price": 849.99,
  "currency": "USD"
}
```

**Expected:**
- 201 Created
- Response item.userId matches USER_A_TOKEN sub claim
- Database record userId = User A's ID

**Evidence:** Integration test + database verification

---

### AC10: GET /api/wishlist returns only authenticated user's items
**Scenario:**
- User A has 5 items
- User B has 3 items

**Test:**
```http
GET /api/wishlist
Authorization: Bearer {USER_A_TOKEN}
```

**Expected:**
- 200 OK
- Response contains only User A's 5 items
- User B's items NOT included

**Evidence:** Integration test + database query verification

---

### AC11: PUT /api/wishlist/reorder validates item ownership
**Scenario:**
- User A authenticated
- User B has items with ids [10, 11, 12]

**Test:**
```http
PUT /api/wishlist/reorder
Authorization: Bearer {USER_A_TOKEN}
Content-Type: application/json
{ "itemIds": [11, 10, 12] }
```

**Expected:** 400 Bad Request with error: "One or more item IDs are invalid or do not belong to you"

**Evidence:** Integration test + User B's sortOrder unchanged

---

### AC12: POST /:id/purchased verifies item ownership
**Scenario:**
- User A authenticated
- User B has item with id=456

**Test:**
```http
POST /api/wishlist/456/purchased
Authorization: Bearer {USER_A_TOKEN}
Content-Type: application/json
{ "purchaseDate": "2026-01-28", "actualPrice": 799.99 }
```

**Expected:** 404 Not Found, item NOT marked as purchased

**Evidence:** Integration test + database verification (item unchanged)

---

### AC13: GET /images/presign generates user-scoped S3 paths
**Test:**
```http
GET /api/wishlist/images/presign?filename=falcon.jpg&contentType=image/jpeg
Authorization: Bearer {USER_A_TOKEN}
```

**Expected:**
- 200 OK
- Presigned URL path format: `wishlist/{USER_A_ID}/images/falcon.jpg`
- URL includes userId from JWT sub claim

**Evidence:** Integration test + S3 path verification

---

### AC14: Audit logging for unauthorized access attempts
**Verify:**
- All 404 responses for cross-user access log structured event
- Log includes: timestamp, userId (if authenticated), itemId, endpoint, HTTP method

**Expected Log Format:**
```json
{
  "level": "warn",
  "message": "Unauthorized wishlist access attempt",
  "userId": "user-a-id",
  "itemId": "456",
  "endpoint": "GET /api/wishlist/456",
  "statusCode": 404,
  "timestamp": "2026-01-28T12:00:00Z"
}
```

**Evidence:** Integration test + CloudWatch log verification

---

### AC15: Security policy document created
**Document:** `packages/backend/database-schema/docs/wishlist-authorization-policy.md`

**Required Sections:**
1. Ownership Model (single-user ownership via userId foreign key)
2. Authentication Requirements (Cognito JWT, sub claim extraction)
3. Authorization Rules (userId filters in all queries, 404 for cross-user access)
4. Audit Logging (structured logs for 403/404 events)
5. S3 Path Isolation (user-scoped prefixes)
6. Future Enhancements (role-based access control for admin users)

**Evidence:** Document exists and passes markdown linting

---

### AC16: Integration test suite with 20+ authorization scenarios
**Test File:** `__http__/wishlist-authorization.http`

**Minimum Coverage:**
- 8 happy path tests (authenticated user accesses own items)
- 6 cross-user access tests (expect 404)
- 2 unauthenticated tests (expect 401)
- 2 invalid JWT tests (expired, invalid signature - expect 401)
- 2 edge case tests (empty userId, concurrent requests)

**Evidence:** HTTP file created with all scenarios passing

---

### AC17: Unit tests for authorization middleware
**Test Coverage:**
- JWT parsing (valid token, expired token, invalid signature, missing sub claim)
- Sub claim extraction and userId attachment to request context
- Error handling (malformed tokens, missing Authorization header)

**Minimum:** 10 unit tests

**Evidence:** Test file created, all tests passing

---

### AC18: Integration tests for all 8 endpoints
**Test Coverage:**
- Each endpoint tested with valid authentication (happy path)
- Each endpoint tested without Authorization header (401)
- Each endpoint tested with cross-user access (404)

**Minimum:** 20 integration tests (8 happy + 8 unauthorized + 4 cross-user)

**Evidence:** Test file created, all tests passing

---

### AC19: Code review with security focus
**Required:**
- Security engineer or senior developer reviews all repository queries
- Confirms all queries include userId filters
- Confirms auth middleware consistently applied
- Confirms audit logging implemented

**Evidence:** GitHub PR approval from designated security reviewer

---

### AC20: QA verification complete
**Manual Testing:**
- QA attempts cross-user access with Postman/Insomnia
- QA verifies audit logs written to CloudWatch
- QA confirms S3 path isolation prevents cross-user uploads

**Evidence:** QA sign-off in verification ticket

---

### AC21: Audit Trail Field Documentation

**Document:** Create section in `wishlist-authorization-policy.md` (AC 15) explicitly documenting that `createdBy` and `updatedBy` fields are for audit trail only, not for authorization decisions.

**Required Sections:**
- `createdBy` and `updatedBy` are read-only audit fields
- Authorization always uses `userId` foreign key, never `createdBy`
- Implications: Users cannot impersonate creators; only authenticated user can authorize own access

**Evidence:** Documentation section added and reviewed

---

### AC22: Malformed Authorization Header Edge Cases

**Extend:** AC 17 unit tests with 2 additional edge case tests for malformed headers.

**Test Cases:**
1. Authorization header missing "Bearer " prefix: `Authorization: {TOKEN}` → 401 Unauthorized
2. Authorization header with extra whitespace: `Authorization: Bearer  {TOKEN}` → 401 Unauthorized

**Expected:** Both cases return 401 Unauthorized with clear error messages

**Evidence:** Tests added to `apps/api/lego-api/middleware/__tests__/auth.test.ts` and passing

---

### AC23: Presigned URL Expiration Testing

**Extend:** AC 16 integration tests with test for presigned URL expiration.

**Test Scenario:**
```http
# Step 1: Request presigned URL
GET /api/wishlist/images/presign?filename=test.jpg&contentType=image/jpeg
Authorization: Bearer {USER_TOKEN}
Response: 200 OK with presigned URL (TTL: 15 minutes)

# Step 2: Immediately use presigned URL
PUT {PRESIGNED_URL}
Content-Type: image/jpeg
[binary image data]
Response: 200 OK - Upload succeeds

# Step 3: Wait 15+ minutes, attempt to use expired presigned URL
PUT {PRESIGNED_URL}
Content-Type: image/jpeg
[binary image data]
Response: 403 Forbidden - URL expired
```

**Expected:** Presigned URL becomes unusable after 15-minute TTL expiration

**Evidence:** Integration test added to `__http__/wishlist-authorization.http` and passing

---

### AC24: Rate Limiting for Authorization Failures (Brute-Force Protection)

**Implement:** Rate limiting middleware for brute-force protection on authorization failures.

**Requirement:** Middleware that:
- Counts failed authentication/authorization attempts (401/403 responses) per IP address
- Enforces limit: 10 failures per 5-minute window per IP
- Returns 429 Too Many Requests after limit exceeded
- Logs rate limit violations with IP, attempted endpoint, and timestamp
- Applies to all API endpoints returning 401/403

**Configuration:**
- Window: 5 minutes sliding
- Max failures: 10 per IP per window
- Response: 429 with `Retry-After` header
- Log level: warn

**Implementation Location:** `apps/api/lego-api/middleware/rate-limit.ts`

**Test Coverage:**
- Unit tests: Rate limit counter increments on 401/403, resets on 200
- Unit tests: 429 returned after threshold exceeded
- Integration tests: Verify 10 failures → 429, verify window sliding
- Integration tests: Verify rate limit bypassed for 200/204 responses

**Evidence:** Middleware implemented, tests passing, applied to all routes

---

## Reuse Plan

### Existing Components (Verified/Extended)
- Cognito JWT authentication middleware - verify sub claim extraction
- Logger utility (@repo/logger) - extend with authorization failure logging
- Wishlist repository - audit for userId filters
- Wishlist service - verify userId passed to repository methods
- HTTP test infrastructure - extend with authorization scenarios

### New Components
- `wishlist-authorization-policy.md` - Security policy document
- `__http__/wishlist-authorization.http` - Authorization test suite
- Authorization middleware unit tests
- Cross-user access integration tests
- Audit logging for 403/404 events

### Existing Patterns
- Hexagonal architecture (ports/adapters) - no changes needed
- Zod schema validation - reuse for JWT claim validation
- Structured logging - extend for security events
- HTTP test patterns - reuse for authorization scenarios

## Architecture Notes (Ports & Adapters)

### Hexagonal Architecture Compliance

**No Architecture Violations:**
This story verifies existing architecture rather than introducing new components.

**Domain Layer** (Business Logic):
- `wishlist-service.ts` - Verify userId extracted from request context and passed to repository
- Authorization logic remains in middleware (adapter layer), not domain

**Adapter Layer** (Infrastructure):
- `auth.ts` middleware - Cognito JWT validation (inbound adapter)
- `wishlist-repository.ts` - Database queries with userId filters (outbound adapter)
- `logger.ts` - Audit logging (outbound adapter)

**Port Layer** (Contracts):
- `types.ts` - No new types required
- JWT claims validated via Zod schema

**Separation of Concerns:**
- Authentication (JWT validation) in middleware adapter
- Authorization (ownership verification) in repository WHERE clauses
- Domain service remains pure business logic (no auth coupling)

## Infrastructure Notes

### No Infrastructure Changes Required

**Existing Infrastructure (Verified):**
- Cognito User Pool - JWT token generation and validation
- API Gateway - Authorization header forwarding
- CloudWatch Logs - Structured logging destination
- PostgreSQL - userId foreign key constraints
- S3 - User-scoped path prefixes (wishlist/{userId}/images/)

**Testing Infrastructure:**
- Local PostgreSQL with multi-user seed data
- LocalStack or MinIO for S3 testing
- Valid Cognito JWT tokens generated for test users (User A, User B)

### Environment Variables (No Changes)

Existing variables verified:
- `COGNITO_USER_POOL_ID` - JWT validation
- `COGNITO_CLIENT_ID` - JWT audience validation
- `DATABASE_URL` - PostgreSQL connection
- `S3_BUCKET_NAME` - Presigned URL generation

## Test Plan

### Backend Unit Tests (10+ Tests)

**Authorization Middleware Tests:**
1. Valid JWT token - extract sub claim as userId
2. Expired JWT token - return 401
3. Invalid JWT signature - return 401
4. Missing Authorization header - return 401
5. Malformed JWT token - return 401
6. JWT missing sub claim - return 401
7. JWT with invalid sub format - return 401
8. JWT middleware attaches userId to request context
9. JWT middleware calls next() on success
10. JWT middleware short-circuits on failure

**Test File:** `apps/api/lego-api/middleware/__tests__/auth.test.ts`

---

### Backend Integration Tests (20+ Tests)

**HTTP Test File:** `__http__/wishlist-authorization.http`

**Happy Path Tests (8):**
1. Authenticated user lists own items
2. Authenticated user retrieves own item by ID
3. Authenticated user creates item
4. Authenticated user updates own item
5. Authenticated user deletes own item
6. Authenticated user reorders own items
7. Authenticated user marks own item as purchased
8. Authenticated user requests presigned URL

**Authorization Failure Tests (6):**
9. User A attempts GET User B's item → 404
10. User A attempts PATCH User B's item → 404
11. User A attempts DELETE User B's item → 404
12. User A attempts reorder with User B's itemIds → 400
13. User A attempts purchase User B's item → 404
14. Verify audit logs written for all unauthorized attempts

**Authentication Failure Tests (4):**
15. GET /api/wishlist without Authorization header → 401
16. POST /api/wishlist with expired token → 401
17. PATCH /api/wishlist/:id with invalid signature → 401
18. DELETE /api/wishlist/:id with malformed token → 401

**Edge Case Tests (2):**
19. User with no items returns empty array (200)
20. Concurrent PATCH requests to same item (last-write-wins)

---

### Manual QA Testing (Security Focus)

**QA Manual Test Scenarios:**
1. **Cross-User Access Prevention:**
   - QA creates User A and User B in Cognito
   - QA adds items for both users via API
   - QA attempts User A accessing User B's item → verify 404
   - QA verifies audit log entry in CloudWatch

2. **S3 Path Isolation:**
   - QA requests presigned URL for User A
   - QA attempts to upload to User B's S3 prefix → verify failure
   - QA verifies uploaded file only accessible by User A

3. **JWT Token Expiration:**
   - QA generates token with short expiration (5 minutes)
   - QA waits for expiration
   - QA attempts API call with expired token → verify 401

4. **Audit Log Verification:**
   - QA performs unauthorized access attempts
   - QA reviews CloudWatch logs
   - QA confirms structured log entries with userId, itemId, endpoint

---

## UI/UX Notes

**Verdict:** SKIPPED

**Justification:** WISH-2008 is backend-only (authorization verification and policy documentation). No UI components or user-facing changes.

**Frontend Impact:** None
- Existing API error handling already supports 401/403/404 responses
- RTK Query automatically handles authorization errors
- No new UI components required

**Future Considerations:**
- Admin dashboard for viewing all users' items (Phase 4)
- Audit log viewer UI (Phase 5)

## Risks & Mitigations

### MVP-Critical Risks

**Risk 1: Missing userId Filters in Database Queries**
- **Severity:** Critical (security vulnerability)
- **Likelihood:** Medium
- **Mitigation:** Comprehensive code audit + integration tests for all endpoints
- **Verification:** Security-focused code review + QA manual testing

**Risk 2: S3 Presigned URL Path Isolation Gaps**
- **Severity:** High (cross-user file access)
- **Likelihood:** Low
- **Mitigation:** Integration test attempting cross-user S3 upload
- **Verification:** Manual QA testing with LocalStack

**Risk 3: Inconsistent Auth Middleware Application**
- **Severity:** Critical (unauthenticated access)
- **Likelihood:** Low
- **Mitigation:** Integration tests without Authorization header for all endpoints
- **Verification:** Automated test suite

**Risk 4: JWT Sub Claim Extraction Errors**
- **Severity:** Critical (userId mismatch)
- **Likelihood:** Low
- **Mitigation:** Unit tests for JWT middleware + integration tests verifying userId
- **Verification:** Automated test suite

**Risk 5: Audit Logging Blind Spots**
- **Severity:** Medium (incident investigation impact)
- **Likelihood:** Medium
- **Mitigation:** Integration tests verify log entries + QA CloudWatch review
- **Verification:** Manual QA verification

### Non-MVP Risks (Future Work)

- Rate limiting for brute-force authorization attempts - deferred to WISH-XXXX
- Role-based access control (admin users) - deferred to Phase 4
- Historical audit log retention policy - deferred to Phase 5
- Penetration testing and security audit - deferred to pre-production phase

## Open Questions

### Q1: Should cross-user access return 403 Forbidden or 404 Not Found?

**Decision:** 404 Not Found

**Rationale:** Prevents item ID enumeration attacks. An attacker could probe item IDs and identify valid items by distinguishing 403 (exists but forbidden) from 404 (doesn't exist). Returning 404 for both cases improves security.

**Implementation:** Backend logs 403 internally for audit but returns 404 to client.

---

### Q2: How should reorder endpoint handle unauthorized itemIds?

**Decision:** Return 400 Bad Request with clear error message

**Rationale:** Rejecting entire request is more secure than silently filtering unauthorized IDs. User explicitly knows which IDs are invalid.

**Error Message:** "One or more item IDs are invalid or do not belong to you."

---

### Q3: How should concurrent updates be handled?

**Decision:** Last-write-wins (no optimistic locking for MVP)

**Rationale:** Optimistic locking adds complexity for MVP. Last-write-wins is acceptable for single-user updates. Concurrent updates across different users already prevented by authorization.

**Future:** Optimistic locking with version field deferred to Phase 4 (WISH-XXXX).

---

## Definition of Done

- [ ] All 24 Acceptance Criteria pass (original 20 + 4 new ACs from QA elaboration)
- [ ] Backend: 10+ authorization middleware unit tests pass (including AC 22 malformed header tests)
- [ ] Backend: 20+ HTTP integration tests pass (including AC 23 presigned URL expiration test)
- [ ] Security policy document created and reviewed (including AC 21 audit trail field documentation)
- [ ] All repository methods audited for userId filters
- [ ] Audit logging implemented for 403/404 events
- [ ] Rate limiting middleware implemented for 401/403 brute-force protection (AC 24)
- [ ] `.http` file with 20+ authorization scenarios created
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved (security-focused reviewer)
- [ ] QA verification complete (manual security testing)

## Follow-up Stories (Future)

### Phase 4 - Role-Based Access Control
- **WISH-XXXX:** Admin role with read-all wishlist access
- **WISH-XXXX:** User impersonation for customer support

### Phase 5 - Security Enhancements
- **WISH-XXXX:** Rate limiting for authorization attempts
- **WISH-XXXX:** Audit log viewer UI
- **WISH-XXXX:** Historical audit log retention policy

### Infrastructure
- **WISH-XXXX:** Penetration testing and security audit
- **WISH-XXXX:** CloudWatch alarms for authorization failures

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Generation | ~15k | — | — | PM orchestration + 3 workers |
| Implementation | ~12k | — | — | Code audit + tests + docs |
| Code Review | ~6k | — | — | Security-focused review |
| **Total** | ~33k | — | — | Medium-sized story (verification-focused) |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | CloudWatch metrics not instrumented for authorization events | Out-of-scope | Separate infrastructure story, not blocking MVP |
| 2 | Load testing not included for authorization performance | Out-of-scope | Performance testing deferred to Phase 5 |
| 3 | createdBy/updatedBy audit trail fields lack documentation | Add as AC | New AC 21: Document that createdBy/updatedBy fields are for audit trail only, not authorization |
| 4 | Malformed Authorization header edge cases not covered in tests | Add as AC | New AC 22: Add 2 edge case tests for malformed headers (missing Bearer prefix, extra whitespace) |
| 5 | Presigned URL expiration testing not included | Add as AC | New AC 23: Add integration test verifying presigned URL returns 403 after 15-minute expiration |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Rate limiting not implemented for brute-force protection | Add as AC | New AC 24: Implement rate limiting middleware for 401/403 responses (10 failures per 5 minutes per IP) |
| 2 | Audit log viewer UI not included | Out-of-scope | Deferred to Phase 5 |
| 3 | CloudWatch alarms for authorization failures not configured | Out-of-scope | Infrastructure story, not blocking MVP |
| 4 | Log retention policy not defined | Out-of-scope | Deferred to Phase 5 governance |
| 5 | Penetration testing not included | Out-of-scope | Manual security testing sufficient for MVP |
| 6 | JWT token refresh handling not specified | Out-of-scope | Cognito handles JWT refresh automatically |
| 7 | Multi-factor authentication step-up not included | Out-of-scope | Deferred to Phase 4 security enhancements |
| 8 | OPA/Cedar policy engine not implemented | Out-of-scope | Over-engineered for MVP single-tenant ownership model |
| 9 | IP/geolocation logging for suspicious access patterns | Follow-up story | Create WISH-2XXX: Log IP address and country for 403/404 events to detect suspicious access patterns |
| 10 | S3 versioning not implemented for audit trail | Skip | S3 lifecycle policies handle retention; versioning adds complexity without MVP value |

### Follow-up Stories Suggested

- [x] WISH-2047: IP/Geolocation Logging (Phase 5) - Log IP address and country for 403/404 events to detect suspicious access patterns

### Items Marked Out-of-Scope

- **CloudWatch metrics for authorization events**: Separate infrastructure/observability story
- **Load testing for authorization layer**: Performance testing deferred to Phase 5
- **Audit log viewer UI**: Dashboard feature deferred to Phase 5
- **CloudWatch alarms for authorization failures**: Infrastructure monitoring story
- **Log retention policy governance**: Platform-wide policy decision for Phase 5
- **Penetration testing**: Manual security testing sufficient for MVP; formal pen testing deferred to pre-production
- **JWT token refresh handling**: Already managed by Cognito
- **Multi-factor authentication step-up**: Phase 4 security enhancement
- **OPA/Cedar policy engine**: Over-engineered for single-user MVP; deferred to multi-tenant phase
- **S3 versioning for audit trail**: Lifecycle policies sufficient; versioning skipped for MVP

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-28 00:00 | pm-story-generation-leader | Generated story from index entry | WISH-2008.md, _pm/TEST-PLAN.md, _pm/DEV-FEASIBILITY.md, _pm/UIUX-NOTES.md |
| 2026-01-28 19:44 | elab-completion-leader | Completed elaboration with user decisions | ELAB-WISH-2008.md, WISH-2008.md updated with QA notes, 4 new ACs added |
