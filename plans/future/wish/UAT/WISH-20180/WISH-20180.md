---
doc_type: story
title: "WISH-20180: CI Job to Validate Schema Changes Against Policy"
story_id: WISH-20180
story_prefix: WISH
status: uat
phase: 2
created_at: "2026-01-29T19:00:00-07:00"
updated_at: "2026-01-31T23:00:00Z"
depends_on: [WISH-2057]
follow_up_from: WISH-2057
estimated_points: 3
---

# WISH-20180: CI Job to Validate Schema Changes Against Policy

## Follow-up Context

**Parent Story:** WISH-2057
**Source:** QA Discovery Notes (Follow-up Stories Suggested - Finding #1)
**Original Finding:** "CI job to validate schema changes against policy (automated governance)"
**Category:** Enhancement Opportunity
**Impact:** High
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-2057 as a critical enhancement to automate governance of schema changes. WISH-2057 establishes comprehensive schema evolution policies, but manual enforcement during code review is error-prone and slow. This story automates policy enforcement via CI checks.

## Context

WISH-2057 documents comprehensive schema evolution policies in `packages/backend/database-schema/docs/SCHEMA-EVOLUTION-POLICY.md` covering breaking vs non-breaking changes, approval processes, and migration requirements. However, policy documentation alone cannot guarantee compliance. Developers may inadvertently violate policies (e.g., adding required columns without defaults, removing enum values, skipping migration testing).

Without automated validation, policy violations are only caught during manual code review, which:
- Slows down PR merge velocity
- Creates inconsistent enforcement across reviewers
- Increases risk of production issues from policy violations
- Wastes reviewer time on mechanical checks

This story implements a CI job that automatically validates schema changes against the documented policies from WISH-2057, providing fast feedback to developers and reducing reviewer burden.

## Goal

Implement automated CI validation of database schema changes against schema evolution policies from WISH-2057. Provide developers with immediate feedback on policy violations during PR submission, reducing manual review burden and preventing policy violations from reaching production.

## Non-goals

- Implementing schema migration generation tools (handled by Drizzle)
- Automated migration rollback testing (future enhancement)
- Schema change approval workflow automation (future enhancement)
- Database backup/restore automation (separate infrastructure concern)
- Policy enforcement beyond schema changes (e.g., code style, API design)

## Scope

### CI Job Implementation

1. **GitHub Actions Workflow** (`.github/workflows/schema-validation.yml`)
   - Triggered on PRs modifying `packages/backend/database-schema/`
   - Runs schema validation script
   - Posts validation results as PR comment
   - Fails CI if critical policy violations detected

2. **Schema Validation Script** (`packages/backend/database-schema/scripts/validate-schema-changes.ts`)
   - Detects schema changes via git diff
   - Validates migration file naming conventions
   - Checks for breaking changes (column removals, enum removals, type changes)
   - Validates required columns have defaults or backfill migrations
   - Ensures migration journal (`meta/_journal.json`) is updated
   - Validates migration SQL syntax
   - Checks for concurrent index creation (CREATE INDEX CONCURRENTLY)

3. **Policy Validation Rules** (implementation of WISH-2057 policies)
   - Breaking change detection: column/table drops, enum value removals, type changes
   - Non-breaking change validation: optional columns, enum additions, indexes
   - Migration file naming: `XXXX_description.sql` pattern from WISH-2057 AC 5
   - Backward compatibility checks: required columns must have defaults
   - Migration testing requirements: fresh database test documented

### Packages Affected

- `.github/workflows/` - New CI workflow for schema validation
- `packages/backend/database-schema/scripts/` - Validation script implementation
- `packages/backend/database-schema/docs/` - CI validation documentation

### Cross-References

- WISH-2057: Parent story with schema evolution policies
- WISH-2007: Initial migration that creates schema validation needs
- Future stories requiring schema changes (benefits from automated validation)

## Acceptance Criteria

### CI Workflow Setup (AC 1-5)

- [ ] AC 1: GitHub Actions workflow triggers on PRs touching `packages/backend/database-schema/src/`
- [ ] AC 2: Workflow runs `pnpm --filter @repo/database-schema validate:schema` command
- [ ] AC 3: Workflow posts validation results as PR comment (violations, warnings, approvals)
- [ ] AC 4: Workflow fails CI if critical violations detected (breaking changes without policy compliance)
- [ ] AC 5: Workflow passes CI if only warnings or no violations (non-blocking for non-breaking changes)

### Migration File Validation (AC 6-9)

- [ ] AC 6: Script validates migration file naming follows `XXXX_description.sql` pattern (WISH-2057 AC 5)
- [ ] AC 7: Script checks `meta/_journal.json` is updated with new migration entry
- [ ] AC 8: Script validates migration SQL syntax using PostgreSQL parser or linter
- [ ] AC 9: Script detects duplicate migration numbers (collision detection)

### Breaking Change Detection (AC 10-14)

- [ ] AC 10: Script detects column drops (`DROP COLUMN`) and flags as breaking change
- [ ] AC 11: Script detects table drops (`DROP TABLE`) and flags as breaking change
- [ ] AC 12: Script detects enum value removals (complex ALTER TYPE) and flags as breaking change
- [ ] AC 13: Script detects column type changes (`ALTER COLUMN TYPE`) and flags as breaking change
- [ ] AC 14: Script requires deprecation documentation for breaking changes (comment in migration or policy doc reference)

### Non-Breaking Change Validation (AC 15-18)

- [ ] AC 15: Script validates optional column additions have default values or nullable constraints
- [ ] AC 16: Script validates required column additions include backfill migration strategy (comment in SQL)
- [ ] AC 17: Script validates index creation uses `CONCURRENTLY` keyword for production safety (WISH-2057 AC 16)
- [ ] AC 18: Script validates enum additions use `ALTER TYPE ... ADD VALUE` syntax (WISH-2057 AC 6)

### Governance and Documentation (AC 19-20)

- [ ] AC 19: CI job documentation added to `packages/backend/database-schema/docs/CI-SCHEMA-VALIDATION.md`
- [ ] AC 20: Validation rules reference specific sections of `SCHEMA-EVOLUTION-POLICY.md` from WISH-2057

## Reuse Plan

### Existing Tools

- **Drizzle Migration System**: Read `meta/_journal.json` for migration state
- **GitHub Actions**: Existing CI infrastructure for workflow execution
- **PostgreSQL Parser**: Use existing SQL parsers (pg-query-parser or sql-parser-cst) for syntax validation
- **Git Diff**: Detect schema file changes using `git diff` commands

### Industry Patterns

- **Schema Linting**: Follow patterns from tools like sqlfluff, pg-lint
- **Migration Testing**: Reference Rails Strong Migrations gem for breaking change detection
- **CI Gating**: Follow Stripe's approach to schema change CI gates

## Architecture Notes

### Breaking Change Detection Strategy

The script will analyze migration SQL files using AST parsing to detect:

**Breaking Changes (fail CI):**
```sql
-- Detected: DROP COLUMN
ALTER TABLE wishlist_items DROP COLUMN old_field;

-- Detected: DROP TABLE
DROP TABLE deprecated_table;

-- Detected: Type change
ALTER TABLE wishlist_items ALTER COLUMN price TYPE INTEGER;

-- Detected: Remove enum value (requires complex migration)
-- Creates new enum, migrates data, drops old enum
```

**Non-Breaking Changes (pass CI with checks):**
```sql
-- Validated: Optional column with default
ALTER TABLE wishlist_items ADD COLUMN new_field TEXT DEFAULT 'default_value';

-- Validated: Enum addition
ALTER TYPE wishlist_store ADD VALUE 'Amazon';

-- Validated: Concurrent index
CREATE INDEX CONCURRENTLY idx_user_id ON wishlist_items(user_id);
```

### Migration Journal Validation

Drizzle tracks migrations in `meta/_journal.json`:

```json
{
  "version": "5",
  "dialect": "postgresql",
  "entries": [
    {
      "idx": 0,
      "version": "5",
      "when": 1706000000000,
      "tag": "0000_initial_schema",
      "breakpoints": true
    }
  ]
}
```

The validation script will:
1. Parse `_journal.json` before and after changes
2. Verify new migration entry added with correct idx
3. Check migration file exists at `migrations/app/{tag}.sql`
4. Ensure no gaps in migration numbering

### CI Workflow Integration

```yaml
name: Schema Validation

on:
  pull_request:
    paths:
      - 'packages/backend/database-schema/src/**'
      - 'packages/backend/database-schema/migrations/**'

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Setup pnpm
        uses: pnpm/action-setup@v2

      - name: Validate schema changes
        run: pnpm --filter @repo/database-schema validate:schema

      - name: Post validation results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            // Post PR comment with validation results
```

## Test Plan

### Validation Script Tests

**Test 1: Breaking Change Detection**
- Create migration with `DROP COLUMN` statement
- Run validation script
- Verify script flags as breaking change
- Verify CI fails with appropriate message

**Test 2: Non-Breaking Change Validation**
- Create migration with `ADD COLUMN ... DEFAULT` statement
- Run validation script
- Verify script passes validation
- Verify CI passes

**Test 3: Migration Naming Convention**
- Create migration with invalid name (e.g., `migration.sql`)
- Run validation script
- Verify script fails with naming convention error
- Verify error message references WISH-2057 AC 5

**Test 4: Migration Journal Validation**
- Create migration without updating `_journal.json`
- Run validation script
- Verify script detects missing journal entry
- Verify CI fails with journal error

**Test 5: Concurrent Index Validation**
- Create migration with `CREATE INDEX` (without CONCURRENTLY)
- Run validation script
- Verify script warns about production safety
- Verify warning references WISH-2057 AC 16

### CI Workflow Tests

**Test 6: PR Comment Generation**
- Create PR with schema changes
- Trigger CI workflow
- Verify PR comment includes validation results
- Verify comment format is readable and actionable

**Test 7: CI Pass/Fail Behavior**
- Test PR with breaking changes → CI fails
- Test PR with non-breaking changes → CI passes
- Test PR with warnings only → CI passes

### Edge Cases

**Edge 1: Multiple Migrations in Single PR**
- Create PR with 3 new migrations
- Verify validation runs on all migrations
- Verify results aggregated in single PR comment

**Edge 2: Migration File Deletion**
- Attempt to delete existing migration file
- Verify validation script blocks deletion
- Verify error explains immutability of applied migrations

**Edge 3: Schema Change Without Migration**
- Modify `schema/index.ts` without creating migration
- Verify validation script detects missing migration
- Verify CI fails with "migration required" message

## Risk Notes

### MVP-Critical Risks

**Risk 1: False Positives Block Valid Changes**
- Overly strict validation may flag valid changes as violations
- **Mitigation**: Provide escape hatch (comment `<!-- schema-validation: skip -->` with justification)

**Risk 2: SQL Parsing Complexity**
- Complex SQL migrations may not parse correctly, causing validation failures
- **Mitigation**: Use well-tested SQL parser (pg-query-parser), graceful fallback for unparseable SQL

**Risk 3: CI Performance Impact**
- Validation script adds latency to PR CI pipeline
- **Mitigation**: Optimize script to run in < 30 seconds, cache dependencies

### Non-MVP Risks

**Risk 4: Policy Drift**
- Validation rules may drift from documented policies in WISH-2057
- **Mitigation**: Cross-reference validation rules with policy docs in tests

**Risk 5: Developer Friction**
- Strict CI gates may frustrate developers with false positives
- **Mitigation**: Provide clear error messages with policy doc links, escape hatch for overrides

## Definition of Done

- [ ] All 20 Acceptance Criteria verified
- [ ] GitHub Actions workflow created and tested on sample PR
- [ ] Validation script implemented with unit tests
- [ ] Breaking change detection tested with 10+ SQL patterns
- [ ] CI documentation added to `packages/backend/database-schema/docs/`
- [ ] PR comment formatting tested and readable
- [ ] Validation script runs in < 30 seconds for typical migrations
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~3k | — | — | Follow-up generation |
| Implementation | ~8k | — | — | CI workflow + validation script |
| Review | ~2k | — | — | Testing and documentation |
| **Total** | ~13k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-29 19:00 | pm-story-followup-leader | Created follow-up story from WISH-2057 finding #1 | WISH-20180.md |

---

## Future Enhancement Notes

Once this CI validation is implemented, consider:
- Automated migration rollback testing (create test database, apply migration, verify rollback)
- Schema change impact analysis (which services/endpoints affected by this change?)
- Migration performance profiling (estimate execution time on production-sized datasets)
- Visual schema diff tool for PR reviews (show table/column changes graphically)

---

## Open Questions

_Should be empty or non-blocking for backlog story_

None - all dependencies and requirements clear from WISH-2057 policy documentation.

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-31_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | No MVP-critical gaps identified | Not Reviewed | Core journey is complete: Developer creates PR with schema change → CI validates → Feedback posted to PR → CI passes or fails appropriately. All essential validation rules are specified and achievable. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Automated migration rollback testing | Not Reviewed | Create test database, apply migration, verify rollback - future story candidate |
| 2 | Schema change impact analysis | Not Reviewed | Identify which services/endpoints affected by schema changes - future story candidate |
| 3 | Migration performance profiling | Not Reviewed | Estimate migration execution time on production-sized datasets - future story candidate |
| 4 | Visual schema diff tool | Not Reviewed | Show table/column changes graphically in PR reviews - future story candidate |

### Follow-up Stories Suggested

- [x] Automated migration rollback testing (test database creation and rollback verification) → WISH-20360
- [x] Schema change impact analysis (service/endpoint impact detection) → WISH-20370
- [x] Migration performance profiling (execution time estimation) → WISH-20380
- [x] Visual schema diff tool (graphical schema change display in PRs) → WISH-20390

### Items Marked Out-of-Scope

- Implementing schema migration generation tools (handled by Drizzle)
- Automated migration rollback testing (future enhancement)
- Schema change approval workflow automation (future enhancement)
- Database backup/restore automation (separate infrastructure concern)
- Policy enforcement beyond schema changes (e.g., code style, API design)
