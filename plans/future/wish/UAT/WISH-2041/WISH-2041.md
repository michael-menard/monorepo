---
doc_type: story
title: "WISH-2041: Delete Flow"
story_id: WISH-2041
story_prefix: WISH
status: uat
split_from: WISH-2004
split_part: 1 of 2
phase: 3
created_at: "2026-01-27T00:00:00-07:00"
updated_at: "2026-01-28T19:21:00-07:00"
depends_on: [WISH-2001]
estimated_points: 3
---

# WISH-2041: Delete Flow

## Split Context

This story is part of a split from WISH-2004.
- **Original Story:** WISH-2004 (Modals & Transitions)
- **Split Reason:** Original story bundled two independent user flows (Delete and Purchase) with 10 ACs, complex cross-domain transaction logic, multiple modal interfaces, and undo mechanics. Split required to separate concerns and reduce complexity.
- **This Part:** 1 of 2 (Delete Flow)
- **Dependency:** Depends on WISH-2001 (Gallery MVP)

## Context

Users need the ability to permanently remove items from their wishlist when they no longer want them. This is a destructive action that requires confirmation to prevent accidental deletion. The delete flow must include an undo mechanism with a time-limited window for recovery, providing users with a safety net while maintaining data cleanup.

This story focuses solely on the delete functionality, separated from the purchase/"Got It" flow to reduce implementation complexity and enable independent testing.

## Goal

Enable users to permanently delete wishlist items with confirmation and a 5-second undo window.

## Non-goals

- Purchase/"Got It" flow (handled in WISH-2042)
- Archive/restore functionality (deferred to WISH-201X)
- Soft delete implementation (hard delete only)
- Batch deletion of multiple items
- Email notifications for deletions
- Analytics tracking of delete actions (deferred to WISH-2009)

## Scope

### Backend (API) - ALREADY IMPLEMENTED

**DELETE /api/wishlist/:id** - Fully functional endpoint exists
- Hard deletes wishlist item (no soft delete)
- Returns `204 No Content` on success
- Returns `404 Not Found` if item doesn't exist
- Returns `403 Forbidden` if user doesn't own item
- Implemented using `lego-api` hexagonal architecture:
  - Route: `apps/api/lego-api/domains/wishlist/routes.ts` (lines 198-210)
  - Service: `apps/api/lego-api/domains/wishlist/application/services.ts` (lines 173-184)
  - Repository: `apps/api/lego-api/domains/wishlist/adapters/repositories.ts`
- **Backend tests exist:** `apps/api/lego-api/domains/wishlist/__tests__/services.test.ts`
- **No backend work required** - This story focuses on frontend implementation only

### Frontend (React)

**DeleteConfirmModal Component**
- AlertDialog component from `@repo/app-component-library`
- Title: "Delete Item?"
- Message: "This action is permanent. You cannot undo it."
- Item preview: thumbnail + title
- Cancel button (secondary)
- Delete button (destructive/red)
- Keyboard accessible: ESC to cancel, Enter to confirm
- Focus trap during modal open
- Returns focus to trigger element on close

**Toast Notifications**
- Success toast: "Item removed"
- "Undo" action button (5-second window)
- Toast auto-dismisses after 5 seconds if no action
- Toast announced via `role="alert"` for screen readers
- Auto-focus undo button when toast appears
- ESC to dismiss toast
- **Implementation Note:** Use Sonner's native action API (`action: { label: string; onClick: () => void }`)

**Undo Logic**
- Component-local state (not persisted)
- Store deleted item in component state before mutation executes
- On undo: Call `addWishlistItem` mutation with stored item data to restore
- Cleared on navigation away from page
- Prevents duplicate deletion requests during undo window
- Handle undo failure: Show error toast if restoration fails

### RTK Query Integration

**Mutation:** `removeFromWishlist` in `wishlistGalleryApi`
- Add to `packages/core/api-client/src/rtk/wishlist-gallery-api.ts`
- Maps to `DELETE /api/wishlist/:id`
- Returns 204 status (no content) on success
- Invalidates tags: `{ type: 'Wishlist', id: 'LIST' }` and `{ type: 'WishlistItem', id }`
- Error handling for 403 Forbidden, 404 Not Found, network errors
- Export hook: `useRemoveFromWishlistMutation()`

## Acceptance Criteria

### Backend (Verification Only)
- [ ] AC 1: Verify DELETE `/api/wishlist/:id` endpoint exists and returns 204 on success
- [ ] AC 2: Verify endpoint handles 403 Forbidden error when user doesn't own item
- [ ] AC 3: Verify endpoint handles 404 Not Found error when item doesn't exist
- [ ] AC 4: Backend tests exist and pass in `services.test.ts` (deleteItem suite)

### Frontend (Implementation Required)
- [ ] AC 5: RTK Query mutation `removeFromWishlist` added to `wishlistGalleryApi.ts`
- [ ] AC 6: Mutation invalidates `{ type: 'Wishlist', id: 'LIST' }` and `{ type: 'WishlistItem', id }` tags
- [ ] AC 7: Export hook `useRemoveFromWishlistMutation()` for component use
- [ ] AC 8: DeleteConfirmModal component (AlertDialog) with "This is permanent" warning
- [ ] AC 9: Modal shows item preview (thumbnail + title) before deletion
- [ ] AC 10: Success toast displays "Item removed" with undo action button
- [ ] AC 11: Toast uses Sonner's `action` API with label "Undo" and 5-second duration
- [ ] AC 12: Undo stores deleted item in component state before mutation
- [ ] AC 13: Undo calls `addWishlistItem` mutation to restore item to backend
- [ ] AC 14: Undo shows error toast if restoration fails
- [ ] AC 15: Modal is keyboard accessible (ESC to cancel, Enter to confirm, focus trap)
- [ ] AC 16: Toast announced via `role="alert"` for screen readers
- [ ] AC 17: Action buttons disabled during `isLoading` to prevent race conditions
- [ ] AC 18: Frontend displays appropriate error messages for 403/404/network errors
- [ ] AC 19: Export `useRemoveFromWishlistMutation()` hook explicitly in `wishlistGalleryApi.ts` alongside other hooks
- [ ] AC 20: Verify undo toast action button receives focus or is properly announced for screen readers

## Reuse Plan

### Existing Components
- `@repo/app-component-library` AlertDialog for confirmation modal
- `@repo/app-component-library` Toast for notifications
- RTK Query mutation and cache invalidation patterns from existing features

### Existing Patterns
- Modal component structure from existing modals (confirmation, forms)
- Toast notification patterns with action buttons
- Optimistic update patterns from RTK Query
- Undo mechanism patterns (cache-based recovery)

### Services & Infrastructure
- `lego-api` hexagonal architecture (routes, services, repositories)
- Existing wishlist service methods (extend for delete)
- Database connection and error handling patterns
- Authorization middleware from existing endpoints

## Architecture Notes

### Backend Architecture (Already Implemented)

**Location:** `apps/api/lego-api/domains/wishlist/`

**Service Implementation** (`application/services.ts` lines 173-184):
```typescript
async deleteItem(userId: string, itemId: string): Promise<Result<void, WishlistError>> {
  // Check ownership first
  const existing = await wishlistRepo.findById(itemId)
  if (!existing.ok) return existing
  if (existing.data.userId !== userId) return err('FORBIDDEN')

  return wishlistRepo.delete(itemId)
}
```

**Route Implementation** (`routes.ts` lines 198-210):
```typescript
wishlist.delete('/:id', async c => {
  const userId = c.get('userId')
  const itemId = c.req.param('id')
  const result = await wishlistService.deleteItem(userId, itemId)

  if (!result.ok) {
    const status = result.error === 'NOT_FOUND' ? 404 : result.error === 'FORBIDDEN' ? 403 : 500
    return c.json({ error: result.error }, status)
  }

  return c.body(null, 204)
})
```

**Tests:** `__tests__/services.test.ts` (deleteItem suite exists)

### Frontend Architecture (Implementation Required)

**RTK Query Mutation** (`packages/core/api-client/src/rtk/wishlist-gallery-api.ts`):
```typescript
removeFromWishlist: builder.mutation<void, string>({
  query: (id) => ({
    url: `/wishlist/${id}`,
    method: 'DELETE',
  }),
  invalidatesTags: (_, __, id) => [
    { type: 'Wishlist', id: 'LIST' },
    { type: 'WishlistItem', id },
  ],
})
```

**Component Usage** (with undo pattern):
```typescript
const [removeFromWishlist, { isLoading }] = useRemoveFromWishlistMutation()
const [addWishlistItem] = useAddWishlistItemMutation() // for undo restoration
const [deletedItem, setDeletedItem] = useState<WishlistItem | null>(null)

const handleDelete = async (item: WishlistItem) => {
  // Store item for undo
  setDeletedItem(item)

  try {
    await removeFromWishlist(item.id).unwrap()

    // Show toast with undo action
    toast('Item removed', {
      action: {
        label: 'Undo',
        onClick: async () => {
          try {
            await addWishlistItem(deletedItem).unwrap()
            toast.success('Item restored')
          } catch {
            toast.error('Failed to restore item')
          }
        }
      },
      duration: 5000
    })
  } catch (error) {
    // Handle 403, 404, network errors
    toast.error(getErrorMessage(error))
  }
}
```

### Error Handling
- 403 Forbidden → Toast: "You don't have permission to delete this item"
- 404 Not Found → Toast: "Item not found or already deleted"
- 500 Server Error → Toast: "Failed to delete item. Please try again."
- Network error → Toast: "Network error. Please check your connection."

## Test Plan

### Backend Tests (Verification Only)

**Existing Tests:** `apps/api/lego-api/domains/wishlist/__tests__/services.test.ts`

Verify existing `deleteItem` suite covers:
- ✓ Delete removes item from database (Happy path)
- ✓ Delete returns 403 if user doesn't own item (Authorization)
- ✓ Delete returns 404 if item doesn't exist (Error handling)

**No new backend tests required** - functionality already implemented and tested

### Frontend Tests (`apps/web/main-app/...`)

**Component Tests:**
- ✓ DeleteConfirmModal renders with item preview
- ✓ Cancel button closes modal without action
- ✓ Delete button triggers mutation
- ✓ Modal is keyboard accessible (ESC, Enter, Tab)
- ✓ Focus trap works during modal open
- ✓ Focus returns to trigger on close

**Integration Tests:**
- ✓ Success toast appears after delete
- ✓ Undo button restores item to cache
- ✓ Item reappears in gallery after undo
- ✓ Toast auto-dismisses after 5 seconds
- ✓ Undo window expires correctly
- ✓ Error toast shows on failure

**Accessibility Tests:**
- ✓ Modal announced to screen readers
- ✓ Toast announced via live region
- ✓ Undo button keyboard accessible
- ✓ ESC dismisses toast

### E2E Tests (`apps/web/playwright/tests/wishlist-delete.spec.ts`)

**User Flows:**
- ✓ User can delete item from gallery view
- ✓ User can delete item from detail view
- ✓ Delete confirmation modal appears
- ✓ User can cancel deletion
- ✓ User can confirm deletion
- ✓ Item disappears from gallery after confirm
- ✓ User can undo deletion within 5 seconds
- ✓ Item reappears after undo
- ✓ Item stays deleted after undo window expires

**Error Scenarios:**
- ✓ 403 error shows appropriate message
- ✓ 404 error shows appropriate message
- ✓ Network error shows retry option

## Risks / Edge Cases

### Risk 1: Race Condition During Undo Window
**Scenario:** User deletes item, then clicks undo, but also navigates to another page during the 5-second window.

**Mitigation:**
- Undo state is component-local and cleared on navigation
- Accept default behavior: changes committed if user navigates away
- UI shows loading state to prevent duplicate actions

### Risk 2: Concurrent Deletions
**Scenario:** User opens multiple tabs and deletes same item in both tabs simultaneously.

**Mitigation:**
- Backend idempotent: DELETE on non-existent item returns 404 (acceptable)
- Frontend cache invalidation handles stale data
- Second deletion shows "Item not found" toast (acceptable UX)

### Risk 3: Rapid Click During Flight
**Scenario:** User rapidly clicks delete button before first request completes.

**Mitigation:**
- Disable action buttons during `isLoading` state
- Show loading spinner on card being deleted
- Prevent modal from closing during flight

### Risk 4: Accessibility Gaps
**Scenario:** Screen reader users may not discover undo button in toast.

**Mitigation:**
- Toast has `role="alert"` for screen reader announcement
- Auto-focus undo button when toast appears
- ESC to dismiss toast (announced)
- 5-second window provides reasonable time to discover

### Risk 5: Data Loss on Accidental Delete
**Scenario:** User accidentally confirms delete and misses undo window.

**Mitigation:**
- Confirmation modal provides friction ("This is permanent")
- 5-second undo window provides safety net
- Future story (WISH-201X) may add archive/restore for non-destructive alternative

## Definition of Done

### Backend (Verification)
- [ ] Verified DELETE endpoint exists and works (manual test or E2E)
- [ ] Verified backend tests exist and pass (deleteItem suite)

### Frontend (Implementation)
- [ ] RTK Query mutation `removeFromWishlist` added to `wishlistGalleryApi.ts`
- [ ] Export hook `useRemoveFromWishlistMutation()` available
- [ ] DeleteConfirmModal component implemented with AlertDialog
- [ ] Toast with undo action implemented using Sonner's action API
- [ ] Undo mechanism stores item and restores via `addWishlistItem`
- [ ] All frontend tests passing (component, integration, a11y)
- [ ] E2E tests passing (delete flow, undo flow)
- [ ] Keyboard navigation working (ESC, Enter, Tab)
- [ ] Screen reader announcements working (`role="alert"`)
- [ ] Error handling for 403/404/network errors
- [ ] Action buttons disabled during `isLoading`
- [ ] Code reviewed and approved
- [ ] Ready for WISH-2042 (Purchase flow can reuse undo pattern)

## Dependencies

- **Depends On:** WISH-2001 (Gallery MVP) - Provides gallery view and list display
- **Unblocks:** WISH-2042 (Purchase flow) - Reuses undo pattern and modal structure
- **Unblocks:** WISH-2005a (Drag-and-drop) - Core delete functionality required

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~4k | — | — | Simpler scope post-split |
| Elaboration | ~6k | — | — | Single flow, no cross-domain |
| Implementation | ~20k | — | — | Modal + endpoint + tests |
| Code Review | ~6k | — | — | Standard review |
| **Total** | ~36k | — | — | Reduced from original ~70k |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|


---

## Revision History

### v2 - 2026-01-27 (PM Fix)
**Addressed QA Feedback from Elaboration Audit (ELAB-WISH-2041.md)**

| Issue | Resolution |
|-------|------------|
| Backend already implemented (Critical) | Updated Scope section to clarify backend is 100% complete. Story now focuses on frontend-only implementation. |
| Incorrect architecture paths (Critical) | Corrected file paths to match actual `lego-api` hexagonal structure: `application/services.ts`, `adapters/repositories.ts`. |
| RTK Query mutation missing (High) | Added AC 5-7: Create `removeFromWishlist` mutation in `wishlistGalleryApi.ts` with proper tag invalidation. |
| Undo mechanism unspecified (High) | Added AC 12-14: Document undo pattern - store item before delete, restore via `addWishlistItem`, handle failures. |
| Toast action button missing (High) | Added AC 11: Use Sonner's native `action` API for undo button in toast. |
| Scope section inaccuracy (High) | Rewritten Scope to separate "Backend (ALREADY IMPLEMENTED)" from "Frontend (Implementation Required)". |
| ACs for backend features (Medium) | Updated ACs 1-4 to verification-only (backend exists). ACs 5-18 cover frontend implementation. |

**Files Updated:**
- `WISH-2041.md` (status: `elaboration` → `backlog`, ready for re-audit)

**Ready for Re-Audit:** Yes
**Ready for Implementation:** Pending QA re-audit

---

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-27 | pm-story-split-leader | Created split story from WISH-2004 | WISH-2041.md |
| 2026-01-27 | elab-completion-leader | Elaboration audit complete - Verdict: FAIL | ELAB-WISH-2041.md + QA Notes appended |
| 2026-01-27 | pm-story-fix-leader | Addressed all QA feedback - v2 | WISH-2041.md (updated) |
| 2026-01-27 | elab-completion-leader | Elaboration completion - Verdict: CONDITIONAL PASS | ELAB-WISH-2041.md updated, AC 19-20 added, ready-to-work |

---

## QA Discovery Notes (for PM Review)

_Added by elab-completion-leader on 2026-01-27_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| gap_1 | RTK Query mutation hook export missing | **ADD AS AC 19** | Story AC 7 mentions `useRemoveFromWishlistMutation()` but doesn't explicitly require exporting the hook. Must export alongside other hooks in `wishlistGalleryApi.ts` for component use. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| enh_1 | Undo toast action button focus/announcement | **ADD AS AC 20** | Verify undo toast action button receives focus automatically or is properly announced to screen readers. Improves discoverability for keyboard/a11y users. |

### Follow-up Stories Suggested

- [ ] None at this time. WISH-2042 (Purchase Flow) will reuse undo patterns from this story.

### Items Marked Out-of-Scope

- **Toast Implementation Detail**: Sonner API selection is an implementation detail. Developer will choose native action API vs. extending toast utils.
- **204 Response Handling**: RTK Query library handling of 204 responses verified during implementation.
- **Item Preview in Modal**: Implicit in AlertDialog + item data already available.
