---
story_id: WISH-2004
title: "Modals & Transitions"
status: uat
phase: 3 - Core Features
depends_on:
  - WISH-2001
created_at: "2026-01-28T12:00:00Z"
updated_at: "2026-01-29T18:15:00Z"
sizing_warning: true
implementation_status: substantially_complete
---

# WISH-2004: Modals & Transitions

## Context

The Wishlist Gallery (WISH-2001) provides the core viewing experience. Users need the ability to:
1. **Delete** items they no longer want to track
2. **Transition** items to their Sets collection when purchased ("Got It" flow)

These actions require confirmation dialogs to prevent accidental data loss and provide rich feedback through toast notifications.

**Discovery Note:** During story generation, implementation was found to already exist:
- `DeleteConfirmModal` and `GotItModal` components implemented (WISH-2041, WISH-2042)
- Backend endpoints `DELETE /api/wishlist/:id` and `POST /api/wishlist/:id/purchased` implemented
- 57+ unit tests covering modal and service behavior
- RTK Query mutations with cache invalidation wired up

This story serves as the **verification and acceptance story** for the existing implementation.

---

## Goal

Enable users to delete wishlist items or transition them to their Sets collection with purchase details, using confirmation modals and toast notifications for feedback.

---

## Non-Goals

- **Undo delete functionality** - Toast shows placeholder, actual undo is future work
- **Batch delete/purchase** - Single item operations only
- **Purchase history/audit trail** - No tracking of purchase events
- **True database transactions** - Application-level atomicity (acceptable for MVP)

---

## Scope

### Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/wishlist/:id` | DELETE | Delete wishlist item permanently |
| `/api/wishlist/:id/purchased` | POST | Mark as purchased, create Set, optionally delete from wishlist |

### Packages Affected

| Package | Changes |
|---------|---------|
| `apps/api/lego-api/domains/wishlist/` | Delete and purchase endpoints (existing) |
| `apps/api/lego-api/domains/sets/` | Sets service integration (existing) |
| `apps/web/app-wishlist-gallery/src/components/DeleteConfirmModal/` | Delete confirmation modal (existing) |
| `apps/web/app-wishlist-gallery/src/components/GotItModal/` | Purchase form modal (existing) |
| `packages/core/api-client/src/rtk/wishlist-gallery-api.ts` | RTK Query mutations (existing) |
| `packages/core/api-client/src/schemas/wishlist.ts` | Zod schemas (existing) |

### UI Components

| Component | Purpose | Status |
|-----------|---------|--------|
| DeleteConfirmModal | Confirm item deletion with preview | Implemented |
| GotItModal | Purchase details form | Implemented |
| Toast notifications | Success/error feedback | Implemented (sonner) |

---

## Acceptance Criteria

### Delete Flow

- [ ] **AC1:** DeleteConfirmModal opens when user triggers delete action on WishlistCard
- [ ] **AC2:** Modal displays item preview (thumbnail, title, set number, store)
- [ ] **AC3:** Cancel button closes modal without deleting
- [ ] **AC4:** Confirm button triggers `DELETE /api/wishlist/:id`
- [ ] **AC5:** 204 response removes item from gallery (RTK Query cache invalidation)
- [ ] **AC6:** Loading state disables buttons during deletion
- [ ] **AC7:** 403 response when user doesn't own item
- [ ] **AC8:** 404 response when item doesn't exist
- [ ] **AC9:** Toast notification appears on success

### Purchase ("Got It") Flow

- [ ] **AC10:** GotItModal opens when user triggers "Got It" action
- [ ] **AC11:** Modal displays item title in description
- [ ] **AC12:** Price field pre-filled from wishlist item price
- [ ] **AC13:** Quantity defaults to 1
- [ ] **AC14:** Purchase date defaults to today
- [ ] **AC15:** "Keep on wishlist" checkbox defaults to unchecked
- [ ] **AC16:** Form validates price/tax/shipping format (decimal only)
- [ ] **AC17:** Form validates quantity >= 1
- [ ] **AC18:** Submit triggers `POST /api/wishlist/:id/purchased`
- [ ] **AC19:** 201 response returns new SetItem
- [ ] **AC20:** Set creation failure does NOT delete wishlist item (atomicity)
- [ ] **AC21:** Success toast shows with "View in Sets" button
- [ ] **AC22:** Item removed from gallery when keepOnWishlist=false
- [ ] **AC23:** Item remains in gallery when keepOnWishlist=true
- [ ] **AC24:** Image copied to Sets S3 prefix during purchase
- [ ] **AC25:** Loading state shows progress messages

### Accessibility

- [ ] **AC26:** ESC key closes modals (when not loading)
- [ ] **AC27:** Focus trap active during modal open
- [ ] **AC28:** Focus returns to trigger element on close
- [ ] **AC29:** All form fields have associated labels
- [ ] **AC30:** Loading indicators have role="status"

---

## Reuse Plan

### Existing Packages Used

| Package | Usage |
|---------|-------|
| `@repo/app-component-library` | AppAlertDialog, AppDialog, Button, Input, Checkbox, LoadingSpinner |
| `@repo/api-client` | RTK Query mutations, Zod schemas |
| `sonner` | Toast notifications |
| `lucide-react` | Icons (AlertTriangle, CheckCircle, Package, Undo2) |

### No New Packages Required

All functionality uses existing shared packages.

---

## Architecture Notes (Ports & Adapters)

### Backend

```
routes.ts
  └── wishlistService.deleteItem(userId, itemId)
        └── wishlistRepo.delete(itemId)

  └── wishlistService.markAsPurchased(userId, itemId, input)
        ├── wishlistRepo.findById(itemId) → ownership check
        ├── setsService.createSet(userId, setInput) → cross-domain
        ├── imageStorage.copyImage(sourceKey, destKey) → S3
        ├── imageStorage.deleteImage(sourceKey) → S3 (if !keepOnWishlist)
        └── wishlistRepo.delete(itemId) → only after Set created
```

### Frontend

```
WishlistCard
  └── onDelete → DeleteConfirmModal
        └── onConfirm → useDeleteWishlistItemMutation()
              └── RTK invalidates ['Wishlist', 'WishlistItem']

  └── onGotIt → GotItModal
        └── onSubmit → useMarkAsPurchasedMutation()
              └── RTK invalidates ['Wishlist', 'WishlistItem', 'Sets']
```

---

## Infrastructure Notes

### S3 Operations

- **Image copy:** Wishlist image copied to Sets prefix during purchase
- **Image delete:** Original deleted if keepOnWishlist=false
- **Best effort:** S3 failures logged but don't block transaction

### Database

- No new migrations required
- Uses existing `wishlist_items` and `sets` tables

---

## HTTP Contract Plan

### DELETE /api/wishlist/:id

**Request:**
```http
DELETE /api/wishlist/123e4567-e89b-12d3-a456-426614174000
Authorization: Bearer {token}
```

**Response (204):** No content

**Error Responses:**
- 403: `{ "error": "FORBIDDEN" }`
- 404: `{ "error": "NOT_FOUND" }`

### POST /api/wishlist/:id/purchased

**Request:**
```http
POST /api/wishlist/123e4567-e89b-12d3-a456-426614174000/purchased
Authorization: Bearer {token}
Content-Type: application/json

{
  "pricePaid": "799.99",
  "tax": "64.00",
  "shipping": "15.00",
  "quantity": 1,
  "purchaseDate": "2026-01-28T00:00:00.000Z",
  "keepOnWishlist": false
}
```

**Response (201):**
```json
{
  "id": "set-uuid",
  "userId": "user-uuid",
  "title": "LEGO Star Wars Millennium Falcon",
  "setNumber": "75192",
  "store": "LEGO",
  "purchasePrice": "799.99",
  "tax": "64.00",
  "shipping": "15.00",
  "quantity": 1,
  "purchaseDate": "2026-01-28T00:00:00.000Z",
  "wishlistItemId": "123e4567-e89b-12d3-a456-426614174000",
  "isBuilt": false,
  "createdAt": "2026-01-28T12:00:00.000Z",
  "updatedAt": "2026-01-28T12:00:00.000Z"
}
```

**Error Responses:**
- 400: `{ "error": "Validation failed", "details": {...} }`
- 403: `{ "error": "FORBIDDEN" }`
- 404: `{ "error": "NOT_FOUND" }`
- 500: `{ "error": "SET_CREATION_FAILED" }`

---

## Seed Requirements

No new seed data required. Existing wishlist seeds from WISH-2000 are sufficient.

---

## Test Plan

### Unit Tests (Existing)

| Component | Test File | Count |
|-----------|-----------|-------|
| DeleteConfirmModal | `DeleteConfirmModal.test.tsx` | 17 tests |
| GotItModal | `GotItModal.test.tsx` | 25 tests |
| Purchase service | `purchase.test.ts` | 15 tests |

### Integration Tests (Required)

1. **Delete happy path:** Item deleted, gallery refreshed
2. **Delete authorization:** 403 for non-owner
3. **Purchase happy path:** Set created, wishlist item optionally deleted
4. **Purchase atomicity:** Set failure doesn't delete wishlist item
5. **Image operations:** Copy/delete during purchase

### E2E Tests (Required)

1. **delete-flow.spec.ts:** Modal open, cancel, confirm, loading states
2. **purchase-flow.spec.ts:** Form fill, submit, success toast, navigation
3. **accessibility.spec.ts:** Keyboard navigation, focus management

See `_pm/TEST-PLAN.md` for full test plan.

---

## UI/UX Notes

### DeleteConfirmModal

- Uses `AppAlertDialog` (appropriate for destructive confirmation)
- Shows item preview with thumbnail
- Destructive styling on confirm button
- Loading state disables all buttons

### GotItModal

- Uses `AppDialog` (appropriate for form modal)
- Pre-fills price from wishlist item
- Form validation with inline error messages
- Progress messages cycle during loading
- Success toast with "View in Sets" button

See `_pm/UIUX-NOTES.md` for full UI/UX notes.

---

## Token Budget

_To be filled during implementation/verification_

| Phase | Input | Output | Total |
|-------|-------|--------|-------|
| PM Generation | — | — | — |
| Verification | — | — | — |
| **Total** | — | — | — |

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| gap_1 | Missing .http test files for manual API testing | **Add as AC** | Create REST client test files for DELETE /api/wishlist/:id and POST /api/wishlist/:id/purchased endpoints. Includes happy path and error scenarios. New ACs 31-32. |
| gap_2 | Missing Playwright E2E tests | **Add as AC** | Create three E2E test files: delete-flow.spec.ts, purchase-flow.spec.ts, modal-accessibility.spec.ts. Required for comprehensive AC verification (functional and accessibility). |
| gap_3 | Test count variance (GotItModal) | **Skip** | Claimed 25 tests, actual 23. Minor variance, acceptable. No action required. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| enh_1 | True database transactions with ACID compliance | **Out-of-scope** | Current application-level atomicity (Set-before-delete ordering) acceptable for MVP. Production-scale ACID would require PostgreSQL transactions or Step Functions. Phase 6+ future work. |
| enh_2 | Optimistic S3 retry with exponential backoff | **Out-of-scope** | S3 copy/delete currently "best effort". Retry with dead-letter queue is Phase 5+ reliability enhancement. |
| enh_3 | Toast notification customization | **Skip** | Hardcoded messages acceptable for MVP. User preferences deferred to Phase 6 personalization. |
| enh_4 | Image preview lightbox in DeleteConfirmModal | **Skip** | AC 2 covers item preview. Lightbox enhancement deferred to Phase 4 UX Polish if user testing indicates need. |
| enh_5 | "View in Sets" deep link with highlight animation | **Skip** | Success toast has "View in Sets" button. Deep link enhancement deferred to Phase 4 UX Polish. |
| enh_6 | Purchase form validation enhancements | **Skip** | Current validation (decimal format, quantity >= 1) sufficient for MVP. Enhanced validation (currency format, max quantity, date checks) deferred to Phase 4. |
| enh_7 | Image format conversion (WebP compression) during copy | **Out-of-scope** | Converting format during S3 copy requires image processing library in Lambda. Phase 5 performance optimization. |
| enh_8 | Keyboard shortcut for "Got It" (e.g., Ctrl+G) | **Out-of-scope** | Keyboard shortcuts align with WISH-2006 Accessibility story, deferred to Phase 4 UX Polish. |

### Follow-up Stories Suggested

- [ ] WISH-2006: Accessibility enhancements (keyboard shortcuts, focus management)
- [ ] WISH-2008: Authorization verification tests
- [ ] Phase 4 UX Polish epic: Image lightbox, deep links, form validation enhancements
- [ ] Phase 5 Observability epic: S3 retry/reconciliation, purchase history/audit trails
- [ ] Phase 6+ Architecture epic: True ACID transactions with PostgreSQL or Step Functions

### Items Marked Out-of-Scope

- **True database transactions**: Application-level atomicity via Set-before-delete ordering is acceptable for MVP. Production-scale ACID compliance is Phase 6+.
- **S3 retry infrastructure**: Best-effort image operations are acceptable for MVP. Reliability enhancements (retry, dead-letter, reconciliation) are Phase 5.
- **Image format conversion**: WebP compression during copy is a performance optimization, not MVP-critical. Phase 5 future work.
- **Keyboard shortcuts**: "Got It" keyboard activation belongs in WISH-2006 Accessibility story, Phase 4.

---

## Agent Log

| Timestamp | Agent | Action | Outputs |
|-----------|-------|--------|---------|
| 2026-01-28 | pm-story-generation-leader | Story generated | WISH-2004.md, _pm/*.md |
| 2026-01-28 | elab-completion-leader | Elaboration complete | ELAB-WISH-2004.md, QA Discovery Notes appended |
