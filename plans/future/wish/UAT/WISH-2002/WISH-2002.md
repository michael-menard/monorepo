---
doc_type: story
title: "WISH-2002: Add Item Flow"
story_id: WISH-2002
story_prefix: WISH
status: uat
phase: 3
created_at: "2026-01-24T02:00:00-07:00"
updated_at: "2026-01-28T14:30:00Z"
depends_on: [WISH-2001]
estimated_points: 5
---

# WISH-2002: Add Item Flow

## Goal

Enable users to add wishlist items manually with all fields and image upload.

## Feature

POST endpoint, add item form with all fields, image upload to S3, form validation with Zod, RTK Query mutation.

## Phase

Phase 3: Core Features

## Acceptance Criteria

- [ ] POST `/api/wishlist` endpoint validates and creates item
- [ ] Add item page with form fields: store (required), title (required), set number, price, currency, piece count, priority, image, source URL, notes, tags
- [ ] Store selector: LEGO, Barweer, Cata, BrickLink, Other
- [ ] Priority selector: 0-5 scale
- [ ] Image upload field with S3 presigned URL
- [ ] Form validation with Zod (client and server)
- [ ] RTK Query mutation: `useAddToWishlistMutation`
- [ ] Success toast with link to view item
- [ ] Error handling for API failures

## Risk Notes

Image upload to S3 can fail or timeout; needs robust error handling and retry logic.

## Technical Details

### Backend (API)

**Location:** `apps/api/endpoints/wishlist/create/handler.ts`

**POST /api/wishlist**

Creates new wishlist item.

Request body:
```json
{
  "title": "string (required)",
  "store": "enum (required)",
  "setNumber": "string (optional)",
  "sourceUrl": "string (optional)",
  "imageUrl": "string (optional)",
  "price": "number (optional)",
  "currency": "string (optional, default: USD)",
  "pieceCount": "number (optional)",
  "releaseDate": "ISO date (optional)",
  "tags": "string[] (optional)",
  "priority": "0-5 (optional)",
  "notes": "string (optional)"
}
```

Response: `201 Created` with full item object

Validation: Zod schema from WISH-2000

### Frontend (React)

**Locations:**
- `apps/web/app-wishlist-gallery/src/pages/AddItemPage.tsx`
- `apps/web/app-wishlist-gallery/src/components/WishlistForm.tsx`
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts`

**Add Item Page**

- Breadcrumb: Gallery > Add Item
- Form with all fields
- Image upload preview
- Submit button disabled while uploading
- Success toast with link to view item

**WishlistForm Component**

Reusable form for add/edit with:
- Text inputs: title, setNumber, sourceUrl, notes
- Select dropdowns: store, currency, priority
- Number inputs: price, pieceCount
- Date picker: releaseDate
- Tag input: comma-separated or chip interface
- Image upload with preview

**Form Validation**

Client-side: Zod schema from `@repo/api-client`
Server-side: POST endpoint validates again

**Image Upload**

1. User selects image file
2. Request presigned S3 URL from backend
3. Upload directly to S3 with presigned URL
4. Form submission includes S3 URL

Error handling:
- Presigned URL expired: retry
- S3 upload failed: clear error, allow retry
- Timeout: show error message
- Invalid file type: reject immediately

### RTK Query Integration

**Location:** `packages/core/api-client/src/rtk/wishlist-api.ts`

Mutation:
- `useAddToWishlistMutation()` - POST endpoint
- Invalidates `useGetWishlistQuery` cache on success

## Dependencies

- **Depends On:** WISH-2001 (gallery page)
- **Can run in parallel with:** WISH-2003, WISH-2004
- **Unblocks:** WISH-2005 (UX Polish)

## Reuse Plan

- Use `WishlistItemSchema` from WISH-2000 for validation
- Use `@repo/app-component-library` for form inputs, buttons
- Leverage S3 presigned URL pattern from Instructions epic (if available)
- Use RTK Query mutation patterns from existing endpoints

## Test Coverage

**Backend Tests:**
- Create with all required fields
- Create with optional fields
- Validation errors for missing required fields
- Validation errors for invalid field types
- Unauthorized user rejection

**Frontend Tests:**
- Form renders with all fields
- Form validation feedback
- Image upload preview
- Success/error toasts
- Mutation call with correct payload

**E2E Tests:**
- User can add item with all fields
- User can upload image
- User receives success message
- User is redirected to item detail view
- Added item appears in gallery

## Definition of Done

- [ ] POST endpoint created and deployed
- [ ] Form component created and styled
- [ ] Image upload working with presigned URLs
- [ ] Form validation complete (client + server)
- [ ] RTK Query mutation created
- [ ] Success/error handling
- [ ] Tests passing
- [ ] Code reviewed
- [ ] Ready for WISH-2005

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~6k | — | — | — |
| Elaboration | ~10k | — | — | — |
| Implementation | ~25k | — | — | Image upload adds complexity |
| Code Review | ~8k | — | — | — |
| **Total** | ~49k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-24 02:00 | pm-bootstrap-generation-leader | Created story file | WISH-2002.md |
| 2026-01-27 | elab-analyst | Analyzed story against requirements and api architecture | ANALYSIS.md |
| 2026-01-27 | elab-completion-leader | Applied user decisions and updated story | ELAB-WISH-2002.md, QA Discovery Notes |

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-27_

### Issues Resolved

During elaboration, the following issues were identified and resolved through user decisions:

| # | Issue | User Decision | Implementation Notes |
|---|-------|---------------|----------------------|
| 1 | API architecture violation (handler-only pattern) | Fix in story - update Technical Details to reference apps/api/lego-api/domains/wishlist/ | Service layer must be created at apps/api/lego-api/domains/wishlist/ with business logic. Route handler remains thin adapter. |
| 2 | Missing authorization AC | Add as AC - document that endpoint validates userId from JWT | New AC: "Endpoint validates userId from JWT and prevents creating items for other users" |
| 3 | Unclear security dependencies | Defer to WISH-2013 - explicitly note dependency | Add note to Technical Details: "File type validation and virus scanning deferred to WISH-2013 security hardening story" |
| 4 | S3 presigned URL endpoint missing | Add to this story - add GET /api/wishlist/images/presign endpoint | New AC: "GET /api/wishlist/images/presign endpoint returns presigned URL for S3 upload" |
| 5 | Test coverage gaps for S3 | Add to AC - add S3 failure test requirements | New AC: "Backend tests include S3 presigned URL generation failure, S3 upload timeout handling, and image URL validation" |
| 6 | Cache invalidation undefined | Skip - not blocking for MVP | Document in implementation: Use RTK Query's default cache invalidation; revisit in WISH-2005. |

### Gaps Addressed

| # | Finding | User Decision | Implementation Notes |
|---|---------|---------------|----------------------|
| 1 | Image size validation | Add as AC - client-side file size validation 10MB max | New AC: "Client-side validation rejects files > 10MB before upload attempt" |
| 2 | Duplicate detection | Out-of-scope | Users may manually add duplicates. Deferred to later phase for "Similar Items" check. |
| 3 | Upload progress indicator | Add as AC - upload progress indicator | New AC: "Show upload progress percentage during S3 upload; display 'Preparing upload...' while requesting presigned URL" |
| 4 | Currency selector | Out-of-scope | Default USD is sufficient for MVP. Currency field is optional. Selector moved to later phase. |
| 5 | Tag input implementation | Clarify in AC - use chip interface | New AC: "Tag input uses chip interface (e.g., react-tag-input) for better UX than comma-separated text" |
| 6 | Form autosave | Follow-up story | Create new story: "Form autosave to localStorage" for Phase 3b or Phase 4 |
| 7 | Image preview editing | Add as AC - Change/Remove image button | New AC: "Upload preview shows image with 'Change Image' and 'Remove Image' buttons for editing" |
| 8 | SourceUrl validation | Add as AC - URL format validation | New AC: "Client-side Zod validation includes `.url()` check for sourceUrl field" |
| 9 | Error analytics | Out-of-scope | Form and S3 errors logged but not tracked to analytics. Defer to observability phase. |
| 10 | Presigned URL loading state | Add as AC - show 'Preparing upload...' state | New AC: "Show 'Preparing upload...' loading state while requesting presigned URL from backend" |

### Enhancements Integrated

| # | Finding | User Decision | Implementation Notes |
|---|---------|---------------|----------------------|
| 1 | Drag-and-drop image | Add as AC - drag-and-drop image upload | New AC: "Image upload field supports HTML5 drag-and-drop in addition to file picker" |
| 2 | Paste image from clipboard | Document reuse from packages/core/upload-client | Reuse existing clipboard paste functionality. Document in component as: "Uses clipboard paste from @repo/upload-client" |
| 3 | Keyboard shortcuts | Add as AC - Cmd/Ctrl+Enter to submit | New AC: "Form submission keyboard shortcut: Cmd+Enter (Mac) / Ctrl+Enter (Windows) in any form field" |
| 4 | Price currency symbol | Add as AC - show $ symbol next to price | New AC: "Price input displays currency symbol ($) as visual indicator of field purpose" |
| 5 | Client-side compression | Follow-up story | Create new story: "Client-side image compression" for Phase 3b or Phase 4 |
| 6 | Auto-populate from URL | Out-of-scope | Smart URL parsing for Rebrickable/BrickLink deferred. Users manually enter data for MVP. |
| 7 | Smart currency defaults | Out-of-scope | Store-to-currency mapping deferred. Users select currency explicitly or accept USD default. |
| 8 | Tag autocomplete | Out-of-scope | Tag history suggestions deferred to later phase. Basic chip input sufficient for MVP. |
| 9 | Set number validation | Out-of-scope | LEGO set number format (12345 or 12345-1) validation deferred. Loose string validation sufficient. |
| 10 | Optimistic UI | Follow-up story | Create new story: "Optimistic UI for form submission" for Phase 3b or Phase 4 |

### Follow-up Stories to Create

- [x] **Form autosave to localStorage** - Save form draft during typing, restore on page reload. Prevents data loss. → WISH-2012
- [x] **Client-side image compression** - Compress images before S3 upload to reduce upload time and storage costs. Use browser-image-compression library. → WISH-2022
- [x] **Optimistic UI for form submission** - Show success toast and navigate immediately, with rollback if API call fails. Aligns with WISH-2005 patterns. → WISH-2032

### Updated Technical Details

The following updates to Technical Details are required before implementation begins:

**Backend Location Update**: Change from `apps/api/endpoints/wishlist/create/handler.ts` to service layer pattern:
- Service: `apps/api/lego-api/domains/wishlist/services.ts` - contains `createWishlistItem(userId, input)` function
- Route: `apps/api/lego-api/domains/wishlist/routes.ts` - thin adapter for HTTP handler (< 50 lines)

**Security Note**: File type validation and virus scanning are deferred to WISH-2013. This story implements:
- Basic MIME type check on client side
- Server-side extension whitelist (jpg, jpeg, png, gif, webp)
- Deferred to WISH-2013: virus scanning, malware detection

**New Endpoint**: Add GET /api/wishlist/images/presign to Technical Details:
- Request: `{ fileName: string, mimeType: string }`
- Response: `{ presignedUrl: string, expiresIn: number }`
- Includes S3 file size limit (10MB) in URL constraints
