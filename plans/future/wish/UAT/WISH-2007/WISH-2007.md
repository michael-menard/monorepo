---
doc_type: story
title: "WISH-2007: Run Migration"
story_id: WISH-2007
story_type: infra
story_prefix: WISH
status: uat
phase: 1
created_at: "2026-01-24T02:00:00-07:00"
updated_at: "2026-01-28T22:30:00-07:00"
depends_on: [WISH-2000]
estimated_points: 1
---

# WISH-2007: Run Migration

## Context

WISH-2000 established the Drizzle schema for the `wishlist_items` table with all necessary fields, indexes, enums, and constraints. The schema definition exists in the codebase but has not been applied to the database. This story covers generating the migration file using Drizzle's migration system and applying it to create the actual database table in all environments.

This is a critical foundation story that unblocks all subsequent wishlist feature development (WISH-2001, WISH-2002, WISH-2003, WISH-2004).

## Goal

Generate and apply database migration to create the `wishlist_items` table with all indexes, enums, and constraints in local, staging, and production environments.

## Non-goals

- Modifying the schema design (WISH-2000 defines schema)
- Seeding initial data (covered in WISH-2000 seed scripts)
- Setting up migration automation/CI integration (future enhancement)
- Schema evolution strategy for future changes (future story)

## Scope

### Packages Affected
- `packages/backend/database-schema/` - Migration file generation and execution
  - `src/migrations/app/` - New migration file (0007_*.sql)
  - `src/migrations/app/meta/` - Migration metadata
  - `drizzle.config.ts` - Already configured, no changes needed

### Commands to Execute
1. `pnpm --filter @repo/database-schema db:generate` - Generate migration from schema
2. `pnpm --filter @repo/database-schema db:migrate` - Apply migration to database

### Database Objects Created
- **Table**: `wishlist_items` (19 columns)
- **Enums**: `wishlist_store`, `wishlist_currency`
- **Indexes**:
  - `idx_wishlist_user_id` - User lookup
  - `idx_wishlist_user_sort` - User sort order queries
  - `idx_wishlist_user_store` - Store filter queries
  - `idx_wishlist_user_priority` - Priority filter queries
  - `idx_wishlist_user_store_priority` - Composite filter queries (WISH-2000 enhancement)
- **Constraints**:
  - `priority_range_check` - Ensures priority is 0-5

### Environments
- Local development database (PostgreSQL)
- Staging database (if applicable)
- Production database (Aurora PostgreSQL)

## Acceptance Criteria

### Migration Generation (AC 1-3)
- [ ] AC 1: Migration file generated at `packages/backend/database-schema/src/migrations/app/0007_*.sql`
- [ ] AC 2: Migration metadata updated in `meta/` directory (snapshot JSON and journal)
- [ ] AC 3: Migration file contains CREATE TABLE for `wishlist_items` with all 19 columns matching WISH-2000 spec

### Migration Execution (AC 4-9)
- [ ] AC 4: Migration runs successfully in local development environment without errors
- [ ] AC 5: Table `wishlist_items` exists with correct schema (verified via `\d wishlist_items`)
- [ ] AC 6: All 5 indexes created and visible (verified via `\di wishlist_items*`)
- [ ] AC 7: Enums `wishlist_store` and `wishlist_currency` created with correct values
- [ ] AC 8: Check constraint `priority_range_check` enforces 0-5 range (INSERT with priority=10 fails)
- [ ] AC 9: Migration is idempotent (re-running `db:migrate` does not fail)

### Rollback Verification (AC 10-11)
- [ ] AC 10: Rollback script documented in this story
- [ ] AC 11: Rollback tested in local environment (drops table and enums cleanly)

### Cross-Environment (AC 12-13)
- [ ] AC 12: Migration applied to staging database (if applicable)
- [ ] AC 13: Production migration planned and coordinated with ops team

### Schema Verification (AC 14-15)
- [ ] AC 14: Column types match WISH-2000 exactly (19 columns, correct data types)
- [ ] AC 15: Enum values match WISH-2000 exactly:
  - `wishlist_store`: LEGO, Barweer, Cata, BrickLink, Other
  - `wishlist_currency`: USD, EUR, GBP, CAD, AUD

## Reuse Plan

### Existing Infrastructure
- **Drizzle Migration System**: Use existing `drizzle.config.ts` and migration patterns from `packages/backend/database-schema`
- **Migration Naming**: Follow established convention from migrations 0000-0006
- **SQL Dialect**: Aurora PostgreSQL 14+ (same as existing migrations)
- **Connection Configuration**: Reuse existing environment variable setup (`.env.local`, `.env`)

### No New Packages Required
All migration tooling already exists in `packages/backend/database-schema`. No new dependencies needed.

## Architecture Notes

### Drizzle ORM Migration Flow
1. Schema defined in `packages/backend/database-schema/src/schema/index.ts` (lines 363-435)
2. `pnpm db:generate` reads schema, generates SQL migration file
3. `pnpm db:migrate` applies pending migrations to database
4. Migration state tracked in `meta/_journal.json`

### Migration File Structure
```sql
-- Generated by Drizzle
CREATE TYPE wishlist_store AS ENUM ('LEGO', 'Barweer', 'Cata', 'BrickLink', 'Other');
CREATE TYPE wishlist_currency AS ENUM ('USD', 'EUR', 'GBP', 'CAD', 'AUD');

CREATE TABLE wishlist_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  title TEXT NOT NULL,
  store wishlist_store NOT NULL,
  set_number TEXT,
  source_url TEXT,
  image_url TEXT,
  price TEXT,
  currency wishlist_currency DEFAULT 'USD',
  piece_count INTEGER,
  release_date TIMESTAMP,
  tags JSONB DEFAULT '[]',
  priority INTEGER DEFAULT 0,
  notes TEXT,
  sort_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP NOT NULL DEFAULT now(),
  created_by TEXT,
  updated_by TEXT,
  CONSTRAINT priority_range_check CHECK (priority >= 0 AND priority <= 5)
);

CREATE INDEX idx_wishlist_user_id ON wishlist_items(user_id);
CREATE INDEX idx_wishlist_user_sort ON wishlist_items(user_id, sort_order);
CREATE INDEX idx_wishlist_user_store ON wishlist_items(user_id, store);
CREATE INDEX idx_wishlist_user_priority ON wishlist_items(user_id, priority);
CREATE INDEX idx_wishlist_user_store_priority ON wishlist_items(user_id, store, priority);
```

### Transaction Semantics
- Drizzle runs migrations within a transaction
- If migration fails, entire transaction rolls back
- No partial state left in database

## Infrastructure Notes

### Database Connection Requirements
- PostgreSQL 14+ (Aurora PostgreSQL in production)
- Connection details in environment variables:
  - `POSTGRES_HOST`
  - `POSTGRES_PORT` (default: 5432)
  - `POSTGRES_USERNAME`
  - `POSTGRES_PASSWORD`
  - `POSTGRES_DATABASE`

### Migration Execution Permissions
Database user must have:
- `CREATE TABLE` permission
- `CREATE TYPE` permission (for enums)
- `CREATE INDEX` permission
- Write access to database

### Rollback Plan
If migration needs to be rolled back:
```sql
DROP TABLE IF EXISTS wishlist_items CASCADE;
DROP TYPE IF EXISTS wishlist_store CASCADE;
DROP TYPE IF EXISTS wishlist_currency CASCADE;
```

**Warning**: Rollback destroys all wishlist data. Only safe before WISH-2001 goes live.

### Production Deployment Considerations
- Migration must run BEFORE any code that queries `wishlist_items` is deployed
- Index creation locks table (empty table = fast, but document for future)
- Consider `CREATE INDEX CONCURRENTLY` for production if table has data
- Coordinate timing with ops team to minimize risk

## Test Plan

Synthesized from `_pm/TEST-PLAN.md`.

### Happy Path Tests

**Test 1: Fresh Migration on Empty Database**
- Generate migration with `pnpm db:generate`
- Apply migration with `pnpm db:migrate`
- Verify table exists: `\d wishlist_items`
- Verify all 19 columns present with correct types
- Verify 5 indexes created: `\di wishlist_items*`
- Verify 2 enums created: `SELECT enumlabel FROM pg_enum WHERE enumtypid = 'wishlist_store'::regtype`

**Test 2: Migration Idempotency**
- Re-run `pnpm db:migrate` on already-migrated database
- Verify no errors thrown
- Verify schema unchanged

**Test 3: Column Types and Constraints**
- Query PostgreSQL catalog to verify column types
- Attempt INSERT with invalid data (priority = 10)
- Verify check constraint rejects invalid values

**Test 4: Index Performance**
- Insert 1000 test wishlist items
- Run EXPLAIN ANALYZE on indexed queries
- Verify index scans used (not sequential scans)

### Error Cases

**Error 1: Conflicting Schema**
- Manually create `wishlist_items` with different schema
- Run migration
- Verify migration fails safely with transaction rollback

**Error 2: Missing Permissions**
- Database user without CREATE TABLE permission
- Verify migration fails with clear error message

**Error 3: Read-Only Connection**
- Database connection in read-only mode
- Verify migration fails before attempting writes

### Edge Cases

**Edge 1: Large Data Volume**
- Insert 100,000 test items
- Verify queries remain performant (< 50ms)

**Edge 2: Concurrent Migrations**
- Simulate two migration processes
- Verify one succeeds, one waits or fails gracefully

### Manual Verification Queries

```sql
-- Verify table exists
SELECT table_name FROM information_schema.tables WHERE table_name = 'wishlist_items';

-- Verify columns
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'wishlist_items'
ORDER BY ordinal_position;

-- Verify indexes
SELECT indexname FROM pg_indexes WHERE tablename = 'wishlist_items';

-- Verify constraints
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conrelid = 'wishlist_items'::regclass;

-- Verify enums
SELECT enumlabel FROM pg_enum WHERE enumtypid = 'wishlist_store'::regtype;
SELECT enumlabel FROM pg_enum WHERE enumtypid = 'wishlist_currency'::regtype;
```

## Risk Notes

### MVP-Critical Risks

**Risk 1: Enum Definitions Must Match WISH-2000 Exactly**
- PostgreSQL enums are immutable after creation
- If created with wrong values, cannot be easily modified
- **Mitigation**: Code review MUST verify enum values match WISH-2000 spec

**Risk 2: Migration Already Exists from Previous Attempts**
- If table already exists from manual testing, Drizzle will detect drift
- **Mitigation**: Document "clean state" procedure for development

**Risk 3: Index Creation Performance**
- Index creation locks table (fast on empty table, but document for future)
- **Mitigation**: MUST run migration BEFORE any data is inserted

### Future Risks (Non-MVP)
See `_pm/FUTURE-RISKS.md` for:
- Schema evolution strategy
- Multi-environment coordination
- Large dataset performance
- Backup and restore testing
- Database connection pooling in serverless

## Definition of Done

- [ ] Migration file generated at `packages/backend/database-schema/src/migrations/app/0007_*.sql`
- [ ] Migration metadata updated in `meta/` directory
- [ ] Migration runs successfully in local dev environment
- [ ] All 15 Acceptance Criteria verified
- [ ] Rollback script tested in local environment
- [ ] Staging migration applied (if applicable)
- [ ] Production migration coordinated with ops
- [ ] TypeScript compilation passes
- [ ] Code review completed
- [ ] Story marked "Ready for WISH-2001"

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~2k | — | — | — |
| Elaboration | ~2k | — | — | — |
| Implementation | ~3k | — | — | — |
| Code Review | ~2k | — | — | — |
| **Total** | ~9k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-24 02:00 | pm-bootstrap-generation-leader | Created story file | WISH-2007.md |
| 2026-01-27 21:30 | pm-story-generation-leader | Generated complete story with PM workers | WISH-2007.md, _pm/TEST-PLAN.md, _pm/DEV-FEASIBILITY.md, _pm/UIUX-NOTES.md, _pm/BLOCKERS.md, _pm/FUTURE-RISKS.md |
| 2026-01-28 14:30 | elab-completion-leader | Generated ELAB report and completed elaboration | ELAB-WISH-2007.md |

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified
| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| — | None identified | Not Reviewed | Story has no MVP-blocking gaps. All core functionality covered. |

### Enhancement Opportunities
| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | No automated migration testing in CI | Not Reviewed | Add CI job to test migrations on fresh database (prevents drift) - future enhancement |
| 2 | No migration rollback automation | Not Reviewed | Create `db:rollback` script for development safety - future enhancement |
| 3 | Schema drift detection | Not Reviewed | Add `db:check` command to validate live database matches schema - future enhancement |
| 4 | Migration documentation with inline comments | Not Reviewed | Helpful context for developers maintaining schema - future enhancement |
| 5 | Multi-environment coordination tool | Not Reviewed | Build migration orchestration for staging → production - future enhancement |
| 6 | Schema evolution policy documentation | Not Reviewed | Critical for long-term maintenance - document before any schema modifications |
| 7 | Enum modification procedure documentation | Not Reviewed | PostgreSQL enums are immutable - document workaround for future stores/currencies |
| 8 | Database connection pooling | Not Reviewed | Required before WISH-2001 implementation, explicitly noted in Non-goals |

### Follow-up Stories Suggested
- [x] Schema evolution policy and versioning strategy (High priority - required before any schema modifications) → WISH-2057
- [x] Enum modification procedure for future stores/currencies (High priority - handle PostgreSQL immutability) → WISH-2027
- [x] CI/CD automated migration testing (Medium priority - prevents migration drift) → WISH-2047
- [x] Schema drift detection tool (`db:check` command) (Medium priority - catches developer errors) → WISH-2017
- [x] Multi-environment migration orchestration with approval gates (High priority - production safety) → WISH-2037
- [ ] Database connection pooling setup before WISH-2001 (Explicit dependency requirement)

### Items Marked Out-of-Scope
- Schema design modifications: Covered by WISH-2000, not in scope for execution story
- Initial seeding: Covered by WISH-2000 seed scripts, not part of migration execution
- Automated migration testing in CI: Future enhancement, not blocking MVP
- Schema evolution strategy: Future story, not required for single table creation
