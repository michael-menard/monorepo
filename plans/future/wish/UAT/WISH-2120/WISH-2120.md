---
id: WISH-2120
title: "Test utility helpers (createMockFile, mockS3Upload) for S3 upload testing"
status: uat
created: 2026-01-28
updated: 2026-02-08
depends_on:
  - WISH-2011
follow_up_from: WISH-2011
phase: "2 - Infrastructure"
priority: P2
complexity: Small
effort: 1
category: Test Infrastructure
---

# WISH-2120: Test utility helpers (createMockFile, mockS3Upload) for S3 upload testing

## Context

The S3 upload testing patterns established in WISH-2011 work well, but require significant boilerplate code in each test file. The current approach in `useS3Upload.test.ts` involves:

1. **Mock file creation:** 3+ lines per file with manual `new File()` calls
2. **Mock presign responses:** ~10 lines of mock setup per scenario
3. **Mock S3 upload responses:** ~10 lines of mock setup per scenario
4. **Progress simulation:** Complex `onProgress` callback mocking

This boilerplate is repeated across multiple test files, leading to:
- Inconsistent mock patterns
- Harder-to-read tests
- Higher maintenance burden when upload patterns change

## Goal

Create reusable test utilities that reduce S3 upload test boilerplate to single function calls, improving test readability, maintainability, and consistency across the codebase.

## Non-Goals

- Production runtime code changes
- Backend API changes
- Playwright E2E MSW setup (covered in WISH-2121)
- Changes to the actual upload flow logic
- Coverage metrics improvements (test infrastructure only)

---

## Scope

### Test Utilities

#### createMockFile

Generate test `File` objects with configurable properties:

```typescript
// Simple usage with defaults
const file = createMockFile()
// → File { name: 'test-image.jpg', type: 'image/jpeg', size: 1024 }

// Custom properties
const file = createMockFile({
  name: 'custom-photo.png',
  type: 'image/png',
  size: 5 * 1024 * 1024, // 5MB
  content: 'optional explicit content'
})
```

#### mockS3Upload

Configure common upload scenarios with MSW handlers:

```typescript
// Success scenario
const cleanup = mockS3Upload({ scenario: 'success' })
// ... test code ...
cleanup()

// Error scenarios
const cleanup = mockS3Upload({
  scenario: 'presign-error',
  statusCode: 403
})

// With custom delay and progress simulation
const cleanup = mockS3Upload({
  scenario: 'success',
  delay: 200,
  progressSteps: [25, 50, 75, 100]
})
```

### Packages Affected

| Package | Change Type | Description |
|---------|-------------|-------------|
| `apps/web/app-wishlist-gallery/src/test/utils/` | **New** | Test utilities directory |
| `apps/web/app-wishlist-gallery/src/test/utils/createMockFile.ts` | **New** | Mock file factory |
| `apps/web/app-wishlist-gallery/src/test/utils/mockS3Upload.ts` | **New** | S3 upload scenario mocking |
| `apps/web/app-wishlist-gallery/src/test/utils/index.ts` | **New** | Utility exports |
| `apps/web/app-wishlist-gallery/src/test/utils/__tests__/` | **New** | Utility tests |
| `apps/web/app-wishlist-gallery/src/hooks/__tests__/` | **Refactor** | Use new utilities |
| `apps/web/app-wishlist-gallery/src/components/**/__tests__/` | **Refactor** | Use new utilities |

---

## Acceptance Criteria

### createMockFile Utility

- [ ] **AC1:** `createMockFile()` with no arguments returns a valid `File` object with sensible defaults (name: `'test-image.jpg'`, type: `'image/jpeg'`, size: 1024 bytes)
- [ ] **AC2:** `createMockFile({ name, type, size })` creates a file with specified properties
- [ ] **AC3:** `createMockFile({ content })` allows explicit content to be set
- [ ] **AC4:** `createMockFile({ size: 0 })` creates a zero-byte file for edge case testing
- [ ] **AC5:** `createMockFile({ size: 10 * 1024 * 1024 })` creates large files efficiently (< 100ms)

### mockS3Upload Utility

- [ ] **AC6:** `mockS3Upload({ scenario: 'success' })` mocks both presign API and S3 PUT to return success
- [ ] **AC7:** `mockS3Upload({ scenario: 'presign-error', statusCode })` mocks presign API failure
- [ ] **AC8:** `mockS3Upload({ scenario: 's3-error', statusCode })` mocks S3 PUT failure
- [ ] **AC9:** `mockS3Upload({ scenario: 'timeout', delay })` simulates network timeout
- [ ] **AC10:** `mockS3Upload({ progressSteps: [25, 50, 75, 100] })` fires progress callbacks at specified percentages
- [ ] **AC11:** `mockS3Upload()` returns a cleanup function that removes handlers

### Test & Documentation

- [ ] **AC12:** All utilities have 100% test coverage in `src/test/utils/__tests__/`
- [ ] **AC13:** Existing `useS3Upload.test.ts` is refactored to use new utilities
- [ ] **AC14:** JSDoc comments document all options and return types
- [ ] **AC15:** TypeScript types provide full autocomplete for options objects

---

## Reuse Plan

### Existing Patterns

| Pattern | Source | Usage |
|---------|--------|-------|
| MSW v2 handlers | `src/test/mocks/handlers.ts` | Follow `http.get/http.put` syntax |
| File API | `useS3Upload.test.ts` | Extract existing `new File()` patterns |
| vitest mocking | `useS3Upload.test.ts` | Extend `vi.mock` patterns |

### No New Dependencies

All utilities build on existing test infrastructure:
- `msw` (already installed)
- `vitest` (already installed)
- Native `File` API (browser standard)

---

## Architecture Notes

### Ports & Adapters

This story is **test infrastructure only** and does not affect production architecture. However, the utilities follow similar patterns:

- **createMockFile:** Pure factory function (no side effects)
- **mockS3Upload:** Returns cleanup function for proper resource management

### Directory Structure

```
apps/web/app-wishlist-gallery/src/test/
├── mocks/
│   ├── browser.ts
│   ├── handlers.ts
│   └── server.ts
├── utils/                    # NEW
│   ├── __tests__/
│   │   ├── createMockFile.test.ts
│   │   └── mockS3Upload.test.ts
│   ├── createMockFile.ts
│   ├── mockS3Upload.ts
│   └── index.ts
└── setup.ts
```

---

## Infrastructure Notes

- **No infrastructure changes** - Test-only code
- **No deployment** - Not included in production builds
- **CI impact:** Minimal (adds ~12 new tests)

---

## Test Plan

### Utility Tests

| Utility | Scenario | Tests |
|---------|----------|-------|
| createMockFile | defaults | 1 |
| createMockFile | custom props | 1 |
| createMockFile | edge cases (0-byte, large, special chars) | 3 |
| mockS3Upload | success | 2 |
| mockS3Upload | errors (presign, s3) | 2 |
| mockS3Upload | timeout | 1 |
| mockS3Upload | progress | 1 |
| mockS3Upload | cleanup | 1 |
| **Total** | | **12** |

### Refactoring Verification

After refactoring existing tests:
1. All `useS3Upload.test.ts` tests pass
2. Lines of code reduced by ~50%
3. No functionality regression

### Evidence Commands

```bash
# Run utility tests
pnpm --filter app-wishlist-gallery test src/test/utils

# Run refactored tests
pnpm --filter app-wishlist-gallery test src/hooks/__tests__/useS3Upload.test.ts

# Type check
pnpm check-types

# Lint
pnpm lint
```

---

## TypeScript Interfaces

```typescript
// createMockFile
interface CreateMockFileOptions {
  name?: string     // default: 'test-image.jpg'
  type?: string     // default: 'image/jpeg'
  size?: number     // default: 1024 (bytes)
  content?: string  // optional explicit content
}

function createMockFile(options?: CreateMockFileOptions): File

// mockS3Upload
interface MockS3UploadOptions {
  scenario: 'success' | 'presign-error' | 's3-error' | 'timeout'
  statusCode?: number        // default depends on scenario
  delay?: number             // default: 0 (ms)
  progressSteps?: number[]   // default: [100]
}

type MockS3UploadCleanup = () => void

function mockS3Upload(options: MockS3UploadOptions): MockS3UploadCleanup
```

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| MSW handler leaks | Medium | High | Cleanup function + test isolation |
| Large file perf | Low | Medium | Lazy content generation |
| Type complexity | Low | Low | Keep options simple |

---

## Source

Follow-up from QA Elaboration of WISH-2011 (Enhancement Opportunity #3)

**Original Finding:** Test utility helpers (createMockFile, mockS3Upload) as future enhancement after WISH-2011 validation

**Category:** Enhancement Opportunity
**Impact:** Medium (improved test developer experience)
**Effort:** Low (1 point)

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-30_

### Gaps Identified
| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Coverage metrics integration | Follow-up | Add coverage threshold enforcement (e.g., 80%) for test utility files via vitest.config.ts. Non-MVP: existing tests work fine without this. → WISH-20290 |
| 2 | E2E test file examples | Not Reviewed | Create example E2E test using utilities in `apps/web/playwright/tests/examples/` to demonstrate reuse patterns. Non-MVP: utilities target Vitest, not Playwright (WISH-2121). |

### Enhancement Opportunities
| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Visual Studio Code snippets | Not Reviewed | Create VS Code snippet for `createMockFile()` and `mockS3Upload()` in `.vscode/test-utils.code-snippets` to improve discoverability for developers. |
| 2 | Auto-cleanup in test teardown | Not Reviewed | Add global MSW handler cleanup in `src/test/setup.ts` afterEach hook to prevent handler leaks across tests. Current approach requires manual cleanup() calls. |
| 3 | Mock file content generators | Not Reviewed | Add specialized generators like `createMockImageFile({ format: 'jpeg', megapixels: 12 })` that create realistic image content with EXIF metadata for advanced testing. Non-MVP: basic File objects sufficient for current tests. |
| 4 | Progress simulation presets | Not Reviewed | Add named progress presets like `mockS3Upload({ progressProfile: 'slow-connection' })` for common network scenarios. Non-MVP: custom progressSteps already supported. |
| 5 | TypeScript template literals | Not Reviewed | Use template literal types for scenario parameter (e.g., `scenario: 'success' | 'presign-error' | 's3-error' | 'timeout'`) for better autocomplete. Already documented in story but worth highlighting. |

### Follow-up Stories Suggested
- [ ] WISH-2121: Playwright E2E MSW setup (already tracked as separate story)
- [ ] Coverage metrics integration for test utilities
- [x] VS Code snippets for test utility discovery → WISH-20300
- [x] Global MSW handler cleanup patterns → WISH-20310

### Items Marked Out-of-Scope
- Production runtime code changes: Not needed for test utilities only
- Backend API changes: Story scope is test infrastructure only
- Playwright E2E MSW setup: Covered in WISH-2121 story
- Changes to the actual upload flow logic: Out of scope per Non-Goals
- Coverage metrics improvements: Test infrastructure only, non-MVP
