---
doc_type: story
title: "WISH-20420: Schema Migration Code Generation Tool"
story_id: WISH-20420
story_prefix: WISH
status: backlog
phase: 1
created_at: "2026-01-31T00:00:00-07:00"
updated_at: "2026-01-31T00:00:00-07:00"
depends_on: [WISH-20210]
follow_up_from: WISH-20210
estimated_points: 5
---

# WISH-20420: Schema Migration Code Generation Tool

## Follow-up Context

**Parent Story:** WISH-20210
**Source:** QA Discovery Notes - Follow-up Stories Suggested (Finding #3)
**Original Finding:** "Build schema migration code generation based on impact analysis output"
**Category:** Enhancement Opportunity
**Impact:** High
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-20210 (Schema Change Impact Analysis Tool) as a natural next step to automate the manual work identified by impact analysis. While WISH-20210 provides developers with comprehensive reports of affected files and required changes, developers must still manually write migration code, update Zod schemas, modify service layer code, and update frontend components. This follow-up eliminates repetitive manual work by generating skeleton code for common schema change patterns.

## Context

WISH-20210 establishes a CLI tool (`pnpm db:impact-analysis`) that analyzes proposed database schema changes and generates comprehensive impact reports. These reports identify:
- Affected backend services, repositories, and routes
- Frontend components requiring updates
- Zod schemas needing modifications
- Test files requiring fixture updates

However, the tool stops at **analysis** - developers must manually implement all the changes identified in the report. For common schema change patterns (adding columns, adding enum values, renaming columns), this manual work is repetitive, error-prone, and time-consuming.

**The Problem:**
- Adding a new column requires updating 5-10+ files with nearly identical boilerplate (Drizzle schema, Zod schemas, service layer, repository layer, API response types, frontend components)
- Adding an enum value requires updating enum definitions in multiple locations (Drizzle schema, Zod schema, TypeScript union types)
- Renaming a column requires careful find-replace across dozens of files, risking typos and missed references

**The Opportunity:**
Build a code generation tool that consumes WISH-20210's impact analysis output and generates skeleton code for affected files, reducing developer effort from hours to minutes.

## Goal

Build an automated CLI tool that consumes schema change impact analysis reports (from WISH-20210) and generates skeleton code modifications for affected files, including Drizzle schema updates, Zod schema changes, service layer boilerplate, and frontend component scaffolding.

## Non-goals

- Automated application of generated code (developer must review and apply manually)
- Complex business logic generation (only skeleton/boilerplate code)
- Test case implementation (only fixture/mock updates)
- Database migration execution (only generates migration files)
- Support for arbitrary schema refactoring (focus on common patterns only)

## Scope

### CLI Tool: `pnpm db:generate-migration`

```bash
# Generate migration code from impact analysis report
pnpm db:generate-migration --report impact-reports/2026-01-29-wishlist_items-add-column-priority.md

# Preview generated code without writing files
pnpm db:generate-migration --report latest.md --dry-run

# Generate code for specific file categories only
pnpm db:generate-migration --report latest.md --only backend
```

### Code Generation Capabilities

1. **Drizzle Schema Updates**
   - Adding optional columns: `priority: text('priority')`
   - Adding required columns with defaults: `priority: text('priority').notNull().default('medium')`
   - Adding enum values: extend existing `pgEnum()` definition
   - Renaming columns: generate `.alter()` migration

2. **Zod Schema Updates**
   - Adding optional fields: `priority: z.string().optional()`
   - Adding required fields: `priority: z.string()`
   - Extending enum schemas: `z.enum(['LEGO', 'BrickLink', 'Amazon'])`
   - Updating union types for enum changes

3. **Service Layer Boilerplate**
   - Update service method signatures to include new fields
   - Generate skeleton validation logic for new required fields
   - Add field mapping in repository adapters

4. **Frontend Scaffolding**
   - Generate form field components for new columns
   - Update TypeScript types imported from `@repo/api-client`
   - Generate display components for new fields (badges, labels, etc.)

5. **Test Fixture Updates**
   - Add new fields to mock data objects
   - Update test assertions to include new fields
   - Generate skeleton test cases for new validation logic

### Generated Code Output Structure

```
generated-migrations/
  2026-01-29-wishlist_items-add-priority/
    drizzle/
      0001_add_priority_column.sql
      schema-update.ts
    backend/
      wishlist-schema.zod.ts.patch
      wishlist-service.ts.patch
      wishlist-repository.ts.patch
    frontend/
      WishlistForm.tsx.patch
      WishlistCard.tsx.patch
    tests/
      wishlist-fixtures.ts.patch
    README.md  # Instructions for applying patches
```

### Supported Schema Change Patterns

**Phase 1 (MVP):**
1. Adding optional column to table
2. Adding enum value to existing enum
3. Updating Zod schemas for new fields

**Phase 2 (Future):**
4. Adding required column with default/backfill
5. Renaming column across codebase
6. Dropping column (with cleanup suggestions)

### Packages Affected

- `packages/backend/database-schema/scripts/` - New `generate-migration.ts` CLI tool
- `packages/backend/database-schema/src/` - Code generation templates and AST utilities
- Reuses existing `impact-analysis.ts` output from WISH-20210

### Technical Implementation

1. **Impact Report Parser**
   - Parse Markdown impact report from WISH-20210
   - Extract change summary (table, operation, column/enum details)
   - Extract affected file list (backend, frontend, tests)

2. **Template-Based Code Generation**
   - Use handlebars/mustache templates for common patterns
   - Templates for Drizzle migrations, Zod schema updates, service layer boilerplate
   - Template variables: `{tableName}`, `{columnName}`, `{columnType}`, `{isOptional}`

3. **AST-Based Code Insertion**
   - Use `ts-morph` (already added for WISH-20210) to parse existing files
   - Insert new code at appropriate locations (e.g., add field to Zod schema object)
   - Generate `.patch` files (unified diff format) for developer review

4. **Safe Defaults**
   - All generated code includes `// GENERATED CODE - REVIEW BEFORE APPLYING` comments
   - Dry-run mode by default, `--apply` flag required to write files
   - Generate summary report of all changes for review

## Acceptance Criteria

### CLI Tool Basics (AC 1-4)

- [ ] AC 1: CLI tool `pnpm db:generate-migration` accepts `--report` flag pointing to impact analysis Markdown file
- [ ] AC 2: Tool parses impact report and extracts change summary (table, operation, affected files)
- [ ] AC 3: Tool generates code in `generated-migrations/{timestamp}-{table}-{operation}/` directory structure
- [ ] AC 4: Tool supports `--dry-run` flag to preview code generation without writing files

### Drizzle Schema Generation (AC 5-7)

- [ ] AC 5: Adding optional column generates valid Drizzle schema code: `columnName: text('column_name')`
- [ ] AC 6: Adding enum value extends existing `pgEnum()` definition with new value
- [ ] AC 7: Generated Drizzle code includes SQL migration file (`.sql`) and TypeScript schema update

### Zod Schema Generation (AC 8-10)

- [ ] AC 8: Adding optional column generates Zod schema update: `columnName: z.string().optional()`
- [ ] AC 9: Adding enum value extends Zod enum schema: `z.enum([...existingValues, 'NewValue'])`
- [ ] AC 10: Generated Zod code includes `.patch` file with unified diff format for developer review

### Service Layer Boilerplate (AC 11-13)

- [ ] AC 11: Adding column generates service method signature updates (e.g., `createWishlistItem(data: CreateWishlistInput)`)
- [ ] AC 12: Generated service code includes field mapping in repository adapter
- [ ] AC 13: Generated code includes `// GENERATED CODE - REVIEW BEFORE APPLYING` comments

### Frontend Scaffolding (AC 14-16)

- [ ] AC 14: Adding column generates form field component skeleton (e.g., `<Input name="priority" />`)
- [ ] AC 15: Generated frontend code includes TypeScript type import updates
- [ ] AC 16: Generated code provides multiple implementation options (input, select, textarea) with comments

### Test Fixture Updates (AC 17-18)

- [ ] AC 17: Adding column generates test fixture updates with default values (e.g., `priority: 'medium'`)
- [ ] AC 18: Generated test code updates mock data objects in `__tests__/` directories

### Code Quality (AC 19-22)

- [ ] AC 19: All generated code passes TypeScript compilation (no syntax errors)
- [ ] AC 20: Generated `.patch` files use unified diff format compatible with `git apply`
- [ ] AC 21: Tool generates `README.md` with step-by-step instructions for applying patches
- [ ] AC 22: Tool validates impact report format before generation (fails early if report is invalid)

### Documentation (AC 23-24)

- [ ] AC 23: `packages/backend/database-schema/docs/MIGRATION-CODE-GENERATION.md` documents CLI usage with examples
- [ ] AC 24: Documentation includes guide for extending templates to support new schema change patterns

## Reuse Plan

### Existing Patterns

- **WISH-20210 Output**: Consume impact analysis Markdown reports as input
- **ts-morph Library**: Reuse AST utilities from WISH-20210 for code insertion
- **Turbo Generators**: Reuse template patterns from `turbo/generators/` for component scaffolding
- **Database Schema Patterns**: Follow existing Drizzle migration conventions from `packages/backend/database-schema/`

### Template Strategy

- Store templates in `packages/backend/database-schema/templates/`
- Use handlebars for simple variable substitution (table name, column name)
- Use ts-morph for complex AST-based insertions (adding field to existing object)

## Architecture Notes

### Code Generation Pipeline

```typescript
// Conceptual pipeline for migration code generation
const generationPipeline = {
  1. parseImpactReport: 'Extract change summary and affected files',
  2. selectTemplates: 'Choose appropriate templates based on operation type',
  3. renderTemplates: 'Substitute variables (table, column, type)',
  4. insertCode: 'Use ts-morph to insert code at correct locations',
  5. generatePatches: 'Create unified diff .patch files',
  6. generateREADME: 'Write step-by-step application instructions'
}
```

### Template Examples

**Drizzle Column Addition Template:**
```typescript
// Template: drizzle-add-column.hbs
{{columnName}}: {{columnType}}('{{columnDbName}}'){{#if isOptional}}{{else}}.notNull(){{/if}}{{#if hasDefault}}.default({{defaultValue}}){{/if}},
```

**Zod Schema Addition Template:**
```typescript
// Template: zod-add-field.hbs
{{fieldName}}: z.{{zodType}}(){{#if isOptional}}.optional(){{/if}}{{#if hasValidation}}.{{validation}}{{/if}},
```

### Safety Mechanisms

1. **No Automatic Application**: Tool generates patches, developer must review and apply
2. **Dry-run Default**: Requires explicit `--apply` flag to write files
3. **Validation**: Check that generated code passes TypeScript compilation before writing
4. **Rollback**: Keep original files untouched, only create new patch files

## Infrastructure Notes

### Integration with WISH-20210

```bash
# Typical workflow combining both tools
pnpm db:impact-analysis --table wishlist_items --change "add-column:priority:text"
# Review impact report: impact-reports/2026-01-31-wishlist_items-add-column-priority.md

pnpm db:generate-migration --report impact-reports/2026-01-31-wishlist_items-add-column-priority.md
# Review generated code: generated-migrations/2026-01-31-wishlist_items-add-priority/

# Apply patches manually after review
cd generated-migrations/2026-01-31-wishlist_items-add-priority/
cat README.md  # Follow application instructions
```

### Generated Output Structure

- **Drizzle migrations**: SQL + TypeScript schema updates
- **Backend patches**: `.patch` files for services, repositories, schemas
- **Frontend patches**: `.patch` files for components, hooks
- **Test patches**: `.patch` files for fixtures, mocks
- **README.md**: Step-by-step application guide

## Test Plan

### Unit Tests

**Test 1: Impact Report Parsing**
- Mock impact report Markdown with "add-column:priority:text" change
- Run parser and verify extracted change summary
- Assert: table = 'wishlist_items', operation = 'add-column', column = 'priority', type = 'text'

**Test 2: Drizzle Code Generation**
- Mock change: adding optional column "priority:text"
- Run Drizzle template renderer
- Assert: generated code matches `priority: text('priority'),`

**Test 3: Zod Schema Generation**
- Mock change: adding optional column "priority:text"
- Run Zod template renderer
- Assert: generated code matches `priority: z.string().optional(),`

**Test 4: Service Layer Boilerplate**
- Mock change: adding optional column "priority:text"
- Run service template renderer
- Assert: generated code includes method signature update

### Integration Tests

**Test 5: End-to-End Column Addition**
- Use real impact report from WISH-20210 integration test (priority column)
- Run `pnpm db:generate-migration --report test-report.md --dry-run`
- Verify generated code in all categories (Drizzle, Zod, service, frontend, tests)

**Test 6: Enum Value Addition**
- Mock impact report for adding "Amazon" to `wishlist_store` enum
- Run code generation
- Verify Drizzle `pgEnum()` extension and Zod enum update

### Edge Cases

**Edge 1: Invalid Impact Report**
- Provide malformed Markdown file
- Verify tool fails early with clear error message: "Invalid report format"

**Edge 2: No Code Generation Needed**
- Provide impact report for zero-impact change (e.g., adding index only)
- Verify tool generates empty output with message: "No code generation required"

**Edge 3: Complex Type Change**
- Provide impact report for breaking change (e.g., changing column type)
- Verify tool generates warning comments: "// WARNING: Breaking change - manual review required"

## Risk Notes

### MVP-Critical Risks

**Risk 1: Generated Code Doesn't Compile**
- Templates may produce invalid TypeScript syntax
- **Mitigation**: Run `tsc --noEmit` on generated files before writing; fail if compilation errors

**Risk 2: Template Maintenance Burden**
- As codebase patterns evolve, templates become stale
- **Mitigation**: Document template extension guide; make templates easy to customize

**Risk 3: Over-reliance on Code Generation**
- Developers may apply patches without review, introducing bugs
- **Mitigation**: Require `--apply` flag; include "REVIEW REQUIRED" comments in all generated code

### Non-MVP Risks

**Risk 4: Conflict with Manual Changes**
- Generated patches may conflict with developer's manual edits
- **Mitigation**: Use unified diff format; let git handle conflicts

**Risk 5: False Confidence in Completeness**
- Tool may not generate all necessary code (e.g., complex business logic)
- **Mitigation**: Document limitations; mark generated code as "skeleton" requiring completion

## Definition of Done

- [ ] All 24 Acceptance Criteria verified
- [ ] CLI tool `pnpm db:generate-migration` functional with column and enum generation
- [ ] Code generated for Drizzle schemas, Zod schemas, service layer, and frontend
- [ ] Unit tests pass (4+ scenarios: impact parsing, Drizzle, Zod, service generation)
- [ ] Integration test validates end-to-end generation from real impact report
- [ ] Documentation created (`MIGRATION-CODE-GENERATION.md`) with usage examples
- [ ] Tool tested against WISH-20210 output (priority column example)
- [ ] Generated code reviewed for correctness and TypeScript compilation
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~5k | — | — | Follow-up generation from WISH-20210 finding #3 |
| Implementation | ~18k | — | — | Template system + AST code insertion + patch generation |
| Testing | ~10k | — | — | Unit + integration tests for code generation |
| Review | ~4k | — | — | Code review + documentation review |
| **Total** | ~37k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-31 00:00 | pm-story-followup-leader | Created follow-up story from WISH-20210 finding #3 (Schema migration code generation) | WISH-20420.md |

---

## Future Enhancement Notes

Once this tool exists, consider:
- **AI-Assisted Code Generation**: Use LLM to generate complex business logic, not just boilerplate
- **Interactive Application Mode**: Step-by-step wizard for applying patches with conflict resolution
- **Direct File Modification**: Add `--auto-apply` mode for trusted scenarios (with backup)
- **Rollback Capability**: Generate reverse patches for easy undo
- **Custom Template Library**: Community-contributed templates for domain-specific patterns
- **CI Integration**: Automatically generate migration code in PR review comments
