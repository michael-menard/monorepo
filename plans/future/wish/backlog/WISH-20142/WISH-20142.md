---
doc_type: story
title: "WISH-20142: Playwright E2E Tests for Smart Sorting"
story_id: WISH-20142
story_prefix: WISH
status: backlog
e2e_required: true
phase: 4
created_at: "2026-02-09T00:00:00-07:00"
updated_at: "2026-02-09T00:00:00-07:00"
depends_on: [WISH-2014]
follow_up_from: WISH-2014
estimated_points: 2
sizing_warning: false
---

# WISH-20142: Playwright E2E Tests for Smart Sorting

## Context

Deferred from WISH-2014 (Smart Sorting Algorithms) AC12. Unit tests for the smart sorting feature were written using Vitest + JSDOM, but full interaction testing with Radix UI Select was not possible in JSDOM due to portal/focus limitations. This story adds Playwright browser-based E2E tests to verify the complete user flow.

**Deferred AC from WISH-2014:**
- **AC12**: Playwright E2E test covers full sort flow - select each smart sort option, verify items re-order, verify network requests, verify no console errors

## Goal

Add Playwright E2E tests that verify the smart sorting feature works end-to-end in a real browser: selecting sort options from the dropdown, confirming API calls include correct sort parameters, validating that items re-render in the expected order, and ensuring accessibility compliance.

## Non-goals

- Changing sort algorithm behavior (already implemented in WISH-2014)
- Adding new sort modes
- Modifying backend sort logic
- Testing icon/tooltip rendering (covered by WISH-20141 if implemented)
- Performance benchmarking (AC16 already covered by SQL-level implementation)

## Scope

### Packages Affected

1. **Playwright Tests**: `apps/web/playwright/`
   - New test file: `wishlist/smart-sorting.spec.ts`
   - May need test fixtures for seeded wishlist data with varied price/pieceCount/releaseDate/priority

### Database Impact
- None (uses existing test data or seeds via API)

## Acceptance Criteria

**AC1**: Playwright test selects "Best Value" sort option
- Opens sort dropdown in real browser
- Clicks "Best Value" option
- Verifies network request includes `sort=bestValue`
- Verifies items re-render (gallery updates)

**AC2**: Playwright test selects "Expiring Soon" sort option
- Opens sort dropdown
- Clicks "Expiring Soon" option
- Verifies network request includes `sort=expiringSoon`
- Verifies items re-render

**AC3**: Playwright test selects "Hidden Gems" sort option
- Opens sort dropdown
- Clicks "Hidden Gems" option
- Verifies network request includes `sort=hiddenGems`
- Verifies items re-render

**AC4**: Verify item ordering after sort
- With seeded data, verify items appear in expected order for each sort mode
- Best Value: lowest price/piece ratio first
- Expiring Soon: oldest release date first
- Hidden Gems: highest (5-priority)*pieceCount score first

**AC5**: No console errors during sort changes
- Monitor browser console during all sort interactions
- Assert zero console.error calls

**AC6**: Keyboard accessibility in browser
- Tab to sort dropdown
- Open with Enter/Space
- Navigate options with arrow keys
- Select with Enter
- Focus returns to trigger after selection

**AC7**: Screenshot evidence captured
- Screenshot after each sort mode selection
- Network HAR captured for API verification

**AC8**: Test runs in CI
- Playwright config includes smart-sorting spec
- Test passes in headless mode

## Reuse Plan

### Existing Infrastructure
- Playwright test setup from `apps/web/playwright/`
- Existing wishlist page object or helpers (if any from WISH-2001 E2E tests)
- Test authentication helpers (sign in flow)

### Existing Patterns
- Follow Gherkin/Cucumber BDD format if used in other Playwright tests
- Use `page.waitForResponse` for API call verification
- Use `page.screenshot` for evidence capture

## Implementation Notes

### Test Structure

```typescript
// apps/web/playwright/wishlist/smart-sorting.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Smart Sorting', () => {
  test.beforeEach(async ({ page }) => {
    // Sign in and navigate to wishlist page
    // Ensure seeded data exists
  })

  test('Best Value sort orders items by price-per-piece ratio', async ({ page }) => {
    // Open sort dropdown
    // Select "Best Value"
    // Wait for API response with sort=bestValue
    // Verify item order
    // Screenshot
  })

  // ... similar for Expiring Soon and Hidden Gems
})
```

### Test Data Requirements

Need wishlist items with varied attributes to verify sort order:
- Item A: price=50, pieceCount=500 (ratio: 0.10)
- Item B: price=100, pieceCount=200 (ratio: 0.50)
- Item C: price=200, pieceCount=2000 (ratio: 0.10)

Can seed via API calls in beforeEach or use existing test seed data.

## Risks & Mitigations

1. **Radix UI Select interaction** - Radix renders Select options in a portal. Mitigation: use `page.getByRole('option')` after opening dropdown.
2. **Test data dependency** - Sort verification needs predictable data. Mitigation: seed specific items in beforeEach, clean up in afterEach.
3. **Flaky network timing** - API calls may vary in timing. Mitigation: use `page.waitForResponse` with URL pattern matching.

## Definition of Done

- [ ] Playwright E2E test file created
- [ ] All 3 smart sort modes tested (Best Value, Expiring Soon, Hidden Gems)
- [ ] Item ordering verified with seeded data
- [ ] No console errors during sort interactions
- [ ] Keyboard accessibility tested in browser
- [ ] Screenshots captured as evidence
- [ ] Test passes in headless CI mode
- [ ] Test passes in local Playwright runner
