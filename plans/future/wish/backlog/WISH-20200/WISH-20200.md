---
doc_type: story
title: "WISH-20200: Automated Rollback Script Generation"
story_id: WISH-20200
story_prefix: WISH
status: pending
phase: 2
created_at: "2026-01-29T18:15:00-07:00"
updated_at: "2026-01-29T18:15:00-07:00"
depends_on: [WISH-2057]
follow_up_from: WISH-2057
estimated_points: 3
---

# WISH-20200: Automated Rollback Script Generation

## Follow-up Context

**Parent Story:** WISH-2057
**Source:** QA Discovery Notes (Follow-up Stories Suggested - Finding #3)
**Original Finding:** "Automated rollback script generation based on migration metadata"
**Category:** Enhancement Opportunity
**Impact:** High
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-2057 as an enhancement to the schema evolution policy framework. By automating rollback script generation from migration metadata, we reduce manual error risks, improve incident response time, and ensure consistent rollback procedures across all environments.

## Context

WISH-2057 establishes comprehensive schema evolution policies and versioning strategies, including documentation of which migrations can be safely rolled back. However, the rollback process itself remains manual - developers must write SQL rollback scripts by hand, which is error-prone and time-consuming during production incidents.

This story builds on the `schema_versions` metadata table and rollback safety classifications from WISH-2057 to automate the generation of safe rollback scripts. When a migration is applied, the system analyzes the migration SQL and generates a corresponding rollback script (if safe), storing it in the metadata table for instant retrieval during incidents.

## Goal

Automate the generation of rollback scripts from migration metadata to reduce manual error risks, improve incident response time, and ensure consistent rollback procedures across all environments.

## Non-goals

- Supporting rollback of unsafe migrations (those that drop data or modify types) - these require manual intervention
- Implementing automated rollback execution in production (requires approval workflow)
- Creating rollback scripts for migrations applied before this tooling exists (future migration required)
- Generating rollback scripts for complex data migrations (scope limited to schema-only changes)

## Scope

### Implementation Deliverables

1. **Rollback Script Generator** (`packages/backend/database-schema/src/rollback/generator.ts`)
   - Parses migration SQL using PostgreSQL AST parser
   - Generates inverse SQL for supported operations (ADD COLUMN → DROP COLUMN, etc.)
   - Classifies migration safety (`rollback_safe` boolean)
   - Stores generated scripts in `schema_versions.rollback_script` column

2. **Rollback CLI Command** (`packages/backend/database-schema/src/cli/rollback.ts`)
   - `pnpm db:rollback --version=X.Y.Z` - Preview rollback script for specific version
   - `pnpm db:rollback --version=X.Y.Z --execute` - Execute rollback (requires confirmation)
   - Validates rollback safety before execution
   - Logs rollback events to `schema_versions` table

3. **Database Schema Updates** (`packages/backend/database-schema/src/migrations/`)
   - Add `rollback_script` column (TEXT, nullable) to `schema_versions` table
   - Migration to backfill rollback scripts for existing migrations (if possible)

4. **Integration with Drizzle Migration Flow**
   - Hook into `drizzle-kit push` or custom migration wrapper
   - Automatically generate and store rollback scripts on migration apply
   - Log warnings for unsafe migrations (cannot auto-generate rollback)

### Packages Affected

- `packages/backend/database-schema/` - Rollback generator, CLI command, schema updates
- `packages/backend/database-schema/src/rollback/` - New directory for rollback tooling
- `packages/backend/database-schema/src/cli/` - New CLI commands

### Cross-References

- WISH-2057: Parent story documenting schema evolution policies
- WISH-2007: Creates initial `wishlist_items` table and migration patterns
- WISH-2000: Schema design story with enum definitions

## Acceptance Criteria

### Rollback Script Generation (AC 1-6)

- [ ] AC 1: Generator parses migration SQL using PostgreSQL AST parser (e.g., `pgsql-parser` npm package)
- [ ] AC 2: Generator produces inverse SQL for supported operations:
  - `ADD COLUMN` → `DROP COLUMN`
  - `CREATE INDEX` → `DROP INDEX`
  - `ADD CONSTRAINT` → `DROP CONSTRAINT`
  - `ALTER TYPE ... ADD VALUE` → (Warning: unsafe, no rollback script generated)
- [ ] AC 3: Generator stores rollback script in `schema_versions.rollback_script` column
- [ ] AC 4: Generator sets `rollback_safe` boolean based on operation type (follows WISH-2057 definitions)
- [ ] AC 5: Generator logs warnings for unsafe migrations (DROP COLUMN, DROP TABLE, enum modifications)
- [ ] AC 6: Generator handles multi-statement migrations (generates rollback for each reversible statement)

### CLI Command (AC 7-11)

- [ ] AC 7: `pnpm db:rollback --version=X.Y.Z` previews rollback script without executing
- [ ] AC 8: `pnpm db:rollback --version=X.Y.Z --execute` prompts for confirmation before execution
- [ ] AC 9: CLI validates rollback safety - refuses to execute if `rollback_safe=false` unless `--force` flag provided
- [ ] AC 10: CLI logs rollback event to `schema_versions` table with `rollback_applied_at` timestamp
- [ ] AC 11: CLI displays clear error message if rollback script not found for specified version

### Database Schema (AC 12-13)

- [ ] AC 12: Migration adds `rollback_script` column (TEXT, nullable) to `schema_versions` table
- [ ] AC 13: Migration adds `rollback_applied_at` column (TIMESTAMP, nullable) to `schema_versions` table

### Integration (AC 14-16)

- [ ] AC 14: Rollback generator integrates with migration application flow (hook or wrapper)
- [ ] AC 15: Integration automatically generates rollback script when migration is applied
- [ ] AC 16: Integration logs clear warnings to console for unsafe migrations

### Testing (AC 17-20)

- [ ] AC 17: Unit tests verify correct inverse SQL generation for all supported operations
- [ ] AC 18: Integration tests verify rollback script storage in `schema_versions` table
- [ ] AC 19: Integration tests verify CLI command execution with confirmation prompts
- [ ] AC 20: Edge case tests verify handling of unsafe migrations (no rollback script, clear warnings)

## Reuse Plan

### Existing Patterns

- **Drizzle Migration System**: Extend existing `drizzle.config.ts` and migration flow from `packages/backend/database-schema`
- **Schema Versions Table**: Build on `schema_versions` table design from WISH-2057
- **Migration Naming**: Follow established convention from migrations 0000-0007
- **Rollback Safety Classification**: Reuse breaking/non-breaking definitions from WISH-2057 policy documentation

### Industry Tools & Libraries

- **pgsql-parser**: PostgreSQL SQL parser for Node.js (AST generation from SQL)
- **pg-format**: Safe SQL string formatting for generated rollback scripts
- **inquirer**: Interactive CLI prompts for confirmation dialogs

### Similar Projects

- **Rails Active Record Migrations**: Study up/down migration patterns
- **Flyway**: Reference rollback script generation strategies
- **Liquibase**: Study rollback metadata storage approaches

## Architecture Notes

### Supported Migration Operations

**Reversible (safe rollback):**
```sql
-- Migration
ALTER TABLE wishlist_items ADD COLUMN notes TEXT;

-- Generated Rollback
ALTER TABLE wishlist_items DROP COLUMN notes;
```

**Irreversible (unsafe rollback):**
```sql
-- Migration
ALTER TABLE wishlist_items DROP COLUMN legacy_field;

-- Generated Rollback: None (data loss risk)
-- Warning: "Cannot auto-generate rollback for DROP COLUMN (data loss)"
```

**Enum Operations (special handling):**
```sql
-- Migration
ALTER TYPE wishlist_store ADD VALUE 'Amazon';

-- Generated Rollback: None (PostgreSQL limitation)
-- Warning: "Cannot rollback enum value addition (PostgreSQL limitation)"
```

### Rollback Script Storage

Extend `schema_versions` table from WISH-2057:

```sql
CREATE TABLE schema_versions (
  id SERIAL PRIMARY KEY,
  version TEXT NOT NULL,
  migration_file TEXT NOT NULL,
  applied_at TIMESTAMP NOT NULL DEFAULT now(),
  applied_by TEXT,
  description TEXT,
  rollback_safe BOOLEAN DEFAULT false,
  rollback_script TEXT,              -- NEW: Generated rollback SQL
  rollback_applied_at TIMESTAMP      -- NEW: Rollback execution timestamp
);
```

### CLI Command Flow

```bash
# Preview rollback script
$ pnpm db:rollback --version=1.2.0
> Rollback script for version 1.2.0:
> ALTER TABLE wishlist_items DROP COLUMN notes;
>
> This rollback is marked as SAFE.
> To execute, run: pnpm db:rollback --version=1.2.0 --execute

# Execute rollback
$ pnpm db:rollback --version=1.2.0 --execute
> Rollback script for version 1.2.0:
> ALTER TABLE wishlist_items DROP COLUMN notes;
>
> Are you sure you want to execute this rollback? (yes/no): yes
> Executing rollback...
> ✓ Rollback completed successfully
```

### Safety Validations

CLI must enforce:
1. Rollback script exists in metadata (`rollback_script IS NOT NULL`)
2. Migration is marked as safe (`rollback_safe = true`) unless `--force` provided
3. User confirmation before execution (prevent accidental rollbacks)
4. Database connection validates before execution

## Infrastructure Notes

### Migration Integration Hooks

**Option 1: Wrapper Script (Recommended for MVP)**
```bash
# Custom wrapper around drizzle-kit push
pnpm db:migrate:apply --generate-rollback
```

**Option 2: Drizzle Plugin (Future Enhancement)**
- Requires Drizzle plugin API support
- Deferred to post-MVP

**Option 3: Post-Migration Hook**
- Analyze applied migration from `_journal.json`
- Generate rollback script after successful application

### PostgreSQL Parser Selection

**Evaluated Libraries:**
- `pgsql-parser` (14k weekly downloads, PostgreSQL 13 support) - **Recommended**
- `node-sql-parser` (supports multiple SQL dialects, less PostgreSQL-specific)
- `pg-query-native` (native bindings, faster but requires compilation)

**Decision**: Use `pgsql-parser` for MVP (pure JavaScript, easy to install, good PostgreSQL support).

## Test Plan

### Happy Path Tests

**Test 1: Generate Rollback for ADD COLUMN**
- Create migration: `ALTER TABLE wishlist_items ADD COLUMN test_field TEXT;`
- Apply migration with rollback generation
- Verify `rollback_script` contains `DROP COLUMN test_field`
- Verify `rollback_safe = true`
- Preview rollback script with CLI
- Execute rollback with `--execute` flag
- Verify column removed

**Test 2: Generate Rollback for CREATE INDEX**
- Create migration: `CREATE INDEX idx_test ON wishlist_items(user_id);`
- Apply migration with rollback generation
- Verify `rollback_script` contains `DROP INDEX idx_test`
- Execute rollback
- Verify index removed

**Test 3: CLI Confirmation Prompt**
- Run `pnpm db:rollback --version=X.Y.Z --execute`
- Respond "no" to confirmation prompt
- Verify rollback NOT executed
- Verify `rollback_applied_at` remains NULL

### Error Cases

**Test 4: Unsafe Migration Warning**
- Create migration: `ALTER TABLE wishlist_items DROP COLUMN legacy_field;`
- Apply migration with rollback generation
- Verify warning logged: "Cannot auto-generate rollback for DROP COLUMN (data loss)"
- Verify `rollback_script IS NULL`
- Verify `rollback_safe = false`
- Attempt rollback with CLI
- Verify CLI refuses unless `--force` flag provided

**Test 5: Enum Value Addition (Irreversible)**
- Create migration: `ALTER TYPE wishlist_store ADD VALUE 'NewStore';`
- Apply migration with rollback generation
- Verify warning logged: "Cannot rollback enum value addition (PostgreSQL limitation)"
- Verify `rollback_script IS NULL`
- Verify `rollback_safe = false`

**Test 6: Missing Rollback Script**
- Attempt rollback for version without rollback script
- Verify CLI error message: "No rollback script found for version X.Y.Z"
- Verify no database changes made

### Edge Cases

**Edge 1: Multi-Statement Migration**
- Create migration with 3 statements:
  - `ADD COLUMN field1 TEXT;`
  - `CREATE INDEX idx1 ON wishlist_items(field1);`
  - `DROP COLUMN legacy_field;` (unsafe)
- Verify rollback script contains only reversible operations:
  - `DROP INDEX idx1;`
  - `DROP COLUMN field1;`
- Verify `rollback_safe = false` (due to unsafe statement)
- Verify warning logged for unsafe statement

**Edge 2: Already Rolled Back Migration**
- Execute rollback for version X.Y.Z
- Verify `rollback_applied_at` timestamp set
- Attempt rollback again for same version
- Verify CLI warning: "Migration X.Y.Z has already been rolled back"

**Edge 3: Complex Data Migration (Out of Scope)**
- Create migration with data transformation: `UPDATE wishlist_items SET ...;`
- Verify warning logged: "Cannot auto-generate rollback for data migrations"
- Verify `rollback_safe = false`

## Risk Notes

### MVP-Critical Risks

**Risk 1: Incorrect Rollback Script Generation**
- Generated rollback script may not correctly reverse migration
- **Mitigation**: Comprehensive unit tests for all supported operations, integration tests verify actual database state after rollback

**Risk 2: Accidental Rollback Execution**
- Developer runs `--execute` flag without understanding consequences
- **Mitigation**: Confirmation prompt required, clear preview before execution, safety validations

**Risk 3: Enum Rollback Expectations**
- Developers may expect enum additions to be reversible
- **Mitigation**: Clear warnings in CLI output, documentation references WISH-2057 policy

### Non-MVP Risks

**Risk 4: Parser Incompatibility**
- `pgsql-parser` may not support all PostgreSQL SQL syntax variations
- **Mitigation**: Start with simple operations (ADD/DROP COLUMN, CREATE/DROP INDEX), expand support incrementally

**Risk 5: Rollback Script Storage Size**
- Very large migrations may produce large rollback scripts (column storage limit)
- **Mitigation**: TEXT column supports up to 1GB, sufficient for schema-only migrations

## Definition of Done

- [ ] All 20 Acceptance Criteria verified
- [ ] Rollback generator implemented with unit tests (AC 1-6)
- [ ] CLI command implemented with integration tests (AC 7-11)
- [ ] Database schema migration applied (AC 12-13)
- [ ] Integration with migration flow complete (AC 14-16)
- [ ] Test Plan executed: 6 happy path + error + edge case tests
- [ ] Documentation updated in `packages/backend/database-schema/README.md`
- [ ] Code review completed
- [ ] Manual testing: Apply migration, generate rollback, execute rollback
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~4k | — | — | Follow-up generation from WISH-2057 |
| Implementation | ~12k | — | — | Parser integration + CLI + tests |
| Review | ~3k | — | — | Code review + testing |
| **Total** | ~19k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-29 18:15 | pm-story-followup-leader | Created follow-up story from WISH-2057 finding #3 (Follow-up Stories Suggested) | WISH-20200.md |

---

## Future Enhancement Notes

Once automated rollback script generation exists, consider:
- Rollback preview in CI/CD pipeline (show what would be rolled back)
- Rollback testing in CI (apply migration, rollback, verify clean state)
- Multi-step rollback coordination (rollback multiple migrations in order)
- Rollback script versioning (track changes to rollback logic over time)

---

## Open Questions

- **Q1**: Should rollback CLI integrate with existing `pnpm db:*` commands or create separate namespace?
  - **Proposed**: Use `pnpm db:rollback` to maintain consistency with `pnpm db:migrate`, `pnpm db:push`

- **Q2**: Should rollback script generation be enabled by default or require opt-in flag?
  - **Proposed**: Enable by default for all migrations, log warnings for unsafe operations

- **Q3**: How should we handle rollback of migrations that partially succeeded?
  - **Proposed**: Out of scope for MVP - require manual intervention for partial failures
