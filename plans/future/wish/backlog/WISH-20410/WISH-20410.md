---
status: pending
follow_up_from: WISH-20210
depends_on: WISH-20210
---

# WISH-20410: Visual Dependency Graph UI for Schema Impact Analysis

## Follow-up Context

**Parent Story:** WISH-20210
**Source:** QA Discovery Notes - Follow-up Stories Suggested (Finding #2)
**Original Finding:** "Add visual dependency graph UI showing table → service → endpoint relationships"
**Category:** Enhancement Opportunity
**Impact:** Medium
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-20210 (Schema Change Impact Analysis Tool) as an enhancement to visualize the dependency relationships discovered by the CLI tool. While the CLI tool provides text-based impact reports, a visual graph would help developers quickly understand complex dependency chains and identify indirect impacts.

## Context

WISH-20210 delivers a CLI tool (`pnpm db:impact-analysis`) that analyzes schema changes and generates text-based impact reports. These reports identify affected files across the monorepo (services, repositories, components, Zod schemas, API hooks, tests), but understanding the **relationships** between these components requires careful reading and mental modeling.

In complex scenarios, a database table change can cascade through multiple layers:
- **Direct dependencies**: Services that query the table
- **Indirect dependencies**: Endpoints that use those services
- **Transitive dependencies**: Frontend components that call those endpoints

Example chain for `wishlist_items.priority` column addition:
```
wishlist_items (table)
  ↓
wishlist-repository.ts (queries table)
  ↓
wishlist-service.ts (uses repository)
  ↓
GET /api/wishlist (uses service)
  ↓
WishlistCard.tsx (calls endpoint)
```

A **visual dependency graph** would make these relationships immediately clear, enabling developers to:
1. Identify the full impact scope at a glance
2. Understand which components are directly vs indirectly affected
3. Prioritize update order (database → repository → service → endpoint → frontend)
4. Communicate impact to stakeholders without technical jargon

This enhancement builds on WISH-20210's analysis engine by adding an **interactive visualization layer** to the existing impact reports.

## Goal

Add an interactive visual dependency graph to the Schema Change Impact Analysis Tool that displays table → service → endpoint → component relationships as a hierarchical graph, enabling developers to quickly understand multi-layer impacts from schema changes.

## Non-goals

- Real-time graph updates (static graph generated at analysis time)
- Interactive graph editing or manipulation (read-only visualization)
- Multi-table dependency analysis (single table focus for MVP)
- Export to external graph formats (PNG/SVG only)
- Historical impact comparison (single analysis snapshot only)
- Integration with external visualization tools (self-contained HTML output)

## Scope

### Visual Graph Output Format

Extend `pnpm db:impact-analysis` with `--graph` flag:

```bash
# Generate impact report with visual dependency graph
pnpm db:impact-analysis --table wishlist_items --change "add-column:priority:text" --graph

# Output:
# 1. Markdown report: impact-reports/{timestamp}-wishlist_items-add-column-priority.md
# 2. HTML graph: impact-reports/{timestamp}-wishlist_items-add-column-priority-graph.html
```

### Graph Structure

**Hierarchical Layout:**

```
[wishlist_items] (Database Table - root node)
    |
    +-- [wishlist-repository.ts] (Adapter Layer)
    |       |
    |       +-- [wishlist-service.ts] (Application Layer)
    |               |
    |               +-- [GET /api/wishlist] (API Route)
    |               |       |
    |               |       +-- [WishlistCard.tsx] (Frontend Component)
    |               |       +-- [MainPage.tsx] (Frontend Page)
    |               |
    |               +-- [POST /api/wishlist] (API Route)
    |                       |
    |                       +-- [WishlistForm.tsx] (Frontend Component)
    |
    +-- [WishlistItemSchema] (Zod Schema - packages/core/api-client)
            |
            +-- [wishlist-gallery-api.ts] (RTK Query Hooks)
                    |
                    +-- [WishlistCard.tsx] (Frontend Component - type dependency)
```

**Node Types:**
- **Database Table** (root): Cyan, bold border
- **Repository/Adapter**: Blue
- **Service/Application Logic**: Green
- **API Routes/Endpoints**: Orange
- **Zod Schemas**: Purple
- **Frontend Components**: Pink
- **Test Files**: Gray (optional, toggled off by default)

**Edge Types:**
- **Direct Query Dependency** (solid line): Repository → Table
- **Service Dependency** (solid line): Service → Repository
- **Endpoint Dependency** (solid line): Route → Service
- **Component Dependency** (solid line): Component → Endpoint
- **Type Dependency** (dashed line): Component → Zod Schema

### Interactive Features

1. **Node Hover**: Display file path tooltip
2. **Click Node**: Highlight all downstream dependencies
3. **Toggle Test Files**: Show/hide test file nodes
4. **Layer Filtering**: Show only specific layers (Backend/Frontend/Schemas)
5. **Zoom/Pan**: Navigate large graphs with many dependencies

### Technical Implementation

**Graph Rendering Library:**
- Use **vis-network** or **D3.js** for interactive graph visualization
- Generate self-contained HTML file with embedded JavaScript/CSS (no external dependencies)
- Fallback to static SVG for CI/non-interactive environments

**Data Pipeline:**
1. Extend WISH-20210's AST analysis to capture **dependency relationships** (not just affected files)
2. Build dependency graph data structure during codebase scan
3. Serialize graph as JSON (nodes + edges)
4. Render JSON to interactive HTML using graph library
5. Optionally render static SVG for embedding in Markdown reports

**Example Graph Data Structure:**
```typescript
interface DependencyGraph {
  nodes: Array<{
    id: string                    // File path
    label: string                 // File name
    type: 'table' | 'repository' | 'service' | 'route' | 'component' | 'schema' | 'test'
    layer: 'database' | 'backend' | 'shared' | 'frontend'
    impacted: boolean             // True if file requires updates
  }>
  edges: Array<{
    from: string                  // Source node ID
    to: string                    // Target node ID
    type: 'query' | 'service-call' | 'endpoint-call' | 'type-import'
    label?: string                // Optional edge label (e.g., "queries wishlist_items")
  }>
}
```

### Output Files

For each analysis run with `--graph` flag:

1. **Markdown Report** (unchanged from WISH-20210):
   - `impact-reports/{timestamp}-{table}-{operation}.md`
   - Text-based impact summary

2. **Interactive HTML Graph** (new):
   - `impact-reports/{timestamp}-{table}-{operation}-graph.html`
   - Self-contained HTML with embedded JavaScript
   - Opens in browser for interactive exploration

3. **Static SVG Graph** (optional):
   - `impact-reports/{timestamp}-{table}-{operation}-graph.svg`
   - Embeddable in PRs, documentation, Confluence

### Packages Affected

- `packages/backend/database-schema/scripts/impact-analysis.ts` - Extend CLI with `--graph` flag
- `packages/backend/database-schema/src/analysis/` - New `graph-builder.ts` module for dependency graph construction
- `packages/backend/database-schema/src/renderers/` - New `graph-renderer.ts` module for HTML/SVG generation
- `packages/backend/database-schema/package.json` - Add vis-network or D3.js dependency

## Acceptance Criteria

### CLI Integration (AC 1-3)

- [ ] AC 1: `pnpm db:impact-analysis --graph` flag generates both Markdown report and HTML graph
- [ ] AC 2: HTML graph file is self-contained (no external CDN dependencies)
- [ ] AC 3: Tool supports `--graph-format` flag with options: `html`, `svg`, `both` (default: `html`)

### Graph Structure (AC 4-7)

- [ ] AC 4: Graph displays hierarchical layout with database table as root node
- [ ] AC 5: Graph uses distinct node colors for each layer (Database, Backend, Shared, Frontend, Tests)
- [ ] AC 6: Graph displays solid lines for direct dependencies, dashed lines for type dependencies
- [ ] AC 7: Graph labels nodes with file names (hover shows full file path)

### Interactive Features (AC 8-11)

- [ ] AC 8: Clicking a node highlights all downstream dependencies (transitive closure)
- [ ] AC 9: Hovering over node displays tooltip with file path and impact status (requires update: yes/no)
- [ ] AC 10: Graph includes toggle button to show/hide test file nodes
- [ ] AC 11: Graph supports zoom (mouse wheel) and pan (drag) for large graphs (>20 nodes)

### Dependency Analysis (AC 12-14)

- [ ] AC 12: Graph correctly identifies repository → service → endpoint → component dependency chains
- [ ] AC 13: Graph displays Zod schema type dependencies as dashed edges to frontend components
- [ ] AC 14: Graph marks nodes requiring updates (based on schema change type) with bold borders

### Output Quality (AC 15-17)

- [ ] AC 15: HTML graph opens in browser and renders without errors
- [ ] AC 16: SVG graph (if generated) is valid SVG and embeddable in Markdown
- [ ] AC 17: Graph legend displays node type colors and edge type meanings

### Test Coverage (AC 18-20)

- [ ] AC 18: Unit tests validate graph data structure construction (nodes + edges) from mock dependency analysis
- [ ] AC 19: Integration test generates HTML graph for hypothetical `wishlist_items.priority` column addition
- [ ] AC 20: E2E test opens generated HTML graph in headless browser and validates DOM structure

### Documentation (AC 21-22)

- [ ] AC 21: `IMPACT-ANALYSIS-TOOL.md` updated with `--graph` flag usage examples and screenshots
- [ ] AC 22: Documentation includes interpretation guide for graph node types and edge types

## Reuse Plan

### From WISH-20210 (Parent Story)

- **Dependency Analysis Engine**: Reuse AST-based codebase scanning and file categorization logic
- **Impact Report Data**: Extend existing impact report JSON with graph relationship data
- **CLI Scaffolding**: Build on existing `pnpm db:impact-analysis` command structure
- **Test Infrastructure**: Reuse mock codebase fixtures from WISH-20210 unit tests

### External Libraries

- **vis-network** (preferred): Lightweight, easy hierarchical layouts, good interactivity
  - Alternative: **D3.js** (more powerful but steeper learning curve)
- **svg-builder** (for static SVG generation): Headless rendering without browser

### Existing Patterns

- **HTML Report Generation**: Reuse patterns from existing Playwright HTML reports (if available in monorepo)
- **Self-contained Output**: Follow pattern of embedding CSS/JS in single HTML file (no external CDN dependencies)

## Architecture Notes

### Graph Builder Module

```typescript
// packages/backend/database-schema/src/analysis/graph-builder.ts

interface GraphBuilder {
  addNode(file: string, type: NodeType, layer: Layer, impacted: boolean): void
  addEdge(from: string, to: string, type: EdgeType): void
  build(): DependencyGraph
}

// Usage in impact-analysis.ts:
const graphBuilder = new GraphBuilder()
graphBuilder.addNode('wishlist_items', 'table', 'database', true)
graphBuilder.addNode('wishlist-repository.ts', 'repository', 'backend', true)
graphBuilder.addEdge('wishlist-repository.ts', 'wishlist_items', 'query')
const graph = graphBuilder.build()
```

### Graph Renderer Module

```typescript
// packages/backend/database-schema/src/renderers/graph-renderer.ts

interface GraphRenderer {
  renderHTML(graph: DependencyGraph, outputPath: string): Promise<void>
  renderSVG(graph: DependencyGraph, outputPath: string): Promise<void>
}

// Rendering pipeline:
// 1. Convert DependencyGraph to vis-network format
// 2. Generate HTML template with embedded vis-network library
// 3. Inject graph data as JSON
// 4. Write self-contained HTML file
```

### Dependency Discovery Enhancement

Extend WISH-20210's AST analysis to track **relationships**:

```typescript
// Current WISH-20210 behavior: Identify affected files
const affectedFiles = ['wishlist-repository.ts', 'wishlist-service.ts', ...]

// Enhanced behavior for WISH-20410: Track dependencies
const dependencies = [
  { from: 'wishlist-repository.ts', to: 'wishlist_items', type: 'query' },
  { from: 'wishlist-service.ts', to: 'wishlist-repository.ts', type: 'service-call' },
  { from: 'GET /api/wishlist', to: 'wishlist-service.ts', type: 'service-call' },
  { from: 'WishlistCard.tsx', to: 'GET /api/wishlist', type: 'endpoint-call' },
  { from: 'WishlistCard.tsx', to: 'WishlistItemSchema', type: 'type-import' },
]
```

**Implementation Strategy:**
1. During AST scan, track not just "file references table" but "file A imports/calls file B"
2. Build bidirectional dependency map
3. Perform graph traversal to identify transitive closures

## Test Plan

### Unit Tests

**Test 1: Graph Data Structure Construction**
- Input: Mock dependency analysis with 5 files (table → repository → service → endpoint → component)
- Run graph builder
- Assert graph has 5 nodes and 4 edges with correct types

**Test 2: Hierarchical Layout Data**
- Input: Graph with 3 layers (backend, shared, frontend)
- Generate graph data
- Assert nodes have correct `layer` metadata for rendering

**Test 3: Impact Marking**
- Input: Graph with 10 nodes, 5 requiring updates (based on schema change)
- Build graph with impact flags
- Assert `impacted: true` on correct nodes

### Integration Tests

**Test 4: HTML Graph Generation**
- Run `pnpm db:impact-analysis --table wishlist_items --change "add-column:priority:text" --graph`
- Assert HTML file created in `impact-reports/`
- Validate HTML file contains vis-network library and graph JSON

**Test 5: SVG Graph Generation**
- Run with `--graph-format svg`
- Assert SVG file created
- Validate SVG structure (nodes, edges, labels)

**Test 6: Graph Toggle Features**
- Generate HTML graph with test files
- Parse HTML and verify toggle button exists in DOM
- Simulate toggle and verify test nodes can be hidden/shown (if headless browser testing is feasible)

### Edge Cases

**Edge 1: Single-Node Graph (No Dependencies)**
- Table with no code references (orphaned table)
- Assert graph renders single root node with no edges

**Edge 2: Large Graph (>50 nodes)**
- Mock codebase with 50+ affected files
- Assert graph renders without performance issues
- Verify zoom/pan controls work

**Edge 3: Circular Dependencies (Rare)**
- Mock scenario where Service A → Service B → Service A (circular import)
- Assert graph renderer handles cycles gracefully (no infinite loop)

## Risk Notes

### MVP-Critical Risks

**Risk 1: Graph Rendering Performance**
- Large monorepos may produce graphs with 100+ nodes
- **Mitigation**: Use vis-network's built-in performance optimizations; add `--max-depth` flag to limit graph depth

**Risk 2: Dependency Relationship Accuracy**
- AST analysis may miss dynamic imports or conditional dependencies
- **Mitigation**: Document known limitations; focus on static imports for MVP

**Risk 3: Self-Contained HTML File Size**
- Embedding vis-network library increases HTML file size (~200KB)
- **Mitigation**: Acceptable for local reports; use external CDN option for future CI integration

### Non-MVP Risks

**Risk 4: Cross-Browser Compatibility**
- HTML graph may not render identically in all browsers
- **Mitigation**: Test in Chrome/Firefox/Safari; document minimum browser versions

**Risk 5: SVG Export Complexity**
- Headless rendering for SVG may require additional dependencies (Puppeteer)
- **Mitigation**: Defer SVG export to Phase 2 if complexity is too high; prioritize HTML output

## Definition of Done

- [ ] All 22 Acceptance Criteria verified
- [ ] `pnpm db:impact-analysis --graph` generates interactive HTML dependency graph
- [ ] Graph displays hierarchical layout with correct node types and colors
- [ ] Interactive features functional (hover tooltips, click to highlight, toggle tests, zoom/pan)
- [ ] Unit tests pass (graph builder, impact marking, layout generation)
- [ ] Integration test validates HTML graph for `wishlist_items.priority` addition scenario
- [ ] Documentation updated in `IMPACT-ANALYSIS-TOOL.md` with graph usage examples
- [ ] Sample HTML graph reviewed for usability and accuracy
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~4k | — | — | Follow-up generation with graph scope |
| Implementation | ~12k | — | — | Graph builder + HTML renderer + CLI integration |
| Testing | ~6k | — | — | Unit + integration tests |
| Review | ~3k | — | — | Code review + usability review |
| **Total** | ~25k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-31 (generated) | pm-story-followup-leader | Created follow-up story from WISH-20210 finding #2 (Visual dependency graph UI) | WISH-20410.md |

---

## Future Enhancement Notes

Once this visual graph exists, consider:
- **Real-time Graph Updates**: Auto-refresh graph as codebase changes
- **Interactive Graph Editing**: Allow developers to mark false positives and exclude from report
- **Multi-Table Analysis**: Display dependencies across multiple related tables
- **Export Formats**: Support export to Graphviz DOT, JSON, or other graph formats
- **CI Integration**: Automatically attach graph to schema change PRs as comment
- **Historical Comparison**: Show "before vs after" graphs for refactoring impact
- **Dependency Metrics**: Calculate and display metrics (coupling, fan-in, fan-out)

---

## Open Questions

None blocking. All implementation details deferred to development phase.
