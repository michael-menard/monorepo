---
doc_type: story
title: "WISH-2125: IP/Geolocation Logging for Authorization Events"
story_id: WISH-2125
story_prefix: WISH
status: deferred
deferral_reason: "Not MVP - observability enhancement, defer to post-launch"
phase: 5
created_at: "2026-01-29T00:00:00-07:00"
updated_at: "2026-01-29T14:35:00-07:00"
depends_on: [WISH-2008]
follow_up_from: WISH-2008
priority: P2
estimated_points: 2
sizing_warning: false
---

# WISH-2125: IP/Geolocation Logging for Authorization Events - Phase 5 Observability

## Follow-up Context

**Parent Story:** WISH-2008
**Source:** QA Discovery Notes - Enhancement Opportunities
**Original Finding:** IP/geolocation logging for suspicious access patterns - Log IP address and country for 403/404 events to detect suspicious access patterns
**Category:** Enhancement Opportunity
**Impact:** Medium (Security observability improvement)
**Effort:** Medium (IP extraction + geolocation lookup + log enrichment)

## Context

WISH-2008 implemented comprehensive authorization testing and audit logging for 403/404 authorization failure events. However, the current audit logs lack contextual information about the source of unauthorized access attempts, limiting security analysis capabilities.

**Current State (WISH-2008):**
- Authorization failures logged with userId, itemId, endpoint, HTTP method, timestamp
- Structured CloudWatch logs enable basic security auditing
- No IP address or geographic information captured

**Gap Identified:**
Without IP address and geolocation data, security teams cannot:
- Detect suspicious access patterns from specific geographic regions
- Identify potential credential compromise (e.g., rapid access from different countries)
- Correlate authorization failures with known malicious IP ranges
- Investigate security incidents with geographic context
- Detect brute-force attacks from distributed sources

This follow-up story enriches authorization failure logs with IP address and geolocation data to enable detection of suspicious access patterns and geographic anomalies.

## Goal

Enrich authorization failure audit logs (403/404 events from WISH-2008) with IP address and geolocation data (country, region, city) to enable detection of suspicious access patterns, geographic anomalies, and potential security threats.

## Non-goals

- Real-time IP blocking or rate limiting (already addressed in WISH-2008 AC 24)
- VPN detection or anonymization service identification (deferred to Phase 6 advanced security)
- Historical geolocation data backfill for existing logs (forward-looking only)
- Frontend user-facing geolocation features (backend observability only)
- IP-based session management or tracking (privacy concern, out of scope)
- CloudWatch alarms for geographic anomalies (deferred to separate infrastructure story)
- Custom threat intelligence feeds integration (deferred to Phase 6)

## Scope

### Endpoints Affected

**No new endpoints** - enriches existing authorization logging from WISH-2008:
- All wishlist endpoints (GET, POST, PATCH, DELETE) - log IP/geolocation on 403/404 only
- Rate limiting middleware (AC 24) - reuse IP extraction utility

### Packages Affected

1. **Backend - Observability**: `apps/api/lego-api/core/observability/`
   - `logger.ts` - Enrich authorization failure logs with IP/geolocation fields
   - **Changes:** Add geolocation fields to structured log format (~10 lines)

2. **Backend - Geolocation Service**: `apps/api/lego-api/core/geolocation/` (new)
   - `maxmind-service.ts` - MaxMind GeoIP2 lookup wrapper
   - `types.ts` - Geolocation result types
   - **Changes:** New service (~100 lines)

3. **Backend - Utilities**: `apps/api/lego-api/core/utils/` (new)
   - `ip-extraction.ts` - Extract IP from request headers (X-Forwarded-For, X-Real-IP, socket)
   - **Changes:** New utility (~50 lines)

4. **Backend - Middleware**: `apps/api/lego-api/middleware/`
   - `auth.ts` - Reuse IP extraction utility for authorization failures
   - `rate-limit.ts` - Reuse IP extraction utility (WISH-2008 AC 24 integration)
   - **Changes:** Import shared IP extraction utility (~5 lines per file)

5. **Backend - Wishlist Domain**: `apps/api/lego-api/domains/wishlist/`
   - `repositories.ts` - Pass IP from request context to logger on 403/404
   - `services.ts` - Extract IP from request context
   - **Changes:** Pass IP to logger calls (~10 lines)

6. **Documentation**: `packages/backend/database-schema/docs/`
   - `wishlist-authorization-policy.md` - Add IP/geolocation logging section
   - **Changes:** Update existing doc from WISH-2008 (~50 lines)

### Infrastructure Impact

**Lambda Layer:**
- Add MaxMind GeoLite2 City database (~50 MB) to existing Lambda layer
- Database file: `/opt/geolite2-city.mmdb` (bundled in layer, updated monthly)

**Lambda Memory:**
- Increase Lambda memory allocation: +128 MB for in-memory database caching
- Minimal performance impact (<10ms per lookup with caching)

**Environment Variables:**
- `GEOIP_DATABASE_PATH=/opt/geolite2-city.mmdb` (optional, defaults to embedded layer path)

**No Infrastructure Changes:**
- CloudWatch Logs already configured (WISH-2008)
- No database schema changes required
- No new AWS services required

## Acceptance Criteria

### AC1: IP extraction utility extracts IP from request headers

**Verify:**
- IP extraction utility checks headers in order: `X-Forwarded-For` (first IP), `X-Real-IP`, `socket.remoteAddress`
- X-Forwarded-For parsing handles comma-separated list (takes leftmost/client IP)
- Returns null if no valid IP found

**Evidence:** Unit tests for all header scenarios + localhost handling

---

### AC2: MaxMind geolocation lookup returns country, region, city

**Verify:**
- Geolocation service initializes MaxMind GeoLite2 City database from Lambda layer path
- Lookup returns structured data: country code (ISO), country name, region, city, latitude, longitude
- Returns null for lookup failures (private IPs, invalid IPs, missing data)
- Database loaded into memory on Lambda cold start (cached for warm starts)

**Evidence:** Unit tests with sample IPs + integration test with real database

---

### AC3: Authorization failure logs enriched with IP and geolocation

**Verify:**
- All 403/404 responses from wishlist endpoints include IP and geolocation fields in CloudWatch logs
- Log format includes: `ip`, `country`, `region`, `city`, `latitude`, `longitude` (null if unavailable)
- Logs maintain existing fields from WISH-2008: userId, itemId, endpoint, statusCode, timestamp

**Expected Log Format:**
```json
{
  "level": "warn",
  "message": "Unauthorized wishlist access attempt",
  "userId": "user-a-id",
  "itemId": "456",
  "endpoint": "GET /api/wishlist/456",
  "statusCode": 404,
  "timestamp": "2026-01-29T12:00:00Z",
  "ip": "203.0.113.45",
  "country": "US",
  "countryName": "United States",
  "region": "California",
  "city": "San Francisco",
  "latitude": 37.7749,
  "longitude": -122.4194
}
```

**Evidence:** Integration tests verifying log structure + CloudWatch Logs Insights query

---

### AC4: Privacy-conscious logging - IP/geolocation only for 403/404 events

**Verify:**
- IP/geolocation data ONLY logged for 403/404 authorization failures, not 200/201/204 success responses
- Successful requests (200, 201) do NOT include IP or geolocation fields
- Rate limiting logs (429) MAY include IP for abuse detection (reuse same utility)

**Evidence:** Integration tests asserting log format for 200 vs 404 responses

---

### AC5: CloudWatch Logs Insights query examples for security analysis

**Document:** Add section to `wishlist-authorization-policy.md` with CloudWatch Logs Insights query examples.

**Required Queries:**
1. **Unauthorized access by country**: Group 403/404 events by country
2. **High-frequency access from single IP**: Detect potential brute-force from specific IPs
3. **Geographic anomaly detection**: User ID accessing from multiple countries within short timeframe
4. **Top offending IPs**: Rank IPs by unauthorized access attempt count

**Evidence:** Documentation includes 4+ working CloudWatch Logs Insights queries

---

### AC6: Lambda layer includes MaxMind GeoLite2 City database

**Verify:**
- Lambda layer updated to include `geolite2-city.mmdb` database file (~50 MB)
- Database file accessible at `/opt/geolite2-city.mmdb` in Lambda runtime
- Layer deployment script includes database download and bundling steps
- Database version documented (monthly updates via cron or manual process)

**Evidence:** Lambda layer deployment script + runtime verification test

---

### AC7: Geolocation lookup performance < 10ms with caching

**Verify:**
- Cold start: Database loads into memory on first Lambda invocation
- Warm start: Database cached in memory, lookups < 10ms (p95)
- Minimal impact on overall request latency (<2% increase)

**Evidence:** Performance tests with CloudWatch metrics

---

### AC8: Graceful fallback for geolocation lookup failures

**Verify:**
- If geolocation database unavailable: log IP only, geolocation fields set to null
- If IP extraction fails: log without IP or geolocation fields
- No errors thrown that would prevent authorization logging

**Evidence:** Unit tests simulating database unavailable + integration tests

---

### AC9: Shared IP extraction utility integrated with rate limiting

**Verify:**
- IP extraction utility reused in WISH-2008 AC 24 rate limiting middleware (no duplication)
- Rate limiting middleware uses same IP extraction logic for consistent IP identification
- Both authorization logging and rate limiting use identical IP source prioritization

**Evidence:** Code review confirming shared utility + integration tests

---

### AC10: Documentation updated with IP/geolocation logging section

**Document:** Update `packages/backend/database-schema/docs/wishlist-authorization-policy.md`

**Required Sections:**
- IP Extraction Logic (header prioritization, X-Forwarded-For parsing)
- Geolocation Data Sources (MaxMind GeoLite2 City)
- Privacy Controls (403/404 only, not success responses)
- CloudWatch Logs Insights Query Examples (AC 5)
- Database Update Process (monthly MaxMind database refresh)

**Evidence:** Documentation section added and reviewed

---

### AC11: Integration tests verify IP/geolocation in audit logs

**Test Coverage:**
- Happy path: 404 response includes IP and geolocation
- Missing IP: 404 response without IP (no X-Forwarded-For or X-Real-IP headers)
- Private IP: 404 response with private IP (geolocation null)
- Success response: 200 response does NOT include IP/geolocation

**Minimum:** 4 integration tests

**Evidence:** Integration tests passing in `__http__/wishlist-authorization.http`

---

### AC12: Unit tests for IP extraction and geolocation lookup

**Test Coverage:**
- IP extraction: X-Forwarded-For (single IP, comma-separated list), X-Real-IP, socket.remoteAddress
- IP extraction edge cases: localhost, private IPs, IPv6, malformed headers
- Geolocation lookup: valid public IP, private IP (null result), invalid IP (null result)
- Geolocation lookup: database unavailable (null result, no error thrown)

**Minimum:** 10 unit tests

**Evidence:** Unit tests passing in `apps/api/lego-api/core/geolocation/__tests__/` and `apps/api/lego-api/core/utils/__tests__/`

---

## Reuse Plan

### Existing Components (Extended)
- Logger utility (@repo/logger) - extend with IP/geolocation fields (WISH-2008)
- Authorization middleware - pass IP from request context to logger (WISH-2008)
- Rate limiting middleware - reuse IP extraction utility (WISH-2008 AC 24)
- CloudWatch Logs - existing log infrastructure (WISH-2008)
- Lambda layers - existing layer deployment infrastructure

### New Components
- MaxMind geolocation service - encapsulated adapter for GeoIP2 lookups
- IP extraction utility - shared across authorization logging and rate limiting
- Lambda layer update - MaxMind GeoLite2 City database bundling

### Existing Patterns
- Hexagonal architecture (ports/adapters) - geolocation service is outbound adapter
- Structured logging - extend existing log format from WISH-2008
- Graceful degradation - null values on geolocation failures
- Shared utilities - IP extraction utility reused across middleware

## Architecture Notes (Ports & Adapters)

### Hexagonal Architecture Compliance

**Domain Layer** (Business Logic):
- No changes - authorization logic remains in WISH-2008 middleware

**Adapter Layer** (Infrastructure):
- `maxmind-service.ts` - Geolocation lookup adapter (outbound adapter)
- `ip-extraction.ts` - Request header parsing utility (inbound adapter helper)
- `logger.ts` - Structured logging adapter (outbound adapter, extended from WISH-2008)

**Port Layer** (Contracts):
- `GeolocationService` interface - defines lookup contract
- `GeolocationResult` type - structured geolocation data
- IP extraction remains pure utility (no interface required)

**Separation of Concerns:**
- Geolocation lookup is infrastructure concern (adapter), not business logic
- Authorization decision-making remains unchanged (WISH-2008)
- Logging enrichment is post-authorization concern (observability adapter)

## Infrastructure Notes

### MaxMind GeoLite2 City Database

**Database Source:** MaxMind GeoLite2 City (free, accuracy ~95% for country-level)
**Database Size:** ~50 MB compressed
**Update Frequency:** Monthly (manual or automated via cron)
**License:** Creative Commons Attribution-ShareAlike 4.0 International License

**Lambda Layer Deployment:**
1. Download GeoLite2 City database from MaxMind
2. Bundle database into Lambda layer: `/opt/geolite2-city.mmdb`
3. Deploy layer with existing layer deployment script
4. Update Lambda layer version reference in function configuration

**Cost Impact:**
- Lambda layer storage: +50 MB (~$0.03/month)
- Lambda memory increase: +128 MB (~$2/month for 10k requests)
- MaxMind database: Free (GeoLite2)
- Total incremental cost: ~$2-3/month

### Environment Variables

**New Environment Variable:**
- `GEOIP_DATABASE_PATH=/opt/geolite2-city.mmdb` (optional, defaults to embedded layer path)

**Existing Environment Variables (No Changes):**
- `COGNITO_USER_POOL_ID` - JWT validation (WISH-2008)
- `DATABASE_URL` - PostgreSQL connection (WISH-2008)

## Test Plan

### Backend Unit Tests (10+ Tests)

**IP Extraction Tests:**
1. X-Forwarded-For single IP extraction
2. X-Forwarded-For comma-separated list (leftmost IP)
3. X-Real-IP fallback when X-Forwarded-For absent
4. socket.remoteAddress fallback when all headers absent
5. Localhost IP handling (127.0.0.1)
6. Private IP handling (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
7. IPv6 address extraction
8. Malformed X-Forwarded-For header (null result)

**Geolocation Lookup Tests:**
9. Valid public IP returns country, region, city
10. Private IP returns null geolocation
11. Invalid IP returns null geolocation
12. Database unavailable returns null geolocation without error

**Test Files:**
- `apps/api/lego-api/core/geolocation/__tests__/maxmind-service.test.ts`
- `apps/api/lego-api/core/utils/__tests__/ip-extraction.test.ts`

---

### Backend Integration Tests (4+ Tests)

**HTTP Test File:** `__http__/wishlist-authorization.http` (extends WISH-2008 tests)

**Authorization Failure with IP/Geolocation:**
1. User A attempts GET User B's item → 404 with IP and geolocation logged
2. User A attempts PATCH User B's item → 404 with IP and geolocation logged
3. Unauthenticated request → 401 with IP logged (no geolocation for 401, optional)
4. Success response → 200 without IP/geolocation in logs (privacy)

**Edge Cases:**
5. Missing IP headers → 404 without IP in logs (graceful fallback)
6. Private IP (10.0.0.1) → 404 with IP but null geolocation

---

### Manual QA Testing (Security Focus)

**QA Manual Test Scenarios:**

1. **CloudWatch Logs Verification:**
   - QA performs unauthorized access attempts from known public IP
   - QA reviews CloudWatch logs
   - QA confirms IP, country, region, city fields present in log entries
   - QA verifies geolocation accuracy (country matches expected)

2. **CloudWatch Logs Insights Queries:**
   - QA runs query examples from AC 5 documentation
   - QA verifies queries return expected results (unauthorized access by country, top offending IPs)

3. **Privacy Verification:**
   - QA performs successful API call (200 OK)
   - QA reviews CloudWatch logs
   - QA confirms IP/geolocation fields NOT present in success logs

4. **Lambda Performance:**
   - QA reviews CloudWatch metrics for Lambda execution time
   - QA confirms geolocation lookup adds <10ms latency (p95)

---

## UI/UX Notes

**Verdict:** SKIPPED

**Justification:** WISH-2125 is backend-only (observability and logging enhancement). No UI components or user-facing changes.

**Frontend Impact:** None
- No API response changes (IP/geolocation logged server-side only, not returned in API responses)
- No new UI components required
- No user-facing features

**Future Considerations:**
- Admin security dashboard showing geographic access patterns (Phase 6)
- User account security page showing recent access locations (Phase 6)

## Risks & Mitigations

### MVP-Critical Risks

**Risk 1: MaxMind Database Unavailable**
- **Severity:** Low (degrades to IP-only logging)
- **Likelihood:** Low
- **Mitigation:** Graceful fallback returns null geolocation, logs continue with IP only
- **Verification:** Unit tests simulating database unavailable

**Risk 2: Lambda Memory Increase Cost**
- **Severity:** Low (~$2/month increase)
- **Likelihood:** High
- **Mitigation:** Monitor CloudWatch cost metrics, acceptable for security observability value
- **Verification:** Cost monitoring dashboard (WISH-2008)

**Risk 3: IP Extraction Fails for Proxied Requests**
- **Severity:** Medium (missing IP data for security analysis)
- **Likelihood:** Low (API Gateway always sets X-Forwarded-For)
- **Mitigation:** Fallback to multiple header sources (X-Forwarded-For, X-Real-IP, socket)
- **Verification:** Integration tests with various header combinations

**Risk 4: False Positive Geographic Anomalies**
- **Severity:** Low (VPN/travel false positives)
- **Likelihood:** Medium
- **Mitigation:** Logs for analysis only, no automated blocking (WISH-2008 AC 24 handles rate limiting)
- **Verification:** Documentation clarifies logs are for investigation, not automation

### Non-MVP Risks (Future Work)

- VPN detection for more accurate geographic analysis - deferred to Phase 6
- Historical geolocation data backfill - forward-looking only for MVP
- CloudWatch alarms for geographic anomalies - deferred to separate infrastructure story
- Custom threat intelligence feeds - deferred to Phase 6 advanced security

## Open Questions

None - all decisions finalized during QA Elaboration of WISH-2008.

## Definition of Done

- [ ] All 12 Acceptance Criteria pass
- [ ] Backend: 10+ unit tests pass (IP extraction + geolocation lookup)
- [ ] Backend: 4+ integration tests pass (authorization logs with IP/geolocation)
- [ ] Lambda layer updated with MaxMind GeoLite2 City database (~50 MB)
- [ ] Lambda memory increased by +128 MB for database caching
- [ ] CloudWatch Logs Insights query examples documented
- [ ] Documentation updated (`wishlist-authorization-policy.md`)
- [ ] IP extraction utility reused in rate limiting middleware (WISH-2008 AC 24)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved
- [ ] QA verification complete (manual CloudWatch logs review)

## Follow-up Stories (Future)

### Phase 6 - Advanced Security
- **WISH-XXXX:** VPN/Anonymization Service Detection
- **WISH-XXXX:** CloudWatch Alarms for Geographic Anomalies
- **WISH-XXXX:** Custom Threat Intelligence Feeds Integration
- **WISH-XXXX:** Admin Security Dashboard with Geographic Access Patterns

### Infrastructure
- **WISH-XXXX:** Automated MaxMind Database Update Cron Job
- **WISH-XXXX:** User Account Security Page (Recent Access Locations)

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Generation | ~5k | — | — | PM followup orchestration |
| Implementation | ~10k | — | — | IP extraction + geolocation service + logging |
| Code Review | ~4k | — | — | Security-focused review |
| **Total** | ~19k | — | — | Small-sized story (logging enhancement) |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-29 00:00 | pm-story-followup-leader | Generated follow-up story from WISH-2008 QA Discovery Notes (Finding #1) | WISH-2125.md |
