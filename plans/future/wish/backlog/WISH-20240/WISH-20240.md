---
doc_type: story
title: "WISH-20240: Schedule preview endpoint (simulate flag state before schedule applies)"
story_id: WISH-20240
story_prefix: WISH
status: backlog
phase: 4
created_at: "2026-01-30T00:00:00-07:00"
updated_at: "2026-01-30T00:00:00-07:00"
depends_on: [WISH-2119]
follow_up_from: WISH-2119
estimated_points: 2
sizing_warning: false
---

# WISH-20240: Schedule preview endpoint (simulate flag state before schedule applies)

## Goal

Enable admins to preview the exact flag state that will result from a scheduled update before it executes, reducing configuration errors and improving confidence in scheduled flag changes.

## Feature

Schedule preview endpoint that simulates applying pending schedules to a flag and returns the resulting flag state. Allows admins to verify scheduled changes before they take effect, without modifying the actual flag or schedule records.

## Phase

Phase 4 - Infrastructure Enhancements

## Follow-up Context

- **Parent Story:** WISH-2119
- **Source:** QA Discovery Notes from WISH-2119 Elaboration
- **Original Finding:** "Schedule preview endpoint (simulate flag state before schedule applies) - Deferred to Phase 4+ follow-up story"
- **Category:** Enhancement Opportunity
- **Impact:** Medium (improves admin confidence and reduces configuration errors)
- **Effort:** Low (2 points - read-only simulation logic)

## Context

The flag scheduling system from WISH-2119 allows admins to create scheduled flag updates that execute automatically at predetermined times. However, when multiple schedules exist for the same flag or when schedules update only specific properties (enabled vs rolloutPercentage), it can be difficult for admins to predict the final flag state after all pending schedules execute.

A preview endpoint addresses this gap by simulating the application of pending schedules in chronological order and returning the resulting flag state. This allows admins to:
- Verify that scheduled changes will produce the intended flag state
- Identify overlapping or conflicting schedules before they execute
- Build confidence in complex scheduling scenarios (e.g., enable at 9am, set to 50% at noon, disable at 5pm)

This is a read-only operation that does not modify flags or schedules - it only performs a simulation based on current database state.

## Non-goals

- **Preview with hypothetical schedules** - Endpoint only simulates existing schedules, not "what-if" scenarios
- **Preview for all flags** - Must specify flagKey, not a global preview
- **Preview at arbitrary future times** - Simulates all pending schedules, not schedules up to a specific timestamp
- **Preview with canceled schedules** - Only simulates pending schedules (status = 'pending')
- **Modify flag or schedule state** - Read-only operation
- **Client-side preview logic** - Backend-only implementation (frontend can call endpoint)

## Scope

### Endpoints Affected

**New Endpoint:**
- `GET /api/admin/flags/:flagKey/schedule/preview` - Simulate applying pending schedules (admin only)

**Reused from WISH-2119:**
- Schedule repository for fetching pending schedules
- Auth middleware for admin authorization
- Feature flag service for current flag state retrieval

### Packages Affected

1. **Backend - Config Domain**: `apps/api/lego-api/domains/config/`
   - `application/schedule-service.ts` - Add previewSchedules method (extend existing)
   - `routes.ts` - Add preview endpoint (extend existing)
   - `types.ts` - Add PreviewResponseSchema (extend existing)

2. **Shared Schemas**: `packages/core/api-client/src/schemas/`
   - `feature-flags.ts` - Add SchedulePreviewResponseSchema (extend existing)

### Infrastructure Impact

**No Database Changes** - Endpoint is read-only, uses existing tables (feature_flags, feature_flag_schedules)

**No Cache Impact** - Does not modify flag state or cache, only reads current state

**Request Flow:**
1. Fetch current flag state from database
2. Fetch all pending schedules for flag (status = 'pending', ORDER BY scheduled_at ASC)
3. Simulate applying each schedule's updates in chronological order
4. Return simulated final flag state (no database writes)

## Acceptance Criteria

### Backend - Preview Endpoint

**AC1**: Preview endpoint route and authorization
- Endpoint: `GET /api/admin/flags/:flagKey/schedule/preview`
- Requires admin authentication (reuse auth middleware from WISH-2119)
- Returns 403 Forbidden for non-admin users
- Returns 404 Not Found if flag does not exist
- Response: 200 OK with simulated flag state

**AC2**: Fetch current flag state
- Retrieve current flag state from feature_flags table
- Use flag service from WISH-2009 to fetch flag (reuse existing logic)
- If flag not found, return 404 Not Found with error message

**AC3**: Fetch pending schedules
- Query feature_flag_schedules WHERE flag_id = :flagId AND status = 'pending'
- Order by scheduled_at ASC (chronological order matches WISH-2119 processing)
- Include all pending schedules regardless of scheduled_at time (future and past)

**AC4**: Simulate schedule application
- Start with current flag state as baseline
- Apply each pending schedule's updates in chronological order
- For each schedule:
  - If schedule.updates.enabled is defined, set flag.enabled = schedule.updates.enabled
  - If schedule.updates.rolloutPercentage is defined, set flag.rolloutPercentage = schedule.updates.rolloutPercentage
  - Last schedule wins for each property (matches WISH-2119 behavior)

**AC5**: Preview response format
- Response includes:
  - currentState: Current flag state (enabled, rolloutPercentage)
  - previewedState: Simulated flag state after applying pending schedules
  - pendingSchedules: Array of schedules that were simulated (id, scheduledAt, updates)
  - stateChanged: Boolean indicating if previewedState differs from currentState
- Zod schema: `SchedulePreviewResponseSchema`

**AC6**: Handle no pending schedules
- If no pending schedules exist, return:
  - currentState: Current flag state
  - previewedState: Same as currentState (no changes)
  - pendingSchedules: Empty array
  - stateChanged: false

**AC7**: Partial schedule updates
- If schedule updates only enabled (not rolloutPercentage), preserve current rolloutPercentage
- If schedule updates only rolloutPercentage (not enabled), preserve current enabled
- Simulated state includes both properties, even if only one was updated

### Schema & Types

**AC8**: Zod schema for preview response
- `SchedulePreviewResponseSchema`: API response format
- Fields: currentState, previewedState, pendingSchedules, stateChanged
- currentState/previewedState format: `{ enabled: boolean, rolloutPercentage: number }`
- pendingSchedules format: `{ id: string, scheduledAt: string, updates: { enabled?: boolean, rolloutPercentage?: number } }[]`

**AC9**: Frontend/backend schema alignment
- Backend schema defined in `apps/api/lego-api/domains/config/types.ts`
- Schema re-exported in `packages/core/api-client/src/schemas/feature-flags.ts`
- Frontend imports from `@repo/api-client`
- Alignment test verifies schemas match

### Testing

**AC10**: Backend unit tests (minimum 5 tests)
- Preview with no pending schedules (assert stateChanged = false)
- Preview with single schedule (assert previewedState matches schedule.updates)
- Preview with multiple schedules (assert last schedule wins)
- Preview with partial updates (assert only updated properties change)
- Preview for non-existent flag (assert 404)

**AC11**: Backend integration tests (HTTP file)
- File: `__http__/feature-flag-scheduling.http` (extend existing from WISH-2119)
- Test: GET preview with no schedules (assert currentState = previewedState)
- Test: Create schedule, GET preview, assert previewedState reflects schedule
- Test: Create 3 schedules, GET preview, assert chronological application
- Test: Unauthorized access (assert 403 for non-admin)
- Test: Invalid flag (assert 404 for non-existent flag)

**AC12**: Integration with WISH-2119 cron job
- Preview endpoint does NOT affect cron job processing
- Cron job processes schedules independently of preview calls
- Preview is read-only and does not update schedule status or flag state

## Reuse Plan

### Existing Components (Extended)
- Auth middleware from `apps/api/lego-api/middleware/auth.ts` (admin role validation)
- Feature flag service from WISH-2009 (fetch current flag state)
- Schedule repository from WISH-2119 (fetch pending schedules)
- Database client from `packages/backend/database-schema/`
- Zod schema patterns from existing schemas

### New Components
- `previewSchedules` method in `schedule-service.ts` (simulation logic)
- Preview endpoint in `routes.ts`

### Existing Patterns
- Hexagonal architecture (ports & adapters)
- Zod-first type definitions
- Hono routes with middleware
- Read-only simulation logic (no side effects)

## Architecture Notes (Ports & Adapters)

### Hexagonal Architecture Compliance

**Domain Layer** (Business Logic):
- `apps/api/lego-api/domains/config/application/schedule-service.ts`
  - Add `previewSchedules(flagKey: string)` method
  - Pure simulation logic - no HTTP/database coupling
  - Returns simulated flag state object

**Adapter Layer** (Infrastructure):
- Reuses existing schedule repository from WISH-2119
- Reuses existing flag service from WISH-2009
- No new adapters required (read-only)

**Port Layer** (Contracts):
- `apps/api/lego-api/domains/config/types.ts`
  - Define `SchedulePreviewResponse` type
  - Define Zod schema for validation

**No Architecture Violations:** Story extends existing config domain following established patterns from WISH-2119 and WISH-2009.

## HTTP Contract Plan

### GET /api/admin/flags/:flagKey/schedule/preview

**Response (200 OK):**
```json
{
  "currentState": {
    "enabled": false,
    "rolloutPercentage": 0
  },
  "previewedState": {
    "enabled": true,
    "rolloutPercentage": 100
  },
  "pendingSchedules": [
    {
      "id": "a1b2c3d4-...",
      "scheduledAt": "2026-01-30T15:00:00Z",
      "updates": {
        "enabled": true
      }
    },
    {
      "id": "e5f6g7h8-...",
      "scheduledAt": "2026-01-30T18:00:00Z",
      "updates": {
        "rolloutPercentage": 100
      }
    }
  ],
  "stateChanged": true
}
```

**Response (200 OK - No Pending Schedules):**
```json
{
  "currentState": {
    "enabled": true,
    "rolloutPercentage": 50
  },
  "previewedState": {
    "enabled": true,
    "rolloutPercentage": 50
  },
  "pendingSchedules": [],
  "stateChanged": false
}
```

**Error Responses:**
- 403 Forbidden: Non-admin user
- 404 Not Found: Flag does not exist

## Seed Requirements

No seed data required. Preview uses existing flags and schedules from WISH-2119.

## Test Plan

### Scope Summary
- **Endpoints:** 1 admin endpoint (GET preview)
- **UI Touched:** No (backend only)
- **Data/Storage:** Read-only (no writes to database or cache)
- **Infrastructure:** None (reuses existing Lambda/API)

### Happy Path Tests

1. **Preview with no pending schedules**: GET preview, assert stateChanged = false and currentState = previewedState
2. **Preview with single schedule**: Create pending schedule, GET preview, assert previewedState reflects schedule updates
3. **Preview with multiple schedules**: Create 3 schedules with different scheduled_at times, GET preview, assert chronological application (last wins)
4. **Preview after schedule executes**: Create schedule, wait for cron execution, GET preview, assert no pending schedules

### Error Cases

1. **Unauthorized access**: Non-admin user GET preview, assert 403 Forbidden
2. **Invalid flag key**: GET preview for non-existent flag, assert 404 Not Found

### Edge Cases

1. **Partial schedule updates**: Create schedule updating only enabled (not rolloutPercentage), assert preview preserves current rolloutPercentage
2. **Overlapping schedules**: Create 2 schedules with same scheduled_at time, assert last schedule wins (ORDER BY behavior)
3. **Preview with past schedules**: Create schedule with scheduled_at in past (pending but not yet processed by cron), assert preview includes it
4. **Preview does not affect cron processing**: GET preview, verify cron job still processes schedules independently

### Required Tooling Evidence

**Backend HTTP Tests (`__http__/feature-flag-scheduling.http`):**
- Extend existing file from WISH-2119 with 5+ preview requests
- Assert status codes: 200, 403, 404
- Assert preview properties: currentState, previewedState, pendingSchedules, stateChanged

**Backend Unit Tests:**
- Minimum 5 tests covering simulation logic, edge cases, error handling

**Frontend Tests:**
- N/A (no user-facing UI)

## UI/UX Notes

**Verdict:** SKIPPED - This story does not touch user-facing UI.

**Justification:** WISH-20240 implements backend infrastructure only (admin API endpoint for schedule preview). No user-facing components or pages created. All endpoints require admin authentication.

**Future UI/UX:** Admin dashboard from WISH-2119 follow-up stories may integrate this preview endpoint to show "What will happen when schedules execute?" UI elements.

## Risks & Mitigations

### MVP-Critical Risks

1. **Simulation logic out of sync with cron job**
   - Risk: Preview logic diverges from actual cron processing in WISH-2119
   - Mitigation: Reuse same schedule ordering logic (ORDER BY scheduled_at ASC), apply same property merging rules
   - Severity: Medium (would mislead admins)

2. **Performance with many pending schedules**
   - Risk: Preview becomes slow if 100+ pending schedules exist for a flag
   - Mitigation: Acceptable for MVP (admin-only endpoint, infrequent usage)
   - Severity: Low (admin tool only)

3. **Preview does not reflect concurrent schedule creation**
   - Risk: Admin creates schedule after calling preview, causing preview to be stale
   - Mitigation: Document that preview is a point-in-time snapshot
   - Severity: Low (acceptable for MVP)

## Open Questions

None - all decisions finalized for MVP scope.

## Definition of Done

- [ ] All 12 Acceptance Criteria pass
- [ ] Backend: 5+ unit tests pass (preview simulation logic)
- [ ] Backend: HTTP integration tests pass (`.http` file extended with 5+ preview requests)
- [ ] Schema alignment test passes (frontend ↔ backend)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Generation | ~8k | — | — | Follow-up from elaboration finding |
| Elaboration | ~8k | — | — | Read-only endpoint story |
| Implementation | ~10k | — | — | Simulation logic + endpoint + tests |
| Code Review | ~4k | — | — | Small story |
| **Total** | ~30k | — | — | Small-sized story |

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-30 00:00 | pm-story-followup-leader | Generated follow-up story from WISH-2119 finding #3 | WISH-20240.md |

---

## Source

Follow-up from QA Elaboration of WISH-2119 (Enhancement Opportunities)

**Original Finding:** "Schedule preview endpoint (simulate flag state before schedule applies) - Deferred to Phase 4+ follow-up story"

**Category:** Enhancement Opportunity

**Impact:** Medium (improves admin confidence and reduces configuration errors)

**Effort:** Low (2 points - read-only simulation logic)

**Use Cases:**
- Verify complex scheduling scenarios before execution (multiple overlapping schedules)
- Identify conflicting schedules that may produce unexpected flag states
- Build admin confidence when scheduling critical flag changes (production rollouts)
- Debug scheduling issues without affecting live flags
