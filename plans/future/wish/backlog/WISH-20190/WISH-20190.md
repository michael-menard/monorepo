---
doc_type: story
title: "WISH-20190: Schema Drift Detection Tool (db:check command)"
story_id: WISH-20190
story_prefix: WISH
status: backlog
phase: 1
created_at: "2026-01-29T19:00:00-07:00"
updated_at: "2026-01-29T19:00:00-07:00"
depends_on: [WISH-2057]
follow_up_from: WISH-2057
estimated_points: 3
---

# WISH-20190: Schema Drift Detection Tool (db:check command)

## Follow-up Context

**Parent Story:** WISH-2057
**Source:** QA Discovery Notes (Follow-up Stories Suggested - Finding #2)
**Original Finding:** "Schema drift detection tool (`db:check` command from WISH-2007 Enhancement #3)"
**Category:** Enhancement Opportunity
**Impact:** High
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-2057 as a critical operational tool for detecting schema drift between environments. The schema evolution policies documented in WISH-2057 need accompanying tooling to verify schema consistency across development, staging, and production environments.

## Context

WISH-2057 establishes comprehensive schema evolution policies and versioning strategies, but lacks automation for detecting when environments fall out of sync. In multi-environment deployments, schema drift is a common source of production failures:

- Developer applies migration locally but forgets to commit
- Staging and production schemas diverge due to hotfix migrations
- Manual schema changes bypass migration system
- Migration rollbacks leave inconsistent state

Without a schema drift detection tool, these issues remain hidden until runtime errors occur. The `db:check` command will provide proactive detection of schema mismatches, ensuring the schema evolution policies from WISH-2057 are actually being followed.

This tool was originally suggested in WISH-2007 Enhancement #3 and is now prioritized as a follow-up to WISH-2057's policy documentation.

## Goal

Implement a `db:check` command that compares the current database schema against the expected schema from Drizzle migrations, detecting drift and reporting mismatches for manual review and remediation.

## Non-goals

- Automatic schema drift remediation (would be unsafe; manual review required)
- Schema diff generation for non-Drizzle databases (Drizzle-specific only)
- Real-time schema monitoring dashboard (separate observability concern)
- Blocking deployments on drift detection (future CI/CD integration)
- Cross-database schema comparison (focus on single database vs expected state)

## Scope

### CLI Command

1. **`pnpm db:check` Command** (`packages/backend/database-schema/scripts/check-schema-drift.ts`)
   - Connects to target database (uses existing Drizzle connection config)
   - Introspects current database schema using Drizzle introspection
   - Compares against expected schema from Drizzle schema definitions
   - Reports mismatches (missing tables, extra tables, column differences, type mismatches, constraint differences)
   - Exit code 0 for no drift, exit code 1 for drift detected
   - Supports `--environment` flag (local, staging, production)
   - JSON output mode with `--json` flag for CI integration

### Detection Categories

The tool will detect the following types of schema drift:

- **Missing tables**: Tables in code but not in database
- **Extra tables**: Tables in database but not in code (manual additions)
- **Missing columns**: Columns in code but not in table
- **Extra columns**: Columns in table but not in code
- **Type mismatches**: Column type differs (e.g., VARCHAR(255) vs TEXT)
- **Constraint differences**: NOT NULL, UNIQUE, FOREIGN KEY mismatches
- **Enum value differences**: PostgreSQL enum values differ from code definitions
- **Index differences**: Missing or extra indexes
- **Default value mismatches**: Column defaults differ from code

### Packages Affected

- `packages/backend/database-schema/scripts/check-schema-drift.ts` - Main drift detection script (new)
- `packages/backend/database-schema/package.json` - Add `db:check` script
- `packages/backend/database-schema/src/drift-detector/` - Drift detection utilities (new)
- `packages/backend/database-schema/docs/SCHEMA-DRIFT-DETECTION.md` - Usage documentation (new)

### Infrastructure

- Uses existing Drizzle database connection configuration
- Requires database read permissions (no writes)
- Supports environment variable configuration: `DATABASE_URL_LOCAL`, `DATABASE_URL_STAGING`, `DATABASE_URL_PRODUCTION`

## Acceptance Criteria

### Core Functionality (AC 1-6)

- [ ] AC 1: `pnpm db:check` command connects to database using Drizzle config
- [ ] AC 2: Command introspects current database schema (tables, columns, types, constraints, enums)
- [ ] AC 3: Command compares introspected schema against expected Drizzle schema definitions
- [ ] AC 4: Command reports all detected drift categories (missing/extra tables, column mismatches, type differences, constraint differences)
- [ ] AC 5: Command exits with code 0 when no drift detected, code 1 when drift found
- [ ] AC 6: Command supports `--environment` flag to target different databases (local, staging, production)

### Output Formatting (AC 7-9)

- [ ] AC 7: Human-readable output mode (default) with clear mismatch descriptions
- [ ] AC 8: JSON output mode (`--json` flag) for CI integration with structured drift report
- [ ] AC 9: Output includes remediation suggestions (e.g., "Run migration 0008_add_column.sql" or "Manually remove extra table")

### Enum and Constraint Detection (AC 10-12)

- [ ] AC 10: Detects PostgreSQL enum value differences (missing values, extra values)
- [ ] AC 11: Detects constraint differences (NOT NULL, UNIQUE, FOREIGN KEY, CHECK constraints)
- [ ] AC 12: Detects index differences (missing indexes, extra indexes, different index definitions)

### Error Handling and Edge Cases (AC 13-16)

- [ ] AC 13: Gracefully handles connection failures with clear error message
- [ ] AC 14: Handles missing environment variables with actionable error message
- [ ] AC 15: Handles partially applied migrations (detects tables from migration N but not N+1)
- [ ] AC 16: Ignores Drizzle metadata tables (`drizzle_migrations`, `schema_versions`) in drift detection

### Documentation and Testing (AC 17-20)

- [ ] AC 17: `SCHEMA-DRIFT-DETECTION.md` documents `db:check` usage with examples
- [ ] AC 18: Documentation includes common drift scenarios and remediation steps
- [ ] AC 19: Unit tests cover all drift detection categories with mock database schemas
- [ ] AC 20: Integration test runs `db:check` against test database with known drift

## Reuse Plan

### Existing Patterns

- **Drizzle Introspection**: Use Drizzle's built-in introspection API (`drizzle-kit introspect`)
- **Migration System**: Build on existing `drizzle.config.ts` and migration infrastructure from WISH-2007
- **Connection Management**: Reuse database connection patterns from `packages/backend/database-schema/src/index.ts`
- **Script Infrastructure**: Follow existing script patterns in `packages/backend/database-schema/scripts/`

### Third-Party Libraries

- **Drizzle ORM**: Use `drizzle-orm` introspection utilities for schema comparison
- **Drizzle Kit**: Leverage `drizzle-kit` for schema introspection
- **pg-introspect** (optional): PostgreSQL introspection library if Drizzle introspection insufficient

### Industry Standards

- **Rails Schema Drift Detection**: `rails db:schema:dump` and schema.rb comparison patterns
- **Liquibase Schema Validation**: `liquibase validate` command patterns
- **Flyway Drift Detection**: `flyway info` and `flyway validate` command patterns

## Architecture Notes

### Drizzle Introspection Approach

Drizzle Kit provides introspection capabilities to generate schema from existing database:

```typescript
import { drizzle } from 'drizzle-orm/postgres-js'
import { pgTable } from 'drizzle-orm/pg-core'
import postgres from 'postgres'

// Introspect current database schema
const connection = postgres(process.env.DATABASE_URL)
const db = drizzle(connection)
const currentSchema = await introspectDatabase(db)

// Compare against expected schema from code
const expectedSchema = loadDrizzleSchemaDefinitions()
const driftReport = compareSchemata(currentSchema, expectedSchema)
```

### Drift Detection Algorithm

1. **Table-level comparison**:
   - Missing tables: in code but not in DB
   - Extra tables: in DB but not in code

2. **Column-level comparison** (for matching tables):
   - Missing columns: in code but not in table
   - Extra columns: in table but not in code
   - Type mismatches: same column, different type
   - Nullability mismatches: NOT NULL differences
   - Default value mismatches

3. **Constraint comparison**:
   - Primary key differences
   - Foreign key differences
   - Unique constraint differences
   - Check constraint differences

4. **Enum comparison**:
   - Enum type missing or extra
   - Enum values missing or extra

5. **Index comparison**:
   - Missing indexes
   - Extra indexes
   - Index definition differences

### Output Format (Human-Readable)

```
Schema Drift Detection Report
=============================

Environment: staging
Database: wishlist_staging_db
Checked at: 2026-01-29 19:00:00 UTC

DRIFT DETECTED: 3 issues found

[ERROR] Missing Table: wishlist_items_archive
  Expected in code, not found in database
  Remediation: Run migration 0008_create_archive_table.sql

[WARNING] Extra Column: wishlist_items.legacy_field
  Found in database, not in code
  Remediation: Create migration to drop column or add to schema

[ERROR] Type Mismatch: wishlist_items.price_amount
  Database: NUMERIC(10,2)
  Code:     DECIMAL(12,2)
  Remediation: Create migration to alter column type

Exit Code: 1 (drift detected)
```

### Output Format (JSON for CI)

```json
{
  "environment": "staging",
  "database": "wishlist_staging_db",
  "checked_at": "2026-01-29T19:00:00Z",
  "has_drift": true,
  "drift_count": 3,
  "drifts": [
    {
      "type": "missing_table",
      "severity": "error",
      "table": "wishlist_items_archive",
      "message": "Expected in code, not found in database",
      "remediation": "Run migration 0008_create_archive_table.sql"
    },
    {
      "type": "extra_column",
      "severity": "warning",
      "table": "wishlist_items",
      "column": "legacy_field",
      "message": "Found in database, not in code",
      "remediation": "Create migration to drop column or add to schema"
    },
    {
      "type": "type_mismatch",
      "severity": "error",
      "table": "wishlist_items",
      "column": "price_amount",
      "database_type": "NUMERIC(10,2)",
      "code_type": "DECIMAL(12,2)",
      "message": "Column type differs between database and code",
      "remediation": "Create migration to alter column type"
    }
  ]
}
```

## Test Plan

### Unit Tests (AC 19)

**Test 1: Detect Missing Tables**
- Mock database schema: `wishlist_items` table only
- Expected schema: `wishlist_items`, `wishlist_items_archive`
- Assert drift report includes missing table `wishlist_items_archive`

**Test 2: Detect Extra Tables**
- Mock database schema: `wishlist_items`, `legacy_table`
- Expected schema: `wishlist_items` only
- Assert drift report includes extra table `legacy_table`

**Test 3: Detect Type Mismatches**
- Mock database column: `price_amount NUMERIC(10,2)`
- Expected schema column: `price_amount DECIMAL(12,2)`
- Assert drift report includes type mismatch

**Test 4: Detect Enum Value Differences**
- Mock database enum: `wishlist_store` with values ['LEGO', 'BrickLink']
- Expected schema enum: `wishlist_store` with values ['LEGO', 'BrickLink', 'Amazon']
- Assert drift report includes missing enum value 'Amazon'

**Test 5: Detect Constraint Differences**
- Mock database column: `user_id` without NOT NULL
- Expected schema column: `user_id` with NOT NULL
- Assert drift report includes constraint mismatch

**Test 6: Ignore Drizzle Metadata Tables**
- Mock database schema includes `drizzle_migrations` table
- Assert drift report does NOT flag `drizzle_migrations` as extra table

### Integration Tests (AC 20)

**Test 7: Real Database Drift Detection**
- Create test database with known drift (extra column, missing table)
- Run `pnpm db:check` against test database
- Assert exit code 1 and drift report matches expected drift

**Test 8: No Drift Scenario**
- Create test database matching exact schema from Drizzle definitions
- Run `pnpm db:check` against test database
- Assert exit code 0 and no drift reported

### CLI Tests

**Test 9: Environment Flag Support**
- Run `pnpm db:check --environment=staging`
- Assert command uses `DATABASE_URL_STAGING` environment variable
- Assert output includes "Environment: staging"

**Test 10: JSON Output Mode**
- Run `pnpm db:check --json`
- Assert output is valid JSON
- Assert JSON includes `has_drift`, `drift_count`, `drifts` array

### Error Handling Tests

**Test 11: Connection Failure**
- Set `DATABASE_URL` to invalid connection string
- Run `pnpm db:check`
- Assert clear error message and exit code 1

**Test 12: Missing Environment Variable**
- Unset `DATABASE_URL` environment variable
- Run `pnpm db:check`
- Assert actionable error message mentioning missing variable

## Risk Notes

### MVP-Critical Risks

**Risk 1: Drizzle Introspection Limitations**
- Drizzle introspection may not capture all PostgreSQL-specific features (custom types, advanced constraints)
- **Mitigation**: Use `pg-introspect` library as fallback for PostgreSQL-specific features

**Risk 2: False Positives from Type Aliases**
- PostgreSQL type aliases (e.g., `INTEGER` vs `INT4`) may trigger false positive type mismatches
- **Mitigation**: Normalize type names to canonical PostgreSQL types before comparison

**Risk 3: Noisy Output for Intentional Drift**
- Some drift may be intentional (e.g., staging has test data tables not in code)
- **Mitigation**: Document how to ignore specific tables/columns (future enhancement: `.driftignore` file)

### Non-MVP Risks

**Risk 4: Performance on Large Schemas**
- Introspection on databases with 100+ tables may be slow
- **Mitigation**: Add `--table` flag to check specific tables only (future enhancement)

**Risk 5: Multi-Schema Databases**
- Tool assumes single PostgreSQL schema (public); may not handle multi-schema setups
- **Mitigation**: Document single-schema limitation; extend for multi-schema in future

## Definition of Done

- [ ] All 20 Acceptance Criteria verified
- [ ] `pnpm db:check` command runs successfully
- [ ] Command detects all drift categories (tables, columns, types, constraints, enums, indexes)
- [ ] Human-readable and JSON output modes both work
- [ ] 12 unit/integration tests pass
- [ ] Documentation created in `SCHEMA-DRIFT-DETECTION.md`
- [ ] Documentation includes usage examples and common drift scenarios
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~3k | — | — | Follow-up generation |
| Implementation | ~8k | — | — | CLI script + drift detector utilities |
| Review | ~2k | — | — | Code review |
| **Total** | ~13k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-29 19:00 | pm-story-followup-leader | Created follow-up story from WISH-2057 finding #2 (Follow-up Stories Suggested) | WISH-20190.md |

---

## Future Enhancement Notes

Once this drift detection tool exists, consider:
- **Automated drift remediation**: Generate migration scripts to fix detected drift
- **CI/CD integration**: Block deployments if drift detected in target environment
- **Real-time monitoring**: Schema drift alerts via CloudWatch or PagerDuty
- **Drift ignore file**: `.driftignore` to exclude intentional drift (e.g., test tables)
- **Multi-schema support**: Extend to handle PostgreSQL schemas beyond `public`
- **Performance optimization**: Parallel introspection for large schemas
- **Historical drift tracking**: Store drift detection results over time for trend analysis
