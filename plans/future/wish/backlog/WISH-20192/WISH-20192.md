---
doc_type: story
title: "WISH-20192: Schema Drift Detection - Advanced Features"
story_id: WISH-20192
story_prefix: WISH
status: backlog
phase: 1
created_at: "2026-01-31T10:16:00-07:00"
updated_at: "2026-01-31T10:16:00-07:00"
depends_on: [WISH-20191]
split_from: WISH-20190
split_part: 2 of 3
estimated_points: 3
---

# WISH-20192: Schema Drift Detection - Advanced Features

## Split Context

This story is part of a split from WISH-20190.
- **Original Story:** WISH-20190 (Schema Drift Detection Tool)
- **Split Reason:** Scope expansion during QA elaboration (8 new features added via user decisions). Advanced features separated from MVP for independent implementation.
- **This Part:** 2 of 3 (Advanced features)
- **Dependency:** Depends on WISH-20191 (must complete MVP core drift detection first)
- **Related Stories:**
  - WISH-20191 (MVP - Core drift detection with db:check command)
  - WISH-20193 (CI/CD Integration - deployment blocking, severity levels)

## Context

While WISH-20191 provides the MVP core drift detection capabilities, real-world usage identified several enhancement needs during QA elaboration:

1. **Intentional Drift Exclusion**: Staging/dev environments often have test tables or debug columns not in production code. Without ignore capability, the tool generates noise.

2. **Automated Remediation**: Developers currently receive drift reports but must manually create migration scripts to fix drift. This is error-prone and time-consuming.

3. **Debugging Support**: When drift detection behaves unexpectedly, developers need detailed logging to understand what the tool is comparing and why mismatches occur.

4. **Trend Analysis**: Detecting drift at a single point in time is useful, but tracking drift patterns over time reveals systemic issues (e.g., hotfix migrations bypassing proper workflow).

This story extends the drift detection tool with these advanced features, improving usability and automation without blocking the MVP implementation.

## Goal

Extend the drift detection tool with `.driftignore` file support for excluding intentional drift, automated drift remediation to generate migration scripts, verbose mode for debugging, and historical drift tracking for trend analysis.

## Non-goals

- Real-time drift monitoring dashboard (separate observability concern)
- CI/CD integration and deployment blocking (covered in WISH-20193)
- Drift severity levels (covered in WISH-20193)
- Multi-schema PostgreSQL support (future enhancement)
- Custom PostgreSQL types beyond standard Drizzle support (future enhancement)

## Scope

### .driftignore File Support (AC 21)

Allow developers to exclude intentional drift from detection reports:

- Gitignore-style syntax for excluding tables/columns/schemas
- File location: `packages/backend/database-schema/.driftignore`
- Patterns support: exact matches, wildcards, table.column notation
- Comment support with `#` prefix
- Validation errors if pattern syntax is invalid

**Example `.driftignore`:**
```
# Test tables in staging environment
test_*
staging_*

# Debug columns in development
*.debug_*
*.temp_*

# Specific exclusions
legacy_users
wishlist_items.legacy_field
```

### Automated Drift Remediation (AC 22)

Generate migration scripts to automatically fix detected drift:

- `pnpm db:check --remediate` flag to generate migration scripts
- Creates migration file in `packages/backend/database-schema/src/migrations/`
- Migration file includes inverse operations to fix drift
- Supported operations: ADD COLUMN (for missing columns), DROP COLUMN (for extra columns), ALTER COLUMN TYPE (for type mismatches), CREATE INDEX, DROP INDEX
- Unsupported/unsafe operations generate manual remediation instructions
- Dry-run output shows what migration would be generated
- Safety warnings for destructive operations (DROP COLUMN, type changes)

**Example remediation output:**
```
Schema Drift Remediation
========================

Generated migration: 0009_fix_drift_staging.sql

Operations:
  - ADD COLUMN wishlist_items.archived_at TIMESTAMP
  - DROP COLUMN wishlist_items.legacy_field (WARNING: data loss)
  - ALTER COLUMN wishlist_items.price_amount TYPE DECIMAL(12,2)

Review the migration file before applying:
  packages/backend/database-schema/src/migrations/0009_fix_drift_staging.sql

To apply: pnpm db:migrate
```

### Verbose Mode (AC 23)

Detailed logging of comparison steps for debugging:

- `pnpm db:check --verbose` flag enables detailed output
- Logs each table comparison step
- Shows raw introspection results for debugging
- Displays type normalization logic
- Indicates which tables/columns are being compared
- Useful for understanding why drift is or isn't detected

**Example verbose output:**
```
[VERBOSE] Loading Drizzle schema definitions...
[VERBOSE] Found 5 tables in code schema: wishlist_items, users, ...
[VERBOSE] Connecting to database: wishlist_staging_db
[VERBOSE] Introspecting database schema...
[VERBOSE] Found 6 tables in database: wishlist_items, users, test_table, ...
[VERBOSE] Comparing table: wishlist_items
[VERBOSE]   Code columns: 12 | DB columns: 13
[VERBOSE]   Comparing column: id (UUID vs uuid) - normalized to UUID
[VERBOSE]   Comparing column: price_amount
[VERBOSE]     Code: DECIMAL(12,2) | DB: NUMERIC(10,2)
[VERBOSE]     MISMATCH DETECTED: Type differs
[VERBOSE] Checking .driftignore exclusions...
[VERBOSE]   Excluded: test_table (matches pattern 'test_*')
```

### Historical Drift Tracking (AC 24)

Store drift detection results over time for trend analysis:

- `pnpm db:check --track` flag enables historical tracking
- Stores drift reports in `packages/backend/database-schema/.drift-history/`
- JSON format with timestamp, environment, drift details
- `pnpm db:check --history` command displays drift trends
- Identifies recurring drift patterns (same tables/columns repeatedly)
- Retention policy: keeps last 30 days of drift reports by default

**Example history output:**
```
Schema Drift History
====================

Last 7 days - staging environment:

2026-01-29: 3 drifts detected
  - Missing table: wishlist_items_archive
  - Extra column: wishlist_items.legacy_field
  - Type mismatch: wishlist_items.price_amount

2026-01-28: 2 drifts detected
  - Extra column: wishlist_items.legacy_field (recurring)
  - Type mismatch: wishlist_items.price_amount (recurring)

2026-01-27: 0 drifts detected

Recurring Issues:
  - wishlist_items.legacy_field (extra column) - detected 5 times in last 7 days
  - wishlist_items.price_amount (type mismatch) - detected 5 times in last 7 days

Recommendation: Create migration to resolve recurring drift
```

### Packages Affected

- `packages/backend/database-schema/src/drift-detector/ignore-parser.ts` - .driftignore parser (new)
- `packages/backend/database-schema/src/drift-detector/remediation-generator.ts` - Migration script generator (new)
- `packages/backend/database-schema/src/drift-detector/history-tracker.ts` - Drift history storage (new)
- `packages/backend/database-schema/src/drift-detector/logger.ts` - Verbose mode logging (new)
- `packages/backend/database-schema/.driftignore` - Example ignore file (new)
- `packages/backend/database-schema/.drift-history/` - Historical drift reports directory (new)
- `packages/backend/database-schema/docs/SCHEMA-DRIFT-DETECTION.md` - Update with advanced features
- `packages/backend/database-schema/scripts/check-schema-drift.ts` - Update to support new flags

## Acceptance Criteria

### .driftignore Support (AC 21)

- [ ] AC 21.1: `.driftignore` file is parsed and applied to drift detection results
- [ ] AC 21.2: Gitignore-style pattern matching works (exact matches, wildcards, table.column notation)
- [ ] AC 21.3: Comments with `#` prefix are supported
- [ ] AC 21.4: Invalid pattern syntax displays actionable validation error
- [ ] AC 21.5: Excluded tables/columns do not appear in drift reports
- [ ] AC 21.6: Verbose mode logs which items are excluded and why

### Automated Drift Remediation (AC 22)

- [ ] AC 22.1: `--remediate` flag generates migration file in migrations/ directory
- [ ] AC 22.2: Migration includes SQL to fix detected drift (ADD COLUMN, DROP COLUMN, ALTER TYPE, CREATE INDEX, DROP INDEX)
- [ ] AC 22.3: Unsupported operations generate manual remediation instructions
- [ ] AC 22.4: Safety warnings displayed for destructive operations
- [ ] AC 22.5: Generated migration follows Drizzle migration naming convention
- [ ] AC 22.6: Dry-run mode (default) shows what would be generated without writing file
- [ ] AC 22.7: `--remediate --execute` flag writes migration file to disk

### Verbose Mode (AC 23)

- [ ] AC 23.1: `--verbose` flag enables detailed logging of comparison steps
- [ ] AC 23.2: Verbose output logs table discovery, column comparisons, type normalization
- [ ] AC 23.3: Verbose output indicates which .driftignore patterns are applied
- [ ] AC 23.4: Verbose mode works with JSON output (adds `verbose_logs` array to JSON)

### Historical Drift Tracking (AC 24)

- [ ] AC 24.1: `--track` flag stores drift report as JSON in `.drift-history/` directory
- [ ] AC 24.2: Historical reports include timestamp, environment, drift details
- [ ] AC 24.3: `--history` command displays drift trends over time
- [ ] AC 24.4: History report identifies recurring drift patterns
- [ ] AC 24.5: Retention policy automatically removes reports older than 30 days
- [ ] AC 24.6: `.drift-history/` directory is git-ignored by default

## Reuse Plan

### Existing Patterns

- **Ignore File Parsing**: Reuse patterns from `.gitignore` parsers (minimatch library)
- **Migration Generation**: Follow Drizzle migration file naming and structure conventions
- **Logging**: Reuse `@repo/logger` for verbose mode output
- **File System Operations**: Use Node.js `fs` module for .driftignore and history tracking

### Third-Party Libraries

- **minimatch**: Pattern matching for .driftignore file (gitignore-style wildcards)
- **date-fns**: Date handling for drift history retention policy
- **zod**: Schema validation for .drift-history JSON files

### Industry Standards

- **.gitignore syntax**: Use familiar pattern matching syntax for developer experience
- **Flyway remediation**: Similar to Flyway's baseline migration generation
- **Liquibase rollback**: Similar to Liquibase's automated rollback script generation

## Architecture Notes

### .driftignore Parser

```typescript
import minimatch from 'minimatch'

interface DriftIgnorePattern {
  pattern: string
  isTableLevel: boolean // true if pattern doesn't include '.'
  isComment: boolean
}

function parseDriftIgnore(filePath: string): DriftIgnorePattern[] {
  const lines = fs.readFileSync(filePath, 'utf-8').split('\n')
  return lines
    .map(line => line.trim())
    .filter(line => line.length > 0)
    .map(line => ({
      pattern: line,
      isTableLevel: !line.includes('.'),
      isComment: line.startsWith('#'),
    }))
    .filter(p => !p.isComment)
}

function shouldIgnore(
  table: string,
  column: string | null,
  patterns: DriftIgnorePattern[]
): boolean {
  const fullPath = column ? `${table}.${column}` : table
  return patterns.some(p => minimatch(fullPath, p.pattern))
}
```

### Remediation Generator

```typescript
interface DriftItem {
  type: 'missing_table' | 'extra_column' | 'type_mismatch' | ...
  table: string
  column?: string
  databaseType?: string
  codeType?: string
}

function generateRemediationSQL(drifts: DriftItem[]): string {
  const sqlStatements: string[] = []

  for (const drift of drifts) {
    switch (drift.type) {
      case 'missing_column':
        // Generate ADD COLUMN statement
        sqlStatements.push(
          `ALTER TABLE ${drift.table} ADD COLUMN ${drift.column} ${drift.codeType};`
        )
        break
      case 'extra_column':
        // Generate DROP COLUMN with warning
        sqlStatements.push(
          `-- WARNING: Data loss! Review before executing\n` +
          `ALTER TABLE ${drift.table} DROP COLUMN ${drift.column};`
        )
        break
      case 'type_mismatch':
        // Generate ALTER COLUMN TYPE
        sqlStatements.push(
          `ALTER TABLE ${drift.table} ALTER COLUMN ${drift.column} TYPE ${drift.codeType};`
        )
        break
      // ... other cases
    }
  }

  return sqlStatements.join('\n\n')
}
```

### Historical Tracking

```typescript
interface DriftHistoryEntry {
  timestamp: string // ISO 8601
  environment: string
  database: string
  has_drift: boolean
  drift_count: number
  drifts: DriftItem[]
}

function saveDriftHistory(report: DriftHistoryEntry): void {
  const filename = `drift-${report.environment}-${Date.now()}.json`
  const filepath = path.join('.drift-history', filename)
  fs.writeFileSync(filepath, JSON.stringify(report, null, 2))
}

function loadDriftHistory(environment: string, days: number = 7): DriftHistoryEntry[] {
  const files = fs.readdirSync('.drift-history')
    .filter(f => f.startsWith(`drift-${environment}-`))
    .sort()
    .reverse()

  const cutoff = Date.now() - days * 24 * 60 * 60 * 1000
  return files
    .map(f => JSON.parse(fs.readFileSync(path.join('.drift-history', f), 'utf-8')))
    .filter(entry => new Date(entry.timestamp).getTime() > cutoff)
}

function analyzeRecurringDrift(history: DriftHistoryEntry[]): RecurringIssue[] {
  const issueMap = new Map<string, number>()

  for (const entry of history) {
    for (const drift of entry.drifts) {
      const key = `${drift.table}.${drift.column || '*'} (${drift.type})`
      issueMap.set(key, (issueMap.get(key) || 0) + 1)
    }
  }

  return Array.from(issueMap.entries())
    .filter(([_, count]) => count > 1)
    .map(([issue, count]) => ({ issue, count }))
    .sort((a, b) => b.count - a.count)
}
```

## Test Plan

### .driftignore Tests

**Test 1: Parse .driftignore File**
- Create `.driftignore` with patterns: `test_*`, `*.debug_*`, `legacy_users`
- Assert parser correctly loads and categorizes patterns
- Assert comments are ignored

**Test 2: Apply Table-Level Exclusions**
- Mock drift report with extra table `test_users`
- Apply `.driftignore` pattern `test_*`
- Assert `test_users` is excluded from final report

**Test 3: Apply Column-Level Exclusions**
- Mock drift report with extra column `wishlist_items.debug_field`
- Apply `.driftignore` pattern `*.debug_*`
- Assert `wishlist_items.debug_field` is excluded from final report

**Test 4: Invalid Pattern Syntax**
- Create `.driftignore` with invalid regex pattern
- Run `pnpm db:check`
- Assert validation error is displayed

### Remediation Tests

**Test 5: Generate Migration for Missing Column**
- Mock drift report with missing column `wishlist_items.archived_at TIMESTAMP`
- Run `pnpm db:check --remediate`
- Assert migration file includes `ALTER TABLE wishlist_items ADD COLUMN archived_at TIMESTAMP;`

**Test 6: Generate Migration for Extra Column**
- Mock drift report with extra column `wishlist_items.legacy_field`
- Run `pnpm db:check --remediate`
- Assert migration includes `DROP COLUMN` with safety warning

**Test 7: Generate Migration for Type Mismatch**
- Mock drift report with type mismatch: DB `NUMERIC(10,2)`, code `DECIMAL(12,2)`
- Run `pnpm db:check --remediate`
- Assert migration includes `ALTER COLUMN ... TYPE DECIMAL(12,2);`

**Test 8: Dry-Run Mode (Default)**
- Mock drift report
- Run `pnpm db:check --remediate` (without --execute)
- Assert migration SQL is displayed but file is NOT written to disk

**Test 9: Execute Mode**
- Mock drift report
- Run `pnpm db:check --remediate --execute`
- Assert migration file is written to `src/migrations/` directory

### Verbose Mode Tests

**Test 10: Verbose Logging**
- Run `pnpm db:check --verbose`
- Assert output includes detailed comparison steps
- Assert type normalization is logged
- Assert .driftignore exclusions are logged

**Test 11: Verbose with JSON Output**
- Run `pnpm db:check --verbose --json`
- Assert JSON output includes `verbose_logs` array
- Assert logs are structured as JSON entries

### Historical Tracking Tests

**Test 12: Save Drift History**
- Run `pnpm db:check --track`
- Assert drift report is saved to `.drift-history/` directory
- Assert filename includes environment and timestamp

**Test 13: Load Drift History**
- Create historical reports for last 7 days
- Run `pnpm db:check --history`
- Assert all reports from last 7 days are displayed
- Assert older reports are excluded

**Test 14: Identify Recurring Drift**
- Create 5 historical reports with same drift (extra column `wishlist_items.legacy_field`)
- Run `pnpm db:check --history`
- Assert recurring issue is identified and highlighted

**Test 15: Retention Policy**
- Create historical reports older than 30 days
- Run cleanup command (or automatic cleanup)
- Assert old reports are removed

## Risk Notes

### MVP-Critical Risks

**Risk 1: .driftignore Pattern Complexity**
- Complex wildcard patterns may be confusing or behave unexpectedly
- **Mitigation**: Use well-tested `minimatch` library; provide clear documentation with examples

**Risk 2: Automated Remediation Safety**
- Generated migrations could be incorrect or destructive
- **Mitigation**: Default to dry-run mode; require `--execute` flag; include safety warnings for DROP operations

**Risk 3: Historical Data Growth**
- `.drift-history/` directory could grow unbounded
- **Mitigation**: Implement 30-day retention policy; document that directory is git-ignored

### Non-MVP Risks

**Risk 4: Migration Generation for Complex Types**
- Custom PostgreSQL types may not generate correct migration SQL
- **Mitigation**: Document unsupported types; generate manual remediation instructions

**Risk 5: Verbose Mode Performance**
- Detailed logging could impact performance on large schemas
- **Mitigation**: Verbose mode is opt-in only; can be optimized if needed

## Definition of Done

- [ ] All 4 Acceptance Criteria groups verified (21.1-21.6, 22.1-22.7, 23.1-23.4, 24.1-24.6)
- [ ] `.driftignore` file parsing and pattern matching works correctly
- [ ] `--remediate` flag generates correct migration scripts
- [ ] `--verbose` flag provides detailed debugging output
- [ ] `--track` and `--history` flags enable drift trend analysis
- [ ] 15 unit/integration tests pass
- [ ] Documentation updated in `SCHEMA-DRIFT-DETECTION.md`
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Implementation | ~9k | — | — | Ignore parser + remediation generator + history tracker + verbose logging |
| Review | ~2k | — | — | Code review |
| **Total** | ~11k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-31 10:16 | pm-story-split-leader | Created split story 2/3 from WISH-20190 (Advanced features) | WISH-20192.md |

---
