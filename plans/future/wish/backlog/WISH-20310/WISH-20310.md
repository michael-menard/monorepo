---
id: WISH-20310
title: "Global MSW handler cleanup in src/test/setup.ts afterEach hook"
status: backlog
created: 2026-01-30
updated: 2026-01-30
depends_on:
  - WISH-2120
follow_up_from: WISH-2120
phase: "2 - Infrastructure"
priority: P2
complexity: Small
effort: 1
category: Test Infrastructure
---

# WISH-20310: Global MSW handler cleanup in src/test/setup.ts afterEach hook

## Follow-up Context

**Parent Story:** WISH-2120
**Source:** QA Discovery Notes - Enhancement Opportunity #2
**Original Finding:** Auto-cleanup in test teardown - Add global MSW handler cleanup in `src/test/setup.ts` afterEach hook to prevent handler leaks across tests. Current approach requires manual cleanup() calls.
**Category:** Enhancement Opportunity
**Impact:** Medium (prevents handler leaks, improves test reliability)
**Effort:** Low (global cleanup hook)

## Context

WISH-2120 introduced `mockS3Upload()` utility with manual cleanup pattern:

```typescript
const cleanup = mockS3Upload({ scenario: 'success' })
// ... test code ...
cleanup()
```

While explicit cleanup works, it introduces risk:
- Developers may forget to call `cleanup()` in tests
- Test failures can skip cleanup code, leaking handlers to subsequent tests
- Adds boilerplate to every test using MSW mocking
- Handler leaks cause flaky tests with unpredictable behavior

## Goal

Implement global MSW handler cleanup in `src/test/setup.ts` afterEach hook to automatically prevent handler leaks across tests, eliminating the need for manual cleanup calls.

## Non-Goals

- Removing the existing manual cleanup pattern from WISH-2120 (backward compatible)
- Changes to production code
- Modifying MSW handler implementation patterns
- Coverage metrics improvements

---

## Scope

### Global Cleanup Hook

Add automatic MSW handler cleanup in test setup file:

**File:** `apps/web/app-wishlist-gallery/src/test/setup.ts`

```typescript
import { afterEach } from 'vitest'
import { server } from './mocks/server'

// Clean up MSW handlers after each test to prevent leaks
afterEach(() => {
  server.resetHandlers()
})
```

### Benefits

1. **Automatic cleanup:** Handlers reset after each test without manual calls
2. **Safer tests:** Cleanup runs even if test fails or throws
3. **Less boilerplate:** Tests don't need explicit cleanup calls
4. **Flake reduction:** Prevents handler leaks causing unpredictable test behavior

### Backward Compatibility

The global cleanup is **additive** and does not break existing code:
- Manual `cleanup()` calls from WISH-2120 still work (redundant but harmless)
- Existing tests continue to pass without changes
- Developers can gradually remove manual cleanup calls over time

### Packages Affected

| Package | Change Type | Description |
|---------|-------------|-------------|
| `apps/web/app-wishlist-gallery/src/test/setup.ts` | **Modify** | Add global afterEach hook |
| `apps/web/app-wishlist-gallery/src/test/__tests__/` | **New** | Test to verify cleanup runs |

---

## Acceptance Criteria

### Global Cleanup Implementation

- [ ] **AC1:** `src/test/setup.ts` imports `afterEach` from vitest
- [ ] **AC2:** `src/test/setup.ts` imports `server` from `./mocks/server`
- [ ] **AC3:** `afterEach(() => server.resetHandlers())` is added to `setup.ts`
- [ ] **AC4:** Comment explains purpose: "Clean up MSW handlers after each test to prevent leaks"

### Verification Tests

- [ ] **AC5:** New test file `src/test/__tests__/global-cleanup.test.ts` verifies handler cleanup
- [ ] **AC6:** Test verifies `server.resetHandlers()` is called after each test
- [ ] **AC7:** Test verifies handlers added in one test don't affect subsequent tests

### Backward Compatibility

- [ ] **AC8:** All existing tests in `src/hooks/__tests__/useS3Upload.test.ts` pass without changes
- [ ] **AC9:** Tests with manual `cleanup()` calls continue to work (no regressions)

### Code Quality

- [ ] **AC10:** TypeScript compilation passes with no new errors
- [ ] **AC11:** ESLint passes with no new warnings
- [ ] **AC12:** All tests pass: `pnpm --filter app-wishlist-gallery test`

### Documentation

- [ ] **AC13:** JSDoc comment added to `afterEach` hook explaining automatic cleanup behavior
- [ ] **AC14:** Optional: Add note in WISH-2120 implementation files recommending global cleanup over manual cleanup

---

## Reuse Plan

### Existing Patterns

| Pattern | Source | Usage |
|---------|--------|-------|
| Global test setup | `src/test/setup.ts` | Add afterEach hook here |
| MSW server instance | `src/test/mocks/server.ts` | Call `server.resetHandlers()` |
| vitest lifecycle hooks | Existing tests | Use `afterEach` from vitest |

### WISH-2120 Integration

Builds on WISH-2120's MSW test infrastructure:
- Uses the same `server` instance from `src/test/mocks/server.ts`
- Complements `mockS3Upload()` cleanup pattern
- Allows gradual migration from manual to automatic cleanup

---

## Architecture Notes

### Test Infrastructure Pattern

This story follows the **global test setup** pattern:

```
apps/web/app-wishlist-gallery/src/test/
├── mocks/
│   ├── browser.ts
│   ├── handlers.ts
│   └── server.ts          # MSW server instance
├── utils/
│   ├── createMockFile.ts
│   └── mockS3Upload.ts    # Manual cleanup (WISH-2120)
├── __tests__/
│   └── global-cleanup.test.ts  # NEW: Verify global cleanup
└── setup.ts               # MODIFY: Add afterEach hook
```

### Cleanup Execution Order

When both global and manual cleanup exist:

1. Test completes (pass or fail)
2. `afterEach` hooks run (newest to oldest registration)
3. Manual `cleanup()` calls (if present, run during test)
4. Global `afterEach(() => server.resetHandlers())` runs

Result: Handlers are reset at least once, preventing leaks.

---

## Test Plan

### Happy Path Tests

| Test Case | Verification |
|-----------|--------------|
| Global cleanup registered | afterEach hook exists in setup.ts |
| Handlers reset after each test | server.resetHandlers() called |
| No handler leaks | Handlers from test A don't affect test B |

### Edge Cases

| Test Case | Verification |
|-----------|--------------|
| Test failure | Cleanup runs even if test throws |
| Multiple afterEach hooks | Global cleanup doesn't conflict with others |
| Manual + global cleanup | Both patterns work together |

### Evidence Commands

```bash
# Run cleanup verification tests
pnpm --filter app-wishlist-gallery test src/test/__tests__/global-cleanup.test.ts

# Run all existing tests to verify no regressions
pnpm --filter app-wishlist-gallery test

# Type check
pnpm check-types

# Lint
pnpm lint
```

---

## TypeScript Interfaces

No new interfaces required. Uses existing vitest and MSW types:

```typescript
import { afterEach } from 'vitest'
import { server } from './mocks/server'

afterEach(() => {
  server.resetHandlers()
})
```

---

## Risks / Edge Cases

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Performance overhead | Low | Low | `resetHandlers()` is fast (<1ms) |
| Conflicts with manual cleanup | Low | Low | Both patterns are compatible |
| Breaking existing tests | Low | Medium | Verify all tests pass after change |
| Unexpected handler state | Medium | Medium | Add verification test (AC5-AC7) |

---

## Open Questions

None - this is a straightforward global cleanup pattern.

---

## Related Stories

- **WISH-2120:** Test utility helpers (parent story, introduces `mockS3Upload()`)
- **WISH-2011:** Test infrastructure for MSW mocking (base MSW setup)
- **WISH-2121:** Playwright E2E MSW setup (browser-mode MSW, different cleanup pattern)
