---
doc_type: story
title: "WISH-20370: Schema Change Impact Analysis Tool"
story_id: WISH-20370
story_prefix: WISH
status: backlog
phase: 1
created_at: "2026-01-31T12:00:00-07:00"
updated_at: "2026-01-31T12:00:00-07:00"
depends_on: [WISH-20180]
follow_up_from: WISH-20180
estimated_points: 3
---

# WISH-20370: Schema Change Impact Analysis Tool

## Follow-up Context

**Parent Story:** WISH-20180
**Source:** QA Discovery Notes (Follow-up Stories Suggested - Finding #2)
**Original Finding:** "Schema change impact analysis (service/endpoint impact detection)"
**Category:** Enhancement Opportunity
**Impact:** Medium
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-20180 as an enhancement to provide developers with visibility into which services, endpoints, and application code will be affected by their schema changes. While WISH-20180 validates schema changes against policies, this story adds impact analysis to help developers understand the downstream consequences of their changes.

## Context

When developers make schema changes (add/remove/modify columns, tables, or enums), they often lack visibility into which parts of the application will be affected:

- Which API endpoints query the modified table?
- Which backend services depend on the changed columns?
- Which frontend apps consume the affected data?
- Which GraphQL queries or REST endpoints need updates?

Without impact analysis, developers must manually search the codebase to identify affected code, which is time-consuming and error-prone. This leads to:

- Incomplete refactoring (forgetting to update dependent code)
- Runtime errors in production (accessing removed columns)
- Inefficient PR reviews (reviewers must manually trace dependencies)
- Slow schema evolution (fear of breaking things)

This story implements a tool that automatically analyzes schema changes and reports which services, endpoints, and code paths are affected, providing actionable guidance during PR reviews.

## Goal

Implement an automated schema change impact analysis tool that identifies affected services, API endpoints, GraphQL queries, and application code when database schema changes are proposed. Integrate the tool into the CI pipeline from WISH-20180 to provide developers with impact reports in PR comments.

## Non-goals

- Automated code refactoring (only reporting, not fixing affected code)
- Cross-repository impact analysis (assumes monorepo structure)
- Runtime performance monitoring of migrations (covered by future story)
- Visual schema diff tool (separate enhancement)
- Database query performance analysis (separate concern)

## Scope

### Impact Analysis Script

1. **Schema Change Detection** (`packages/backend/database-schema/scripts/analyze-schema-impact.ts`)
   - Parse migration SQL files to extract schema changes
   - Identify affected tables, columns, enums, and indexes
   - Build change summary (additions, removals, modifications)

2. **Service Impact Analysis**
   - Scan backend services in `packages/backend/` for code references to affected schema
   - Detect SQL queries, Drizzle ORM references, and raw query strings
   - Identify affected API route handlers, Lambda functions, and service modules

3. **API Endpoint Impact Analysis**
   - Scan API Gateway routes in `apps/api/` for endpoints using affected schema
   - Detect GraphQL schema fields that map to affected database columns
   - Identify REST endpoints that query affected tables

4. **Frontend Impact Analysis**
   - Scan frontend apps in `apps/web/` for GraphQL queries using affected fields
   - Detect API client calls to affected REST endpoints
   - Identify TypeScript types that reference affected schema

5. **Impact Report Generation**
   - Generate structured impact report in JSON format
   - Include file paths, line numbers, and code snippets for each affected location
   - Categorize impacts by severity (breaking, warning, informational)
   - Output human-readable markdown report for PR comments

### CI Integration

- Extend GitHub Actions workflow from WISH-20180 to run impact analysis
- Post impact report as PR comment alongside validation results
- Link to affected files in GitHub for easy navigation
- Provide actionable recommendations (e.g., "Update GraphQL schema", "Add migration data backfill")

### Packages Affected

- `packages/backend/database-schema/scripts/` - Impact analysis script
- `.github/workflows/schema-validation.yml` - CI workflow extension
- `packages/backend/database-schema/docs/` - Impact analysis documentation

### Cross-References

- WISH-20180: Parent story with CI validation framework
- WISH-2057: Schema evolution policies
- Future stories: Visual schema diff tool, migration performance profiling

## Acceptance Criteria

### Schema Change Detection (AC 1-3)

- [ ] AC 1: Script parses migration SQL files to extract affected tables (CREATE, ALTER, DROP TABLE)
- [ ] AC 2: Script detects column changes (ADD COLUMN, DROP COLUMN, ALTER COLUMN)
- [ ] AC 3: Script detects enum changes (ALTER TYPE ... ADD VALUE, enum value removals)

### Service Impact Analysis (AC 4-7)

- [ ] AC 4: Script scans `packages/backend/` for Drizzle ORM references to affected tables/columns
- [ ] AC 5: Script detects raw SQL queries referencing affected schema (SELECT, INSERT, UPDATE, DELETE)
- [ ] AC 6: Script identifies affected Lambda functions in `apps/api/src/handlers/`
- [ ] AC 7: Script reports file paths and line numbers for each affected code location

### API Endpoint Impact Analysis (AC 8-10)

- [ ] AC 8: Script scans GraphQL schema files (`*.graphql`) for fields mapping to affected database columns
- [ ] AC 9: Script identifies REST endpoint route handlers in `apps/api/` that query affected tables
- [ ] AC 10: Script detects OpenAPI/API Gateway route definitions using affected schema

### Frontend Impact Analysis (AC 11-13)

- [ ] AC 11: Script scans frontend apps in `apps/web/` for GraphQL queries (`useQuery`, `useMutation`) using affected fields
- [ ] AC 12: Script detects REST API client calls to affected endpoints (fetch, axios, API SDK)
- [ ] AC 13: Script identifies TypeScript types/interfaces that reference affected schema (if Zod schemas are shared)

### Impact Report Generation (AC 14-17)

- [ ] AC 14: Script generates JSON impact report with structure: `{ table, column, changeType, affectedFiles[] }`
- [ ] AC 15: Script generates markdown impact report for PR comments with categorized findings
- [ ] AC 16: Impact report categorizes findings by severity (Breaking, Warning, Informational)
- [ ] AC 17: Impact report includes actionable recommendations (e.g., "Update GraphQL schema at path X")

### CI Integration (AC 18-20)

- [ ] AC 18: GitHub Actions workflow runs impact analysis after schema validation passes
- [ ] AC 19: Workflow posts impact report as PR comment with GitHub file links
- [ ] AC 20: Impact analysis documentation added to `packages/backend/database-schema/docs/SCHEMA-IMPACT-ANALYSIS.md`

## Reuse Plan

### Existing Tools

- **Drizzle Introspection**: Use `drizzle-kit introspect` to get current schema state
- **Git Diff**: Detect migration file changes from WISH-20180 validation script
- **TypeScript Compiler API**: Parse TypeScript files to find schema references
- **SQL Parser**: Reuse SQL parser from WISH-20180 (pg-query-parser or sql-parser-cst)
- **AST Grep**: Use ast-grep or ts-morph to search TypeScript codebases for schema references

### Industry Patterns

- **Prisma Migrate**: Reference Prisma's approach to impact analysis during migrations
- **Hasura Migrations**: Study Hasura's metadata tracking for schema impact
- **AWS Schema Conversion Tool**: Review AWS SCT's approach to dependency tracking
- **GitHub Code Search API**: Use GitHub's native search for cross-repo impact (future enhancement)

## Architecture Notes

### Impact Analysis Flow

```
1. Parse migration SQL → Extract schema changes
   ├─ Affected tables: wishlist_items, users
   ├─ Affected columns: wishlist_items.price (type change)
   └─ Change type: ALTER COLUMN TYPE

2. Scan Backend Services
   ├─ packages/backend/wishlist-service/src/repository.ts:45
   │  └─ Drizzle query: select({ price: wishlistItems.price })
   ├─ packages/backend/wishlist-service/src/mutations.ts:78
   │  └─ Raw SQL: UPDATE wishlist_items SET price = $1
   └─ Impact: Breaking (column type changed, may require code updates)

3. Scan API Endpoints
   ├─ apps/api/src/handlers/wishlist/get-item.ts:23
   │  └─ Lambda handler queries wishlist_items
   ├─ apps/api/src/graphql/schema.graphql:15
   │  └─ GraphQL field: WishlistItem.price: Float
   └─ Impact: Warning (GraphQL type may not match new SQL type)

4. Scan Frontend Apps
   ├─ apps/web/main-app/src/queries/wishlist.ts:12
   │  └─ GraphQL query: query GetWishlist { items { price } }
   ├─ apps/web/main-app/src/components/WishlistItem.tsx:45
   │  └─ Type: WishlistItemType = { price: number }
   └─ Impact: Informational (frontend types may need updates)

5. Generate Impact Report
   ├─ Breaking Changes: 2 locations
   ├─ Warnings: 1 location
   ├─ Informational: 2 locations
   └─ Recommendations:
      • Update Drizzle schema in packages/backend/database-schema/src/schema/wishlist.ts
      • Verify GraphQL type matches new SQL type in apps/api/src/graphql/schema.graphql
      • Update frontend types if necessary
```

### Search Strategies

**Drizzle ORM References:**
```typescript
// Search for: tableName.columnName
// Example: wishlistItems.price
const pattern = new RegExp(`${tableName}\\.${columnName}`, 'g')
```

**Raw SQL Queries:**
```typescript
// Search for: SELECT * FROM table_name, INSERT INTO table_name, etc.
const sqlPattern = new RegExp(`(SELECT|INSERT|UPDATE|DELETE).*${tableName}`, 'gi')
```

**GraphQL Schema Fields:**
```graphql
# Search for: type WishlistItem { columnName: Type }
type WishlistItem {
  price: Float  # Affected by price column change
}
```

**Frontend GraphQL Queries:**
```typescript
// Search for: useQuery with field name
const query = gql`
  query GetWishlist {
    items {
      price  # Affected by price field change
    }
  }
`
```

### Impact Report Format

**JSON Structure:**
```json
{
  "migration": "0010_alter_wishlist_items_price.sql",
  "changes": [
    {
      "table": "wishlist_items",
      "column": "price",
      "changeType": "ALTER_COLUMN_TYPE",
      "oldType": "TEXT",
      "newType": "NUMERIC(10,2)",
      "impact": {
        "backend": [
          {
            "file": "packages/backend/wishlist-service/src/repository.ts",
            "line": 45,
            "snippet": "select({ price: wishlistItems.price })",
            "severity": "Breaking",
            "recommendation": "Update Drizzle schema to use numeric type"
          }
        ],
        "api": [
          {
            "file": "apps/api/src/graphql/schema.graphql",
            "line": 15,
            "snippet": "price: Float",
            "severity": "Warning",
            "recommendation": "Verify GraphQL Float type is compatible with NUMERIC(10,2)"
          }
        ],
        "frontend": [
          {
            "file": "apps/web/main-app/src/queries/wishlist.ts",
            "line": 12,
            "snippet": "items { price }",
            "severity": "Informational",
            "recommendation": "Frontend types should remain compatible"
          }
        ]
      }
    }
  ],
  "summary": {
    "breaking": 2,
    "warnings": 1,
    "informational": 2
  }
}
```

**Markdown Report (for PR comments):**
```markdown
## Schema Change Impact Analysis

**Migration:** `0010_alter_wishlist_items_price.sql`

### Changes Detected

- **Table:** `wishlist_items`
- **Column:** `price`
- **Change Type:** ALTER COLUMN TYPE (`TEXT` → `NUMERIC(10,2)`)

---

### Affected Code

#### Breaking Changes (2)

1. **Backend Service** - `packages/backend/wishlist-service/src/repository.ts:45`
   ```typescript
   select({ price: wishlistItems.price })
   ```
   **Recommendation:** Update Drizzle schema to use numeric type

2. **Backend Service** - `packages/backend/wishlist-service/src/mutations.ts:78`
   ```sql
   UPDATE wishlist_items SET price = $1
   ```
   **Recommendation:** Ensure input validation handles numeric type

#### Warnings (1)

1. **GraphQL Schema** - `apps/api/src/graphql/schema.graphql:15`
   ```graphql
   price: Float
   ```
   **Recommendation:** Verify GraphQL Float type is compatible with NUMERIC(10,2)

#### Informational (2)

1. **Frontend Query** - `apps/web/main-app/src/queries/wishlist.ts:12`
   ```typescript
   items { price }
   ```
   **Recommendation:** Frontend types should remain compatible

---

### Summary

- **Breaking Changes:** 2 locations require code updates
- **Warnings:** 1 location needs verification
- **Informational:** 2 locations may need attention

**Next Steps:**
1. Update Drizzle schema in `packages/backend/database-schema/src/schema/wishlist.ts`
2. Verify GraphQL type compatibility
3. Update affected backend services
4. Review frontend impact
```

## Test Plan

### Impact Detection Tests

**Test 1: Table Rename Impact**
- Create migration renaming `wishlist_items` to `wishlist_entries`
- Run impact analysis
- Verify script detects all references to `wishlist_items` in backend/API/frontend
- Verify report includes file paths and line numbers

**Test 2: Column Removal Impact**
- Create migration with `DROP COLUMN wishlist_items.old_field`
- Run impact analysis
- Verify script flags all code accessing `old_field` as breaking changes
- Verify recommendations include "Remove references to old_field"

**Test 3: Column Addition Impact (Non-Breaking)**
- Create migration with `ADD COLUMN wishlist_items.new_field TEXT`
- Run impact analysis
- Verify script reports informational impact (no breaking changes)
- Verify recommendation suggests updating GraphQL schema if needed

**Test 4: Enum Value Addition Impact**
- Create migration with `ALTER TYPE wishlist_store ADD VALUE 'Target'`
- Run impact analysis
- Verify script detects enum usage in backend services
- Verify frontend GraphQL queries using enum are flagged

**Test 5: Multi-Table Impact**
- Create migration affecting 3 tables (users, wishlist_items, wishlist_images)
- Run impact analysis
- Verify report groups impacts by table
- Verify summary counts are accurate

### CI Integration Tests

**Test 6: Impact Report PR Comment**
- Create PR with schema change
- Trigger CI workflow
- Verify impact report posted as PR comment
- Verify markdown formatting is readable
- Verify GitHub file links work

**Test 7: No Impact Scenario**
- Create migration adding index only (no schema changes)
- Run impact analysis
- Verify report indicates "No affected code found"
- Verify CI passes without posting impact comment

### Edge Cases

**Edge 1: False Positives**
- Create migration renaming column `name` (common word)
- Verify impact analysis doesn't flag unrelated code with "name" references
- Verify script uses AST parsing to avoid false positives

**Edge 2: Indirect References**
- Create migration affecting table used by view
- Verify impact analysis detects references to the view
- Verify transitive dependencies are reported

**Edge 3: Dynamic SQL**
- Create migration affecting table used in dynamic SQL string
- Verify impact analysis detects string-based SQL queries
- Verify report warns about dynamic SQL limitations

## Risk Notes

### MVP-Critical Risks

**Risk 1: False Negatives (Missing Affected Code)**
- Impact analysis may miss code references using dynamic queries or string interpolation
- **Mitigation**: Document analysis limitations, recommend manual review for dynamic SQL

**Risk 2: Performance on Large Codebases**
- Scanning entire monorepo for schema references may be slow
- **Mitigation**: Cache analysis results, optimize AST parsing, run in parallel

**Risk 3: Incomplete GraphQL Mapping**
- May not detect all GraphQL fields that map to affected database columns
- **Mitigation**: Require naming convention (GraphQL field names match DB columns), document limitations

### Non-MVP Risks

**Risk 4: Cross-Repository Impact**
- Cannot detect impacts in external repositories consuming shared schemas
- **Mitigation**: Document as limitation, consider GitHub Code Search API for future enhancement

**Risk 5: Indirect Schema Usage**
- May miss indirect references via database views, stored procedures, or triggers
- **Mitigation**: Document limitation, suggest manual review for complex database features

## Definition of Done

- [ ] All 20 Acceptance Criteria verified
- [ ] Impact analysis script implemented and tested
- [ ] Schema change detection tested with 10+ SQL patterns
- [ ] Service impact analysis tested across backend/API/frontend
- [ ] CI integration tested with PR comment posting
- [ ] Impact report format validated for readability
- [ ] False positive rate < 10% in test scenarios
- [ ] Script runs in < 60 seconds for typical schema changes
- [ ] Documentation added to `packages/backend/database-schema/docs/`
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~3k | — | — | Follow-up generation |
| Implementation | ~12k | — | — | Impact analysis script + CI integration |
| Review | ~2k | — | — | Testing and documentation |
| **Total** | ~17k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-31 12:00 | pm-story-followup-leader | Created follow-up story from WISH-20180 finding #2 | WISH-20370.md |

---

## Future Enhancement Notes

Once this impact analysis tool is implemented, consider:
- Cross-repository impact analysis using GitHub Code Search API
- Visual dependency graph showing schema → service → endpoint relationships
- Automated refactoring suggestions (not just reporting)
- Real-time impact analysis in IDE (VS Code extension)
- Impact analysis for database views, stored procedures, and triggers

---

## Open Questions

_Should be empty or non-blocking for backlog story_

None - all dependencies clear from WISH-20180 CI validation framework.
