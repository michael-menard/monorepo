---
doc_type: story
title: "WISH-20360: Automated Migration Rollback Testing"
story_id: WISH-20360
story_prefix: WISH
status: backlog
follow_up_from: WISH-20180
created_at: "2026-01-31T12:00:00-07:00"
updated_at: "2026-01-31T12:00:00-07:00"
depends_on: [WISH-20180]
estimated_points: 3
---

# WISH-20360: Automated Migration Rollback Testing

## Follow-up Context

**Parent Story:** WISH-20180
**Source:** QA Discovery Notes (Follow-up Stories Suggested - Finding #1)
**Original Finding:** "Automated migration rollback testing (test database creation and rollback verification)"
**Category:** Enhancement Opportunity
**Impact:** High
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-20180 as a critical enhancement to verify that database migrations can be safely rolled back. While WISH-20180 implements CI validation of schema changes against policy, it does not test whether migrations can be successfully reversed in case of deployment failures. This story adds automated rollback testing to catch irreversible migrations before production deployment.

## Context

Database migrations are often one-way operations that can be difficult or impossible to reverse without data loss. Common scenarios that prevent clean rollbacks include:

- Dropping columns or tables (data is lost)
- Changing column types in non-reversible ways (e.g., TEXT to INTEGER)
- Adding non-nullable columns without defaults (existing rows cannot be reverted)
- Complex data transformations that cannot be undone

Without automated rollback testing, teams discover rollback failures during production incidents when time pressure is highest. This creates significant risk:
- Failed rollbacks extend downtime during incidents
- Manual rollback procedures are error-prone
- Rollback failures may require emergency data recovery
- Developer confidence in deploying migrations is reduced

This story implements automated CI testing that applies each migration to a test database and verifies the rollback succeeds, providing early feedback on rollback safety.

## Goal

Implement automated CI testing that verifies database migrations can be successfully rolled back. For each migration in a PR, create a temporary test database, apply the migration, execute the rollback, and verify the database returns to the pre-migration state. Catch irreversible migrations before they reach production.

## Non-goals

- Generating rollback migrations automatically (Drizzle does not support this; manual rollback SQL is required)
- Testing rollback data integrity on production-sized datasets (performance testing is separate concern)
- Automated rollback execution in production (deployment automation is separate story)
- Testing multi-step migration rollback chains (focus on single migration rollback first)
- Backup and restore testing (infrastructure concern, not migration-specific)

## Scope

### Test Infrastructure

1. **Test Database Provisioning** (`packages/backend/database-schema/scripts/rollback-test.ts`)
   - Create ephemeral PostgreSQL test database for each migration test
   - Use Docker container or in-memory PostgreSQL for fast CI execution
   - Clean up test databases after test completion

2. **Migration Apply/Rollback Cycle**
   - Apply migration using Drizzle's migration runner
   - Capture pre-migration schema state (tables, columns, indexes, constraints)
   - Execute migration rollback (requires manual rollback SQL in migration file)
   - Capture post-rollback schema state
   - Compare pre-migration and post-rollback states for equality

3. **Rollback Verification**
   - Schema comparison: verify all tables, columns, types, indexes restored
   - Constraint validation: verify foreign keys, unique constraints, check constraints restored
   - Data integrity checks: verify test data inserted before migration is preserved after rollback
   - Sequence state: verify auto-increment sequences reset to original values

### CI Integration

4. **GitHub Actions Workflow** (`.github/workflows/migration-rollback-test.yml`)
   - Triggered on PRs modifying `packages/backend/database-schema/migrations/`
   - Spin up PostgreSQL test container
   - Run rollback test script for each new migration
   - Post test results as PR comment
   - Fail CI if rollback test fails

5. **Rollback SQL Requirements**
   - Migrations must include `-- ROLLBACK: <SQL>` comment with rollback instructions
   - CI validates that rollback SQL is present for migrations with schema changes
   - Rollback SQL is executed during test to verify it works

### Packages Affected

- `.github/workflows/` - New CI workflow for rollback testing
- `packages/backend/database-schema/scripts/` - Rollback test script implementation
- `packages/backend/database-schema/docs/` - Rollback testing documentation
- `packages/backend/database-schema/migrations/` - Migration format updated with rollback SQL

### Cross-References

- WISH-20180: Parent story with CI schema validation
- WISH-2057: Schema evolution policy (should be updated with rollback requirements)
- WISH-2007: Initial migration (rollback testing applies to all future migrations)

## Acceptance Criteria

### Test Infrastructure Setup (AC 1-5)

- [ ] AC 1: Rollback test script creates ephemeral PostgreSQL test database using Docker or in-memory instance
- [ ] AC 2: Test database is populated with base schema before applying test migration
- [ ] AC 3: Script captures schema state (tables, columns, types, indexes, constraints) before migration
- [ ] AC 4: Script applies migration using Drizzle migration runner
- [ ] AC 5: Test database is cleaned up after test completion (container stopped, resources released)

### Rollback Execution and Verification (AC 6-10)

- [ ] AC 6: Script extracts rollback SQL from migration file `-- ROLLBACK:` comment block
- [ ] AC 7: Script executes rollback SQL against test database
- [ ] AC 8: Script captures schema state after rollback and compares to pre-migration state
- [ ] AC 9: Test passes if schemas match (tables, columns, types, indexes, constraints identical)
- [ ] AC 10: Test fails if schemas differ or rollback SQL execution errors

### Data Integrity Validation (AC 11-13)

- [ ] AC 11: Script inserts test data into affected tables before migration
- [ ] AC 12: Script verifies test data is preserved after rollback (row count, values unchanged)
- [ ] AC 13: Test fails if data loss detected during rollback cycle

### CI Workflow Integration (AC 14-17)

- [ ] AC 14: GitHub Actions workflow triggers on PRs modifying `packages/backend/database-schema/migrations/`
- [ ] AC 15: Workflow runs rollback test for each new migration file in PR
- [ ] AC 16: Workflow posts test results as PR comment (pass/fail for each migration)
- [ ] AC 17: Workflow fails CI if any rollback test fails

### Documentation and Developer UX (AC 18-20)

- [ ] AC 18: Migration template updated with `-- ROLLBACK:` comment block example
- [ ] AC 19: Documentation added to `packages/backend/database-schema/docs/ROLLBACK-TESTING.md`
- [ ] AC 20: CI error messages provide clear guidance on fixing rollback failures (include rollback SQL example)

## Reuse Plan

### Existing Tools

- **Drizzle Migration System**: Use migration runner to apply migrations programmatically
- **PostgreSQL Docker Image**: Use official postgres:16 image for ephemeral test databases
- **GitHub Actions**: Existing CI infrastructure for workflow execution
- **pg-structure or pg-diff**: Use existing schema introspection tools to compare database states

### Industry Patterns

- **Database Testing Containers**: Follow Testcontainers pattern for ephemeral database provisioning
- **Schema Diffing**: Reference tools like migra (Python) or pg_diff for schema comparison logic
- **Rollback Metadata**: Follow Rails migration pattern of embedding rollback instructions in migration files

## Architecture Notes

### Migration File Format with Rollback

New migration files will include rollback SQL in comments:

```sql
-- Migration: 0005_add_wishlist_priority
-- Created: 2026-01-31

-- FORWARD MIGRATION
ALTER TABLE wishlist_items ADD COLUMN priority INTEGER DEFAULT 3;

-- ROLLBACK:
-- The following SQL will be executed during rollback testing:
-- ALTER TABLE wishlist_items DROP COLUMN priority;
```

### Rollback Test Execution Flow

```
1. Create test database (Docker container)
2. Apply base schema (all migrations up to N-1)
3. Insert test data (sample rows in affected tables)
4. Capture pre-migration schema (tables, columns, indexes, constraints)
5. Apply migration N
6. Verify migration succeeded
7. Extract rollback SQL from migration file
8. Execute rollback SQL
9. Capture post-rollback schema
10. Compare schemas (pre-migration vs post-rollback)
11. Verify test data unchanged
12. Report pass/fail
13. Cleanup test database
```

### Schema Comparison Strategy

The test will compare:

**Tables**:
- Table existence
- Table names

**Columns**:
- Column names
- Data types
- Nullability
- Default values

**Indexes**:
- Index names
- Columns indexed
- Index type (btree, hash, etc.)

**Constraints**:
- Primary keys
- Foreign keys
- Unique constraints
- Check constraints

**Sequences**:
- Sequence existence
- Current value (reset to original)

Differences in any of these will fail the rollback test.

### CI Workflow Implementation

```yaml
name: Migration Rollback Test

on:
  pull_request:
    paths:
      - 'packages/backend/database-schema/migrations/**'

jobs:
  rollback-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2

      - name: Test migration rollback
        run: pnpm --filter @repo/database-schema test:rollback
        env:
          DATABASE_URL: postgresql://postgres:test@postgres:5432/test

      - name: Post results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            // Post PR comment with rollback test results
```

## Test Plan

### Rollback Test Scenarios

**Test 1: Reversible Column Addition**
- Create migration adding optional column with default
- Add rollback SQL: `DROP COLUMN`
- Run rollback test
- Verify schema restored, test data preserved
- Expected: PASS

**Test 2: Irreversible Column Drop**
- Create migration dropping column
- Add rollback SQL: `ADD COLUMN` (without original data)
- Run rollback test
- Verify schema restored but data loss detected
- Expected: FAIL (data loss)

**Test 3: Type Change Rollback**
- Create migration changing column type (TEXT to INTEGER)
- Add rollback SQL: `ALTER COLUMN TYPE TEXT`
- Run rollback test
- Verify schema restored, type conversion reversible
- Expected: PASS if data compatible, FAIL otherwise

**Test 4: Index Creation Rollback**
- Create migration adding index
- Add rollback SQL: `DROP INDEX`
- Run rollback test
- Verify index removed, no other changes
- Expected: PASS

**Test 5: Foreign Key Addition Rollback**
- Create migration adding foreign key constraint
- Add rollback SQL: `DROP CONSTRAINT`
- Run rollback test
- Verify constraint removed, data unchanged
- Expected: PASS

### CI Workflow Tests

**Test 6: PR Comment Generation**
- Create PR with migration including rollback SQL
- Trigger CI workflow
- Verify PR comment includes rollback test results
- Verify comment format is readable

**Test 7: CI Pass/Fail Behavior**
- Test PR with passing rollback → CI passes
- Test PR with failing rollback → CI fails
- Verify failure message includes fix guidance

### Edge Cases

**Edge 1: Missing Rollback SQL**
- Create migration without `-- ROLLBACK:` comment
- Run rollback test
- Verify test fails with clear error message
- Error should explain rollback SQL requirement

**Edge 2: Invalid Rollback SQL**
- Create migration with syntax error in rollback SQL
- Run rollback test
- Verify test fails with SQL error details
- Error should show which SQL line failed

**Edge 3: Multi-Statement Rollback**
- Create migration affecting multiple tables
- Add multi-statement rollback SQL
- Run rollback test
- Verify all statements execute, schema fully restored

**Edge 4: Sequence Reset**
- Create migration adding auto-increment column
- Add rollback with sequence reset
- Run rollback test
- Verify sequence value restored to original

## Risk Notes

### MVP-Critical Risks

**Risk 1: Test Database Provisioning Complexity**
- Docker container setup may be complex in CI environment
- **Mitigation**: Use GitHub Actions service containers (built-in Docker support), fallback to in-memory SQLite for local testing

**Risk 2: Schema Comparison False Positives**
- Schema introspection may detect meaningless differences (e.g., whitespace in default expressions)
- **Mitigation**: Normalize schema representations before comparison, ignore cosmetic differences

**Risk 3: Slow CI Execution**
- Creating test database and running full migration cycle adds latency to PRs
- **Mitigation**: Run tests only on migration file changes, use fast PostgreSQL startup, parallel test execution

### Non-MVP Risks

**Risk 4: Data Integrity Testing Incomplete**
- Test data may not cover all edge cases (e.g., null values, large datasets)
- **Mitigation**: Start with basic test data, expand coverage over time based on migration patterns

**Risk 5: Rollback SQL Maintenance Burden**
- Developers may forget to add rollback SQL or write incorrect rollback
- **Mitigation**: CI fails if rollback SQL missing, provide clear error messages with examples

## Definition of Done

- [ ] All 20 Acceptance Criteria verified
- [ ] Test database provisioning works in CI (GitHub Actions service container)
- [ ] Rollback test script implemented with schema comparison logic
- [ ] At least 5 rollback test scenarios passing (column add/drop, index, constraint, type change)
- [ ] CI workflow created and tested on sample PR
- [ ] Documentation added to `packages/backend/database-schema/docs/ROLLBACK-TESTING.md`
- [ ] Migration template updated with rollback SQL example
- [ ] PR comment formatting tested and readable
- [ ] Rollback tests run in < 60 seconds for typical migrations
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~3k | — | — | Follow-up generation |
| Implementation | ~10k | — | — | Test infrastructure + CI workflow |
| Review | ~3k | — | — | Testing and documentation |
| **Total** | ~16k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-31 12:00 | pm-story-followup-leader | Created follow-up story from WISH-20180 finding #1 | WISH-20360.md |

---

## Open Questions

_Should be empty or non-blocking for backlog story_

None - all requirements clear from WISH-20180 parent story and rollback testing best practices.
