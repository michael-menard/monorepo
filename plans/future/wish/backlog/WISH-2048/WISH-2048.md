---
doc_type: story
title: "WISH-2048: WebP Format Conversion"
story_id: WISH-2048
story_prefix: WISH
status: backlog
follow_up_from: WISH-2022
phase: 4
created_at: "2026-01-29T18:30:00-07:00"
updated_at: "2026-01-29T18:30:00-07:00"
depends_on: [WISH-2022]
estimated_points: 2
---

# WISH-2048: WebP Format Conversion

## Follow-up Context

**Parent Story:** WISH-2022: Client-side Image Compression
**Source:** QA Discovery Notes - Enhancement Opportunities
**Original Finding:** WebP format conversion - Convert to WebP instead of JPEG for 25-35% additional size savings; supported by browser-image-compression library
**Category:** Enhancement Opportunity
**Impact:** Medium - additional storage and bandwidth savings with minimal quality loss
**Effort:** Low - simple configuration change to browser-image-compression library

## Context

WISH-2022 compresses images to JPEG format with quality 0.8, providing 60-80% size reduction. However, WebP format offers superior compression efficiency compared to JPEG:
- 25-35% smaller file sizes at equivalent visual quality
- Better compression algorithm with both lossy and lossless modes
- Supported by 97%+ of modern browsers (Chrome, Firefox, Safari 14+, Edge)
- Already supported by browser-image-compression library via configuration option

Converting to WebP format provides additional storage and bandwidth savings on top of WISH-2022's compression, without requiring major changes to the compression pipeline.

## Goal

Convert compressed images to WebP format instead of JPEG to achieve 25-35% additional size savings while maintaining acceptable visual quality.

## Non-goals

- Not implementing WebP with JPEG fallback for older browsers (Safari 14+ supports WebP)
- Not implementing lossless WebP compression (lossy is sufficient for wishlist images)
- Not implementing WebP animation support (out of scope for wishlist images)
- Not re-implementing the compression pipeline from WISH-2022
- Not implementing server-side WebP conversion (client-side only)

## Scope

**Components Affected:**
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts`

**Packages Affected:**
- `apps/web/app-wishlist-gallery`

**Configuration Changes:**
- Update `browser-image-compression` options from `fileType: 'image/jpeg'` to `fileType: 'image/webp'`
- Maintain existing compression settings (maxSizeMB: 1, maxWidthOrHeight: 1920, quality: 0.8)

## Acceptance Criteria

- [ ] AC1: Images are compressed to WebP format instead of JPEG by changing `fileType: 'image/webp'` in compression settings
- [ ] AC2: WebP compression quality is set to 0.8 (matching WISH-2022 JPEG quality)
- [ ] AC3: Compressed WebP images are 25-35% smaller than equivalent JPEG images at same visual quality
- [ ] AC4: Toast notification shows updated format: "Image compressed to WebP: X MB → Y MB"
- [ ] AC5: Original filename is preserved with `.webp` extension (e.g., `photo.jpg` → `photo.webp`)
- [ ] AC6: Image preview displays compressed WebP image correctly in all supported browsers
- [ ] AC7: S3 upload accepts WebP images with correct MIME type (`image/webp`)
- [ ] AC8: Backend API stores WebP image URL without modification (no format conversion)
- [ ] AC9: Browser compatibility check: Warn users on browsers without WebP support (Safari < 14, IE11)
- [ ] AC10: Compression fallback: If WebP compression fails, fall back to JPEG compression
- [ ] AC11: Unit tests verify WebP format output from imageCompression utility
- [ ] AC12: Integration tests verify useS3Upload hook uploads WebP images successfully
- [ ] AC13: Playwright E2E tests verify end-to-end WebP compression and upload workflow
- [ ] AC14: Documentation updated to reflect WebP as default output format

## Reuse Plan

- Builds on `imageCompression.ts` utility from WISH-2022
- Leverages existing `browser-image-compression` library (WebP support built-in)
- Reuses compression progress indicator from WISH-2022
- Reuses error handling and fallback logic from WISH-2022
- Reuses toast notification system from WISH-2022

## Architecture Notes

**WebP Configuration:**
```typescript
// Updated from WISH-2022
{
  maxSizeMB: 1,
  maxWidthOrHeight: 1920,
  useWebWorker: true,
  fileType: 'image/webp', // Changed from 'image/jpeg'
  initialQuality: 0.8
}
```

**Browser Compatibility:**
- Chrome 32+ (2014)
- Firefox 65+ (2019)
- Safari 14+ (2020)
- Edge 18+ (2018)
- Coverage: 97%+ of users

**Fallback Strategy:**
If WebP compression fails or browser doesn't support WebP:
1. Detect WebP support via canvas.toDataURL('image/webp')
2. Show warning: "Your browser doesn't support WebP. Using JPEG instead."
3. Fall back to JPEG compression from WISH-2022

**Migration Impact:**
- New uploads: Automatically compressed to WebP
- Existing images: Remain as JPEG (no retroactive conversion)
- No database schema changes required

## Test Plan

### Happy Path

1. User selects high-resolution image (5MB, 4032x3024)
2. Compression starts automatically
3. Progress indicator shows: "Compressing image... 45%"
4. Compression completes: "Image compressed to WebP: 5.2 MB → 0.5 MB" (vs 0.8 MB JPEG)
5. Preview updates with WebP image
6. User submits form
7. WebP image uploads to S3 with `image/webp` MIME type

### Error Cases

1. **WebP not supported**: Browser doesn't support WebP; fallback to JPEG compression with warning toast
2. **WebP compression fails**: If browser-image-compression throws error, fall back to JPEG compression
3. **Unsupported source format**: If source format can't be converted to WebP, fall back to JPEG

### Edge Cases

1. **Already WebP**: If user selects WebP image, compress with same settings (no conversion)
2. **Transparent images**: WebP supports transparency; PNG images with alpha channel preserve transparency
3. **HEIC/HEIF source**: If source is HEIC (from WISH-2045), convert to WebP instead of JPEG
4. **User preference**: "High quality (skip compression)" checkbox skips WebP conversion entirely

## Risks / Edge Cases

1. **Browser compatibility**: Safari < 14 and IE11 don't support WebP; mitigate with fallback to JPEG
2. **Quality perception**: WebP at 0.8 quality may have different visual characteristics than JPEG; acceptable for wishlist images
3. **Compression time**: WebP encoding may be 10-20% slower than JPEG; negligible for single-image uploads
4. **File extension confusion**: Users may not recognize `.webp` extension; mitigate with toast notification

## Open Questions

None - all requirements are clear and non-blocking.
