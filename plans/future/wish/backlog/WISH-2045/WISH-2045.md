---
doc_type: story
title: "WISH-2045: HEIC/HEIF Image Format Support"
story_id: WISH-2045
story_prefix: WISH
status: backlog
follow_up_from: WISH-2022
phase: 4
created_at: "2026-01-29T00:00:00-07:00"
updated_at: "2026-01-29T00:00:00-07:00"
depends_on: [WISH-2022]
estimated_points: 3
---

# WISH-2045: HEIC/HEIF Image Format Support

## Follow-up Context

**Parent Story:** WISH-2022: Client-side Image Compression
**Source:** QA Discovery Notes - Gaps Identified
**Original Finding:** Modern iPhones use HEIC by default; browser-image-compression needs plugin or server-side fallback for HEIC conversion
**Category:** Gap
**Impact:** High - Modern iPhone users (iOS 11+) default to HEIC format, blocking compression workflow
**Effort:** Medium - Requires additional library integration or server-side conversion

## Context

Since iOS 11 (2017), iPhones capture photos in High Efficiency Image Format (HEIC/HEIF) by default instead of JPEG. HEIC provides better compression than JPEG at equivalent quality, but browser support is limited and the `browser-image-compression` library from WISH-2022 cannot process HEIC files natively.

When users upload HEIC images:
- The compression workflow fails silently or throws errors
- Fallback to original upload works but uploads full-size HEIC files (3-5MB)
- S3 storage costs increase significantly
- Many browsers cannot display HEIC images in previews
- Users on non-Apple devices cannot view the images

This gap affects a significant portion of users (iPhone market share ~50% in US) and blocks the compression benefits from WISH-2022.

## Goal

Enable HEIC/HEIF image uploads with automatic conversion to JPEG during the compression workflow, ensuring all users can upload iPhone photos with compression benefits.

## Non-goals

- Not implementing native HEIC storage (convert to JPEG for compatibility)
- Not implementing HEIC display in browsers (rely on JPEG conversion)
- Not supporting other exotic image formats (focus on HEIC/HEIF only)
- Not re-implementing the core compression logic from WISH-2022
- Not implementing server-side HEIC conversion (client-side conversion only for MVP)

## Scope

**Components Affected:**
- `apps/web/app-wishlist-gallery/src/utils/imageCompression.ts`
- `apps/web/app-wishlist-gallery/src/hooks/useS3Upload.ts`

**Packages Affected:**
- `apps/web/app-wishlist-gallery`

**New Dependencies:**
- `heic2any` npm package (MIT license, 500KB) for client-side HEIC to JPEG conversion

## Acceptance Criteria

- [ ] HEIC/HEIF files are detected by MIME type (`image/heic`, `image/heif`) or file extension (`.heic`, `.heif`)
- [ ] HEIC files are automatically converted to JPEG using `heic2any` library before compression
- [ ] Conversion progress indicator shows: "Converting HEIC to JPEG... X%"
- [ ] Converted JPEG is passed to existing `browser-image-compression` workflow from WISH-2022
- [ ] Original filename is preserved with `.jpg` extension (e.g., `IMG_1234.heic` → `IMG_1234.jpg`)
- [ ] Conversion failures show error toast: "HEIC conversion failed. Try exporting as JPEG from Photos app."
- [ ] Conversion failures fall back to uploading original HEIC file (with warning toast)
- [ ] Browser compatibility check detects HEIC support via `heic2any` library capabilities
- [ ] Toast notification shows: "HEIC image converted to JPEG (X MB → Y MB)" after conversion
- [ ] Image preview updates with converted JPEG before compression
- [ ] Conversion happens before compression (sequential: HEIC → JPEG → compress → upload)
- [ ] "High quality (skip compression)" checkbox still skips compression but allows HEIC conversion
- [ ] Unit tests cover: HEIC detection logic, conversion success/failure, filename transformation
- [ ] Integration tests cover: HEIC → JPEG → compression workflow, fallback on conversion failure
- [ ] Playwright E2E tests cover: HEIC upload happy path, conversion failure handling, browser compatibility fallback
- [ ] Documentation updated: README notes HEIC support, Architecture docs show conversion flow

## Reuse Plan

- Builds on compression workflow from WISH-2022
- Reuses `imageCompression.ts` utility structure
- Leverages existing error handling patterns from WISH-2022
- Reuses upload progress indicator infrastructure
- Uses `heic2any` library (MIT license, actively maintained, 2M+ weekly downloads)

## Architecture Notes

**Conversion Flow:**
```
1. User selects image file
2. Detect HEIC/HEIF by MIME type or extension
3. If HEIC:
   a. Show "Converting HEIC to JPEG... X%"
   b. Convert using heic2any library
   c. Update filename to .jpg extension
   d. Show conversion toast
4. If conversion fails:
   a. Show error toast with guidance
   b. Fall back to original HEIC upload
5. Pass converted JPEG to existing compression flow (WISH-2022)
6. Continue with existing upload flow
```

**HEIC Detection:**
```typescript
function isHEIC(file: File): boolean {
  const heicMimeTypes = ['image/heic', 'image/heif']
  const heicExtensions = ['.heic', '.heif']

  return heicMimeTypes.includes(file.type) ||
         heicExtensions.some(ext => file.name.toLowerCase().endsWith(ext))
}
```

**Conversion Configuration:**
```typescript
import heic2any from 'heic2any'

const convertedBlob = await heic2any({
  blob: heicFile,
  toType: 'image/jpeg',
  quality: 0.9, // High quality for conversion (compression happens next)
})
```

**Error Handling Strategy:**
- Browser doesn't support HEIC conversion: Show warning, upload original HEIC
- Conversion timeout (>15 seconds): Show warning, allow user to cancel or upload original
- Conversion memory error: Show warning, suggest reducing image size in Photos app
- Corrupted HEIC file: Show error, reject upload

## Test Plan

### Happy Path

1. User selects HEIC image from iPhone (3.2 MB)
2. HEIC detection succeeds
3. Conversion starts: "Converting HEIC to JPEG... 45%"
4. Conversion completes: "HEIC image converted to JPEG (3.2 MB → 5.8 MB)"
5. Compression starts: "Compressing image... 60%"
6. Compression completes: "Image compressed: 5.8 MB → 0.9 MB"
7. Preview updates with compressed JPEG
8. User submits form
9. Compressed JPEG uploads to S3

### Error Cases

1. **Conversion fails**: Show error toast with guidance, fall back to original HEIC upload
2. **Browser doesn't support HEIC**: Detect via `heic2any` capabilities, show warning, upload original
3. **Conversion timeout**: If conversion takes > 15 seconds, show warning with cancel option
4. **Corrupted HEIC file**: `heic2any` throws error, show error toast, reject upload

### Edge Cases

1. **HEIC with transparency**: HEIC supports transparency; JPEG does not. Convert transparency to white background.
2. **Multi-image HEIC**: HEIC can contain multiple images (burst photos); `heic2any` extracts first image only
3. **Large HEIC files**: Files > 10MB may cause browser memory issues; show warning before conversion
4. **User disables compression**: "High quality" checkbox skips compression but still converts HEIC to JPEG for compatibility

## Risks / Edge Cases

1. **Browser memory limits**: HEIC conversion + compression may consume significant memory for large files; mitigate with size warnings
2. **Conversion quality loss**: HEIC → JPEG conversion at 0.9 quality should be visually lossless; verify with test images
3. **Browser compatibility**: `heic2any` uses WebAssembly; may not work in older browsers (IE11, old Safari); fallback required
4. **Conversion latency**: HEIC conversion adds 2-5 seconds for typical phone photos; acceptable for one-time upload
5. **HEIC metadata loss**: EXIF data (orientation, location) may be lost during conversion; acceptable for wishlist images
6. **File size increase**: HEIC → JPEG conversion can increase file size by 50-100% before compression; compression step mitigates this

## Open Questions

None - all requirements are clear and non-blocking.

---

## Notes for Implementation

- The `heic2any` library returns a Blob or Blob[], handle both cases
- HEIC files from iPhone typically have MIME type `image/heic` but some apps use `application/octet-stream`
- Filename extension detection is important as fallback for MIME type detection
- Consider adding telemetry to track HEIC conversion success/failure rates for future optimization
