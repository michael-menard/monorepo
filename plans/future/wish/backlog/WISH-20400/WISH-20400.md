---
status: backlog
follow_up_from: WISH-20210
doc_type: story
title: "WISH-20400: Real-time CI Integration for Schema Change Impact Analysis"
story_id: WISH-20400
story_prefix: WISH
phase: 3
created_at: "2026-01-31T02:30:00-07:00"
updated_at: "2026-01-31T02:30:00-07:00"
depends_on: [WISH-20210]
estimated_points: 3
---

# WISH-20400: Real-time CI Integration for Schema Change Impact Analysis

## Follow-up Context

**Parent Story:** WISH-20210
**Source:** QA Discovery Notes - Follow-up Stories Suggested (Finding #1)
**Original Finding:** "Real-time CI integration for schema change impact analysis (automated PR comments, blocking checks)"
**Category:** Enhancement Opportunity
**Impact:** High
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-20210 as a critical automation opportunity for schema change workflow. WISH-20210 provides a CLI tool for manual impact analysis, but developers must remember to run it. Integrating the tool into CI/CD pipelines ensures **every schema change PR** gets automatic impact analysis, catching issues before they reach production.

## Context

WISH-20210 establishes a CLI tool (`pnpm db:impact-analysis`) that analyzes proposed database schema changes and generates comprehensive impact reports. However, this tool requires manual execution, which leads to several operational risks:

1. **Forgotten Analysis**: Developers may forget to run impact analysis before submitting PRs
2. **Incomplete Reviews**: Reviewers lack automated context about schema change impacts
3. **Delayed Discovery**: Impact issues discovered late in review cycle or after merge
4. **Inconsistent Standards**: No enforced threshold for acceptable impact scope

By integrating the impact analysis tool into GitHub Actions CI pipelines, we can:

- **Automatically run impact analysis** on every PR that modifies Drizzle schema files
- **Post analysis reports as PR comments** for reviewer visibility
- **Block merges for high-impact changes** until manual approval is provided
- **Track schema change metrics** over time (impact scope, frequency, risk distribution)

This automation complements WISH-20210's manual tool by providing **automated guardrails** for schema evolution in CI/CD.

## Goal

Integrate the schema change impact analysis tool (from WISH-20210) into GitHub Actions CI/CD pipelines to automatically analyze schema changes, post impact reports as PR comments, and optionally block high-impact changes pending manual review.

## Non-goals

- Visual dependency graph UI (separate story - deferred from WISH-20210)
- Schema migration code generation (separate story - deferred from WISH-20210)
- Cross-repository impact analysis (single monorepo scope)
- Impact analysis for non-schema changes (e.g., API contract changes)
- Slack/Discord notifications (GitHub comments only in MVP)

## Scope

### GitHub Actions Workflow: `.github/workflows/schema-impact-analysis.yml`

```yaml
name: Schema Change Impact Analysis

on:
  pull_request:
    paths:
      - 'packages/backend/database-schema/src/schema/**/*.ts'
      - 'packages/backend/database-schema/migrations/**/*.sql'

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect schema changes
        id: detect
        run: |
          # Parse git diff to detect added/modified/removed columns, enums, constraints
          # Output: table name, operation, column/enum name
          node scripts/detect-schema-changes.ts

      - name: Run impact analysis
        id: analyze
        run: |
          pnpm db:impact-analysis \
            --table "${{ steps.detect.outputs.table }}" \
            --change "${{ steps.detect.outputs.operation }}" \
            --format json > impact-report.json

      - name: Post PR comment
        uses: actions/github-script@v6
        with:
          script: |
            const report = require('./impact-report.json')
            const comment = formatImpactReport(report)
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              body: comment
            })

      - name: Check impact threshold
        run: |
          # Exit with code 1 if high-impact change detected
          node scripts/check-impact-threshold.ts impact-report.json
```

### Detection Script: `scripts/detect-schema-changes.ts`

Parses `git diff` output to identify schema modifications:

- **Column changes**: `add-column`, `remove-column`, `rename-column`, `change-type`
- **Enum changes**: `add-enum-value`, `remove-enum-value`, `rename-enum-value`
- **Constraint changes**: `add-index`, `add-foreign-key`, `modify-constraint`

Outputs structured data for `pnpm db:impact-analysis`:

```json
{
  "table": "wishlist_items",
  "operation": "add-column:priority:text",
  "files_changed": ["packages/backend/database-schema/src/schema/wishlist.ts"]
}
```

### Impact Report Formatting: `scripts/format-impact-report.ts`

Converts JSON impact report to GitHub-flavored Markdown for PR comments:

```markdown
## ðŸ” Schema Change Impact Analysis

**Table:** `wishlist_items`
**Operation:** Add column `priority` (TEXT)
**Risk Level:** ðŸŸ¡ Medium

### Backend Impact (15 files)
- `apps/api/lego-api/domains/wishlist/application/services.ts`
- `apps/api/lego-api/domains/wishlist/adapters/repositories.ts`
- ...

### Frontend Impact (8 files)
- `apps/web/app-wishlist-gallery/src/components/WishlistCard/index.tsx`
- ...

### Test Impact (12 files)
- `apps/api/lego-api/domains/wishlist/__tests__/services.test.ts`
- ...

### Risk Assessment
- **Breaking Change:** No
- **Backward Compatibility:** Safe (optional column)
- **Rollback Safety:** Safe (old code ignores new column)
- **Deployment Order:** Database first, then app code

### Recommendations
1. Add `priority` field to `WishlistItemSchema` in `packages/core/api-client`
2. Update `wishlist-service.ts` to handle priority in create/update
3. Add priority input to `WishlistForm` component
4. Update all test fixtures with `priority: null`

---
*Generated by [Schema Impact Analysis Tool](LINK) from WISH-20210*
```

### Threshold Enforcement: `scripts/check-impact-threshold.ts`

Reads JSON impact report and applies blocking rules:

- **Block merge** if:
  - Breaking change detected (`breaking: true`)
  - High-impact change (>20 affected files)
  - Removes columns or enum values without deprecation notice
- **Pass with warning** if:
  - Medium-impact change (10-20 files)
  - Adds required columns without default values
- **Pass** if:
  - Low-impact change (<10 files)
  - Adds optional columns or enum values

Exits with code 1 to fail CI check for blocked changes.

### Packages Affected

- `.github/workflows/` - New `schema-impact-analysis.yml` workflow
- `scripts/` - New detection, formatting, and threshold scripts
- `packages/backend/database-schema/` - Reuses existing `pnpm db:impact-analysis` tool from WISH-20210

## Acceptance Criteria

### CI Workflow Basics (AC 1-5)

- [ ] AC 1: GitHub Actions workflow `schema-impact-analysis.yml` triggers on PRs modifying `packages/backend/database-schema/src/schema/**/*.ts`
- [ ] AC 2: Workflow installs dependencies and runs `pnpm db:impact-analysis` successfully
- [ ] AC 3: Workflow posts impact report as PR comment in GitHub-flavored Markdown format
- [ ] AC 4: Workflow exits with code 0 for low-impact changes, code 1 for high-impact/breaking changes
- [ ] AC 5: Workflow skips analysis if no schema files changed (via `paths` filter)

### Schema Change Detection (AC 6-9)

- [ ] AC 6: Detection script identifies column additions from `git diff` (e.g., new field in Drizzle schema)
- [ ] AC 7: Detection script identifies column removals from `git diff` (e.g., deleted field in Drizzle schema)
- [ ] AC 8: Detection script identifies enum value changes from `git diff` (e.g., new value in pgEnum)
- [ ] AC 9: Detection script outputs structured JSON for consumption by `pnpm db:impact-analysis`

### Impact Report Formatting (AC 10-13)

- [ ] AC 10: Formatting script converts JSON impact report to GitHub Markdown with sections: Backend Impact, Frontend Impact, Test Impact, Risk Assessment, Recommendations
- [ ] AC 11: PR comment includes risk level emoji indicator (ðŸŸ¢ Low, ðŸŸ¡ Medium, ðŸ”´ High)
- [ ] AC 12: PR comment includes clickable links to affected files (using PR's base branch)
- [ ] AC 13: PR comment includes footer with link to tool documentation and attribution to WISH-20210

### Threshold Enforcement (AC 14-17)

- [ ] AC 14: Threshold script exits with code 1 for breaking changes (`breaking: true` in report)
- [ ] AC 15: Threshold script exits with code 1 for high-impact changes (>20 affected files)
- [ ] AC 16: Threshold script exits with code 0 for low-impact changes (<10 affected files)
- [ ] AC 17: Threshold script logs clear error messages explaining why merge is blocked (e.g., "Breaking change detected: removes column X")

### Multi-change Scenarios (AC 18-20)

- [ ] AC 18: Workflow handles PRs with multiple schema file changes (runs analysis for each detected change)
- [ ] AC 19: Workflow aggregates multiple impact reports into single PR comment (sections per table/operation)
- [ ] AC 20: Workflow reports first blocking issue immediately (fails fast without analyzing remaining changes)

### Error Handling (AC 21-23)

- [ ] AC 21: Workflow posts error comment if impact analysis tool fails (e.g., invalid schema syntax)
- [ ] AC 22: Workflow posts error comment if detection script fails to parse `git diff` output
- [ ] AC 23: Workflow exits with code 1 on errors (fails CI check to prevent silent failures)

### Documentation (AC 24-26)

- [ ] AC 24: `.github/workflows/schema-impact-analysis.yml` includes inline comments explaining each step
- [ ] AC 25: `scripts/README.md` documents detection, formatting, and threshold scripts with usage examples
- [ ] AC 26: Update `packages/backend/database-schema/docs/IMPACT-ANALYSIS-TOOL.md` (from WISH-20210) with CI integration section

## Reuse Plan

### Existing Infrastructure

- **Impact Analysis Tool**: Reuses `pnpm db:impact-analysis` CLI from WISH-20210 (no modifications needed)
- **Drizzle Schema Parsing**: Reuses schema introspection utilities from WISH-20210
- **GitHub Actions Setup**: Follows existing CI patterns from `.github/workflows/ci.yml`
- **PR Comment Formatting**: Reuses Markdown utilities from existing documentation generators

### New Dependencies

- `@actions/github-script@v6` - GitHub Actions script integration (already in use)
- `simple-git` - Programmatic Git operations for diffing (new)
- `minimatch` - File path pattern matching (already in use via glob)

## Architecture Notes

### Detection Strategy: Git Diff Parsing

```typescript
// Conceptual approach for detecting schema changes
const detectSchemaChanges = async () => {
  const diff = await git.diff(['HEAD^', 'HEAD', '--', 'packages/backend/database-schema/src/schema/**/*.ts'])

  // Parse diff for:
  // - Added lines: + export const newColumn = varchar('new_column')
  // - Removed lines: - export const oldColumn = varchar('old_column')
  // - Modified lines: changed enum values, type modifications

  return {
    table: extractTableName(diff),
    operation: classifyOperation(diff), // add-column, remove-column, etc.
    details: extractOperationDetails(diff) // column name, type, etc.
  }
}
```

### Handling Multiple Changes in Single PR

**Scenario**: PR modifies 3 tables (`wishlist_items`, `users`, `sets`)

**Approach**:
1. Detection script outputs array of changes: `[{table: 'wishlist_items', ...}, {table: 'users', ...}, {table: 'sets', ...}]`
2. Workflow runs impact analysis for each change in parallel (matrix strategy)
3. Formatting script aggregates all reports into single PR comment with sections per table
4. Threshold script checks each report; blocks if ANY change exceeds threshold

### False Positive Mitigation

**Challenge**: Detection script may misidentify code comments or test fixtures as schema changes

**Mitigation**:
1. **AST Parsing**: Use TypeScript Compiler API to parse schema files (not regex on diff text)
2. **Validation**: Run `pnpm db:generate` to validate schema syntax before analysis
3. **Allowlist**: Only analyze files matching `packages/backend/database-schema/src/schema/*.ts` (exclude tests)

## Infrastructure Notes

### CI Performance Optimization

**Challenge**: Running full impact analysis on every schema change PR may slow CI

**Mitigation**:
1. **Caching**: Cache pnpm dependencies and TypeScript AST parsing results
2. **Early Exit**: Skip analysis if `git diff` shows no schema file changes (GitHub Actions `paths` filter)
3. **Parallel Jobs**: Run detection, analysis, and threshold checks concurrently where possible
4. **Selective Scanning**: Only scan files relevant to changed tables (not entire monorepo)

Target: CI workflow completes in <2 minutes for typical schema change PR

### Workflow Trigger Strategy

**Trigger on PR events**:
- `pull_request: [opened, synchronize, reopened]` - Initial PR and subsequent pushes
- `paths` filter: Only trigger if schema files modified

**Skip Trigger**:
- Draft PRs (use `if: github.event.pull_request.draft == false`)
- Bots/automated commits (use `if: github.actor != 'dependabot[bot]'`)

## Test Plan

### Unit Tests

**Test 1: Detection Script - Column Addition**
- Mock `git diff` output with added column
- Run detection script
- Assert output contains `{ table: 'wishlist_items', operation: 'add-column:priority:text' }`

**Test 2: Detection Script - Enum Value Addition**
- Mock `git diff` output with new enum value
- Run detection script
- Assert output contains `{ enum: 'wishlist_store', operation: 'add-value:Amazon' }`

**Test 3: Formatting Script - Low Impact**
- Mock JSON report with 5 affected files
- Run formatting script
- Assert Markdown output includes ðŸŸ¢ Low risk indicator

**Test 4: Threshold Script - Breaking Change**
- Mock JSON report with `breaking: true`
- Run threshold script
- Assert exits with code 1 and logs "Breaking change detected"

### Integration Tests

**Test 5: End-to-End Workflow (Simulated)**
- Create test PR branch with schema change (add `priority` column to `wishlist_items`)
- Run workflow locally using `act` (GitHub Actions local runner)
- Verify impact report posted as comment (mock GitHub API)
- Verify workflow exits with code 0 (low impact)

**Test 6: Multi-Change Aggregation**
- Create test PR branch modifying 2 tables (`wishlist_items`, `users`)
- Run workflow
- Verify single PR comment with 2 sections (one per table)

### Edge Cases

**Edge 1: No Schema Changes**
- Create PR modifying only frontend files
- Verify workflow skips execution (no comment posted)

**Edge 2: Invalid Schema Syntax**
- Create PR with malformed Drizzle schema (syntax error)
- Verify workflow posts error comment: "Failed to analyze schema changes: Invalid syntax in wishlist.ts"
- Verify workflow exits with code 1

**Edge 3: High-Impact Change (>20 files)**
- Mock impact report with 25 affected files
- Run threshold script
- Verify exits with code 1 and logs "High-impact change: 25 files affected. Manual review required."

## Risk Notes

### MVP-Critical Risks

**Risk 1: Detection Script Accuracy**
- Git diff parsing may miss complex schema changes (e.g., renamed tables, multi-line enum definitions)
- **Mitigation**: Use TypeScript AST parsing instead of regex on diff text; add comprehensive unit tests for detection edge cases

**Risk 2: PR Comment Spam**
- Multiple commits to same PR may trigger duplicate comments
- **Mitigation**: Use GitHub API to update existing comment instead of creating new ones (find comment by header signature)

**Risk 3: CI Performance Degradation**
- Large PRs with many schema changes may slow CI significantly (>5 minutes)
- **Mitigation**: Implement selective scanning (only analyze changed tables); add caching for AST parsing

### Non-MVP Risks

**Risk 4: Threshold Tuning**
- Hardcoded thresholds (>20 files = high impact) may be too strict or too lenient
- **Mitigation**: Make thresholds configurable via environment variables; gather metrics over time to tune

**Risk 5: Workflow Maintenance Burden**
- Schema detection logic requires updates when Drizzle syntax changes or new schema patterns emerge
- **Mitigation**: Document workflow internals; add tests for new schema patterns as they arise

## Definition of Done

- [ ] All 26 Acceptance Criteria verified
- [ ] GitHub Actions workflow `schema-impact-analysis.yml` functional and tested with test PR
- [ ] Detection script parses `git diff` and identifies column/enum changes
- [ ] Formatting script converts JSON reports to GitHub Markdown
- [ ] Threshold script enforces blocking rules for high-impact/breaking changes
- [ ] Unit tests pass (4+ scenarios: detection, formatting, threshold logic)
- [ ] Integration test validates end-to-end workflow using `act` or test repository
- [ ] Documentation updated (`IMPACT-ANALYSIS-TOOL.md` CI integration section, `scripts/README.md`)
- [ ] Sample PR created demonstrating workflow in action
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~5k | â€” | â€” | Follow-up generation with CI integration scope |
| Implementation | ~12k | â€” | â€” | Detection script + formatting script + threshold logic + workflow |
| Testing | ~6k | â€” | â€” | Unit tests + integration test with act |
| Review | ~3k | â€” | â€” | Code review + documentation review |
| **Total** | ~26k | â€” | â€” | â€” |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-31 02:30 | pm-story-followup-leader | Created follow-up story from WISH-20210 finding #1 (Real-time CI integration for schema change impact analysis) | WISH-20400.md |

---

## Future Enhancement Notes

Once this CI integration exists, consider:

- **Slack/Discord Notifications**: Post impact reports to team channels for visibility
- **Impact Trend Dashboard**: Track schema change frequency, risk distribution, and impact scope over time
- **Automated Reviewer Assignment**: Auto-assign DBAs or backend leads for high-impact schema changes
- **Schema Migration Verification**: Validate that migration SQL matches detected schema changes
- **Impact Prediction ML Model**: Use historical data to predict effort and risk more accurately

---

## Open Questions

None (all clarified during story generation).
