---
doc_type: story
title: "WISH-20250: Bulk schedule creation (multiple schedules in single API call)"
story_id: WISH-20250
story_prefix: WISH
status: backlog
phase: 4
created_at: "2026-01-30T00:00:00Z"
updated_at: "2026-01-30T00:00:00Z"
depends_on: [WISH-2119]
follow_up_from: WISH-2119
estimated_points: 2
sizing_warning: false
---

# WISH-20250: Bulk schedule creation (multiple schedules in single API call)

## Follow-up Context

**Parent Story:** WISH-2119 (Flag scheduling)
**Source:** QA Discovery Notes - Enhancement Opportunity #3
**Original Finding:** "Bulk schedule creation - Deferred to Phase 4+ follow-up story"
**Category:** Enhancement Opportunity
**Impact:** Medium (Operational efficiency for admins managing complex rollout schedules)
**Effort:** Low (Extension of existing schedule creation endpoint)

## Context

WISH-2119 implemented one-time flag scheduling with admin endpoints for creating, listing, and cancelling schedules. The MVP implementation requires one API call per schedule, which becomes inefficient when admins need to create multiple schedules for coordinated feature rollouts.

Common use cases requiring multiple schedules:
- **Phased rollouts**: Create 5 schedules to gradually increase rollout percentage (0% → 25% → 50% → 75% → 100%)
- **Multi-flag coordination**: Enable multiple related flags simultaneously (e.g., "wishlist-ui", "wishlist-api", "wishlist-notifications")
- **Time-windowed features**: Create enable/disable schedule pairs for temporary features (e.g., holiday promotion starts Dec 1, ends Jan 1)
- **Multi-environment rollouts**: Schedule same flag changes across dev/staging/production with time offsets

Without bulk creation, admins must make N sequential API calls, increasing network overhead, transaction complexity, and error risk (partial creation failures leave inconsistent state).

## Goal

Enable admins to create multiple flag schedules in a single atomic API call, reducing operational overhead and ensuring consistency for coordinated rollout scenarios.

## Non-goals

- **Bulk cancellation** (multiple DELETE requests in one call) - defer to future story
- **Bulk updates** (modify existing schedules) - defer to future story
- **Cross-flag bulk operations** (create schedules for multiple flags in one call) - single flag only in MVP
- **Async bulk processing** (background job for large batches) - synchronous processing only in MVP (max 50 schedules per request)
- **Validation rollback on partial failure** - all-or-nothing atomic transactions only

## Scope

### Endpoints Affected

**New Endpoint:**
- `POST /api/admin/flags/:flagKey/schedule/bulk` - Create multiple schedules atomically (admin only)

**Reused from WISH-2119:**
- Schedule validation logic (Zod schemas, date validation, update validation)
- Schedule repository (database adapter, row-level locking)
- Admin auth middleware for authorization checks

### Packages Affected

1. **Backend - Config Domain**: `apps/api/lego-api/domains/config/`
   - `application/schedule-service.ts` - Extend with bulk creation logic
   - `adapters/schedule-repository.ts` - Add batch insert method
   - `routes.ts` - Add bulk endpoint route
   - `types.ts` - Add BulkScheduleRequest/Response Zod schemas

2. **Shared Schemas**: `packages/core/api-client/src/schemas/`
   - `feature-flags.ts` - Export bulk schedule schemas for frontend

### Infrastructure Impact

**Database:**
- Reuse existing `feature_flag_schedules` table from WISH-2119
- Batch INSERT for all schedules in single transaction
- Rollback entire batch on any validation/constraint violation

**Transaction Guarantees:**
- All schedules created OR none created (atomic)
- Database transaction ensures consistency
- No partial creation states

## Acceptance Criteria

### Backend - Bulk Schedule Service

**AC1**: Bulk schedule endpoint validation
- Endpoint: `POST /api/admin/flags/:flagKey/schedule/bulk`
- Request body validated with Zod: `{ schedules: Array<{ scheduledAt: ISO8601, updates: { enabled?: boolean, rolloutPercentage?: number } }> }`
- schedules array minimum length: 1 (error if empty array)
- schedules array maximum length: 50 (error if > 50, defer large batches to async processing)
- Each schedule item validated same as WISH-2119 single creation (scheduledAt future, updates non-empty, rolloutPercentage 0-100)
- Response: 201 Created with array of created schedule objects
- Zod schema: `BulkCreateScheduleRequestSchema`, `BulkScheduleResponseSchema`

**AC2**: Atomic batch creation
- All schedules inserted in single database transaction
- If any schedule fails validation or constraint check, entire batch rolled back
- No partial creation states (all-or-nothing)
- Returns 400 Bad Request with validation errors if any schedule invalid
- Returns 201 Created with all schedule IDs if successful

**AC3**: Bulk schedule database persistence
- Use batch INSERT statement for efficiency (single query, not N queries)
- Foreign key validates flagKey exists in feature_flags table
- Returns 404 if flag does not exist
- All schedules get status = 'pending'
- Timestamps (created_at, updated_at) auto-populated for all schedules

**AC4**: Duplicate detection within batch
- Reject batch if any two schedules have identical scheduledAt times (millisecond precision)
- Return 400 Bad Request with error message: "Duplicate scheduledAt times detected in batch"
- Prevent conflicting flag states at same execution time

**AC5**: Admin authorization enforcement
- Bulk endpoint requires admin role (same as WISH-2119 single creation)
- Reuse auth middleware from `apps/api/lego-api/middleware/auth.ts`
- Verify JWT contains admin role before allowing bulk creation
- Return 403 Forbidden for non-admin users
- Integration test: non-admin user receives 403

### Schema & Types

**AC6**: Zod schemas for bulk schedules
- `BulkCreateScheduleRequestSchema`: Validation for POST request body (array of schedule items)
- `BulkScheduleResponseSchema`: API response format (array of created schedules)
- Each schedule item schema reuses `CreateScheduleRequestSchema` from WISH-2119
- All types inferred from Zod: `type BulkScheduleRequest = z.infer<typeof BulkCreateScheduleRequestSchema>`

**AC7**: Frontend/backend schema alignment
- Backend schemas defined in `apps/api/lego-api/domains/config/types.ts`
- Schemas re-exported in `packages/core/api-client/src/schemas/feature-flags.ts`
- Frontend imports from `@repo/api-client`
- Alignment test verifies schemas match

### Testing

**AC8**: Backend unit tests (minimum 8 tests)
- Bulk service: Create 2 schedules, assert both created
- Bulk service: Create 5 schedules (phased rollout), assert all created in order
- Validation: Empty array rejected (400)
- Validation: Array > 50 schedules rejected (400)
- Validation: Duplicate scheduledAt times rejected (400)
- Validation: One invalid schedule rolls back entire batch (400)
- Authorization: Non-admin receives 403
- Zod schema validation tests

**AC9**: Backend integration tests (HTTP file)
- File: `__http__/feature-flag-scheduling.http` (extend existing from WISH-2119)
- Test: Bulk create 3 schedules (assert 201, array with 3 schedule IDs, all status = 'pending')
- Test: Bulk create with duplicate times (assert 400)
- Test: Bulk create with one invalid schedule (assert 400, no schedules created)
- Test: Unauthorized access (assert 403 for non-admin)
- Test: Invalid flag (assert 404 for non-existent flag)
- Test: Empty array (assert 400)

**AC10**: Database transaction test
- Create bulk request with 5 valid schedules + 1 invalid schedule (past scheduledAt)
- Assert entire batch rolled back (0 schedules created in database)
- Assert response 400 Bad Request with validation error for invalid schedule

## Reuse Plan

### Existing Components (Extended)
- Schedule validation logic from WISH-2119 (Zod schemas, date/update validation)
- Schedule repository from WISH-2119 (database adapter, extend with batch insert)
- Admin auth middleware from `apps/api/lego-api/middleware/auth.ts`
- Database transaction patterns from existing services
- Schedule service from WISH-2119 (extend with bulk creation method)

### New Components
- `createBulkSchedules()` method in schedule-service.ts
- `batchInsertSchedules()` method in schedule-repository.ts
- Bulk endpoint route in routes.ts
- Bulk Zod schemas in types.ts

### Existing Patterns
- Hexagonal architecture (ports & adapters)
- Zod-first type definitions
- Hono routes with middleware
- Database transactions for atomicity
- Batch INSERT for efficiency

## Architecture Notes

### Hexagonal Architecture Compliance

**Domain Layer** (Business Logic):
- `apps/api/lego-api/domains/config/application/schedule-service.ts`
  - Add `createBulkSchedules()` method
  - Validate all schedules before persistence
  - Pure business logic - no HTTP/database coupling

**Adapter Layer** (Infrastructure):
- `apps/api/lego-api/domains/config/adapters/schedule-repository.ts`
  - Add `batchInsertSchedules()` method
  - Database transaction management
  - Batch INSERT for efficiency

**Port Layer** (Contracts):
- `apps/api/lego-api/domains/config/types.ts`
  - Define `BulkCreateScheduleRequest`, `BulkScheduleResponse` types
  - Define Zod schemas for validation

**No Architecture Violations:** Story extends existing config domain following established patterns from WISH-2119.

## Test Plan

### Scope Summary
- **Endpoints:** 1 new admin endpoint (POST bulk schedule)
- **UI Touched:** No (backend only)
- **Data/Storage:** Yes (feature_flag_schedules table batch inserts)
- **Infrastructure:** Database transactions for atomicity

### Happy Path Tests

1. **Create 2 schedules**: POST bulk with 2 schedules, assert 201 and both created
2. **Create 5-phase rollout**: POST bulk with 5 schedules (0%, 25%, 50%, 75%, 100%), assert all created in chronological order
3. **Cron job processes bulk schedules**: Verify schedules created via bulk endpoint are processed same as single-creation schedules

### Error Cases

1. **Unauthorized access**: Non-admin user POST bulk, assert 403 Forbidden
2. **Invalid flag key**: POST bulk for non-existent flag, assert 404 Not Found
3. **Empty array**: POST bulk with empty schedules array, assert 400 Bad Request
4. **Array too large**: POST bulk with 51 schedules, assert 400 Bad Request (max 50)
5. **Duplicate times**: POST bulk with two schedules at same time, assert 400 Bad Request
6. **One invalid schedule**: POST bulk with 4 valid + 1 invalid (past time), assert 400 and no schedules created
7. **Transaction rollback**: Verify database has 0 schedules after partial failure

### Edge Cases

1. **Maximum batch size**: Create 50 schedules (boundary test), assert all created
2. **Minimum batch size**: Create 1 schedule via bulk endpoint, assert created (same as single creation)
3. **Mixed updates**: Bulk create with some schedules updating enabled, others updating rolloutPercentage, assert all applied correctly
4. **Chronological order**: Bulk create with unordered scheduledAt times, verify cron processes in chronological order (not insertion order)

### Required Tooling Evidence

**Backend HTTP Tests (`__http__/feature-flag-scheduling.http`):**
- Minimum 6 HTTP requests for bulk endpoint (extend existing WISH-2119 file)
- Assert status codes: 201, 400, 403, 404
- Assert bulk response: array of schedule objects with IDs, status = 'pending'

**Backend Integration Tests:**
- Transaction rollback: Verify partial failures leave clean state
- Batch INSERT efficiency: Assert single database query (not N queries)

**Frontend Tests:**
- N/A (no user-facing UI)

## Risks & Mitigations

### MVP-Critical Risks

1. **Batch size limits**
   - Risk: Large batches (> 50 schedules) may exceed Lambda timeout or transaction limits
   - Mitigation: Enforce max 50 schedules per request, document limit in API docs
   - Severity: Low (50 schedules sufficient for MVP use cases)

2. **Transaction deadlocks**
   - Risk: Concurrent bulk creation for same flag may cause database deadlocks
   - Mitigation: Row-level locking from WISH-2119 prevents concurrent writes to same flag
   - Severity: Low (admin coordination expected)

3. **Partial failure UX**
   - Risk: Admins may not realize entire batch was rolled back on validation error
   - Mitigation: Clear error messages specifying "Bulk creation failed: all schedules rolled back"
   - Severity: Low (admin can retry entire batch)

4. **Duplicate detection edge case**
   - Risk: Schedules at same millisecond may cause unexpected flag states
   - Mitigation: Validation rejects duplicate times, document 1-second minimum spacing recommendation
   - Severity: Low (admin error prevention)

## Open Questions

None - all decisions finalized for MVP scope.

## Definition of Done

- [ ] All 10 Acceptance Criteria pass
- [ ] Backend: 8+ unit tests pass (bulk service, validation, authorization)
- [ ] Backend: HTTP integration tests pass (`.http` file with 6+ bulk requests)
- [ ] Backend: Transaction rollback integration test passes
- [ ] Schema alignment test passes (frontend ↔ backend)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved

## HTTP Contract Plan

### POST /api/admin/flags/:flagKey/schedule/bulk

**Request:**
```json
{
  "schedules": [
    {
      "scheduledAt": "2026-01-30T15:00:00Z",
      "updates": {
        "enabled": true,
        "rolloutPercentage": 25
      }
    },
    {
      "scheduledAt": "2026-01-30T16:00:00Z",
      "updates": {
        "rolloutPercentage": 50
      }
    },
    {
      "scheduledAt": "2026-01-30T17:00:00Z",
      "updates": {
        "rolloutPercentage": 100
      }
    }
  ]
}
```

**Response (201 Created):**
```json
{
  "schedules": [
    {
      "id": "a1b2c3d4-...",
      "flagKey": "wishlist-gallery",
      "scheduledAt": "2026-01-30T15:00:00Z",
      "status": "pending",
      "updates": {
        "enabled": true,
        "rolloutPercentage": 25
      },
      "createdAt": "2026-01-30T10:00:00Z"
    },
    {
      "id": "e5f6g7h8-...",
      "flagKey": "wishlist-gallery",
      "scheduledAt": "2026-01-30T16:00:00Z",
      "status": "pending",
      "updates": {
        "rolloutPercentage": 50
      },
      "createdAt": "2026-01-30T10:00:00Z"
    },
    {
      "id": "i9j0k1l2-...",
      "flagKey": "wishlist-gallery",
      "scheduledAt": "2026-01-30T17:00:00Z",
      "status": "pending",
      "updates": {
        "rolloutPercentage": 100
      },
      "createdAt": "2026-01-30T10:00:00Z"
    }
  ]
}
```

**Error Responses:**
- 400 Bad Request: Empty array, array > 50 schedules, duplicate scheduledAt times, any schedule validation failure (entire batch rolled back)
- 403 Forbidden: Non-admin user
- 404 Not Found: Flag does not exist

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Generation | ~8k | — | — | Follow-up from WISH-2119 |
| Elaboration | ~6k | — | — | Extension of existing infrastructure |
| Implementation | ~10k | — | — | Backend endpoint + batch logic + tests |
| Code Review | ~4k | — | — | Small extension story |
| **Total** | ~28k | — | — | Small-sized story |

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-30 00:00 | pm-story-followup-leader | Generated follow-up story from WISH-2119 finding #4 | WISH-20250.md |
