---
status: backlog
follow_up_from: WISH-20180
---

# WISH-20380: Migration Performance Profiling

## Follow-up Context

**Parent Story:** WISH-20180
**Source:** QA Discovery Notes (Enhancement Opportunity #3)
**Original Finding:** "Migration performance profiling - Estimate migration execution time on production-sized datasets"
**Category:** Enhancement Opportunity
**Impact:** Medium
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-20180 as an enhancement to provide migration performance visibility before production deployment. WISH-20180 establishes CI validation for schema changes, but does not predict how long migrations will take to execute on production-scale data. This story adds tooling to estimate migration execution time on realistic datasets.

## Context

WISH-20180 validates schema changes against policy (breaking changes, naming conventions, concurrent index creation), but cannot predict migration execution time. Long-running migrations can cause:

- Extended downtime during deployment windows
- Application timeouts if migration exceeds Lambda timeout
- Table locks blocking concurrent reads/writes
- Unexpected performance degradation in production

Without performance profiling, developers have no visibility into migration runtime until deployment to production. This creates:
- Risk of production incidents from slow migrations
- No ability to plan maintenance windows appropriately
- No data-driven decisions on whether to split large migrations
- Lack of awareness when migrations require zero-downtime strategies

This story implements tooling to profile migration execution time against production-sized datasets in a test environment, providing developers with estimates before merging schema changes.

## Goal

Implement migration performance profiling tooling that estimates execution time of schema changes on production-sized datasets. Provide developers with runtime estimates, execution plan analysis, and warnings for long-running migrations during PR review.

## Non-goals

- Implementing zero-downtime migration strategies (future enhancement)
- Automated migration splitting (future enhancement)
- Production migration monitoring (separate observability story)
- Query performance optimization (separate database tuning story)
- Load testing infrastructure (separate infrastructure concern)

## Scope

### Profiling Script Implementation

1. **Performance Profiling Script** (`packages/backend/database-schema/scripts/profile-migration.ts`)
   - Accepts migration file path as argument
   - Creates isolated test database with production-scale seed data
   - Executes migration and measures total runtime
   - Analyzes PostgreSQL EXPLAIN output for execution plan
   - Generates performance report with warnings
   - Cleans up test database after profiling

2. **Seed Data Generator** (`packages/backend/database-schema/scripts/seed-prod-scale-data.ts`)
   - Generates realistic production-scale datasets (configurable via environment)
   - Default: 100K wishlist_items, 10K users, 5K sets (based on production projections)
   - Maintains referential integrity (foreign keys, constraints)
   - Supports custom seed sizes via `SEED_SCALE` environment variable

3. **CI Workflow Integration** (`.github/workflows/schema-validation.yml`)
   - Extends WISH-20180 workflow to run profiling on migrations
   - Posts performance report as PR comment alongside validation results
   - Warns if migration exceeds thresholds (>30s for small, >5min for large)
   - Fails CI if migration exceeds critical threshold (>10min)

### Performance Analysis Features

- **Execution Time Measurement**: Total runtime in milliseconds
- **EXPLAIN Analysis**: PostgreSQL query plan inspection for table scans, index usage
- **Lock Detection**: Identifies table locks (ALTER TABLE, DROP TABLE)
- **Index Creation Profiling**: Estimates CONCURRENTLY vs non-CONCURRENTLY runtime
- **Row Count Impact**: Correlates migration runtime with affected row counts
- **Threshold Warnings**: Flags migrations exceeding time limits

### Packages Affected

- `.github/workflows/` - Enhanced schema validation workflow with profiling
- `packages/backend/database-schema/scripts/` - Profiling and seed scripts
- `packages/backend/database-schema/docs/` - Performance profiling documentation

### Cross-References

- WISH-20180: Parent story with CI validation (profiling extends this workflow)
- WISH-2057: Schema evolution policies (profiling enforces performance constraints)
- Future zero-downtime migration stories (profiling informs strategy selection)

## Acceptance Criteria

### Profiling Script (AC 1-6)

- [ ] AC 1: Script accepts migration file path as CLI argument
- [ ] AC 2: Script creates isolated test database with unique name (e.g., `test_migration_20250131_123456`)
- [ ] AC 3: Script seeds production-scale data using configurable `SEED_SCALE` environment variable
- [ ] AC 4: Script executes migration and captures total runtime in milliseconds
- [ ] AC 5: Script analyzes EXPLAIN output for execution plan details (scans, indexes, locks)
- [ ] AC 6: Script cleans up test database after profiling (success or failure)

### Seed Data Generator (AC 7-10)

- [ ] AC 7: Generator creates realistic production-scale datasets with referential integrity
- [ ] AC 8: Default seed size: 100K wishlist_items, 10K users, 5K sets (configurable)
- [ ] AC 9: Generator supports custom seed sizes via `SEED_SCALE` environment variable (e.g., `SEED_SCALE=small` for 10K items)
- [ ] AC 10: Generator completes seeding in < 60 seconds for default scale

### Performance Report (AC 11-15)

- [ ] AC 11: Report includes total runtime, affected row count, execution plan summary
- [ ] AC 12: Report warns if migration exceeds 30 seconds (small migrations) or 5 minutes (large migrations)
- [ ] AC 13: Report identifies table locks (ALTER TABLE, DROP TABLE) and warns about production impact
- [ ] AC 14: Report recommends zero-downtime strategies for long-running migrations (>5min)
- [ ] AC 15: Report posted as PR comment alongside WISH-20180 validation results

### CI Integration (AC 16-18)

- [ ] AC 16: CI workflow runs profiling script after validation passes (from WISH-20180)
- [ ] AC 17: CI fails if migration exceeds critical threshold (>10 minutes)
- [ ] AC 18: CI passes with warnings if migration exceeds warning threshold but not critical (30s-10min)

### Documentation (AC 19-20)

- [ ] AC 19: Performance profiling guide added to `packages/backend/database-schema/docs/MIGRATION-PROFILING.md`
- [ ] AC 20: Documentation includes example reports, threshold explanations, and zero-downtime strategy references

## Reuse Plan

### Existing Tools

- **PostgreSQL EXPLAIN**: Use built-in query plan analysis
- **Drizzle Migration System**: Read migration files and meta/_journal.json
- **WISH-20180 CI Workflow**: Extend existing schema validation workflow
- **Test Database Infrastructure**: Reuse test database creation patterns

### Industry Patterns

- **Migration Profiling**: Reference Rails Strong Migrations profiling approach
- **Seed Data**: Follow patterns from Faker.js for realistic test data
- **CI Performance Gates**: Reference GitHub's approach to blocking slow queries

## Architecture Notes

### Performance Profiling Flow

```typescript
// packages/backend/database-schema/scripts/profile-migration.ts
async function profileMigration(migrationPath: string) {
  const testDbName = `test_migration_${Date.now()}`

  // 1. Create isolated test database
  await createTestDatabase(testDbName)

  // 2. Seed production-scale data
  await seedProductionScaleData(testDbName)

  // 3. Execute migration with timing
  const startTime = performance.now()
  await executeMigration(testDbName, migrationPath)
  const runtime = performance.now() - startTime

  // 4. Analyze execution plan
  const plan = await analyzeExplain(testDbName, migrationPath)

  // 5. Generate performance report
  const report = generateReport({ runtime, plan, affectedRows })

  // 6. Cleanup test database
  await dropTestDatabase(testDbName)

  return report
}
```

### Execution Plan Analysis

```sql
-- For ALTER TABLE migrations, analyze impact
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
ALTER TABLE wishlist_items ADD COLUMN new_field TEXT DEFAULT 'default';

-- Output includes:
-- - Execution time (actual)
-- - Rows affected
-- - Lock types acquired
-- - Index scans vs sequential scans
```

### Performance Thresholds

| Migration Type | Warning Threshold | Critical Threshold | Zero-Downtime Required |
|----------------|-------------------|--------------------|------------------------|
| Small (ADD COLUMN, ENUM) | 30s | 10min | No |
| Medium (INDEX, TYPE CHANGE) | 5min | 10min | Recommended |
| Large (DROP COLUMN, TABLE) | 5min | 10min | Yes |

### Seed Data Strategy

```typescript
// Generate production-scale data
const scales = {
  small: { users: 1_000, items: 10_000, sets: 500 },
  medium: { users: 10_000, items: 100_000, sets: 5_000 },
  large: { users: 50_000, items: 500_000, sets: 25_000 },
}

const scale = scales[process.env.SEED_SCALE || 'medium']
```

## Test Plan

### Profiling Script Tests

**Test 1: Small Migration Profiling**
- Create migration: `ADD COLUMN optional_field TEXT`
- Run profiling script with small seed data (1K items)
- Verify runtime < 5 seconds
- Verify report includes execution plan

**Test 2: Large Migration Profiling**
- Create migration: `ALTER TABLE wishlist_items ALTER COLUMN price TYPE NUMERIC(10,2)`
- Run profiling script with medium seed data (100K items)
- Verify runtime captured accurately
- Verify report warns if exceeds threshold

**Test 3: Index Creation Profiling**
- Create migration: `CREATE INDEX CONCURRENTLY idx_user_id ON wishlist_items(user_id)`
- Run profiling script
- Verify execution plan shows index creation strategy
- Verify report includes concurrent index notes

**Test 4: Test Database Cleanup**
- Run profiling script
- Verify test database dropped after execution
- Verify cleanup occurs even if migration fails

### Seed Data Generator Tests

**Test 5: Default Seed Scale**
- Run seed generator without SEED_SCALE env var
- Verify 100K items, 10K users, 5K sets created
- Verify referential integrity maintained
- Verify seeding completes in < 60 seconds

**Test 6: Custom Seed Scale**
- Run seed generator with `SEED_SCALE=small`
- Verify 10K items, 1K users, 500 sets created
- Verify seeding completes in < 10 seconds

### CI Integration Tests

**Test 7: CI Performance Gate**
- Create PR with slow migration (>10min threshold)
- Trigger CI workflow
- Verify workflow fails with performance warning
- Verify PR comment includes performance report

**Test 8: CI Warning Threshold**
- Create PR with migration taking 2 minutes
- Trigger CI workflow
- Verify workflow passes with warning
- Verify PR comment flags performance concern

### Edge Cases

**Edge 1: Migration Timeout**
- Create migration that exceeds Lambda timeout (15min)
- Run profiling script
- Verify script times out gracefully
- Verify report warns about deployment risk

**Edge 2: Missing Seed Data**
- Run profiling script with empty database
- Verify script warns about unrealistic profiling results
- Verify report notes low row count impact

**Edge 3: Multiple Migrations in PR**
- Create PR with 3 migrations
- Run profiling script on each
- Verify aggregated performance report posted to PR
- Verify cumulative runtime calculated

## Risk Notes

### MVP-Critical Risks

**Risk 1: Profiling Accuracy**
- Test database may not reflect production performance (different hardware, caching)
- **Mitigation**: Document profiling as estimates, not guarantees; recommend load testing for critical migrations

**Risk 2: CI Performance Overhead**
- Profiling adds significant latency to CI pipeline (seed data + migration execution)
- **Mitigation**: Run profiling only on migrations, not all PRs; use parallel CI jobs; cache seed data

**Risk 3: Seed Data Realism**
- Generated seed data may not match production data distribution
- **Mitigation**: Base seed data on production analytics; support custom seed scripts

### Non-MVP Risks

**Risk 4: Threshold Tuning**
- Performance thresholds may be too strict or too lenient
- **Mitigation**: Make thresholds configurable; iterate based on production deployment feedback

**Risk 5: Test Database Resource Consumption**
- Multiple parallel CI jobs may exhaust database connection pool
- **Mitigation**: Use isolated test databases; limit parallel profiling jobs; cleanup aggressively

## Definition of Done

- [ ] All 20 Acceptance Criteria verified
- [ ] Profiling script implemented with unit tests
- [ ] Seed data generator tested with multiple scales
- [ ] CI workflow extended to include profiling
- [ ] Performance report format documented
- [ ] Profiling guide added to docs/
- [ ] Tested on 5+ real migration examples
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~3k | — | — | Follow-up generation |
| Implementation | ~10k | — | — | Profiling script + seed generator + CI |
| Review | ~2k | — | — | Testing and documentation |
| **Total** | ~15k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-31 12:00 | pm-story-followup-leader | Created follow-up story from WISH-20180 finding #3 | WISH-20380.md |

---

## Future Enhancement Notes

Once this profiling tooling is implemented, consider:
- Zero-downtime migration strategies (online schema changes)
- Automated migration splitting (break large migrations into smaller chunks)
- Production migration monitoring (track runtime, rollback triggers)
- Query performance optimization recommendations (suggest indexes, query rewrites)

---

## Open Questions

_Should be empty or non-blocking for backlog story_

None - all dependencies and requirements clear from WISH-20180 context.
