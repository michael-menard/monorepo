---
doc_type: story
title: "WISH-20193: Schema Drift Detection - CI/CD Integration"
story_id: WISH-20193
story_prefix: WISH
status: backlog
phase: 2
created_at: "2026-01-31T10:17:00-07:00"
updated_at: "2026-01-31T10:17:00-07:00"
depends_on: [WISH-20191, WISH-20192]
split_from: WISH-20190
split_part: 3 of 3
estimated_points: 2
---

# WISH-20193: Schema Drift Detection - CI/CD Integration

## Split Context

This story is part of a split from WISH-20190.
- **Original Story:** WISH-20190 (Schema Drift Detection Tool)
- **Split Reason:** Scope expansion during QA elaboration (8 new features added via user decisions). CI/CD integration separated from core tool for Phase 2 infrastructure work.
- **This Part:** 3 of 3 (CI/CD integration)
- **Dependencies:**
  - WISH-20191 (MVP - Core drift detection with db:check command) - Required for base drift detection
  - WISH-20192 (Advanced Features) - Required for remediation and severity classification
- **Related Stories:**
  - WISH-20191 (MVP - Core drift detection)
  - WISH-20192 (Advanced Features - .driftignore, remediation, verbose mode, tracking)

## Context

While WISH-20191 provides drift detection capabilities and WISH-20192 adds remediation and tracking, these are reactive tools that require manual execution. In production environments, schema drift should be prevented proactively at deployment time.

CI/CD integration enables:
1. **Deployment Gates**: Block deployments if target environment has schema drift
2. **Severity-Based Policies**: Allow warnings but block on errors (configurable per environment)
3. **Automated Drift Checks**: Run drift detection on every deployment pipeline
4. **Pre-Deployment Validation**: Catch drift before code is deployed to production

This story integrates the drift detection tool into GitHub Actions workflows, providing deployment-time enforcement of schema consistency policies established in WISH-2057.

## Goal

Integrate drift detection into CI/CD pipelines with deployment blocking capabilities and configurable drift severity levels. Enables enforcement of schema consistency policies in deployment workflows.

## Non-goals

- Real-time drift monitoring dashboard (separate observability concern)
- Integration with non-GitHub CI/CD platforms (focus on GitHub Actions first; others can be added later)
- Automated drift remediation during deployment (too risky; remediation should be manual)
- Multi-region drift detection (focus on single environment per deployment)
- Drift notifications via Slack/email (separate observability concern)

## Scope

### Drift Severity Levels (AC 26)

Classify detected drift by severity to enable configurable deployment policies:

**Severity Levels:**
- **ERROR**: Critical drift that indicates schema mismatch (missing tables, missing columns, constraint mismatches)
- **WARNING**: Non-critical drift that may be intentional (extra columns, extra tables, type mismatches with compatible types)
- **INFO**: Informational drift that doesn't affect functionality (index differences, default value differences)

**Configuration File:** `packages/backend/database-schema/drift-policy.yml`

```yaml
# Drift policy configuration
environments:
  production:
    block_on: [ERROR]           # Block deployments on errors only
    allow: [WARNING, INFO]      # Allow warnings and info
    fail_pipeline: true         # Fail CI pipeline if blocked
  staging:
    block_on: [ERROR, WARNING]  # Block on errors and warnings
    allow: [INFO]               # Allow info only
    fail_pipeline: false        # Don't fail pipeline, just warn
  local:
    block_on: []                # Never block local deployments
    allow: [ERROR, WARNING, INFO]
    fail_pipeline: false

# Severity classification rules
severity_rules:
  missing_table: ERROR
  extra_table: WARNING
  missing_column: ERROR
  extra_column: WARNING
  type_mismatch: WARNING
  constraint_mismatch: ERROR
  enum_mismatch: WARNING
  index_mismatch: INFO
  default_mismatch: INFO
```

### CI/CD Integration (AC 25)

GitHub Actions workflow for automated drift detection:

**Workflow File:** `.github/workflows/drift-check.yml`

```yaml
name: Schema Drift Detection

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check (local, staging, production)'
        required: true
        default: 'staging'

jobs:
  drift-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install

      - name: Run drift detection
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          DATABASE_URL_PRODUCTION: ${{ secrets.DATABASE_URL_PRODUCTION }}
        run: |
          pnpm db:check --environment=${{ github.event.inputs.environment || 'staging' }} --json --severity

      - name: Check deployment policy
        run: |
          pnpm db:check --environment=${{ github.event.inputs.environment || 'staging' }} --enforce-policy

      - name: Post drift report to PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const driftReport = JSON.parse(fs.readFileSync('drift-report.json', 'utf-8'))
            // Post formatted drift report as PR comment
```

**Deployment Gate Logic:**

The `--enforce-policy` flag checks drift against `drift-policy.yml`:
1. Load drift report from `--json` output
2. Classify each drift item by severity (using severity_rules)
3. Check if any severity levels are in the environment's `block_on` list
4. Exit with code 1 (fail pipeline) if drift should block deployment
5. Exit with code 0 (pass) if drift is allowed

### Packages Affected

- `packages/backend/database-schema/src/drift-detector/severity-classifier.ts` - Drift severity classification logic (new)
- `packages/backend/database-schema/drift-policy.yml` - Severity and deployment policy config (new)
- `.github/workflows/drift-check.yml` - CI drift detection workflow (new)
- `packages/backend/database-schema/scripts/check-schema-drift.ts` - Update to support `--severity` and `--enforce-policy` flags
- `packages/backend/database-schema/docs/SCHEMA-DRIFT-DETECTION.md` - Update with CI/CD integration and policy configuration

## Acceptance Criteria

### Drift Severity Levels (AC 26)

- [ ] AC 26.1: Drift severity classifier assigns ERROR, WARNING, or INFO to each drift item
- [ ] AC 26.2: `drift-policy.yml` configuration file defines severity rules and per-environment policies
- [ ] AC 26.3: `--severity` flag adds `severity` field to JSON output
- [ ] AC 26.4: Severity rules are configurable (can override default classifications)
- [ ] AC 26.5: Documentation explains severity levels and how to configure policies

### CI/CD Integration (AC 25)

- [ ] AC 25.1: GitHub Actions workflow file (`.github/workflows/drift-check.yml`) runs drift detection on push/PR
- [ ] AC 25.2: Workflow supports manual trigger with environment selection
- [ ] AC 25.3: `--enforce-policy` flag reads `drift-policy.yml` and blocks deployment if drift exceeds threshold
- [ ] AC 25.4: Workflow posts drift report as PR comment when triggered by pull_request event
- [ ] AC 25.5: Environment-specific policies are enforced (production blocks on ERROR, staging blocks on ERROR+WARNING)
- [ ] AC 25.6: Pipeline exit code matches policy enforcement (code 1 if blocked, code 0 if allowed)
- [ ] AC 25.7: Documentation includes workflow setup instructions and example configurations

## Reuse Plan

### Existing Patterns

- **GitHub Actions Workflows**: Follow existing CI workflow patterns from the monorepo
- **Policy Configuration**: YAML-based policy files similar to ESLint/Prettier configs
- **Exit Codes**: Standard CI exit code patterns (0 = pass, 1 = fail)

### Third-Party Libraries

- **js-yaml**: Parse `drift-policy.yml` configuration file
- **@actions/github**: GitHub Actions SDK for posting PR comments
- **zod**: Validate drift-policy.yml schema

### Industry Standards

- **Liquibase Deployment Checks**: Similar policy-based drift checking
- **Flyway Deployment Gates**: Comparable CI integration patterns
- **Terraform Plan Checks**: Policy enforcement at deployment time

## Architecture Notes

### Severity Classification

```typescript
import { z } from 'zod'

const DriftPolicySchema = z.object({
  environments: z.record(
    z.object({
      block_on: z.array(z.enum(['ERROR', 'WARNING', 'INFO'])),
      allow: z.array(z.enum(['ERROR', 'WARNING', 'INFO'])),
      fail_pipeline: z.boolean(),
    })
  ),
  severity_rules: z.record(z.enum(['ERROR', 'WARNING', 'INFO'])),
})

type DriftPolicy = z.infer<typeof DriftPolicySchema>
type Severity = 'ERROR' | 'WARNING' | 'INFO'

interface DriftItemWithSeverity extends DriftItem {
  severity: Severity
}

function classifyDriftSeverity(
  drift: DriftItem,
  policy: DriftPolicy
): DriftItemWithSeverity {
  const defaultSeverity = policy.severity_rules[drift.type]
  return {
    ...drift,
    severity: defaultSeverity || 'WARNING', // default to WARNING if not configured
  }
}

function shouldBlockDeployment(
  drifts: DriftItemWithSeverity[],
  environment: string,
  policy: DriftPolicy
): boolean {
  const envPolicy = policy.environments[environment]
  if (!envPolicy) {
    throw new Error(`No policy defined for environment: ${environment}`)
  }

  const blockingSeverities = new Set(envPolicy.block_on)
  const hasBlockingDrift = drifts.some(d => blockingSeverities.has(d.severity))

  return hasBlockingDrift
}
```

### Policy Enforcement in CLI

```typescript
// In check-schema-drift.ts script

async function main() {
  const args = parseArgs(process.argv)
  const driftReport = await detectDrift(args.environment)

  if (args.severity) {
    const policy = loadDriftPolicy('drift-policy.yml')
    driftReport.drifts = driftReport.drifts.map(d => classifyDriftSeverity(d, policy))
  }

  if (args.json) {
    console.log(JSON.stringify(driftReport, null, 2))
  } else {
    printHumanReadableReport(driftReport)
  }

  if (args.enforcePolicy) {
    const policy = loadDriftPolicy('drift-policy.yml')
    const shouldBlock = shouldBlockDeployment(
      driftReport.drifts,
      args.environment,
      policy
    )

    if (shouldBlock) {
      const envPolicy = policy.environments[args.environment]
      console.error(`\nDEPLOYMENT BLOCKED: Drift detected with severity levels in block list`)
      console.error(`Environment: ${args.environment}`)
      console.error(`Blocked severities: ${envPolicy.block_on.join(', ')}`)
      console.error(`\nResolve drift before deploying. Run: pnpm db:check --remediate\n`)
      process.exit(1)
    } else {
      console.log(`\nDeployment allowed: No blocking drift detected`)
      process.exit(0)
    }
  }

  // Default: exit with code 1 if drift, 0 if no drift (backward compatible with WISH-20191)
  process.exit(driftReport.has_drift ? 1 : 0)
}
```

### GitHub Actions Workflow Integration

The workflow uses a multi-step approach:
1. **Detect drift**: Run `db:check --json --severity` and save output
2. **Enforce policy**: Run `db:check --enforce-policy` which reads the JSON and applies policy
3. **Report to PR**: Post formatted drift report as PR comment (if pull_request event)

This separation allows the drift report to be generated once and reused for both enforcement and reporting.

## Test Plan

### Severity Classification Tests

**Test 1: Classify Drift by Type**
- Load default `drift-policy.yml`
- Mock drift items: missing_table, extra_column, index_mismatch
- Assert severities: ERROR, WARNING, INFO (respectively)

**Test 2: Custom Severity Rules**
- Override `severity_rules.extra_column: ERROR` in policy
- Mock drift: extra_column
- Assert severity is ERROR (not default WARNING)

**Test 3: Invalid Policy Configuration**
- Create `drift-policy.yml` with invalid severity level
- Load policy
- Assert validation error from Zod schema

### Policy Enforcement Tests

**Test 4: Block Deployment on Error**
- Set environment policy: `block_on: [ERROR]`
- Mock drift with severity ERROR
- Run `db:check --enforce-policy`
- Assert exit code 1 (deployment blocked)

**Test 5: Allow Deployment with Warnings**
- Set environment policy: `block_on: [ERROR]`
- Mock drift with severity WARNING
- Run `db:check --enforce-policy`
- Assert exit code 0 (deployment allowed)

**Test 6: Block Deployment on Multiple Severities**
- Set environment policy: `block_on: [ERROR, WARNING]`
- Mock drift with severity WARNING
- Run `db:check --enforce-policy`
- Assert exit code 1 (deployment blocked)

**Test 7: Environment-Specific Policies**
- Set production policy: `block_on: [ERROR]`
- Set staging policy: `block_on: [ERROR, WARNING]`
- Mock drift with severity WARNING
- Assert `--environment=production` allows deployment
- Assert `--environment=staging` blocks deployment

### CI/CD Workflow Tests

**Test 8: Workflow Runs on Push**
- Simulate GitHub Actions push event
- Assert workflow is triggered
- Assert drift check step executes

**Test 9: Workflow Manual Trigger**
- Simulate workflow_dispatch event with environment input
- Assert workflow runs with specified environment
- Assert correct environment URL is used

**Test 10: PR Comment Integration**
- Mock pull_request event
- Mock drift report with 2 drifts
- Run workflow
- Assert PR comment is posted with formatted drift report

### Integration Tests

**Test 11: End-to-End Policy Enforcement**
- Set up test database with known drift
- Configure `drift-policy.yml` to block on ERROR
- Run CI workflow
- Assert workflow fails with exit code 1
- Assert error message explains why deployment is blocked

**Test 12: End-to-End Deployment Success**
- Set up test database with no drift
- Run CI workflow
- Assert workflow passes with exit code 0
- Assert success message confirms no blocking drift

## Risk Notes

### MVP-Critical Risks

**Risk 1: Policy Configuration Errors**
- Incorrect `drift-policy.yml` configuration could block valid deployments
- **Mitigation**: Zod schema validation; provide example configurations; test with multiple environments

**Risk 2: False Positive Deployment Blocks**
- Overly strict policies could block deployments unnecessarily
- **Mitigation**: Default to conservative policies (block only on ERROR); document how to tune per environment

**Risk 3: GitHub Actions Secrets**
- Database credentials must be securely stored in GitHub Secrets
- **Mitigation**: Document secret setup; use read-only database credentials for drift checks

### Non-MVP Risks

**Risk 4: Workflow Performance**
- Drift detection could slow down CI pipelines on large schemas
- **Mitigation**: Run drift check in parallel with other CI jobs; optimize if needed

**Risk 5: Multi-Region Deployments**
- Tool assumes single database per environment; doesn't handle multi-region
- **Mitigation**: Document limitation; can be extended for multi-region in future

## Definition of Done

- [ ] All Acceptance Criteria verified (26.1-26.5 for severity, 25.1-25.7 for CI/CD)
- [ ] `drift-policy.yml` configuration file created with sensible defaults
- [ ] Severity classification logic implemented and tested
- [ ] `--severity` and `--enforce-policy` flags work correctly
- [ ] GitHub Actions workflow runs drift detection on push/PR
- [ ] Workflow enforces deployment policies correctly
- [ ] Workflow posts drift reports to PRs
- [ ] 12 unit/integration tests pass
- [ ] Documentation updated in `SCHEMA-DRIFT-DETECTION.md`
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Implementation | ~6k | — | — | Severity classifier + policy enforcement + GitHub Actions workflow |
| Review | ~1.5k | — | — | Code review |
| **Total** | ~7.5k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-31 10:17 | pm-story-split-leader | Created split story 3/3 from WISH-20190 (CI/CD integration) | WISH-20193.md |

---
