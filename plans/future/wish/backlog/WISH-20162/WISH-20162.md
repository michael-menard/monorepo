---
status: backlog
e2e_required: true
follow_up_from: WISH-2016
created: 2026-02-09
updated_at: 2026-02-09
story_id: WISH-20162
title: Playwright E2E Tests for Image Optimization
epic: Wishlist Feature
phase: 4 - Performance & UX Polish
priority: P3
depends_on: [WISH-2016]
complexity: Small
effort: 1-2 points
---

# WISH-20162: Playwright E2E Tests for Image Optimization

## Follow-up Context

**Parent Story:** WISH-2016 (Image Optimization - Automatic Resizing, Compression, and Watermarking)

**Source:** Split from WISH-2016 during implementation. E2E tests could not execute because the image processing pipeline requires AWS infrastructure (S3 event triggers, Lambda function, Sharp layer) that is not available in the local development environment.

**Category:** Test Coverage

**Impact:** Low (all unit/integration/frontend tests pass; E2E adds browser-level verification)

**Effort:** Small (feature file already written, needs step definitions and infrastructure)

---

## Context

WISH-2016 implemented automatic image optimization with 75 passing tests (26 unit, 28 integration, 21 frontend). However, the Playwright E2E tests could not be executed because:

1. The image processing pipeline runs as an S3-triggered Lambda function
2. The Lambda requires the Sharp library layer (~50MB) deployed to AWS
3. E2E tests need a running backend with access to AWS infrastructure
4. The feature file exists but step definitions and live execution are pending

The Gherkin feature file (`wishlist-image-optimization.feature`) with 12 BDD scenarios was authored during WISH-2016 and is ready to be wired up.

---

## Goal

Execute the existing Playwright E2E tests for image optimization against a running backend with AWS infrastructure, fixing any test failures discovered during execution.

---

## Non-goals

- Modifying the image processing code (completed in WISH-2016)
- Deploying AWS infrastructure (separate infrastructure task)
- Adding new acceptance criteria beyond E2E verification

---

## Scope

### Packages Affected

- `apps/web/playwright/` - Step definitions and test execution

### Existing Assets

- `apps/web/playwright/features/wishlist/wishlist-image-optimization.feature` - 12 BDD scenarios already written

### Files to Create/Modify

1. **Step Definitions:**
   - `apps/web/playwright/steps/wishlist-image-optimization.steps.ts` - Step definitions for all 12 scenarios

2. **Test Configuration:**
   - Ensure `playwright.legacy.config.ts` includes image optimization feature
   - Configure test environment variables for AWS access

---

## Acceptance Criteria

### AC1: E2E Test Execution
**Given** the backend server is running with AWS infrastructure access
**When** the Playwright E2E tests are executed
**Then** all 12 BDD scenarios in `wishlist-image-optimization.feature` pass

### AC2: Gallery Card Image Verification (AC8 from WISH-2016)
**Given** the gallery view displays wishlist items with optimized images
**When** E2E tests inspect the gallery cards
**Then** images use thumbnail variant URLs
**And** images are wrapped in `<picture>` elements with WebP sources
**And** images have `loading="lazy"` attribute

### AC3: WebP Fallback Verification (AC3 from WISH-2016)
**Given** the responsive image component renders
**When** E2E tests inspect the picture element
**Then** WebP source is present
**And** JPEG fallback img src is present

### AC4: Legacy Item Fallback Verification (AC10 from WISH-2016)
**Given** legacy items without image variants exist
**When** E2E tests load the gallery
**Then** legacy items display using original imageUrl
**And** no image errors appear on the page

### AC5: Processing State Verification
**Given** items with various processing states exist
**When** E2E tests inspect the gallery
**Then** pending items show optimizing indicator
**And** failed items show original image without broken icons

### AC6: Accessibility Verification
**Given** optimized images are displayed
**When** E2E tests check accessibility
**Then** all images have non-empty alt text
**And** no empty alt attributes exist

---

## Test Plan

### Prerequisites
- Backend server running at configured URL
- AWS infrastructure deployed (S3 triggers, Lambda, Sharp layer)
- Test data with both optimized and legacy wishlist items

### Execution
```bash
pnpm --filter @repo/playwright test -- --grep @wish-2016
```

### Scenarios (from existing feature file)
1. Gallery cards display optimized thumbnail images (smoke)
2. Gallery cards use picture element with WebP source
3. Gallery card images use lazy loading
4. Responsive image provides JPEG fallback
5. Legacy items without image variants show original image
6. Legacy items do not break the gallery layout
7. Items with pending processing show optimizing indicator
8. Items with failed processing show original image
9. Thumbnail images have correct dimensions
10. Image variants preserve aspect ratio
11. Optimized images have proper alt text
12. Image loading states are accessible

---

## Dependencies

### Blocked By
- **WISH-2016** (Image Optimization) - Code must be deployed
- AWS infrastructure deployment (S3 triggers, Lambda, Sharp layer)

### Blocks
- None

---

## Definition of Done

- [ ] Step definitions written for all 12 BDD scenarios
- [ ] All 12 E2E scenarios pass against live backend
- [ ] No console errors during test execution
- [ ] Screenshot evidence captured for key scenarios
- [ ] Test results documented in EVIDENCE.yaml
