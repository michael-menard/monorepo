---
doc_type: story
title: "WISH-20270: Schedule cleanup cron job (retention policy enforcement)"
story_id: WISH-20270
story_prefix: WISH
status: backlog
phase: 3
created_at: "2026-01-30T00:00:00-07:00"
updated_at: "2026-01-30T00:00:00-07:00"
depends_on: [WISH-2119]
follow_up_from: WISH-2119
estimated_points: 1
sizing_warning: false
---

# WISH-20270: Schedule cleanup cron job (retention policy enforcement)

## Follow-up Context

**Parent Story:** WISH-2119 (Flag scheduling - auto-enable/disable at scheduled times)

**Source:** QA Discovery Notes - Follow-up Stories Suggested (Finding #6)

**Original Finding:** "Schedule cleanup cron job (retention policy enforcement, automatic purging of old schedules)"

**Category:** Enhancement Opportunity

**Impact:** Low (operational housekeeping, prevents unbounded table growth)

**Effort:** Low (1 point - simple cron job reusing existing patterns)

## Context

WISH-2119 implements schedule retention policies (AC15) but does not enforce them automatically:
- Applied schedules: Retain for 90 days (audit trail)
- Failed schedules: Retain indefinitely (manual review required)
- Cancelled schedules: Retain for 30 days

Without automatic cleanup, the `feature_flag_schedules` table will grow unbounded over time, degrading query performance and increasing storage costs. This story implements a nightly cron job to enforce retention policies automatically, removing expired schedules while preserving failed schedules for manual review.

## Goal

Implement automated retention policy enforcement for feature flag schedules through a nightly cron job, preventing unbounded table growth while preserving failed schedules for manual review.

## Non-goals

- **Automatic retry for failed schedules** - failed schedules remain for manual intervention (Enhancement Opportunity #4 in ELAB-WISH-2119)
- **Failed schedule alerting** - CloudWatch logs only in MVP, no alerts (defer to observability story)
- **Configurable retention policies** - hardcoded retention windows in MVP (90 days applied, 30 days cancelled)
- **Manual cleanup UI** - admin cannot override retention via UI (defer to admin dashboard story)
- **Soft delete with recovery** - hard DELETE in MVP (no undo capability)
- **Cleanup metrics dashboard** - CloudWatch Logs only (defer to observability story)

## Scope

### Endpoints Affected

**No new endpoints** - cron job operates directly on database via repository layer.

**Reused from WISH-2119:**
- `schedule-repository.ts` - deleteExpiredSchedules() method (new)
- Database client from `packages/backend/database-schema/`

### Packages Affected

1. **Backend - Cron Job**: `apps/api/lego-api/jobs/`
   - `cleanup-flag-schedules.ts` - Cron job handler for cleanup (new)

2. **Backend - Config Domain**: `apps/api/lego-api/domains/config/`
   - `adapters/schedule-repository.ts` - Add deleteExpiredSchedules() method

3. **Infrastructure**: AWS Lambda + EventBridge
   - Cron schedule: Daily at 2:00 AM UTC (off-peak hours)

### Infrastructure Impact

**Cron Job Configuration:**
```yaml
Function: cleanup-flag-schedules
Trigger: EventBridge rule - cron(0 2 * * ? *)  # Daily at 2:00 AM UTC
Runtime: Node.js (same as API Lambda)
Timeout: 5 minutes
Memory: 256 MB
Environment: DATABASE_URL (shared with API, no Redis needed)
```

**Cleanup Query:**
```sql
DELETE FROM feature_flag_schedules
WHERE
  (status = 'applied' AND applied_at < NOW() - INTERVAL '90 days')
  OR (status = 'cancelled' AND updated_at < NOW() - INTERVAL '30 days');
-- Failed schedules NOT deleted (retain indefinitely for manual review)
```

**Database Indexes (reused from WISH-2119):**
- `idx_schedules_status` - Filter by status (applied/cancelled/failed)
- Composite index on `(status, applied_at)` may improve performance (evaluate in AC12)

## Acceptance Criteria

### Backend - Cleanup Service

**AC1**: Repository method for expired schedule deletion
- Method: `scheduleRepository.deleteExpiredSchedules()`
- Delete WHERE status = 'applied' AND applied_at < NOW() - INTERVAL '90 days'
- Delete WHERE status = 'cancelled' AND updated_at < NOW() - INTERVAL '30 days'
- Does NOT delete failed schedules (status = 'failed')
- Returns count of deleted schedules
- Uses parameterized query (no SQL injection)

**AC2**: Retention window constants
- Define retention constants in repository or config:
  - `APPLIED_SCHEDULE_RETENTION_DAYS = 90`
  - `CANCELLED_SCHEDULE_RETENTION_DAYS = 30`
- Constants referenced in DELETE query (no magic numbers)
- Easy to modify retention windows in future

**AC3**: Cleanup cron job implementation
- File: `apps/api/lego-api/jobs/cleanup-flag-schedules.ts`
- Invokes `scheduleRepository.deleteExpiredSchedules()`
- Logs deleted count to CloudWatch: `{ message: "Cleanup completed", deletedCount: N }`
- Wraps deletion in try-catch block with error logging
- Returns success if deletion succeeds, throws error if fails

### Infrastructure & Deployment

**AC4**: Cron job Lambda configuration
- EventBridge rule: `cron(0 2 * * ? *)` (daily at 2:00 AM UTC)
- Lambda timeout: 5 minutes (sufficient for large tables)
- Lambda memory: 256 MB (lighter than WISH-2119's schedule processor)
- Environment: DATABASE_URL (no Redis needed)
- Permissions: Database read/write access, CloudWatch logs

**AC5**: Idempotent cleanup execution
- Running cleanup job multiple times per day has no adverse effects
- DELETE query is safe to run repeatedly (only deletes expired records)
- No race conditions with WISH-2119's schedule processor (different tables/statuses)

### Monitoring & Observability

**AC6**: CloudWatch structured logging
- Success log: `{ level: "info", message: "Cleanup completed", deletedCount: N, duration: Xms }`
- Error log: `{ level: "error", message: "Cleanup failed", error: "..." }`
- Log includes timestamp for audit trail
- Logs written to CloudWatch Logs group: `/aws/lambda/cleanup-flag-schedules`

**AC7**: CloudWatch metrics
- Metric namespace: `FeatureFlags/ScheduleCleanup`
- Metric: `SchedulesDeletedCount` (count of deleted schedules per execution)
- Metric: `CleanupExecutionTime` (milliseconds)
- Dimensions: `Status` (applied vs cancelled)
- Metrics published after successful cleanup

**AC8**: Failed schedule monitoring
- Cleanup job does NOT delete failed schedules (verified in AC1)
- Failed schedules remain in table indefinitely for manual review
- Admin can query failed schedules via `GET /api/admin/flags/:flagKey/schedule` (from WISH-2119)
- CloudWatch log includes count of failed schedules: `{ failedSchedulesRetained: M }` (info only, not deleted)

### Testing

**AC9**: Repository unit tests
- Test: deleteExpiredSchedules() deletes applied schedules older than 90 days
- Test: deleteExpiredSchedules() deletes cancelled schedules older than 30 days
- Test: deleteExpiredSchedules() does NOT delete failed schedules (any age)
- Test: deleteExpiredSchedules() does NOT delete pending schedules (any age)
- Test: deleteExpiredSchedules() returns correct count of deleted schedules
- Test: deleteExpiredSchedules() handles empty table (no schedules to delete)

**AC10**: Cron job integration tests
- Test: Invoke cleanup handler, assert expired schedules deleted
- Test: Create applied schedule 91 days old, invoke cleanup, assert deleted
- Test: Create cancelled schedule 31 days old, invoke cleanup, assert deleted
- Test: Create failed schedule 200 days old, invoke cleanup, assert NOT deleted
- Test: Simulate database error, assert error logged to CloudWatch

**AC11**: Edge case tests
- Test: Applied schedule exactly 90 days old (boundary condition) - should be deleted
- Test: Cancelled schedule exactly 30 days old (boundary condition) - should be deleted
- Test: Applied schedule 89 days old - should NOT be deleted
- Test: Cancelled schedule 29 days old - should NOT be deleted

### Documentation

**AC12**: Retention policy documentation
- Document retention windows in `apps/api/lego-api/domains/config/README.md`:
  - Applied schedules: 90 days
  - Cancelled schedules: 30 days
  - Failed schedules: Indefinite (manual review required)
- Document cleanup cron schedule (daily at 2:00 AM UTC)
- Document manual cleanup procedure for failed schedules (SQL query example)

**AC13**: Index optimization evaluation
- Evaluate composite index on `(status, applied_at)` and `(status, updated_at)`
- Document in README whether composite index improves DELETE performance
- If beneficial: Add index migration in this story
- If marginal: Document as future optimization opportunity

## Reuse Plan

### Existing Components (Extended)

- `schedule-repository.ts` from WISH-2119 - add deleteExpiredSchedules() method
- `feature_flag_schedules` table from WISH-2119 - cleanup target
- Database client from `packages/backend/database-schema/`
- CloudWatch logging patterns from WISH-2119's `process-flag-schedules.ts`
- EventBridge cron job infrastructure from WISH-2119

### New Components

- `cleanup-flag-schedules.ts` - Cron job handler (new)

### Existing Patterns

- Lambda cron job triggered by EventBridge (same as WISH-2119)
- CloudWatch structured logging with JSON format
- Repository pattern for database operations
- Retention constants pattern (same as session expiry in other domains)

## Architecture Notes

**Hexagonal Architecture Compliance:**
- Cleanup logic lives in repository adapter (`adapters/schedule-repository.ts`)
- Cron job handler delegates to repository (no direct SQL in handler)
- Retention constants defined in repository or config (not hardcoded in handler)

**No Service Layer Needed:**
- Cleanup is infrastructure-only operation (no business logic)
- Direct repository call from cron job handler is acceptable
- No HTTP endpoints, no validation, no complex workflows

**Database Transaction Safety:**
- DELETE operations are atomic by default in PostgreSQL
- No need for explicit transaction (single statement)
- No foreign key cascade concerns (schedules have no dependents)

## Test Plan

### Scope Summary

- **Endpoints:** None (cron job only)
- **UI Touched:** No
- **Data/Storage:** Yes (deletes from feature_flag_schedules table)
- **Infrastructure:** Cron job (Lambda + EventBridge)

### Happy Path Tests

1. **Cleanup deletes expired applied schedules**: Create applied schedule 91 days old, invoke cleanup, assert deleted
2. **Cleanup deletes expired cancelled schedules**: Create cancelled schedule 31 days old, invoke cleanup, assert deleted
3. **Cleanup preserves failed schedules**: Create failed schedule 200 days old, invoke cleanup, assert NOT deleted
4. **Cleanup logs success metrics**: Invoke cleanup, assert CloudWatch log includes deletedCount

### Error Cases

1. **Database connection failure**: Simulate connection error, assert error logged to CloudWatch
2. **Invalid retention window calculation**: Mock clock/date, assert correct date math
3. **Empty table cleanup**: Invoke cleanup on empty table, assert no errors and deletedCount = 0

### Edge Cases

1. **Boundary conditions**: Applied schedule exactly 90 days old, assert deleted
2. **Mixed status schedules**: Create 10 schedules (2 applied expired, 3 cancelled expired, 5 failed), assert only 5 deleted
3. **Large batch deletion**: Create 1000 expired applied schedules, invoke cleanup, assert all deleted within timeout
4. **Idempotent execution**: Invoke cleanup twice in a row, assert second execution deletes 0 schedules

### Required Tooling Evidence

**Backend Unit Tests:**
- Minimum 6 repository tests (AC9 coverage)
- Minimum 5 cron job integration tests (AC10 coverage)
- Minimum 4 edge case tests (AC11 coverage)

**Backend Integration Tests:**
- Cron job invocation test with real database
- Boundary condition tests with actual dates
- Failed schedule preservation test

**Frontend Tests:**
- N/A (no user-facing UI)

## Risks & Mitigations

### MVP-Critical Risks

1. **Accidental deletion of failed schedules**
   - Risk: Logic error could delete failed schedules needed for manual review
   - Mitigation: Unit test explicitly asserts failed schedules NOT deleted (AC9)
   - Severity: Medium (data loss risk)

2. **Retention window miscalculation**
   - Risk: Date math error could delete recent schedules or retain expired ones
   - Mitigation: Boundary condition tests (AC11), retention constants for easy validation
   - Severity: Low (testable with integration tests)

3. **Large table cleanup timeout**
   - Risk: Lambda timeout if millions of schedules need deletion
   - Mitigation: 5-minute timeout, batch deletion if needed (evaluate in AC13)
   - Severity: Low (unlikely for MVP scale)

4. **No rollback for accidental deletion**
   - Risk: Hard DELETE has no undo capability
   - Mitigation: Document manual cleanup procedure in README, require code review before deploy
   - Severity: Low (admin can recreate schedules if needed)

### Non-Critical Risks

1. **Cleanup drift from WISH-2119 retention policy**
   - Risk: WISH-2119's AC15 retention policy could change without updating cleanup job
   - Mitigation: Reference retention constants from single source (AC2)
   - Severity: Low (documentation synchronization)

## Open Questions

None - all decisions finalized for MVP scope.

## Definition of Done

- [ ] All 13 Acceptance Criteria pass
- [ ] Backend: 6+ repository unit tests pass (deleteExpiredSchedules method)
- [ ] Backend: 5+ cron job integration tests pass (cleanup execution, error handling)
- [ ] Backend: 4+ edge case tests pass (boundary conditions, mixed statuses)
- [ ] Cron job Lambda deployed with EventBridge trigger (daily at 2:00 AM UTC)
- [ ] CloudWatch metrics published (SchedulesDeletedCount, CleanupExecutionTime)
- [ ] Documentation updated (retention policy in README)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved

## Follow-up Stories (Future)

### Phase 4+

- Failed schedule alerting (CloudWatch alarm when failed count exceeds threshold)
- Configurable retention policies (admin UI to adjust retention windows)
- Soft delete with recovery (archive expired schedules instead of hard delete)
- Cleanup metrics dashboard (visualize deletion trends, table growth, failed schedule backlog)
- Manual cleanup UI (admin dashboard to manually delete specific schedules)

### Integration with Observability

- CloudWatch dashboard for schedule lifecycle (created, applied, failed, deleted over time)
- Alerts for cleanup failures or abnormal deletion counts

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Generation | ~8k | — | — | Follow-up story from WISH-2119 |
| Elaboration | ~6k | — | — | Small infrastructure story |
| Implementation | ~10k | — | — | Cron job + repository method + tests |
| Code Review | ~3k | — | — | Simple cleanup logic |
| **Total** | ~27k | — | — | Small-sized story |

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-30 00:00 | pm-story-followup-leader | Generated follow-up story from WISH-2119 elaboration | WISH-20270.md |

---
