---
id: WISH-20290
title: "Coverage metrics integration for test utilities"
status: backlog
created: 2026-01-30
updated: 2026-01-30
depends_on:
  - WISH-2120
follow_up_from: WISH-2120
phase: "2 - Infrastructure"
priority: P2
complexity: Small
effort: 1
category: Test Infrastructure
---

# WISH-20290: Coverage metrics integration for test utilities

## Follow-up Context

**Parent Story:** WISH-2120
**Source:** QA Discovery Notes (Gaps Identified - Finding #1)
**Original Finding:** Coverage metrics integration - Add coverage threshold enforcement (e.g., 80%) for test utility files via vitest.config.ts
**Category:** Gap
**Impact:** Low
**Effort:** Low

## Context

WISH-2120 establishes test utility helpers (`createMockFile`, `mockS3Upload`) that reduce boilerplate in S3 upload tests. While the utilities themselves will have 100% test coverage (per AC12), there is no automated enforcement to prevent future coverage regressions when these utilities are modified or extended.

Without coverage threshold enforcement in `vitest.config.ts`, developers might:
- Add new utility functions without corresponding tests
- Modify existing utilities and miss edge cases
- Reduce coverage accidentally through refactoring

This gap is non-MVP for WISH-2120 (existing tests work fine without it), but represents a technical debt that should be addressed before the test utilities proliferate across the codebase.

## Goal

Add coverage threshold enforcement (minimum 80%) for test utility files via `vitest.config.ts` to prevent coverage regressions and maintain high test quality as the test infrastructure evolves.

## Non-goals

- Coverage enforcement for production code (separate concern)
- Coverage enforcement for E2E tests (Playwright does not use Vitest coverage)
- Changing the test utilities themselves (WISH-2120 scope only)
- Retroactive coverage enforcement for existing non-utility test files

---

## Scope

### Vitest Configuration Updates

Update `apps/web/app-wishlist-gallery/vitest.config.ts` to add coverage thresholds for test utility files:

```typescript
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      include: ['src/**/*.ts', 'src/**/*.tsx'],
      thresholds: {
        // Global thresholds
        lines: 45,
        functions: 45,
        branches: 45,
        statements: 45,

        // Test utilities: enforce 80% coverage
        'src/test/utils/**/*.ts': {
          lines: 80,
          functions: 80,
          branches: 80,
          statements: 80,
        },
      },
    },
  },
})
```

### Documentation Updates

Add coverage threshold documentation to test utilities README:

- `apps/web/app-wishlist-gallery/src/test/utils/README.md` - Document 80% threshold requirement
- Include example commands for running coverage checks locally
- Explain how to add new utilities while maintaining coverage

### Packages Affected

| Package | Change Type | Description |
|---------|-------------|-------------|
| `apps/web/app-wishlist-gallery/vitest.config.ts` | **Modified** | Add coverage thresholds for `src/test/utils/**/*.ts` |
| `apps/web/app-wishlist-gallery/src/test/utils/README.md` | **New** | Document coverage requirements |

---

## Acceptance Criteria

### Coverage Threshold Enforcement

- [ ] **AC1:** `vitest.config.ts` defines coverage thresholds of 80% (lines, functions, branches, statements) for `src/test/utils/**/*.ts`
- [ ] **AC2:** Running `pnpm test --coverage` fails if test utility coverage drops below 80%
- [ ] **AC3:** Coverage thresholds apply only to `src/test/utils/` directory, not global test files
- [ ] **AC4:** Coverage report shows test utility coverage separately in terminal output
- [ ] **AC5:** Existing global coverage thresholds (45%) remain unchanged

### Documentation

- [ ] **AC6:** `src/test/utils/README.md` documents the 80% coverage requirement
- [ ] **AC7:** README includes command to run coverage checks locally: `pnpm test src/test/utils --coverage`
- [ ] **AC8:** README explains how to view detailed coverage reports (HTML output)
- [ ] **AC9:** README provides guidance on maintaining coverage when adding new utilities

### Validation

- [ ] **AC10:** All test utilities from WISH-2120 (`createMockFile`, `mockS3Upload`) meet 80% threshold
- [ ] **AC11:** CI pipeline enforces coverage thresholds and fails PR if violated
- [ ] **AC12:** Coverage report includes clear error messages when thresholds are not met

---

## Reuse Plan

### Existing Patterns

| Pattern | Source | Usage |
|---------|--------|-------|
| Vitest coverage config | `vitest.config.ts` | Extend existing coverage object |
| Per-directory thresholds | Vitest docs | Use thresholds object with glob patterns |
| README documentation | `apps/web/app-wishlist-gallery/README.md` | Follow similar structure |

### No New Dependencies

All changes leverage existing infrastructure:
- `vitest` (already installed)
- `@vitest/coverage-v8` (already installed)
- No new npm packages required

---

## Test Plan

### Validation Steps

| Scenario | Command | Expected Result |
|----------|---------|-----------------|
| Coverage passes | `pnpm test src/test/utils --coverage` | Exit 0, coverage â‰¥80% |
| Coverage fails | Temporarily delete tests, run coverage | Exit 1, clear error message |
| Global coverage unaffected | `pnpm test --coverage` | Global thresholds still 45% |
| CI enforcement | Push PR with low coverage | CI fails with coverage error |

### Evidence Commands

```bash
# Run test utility coverage
pnpm --filter app-wishlist-gallery test src/test/utils --coverage

# Run full coverage suite
pnpm --filter app-wishlist-gallery test --coverage

# View HTML coverage report
open apps/web/app-wishlist-gallery/coverage/index.html
```

---

## Architecture Notes

### Coverage Threshold Strategy

This story establishes a **two-tier coverage strategy**:

1. **Global coverage (45%):** Production code and existing tests maintain current thresholds
2. **Test utilities (80%):** Higher bar for test infrastructure to ensure reliability

**Rationale:**
- Test utilities are critical infrastructure used across many test files
- High coverage prevents cascading failures when utilities have bugs
- 80% threshold balances rigor with pragmatism (allows some edge cases)

### Future Expansion

This pattern can be extended to other critical paths:
- `src/hooks/**/*.ts` (custom React hooks)
- `src/utils/**/*.ts` (shared utilities)
- `src/lib/**/*.ts` (core library code)

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| False positives | Low | Low | 80% threshold allows some uncovered paths |
| CI failures on PR | Medium | Medium | Clear error messages in README |
| Coverage config complexity | Low | Medium | Simple glob pattern per Vitest docs |
| Developer friction | Low | Low | README provides clear guidance |

---

## Source

Follow-up from QA Elaboration of WISH-2120 (Gaps Identified - Finding #1)

**Original Finding:** Coverage metrics integration - Add coverage threshold enforcement (e.g., 80%) for test utility files via vitest.config.ts. Non-MVP: existing tests work fine without this.

**Category:** Gap
**Impact:** Low (prevents future coverage regressions)
**Effort:** Low (1 point - configuration only)

---

## Open Questions

None - straightforward Vitest configuration change.
