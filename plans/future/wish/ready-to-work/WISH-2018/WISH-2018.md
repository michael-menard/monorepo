---
status: ready-to-work
follow_up_from: WISH-2013
created: 2026-01-28
updated_at: 2026-01-28
story_id: WISH-2018
title: CDN Integration for Image Performance Optimization
epic: Wishlist Feature
phase: 5 - Performance
priority: P2
depends_on: [WISH-2013]
complexity: Medium
effort: 3-5 points
---

# WISH-2018: CDN Integration for Image Performance Optimization

## Follow-up Context

**Parent Story:** WISH-2013 (File Upload Security Hardening)

**Source:** QA Discovery Notes - Follow-up Stories Suggested

**Original Finding:** "WISH-2018: CDN Integration - CloudFront or image CDN for performance"

**Category:** Enhancement Opportunity

**Impact:** Medium (Performance improvement for global users)

**Effort:** Medium (CloudFront distribution + S3 origin configuration)

---

## Context

The wishlist feature stores uploaded images in S3 with direct S3 access for viewing. While this works functionally, it has several performance and scalability limitations:

1. **Global Latency:** S3 buckets are region-specific (e.g., us-east-1). Users accessing from other regions (Europe, Asia, Australia) experience higher latency (200-500ms) compared to users in the same region (~50ms).

2. **No Edge Caching:** Every image request hits S3 directly, incurring S3 request costs and missing opportunities for edge caching.

3. **No Image Transformations:** S3 serves raw uploaded images without resizing, format conversion (WebP), or compression, leading to larger file sizes and slower page loads.

4. **Bandwidth Costs:** S3 data transfer costs are higher than CloudFront (S3: $0.09/GB vs CloudFront: $0.085/GB in US regions, significantly cheaper in other regions).

This story integrates **Amazon CloudFront** as a Content Delivery Network (CDN) to serve wishlist images from edge locations worldwide, reducing latency, improving user experience, and lowering bandwidth costs.

### Background

**Current State (WISH-2013):**
- Images uploaded to S3 bucket: `lego-moc-wishlist-uploads/uploads/wishlist/{userId}/{imageId}.jpg`
- Frontend accesses images via S3 URLs: `https://s3.amazonaws.com/lego-moc-wishlist-uploads/...`
- No caching layer between S3 and frontend
- No image optimization or transformations

**Benefits of CloudFront CDN:**
- **Reduced Latency:** Edge locations in 200+ cities worldwide cache images close to users
- **Lower Costs:** CloudFront data transfer is cheaper than S3, especially for frequently accessed images
- **Built-in Security:** CloudFront supports HTTPS by default, DDoS protection, geo-blocking
- **Image Optimization:** Integration with Lambda@Edge enables on-the-fly image transformations (resize, format conversion)
- **Cache Control:** Configurable TTL (Time To Live) for cache invalidation strategies

---

## Goal

Integrate Amazon CloudFront as a CDN to serve wishlist images from edge locations, reducing latency for global users and lowering bandwidth costs. Ensure seamless migration from S3 URLs to CloudFront URLs without breaking existing images.

---

## Non-goals

- **Image Transformations:** On-the-fly resizing, format conversion (WebP), or compression is out of scope for MVP. Defer to WISH-2016 (Image Optimization) or future Lambda@Edge story.
- **Video/PDF CDN:** This story focuses on image delivery only. Other file types (PDFs, videos) are out of scope.
- **Custom Domain:** Using a custom domain (e.g., `cdn.lego-moc.com`) instead of CloudFront's default domain is deferred to future branding story.
- **Cache Invalidation UI:** Admin UI for manual cache invalidation is out of scope. Use AWS CLI or CloudFormation for cache invalidation in MVP.
- **Multi-CDN Strategy:** Using multiple CDN providers (Cloudflare, Fastly) for redundancy is out of scope.

---

## Scope

### Packages Affected

- `apps/api/lego-api/domains/wishlist/` - Update presign endpoint to return CloudFront URLs
- `apps/api/lego-api/core/storage/` - S3 client configuration for CloudFront integration
- `apps/api/lego-api/core/cdn/` - CloudFront URL generation utilities (new)
- `apps/web/app-wishlist-gallery/src/components/WishlistCard/` - Use CloudFront URLs for image display
- `apps/web/app-wishlist-gallery/src/pages/` - Update image URLs in detail/edit pages
- Infrastructure: CloudFront distribution, S3 origin configuration, OAI (Origin Access Identity)

### Files to Create

1. **CloudFront Utilities:**
   - `apps/api/lego-api/core/cdn/cloudfront.ts` - CloudFront URL generator
   - `apps/api/lego-api/core/cdn/__tests__/cloudfront.test.ts` - Unit tests

2. **Infrastructure as Code (IaC):**
   - CloudFront distribution configuration (JSON/YAML for CloudFormation/Terraform)
   - OAI (Origin Access Identity) for S3-CloudFront integration
   - S3 bucket policy update to allow CloudFront access

### Files to Modify

1. **API Layer:**
   - `apps/api/lego-api/domains/wishlist/application/wishlist-service.ts` - Return CloudFront URLs in GET responses
   - `apps/api/lego-api/domains/wishlist/routes.ts` - Update image URL schema validation

2. **Frontend Layer:**
   - `apps/web/app-wishlist-gallery/src/components/WishlistCard/index.tsx` - Use CloudFront URLs for image rendering
   - `apps/web/app-wishlist-gallery/src/pages/main-page.tsx` - Update image URLs in gallery view
   - `apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx` - Display CloudFront URL after upload

3. **Database Migration (Optional):**
   - If existing S3 URLs are stored in database, add migration to convert S3 URLs to CloudFront URLs
   - Alternative: Generate CloudFront URLs on-the-fly from S3 keys (recommended for MVP)

---

## Acceptance Criteria

### AC1: CloudFront Distribution Created
**Given** AWS infrastructure is configured
**When** CloudFormation/Terraform stack is deployed
**Then** CloudFront distribution is created with S3 origin pointing to `lego-moc-wishlist-uploads` bucket
**And** OAI (Origin Access Identity) is created and attached to distribution
**And** S3 bucket policy allows CloudFront OAI to read objects (GetObject)
**And** distribution is deployed to all edge locations (status: "Deployed")

### AC2: HTTPS-Only Access Enforced
**Given** CloudFront distribution is configured
**When** a user accesses an image URL
**Then** CloudFront enforces HTTPS-only access (redirect HTTP to HTTPS)
**And** HTTP requests are automatically upgraded to HTTPS
**And** SSL/TLS certificate is valid (CloudFront default certificate or custom ACM certificate)

### AC3: Cache Behavior Configured
**Given** CloudFront distribution is configured
**When** a user requests an image
**Then** CloudFront caches the image at edge locations with 24-hour TTL (default)
**And** subsequent requests for the same image are served from edge cache (cache hit)
**And** cache control headers from S3 are respected (Cache-Control: max-age, s-maxage)

### AC4: CloudFront URL Generation (Backend)
**Given** a wishlist item with uploaded image exists
**When** the backend generates image URLs for API responses
**Then** the backend converts S3 keys to CloudFront URLs using distribution domain
**And** CloudFront URLs follow format: `https://{distributionId}.cloudfront.net/uploads/wishlist/{userId}/{imageId}.jpg`
**And** S3 keys are not exposed directly in API responses

### AC5: GET /api/wishlist Returns CloudFront URLs
**Given** a user requests their wishlist items
**When** the backend returns wishlist items (GET /api/wishlist)
**Then** the `imageUrl` field contains CloudFront URL (not S3 URL)
**And** frontend can render images using CloudFront URL
**And** existing S3 URLs are migrated or converted to CloudFront URLs

### AC6: GET /api/wishlist/:id Returns CloudFront URL
**Given** a user requests a specific wishlist item
**When** the backend returns item details (GET /api/wishlist/:id)
**Then** the `imageUrl` field contains CloudFront URL
**And** detail page renders image from CloudFront

### AC7: Frontend Renders Images from CloudFront
**Given** wishlist items contain CloudFront image URLs
**When** the frontend renders WishlistCard components
**Then** images are loaded from CloudFront edge locations
**And** browser network tab shows requests to `*.cloudfront.net` domain
**And** no requests to S3 domain (`s3.amazonaws.com`)

### AC8: Backward Compatibility for Existing S3 URLs
**Given** existing wishlist items may have S3 URLs stored
**When** the backend returns legacy items with S3 URLs
**Then** the backend converts S3 URLs to CloudFront URLs on-the-fly
**And** frontend receives CloudFront URLs for all images (new and legacy)
**And** no breaking changes for existing data

### AC9: Presigned URL Upload Still Uses S3
**Given** a user uploads a new image
**When** the backend generates presigned URL for upload
**Then** the presigned URL still points to S3 (uploads go directly to S3)
**And** CloudFront is NOT used for uploads (read-only CDN)
**And** after upload completion, the image is accessible via CloudFront URL

### AC10: Cache Invalidation Strategy Documented
**Given** CloudFront caches images at edge locations
**When** a user updates or deletes an image
**Then** documentation includes cache invalidation strategy:
  - Option 1: Versioned URLs (append `?v={timestamp}` to CloudFront URL)
  - Option 2: CloudFront invalidation API call (for immediate purge)
  - Option 3: Wait for TTL expiration (24 hours)
**And** recommended approach is versioned URLs for instant updates

### AC11: CloudFront Access Logs Enabled
**Given** CloudFront distribution is configured
**When** users access images via CloudFront
**Then** access logs are written to S3 bucket: `lego-moc-cloudfront-logs`
**And** logs include: request timestamp, edge location, cache hit/miss status, user IP, bytes transferred
**And** logs are used for performance monitoring and cost analysis

### AC12: Cost Monitoring for CloudFront
**Given** CloudFront is deployed
**When** images are served via CloudFront
**Then** AWS Cost Explorer tracks CloudFront data transfer costs separately from S3 costs
**And** alerts are configured for unexpected cost increases (> $50/month threshold)
**And** monthly cost reports compare S3 vs CloudFront costs

### AC13: Integration Tests for CloudFront URLs
**Given** MSW test infrastructure from WISH-2011
**When** integration tests run for wishlist API
**Then** tests verify GET /api/wishlist returns CloudFront URLs (not S3 URLs)
**And** tests verify CloudFront URL format matches expected pattern
**And** tests mock CloudFront image serving for frontend rendering tests

### AC14: Performance Benchmarking
**Given** CloudFront is deployed
**When** performance tests are run
**Then** image load times are measured for multiple geographic regions:
  - US East (baseline): < 100ms
  - Europe: < 200ms (vs 400ms pre-CloudFront)
  - Asia: < 300ms (vs 500ms pre-CloudFront)
**And** cache hit ratio is > 80% after warmup period
**And** performance improvements are documented

### AC15: Security - CloudFront OAI Restricts S3 Access
**Given** CloudFront OAI is configured
**When** a user attempts direct S3 access to images
**Then** S3 bucket policy denies direct access (403 Forbidden)
**And** images are only accessible via CloudFront URLs
**And** S3 URLs are blocked for security and cost control

---

## Test Plan

*Comprehensive test coverage for CloudFront integration.*

### Happy Path Tests:

1. **Image Served from CloudFront (Cache Miss):**
   - User requests image for first time
   - CloudFront forwards request to S3 origin
   - S3 returns image to CloudFront
   - CloudFront caches image and serves to user
   - Verify cache status: MISS (X-Cache: Miss from cloudfront)

2. **Image Served from CloudFront (Cache Hit):**
   - User requests same image again
   - CloudFront serves from edge cache (no S3 request)
   - Verify cache status: HIT (X-Cache: Hit from cloudfront)
   - Verify response time < 50ms (edge cache)

3. **New Image Upload Flow:**
   - User uploads new image via presigned S3 URL
   - Backend returns CloudFront URL in response
   - Frontend renders image from CloudFront
   - Image is accessible within 1 minute (CloudFront propagation)

4. **Legacy S3 URL Conversion:**
   - Existing wishlist item has S3 URL in database
   - Backend converts S3 URL to CloudFront URL on-the-fly
   - Frontend receives CloudFront URL
   - Image renders successfully

### Error Cases:

1. **CloudFront Origin Not Accessible:**
   - S3 bucket is temporarily unavailable
   - CloudFront returns 502 Bad Gateway
   - Frontend displays error state: "Image temporarily unavailable"

2. **Image Not Found in S3:**
   - CloudFront requests image from S3
   - S3 returns 404 Not Found
   - CloudFront caches 404 response (short TTL: 5 minutes)
   - Frontend displays placeholder image

3. **CloudFront Distribution Disabled:**
   - Distribution is disabled for maintenance
   - CloudFront returns 503 Service Unavailable
   - Frontend falls back to S3 URL (if configured) or shows error state

4. **Direct S3 Access Blocked:**
   - User attempts to access image via S3 URL directly
   - S3 bucket policy denies request (403 Forbidden)
   - Error message: "Access Denied - Use CDN URL"

### Edge Cases:

1. **Cache Invalidation After Image Update:**
   - User uploads new image, replacing existing image
   - Backend appends version query parameter: `?v={timestamp}`
   - CloudFront treats as new URL (cache miss)
   - Old cached image expires after 24-hour TTL

2. **Large Image (10MB):**
   - User uploads 10MB image (max size from WISH-2013)
   - CloudFront transfers 10MB from S3 on first request
   - Subsequent requests served from edge cache (no S3 transfer)
   - Verify cost savings for frequently accessed large images

3. **Concurrent Requests from Multiple Regions:**
   - Users in US, Europe, Asia request same image simultaneously
   - Each edge location caches image independently
   - All regions experience low latency (< 300ms)
   - Verify global cache distribution

### Required Evidence:

- 15+ unit tests for CloudFront URL generation utilities
- 10+ integration tests for API responses with CloudFront URLs
- Performance benchmarks for image load times (pre/post CloudFront)
- CloudFront access logs showing cache hit/miss ratios
- AWS Cost Explorer showing CloudFront vs S3 cost comparison

---

## Reuse Plan

### Reuse from WISH-2013 (Security Hardening)

1. **S3 Bucket Configuration:**
   - Extend existing S3 bucket policy to allow CloudFront OAI access
   - Maintain existing HTTPS-only enforcement
   - Maintain existing IAM policy restrictions

2. **Presigned URL Flow:**
   - No changes to presign endpoint (uploads still go to S3)
   - CloudFront serves images read-only (no uploads via CDN)

### Reuse from WISH-2011 (Test Infrastructure)

1. **MSW Handlers:**
   - Extend MSW handlers to mock CloudFront URL responses
   - Add CloudFront cache headers (X-Cache, Age) to mock responses
   - Reuse existing integration test patterns

### Reusable Components for Future Stories

1. **CloudFront Utilities:**
   - `cloudfront.ts` can be reused for other image-serving features (MOC instructions, gallery, sets)
   - URL generation logic is domain-agnostic (works for any S3 key)

2. **CDN Infrastructure:**
   - CloudFront distribution can be extended to serve other static assets (CSS, JS, fonts)
   - OAI pattern is reusable for other S3 buckets requiring CDN

3. **Performance Monitoring:**
   - CloudFront access logs and metrics can be reused for other CDN-served features
   - Cost monitoring dashboards can track all CloudFront distributions

---

## Architecture Notes

### CloudFront Distribution Configuration

**Origin Configuration:**
- **Origin Domain:** `lego-moc-wishlist-uploads.s3.amazonaws.com`
- **Origin Path:** `/` (root of bucket)
- **Origin Access Identity (OAI):** `cloudfront-oai-wishlist`
- **Protocol:** HTTPS only (S3 bucket endpoint supports HTTPS)

**Cache Behavior:**
- **Path Pattern:** `/uploads/wishlist/*`
- **Viewer Protocol Policy:** Redirect HTTP to HTTPS
- **Allowed HTTP Methods:** GET, HEAD, OPTIONS (read-only)
- **Cache Policy:** CachingOptimized (AWS managed policy)
- **TTL Settings:**
  - Default TTL: 86400 seconds (24 hours)
  - Max TTL: 31536000 seconds (1 year)
  - Min TTL: 0 seconds (respect Cache-Control headers)

**Price Class:**
- **MVP:** PriceClass_100 (US, Canada, Europe only) - cheapest option
- **Future:** PriceClass_All (all edge locations worldwide) - if global user base grows

**Compression:**
- **Enabled:** Yes (gzip, brotli for text-based formats)
- **Note:** Image compression not needed (images are binary, already compressed)

### S3 Bucket Policy Update

Add policy statement to allow CloudFront OAI access:

```json
{
  "Sid": "AllowCloudFrontOAI",
  "Effect": "Allow",
  "Principal": {
    "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity {OAI_ID}"
  },
  "Action": "s3:GetObject",
  "Resource": "arn:aws:s3:::lego-moc-wishlist-uploads/uploads/wishlist/*"
}
```

Add policy statement to block direct S3 access (enforce CloudFront-only):

```json
{
  "Sid": "DenyDirectS3Access",
  "Effect": "Deny",
  "Principal": "*",
  "Action": "s3:GetObject",
  "Resource": "arn:aws:s3:::lego-moc-wishlist-uploads/uploads/wishlist/*",
  "Condition": {
    "StringNotEquals": {
      "aws:UserAgent": "Amazon CloudFront"
    }
  }
}
```

### URL Conversion Logic

**S3 Key to CloudFront URL:**

```typescript
function s3KeyToCloudFrontUrl(s3Key: string): string {
  const distributionDomain = process.env.CLOUDFRONT_DISTRIBUTION_DOMAIN
  // s3Key: "uploads/wishlist/user-123/abc123.jpg"
  // CloudFront URL: "https://d1234abcd.cloudfront.net/uploads/wishlist/user-123/abc123.jpg"
  return `https://${distributionDomain}/${s3Key}`
}
```

**Legacy S3 URL to CloudFront URL:**

```typescript
function s3UrlToCloudFrontUrl(s3Url: string): string {
  // s3Url: "https://s3.amazonaws.com/lego-moc-wishlist-uploads/uploads/wishlist/user-123/abc123.jpg"
  const s3Key = s3Url.replace(/^https:\/\/s3\.amazonaws\.com\/lego-moc-wishlist-uploads\//, '')
  return s3KeyToCloudFrontUrl(s3Key)
}
```

### Cache Invalidation Strategy

**Option 1: Versioned URLs (Recommended for MVP):**
- Append query parameter to CloudFront URL: `?v={timestamp}`
- When image is updated, generate new timestamp
- CloudFront treats as different URL (cache miss)
- No API calls required, instant cache bypass

**Option 2: CloudFront Invalidation API:**
- Call CloudFront CreateInvalidation API when image is updated/deleted
- Purges specific path from all edge locations
- Cost: $0.005 per invalidation path (first 1000 free per month)
- Latency: 5-15 minutes for global propagation

**Option 3: Wait for TTL Expiration:**
- No action required, old cache expires after 24 hours
- Acceptable for non-critical updates (e.g., image edits are rare)

**MVP Recommendation:** Use versioned URLs for instant updates, defer invalidation API to future story.

---

## Infrastructure Notes

### CloudFront Distribution Deployment

**CloudFormation Stack (Recommended):**
- Define CloudFront distribution in CloudFormation template
- Deploy via AWS CLI or CI/CD pipeline
- Outputs: Distribution ID, Distribution Domain
- Update environment variables: `CLOUDFRONT_DISTRIBUTION_DOMAIN`

**Manual Setup (Alternative):**
- AWS Console → CloudFront → Create Distribution
- Select S3 origin, configure OAI, set cache behaviors
- Copy distribution domain to environment variables

### Cost Estimation

**S3 Costs (Pre-CloudFront):**
- Storage: 1 GB images → $0.023/month
- Data Transfer: 10 GB/month → $0.90/month
- Requests: 100,000 GET requests → $0.40/month
- **Total S3:** ~$1.33/month

**CloudFront Costs (Post-CloudFront):**
- Data Transfer (US): 10 GB/month → $0.85/month
- Requests: 100,000 GET requests → $0.10/month
- **Total CloudFront:** ~$0.95/month

**Savings:** $0.38/month (~29% reduction)

**Note:** Savings increase with traffic volume. At 100 GB/month, savings are ~$5/month. For global users (non-US regions), savings are even higher due to CloudFront's lower international data transfer costs.

### Performance Benchmarks (Expected)

**Image Load Times (Pre-CloudFront):**
- US East (same region as S3): ~80ms
- Europe (cross-region): ~400ms
- Asia (cross-region): ~600ms

**Image Load Times (Post-CloudFront):**
- US East (edge location): ~60ms (25% faster)
- Europe (edge location): ~120ms (70% faster)
- Asia (edge location): ~200ms (67% faster)

**Cache Hit Ratio:** > 80% after warmup period (24-48 hours)

---

## HTTP Contract Plan

### No New Endpoints Created

This story enhances existing endpoints to return CloudFront URLs instead of S3 URLs. No new HTTP routes.

### Enhanced GET /api/wishlist (Existing)

**Response - Before (S3 URL):**
```json
{
  "items": [
    {
      "id": "item-123",
      "title": "LEGO Set 12345",
      "imageUrl": "https://s3.amazonaws.com/lego-moc-wishlist-uploads/uploads/wishlist/user-123/abc123.jpg"
    }
  ]
}
```

**Response - After (CloudFront URL):**
```json
{
  "items": [
    {
      "id": "item-123",
      "title": "LEGO Set 12345",
      "imageUrl": "https://d1234abcd.cloudfront.net/uploads/wishlist/user-123/abc123.jpg"
    }
  ]
}
```

**Contract Compatibility:** Fully backward compatible. Frontend expects `imageUrl` field, domain change is transparent.

### Enhanced GET /api/wishlist/:id (Existing)

**Response - Before (S3 URL):**
```json
{
  "id": "item-123",
  "title": "LEGO Set 12345",
  "imageUrl": "https://s3.amazonaws.com/lego-moc-wishlist-uploads/uploads/wishlist/user-123/abc123.jpg"
}
```

**Response - After (CloudFront URL):**
```json
{
  "id": "item-123",
  "title": "LEGO Set 12345",
  "imageUrl": "https://d1234abcd.cloudfront.net/uploads/wishlist/user-123/abc123.jpg"
}
```

**Contract Compatibility:** Fully backward compatible.

---

## Seed Requirements

**Not applicable.** CloudFront infrastructure does not require database seeds.

**Test Seeds:**
- Existing wishlist items with S3 URLs can be used for migration testing
- No new seed data required

---

## UI/UX Notes

### User-Facing Changes

**No User-Facing Changes:** CloudFront integration is transparent to users. Images load faster from edge locations, but UI/UX remains unchanged.

**Developer-Facing Changes:**
- Browser network tab shows requests to `*.cloudfront.net` instead of `s3.amazonaws.com`
- CloudFront cache headers visible in browser DevTools (X-Cache, Age)

### Performance Improvements (Perceived)

- **Faster Page Loads:** Images load 50-70% faster for global users (Europe, Asia)
- **Reduced Spinner Time:** Gallery view loads images more quickly, reducing "loading" states
- **Better Mobile Experience:** Faster image loads on slower mobile networks

### No Design System Changes

This story uses existing image components. No UI changes needed.

---

## Dependencies

### Blocked By:

- **WISH-2013** (File Upload Security Hardening) - Required for S3 security configuration and image upload flow
  - CloudFront OAI depends on S3 bucket policy from WISH-2013
  - CloudFront serves images uploaded via WISH-2013 presign flow

### Blocks:

- **WISH-2016** (Image Optimization) - Lambda@Edge for on-the-fly image transformations requires CloudFront
- Future CDN-dependent features (video streaming, large file downloads)

### Internal Package Dependencies:

- `@repo/api-client` - Zod schemas for image URLs (no changes)
- `@repo/logger` - Logging for CloudFront URL generation
- `@repo/ui` - Existing image components (no changes)

### External Dependencies:

- **Amazon CloudFront:** AWS service for CDN
- **Origin Access Identity (OAI):** AWS resource for S3-CloudFront integration
- **CloudFormation/Terraform:** IaC for CloudFront distribution deployment

---

## Risks & Mitigations

### Risk 1: CloudFront Propagation Delay After Deployment

**Description:** CloudFront distribution takes 15-30 minutes to deploy to all edge locations globally. During this time, image requests may fail or return inconsistent results.

**Likelihood:** High
**Impact:** Medium (Temporary image loading failures during deployment)

**Mitigation:**
- Deploy CloudFront during low-traffic window (e.g., 2am UTC)
- Monitor CloudFront distribution status before switching frontend to CloudFront URLs
- Use blue-green deployment: keep S3 URLs active until CloudFront is fully deployed
- Add feature flag for CloudFront rollout (gradual migration)

---

### Risk 2: Cache Invalidation Lag After Image Updates

**Description:** When a user updates or replaces an image, CloudFront edge cache may serve stale image for up to 24 hours (default TTL), confusing users.

**Likelihood:** Medium
**Impact:** Medium (User sees old image after update)

**Mitigation:**
- **Use versioned URLs (recommended):** Append `?v={timestamp}` to CloudFront URL when image is updated
- Versioned URLs bypass cache instantly (no API calls, no cost)
- Document cache invalidation strategy for developers
- Alternative: Call CloudFront invalidation API (costs $0.005 per path, 5-15 min propagation)

---

### Risk 3: CloudFront Costs Exceed Budget

**Description:** If traffic spikes unexpectedly (e.g., viral post, bot scraping), CloudFront data transfer costs could exceed budget.

**Likelihood:** Low
**Impact:** High (Unexpected AWS bill)

**Mitigation:**
- Set up AWS Budgets alert for CloudFront costs (threshold: $50/month)
- Monitor CloudFront access logs for unusual traffic patterns (bot user-agents)
- Enable AWS WAF (Web Application Firewall) to block malicious traffic
- Use CloudFront geo-restriction to block specific countries if abuse detected
- Add rate limiting at API layer (WISH-2008 authorization checks)

---

### Risk 4: OAI Misconfiguration Blocks S3 Access

**Description:** Incorrect OAI configuration or S3 bucket policy could block CloudFront from accessing S3 origin, causing all image requests to fail (502 Bad Gateway).

**Likelihood:** Low
**Impact:** High (Complete image outage)

**Mitigation:**
- Validate S3 bucket policy in staging environment before production deployment
- Add integration test to verify CloudFront can access S3 origin (AC13)
- Use CloudFormation/Terraform for IaC to prevent manual errors
- Monitor CloudFront origin response codes (5xx errors trigger alert)
- Rollback plan: Revert S3 bucket policy and disable CloudFront distribution within 5 minutes

---

### Risk 5: Direct S3 Access Blocked Too Early

**Description:** If S3 bucket policy blocks direct access before CloudFront is fully deployed, existing S3 URLs in production will break, causing image outage.

**Likelihood:** Medium
**Impact:** High (Image outage for existing users)

**Mitigation:**
- **Phased rollout:** Deploy CloudFront first, wait 24 hours for cache warmup
- Then update frontend to use CloudFront URLs (gradual rollout via feature flag)
- Finally, block direct S3 access in bucket policy (after confirming CloudFront works)
- Monitor error rates during each phase, rollback if errors spike
- Keep S3 access open for 1 week after CloudFront deployment as safety buffer

---

## Definition of Done

- [ ] CloudFront distribution created with S3 origin (AC1)
- [ ] HTTPS-only access enforced (AC2)
- [ ] Cache behavior configured with 24-hour TTL (AC3)
- [ ] CloudFront URL generation utilities implemented (AC4)
- [ ] GET /api/wishlist returns CloudFront URLs (AC5)
- [ ] GET /api/wishlist/:id returns CloudFront URL (AC6)
- [ ] Frontend renders images from CloudFront (AC7)
- [ ] Backward compatibility for existing S3 URLs (AC8)
- [ ] Presigned URL upload still uses S3 (AC9)
- [ ] Cache invalidation strategy documented (AC10)
- [ ] CloudFront access logs enabled (AC11)
- [ ] Cost monitoring configured (AC12)
- [ ] Integration tests for CloudFront URLs (AC13)
- [ ] Performance benchmarking completed (AC14)
- [ ] OAI restricts direct S3 access (AC15)
- [ ] All unit tests pass (15+ for URL generation)
- [ ] All integration tests pass (10+ for API responses)
- [ ] Performance benchmarks meet targets (< 200ms Europe, < 300ms Asia)
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] Code reviewed and approved
- [ ] Infrastructure deployed (CloudFront, OAI, S3 policy updates)
- [ ] Staging environment validation complete
- [ ] Performance review approved

---

## Out of Scope (Future Work)

- **Image Transformations (Lambda@Edge):** On-the-fly resizing, format conversion (WebP), compression → Defer to WISH-2016 (Image Optimization)
- **Custom Domain:** Using `cdn.lego-moc.com` instead of CloudFront default domain → Defer to branding story
- **Cache Invalidation UI:** Admin UI for manual cache purge → Defer to admin dashboard story
- **Multi-CDN Strategy:** Using multiple CDN providers (Cloudflare, Fastly) → Defer to future redundancy story
- **Video/PDF CDN:** Serving non-image files via CloudFront → Defer to future media story
- **Advanced Caching:** Edge-side includes (ESI), dynamic content caching → Defer to future performance story

---

## Notes

### Implementation Approach (Recommended):

1. **Deploy CloudFront Infrastructure:**
   - Create CloudFormation template for CloudFront distribution
   - Deploy OAI (Origin Access Identity)
   - Configure S3 bucket policy to allow OAI access
   - Wait for CloudFront distribution to deploy (~20 minutes)
   - Validate CloudFront can access S3 origin (manual test)

2. **Implement CloudFront URL Generation:**
   - Create `cloudfront.ts` utilities for URL conversion
   - Add environment variable: `CLOUDFRONT_DISTRIBUTION_DOMAIN`
   - Write unit tests for URL generation logic (15+ tests)

3. **Update API Layer:**
   - Modify wishlist service to return CloudFront URLs in GET responses
   - Add URL conversion for legacy S3 URLs (backward compatibility)
   - Write integration tests for API responses (10+ tests)

4. **Update Frontend (Optional - Transparent):**
   - No code changes required (frontend uses `imageUrl` field as-is)
   - Verify images render from CloudFront in browser DevTools

5. **Performance Benchmarking:**
   - Measure image load times from multiple regions (US, Europe, Asia)
   - Compare pre/post CloudFront performance
   - Document improvements

6. **Gradual Rollout (Feature Flag):**
   - Use feature flag to control CloudFront URL rollout (10% → 50% → 100%)
   - Monitor error rates and performance during rollout
   - Rollback if issues detected

7. **Block Direct S3 Access (Final Step):**
   - After CloudFront is stable for 1 week, update S3 bucket policy to deny direct access
   - Enforce CloudFront-only access for security and cost control

### Quality Gates:

- All integration tests pass with CloudFront URLs
- Performance benchmarks meet targets (< 200ms Europe, < 300ms Asia)
- Cache hit ratio > 80% after 24-hour warmup
- CloudFront costs < S3 costs (validate in AWS Cost Explorer)
- No 5xx errors from CloudFront origin

---
