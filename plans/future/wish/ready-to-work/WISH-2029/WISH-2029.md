---
id: WISH-2029
title: Update architecture documentation for lego-api/domains/ pattern
status: ready-to-work
created: 2026-01-28
category: Technical Debt / Documentation
dependencies: [WISH-2009]
follows_from: WISH-2009
phase: 2 - Infrastructure
impact: Medium
effort: Low
---

# WISH-2029: Update architecture documentation for lego-api/domains/ pattern

## Context

The codebase has migrated from the old `services/{domain}/` pattern to a new hexagonal architecture pattern located at `apps/api/lego-api/domains/{domain}/`. All six existing backend domains (gallery, wishlist, health, instructions, sets, parts-lists) now follow this new structure with proper separation of concerns:

- `application/` - Business logic (ports)
- `adapters/` - Infrastructure adapters (database, storage)
- `ports/` - Interface definitions
- `routes.ts` - Hono HTTP routes
- `types.ts` - Zod schemas and types
- `__tests__/` - Domain tests

However, the architecture documentation (`docs/architecture/api-layer.md`) still references the deprecated `services/{domain}/` pattern, creating confusion for developers implementing new features or understanding the codebase structure.

This documentation gap was identified during QA elaboration of WISH-2009 (Gap #2 - AC 18 follow-up).

---

## Goal

Update `docs/architecture/api-layer.md` to accurately document the current `apps/api/lego-api/domains/` hexagonal architecture pattern as the canonical approach for all backend domain development.

**Success means:**
- Architecture documentation reflects actual codebase structure
- New developers can follow clear guidance on implementing domains
- Migration path from old pattern is clearly stated
- Cross-domain dependency patterns are documented
- Documentation remains accurate over time (with verification dates)

---

## Non-Goals

- Migrating existing legacy code to new pattern (separate effort)
- Creating automated migration tooling
- Adding visual diagrams or videos (future enhancement)
- Documenting every possible edge case or advanced pattern
- Updating generator templates (separate story: potential WISH-2030)

---

## Scope

### Documentation Files Affected

**Primary:**
- `docs/architecture/api-layer.md` - Complete rewrite of architecture documentation

**Reference (Verification Only):**
- `apps/api/lego-api/domains/gallery/` - Example domain
- `apps/api/lego-api/domains/wishlist/` - Example with cross-domain dependencies
- `apps/api/lego-api/domains/health/` - Simplest example
- `apps/api/lego-api/domains/instructions/` - Example domain
- `apps/api/lego-api/domains/sets/` - Example domain
- `apps/api/lego-api/domains/parts-lists/` - Example domain
- `CLAUDE.md` - Cross-reference for consistency check

### Content Requirements

The updated documentation must include:

1. **Directory Structure Tree** showing `apps/api/lego-api/domains/{domain}/` pattern
2. **Subdirectory Responsibilities** explaining:
   - `application/` = business logic (ports)
   - `adapters/` = infrastructure (repositories, storage)
   - `ports/` = interface definitions
   - `routes.ts` = Hono HTTP routing layer
   - `types.ts` = Zod schemas and TypeScript types
   - `__tests__/` = domain-specific tests

3. **Hexagonal Architecture Explanation**
   - Ports and adapters pattern overview
   - Separation of concerns (business logic vs infrastructure)
   - Dependency injection patterns
   - Why this pattern was chosen

4. **Real Code Examples** from existing domains (use wishlist or health as primary examples)

5. **"Creating a New Domain" Step-by-Step Guide**
   - Directory structure setup
   - File creation order
   - Dependency wiring
   - Testing setup

6. **Hono Framework Usage Patterns**
   - Route definition in routes.ts
   - Request validation with Zod
   - Response formatting
   - Error handling

7. **Shared Schema Patterns**
   - Backend owns Zod schemas (in types.ts)
   - Frontend imports via `@repo/api-client`
   - Schema versioning considerations

8. **Migration Notes**
   - Old pattern: `services/{domain}/` (deprecated)
   - New pattern: `apps/api/lego-api/domains/{domain}/` (canonical)
   - When to migrate (as files are touched)
   - How to migrate (extract business logic to application/, infrastructure to adapters/)

9. **Architecture Decision Rationale**
   - Why hexagonal architecture
   - Benefits for testing
   - Platform independence
   - Scalability considerations

10. **Cross-Domain Dependencies**
    - How to handle dependencies between domains
    - Dependency injection via composition root
    - Example: wishlist -> sets (purchase flow)

11. **Testing Strategy**
    - Unit tests for application layer
    - Integration tests for adapters
    - Route testing patterns

12. **Last Verified Date**
    - Include "Last Verified: 2026-01-28" field
    - Document process for updating verification date

---

## Acceptance Criteria

### Documentation Content (ACs 1-9)

1. **AC1:** Documentation includes directory structure tree showing `apps/api/lego-api/domains/{domain}/` pattern with all subdirectories (application/, adapters/, ports/, routes.ts, types.ts, __tests__/)

2. **AC2:** Each subdirectory's responsibility is clearly documented (application = business logic, adapters = infrastructure, ports = interfaces)

3. **AC3:** Hexagonal architecture (ports & adapters) is explained with rationale for why this pattern was chosen

4. **AC4:** At least one complete domain example is included (preferably wishlist or health) with real code snippets

5. **AC5:** "Creating a New Domain" step-by-step guide is present and actionable

6. **AC6:** Hono framework usage patterns are documented (routing, validation, responses, errors)

7. **AC7:** Shared schema pattern is documented (backend owns Zod schemas, frontend imports via @repo/api-client)

8. **AC8:** Migration notes clearly state:
   - Old pattern: `services/{domain}/` is deprecated
   - New pattern: `apps/api/lego-api/domains/{domain}/` is canonical
   - Migration steps are provided

9. **AC9:** Cross-domain dependency pattern is documented with example (e.g., wishlist -> sets)

### Verification & Quality (ACs 10-14)

10. **AC10:** All 6 existing domains verified to follow documented pattern (gallery, wishlist, health, instructions, sets, parts-lists)

11. **AC11:** Documentation cross-references actual code (examples match real domain structure)

12. **AC12:** No contradictions with `CLAUDE.md` guidelines (Zod-first, no barrel files, etc.)

13. **AC13:** "Last Verified: 2026-01-28" date field is present in documentation

14. **AC14:** Old pattern references (`services/{domain}/`) only appear in migration/historical context (clearly marked as deprecated)

---

## Reuse Plan

**Existing Packages/Components:**
- No code changes - documentation only
- Reference existing domain implementations as source of truth

**Existing Patterns to Follow:**
- Use wishlist domain as primary example (most complete with cross-domain dependencies)
- Use health domain as simplest example (minimal complexity)
- Follow CLAUDE.md documentation standards (markdown format, code blocks with language tags)

**No New Packages Required:**
- This is documentation work only

---

## Architecture Notes

### Hexagonal Architecture (Ports & Adapters)

The documented pattern follows hexagonal architecture principles:

**Layers:**
1. **Application Layer (Ports)** - Business logic, platform-agnostic
   - Location: `application/`
   - Pure functions, domain rules, orchestration
   - No HTTP knowledge, no infrastructure dependencies

2. **Adapters Layer** - Infrastructure implementations
   - Location: `adapters/`
   - Database repositories (Drizzle)
   - Storage adapters (S3)
   - External service integrations

3. **Ports Layer** - Interface definitions
   - Location: `ports/`
   - Repository interfaces
   - Service interfaces
   - Dependency contracts

4. **HTTP Adapter** - Web framework routing
   - Location: `routes.ts`
   - Hono route definitions
   - Request parsing, validation (Zod)
   - Response formatting
   - Calls application layer services

5. **Types Layer** - Schemas and types
   - Location: `types.ts`
   - Zod schemas (runtime validation)
   - TypeScript types (compile-time)
   - Shared with frontend via `@repo/api-client`

**Benefits:**
- Business logic is testable without HTTP
- Easy to swap infrastructure (e.g., Postgres -> DynamoDB)
- Clear separation of concerns
- Platform-independent core domain

---

## Infrastructure Notes

**No Infrastructure Changes Required**

This story is documentation-only. No deployment, database, or infrastructure changes are needed.

**Documentation Deployment:**
- Changes committed to version control
- Available to all developers via Git
- No build or deploy process required

---

## HTTP Contract Plan

**N/A - No API Changes**

This story does not modify any HTTP endpoints or API contracts. It only updates documentation to reflect the existing architecture pattern.

---

## Seed Requirements

**N/A - Documentation Only**

No seed data or database changes are required.

---

## Test Plan

> **Note:** This is a documentation-only story. Testing focuses on documentation quality, accuracy, and completeness.

### Scope Summary

- **Endpoints touched:** None
- **UI touched:** No
- **Data/storage touched:** No
- **Documentation touched:** Yes (`docs/architecture/api-layer.md`)

### Happy Path Tests

#### Test 1: Documentation Content Completeness

**Setup:**
- Read updated `docs/architecture/api-layer.md`
- Review all 6 existing domains in `apps/api/lego-api/domains/`

**Action:**
- Verify documentation includes all required sections per acceptance criteria
- Confirm examples match actual codebase structure

**Expected Outcome:**
- All 14 acceptance criteria are met
- Documentation is comprehensive and accurate

**Evidence:**
- Acceptance criteria checklist (all checked)
- Cross-reference validation showing examples match real code

#### Test 2: Cross-Reference Accuracy

**Setup:**
- Open `docs/architecture/api-layer.md`
- Open `apps/api/lego-api/domains/wishlist/` as reference

**Action:**
- Verify documented structure matches actual domain structure
- Check file paths in examples are correct

**Expected Outcome:**
- All file paths are accurate
- Directory structure diagram matches actual folders

**Evidence:**
- Side-by-side comparison documentation vs. actual code
- File tree output from domain directory

#### Test 3: Migration Guidance Clarity

**Setup:**
- Read "Migration Path" section in updated doc

**Action:**
- Verify documentation clearly states old vs. new pattern
- Confirm migration steps are actionable

**Expected Outcome:**
- Clear distinction between deprecated and canonical patterns
- Migration path is step-by-step

**Evidence:**
- Migration section is present and clear
- Old pattern clearly marked as deprecated

#### Test 4: Pattern Consistency Verification

**Setup:**
- Review all 6 domains: gallery, wishlist, health, instructions, sets, parts-lists

**Action:**
- Verify each domain has required subdirectories (application/, adapters/, ports/, routes.ts, types.ts, __tests__/)

**Expected Outcome:**
- All domains follow consistent structure
- Documentation accurately describes the pattern

**Evidence:**
- File tree output for each domain
- Checklist confirming structure presence

### Error Cases

#### Error 1: Documentation Contradicts CLAUDE.md

**Setup:**
- Read `docs/architecture/api-layer.md` and `CLAUDE.md`

**Action:**
- Check for contradictions

**Expected Outcome:**
- No contradictions found
- Both docs promote same guidelines (Zod-first, no barrel files)

**Evidence:**
- Cross-reference checklist showing alignment

#### Error 2: Outdated References Remain

**Setup:**
- Search documentation for old pattern references

**Action:**
- Search for `services/{domain}/` references

**Expected Outcome:**
- Old pattern only mentioned in migration/historical context
- Clearly marked as deprecated

**Evidence:**
- Grep results showing old pattern references only in migration section

#### Error 3: Missing Domain Example

**Setup:**
- Read documentation examples section

**Action:**
- Verify at least one complete domain example exists

**Expected Outcome:**
- Complete example with all layers demonstrated

**Evidence:**
- Example code blocks present and accurate

### Edge Cases

#### Edge 1: Documentation Drift Detection

**Action:**
- Verify "Last Verified: YYYY-MM-DD" field exists

**Expected Outcome:**
- Verification date present (2026-01-28)

**Evidence:**
- Date field in documentation header

#### Edge 2: Cross-Domain Dependencies Example

**Action:**
- Verify cross-domain dependency guidance (e.g., wishlist -> sets)

**Expected Outcome:**
- Dependency injection pattern documented

**Evidence:**
- Cross-domain section with real example

#### Edge 3: Testing Strategy for Domains

**Action:**
- Verify testing guidance is included

**Expected Outcome:**
- Test organization documented

**Evidence:**
- Testing section in documentation

### Verification Commands

```bash
# Verify all domains follow documented structure
for domain in gallery wishlist health instructions sets parts-lists; do
  echo "Checking $domain..."
  ls -la /Users/michaelmenard/Development/Monorepo/apps/api/lego-api/domains/$domain
done

# Check for old pattern usage (should be minimal/zero in docs)
grep -n "services/{domain}" /Users/michaelmenard/Development/Monorepo/docs/architecture/api-layer.md
```

### Test Completion Criteria

- [ ] All acceptance criteria verified (14/14)
- [ ] Examples cross-referenced against actual code
- [ ] Old pattern references only in migration context
- [ ] All 6 domains verified to follow pattern
- [ ] CLAUDE.md compatibility confirmed
- [ ] "Last Verified" date present
- [ ] Migration guidance is actionable
- [ ] Cross-domain dependency pattern documented
- [ ] Testing guidance included
- [ ] Markdown linting passes

---

## UI/UX Notes

**N/A - No UI Changes**

This story is documentation-only with no frontend or user interface changes.

---

## Implementation Notes

### Recommended Approach

1. **Pattern Analysis Phase**
   - Review all 6 existing domains for structural consistency
   - Document any variations (intentional vs inconsistencies)
   - Identify best example domains (wishlist for complexity, health for simplicity)

2. **Documentation Writing Phase**
   - Start with directory structure tree
   - Write subdirectory responsibility descriptions
   - Add hexagonal architecture explanation
   - Include real code examples from wishlist/health domains
   - Write "Creating a New Domain" step-by-step guide
   - Document Hono patterns, schema patterns, migration notes
   - Add cross-domain dependency example

3. **Validation Phase**
   - Cross-reference all examples against actual code
   - Check CLAUDE.md for contradictions
   - Verify old pattern references only in migration section
   - Add "Last Verified: 2026-01-28" field
   - Run markdown linting

4. **Review Phase**
   - Final read-through for clarity
   - Ensure all 14 acceptance criteria met
   - Verify actionable guidance for new developers

### Estimated Effort

**4-6 hours total:**
- 1 hour: Review all 6 domains for pattern consistency
- 2 hours: Write new documentation sections
- 1 hour: Create examples and code snippets
- 1 hour: Cross-reference validation
- 0.5 hour: CLAUDE.md compatibility check
- 0.5 hour: Final review and polish

### No Technical Blockers

- All required information exists in codebase
- No dependencies on other stories (WISH-2009 is prerequisite)
- No infrastructure setup required
- No deployment coordination needed

---

## Dependencies

**Depends On:**
- **WISH-2009** - Must be complete (this story is a follow-up from WISH-2009 QA elaboration)

**Blocks:**
- None (documentation doesn't block other work)

**Related:**
- Future: Update generator templates to match documented pattern (potential WISH-2030)

---

## Risks

### Risk 1: Documentation Drift Over Time
**Likelihood:** Medium
**Impact:** Medium
**Mitigation:**
- Include "Last Verified: YYYY-MM-DD" field
- Add reminder to update docs when new domains are created
- Consider PR template checklist for architecture changes

### Risk 2: Contradictions with CLAUDE.md
**Likelihood:** Low
**Impact:** High (conflicting guidance confuses developers)
**Mitigation:**
- Explicit cross-check during documentation writing
- Ensure both docs promote same principles (Zod-first, no barrel files)

### Risk 3: Incomplete Pattern Coverage
**Likelihood:** Low
**Impact:** Medium
**Mitigation:**
- Review all 6 existing domains before documenting
- Note any structural variations
- Provide guidance for edge cases

### Risk 4: Ambiguity for Future Implementers
**Likelihood:** Low
**Impact:** Medium
**Mitigation:**
- Include concrete step-by-step "Creating a New Domain" guide
- Use real code examples from existing domains
- Make examples copy-pasteable and actionable

---

## Future Considerations

**Post-MVP Enhancements:**
- Add sequence diagrams for request flow through layers
- Create video walkthrough of domain structure
- Add architecture decision record (ADR) for pattern choice
- Update generator templates to automate domain creation
- Add FAQ section for common questions
- Include troubleshooting guide

**Related Stories:**
- Update `pnpm turbo gen api-endpoint` generator to create domains/ structure
- Create automated migration tool for old-to-new pattern conversion
- Add visual architecture diagrams to documentation

---

## Definition of Done

- [ ] `docs/architecture/api-layer.md` updated with all required sections
- [ ] All 14 acceptance criteria verified and met
- [ ] Examples cross-referenced against actual domain code
- [ ] All 6 domains verified to follow documented pattern
- [ ] CLAUDE.md compatibility confirmed (no contradictions)
- [ ] "Last Verified: 2026-01-28" field present
- [ ] Old pattern clearly marked as deprecated (only in migration section)
- [ ] Markdown linting passes
- [ ] Documentation committed to version control
- [ ] Peer review completed (if applicable)

---

**Story Type:** Documentation / Technical Debt
**Category:** Infrastructure / Architecture
**Phase:** 2 - Infrastructure
**Impact:** Medium (prevents future confusion, improves developer onboarding)
**Effort:** Low (4-6 hours)
**Confidence:** High (straightforward documentation work)
