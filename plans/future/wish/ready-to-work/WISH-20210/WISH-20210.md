---
doc_type: story
title: "WISH-20210: Schema Change Impact Analysis Tool"
story_id: WISH-20210
story_prefix: WISH
status: ready-to-work
phase: 3
created_at: "2026-01-29T19:00:00-07:00"
updated_at: "2026-01-31T02:00:00-07:00"
depends_on: [WISH-2057]
follow_up_from: WISH-2057
estimated_points: 5
---

# WISH-20210: Schema Change Impact Analysis Tool

## Follow-up Context

**Parent Story:** WISH-2057
**Source:** QA Discovery Notes - Follow-up Stories Suggested (Finding #4)
**Original Finding:** "Schema change impact analysis tool (which services/endpoints affected?)"
**Category:** Enhancement Opportunity
**Impact:** High
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-2057 as a critical tool for understanding the impact of database schema changes across the codebase. Without automated impact analysis, developers must manually search for affected code, leading to missed dependencies and potential runtime failures.

## Context

WISH-2057 establishes comprehensive schema evolution policies and procedures for safe database modifications. However, these policies don't address a critical operational challenge: **understanding which services, endpoints, and frontend components are affected by a proposed schema change**.

In a monorepo with multiple apps (`apps/api/lego-api`, `apps/web/*`) and shared packages (`packages/backend/database-schema`, `packages/core/api-client`), a single column addition or enum value change can ripple across:

- **Backend**: Domain services, repositories, routes, adapters
- **Frontend**: RTK Query hooks, type definitions, components
- **Shared Schemas**: Zod schemas, TypeScript types, API contracts

Manual analysis is error-prone and time-consuming. Developers need an automated tool that:
1. Analyzes a proposed schema change (column addition, enum value, type change)
2. Scans the codebase for affected files (TypeScript imports, Drizzle queries, Zod schemas)
3. Generates an impact report identifying services, endpoints, and components requiring updates
4. Provides confidence that no dependencies were missed

This tool complements WISH-2057's policies by providing **automated verification** before schema changes are applied.

## Goal

Build an automated CLI tool that analyzes proposed database schema changes and generates comprehensive impact reports identifying all affected services, endpoints, frontend components, and test files across the monorepo.

## Non-goals

- Real-time impact analysis in CI/CD pipelines (future enhancement)
- Automated code generation for schema changes (separate story)
- Schema migration testing automation (covered by WISH-2057 policy)
- Visual dependency graph UI (future enhancement)
- Cross-repository impact analysis (single monorepo scope for MVP)

## Scope

### CLI Tool: `pnpm db:impact-analysis`

```bash
# Analyze impact of adding a new column
pnpm db:impact-analysis --table wishlist_items --change "add-column:priority:text"

# Analyze impact of adding enum value
pnpm db:impact-analysis --enum wishlist_store --change "add-value:Amazon"

# Analyze impact of renaming a column
pnpm db:impact-analysis --table wishlist_items --change "rename-column:price:priceCents"
```

### Analysis Capabilities

1. **Column Changes**
   - Adding optional columns (safe)
   - Adding required columns (identifies defaults/backfills needed)
   - Renaming columns (identifies all references)
   - Changing column types (identifies type compatibility issues)
   - Dropping columns (identifies orphaned code)

2. **Enum Changes**
   - Adding enum values (identifies validation schemas)
   - Renaming enum values (identifies hardcoded references)
   - Removing enum values (identifies usage sites)

3. **Constraint Changes**
   - Adding indexes (identifies query performance impacts)
   - Adding foreign keys (identifies cascade implications)
   - Modifying constraints (identifies validation logic impacts)

### Impact Report Output

```markdown
# Schema Change Impact Report

## Change Summary
- **Table:** wishlist_items
- **Operation:** add-column
- **Column:** priority (TEXT)
- **Breaking:** No (optional column)

## Backend Impact (15 files)

### Services
- apps/api/lego-api/domains/wishlist/application/wishlist-service.ts
  - GET /api/wishlist (add priority to response)
  - POST /api/wishlist (add priority to create)

### Repositories
- apps/api/lego-api/domains/wishlist/adapters/wishlist-repository.ts
  - insert() query needs priority mapping

### Zod Schemas
- packages/core/api-client/src/schemas/wishlist.ts
  - WishlistItemSchema requires priority field
  - CreateWishlistSchema requires priority field

## Frontend Impact (8 files)

### Components
- apps/web/app-wishlist-gallery/src/components/WishlistCard/index.tsx
  - Display priority badge
- apps/web/app-wishlist-gallery/src/components/WishlistForm/index.tsx
  - Add priority input field

### API Hooks
- packages/core/api-client/src/rtk/wishlist-gallery-api.ts
  - Type definitions updated automatically

## Test Impact (12 files)

### Unit Tests
- apps/api/lego-api/domains/wishlist/__tests__/services.test.ts
  - Update mock data fixtures

### Integration Tests
- apps/web/app-wishlist-gallery/src/pages/__tests__/main-page.test.tsx
  - Update test assertions

## Risk Assessment
- **Breaking Change:** No
- **Backward Compatibility:** Safe (optional column)
- **Rollback Safety:** Safe (old code ignores new column)
- **Deployment Order:** Database first, then app code

## Recommendations
1. Add priority field to WishlistItemSchema (packages/core/api-client)
2. Update wishlist-service.ts to handle priority in create/update
3. Add priority input to WishlistForm component
4. Update all test fixtures with priority: null
5. Consider adding priority filter to GET /api/wishlist endpoint
```

### Packages Affected

- `packages/backend/database-schema/scripts/` - New `impact-analysis.ts` CLI tool
- `packages/backend/database-schema/src/` - Drizzle schema introspection utilities
- `turbo/generators/` - Integration with existing generator templates (optional)

### Technical Implementation

1. **AST-based Code Analysis**
   - Use TypeScript Compiler API to parse source files
   - Search for Drizzle table references (`db.select().from(wishlistItems)`)
   - Search for Zod schema references (`WishlistItemSchema`, `CreateWishlistSchema`)
   - Search for type imports (`import { WishlistItem } from '@repo/api-client'`)

2. **Schema Introspection**
   - Parse Drizzle schema files to understand table structure
   - Identify foreign key relationships and cascade implications
   - Detect enum definitions and usage patterns

3. **Impact Scoring**
   - **High Impact**: Breaking changes (removes columns, changes types)
   - **Medium Impact**: Requires code updates (adds required columns)
   - **Low Impact**: Backward compatible (adds optional columns)

4. **Output Formats**
   - Markdown report (human-readable)
   - JSON report (machine-readable for CI integration)
   - Terminal-formatted output (quick reference)

## Acceptance Criteria

### CLI Tool Basics (AC 1-5)

- [ ] AC 1: CLI tool `pnpm db:impact-analysis` accepts `--table`, `--enum`, and `--change` flags
- [ ] AC 2: Tool analyzes TypeScript files in `apps/api/lego-api/domains/`, `apps/web/`, and `packages/`
- [ ] AC 3: Tool generates Markdown impact report to `packages/backend/database-schema/impact-reports/{timestamp}-{table}.md`
- [ ] AC 4: Tool exits with code 0 for low-impact changes, code 1 for high-impact changes (CI integration)
- [ ] AC 5: Tool supports `--dry-run` flag to preview analysis without generating report

### Column Change Analysis (AC 6-9)

- [ ] AC 6: Adding optional column identifies affected Drizzle queries and Zod schemas
- [ ] AC 7: Adding required column warns about missing defaults and identifies backfill locations
- [ ] AC 8: Renaming column identifies all code references (repositories, services, components)
- [ ] AC 9: Dropping column identifies orphaned code and suggests cleanup tasks

### Enum Change Analysis (AC 10-12)

- [ ] AC 10: Adding enum value identifies Zod enum schemas requiring updates
- [ ] AC 11: Removing enum value identifies usage sites in switch statements and conditionals
- [ ] AC 12: Renaming enum value identifies hardcoded string references (e.g., `store === 'LEGO'`)

### Impact Report Quality (AC 13-16)

- [ ] AC 13: Report groups affected files by category (Backend Services, Repositories, Zod Schemas, Frontend Components, API Hooks, Tests)
- [ ] AC 14: Report includes risk assessment (Breaking/Non-breaking, Rollback Safety, Deployment Order)
- [ ] AC 15: Report provides actionable recommendations for each affected file
- [ ] AC 16: Report estimates effort (Low/Medium/High) based on number of affected files

### Test Coverage (AC 17-19)

- [ ] AC 17: Unit tests cover column addition/removal analysis with mock codebase
- [ ] AC 18: Integration tests validate tool against real `wishlist_items` schema changes
- [ ] AC 19: E2E test generates impact report for hypothetical "priority" column addition and validates output structure

### Documentation (AC 20-22)

- [ ] AC 20: `packages/backend/database-schema/docs/IMPACT-ANALYSIS-TOOL.md` documents CLI usage with examples
- [ ] AC 21: Documentation provides interpretation guide for impact report sections
- [ ] AC 22: Documentation includes troubleshooting guide for common analysis errors

## Reuse Plan

### Existing Patterns

- **TypeScript Compiler API**: Reuse AST parsing patterns from `turbo/generators/` (template validation)
- **Drizzle Introspection**: Build on existing Drizzle schema definitions in `packages/backend/database-schema/src/schema/`
- **CLI Tooling**: Follow existing `pnpm db:*` command conventions (db:generate, db:migrate, db:push)
- **Report Generation**: Reuse Markdown formatting utilities from existing documentation generators

### External Libraries

- `ts-morph` - High-level TypeScript AST manipulation (easier than raw Compiler API)
- `glob` - File pattern matching for codebase scanning
- `chalk` - Terminal output formatting
- `yargs` - CLI argument parsing

## Architecture Notes

### Analysis Pipeline

```typescript
// Conceptual pipeline for impact analysis
const analysisPipeline = {
  1. parseChange: 'Parse --change flag into structured operation',
  2. introspectSchema: 'Load Drizzle schema and identify target table/enum',
  3. scanCodebase: 'Use ts-morph to find references to table/enum',
  4. categorizeImpact: 'Group findings by category (services, components, tests)',
  5. assessRisk: 'Determine breaking/non-breaking, rollback safety',
  6. generateReport: 'Output Markdown/JSON report with recommendations'
}
```

### File Scanning Strategy

**Backend Files:**
- `apps/api/lego-api/domains/*/application/*.ts` - Service layer
- `apps/api/lego-api/domains/*/adapters/*.ts` - Repository layer
- `apps/api/lego-api/domains/*/routes.ts` - Route definitions

**Frontend Files:**
- `apps/web/*/src/components/**/*.tsx` - React components
- `apps/web/*/src/pages/**/*.tsx` - Page components
- `packages/core/api-client/src/rtk/*.ts` - RTK Query hooks

**Shared Schema Files:**
- `packages/core/api-client/src/schemas/*.ts` - Zod schemas
- `packages/backend/database-schema/src/schema/*.ts` - Drizzle schemas

### False Positive Mitigation

**Challenge**: Tool may report false positives (files that import types but don't use affected columns)

**Mitigation Strategies:**
1. **Reference Tracing**: Only report files with actual column references in code (not just type imports)
2. **Confidence Scoring**: Mark findings as "High Confidence" (direct column reference) vs "Low Confidence" (generic type import)
3. **Exclude Patterns**: Skip files in `__tests__/`, `*.spec.ts`, `*.test.ts` in main analysis (separate Test Impact section)

## Infrastructure Notes

### CI Integration (Future Enhancement)

```yaml
# Example GitHub Actions integration
- name: Schema Change Impact Analysis
  run: pnpm db:impact-analysis --table wishlist_items --change "${{ env.SCHEMA_CHANGE }}" --format json

- name: Post Impact Report as PR Comment
  uses: actions/github-script@v6
  with:
    script: |
      const report = require('./impact-reports/latest.json')
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        body: formatImpactReport(report)
      })
```

### Report Storage

- Reports stored in `packages/backend/database-schema/impact-reports/`
- Naming convention: `{timestamp}-{table}-{operation}.md`
- Example: `2026-01-29-wishlist_items-add-column-priority.md`
- `.gitignore` impact-reports directory (ephemeral analysis artifacts)

## Test Plan

### Unit Tests

**Test 1: Column Addition Analysis**
- Mock codebase with references to `wishlist_items.title`
- Run analysis for adding `priority` column
- Assert report identifies affected Zod schemas and services

**Test 2: Enum Value Addition**
- Mock codebase with `wishlist_store` enum references
- Run analysis for adding `Amazon` enum value
- Assert report identifies Zod enum schema requiring update

**Test 3: Column Rename Analysis**
- Mock codebase with references to `wishlist_items.price`
- Run analysis for renaming `price` to `priceCents`
- Assert report identifies all code references requiring updates

**Test 4: Column Type Change**
- Mock codebase with `wishlist_items.price` as `numeric`
- Run analysis for changing type to `integer`
- Assert report warns about type compatibility issues

### Integration Tests

**Test 5: Real Wishlist Schema Analysis**
- Run analysis against actual `wishlist_items` table for hypothetical "priority" column
- Verify report includes `packages/core/api-client/src/schemas/wishlist.ts`
- Verify report includes `apps/api/lego-api/domains/wishlist/` services

**Test 6: Multi-File Impact**
- Add mock references to `wishlist_items` across 10+ files
- Run analysis and verify all files reported
- Check report grouping by category (Backend, Frontend, Tests)

### Edge Cases

**Edge 1: No Impact (Safe Change)**
- Run analysis for adding optional column with no code changes needed
- Verify report marks change as "Low Impact" and "Backward Compatible"

**Edge 2: High Impact (Breaking Change)**
- Run analysis for dropping a column used in 20+ files
- Verify report lists all affected files and marks as "Breaking Change"
- Verify CLI exits with code 1 (error for CI integration)

**Edge 3: Ambiguous References**
- Mock file with generic type import but no actual column usage
- Verify tool correctly excludes from high-confidence findings

## Risk Notes

### MVP-Critical Risks

**Risk 1: False Negatives (Missed Dependencies)**
- Tool may miss dynamic references (e.g., `db.select()[column]` where column is variable)
- **Mitigation**: Document tool limitations; recommend manual code review for high-risk changes

**Risk 2: AST Parsing Performance**
- Scanning entire monorepo TypeScript AST may be slow (>30 seconds)
- **Mitigation**: Implement file caching; only re-scan changed files in subsequent runs

**Risk 3: TypeScript Version Compatibility**
- ts-morph may not support latest TypeScript syntax
- **Mitigation**: Pin ts-morph version; test against monorepo's TypeScript version (5.x)

### Non-MVP Risks

**Risk 4: Maintenance Burden**
- Tool requires updates when new domain modules or packages are added
- **Mitigation**: Use glob patterns instead of hardcoded paths; document extension guide

**Risk 5: Report Format Drift**
- As codebase grows, report format may become too verbose
- **Mitigation**: Implement filtering options (e.g., `--only-backend`, `--exclude-tests`)

## Definition of Done

- [ ] All 22 Acceptance Criteria verified
- [ ] CLI tool `pnpm db:impact-analysis` functional with column and enum analysis
- [ ] Impact reports generated in Markdown format with all required sections
- [ ] Unit tests pass (3+ scenarios: add column, add enum, rename column)
- [ ] Integration test validates tool against real `wishlist_items` schema
- [ ] Documentation created (`IMPACT-ANALYSIS-TOOL.md`) with usage examples
- [ ] Tool tested against hypothetical "priority" column addition
- [ ] Sample impact report reviewed for completeness and actionability
- [ ] Code review completed
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~5k | — | — | Follow-up generation with detailed scope |
| Implementation | ~15k | — | — | CLI tool + AST analysis + report generation |
| Testing | ~8k | — | — | Unit + integration tests |
| Review | ~3k | — | — | Code review + documentation review |
| **Total** | ~31k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-29 19:00 | pm-story-followup-leader | Created follow-up story from WISH-2057 finding #4 (Schema change impact analysis tool) | WISH-20210.md |

---

## Future Enhancement Notes

Once this tool exists, consider:
- **Real-time CI Integration**: Automatically run impact analysis on schema change PRs
- **Visual Dependency Graph**: Generate interactive graph showing table → service → endpoint relationships
- **Automated Test Generation**: Generate skeleton test cases for affected endpoints
- **Cross-Repository Analysis**: Extend to analyze impact across multiple repositories (if monorepo splits)
- **Schema Migration Code Generation**: Auto-generate migration code based on change description
- **Impact Prediction ML Model**: Use historical data to predict effort and risk more accurately

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-31_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | CLI command registration undefined | Not Reviewed | Developer cannot run `pnpm db:impact-analysis` without script registration. Must specify how command is registered in package.json/turbo.json. |
| 2 | False negative limitations not documented | Not Reviewed | Developers will have false confidence in tool completeness, leading to missed dependencies. Requires AC#23: documented known limitations section. |
| 3 | File scanning scope ambiguous | Not Reviewed | Tool may miss frontend impacts or report too many false positives. Clarify: scan `apps/api/lego-api/domains/*`, `apps/web/**/src/**`, `packages/core/api-client/src/**`, `packages/backend/database-schema/src/**`. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Verify existing AST utilities in turbo/generators before adding dependencies | Not Reviewed | Reuse-first approach. Check if TypeScript AST parsing already exists before adding ts-morph to avoid redundant dependencies. |
| 2 | Consider real-time CI integration prototype | Not Reviewed | Could enhance value for schema change workflow automation, but defer to future enhancement per non-goals. |
| 3 | Add JSON output format schema to scope | Not Reviewed | Story mentions `--format json` but doesn't define schema. Add brief example to scope or explicitly defer to Phase 2. |

### Follow-up Stories Suggested

- [x] Real-time CI integration for schema change impact analysis (automated PR comments, blocking checks) → WISH-20400
- [x] Visual dependency graph UI showing table → service → endpoint relationships → WISH-20410
- [ ] Schema migration code generation based on impact analysis recommendations
- [ ] Cross-repository impact analysis (if monorepo is split in future)

### Items Marked Out-of-Scope

- Real-time impact analysis in CI/CD pipelines (future enhancement)
- Automated code generation for schema changes (separate story)
- Schema migration testing automation (covered by WISH-2057 policy)
- Visual dependency graph UI (future enhancement)
- Cross-repository impact analysis (single monorepo scope for MVP)
