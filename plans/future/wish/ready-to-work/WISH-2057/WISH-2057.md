---
doc_type: story
title: "WISH-2057: Schema Evolution Policy and Versioning Strategy"
story_id: WISH-2057
story_prefix: WISH
status: ready-to-work
phase: 1
created_at: "2026-01-28T15:00:00-07:00"
updated_at: "2026-01-29T18:45:00-07:00"
depends_on: [WISH-2007]
follow_up_from: WISH-2007
estimated_points: 2
---

# WISH-2057: Schema Evolution Policy and Versioning Strategy

## Follow-up Context

**Parent Story:** WISH-2007
**Source:** QA Discovery Notes (Enhancement Opportunity #6)
**Original Finding:** "Schema evolution policy documentation - Critical for long-term maintenance, document before any schema modifications"
**Category:** Enhancement Opportunity
**Impact:** High
**Effort:** Medium

This follow-up was identified during QA Elaboration of WISH-2007 as a critical requirement before any future schema modifications occur. PostgreSQL enums are immutable, and without a documented strategy, future changes could require complex migrations or downtime.

## Context

WISH-2007 creates the first `wishlist_items` table with PostgreSQL enums (`wishlist_store`, `wishlist_currency`). The story explicitly defers "schema evolution strategy for future changes" to a follow-up. Before the team performs any schema modifications (adding columns, changing enums, modifying constraints), we need documented policies and procedures.

PostgreSQL enums present a unique challenge: they cannot be modified directly. Adding new values (like a new store "Amazon") requires specific procedures. Without documented strategies, developers may introduce breaking changes or require emergency rollbacks.

This story is a prerequisite for any future schema changes, including:
- Adding new values to `wishlist_store` or `wishlist_currency` enums
- Adding new columns to `wishlist_items`
- Modifying constraints or indexes
- Handling backward compatibility with deployed code

## Goal

Document comprehensive schema evolution policies, versioning strategy, and procedures for safe database schema modifications across all environments. Establish governance for schema changes and provide runbooks for common scenarios.

## Non-goals

- Implementing automated schema versioning tools (future enhancement)
- Migrating existing tables to new schema patterns (no tables exist yet)
- Setting up schema change approval workflows in CI/CD (future enhancement)
- Database backup/restore automation (separate infrastructure concern)

## Scope

### Documentation Deliverables

1. **Schema Evolution Policy** (`packages/backend/database-schema/docs/SCHEMA-EVOLUTION-POLICY.md`)
   - Schema change approval process
   - Breaking vs non-breaking change definitions
   - Backward compatibility requirements
   - Migration file naming conventions
   - Testing requirements for schema changes

2. **Enum Modification Runbook** (`packages/backend/database-schema/docs/ENUM-MODIFICATION-RUNBOOK.md`)
   - Procedure for adding enum values (e.g., new store)
   - Procedure for renaming enum values
   - Procedure for removing enum values (deprecation strategy)
   - Code compatibility considerations (backend + frontend)

3. **Schema Versioning Strategy** (`packages/backend/database-schema/docs/SCHEMA-VERSIONING.md`)
   - Version numbering scheme for schema changes
   - Migration file version tracking
   - Database version metadata table design
   - Rollback version compatibility matrix

4. **Common Schema Change Scenarios** (`packages/backend/database-schema/docs/SCHEMA-CHANGE-SCENARIOS.md`)
   - Adding optional columns (safe)
   - Adding required columns (requires default or backfill)
   - Modifying column types (potentially breaking)
   - Adding indexes (production considerations)
   - Dropping tables/columns (deprecation timeline)

### Packages Affected

- `packages/backend/database-schema/` - New `/docs` directory with 4 documentation files

### Cross-References

- WISH-2007: Parent story that creates initial `wishlist_items` table
- WISH-2000: Schema design story with enum definitions
- Future stories requiring schema changes (WISH-20XX series)

## Acceptance Criteria

### Policy Documentation (AC 1-5)

- [ ] AC 1: `SCHEMA-EVOLUTION-POLICY.md` documents approval process for schema changes (who reviews, what gates)
- [ ] AC 2: Policy defines breaking vs non-breaking changes with examples
- [ ] AC 3: Policy requires migration testing on fresh database before production
- [ ] AC 4: Policy specifies backward compatibility window (e.g., N-1 version support)
- [ ] AC 5: Policy documents migration file naming convention (matches Drizzle pattern `XXXX_description.sql`)

### Enum Modification Runbook (AC 6-9)

- [ ] AC 6: Runbook provides step-by-step procedure for adding enum value (ALTER TYPE... ADD VALUE)
- [ ] AC 7: Runbook documents code deployment order (database first, then app code)
- [ ] AC 8: Runbook includes rollback procedure for failed enum additions
- [ ] AC 9: Runbook warns about enum value removal risks (requires multi-phase migration)

### Versioning Strategy (AC 10-13)

- [ ] AC 10: Versioning doc defines schema version numbering (e.g., semantic versioning: MAJOR.MINOR.PATCH)
- [ ] AC 11: Versioning doc specifies metadata table design (`schema_versions` table with version, applied_at, description)
- [ ] AC 12: Versioning doc includes migration state tracking approach (Drizzle journal + custom metadata)
- [ ] AC 13: Versioning doc defines rollback compatibility rules (which versions can be rolled back safely)

### Common Scenarios Guide (AC 14-18)

- [ ] AC 14: Scenarios doc covers adding optional column (ALTER TABLE... ADD COLUMN)
- [ ] AC 15: Scenarios doc covers adding required column with default or backfill strategy
- [ ] AC 16: Scenarios doc covers adding index (CREATE INDEX CONCURRENTLY for production)
- [ ] AC 17: Scenarios doc covers column type changes (requires data migration + compatibility layer)
- [ ] AC 18: Scenarios doc covers dropping columns (requires deprecation period + tombstone documentation)

### Governance and Review (AC 19-20)

- [ ] AC 19: Policy specifies who must approve schema changes (e.g., Tech Lead + DBA review)
- [ ] AC 20: Policy defines migration risk assessment template (impact, rollback plan, testing evidence)

## Reuse Plan

### Existing Patterns

- **Drizzle Migration System**: Build on existing `drizzle.config.ts` and migration patterns from `packages/backend/database-schema`
- **PostgreSQL Best Practices**: Reference PostgreSQL documentation for enum and constraint modifications
- **Migration Naming**: Extend established convention from migrations 0000-0007

### Industry Standards

- Reference GitHub's approach to large-scale schema changes (gh-ost tool principles)
- Follow Stripe's schema evolution practices (backward compatibility mandates)
- Study Rails Active Record migrations (up/down migration patterns)

## Architecture Notes

### PostgreSQL Enum Immutability

PostgreSQL enums cannot be modified in-place. Adding a new value requires:

```sql
-- Safe: Adding new enum value
ALTER TYPE wishlist_store ADD VALUE 'Amazon';

-- Unsafe: Cannot remove or rename enum values directly
-- Must create new enum, migrate data, drop old enum
```

### Schema Version Metadata Table

Proposed design for tracking schema versions:

```sql
CREATE TABLE schema_versions (
  id SERIAL PRIMARY KEY,
  version TEXT NOT NULL,           -- e.g., "1.2.0"
  migration_file TEXT NOT NULL,    -- e.g., "0007_create_wishlist_items.sql"
  applied_at TIMESTAMP NOT NULL DEFAULT now(),
  applied_by TEXT,                 -- e.g., "deploy-bot" or "developer-name"
  description TEXT,                -- Human-readable change summary
  rollback_safe BOOLEAN DEFAULT false
);
```

### Breaking vs Non-Breaking Changes

**Non-breaking (safe to deploy with old code running):**
- Adding optional columns with defaults
- Adding new enum values
- Adding indexes (with CONCURRENTLY)
- Adding constraints that new code already satisfies

**Breaking (requires coordinated deployment):**
- Removing columns
- Renaming columns
- Changing column types
- Removing enum values
- Adding required columns without defaults

## Infrastructure Notes

### Multi-Environment Schema Synchronization

Schema changes must propagate across environments in order:

1. **Local Development**: Developer tests migration
2. **CI Environment**: Automated migration test on fresh database
3. **Staging**: QA tests migration with production-like data
4. **Production**: Coordinated deployment with rollback plan

### Migration State Tracking

Drizzle tracks applied migrations in `meta/_journal.json`. Our policy must:
- Never manually edit `_journal.json` (Drizzle-managed)
- Use `schema_versions` table for additional metadata
- Implement `db:version` command to show current schema version

### Rollback Considerations

Not all migrations can be safely rolled back:
- Adding columns: Safe (old code ignores new columns)
- Dropping columns: Unsafe (old code expects columns)
- Adding enum values: Safe (old code ignores new values)
- Removing enum values: Unsafe (old code may reference removed values)

Documentation must classify each change type by rollback safety.

## Test Plan

### Documentation Verification Tests

**Test 1: Policy Completeness**
- Read `SCHEMA-EVOLUTION-POLICY.md`
- Verify all AC 1-5 requirements addressed
- Check approval process is clear and actionable
- Verify breaking/non-breaking definitions include examples

**Test 2: Enum Runbook Walkthrough**
- Follow enum addition procedure step-by-step
- Attempt to add new enum value to local database
- Verify steps are correct and complete
- Check rollback procedure is actionable

**Test 3: Versioning Strategy Coherence**
- Read `SCHEMA-VERSIONING.md`
- Verify version numbering scheme is consistent
- Check metadata table design is implementable
- Confirm rollback compatibility matrix is clear

**Test 4: Scenarios Coverage**
- Read `SCHEMA-CHANGE-SCENARIOS.md`
- Verify all common scenarios covered (AC 14-18)
- Check code examples are correct PostgreSQL syntax
- Confirm production considerations documented

### Governance Tests

**Test 5: Approval Process**
- Verify approval process identifies required reviewers
- Check risk assessment template is complete
- Confirm testing requirements are testable

**Test 6: Backward Compatibility Policy**
- Verify policy specifies backward compatibility window
- Check deployment order documented (DB first vs code first)
- Confirm code compatibility testing approach

### Edge Cases

**Edge 1: Enum with Existing Data**
- Document procedure when enum has existing rows
- Verify safe vs unsafe operations clearly distinguished

**Edge 2: High-Traffic Production Tables**
- Document index creation with CONCURRENTLY
- Verify lock considerations documented

**Edge 3: Multi-Developer Coordination**
- Document merge conflict resolution for schema changes
- Verify migration numbering collision handling

## Risk Notes

### MVP-Critical Risks

**Risk 1: Incomplete Policy Leads to Breaking Changes**
- Without clear policy, developers may introduce breaking schema changes
- **Mitigation**: Code review gate requiring policy reference for schema PRs

**Risk 2: Enum Immutability Not Understood**
- Developers may attempt direct enum modifications, causing errors
- **Mitigation**: Runbook must include warnings and examples of incorrect approaches

**Risk 3: Production Downtime from Schema Locks**
- Large table modifications can lock tables and cause downtime
- **Mitigation**: Scenarios doc must document CONCURRENTLY options and lock behavior

### Non-MVP Risks

**Risk 4: Schema Versioning Overhead**
- Maintaining version metadata adds operational complexity
- **Mitigation**: Start simple, document benefits, iterate based on pain points

**Risk 5: Multi-Environment State Drift**
- Staging and production schemas may drift over time
- **Mitigation**: Regular schema drift detection (future tool, document manual checks)

## Definition of Done

- [ ] All 20 Acceptance Criteria verified
- [ ] 4 documentation files created in `packages/backend/database-schema/docs/`
- [ ] Documentation peer-reviewed by Tech Lead
- [ ] Enum modification runbook tested with local database
- [ ] Sample risk assessment template completed for hypothetical change
- [ ] Documentation linked from main README in `packages/backend/database-schema/`
- [ ] Code review completed (documentation review)
- [ ] Story marked complete

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Story Gen | ~3k | — | — | Follow-up generation |
| Implementation | ~5k | — | — | Documentation writing |
| Review | ~2k | — | — | Documentation review |
| **Total** | ~10k | — | — | — |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## Agent Log

Append-only.

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-28 15:00 | pm-story-followup-leader | Created follow-up story from WISH-2007 finding #1 (Enhancement Opportunity #6) | WISH-2057.md |

---

## Future Enhancement Notes

Once this policy documentation exists, consider:
- CI job to validate schema changes against policy (automated governance)
- Schema drift detection tool (`db:check` command from WISH-2007 Enhancement #3)
- Automated rollback script generation based on migration metadata
- Schema change impact analysis tool (which services/endpoints affected?)

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-29_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| — | None identified | Not Reviewed | Core journey for documentation story is complete. No MVP-critical gaps that block implementation. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| — | None identified | Not Reviewed | Story scope is focused on establishing foundational policies before implementation. |

### Follow-up Stories Suggested

- [x] CI job to validate schema changes against policy (automated governance) → WISH-20180
- [x] Schema drift detection tool (`db:check` command from WISH-2007 Enhancement #3) → WISH-20190
- [x] Automated rollback script generation based on migration metadata → WISH-20200
- [x] Schema change impact analysis tool (which services/endpoints affected?) → WISH-20210

### Items Marked Out-of-Scope

- Implementing automated schema versioning tools: Future enhancement to automate policy enforcement
- Migrating existing tables: No tables exist yet; applies when tables are created
- Setting up CI/CD approval workflows: Future enhancement for governance automation
- Database backup/restore automation: Separate infrastructure concern

### Implementation Condition

During implementation, clarify relationship between new 4 documentation files (`SCHEMA-EVOLUTION-POLICY.md`, `ENUM-MODIFICATION-RUNBOOK.md`, `SCHEMA-VERSIONING.md`, `SCHEMA-CHANGE-SCENARIOS.md`) and existing `docs/WISHLIST-SCHEMA-EVOLUTION.md`. Determine whether to replace, extend, or consolidate documentation.
