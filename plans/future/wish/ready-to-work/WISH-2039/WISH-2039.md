---
doc_type: story
title: "WISH-2039: User-level targeting for feature flags"
story_id: WISH-2039
story_prefix: WISH
status: ready-to-work
follow_up_from: WISH-2009
phase: 3
created_at: "2026-01-29T00:00:00-07:00"
updated_at: "2026-01-30T00:00:00-07:00"
depends_on: [WISH-2009]
estimated_points: 3
sizing_warning: false
---

# WISH-2039: User-level targeting for feature flags

## Follow-up Context

**Parent Story**: WISH-2009  
**Source**: QA Discovery Notes - Enhancement Opportunity (Non-goals deferred item)  
**Original Finding**: User-level targeting (beyond percentage-based rollout) - WISH-2009 Non-goals explicitly defer user-level targeting. MVP is percentage-based only. User-level targeting would allow specific users to be included/excluded from flags.  
**Category**: Feature Enhancement  
**Impact**: Medium (enables targeted rollout)  
**Effort**: Medium (user overrides table)

## Context

The MVP feature flag infrastructure (WISH-2009) uses percentage-based rollout for gradual feature deployment. This approach works well for broad rollouts but lacks precision for:

- **Beta Tester Programs**: Inviting specific users to test features before wider rollout
- **VIP/Power User Access**: Granting early access to trusted users regardless of percentage
- **Support/Debug Cases**: Enabling features for specific users to troubleshoot issues
- **Team Member Testing**: Testing features on production with specific internal accounts
- **Exclusion Lists**: Preventing problematic users from accessing unstable features

User-level targeting adds a layer of precision to the existing percentage-based system, allowing explicit inclusion or exclusion overrides.

## Goal

Enable targeted feature flag rollout to specific users through explicit inclusion/exclusion lists, complementing the existing percentage-based rollout system.

## Non-goals

- **Complex targeting rules** (e.g., user attributes, segments, conditions) - simple include/exclude lists only
- **Real-time targeting updates** - rely on existing 5-minute cache TTL
- **Targeting UI** - admin API only (defer UI to future story)
- **Targeting analytics** - defer metrics to future story
- **Third-party targeting services** - in-house implementation only
- **Organization/team-level targeting** - user-level only for MVP
- **Geo-targeting or device-targeting** - user-level only

## Scope

### Endpoints Affected

**New Endpoints**:
- `POST /api/admin/flags/:flagKey/users` - Add users to include/exclude list
- `DELETE /api/admin/flags/:flagKey/users/:userId` - Remove user from targeting
- `GET /api/admin/flags/:flagKey/users` - List all user overrides for flag

**Modified Endpoints**:
- `GET /api/config/flags` - No changes (client-side, server evaluates targeting)

### Packages Affected

1. **Backend - Feature Flag Service**: `apps/api/lego-api/domains/config/`
   - `application/feature-flag-service.ts` - Update `evaluateFlag` to check user overrides
   - `adapters/feature-flag-repository.ts` - Add user override queries
   - `routes.ts` - Add user targeting endpoints

2. **Database**: `packages/backend/database-schema/`
   - `src/schema/feature-flags.ts` - Add `feature_flag_user_overrides` table

3. **Shared Schemas**: `packages/core/api-client/src/schemas/`
   - `feature-flags.ts` - Add user override schemas

### Database Schema Changes

**New Table: `feature_flag_user_overrides`**
```sql
CREATE TABLE feature_flag_user_overrides (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  flag_id UUID NOT NULL REFERENCES feature_flags(id) ON DELETE CASCADE,
  user_id VARCHAR(255) NOT NULL,
  override_type VARCHAR(20) NOT NULL CHECK (override_type IN ('include', 'exclude')),
  reason TEXT,
  created_by VARCHAR(255),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(flag_id, user_id)
);

CREATE INDEX idx_feature_flag_user_overrides_flag_id ON feature_flag_user_overrides(flag_id);
CREATE INDEX idx_feature_flag_user_overrides_user_id ON feature_flag_user_overrides(user_id);
```

### Evaluation Logic Update

**Flag Evaluation Priority** (highest to lowest):
1. **Explicit Exclusion**: User in exclude list → return `false`
2. **Explicit Inclusion**: User in include list → return `true`
3. **Percentage-based**: Fall back to existing percentage rollout logic

This ensures exclusions override everything (useful for blocking problematic users), inclusions override percentages (useful for beta testers), and percentages remain the default behavior.

## Acceptance Criteria

### Database Schema

**AC1**: Create `feature_flag_user_overrides` table
- Columns: id, flag_id, user_id, override_type ('include' | 'exclude'), reason, created_by, created_at
- Foreign key: flag_id references feature_flags(id) with CASCADE delete
- Unique constraint on (flag_id, user_id) to prevent duplicates
- Indexes on flag_id and user_id for fast lookups
- CHECK constraint on override_type ('include' or 'exclude')
- Drizzle migration created and applied

### Backend - User Override Management

**AC2**: Update `evaluateFlag` method to check user overrides
- Query user_overrides table for (flagKey, userId) before percentage check
- If user in exclude list: return `false` (highest priority)
- If user in include list: return `true` (second priority)
- Otherwise: fall back to percentage-based evaluation
- Maintain backward compatibility with existing flag evaluation

**AC3**: Add `POST /api/admin/flags/:flagKey/users` endpoint
- Request body: `{ userId: string, overrideType: 'include' | 'exclude', reason?: string }`
- Requires admin role (reuse existing auth middleware)
- Validates userId is valid Cognito sub
- Upserts user override (updates if exists)
- Invalidates cache for affected flag
- Returns created/updated override
- Zod schema: `AddUserOverrideRequestSchema`, `UserOverrideResponseSchema`

**AC4**: Add `DELETE /api/admin/flags/:flagKey/users/:userId` endpoint
- Removes user from include/exclude list
- Requires admin role
- Invalidates cache for affected flag
- Returns 204 No Content on success
- Returns 404 if override not found

**AC5**: Add `GET /api/admin/flags/:flagKey/users` endpoint
- Returns all user overrides for flag
- Response: `{ includes: [{ userId, reason, createdBy, createdAt }], excludes: [...] }`
- Requires admin role
- Supports pagination (default 50, max 500 per page)
- Zod schema: `UserOverridesListResponseSchema`

**AC6**: Cache user overrides in flag cache
- Include user overrides in flag cache entry
- Cache key: `feature_flags:{environment}:{flagKey}:users` (separate from main flag cache)
- Same 5-minute TTL as main flag cache
- Invalidate on user override add/remove
- Fallback to database if cache unavailable

**AC7**: Add rate limiting for user override modifications
- Max 100 user override changes per flag per hour (prevents abuse)
- Return 429 Too Many Requests if exceeded
- Use in-memory rate limiter (same as WISH-2009 cache approach)

### Testing

**AC8**: Backend unit tests for user override logic
- Test exclusion overrides percentage (user excluded, flag enabled 100%)
- Test inclusion overrides percentage (user included, flag disabled 0%)
- Test exclusion priority over inclusion (if both exist, exclusion wins)
- Test fallback to percentage when no override exists
- Test cache invalidation on override add/remove
- Test pagination for user list endpoint
- Minimum: 12 unit tests

**AC9**: Backend integration tests for user override endpoints
- `.http` file: `__http__/feature-flags-user-targeting.http`
- Test: POST /api/admin/flags/wishlist-gallery/users (add include override)
- Test: POST /api/admin/flags/wishlist-gallery/users (add exclude override)
- Test: GET /api/admin/flags/wishlist-gallery/users (list overrides)
- Test: DELETE /api/admin/flags/wishlist-gallery/users/:userId (remove override)
- Test: GET /api/config/flags with user override (verify evaluation)
- Minimum: 6 HTTP requests

**AC10**: Verify user targeting works end-to-end
- Add user to include list for disabled flag
- Verify flag evaluates to `true` for that user
- Add same user to exclude list
- Verify flag now evaluates to `false` (exclusion priority)
- Remove exclusion, verify flag returns to `true`

### Schema Synchronization

**AC11**: Frontend and backend Zod schemas aligned
- Define `UserOverrideSchema`, `AddUserOverrideRequestSchema`, `UserOverridesListResponseSchema`
- Alignment test verifies schemas match
- TypeScript compilation passes

### Documentation

**AC12**: Update WISH-2009 documentation with user targeting capabilities
- Update "Non-goals" section in WISH-2009.md to reflect user targeting now available
- Add reference to WISH-2039 in "Follow-up Stories" section
- Document evaluation priority order in architecture notes

## Reuse Plan

### Existing Components (Extended)
- In-memory cache (or Redis when available) from WISH-2009 for user overrides
- Auth middleware from `apps/api/lego-api/middleware/auth.ts` for admin role
- Feature flag service from WISH-2009 (`feature-flag-service.ts`)
- Zod schema patterns from WISH-2009

### New Components
- `feature_flag_user_overrides` table and schema
- User override repository methods in `feature-flag-repository.ts`
- Three new admin endpoints for user override management

### Builds On
- WISH-2009 feature flag infrastructure (database, cache, evaluation logic)
- WISH-2009 admin endpoints pattern (POST /api/admin/flags/:flagKey)

## Architecture Notes

### Hexagonal Architecture Compliance

**Domain Layer** (Business Logic):
- Update `feature-flag-service.ts` with user override evaluation logic
- Override priority: exclusion > inclusion > percentage
- No HTTP/database coupling in evaluation logic

**Adapter Layer** (Infrastructure):
- Extend `feature-flag-repository.ts` with user override queries
- Cache adapter includes user override caching
- Database adapter for user override CRUD

**Port Layer** (Contracts):
- Extend `types.ts` with `UserOverride`, `AddUserOverrideRequest`, `UserOverridesListResponse` types
- Define Zod schemas for new endpoints

**No Architecture Violations**: Story extends existing config domain without introducing new patterns

## Test Plan

### Backend Unit Tests

**User Override Evaluation Tests**:
1. Exclusion override returns false (even if flag 100% enabled)
2. Inclusion override returns true (even if flag 0% enabled)
3. Exclusion priority: user in both lists → false
4. No override: falls back to percentage-based evaluation
5. Invalid userId: returns false (safe default)
6. Cache hit: reads overrides from cache
7. Cache miss: reads overrides from database
8. Cache invalidation on add override
9. Cache invalidation on remove override
10. Pagination works correctly (50 per page)
11. Rate limiting blocks excessive updates
12. CASCADE delete: removing flag removes overrides

**Minimum**: 12 unit tests

### Backend Integration Tests

**HTTP Tests** (`__http__/feature-flags-user-targeting.http`):
- POST /api/admin/flags/wishlist-gallery/users (include user "user-123")
- POST /api/admin/flags/wishlist-gallery/users (exclude user "user-456")
- GET /api/admin/flags/wishlist-gallery/users (list all overrides)
- GET /api/config/flags (verify evaluation for user-123 and user-456)
- DELETE /api/admin/flags/wishlist-gallery/users/user-123 (remove override)
- GET /api/admin/flags/wishlist-gallery/users (verify user-123 removed)

**Minimum**: 6 HTTP requests

### End-to-End Scenario Test

**Scenario: Beta Tester Rollout**
1. Create flag `wishlist-gallery` with `enabled=false`, `rolloutPercentage=0`
2. Add user "beta-tester-1" to include list
3. Verify `evaluateFlag('wishlist-gallery', 'beta-tester-1')` returns `true`
4. Verify `evaluateFlag('wishlist-gallery', 'regular-user')` returns `false`
5. Update flag to `rolloutPercentage=50`
6. Verify beta-tester-1 still returns `true` (explicit inclusion)
7. Add beta-tester-1 to exclude list
8. Verify `evaluateFlag('wishlist-gallery', 'beta-tester-1')` returns `false` (exclusion priority)

## UI/UX Notes

### MVP-Critical Requirements

**No User-Facing UI**: This is infrastructure-only story. User targeting is configured via admin API endpoints.

**Admin UI (Future)**: Admin dashboard for user targeting management is out of scope for MVP. Use API endpoints directly.

**Example API Usage**:
```bash
# Add user to beta testers (include list)
curl -X POST https://api.example.com/api/admin/flags/wishlist-gallery/users \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"userId": "user-123", "overrideType": "include", "reason": "Beta tester"}'

# List all user overrides for flag
curl https://api.example.com/api/admin/flags/wishlist-gallery/users \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# Remove user from targeting
curl -X DELETE https://api.example.com/api/admin/flags/wishlist-gallery/users/user-123 \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

## Risks & Mitigations

### MVP-Critical Risks

1. **User Override Scale**
   - Risk: Large include/exclude lists slow down flag evaluation
   - Mitigation: Cache user overrides with flag data, index on user_id for fast lookups
   - Severity: Low

2. **Cache Invalidation Lag**
   - Risk: User override changes take up to 5 minutes to propagate (existing TTL)
   - Mitigation: Acceptable for MVP; user overrides are admin operations, not real-time
   - Severity: Low

3. **Duplicate Override Handling**
   - Risk: User added to both include and exclude lists
   - Mitigation: Exclusion takes priority (documented in evaluation logic); upsert logic updates override_type on conflict
   - Severity: Low

4. **Missing Authorization Checks**
   - Risk: Non-admin users could manipulate user overrides
   - Mitigation: Reuse existing admin auth middleware from WISH-2009 POST endpoint
   - Severity: Medium (security concern, mitigated by auth)

## Open Questions

None - all decisions finalized for implementation.

## Definition of Done

- [ ] All 12 Acceptance Criteria pass
- [ ] Backend: 12 unit tests pass (user override logic)
- [ ] Backend: 6 HTTP integration tests pass
- [ ] Database migration created and applied
- [ ] Schema alignment test passes (frontend ↔ backend)
- [ ] End-to-end scenario test passes (beta tester rollout)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved
- [ ] WISH-2009 documentation updated with reference to WISH-2039

## Follow-up Stories (Future)

### Phase 4+
- Admin UI for user override management (table view, search, bulk operations)
- User override audit logging (track who added/removed users, when)
- User override analytics (most targeted users, most overridden flags)
- Bulk user operations (CSV upload, copy overrides between flags)

### Advanced Targeting
- User attribute targeting (role, subscription tier, account age)
- User segment targeting (groups of users defined by attributes)
- Conditional targeting (multiple AND/OR conditions)
- Geo-targeting (by country, region, timezone)
- Device-targeting (by platform, browser, app version)

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Elaboration | ~10k | — | — | Extension of WISH-2009 |
| Implementation | ~15k | — | — | Backend + Migration + Tests |
| Code Review | ~5k | — | — | Standard review |
| **Total** | ~30k | — | — | Medium-sized story |

## QA Discovery Notes (for PM Review)

_Updated by QA Re-Elaboration on 2026-01-30_

**Status**: CONDITIONAL PASS ✅
- WISH-2009 blocker is now resolved (feature flag infrastructure fully implemented)
- All 8 audit checks pass
- 4 minor implementation-time clarifications (file naming, schema additions)
- No story content changes needed

### Gaps Identified

| # | Finding | Status | Notes |
|---|---------|--------|-------|
| None | — | RESOLVED | Previous blocker (WISH-2009 not implemented) is now resolved. ✅ WISH-2009 fully implemented at `apps/api/lego-api/domains/config/` |

### Implementation Clarifications

| # | Clarification | Required Action | Notes |
|---|----------------|-----------------|-------|
| 1 | File naming conventions | Use `services.ts` (not `feature-flag-service.ts`), `repositories.ts` (not `feature-flag-repository.ts`) | Implementation-time guidance. Follows existing WISH-2009 patterns. |
| 2 | Zod schema additions | Add `UserOverrideSchema`, `AddUserOverrideRequestSchema`, `UserOverrideResponseSchema`, `UserOverridesListResponseSchema` | Expected implementation work. Schemas referenced in ACs must be created. |
| 3 | Schema location | Use `packages/backend/database-schema/src/schema/feature-flags.ts` (verified ✅) | Story assumption is correct. File exists and verified. |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| None | — | N/A | Story comprehensively covers user targeting feature. No enhancements needed. |

### Follow-up Stories Suggested

- [ ] WISH-2029: Update architecture documentation to reflect `lego-api/domains/` pattern (independent effort)
- [ ] Future: Admin UI for user override management (Phase 4+, already documented in Follow-up Stories section)

### Items Marked Out-of-Scope

- Interactive phase skipped: "All findings are minor implementation clarifications"

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-29 00:00 | pm-story-followup-leader | Created follow-up story from WISH-2009 finding #5 | WISH-2039.md |
| 2026-01-29 18:10 | elab-completion-leader | Generated ELAB-WISH-2039.md, marked FAIL due to WISH-2009 blocker | ELAB-WISH-2039.md, QA Discovery Notes appended |
| 2026-01-30 00:00 | elab-completion-leader | Re-elaboration: WISH-2009 now implemented, verified all paths, updated verdict to CONDITIONAL PASS | ELAB-WISH-2039.md updated, story status updated to ready-to-work, QA Discovery Notes refreshed |
