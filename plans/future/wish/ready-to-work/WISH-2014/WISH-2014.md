---
doc_type: story
title: "WISH-2014: Smart Sorting Algorithms"
story_id: WISH-2014
story_prefix: WISH
status: ready-to-work
phase: 4
created_at: "2026-01-27T12:30:00-07:00"
updated_at: "2026-01-29T02:08:42-07:00"
depends_on: [WISH-2001]
follow_up_from: WISH-2001
estimated_points: 3
sizing_warning: false
---

# WISH-2014: Smart Sorting Algorithms

## Context

Follow-up story from WISH-2001 (Gallery MVP) QA Elaboration - Enhancement Opportunity #12. Adds three smart sorting modes to help users discover wishlist items in meaningful ways beyond basic date/price sorting. These sorting modes leverage existing database fields (price, pieceCount, releaseDate, priority) to provide value-based, time-based, and discovery-based sorting.

**Original Finding**: Smart sorting algorithms for better item discovery - fun features that encourage engagement with wishlist

**Impact**: Medium - Improves item discoverability and user engagement
**Effort**: Medium - Multi-field calculations, frontend + backend implementation

## Goal

Enable users to discover wishlist items using three smart sorting modes:
1. **Best Value**: Find budget-friendly items by sorting by price-per-piece ratio (lowest first)
2. **Expiring Soon**: Identify potentially retiring sets by sorting by oldest release dates
3. **Hidden Gems**: Surface overlooked valuable items by sorting low priority + high piece count

## Non-goals

- Algorithm customization (user-defined weights or formulas) - deferred to future story
- Multi-currency exchange rate handling for Best Value - deferred to Phase 6 (Internationalization)
- Secondary/combined sort modes (e.g., "Best Value among High Priority") - deferred to future story
- Sort mode persistence in localStorage - deferred to Phase 5 (UX Polish)
- Advanced filtering combined with smart sorting - deferred to future story
- Real-time sort updates via WebSocket - deferred to Phase 5

## Scope

### Endpoints Affected
- **Extended**: `GET /api/wishlist` with new `sort` parameter values: `bestValue`, `expiringSoon`, `hiddenGems`
- **No New Endpoints Required**

### Packages Affected
1. **Backend**: `apps/api/lego-api/domains/wishlist/`
   - `types.ts` - Extend `ListWishlistQuerySchema` sort enum
   - `application/wishlist-service.ts` - Add sorting algorithms
   - `adapters/wishlist-repository.ts` - Extend repository with Drizzle queries

2. **Shared Schemas**: `packages/core/api-client/src/schemas/wishlist.ts`
   - Extend `WishlistQueryParamsSchema` sort enum

3. **Frontend**: `apps/web/app-wishlist-gallery/`
   - `src/pages/main-page.tsx` - Update sort dropdown with new options
   - `src/components/WishlistCard/index.tsx` - No changes for MVP (visual indicators deferred)

### Database Impact
- **No Schema Changes**: Uses existing fields (price, pieceCount, releaseDate, priority)
- **Recommended**: Add composite index on (userId, price, pieceCount) for Best Value performance

## Acceptance Criteria

### Backend Implementation

**AC1**: Extend `ListWishlistQuerySchema` to accept new sort values
- Schema includes: `'bestValue' | 'expiringSoon' | 'hiddenGems'` in sort enum
- Backward compatible with existing sort values
- Zod validation rejects invalid sort parameters with 400 status

**AC2**: Implement Best Value sorting algorithm
- Formula: `price / pieceCount` (lowest ratio first)
- Null handling: Items with null price or pieceCount placed at end
- Zero handling: Items with pieceCount = 0 treated as null (no division by zero)
- Order: Ascending (best value first)

**AC3**: Implement Expiring Soon sorting algorithm
- Sort by `releaseDate` ascending (oldest first)
- Null handling: Items with null releaseDate placed at end
- Order: Ascending (oldest release dates first)

**AC4**: Implement Hidden Gems sorting algorithm
- Formula: `score = (5 - priority) * pieceCount`
- Logic: Lower priority (0-2) + higher piece count = higher score
- Null handling: Items with null pieceCount excluded or placed at end
- Order: Descending (highest score first)

**AC5**: Backend unit tests cover all three algorithms
- Test correct ordering with varying inputs
- Test null value handling
- Test division by zero (pieceCount = 0)
- Test edge cases (all items equal, extreme values)
- Minimum: 15 unit tests (5 per algorithm)

**AC6**: Integration tests verify endpoint behavior
- `.http` file includes requests for all 3 sort modes
- Response structure matches `WishlistListResponseSchema`
- Items array ordering verified against algorithm
- Pagination works correctly with smart sorting

### Frontend Implementation

**AC7**: Sort dropdown includes three new options
- "Best Value" (value: bestValue)
- "Expiring Soon" (value: expiringSoon)
- "Hidden Gems" (value: hiddenGems)
- Options use icons from lucide-react: TrendingDown, Clock, Gem

**AC8**: Sort dropdown uses `_primitives` Select component
- Import from `@repo/app-component-library/_primitives/Select`
- Token-only colors (neutral-100, neutral-700, etc.)
- No custom styling beyond design system

**AC9**: Sort options include tooltips explaining each mode
- "Best Value": "Sort by lowest price per piece"
- "Expiring Soon": "Sort by oldest release dates"
- "Hidden Gems": "Discover overlooked valuable sets"

**AC10**: RTK Query triggers API call with correct sort parameter
- `useGetWishlistQuery({ sort: 'bestValue' })` calls API correctly
- Loading state shown during fetch
- Items re-render after fetch completes

**AC11**: Frontend component tests verify dropdown rendering
- Test dropdown renders new options
- Test icon rendering for each option
- Test tooltip content for each option
- Minimum: 5 component tests

**AC12**: Playwright E2E test covers full sort flow
- Test: Select each smart sort option
- Verify: Items re-order in gallery
- Verify: Network request includes correct sort parameter
- Verify: No console errors
- Evidence: Screenshots + network HAR

### Schema Synchronization

**AC13**: Frontend and backend Zod schemas define identical sort enums
- Both define: `'bestValue' | 'expiringSoon' | 'hiddenGems'`
- Alignment test verifies schemas match (similar to WISH-2000 pattern)
- TypeScript compilation passes across all packages

### Error Handling

**AC14**: Invalid sort parameter returns 400 error
- Request: `GET /api/wishlist?sort=invalidSort`
- Response: 400 with validation error message
- Error message lists allowed sort values

**AC15**: Items with incomplete data handled gracefully
- Best Value with null price/pieceCount: Items placed at end, no 500 error
- Expiring Soon with null releaseDate: Items placed at end, no 500 error
- Hidden Gems with null pieceCount: Items excluded or placed at end, no 500 error

### Performance

**AC16**: Query performance meets requirements
- All sort modes complete < 2s with 1000+ items
- Database indexes added if needed for performance
- `EXPLAIN ANALYZE` output documented for query plan review

### Accessibility

**AC17**: Sort dropdown is keyboard navigable
- Tab focuses dropdown
- Arrow keys navigate options
- Enter selects option
- Focus returns to trigger after selection

**AC18**: Screen reader announces sort options correctly
- Each option announced as "Sort by [mode name]"
- Tooltip content accessible to screen readers

## Reuse Plan

### Existing Components (No Changes)
- ✅ `GET /api/wishlist` endpoint (extend with new sort values)
- ✅ `useGetWishlistQuery` RTK Query hook (no code changes - schema extension only)
- ✅ Select primitive from `@repo/app-component-library/_primitives/Select`
- ✅ Database schema fields: price, pieceCount, releaseDate, priority

### Existing Patterns
- ✅ Zod schema validation (extend existing sort enum)
- ✅ Drizzle query builder for database sorting
- ✅ RTK Query cache management (existing tags: Wishlist, WishlistItem)
- ✅ Error handling patterns from WISH-2001

## Architecture Notes (Ports & Adapters)

### Hexagonal Architecture Compliance

**Domain Layer** (Business Logic):
- `apps/api/lego-api/domains/wishlist/application/wishlist-service.ts`
- Add sort algorithm logic in `listItems()` method
- Pure business logic - no database coupling

**Adapter Layer** (Infrastructure):
- `apps/api/lego-api/domains/wishlist/adapters/wishlist-repository.ts`
- Implement Drizzle queries for each sort mode
- Handle null values using SQL CASE statements
- Use `sql` template for calculated fields (price/pieceCount ratio)

**Port Layer** (Contracts):
- `apps/api/lego-api/domains/wishlist/types.ts`
- Extend `ListWishlistQuerySchema` sort enum
- Define input/output contracts

**No Architecture Violations**: Story extends existing layers without coupling

### Sorting Algorithm Placement

**Repository Layer** (Recommended for MVP - Database-side):
```typescript
// apps/api/lego-api/domains/wishlist/adapters/wishlist-repository.ts
async findByUser(userId: string, pagination, filters) {
  return await db
    .select()
    .from(wishlistItems)
    .where(eq(wishlistItems.userId, userId))
    .orderBy(
      sql`CASE
        WHEN ${filters.sort} = 'bestValue'
        THEN ${wishlistItems.price}::numeric / NULLIF(${wishlistItems.pieceCount}, 0)
        ELSE ${wishlistItems.createdAt}
      END`
    )
}
```

**Recommendation**: Start with repository layer (database-side) for performance. Move to service layer if business logic complexity increases.

## Infrastructure Notes

### Database Indexes (Recommended)

**Current Indexes** (from WISH-2000):
- `idx_wishlist_user_id` on userId
- `idx_wishlist_user_sort` on (userId, sortOrder)
- `idx_wishlist_user_store` on (userId, store)

**Recommended New Index**:
```sql
CREATE INDEX idx_wishlist_best_value
ON wishlist_items (user_id, price, piece_count)
WHERE price IS NOT NULL AND piece_count IS NOT NULL;
```

**Rationale**: Composite index on (userId, price, pieceCount) improves Best Value query performance. Partial index (WHERE clause) excludes null values to reduce index size.

**Timeline**: Add index if performance tests show queries > 2s

### Query Performance Strategy

**Phase 1 (MVP)**: Calculate fields at query time using SQL
- Pros: No schema changes, simple implementation
- Cons: Slight performance overhead for calculated fields

**Phase 2 (If Needed)**: Add materialized columns
- Add `price_per_piece DECIMAL` column (updated on insert/update)
- Pros: Faster queries, standard indexing
- Cons: Requires schema migration, update triggers

**Decision Point**: Monitor P95 query latency post-launch. If > 2s, implement Phase 2.

## HTTP Contract Plan

### Extended Endpoint: GET /api/wishlist

**New Query Parameters**:
```typescript
{
  sort?: 'createdAt' | 'title' | 'price' | 'pieceCount' | 'sortOrder' | 'priority'
        | 'bestValue' | 'expiringSoon' | 'hiddenGems'
  order?: 'asc' | 'desc'  // Existing parameter
}
```

**Example Requests**:
```http
# Best Value Sort
GET /api/wishlist?sort=bestValue&order=asc
Authorization: Bearer <token>

# Expiring Soon Sort
GET /api/wishlist?sort=expiringSoon&order=asc
Authorization: Bearer <token>

# Hidden Gems Sort
GET /api/wishlist?sort=hiddenGems&order=desc
Authorization: Bearer <token>
```

**Response Format** (unchanged):
```json
{
  "items": [
    {
      "id": "uuid",
      "title": "Millennium Falcon",
      "price": "849.99",
      "pieceCount": 7541,
      "releaseDate": "2017-09-01T00:00:00Z",
      "priority": 0
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 42,
    "totalPages": 3
  }
}
```

**Error Responses**:
```json
// 400 - Invalid sort parameter
{
  "error": "Validation failed",
  "details": {
    "fieldErrors": {
      "sort": ["Invalid enum value. Expected 'createdAt' | ... | 'hiddenGems'"]
    }
  }
}

// 401 - Unauthorized
{
  "error": "Unauthorized"
}
```

### Null Value Handling Contract

**Documented Behavior** (must be in API docs):

| Sort Mode | Null Handling |
|-----------|---------------|
| bestValue | Items with null price OR pieceCount placed at end of list |
| expiringSoon | Items with null releaseDate placed at end of list |
| hiddenGems | Items with null pieceCount placed at end of list |

**Edge Case: pieceCount = 0**
- Treated as null for bestValue (no division by zero)
- Item placed at end of list

## Seed Requirements

### Test Data Requirements

**For Backend Integration Tests** (`__http__/wishlist-smart-sorting.http`):

Create 15 wishlist items with varying attributes:

**Best Value Test Data**:
1. Item: price=100, pieceCount=1000 (ratio: 0.10)
2. Item: price=50, pieceCount=250 (ratio: 0.20)
3. Item: price=200, pieceCount=2000 (ratio: 0.10)
4. Item: price=30, pieceCount=100 (ratio: 0.30)
5. Item: price=null, pieceCount=500 (null handling)
6. Item: price=100, pieceCount=0 (division by zero)

**Expiring Soon Test Data**:
1. Item: releaseDate=2020-01-01 (old)
2. Item: releaseDate=2023-06-15 (recent)
3. Item: releaseDate=2019-05-10 (oldest)
4. Item: releaseDate=2024-12-20 (newest)
5. Item: releaseDate=null (null handling)

**Hidden Gems Test Data**:
1. Item: priority=0, pieceCount=2000 (score: 10000)
2. Item: priority=5, pieceCount=1500 (score: 0)
3. Item: priority=1, pieceCount=3000 (score: 12000)
4. Item: priority=0, pieceCount=500 (score: 2500)
5. Item: priority=2, pieceCount=1000 (score: 3000)

**Seed Script Location**:
- `packages/backend/database-schema/src/seeds/wishlist-smart-sorting.ts`
- Function: `seedWishlistForSmartSorting(userId: string)`

## Test Plan

(See `_pm/TEST-PLAN.md` for comprehensive test plan including happy path, error cases, edge cases, and evidence requirements)

### Backend Unit Tests

**Service Layer Tests**:
1. Best Value algorithm - 5 tests (ordering, nulls, zeros, ties)
2. Expiring Soon algorithm - 5 tests (date ordering, nulls, extremes)
3. Hidden Gems algorithm - 5 tests (score calculation, nulls, ties)

**Minimum**: 15 unit tests total

### Backend Integration Tests

**HTTP Tests** (`__http__/wishlist-smart-sorting.http`):
- Happy path: All 3 sort modes
- Error cases: Invalid sort, unauthenticated
- Edge cases: Nulls, pagination

### Frontend Tests

**Component Tests**:
- Dropdown rendering (5 tests)
- Icon rendering
- Tooltip content

**E2E Tests (Playwright)**:
- Full sort flow for all 3 modes
- Accessibility (keyboard navigation)
- Performance (< 2s queries)

## UI/UX Notes

(See `_pm/UIUX-NOTES.md` for MVP-critical requirements and `_pm/FUTURE-UIUX.md` for future enhancements)

### MVP-Critical Requirements

**Sort Dropdown Enhancement**:
- Add 3 new options with icons (TrendingDown, Clock, Gem)
- Token-only colors (green-600, orange-600, purple-600)
- Tooltips explaining each mode

**Sort Option Labels**:
- "Best Value" - "Sort by lowest price per piece"
- "Expiring Soon" - "Sort by oldest release dates"
- "Hidden Gems" - "Discover overlooked valuable sets"

**Design System Compliance**:
- Import from `_primitives/Select/index.tsx`
- Token-only colors
- Icons from lucide-react

**Accessibility**:
- Keyboard navigation
- Screen reader announcements
- Focus management

## Implementation Notes

### Recommended Implementation Sequence

**Phase 1: Backend Foundation** (Day 1)
1. Extend Zod schemas with new sort values
2. Implement sort algorithms in service layer
3. Add unit tests (15 tests)

**Phase 2: Backend Integration** (Day 2)
1. Extend repository with Drizzle queries
2. Create `.http` test file
3. Verify query performance (< 2s)

**Phase 3: Frontend UI** (Day 3)
1. Update sort dropdown with new options
2. Add icons and tooltips
3. Add component tests (5 tests)

**Phase 4: E2E Verification** (Day 4)
1. Add Playwright test
2. Verify full flow
3. Run accessibility audit

**Phase 5: Code Review & Refinement** (Day 5)
1. Address review feedback
2. Fix edge cases
3. Update documentation

**Estimated Total Effort**: 3-5 days (1 developer)

### Hidden Gems Algorithm Formula

**Final Formula**:
```typescript
score = (5 - priority) * pieceCount
```

**Weight Breakdown**:
- Priority 0 → weight 5 (highest)
- Priority 1 → weight 4
- Priority 2 → weight 3
- Priority 3 → weight 2
- Priority 4 → weight 1
- Priority 5 → weight 0

**Sort Direction**: Descending (highest score first)

### Null Handling Strategy

**Best Value Sort**:
- Items with null `price` → placed at end
- Items with null `pieceCount` → placed at end
- Items with `pieceCount = 0` → treated as null, placed at end

**Expiring Soon Sort**:
- Items with null `releaseDate` → placed at end

**Hidden Gems Sort**:
- Items with null `pieceCount` → placed at end
- Items with `priority > 3` → included but with low score (weights: 2, 1, 0)

## Risks & Mitigations

(See `_pm/DEV-FEASIBILITY.md` for MVP-critical risks and `_pm/FUTURE-RISKS.md` for non-MVP risks)

### MVP-Critical Risks

1. **Null Value Handling Strategy** - Mitigation: Document in AC15, place nulls at end
2. **Division by Zero** - Mitigation: Use `NULLIF(pieceCount, 0)`, AC2 covers this
3. **Schema Synchronization** - Mitigation: AC13 requires alignment test
4. **Query Performance** - Mitigation: Add index if needed, AC16 requires < 2s
5. **Hidden Gems Algorithm Ambiguity** - Mitigation: Formula documented in AC4

### Non-MVP Risks

- Sort performance degradation at scale (future monitoring)
- Sort mode feature discoverability (onboarding in Phase 5)
- Algorithm accuracy perception (user feedback iteration)
- Currency exchange rate handling (Phase 6)
- Mobile dropdown UX (drawer in Phase 4)

## Definition of Done

- [ ] All 18 Acceptance Criteria pass
- [ ] Backend: 15 unit tests pass (5 per algorithm)
- [ ] Backend: Integration tests pass (`.http` file with 5+ requests)
- [ ] Backend: Query performance < 2s for 1000+ items
- [ ] Frontend: 5 component tests pass
- [ ] Frontend: Playwright E2E test passes with evidence
- [ ] Accessibility: Axe-core audit passes (0 violations)
- [ ] Accessibility: Keyboard navigation test passes
- [ ] Schema alignment test passes (frontend ↔ backend)
- [ ] TypeScript compilation passes
- [ ] ESLint passes
- [ ] Code review approved
- [ ] Documentation updated
- [ ] QA verification complete

## Follow-up Stories (Future)

### Phase 5 - UX Polish
- Sort Mode Persistence (localStorage)
- Visual Sort Indicators on Cards
- Animated Re-ordering

### Phase 6 - Advanced Features
- Multi-Currency Best Value
- Advanced Multi-Sort Filtering
- Customizable Hidden Gems Algorithm

### Infrastructure
- Optimize Smart Sorting Performance (materialized columns)
- Sort Mode Analytics & A/B Testing

## Token Budget

### Phase Summary

| Phase | Estimated | Actual | Delta | Notes |
|-------|-----------|--------|-------|-------|
| Elaboration | ~15k | — | — | PM orchestration + 3 workers |
| Implementation | ~12k | — | — | Frontend + Backend |
| Code Review | ~5k | — | — | Single domain |
| **Total** | ~32k | — | — | Medium-sized story |

### Actual Measurements

| Date | Phase | Before | After | Delta | Notes |
|------|-------|--------|-------|-------|-------|

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-28_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| — | None | Not Reviewed | Story passed all audit checks with no gaps |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| — | None | Not Reviewed | MVP scope is comprehensive and well-scoped |

### Follow-up Stories Suggested

- [x] WISH-2015: Sort Mode Persistence (localStorage) - Phase 5 UX Polish → WISH-2015
- [x] WISH-2016: Multi-Currency Best Value Algorithm - Phase 6 Internationalization → WISH-2016
- [x] WISH-2017: Advanced Multi-Sort Filtering - Phase 6 Advanced Features → WISH-2017

### Items Marked Out-of-Scope

- Algorithm customization (user-defined weights): Deferred to future story
- Multi-currency exchange rate handling: Deferred to Phase 6 (Internationalization)
- Secondary/combined sort modes: Deferred to future story
- Sort mode persistence in localStorage: Deferred to Phase 5 (UX Polish)
- Advanced filtering combined with smart sorting: Deferred to future story
- Real-time sort updates via WebSocket: Deferred to Phase 5

## Agent Log

| Timestamp (America/Denver) | Agent | Action | Outputs |
|---|---|---|---|
| 2026-01-27 12:30 | pm-story-followup-leader | Created follow-up story from WISH-2001 Enhancement #12 | WISH-2014.md |
| 2026-01-28 18:33 | pm-story-generation-leader | Orchestrated PM elaboration with 3 parallel workers | TEST-PLAN.md, UIUX-NOTES.md, FUTURE-UIUX.md, DEV-FEASIBILITY.md, FUTURE-RISKS.md |
| 2026-01-28 18:35 | pm-story-generation-leader | Synthesized comprehensive story file from worker outputs | WISH-2014.md (updated) |
| 2026-01-28 18:42 | elab-completion-leader | Completed QA elaboration audit with PASS verdict | ELAB-WISH-2014.md, QA Discovery Notes appended to WISH-2014.md |
