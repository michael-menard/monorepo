---
status: ready-to-work
follow_up_from: WISH-2011
created: 2026-01-28
updated: 2026-01-30
story_id: WISH-2121
title: Playwright E2E MSW Setup for Browser-Mode Testing
epic: Wishlist Feature
phase: 5 - Advanced Testing
priority: P2
depends_on: [WISH-2011]
complexity: Medium
effort: 2-3 points
---

# WISH-2121: Playwright E2E MSW Setup for Browser-Mode Testing

## Follow-up Context

**Parent Story:** WISH-2011
**Source:** QA Discovery Notes - Follow-up Stories Suggested (Finding #2)
**Original Finding:** "Playwright E2E MSW Setup - Browser-mode MSW support explicitly deferred to future"
**Category:** Enhancement Opportunity  
**Impact:** Medium
**Effort:** Medium

## Context

WISH-2011 established MSW (Mock Service Worker) infrastructure for Vitest unit/integration tests, enabling reliable testing of S3 upload flows without external dependencies. However, that story explicitly deferred browser-mode MSW setup for Playwright E2E tests to a future story.

Playwright E2E tests currently either:
1. Make real API/S3 calls (requiring backend/AWS infrastructure)
2. Use Playwright's built-in network interception (`page.route()`)
3. Skip upload testing entirely

Browser-mode MSW would provide a consistent mocking layer across both Vitest and Playwright, using the same handlers and fixtures. This reduces duplication, improves test reliability, and enables true end-to-end testing without external dependencies.

### Background

**MSW Status from WISH-2011:**
- Node-mode MSW configured for Vitest tests
- Handlers in `apps/web/app-wishlist-gallery/src/test/mocks/handlers.ts`
- Fixtures in `apps/web/app-wishlist-gallery/src/test/fixtures/s3-mocks.ts`
- S3 presign and PUT handlers working in unit/integration tests

**Playwright Status:**
- E2E tests in `apps/web/playwright/tests/`
- No MSW integration currently configured
- Upload flows either skip image testing or require real backend

**Browser-Mode MSW Requirements:**
- MSW worker script (`mockServiceWorker.js`) served from public directory
- Worker registration in test setup/teardown
- Same handlers as Vitest tests (reuse existing infrastructure)

## Goal

Enable Playwright E2E tests to use MSW for API and S3 mocking, providing:
- Consistent mocking layer across Vitest and Playwright tests
- No real backend/S3 dependencies for E2E tests
- Reuse of existing handlers and fixtures from WISH-2011
- Faster, more reliable E2E tests in CI

## Non-goals

- **New MSW Handlers:** No new handlers needed; reuse from WISH-2011
- **New Test Fixtures:** No new fixtures needed; reuse from WISH-2011
- **Visual Regression Tests:** Chromatic/screenshot testing out of scope
- **Real S3 Integration Tests:** End-to-end tests against actual S3 out of scope
- **Load Testing:** Stress testing with concurrent uploads out of scope
- **Playwright Test Authoring:** This story sets up infrastructure only; does not write new E2E tests

## Scope

### Packages Affected

- `apps/web/playwright/` - Playwright test configuration and setup
- `apps/web/app-wishlist-gallery/public/` - MSW worker script location
- `apps/web/app-wishlist-gallery/src/test/mocks/` - Reuse existing handlers
- `apps/web/app-wishlist-gallery/src/test/fixtures/` - Reuse existing fixtures

### Files to Create

1. **MSW Worker Script:**
   - `apps/web/app-wishlist-gallery/public/mockServiceWorker.js` - Generated by MSW CLI

2. **Playwright MSW Setup:**
   - `apps/web/playwright/setup/msw-browser.ts` - Browser worker registration
   - `apps/web/playwright/setup/msw-handlers.ts` - Re-export handlers from test/mocks

3. **Documentation:**
   - `apps/web/playwright/setup/README.md` - Browser-mode MSW documentation

### Files to Modify

1. **Playwright Configuration:**
   - `apps/web/playwright/playwright.config.ts` - Add MSW setup to global setup/teardown

2. **Example E2E Test:**
   - `apps/web/playwright/tests/wishlist/add-item.spec.ts` - Add or update upload flow test

## Acceptance Criteria

### AC1: MSW Worker Script Generated
**Given** the MSW CLI is available
**When** the developer runs `pnpm msw init public/`
**Then** the `mockServiceWorker.js` file is generated in `public/` directory
**And** the file is committed to version control
**And** the worker script is served by the dev server

### AC2: Browser Worker Registration Setup
**Given** Playwright tests need MSW
**When** the Playwright global setup runs
**Then** MSW browser worker is registered via `worker.start()`
**And** all handlers from WISH-2011 are loaded
**And** MSW intercepts API and S3 requests in the browser context

### AC3: Handlers Reused from WISH-2011
**Given** MSW handlers exist in `src/test/mocks/handlers.ts`
**When** Playwright tests run with MSW enabled
**Then** the same handlers used in Vitest tests are used in Playwright
**And** no handler duplication occurs
**And** presign and S3 PUT handlers work in browser context

### AC4: Fixtures Reused from WISH-2011
**Given** test fixtures exist in `src/test/fixtures/s3-mocks.ts`
**When** Playwright tests run
**Then** the same fixtures used in Vitest tests are available
**And** no fixture duplication occurs

### AC5: MSW Worker Starts Before Each Test
**Given** Playwright global setup has configured MSW
**When** each test file runs
**Then** MSW worker is active and intercepting requests
**And** handlers are registered before page navigation
**And** no unhandled network requests occur

### AC6: MSW Worker Stops After All Tests
**Given** Playwright tests have completed
**When** the global teardown runs
**Then** MSW worker is stopped via `worker.stop()`
**And** network interception is cleaned up
**And** no orphaned workers remain

### AC7: Upload Flow E2E Test Added
**Given** the add item page with image upload
**When** the Playwright test navigates to `/wishlist/add`
**And** fills the form with item details
**And** selects an image file
**And** clicks Submit
**Then** MSW intercepts the presign request
**And** MSW intercepts the S3 PUT request
**And** the item is created successfully
**And** no real API or S3 calls are made

### AC8: Error Injection Works in Playwright
**Given** a test needs to verify error handling
**When** the test configures MSW to return 500 error for presign
**Then** the presign handler returns error response
**And** the test verifies error toast appears
**And** the test can reset handlers to success state

### AC9: Concurrent Tests Don't Interfere
**Given** multiple Playwright tests run in parallel
**When** each test uses MSW handlers
**Then** each browser context has isolated MSW instance
**And** no state interference occurs between tests
**And** handlers remain consistent per test

### AC10: MSW Request Logs Available in Debug Mode
**Given** Playwright tests run with `DEBUG=pw:api`
**When** an upload test executes
**Then** MSW request logs show intercepted requests
**And** logs include presign and S3 PUT requests
**And** developers can verify MSW is working

### AC11: CI Runs E2E Tests Without AWS Credentials
**Given** the CI environment has no AWS credentials
**When** Playwright E2E tests run
**Then** all tests pass
**And** no tests fail due to missing credentials
**And** MSW handles all API and S3 requests

### AC12: Documentation Added
**Given** developers need to understand browser-mode MSW
**When** they read `apps/web/playwright/setup/README.md`
**Then** they understand:
  - How to generate MSW worker script
  - How browser worker registration works
  - How to reuse handlers from Vitest tests
  - How to debug MSW in Playwright
  - Differences between Node-mode (Vitest) and browser-mode (Playwright) MSW

### AC13: No Handler Duplication Between Vitest and Playwright
**Given** handlers exist in `src/test/mocks/handlers.ts`
**When** both Vitest and Playwright tests use MSW
**Then** both test suites import the same handler definitions
**And** handler logic is not duplicated
**And** fixture updates apply to both test suites automatically

## Test Plan

### Summary:

**Happy Path Tests:**
- MSW worker script generated and served correctly
- Browser worker starts and registers handlers
- Upload flow E2E test completes end-to-end with MSW
- Handlers from WISH-2011 work in browser context

**Error Cases:**
- Presign request failure (500) - error toast appears
- S3 upload failure (403) - error handling verified
- Worker registration failure - test suite aborts with clear error

**Edge Cases:**
- Concurrent tests with isolated MSW instances
- Worker cleanup on test suite completion
- Handler reset between tests

**Required Evidence:**
- At least 1 Playwright E2E test uses MSW for upload flow
- CI passes without AWS credentials
- MSW request logs show interception in debug mode
- No handler or fixture duplication

## Reuse Plan

### Reuse from WISH-2011

1. **MSW Handlers:**
   - Import handlers from `src/test/mocks/handlers.ts`
   - No modifications needed; browser-mode uses same handler definitions
   - Error injection patterns work identically

2. **Test Fixtures:**
   - Import fixtures from `src/test/fixtures/s3-mocks.ts`
   - Same presign responses, sample files
   - No duplication needed

3. **Zod Schemas:**
   - Import `PresignResponseSchema` from `@repo/api-client`
   - Validate fixtures against production schemas
   - Same validation logic as Vitest tests

### Reusable for Future Stories

1. **Browser Worker Pattern:**
   - Can be extended to other Playwright test suites
   - Reusable for future E2E upload scenarios
   - Template for other MSW browser integrations

2. **Handler Extension:**
   - Can add new handlers without modifying infrastructure
   - Error injection works same as Vitest tests
   - Same MSW API for both test environments

## Architecture Notes

### MSW Browser-Mode vs Node-Mode

**Node-Mode (Vitest - from WISH-2011):**
- Runs in Node.js process
- Intercepts requests via `@mswjs/interceptors`
- Setup: `setupServer()` in test setup file

**Browser-Mode (Playwright - this story):**
- Runs in browser context via Service Worker
- Intercepts requests at browser network layer
- Setup: `setupWorker()` + worker script in public directory

**Shared Elements:**
- Same handler definitions (HTTP methods, URL patterns, response logic)
- Same fixtures and test data
- Same MSW API for defining handlers

## Risks & Mitigations

### Risk 1: Worker Script Not Served Correctly
**Description:** MSW worker script must be served from public directory. If not configured correctly, browser-mode MSW will fail silently or throw errors.

**Likelihood:** Medium
**Impact:** High (E2E tests fail or make real network requests)

**Mitigation:**
- Follow MSW CLI command exactly: `npx msw init public/`
- Verify worker script is accessible at `/mockServiceWorker.js` during dev server
- Add test assertion to verify worker registration succeeds
- Document setup steps clearly in README

---

### Risk 2: Service Worker Persistence Between Tests
**Description:** Service Workers can persist in browser context between tests, causing state interference or stale handlers.

**Likelihood:** Medium
**Impact:** Medium (flaky tests, unexpected behavior)

**Mitigation:**
- Use `worker.stop()` in Playwright global teardown
- Clear Service Worker registration between test files if needed
- Use isolated browser contexts per test (Playwright default)
- Document cleanup steps in README

---

### Risk 3: Handler Differences Between Node and Browser Mode
**Description:** Some MSW features work differently in Node-mode vs browser-mode, potentially causing handler incompatibilities.

**Likelihood:** Low
**Impact:** Medium (handlers need modification)

**Mitigation:**
- Test handlers in both Vitest and Playwright to verify compatibility
- Use simple HTTP handlers without Node-specific features
- Consult MSW documentation for browser-mode limitations
- Add integration test to verify handlers work in both contexts

---

### Risk 4: CI Browser Permissions for Service Workers
**Description:** Some CI environments restrict Service Worker usage, causing browser-mode MSW to fail.

**Likelihood:** Low
**Impact:** High (E2E tests fail in CI)

**Mitigation:**
- Verify Service Workers are enabled in Playwright CI configuration
- Use Playwright's headless mode (Service Workers supported)
- Add CI smoke test to verify worker registration succeeds
- Document CI requirements in README

---

## Definition of Done

- [ ] MSW worker script generated at `public/mockServiceWorker.js` (AC1)
- [ ] Browser worker registration setup in Playwright global setup (AC2)
- [ ] Handlers reused from WISH-2011 (AC3)
- [ ] Fixtures reused from WISH-2011 (AC4)
- [ ] MSW worker starts before each test (AC5)
- [ ] MSW worker stops after all tests (AC6)
- [ ] Upload flow E2E test added or updated (AC7)
- [ ] Error injection works in Playwright (AC8)
- [ ] Concurrent tests don't interfere (AC9)
- [ ] MSW request logs available in debug mode (AC10)
- [ ] CI runs E2E tests without AWS credentials (AC11)
- [ ] Documentation added at `apps/web/playwright/setup/README.md` (AC12)
- [ ] No handler or fixture duplication (AC13)
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] All Playwright E2E tests pass locally and in CI
- [ ] Code reviewed and approved

---

## Out of Scope (Future Work)

- **Visual Regression Tests:** Chromatic/screenshot testing → Defer to UX polish story
- **Real S3 Integration Tests:** End-to-end tests against actual S3 → Out of scope
- **Load Testing:** Stress test with concurrent uploads → Defer to performance story
- **New E2E Test Authoring:** This story sets up infrastructure; new tests are separate stories

---

## Additional Acceptance Criteria (from QA Elaboration)

### AC14: Browser Context Isolation Verified
**Given** multiple Playwright tests run in parallel
**When** each test uses MSW handlers
**Then** Playwright's default context isolation ensures each test gets independent browser context
**And** MSW documentation clarifies that each browser context has its own Service Worker instance
**And** no explicit per-test worker registration is needed (relies on default Playwright behavior)

### AC15: Worker Lifecycle Clearly Documented
**Given** developers implement MSW setup
**When** they read the setup documentation
**Then** they understand: worker.start() runs once in global setup
**And** handler.resetHandlers() runs before each test (via beforeEach hook)
**And** worker.stop() runs once in global teardown
**And** implementation notes specify that worker persists across tests but handlers reset

### AC16: Error Injection Pattern Documented
**Given** a test needs to verify error handling
**When** the test documentation is read
**Then** developers understand the error injection pattern uses server.use() runtime override
**And** example shows presign 500 error injection (matching WISH-2011 Vitest pattern)
**And** documentation references WISH-2011 error injection examples

### AC17: Timeout Simulation Fixture Added
**Given** tests need to verify timeout error handling
**When** the timeout fixture is imported
**Then** MSW handlers support `delay()` to simulate network latency
**And** sample fixture provided for 5s, 10s, and infinite timeout scenarios
**And** test verifies timeout toast appears and user can retry

### AC18: Handler Reset Verification Added
**Given** multiple tests run in sequence
**When** handler.resetHandlers() is called before each test
**Then** test verifies that previous error overrides are cleared
**And** test confirms handlers return to default success responses
**And** test prevents state leakage between test cases

### AC19: Handler Extension Documentation Added
**Given** developers need to add new MSW handlers for future E2E tests
**When** they read the extension guide in `apps/web/playwright/setup/README.md`
**Then** they understand how to define new handlers without modifying infrastructure
**And** documentation shows example of adding presign endpoint variant
**And** clarifies difference between global handlers (all tests) and per-test overrides

### AC20: Worker Registration Failure Test Added
**Given** global setup attempts to register Service Worker
**When** registration fails (Service Worker unavailable)
**Then** test verifies setup fails with clear error message
**And** error message guides developer to troubleshoot (check browser permissions, CI config)
**And** CI smoke test verifies worker registration succeeds before test suite runs

### AC21: Error Injection Helper Utility Created
**Given** tests need to inject errors
**When** test imports error helper (e.g., from `playwright/setup/utils/error-injection.ts`)
**Then** helper provides convenience functions: `injectPresignError(code)`, `injectS3Error(code)`
**And** helper simplifies test code compared to raw server.use() calls
**And** helper uses same patterns as WISH-2011 error injection

### AC22: MSW Request Inspection Utility Created
**Given** developers debug MSW behavior
**When** they enable debug logging or use inspection utility
**Then** utility logs intercepted requests with: method, URL, response status, body
**And** logs show presign and S3 PUT requests in test output
**And** debugging guide explains how to enable inspection in CI logs

### AC23: Playwright Fixture for MSW Setup Created
**Given** Playwright tests need MSW initialization
**When** test imports `useMSW` fixture
**Then** fixture automatically starts MSW worker before test
**And** fixture resets handlers before each test
**And** fixture stops worker after all tests
**And** test code is cleaner (no explicit setup/teardown needed)

---

## Notes

### Implementation Approach (Recommended):

1. **Generate Worker Script:**
   - Run `npx msw init apps/web/app-wishlist-gallery/public/`
   - Commit `mockServiceWorker.js` to version control
   - Verify file is served at `/mockServiceWorker.js` during dev server

2. **Create Browser Worker Setup:**
   - Create `apps/web/playwright/setup/msw-browser.ts`
   - Import handlers from `src/test/mocks/handlers.ts`
   - Export configured worker

3. **Update Playwright Config:**
   - Add MSW worker start/stop to global setup/teardown
   - Verify worker registration in browser context

4. **Add or Update E2E Test:**
   - Add upload flow test to `playwright/tests/wishlist/add-item.spec.ts`
   - Verify presign and S3 PUT are intercepted by MSW
   - Verify no real network requests occur

5. **Verify CI:**
   - Run Playwright tests in CI without AWS credentials
   - Verify all tests pass
   - Check MSW request logs in debug mode

### Developer Experience:

- Documentation should explain differences between Node-mode and browser-mode MSW
- Setup should be one-time (worker script generation)
- Handlers should work identically in both test environments
- Debugging should be straightforward (MSW request logs)

### Quality Gates:

- E2E tests pass without AWS credentials
- No handler or fixture duplication between Vitest and Playwright
- Worker cleanup happens correctly
- Documentation is clear and complete

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-01-30_

### Issues Resolved via Additional AC

| # | Finding | Resolution | AC |
|---|---------|-----------|-----|
| 1 | Browser Context Isolation Mechanism Unclear | Added AC clarifying that Playwright's default context isolation suffices, with explicit documentation | AC14 |
| 2 | Worker Lifecycle Ambiguity | Added AC documenting clear lifecycle: setup once, reset per-test, teardown once | AC15 |
| 3 | Error Injection Pattern Not Documented | Added AC documenting error injection pattern using server.use() runtime overrides | AC16 |

### Gaps Identified

| # | Finding | User Decision | AC |
|---|---------|---------------|-----|
| 1 | No timeout simulation fixture | Add as AC | AC17 |
| 2 | No handler reset verification | Add as AC | AC18 |
| 3 | No documentation for extending handlers | Add as AC | AC19 |
| 4 | No test for worker registration failure | Add as AC | AC20 |

### Enhancement Opportunities

| # | Finding | User Decision | AC |
|---|---------|---------------|-----|
| 1 | Error injection convenience helper | Add as AC | AC21 |
| 2 | MSW request inspection utility | Add as AC | AC22 |
| 3 | Playwright fixture for MSW setup | Add as AC | AC23 |
| 4 | Visual test for upload progress | Out-of-scope | — |
| 5 | Performance benchmarking | Out-of-scope | — |
| 6 | Shared worker script management | Out-of-scope | — |

### Follow-up Stories Suggested

None - all enhancements have been incorporated into this story via AC14–AC23.

### Items Marked Out-of-Scope

- **Visual test for upload progress**: Chromatic/screenshot testing deferred to UX polish story
- **Performance benchmarking**: Load testing and concurrent upload stress testing deferred to performance story
- **Shared worker script management**: Multi-app worker script strategy deferred to future story

### Summary

QA elaboration identified 3 implementation clarity gaps and 4 feature gaps in the original 13 AC. Through interactive discussion with stakeholders:
- 3 issues resolved with new AC (AC14–AC16) clarifying design decisions
- 4 gaps filled with new AC (AC17–AC20) covering missing functionality
- 3 enhancements approved (AC21–AC23) for improved developer experience
- 3 items deferred out-of-scope (visual tests, performance, shared worker management)

**Total AC expanded**: 13 → 23

**Ready for Implementation**: YES - All gaps identified in audit have been resolved.
