perspective: security
verdict: CONCERNS

scope:
  threat_model_complete: true
  compliance_requirements_identified: true
  security_implementation_planned: true

mvp_blockers:
  - id: SEC-001
    issue: COGN-005 JWT signature verification implementation unclear - core security gate for all requests
    stories: [COGN-005]
    action: Spec JWKS verification algorithm, key rotation handling, and signature validation before implementation

  - id: SEC-002
    issue: COGN-006 admin bypass logic must be strictly enforced - critical for authorization integrity
    stories: [COGN-006]
    action: Define admin bypass only for specific scopes; document approval workflow before implementation

  - id: SEC-003
    issue: COGN-019 age verification relies on self-reported birthdate - compliance risk for underage users
    stories: [COGN-019]
    action: Document legal compliance approach (honor system vs. 3rd party verification) before implementation

threat_model:
  threat_id: T-001
  threat: Unauthorized quota modification
  attacker_goal: Gain unlimited access without paying
  attack_vector: Modify quota database directly
  impact: Revenue loss, platform integrity
  mitigation_story: COGN-001 (database constraints), COGN-024 (reconciliation)
  severity: critical

  threat_id: T-002
  threat: JWT token forgery
  attacker_goal: Impersonate other users
  attack_vector: Create invalid JWT and submit to API
  impact: Account takeover, data breach
  mitigation_story: COGN-005 (signature verification)
  severity: critical

  threat_id: T-003
  threat: Scope privilege escalation
  attacker_goal: Bypass tier restrictions
  attack_vector: Add own scope to JWT
  impact: Free users get pro features without payment
  mitigation_story: COGN-004 (server-side scope generation), COGN-006 (verification)
  severity: critical

  threat_id: T-004
  threat: Quota exhaustion attack (DoS)
  attacker_goal: Make platform unusable for others
  attack_vector: Make many requests to exhaust shared quotas
  impact: Service degradation
  mitigation_story: COGN-007 (quota enforcement), COGN-025 (load testing)
  severity: high

  threat_id: T-005
  threat: Age verification circumvention
  attacker_goal: Minor gains access to age-restricted features
  attack_vector: Submit false birthdate
  impact: COPPA violation, legal liability
  mitigation_story: COGN-019, COGN-020, COGN-024 (reconciliation)
  severity: high

authentication_requirements:
  - story: COGN-003
    requirement: Cognito enforces strong password policy
    config: 12 chars minimum, upper + lower + number + symbol
    validation: COGN-025 tests password requirements

  - story: COGN-003
    requirement: Cognito supports MFA for sensitive operations
    config: Optional for MVP; required for power tier Post-MVP
    validation: Implemented in user settings

  - story: COGN-005
    requirement: JWT signature verified using Cognito public keys (JWKS)
    config: JWKS endpoint cached, refreshed on key rotation
    validation: COGN-025 tests key rotation scenarios

  - story: COGN-015
    requirement: JWT stored in httpOnly cookie, not localStorage
    config: Secure flag, SameSite=Strict
    validation: COGN-025 verifies cookie security headers

authorization_requirements:
  - story: COGN-006
    requirement: Scope verification fails closed
    config: No scope = no operation; default deny
    validation: COGN-025 tests all missing scope scenarios

  - story: COGN-006
    requirement: Admin bypass logged and auditable
    config: CloudWatch logs include admin bypasses
    validation: Audit trail verified in COGN-025

  - story: COGN-007
    requirement: Quota checks happen in database transaction
    config: FOR UPDATE locking prevents race conditions
    validation: COGN-025 tests concurrent quota operations

  - story: COGN-007
    requirement: Quota enforcement is atomic
    config: Check and increment in single transaction
    validation: COGN-025 verifies no race condition windows

data_protection:
  - asset: User birthdate
    classification: PII
    protection: Encrypted at rest, never in JWT
    access: Only quota/age verification logic
    retention: Until user account deleted
    story: COGN-019

  - asset: User tier/scopes
    classification: sensitive
    protection: Server-side generation, verified on every request
    access: All API endpoints
    retention: JWT lifetime only
    story: COGN-004, COGN-005

  - asset: Quota usage
    classification: sensitive
    protection: Database constraints, reconciliation jobs
    access: Quota verification middleware
    retention: 7 days (archive for billing)
    story: COGN-007, COGN-024

  - asset: Admin bypass log
    classification: audit
    protection: CloudWatch logs, retention 30 days
    access: Ops team only
    retention: 30 days
    story: COGN-006

compliance_requirements:
  - standard: COPPA (Children's Online Privacy Protection Act)
    requirement: Users under 13 cannot use chat
    implementation: Age verification in COGN-019/020
    validation: COGN-025 tests age checks
    note: Currently treats all minors (under 18) same; consider Post-MVP refinement

  - standard: GDPR (EU users)
    requirement: Age of digital consent is 16 in EU
    implementation: Consider regional requirements Post-MVP
    note: Current approach (18 for chat) is conservative; legal review needed

  - standard: CCPA (California)
    requirement: Users have data deletion right
    implementation: Account deletion deletes all PII and quotas
    note: Post-MVP; add deletion flow in user settings

  - standard: SOC 2
    requirement: Audit trails for sensitive operations
    implementation: CloudWatch logging in COGN-023
    validation: Audit completeness validated in COGN-025

  - standard: PCI DSS (if payment processing added)
    note: Out of scope for MVP; plan for future payment integration

api_security:
  - requirement: All endpoints require authentication
    implementation: COGN-005 middleware on all routes
    validation: COGN-025 tests unauthenticated access rejected

  - requirement: CSRF protection on state-changing endpoints
    implementation: SameSite cookies (COGN-015) + CSRF tokens
    validation: COGN-025 tests CSRF attack prevention

  - requirement: Rate limiting on auth endpoints
    implementation: API Gateway throttling + Lambda implementation
    validation: COGN-025 tests rate limit enforcement

  - requirement: SQL injection prevention
    implementation: Parameterized queries (ORM/driver level)
    validation: Code review in COGN-025

  - requirement: Secret management (database credentials, Cognito keys)
    implementation: AWS Secrets Manager
    validation: COGN-025 verifies no secrets in code/logs

secrets_management:
  - secret: Database connection string
    storage: AWS Secrets Manager
    rotation: Manual (Post-MVP: automatic rotation)
    access: Lambda execution role only

  - secret: Cognito client secret
    storage: AWS Secrets Manager
    rotation: Manual via Cognito console
    access: Lambda execution role only

  - secret: JWKS signing keys
    storage: Cognito User Pool (managed)
    rotation: Cognito handles; Lambda fetches via HTTPS
    access: Public (JWKS endpoint)

  - secret: Admin credentials
    storage: Cognito Admin API (not in code)
    rotation: Manual via user settings
    access: Admin group users only

incident_response:
  - scenario: Quota database corruption detected
    response: Activate COGN-024 reconciliation job immediately
    owner: On-call ops engineer
    sla: <15 minutes to restore consistency

  - scenario: JWT signature verification failures spike
    response: Check JWKS endpoint availability; rollback Lambda if needed
    owner: On-call engineer
    sla: <5 minutes to restore auth

  - scenario: Unauthorized admin bypass detected
    response: Revoke admin access; audit CloudWatch logs for scope
    owner: Security team
    sla: <1 hour investigation; notify user

  - scenario: Age verification bypass (minor accesses chat)
    response: Lock account; notify parent/guardian per COPPA
    owner: Legal + Support team
    sla: <24 hours notification

future:
  deferred_security:
    - MFA enforcement for power tier Post-MVP
    - 3rd party age verification service Post-MVP
    - Regional compliance (GDPR) Post-MVP
    - Encryption key rotation Post-MVP

  recommendations:
    - "Conduct security audit before COGN-027 production launch"
    - "Require peer review on all COGN-005, COGN-006 scope/auth code"
    - "Implement secrets rotation automation Pre-MVP"
    - "Run penetration testing on quota enforcement (COGN-007)"
    - "Document incident response procedures before launch"

metrics:
  threat_scenarios_identified: 5
  critical_threats_mitigated: 3
  compliance_standards_addressed: 5
  mvp_blockers: 3

SECURITY REVIEW COMPLETE
