---
perspective: engineering
reviewer: engineering-agent
reviewed_at: "2026-01-25T17:00:00Z"
verdict: CONCERNS

findings:
  critical:
    - issue: "SETS-007 (CRUD API) marked as high-risk with atomic transaction requirement, but story has sizing warning yet is foundational blocker for 11 other stories"
      detail: "Creates cascading risk if implementation scope underestimated. No mitigation strategy documented for transaction complexity or performance indexing upfront."
      affected_stories: [SETS-007]

    - issue: "SETS-008 (Wishlist integration) has inadequate transaction pattern documentation"
      detail: "Cross-epic dependency requires atomic create-then-delete flow with rollback handling and undo support. Risk of data loss if Set creation succeeds but Wishlist deletion fails mid-transaction. Current docs describe pattern but lack implementation specifics (e.g., will this use database transactions, saga pattern, event sourcing?)."
      affected_stories: [SETS-008]

    - issue: "Many-to-many relationship (set_moc_links) underspecified in database design"
      detail: "SETS-011 depends on MOC Instructions epic (external dependency) for bidirectional updates. No cascade delete rules, orphan handling, or referential integrity constraints documented. Risk of broken links if MOC Instructions deletes records."
      affected_stories: [SETS-011]

  high:
    - issue: "Database schema incomplete - missing indexes and constraints"
      detail: "SETS-007 mentions 'proper indexing needed for performance' but doesn't specify which fields. For collection queries at scale (10k+ sets per user potentially), need indexes on (userId, setNumber), (userId, createdAt), (userId, isBuilt). Also missing: unique constraint on (userId, setNumber) for duplicate detection logic."
      affected_stories: [SETS-007, SETS-014, SETS-018]

    - issue: "SETS-018 (duplicate detection) logic conflicts with SETS-010 (quantity stepper)"
      detail: "If user can increment quantity on existing set, why create new entries? Duplicate detection prompts 'add to quantity vs new entry' but doesn't explain when to choose each. This creates UX ambiguity and data model inconsistency. Risk of users creating many single-quantity entries for same set."
      affected_stories: [SETS-018, SETS-010]

    - issue: "Scraper service dependency shared with Wishlist but no integration plan"
      detail: "SETS-005 and SETS-013 depend on shared scraper (POST /api/scraper/product). No documentation of error handling contract, rate limiting, retry logic, or failure modes. If Wishlist hasn't implemented scraper yet, SETS-005 is actually blocked."
      affected_stories: [SETS-005, SETS-013]

    - issue: "Optimistic update pattern needs formal error recovery spec"
      detail: "SETS-009, SETS-010 implement optimistic UI updates with undo. No specification for: how long is undo window (5s mentioned once)? What if user closes tab during undo? State consistency if multiple rapid updates fail? Need formal rollback contract."
      affected_stories: [SETS-009, SETS-010, SETS-021]

    - issue: "Storage architecture for images underspecified"
      detail: "PLAN mentions S3 for image storage but doesn't specify: signed URLs vs public, expiration policies, CDN caching strategy, image optimization (resize, format), cleanup for deleted sets. Risk of orphaned S3 objects and unexpected costs."
      affected_stories: [SETS-005, SETS-006, SETS-013]

  medium:
    - issue: "SETS-019 (accessibility) comes late in phase 5 after core features built"
      detail: "Keyboard shortcuts (B, +/-, M, A, Delete) and focus management should be architected into components from phase 1, not retrofitted. Current sequence risks inaccessible foundation requiring expensive refactoring. Recommend making SETS-019 a phase 2 story."
      affected_stories: [SETS-019, SETS-005, SETS-007, SETS-009, SETS-010]

    - issue: "Mobile-first responsive design deferred to phase 5"
      detail: "SETS-020 listed as low priority but touch targets, swipe gestures, and bottom sheets require component architecture decisions from phase 1. Retrofitting touch interactions onto desktop-first components is expensive."
      affected_stories: [SETS-020, SETS-005, SETS-009]

    - issue: "API endpoint design lacks detail on filtering/sorting parameters"
      detail: "SETS-014 mentions GET /api/sets with query params for sort/filter but no OpenAPI spec or parameter schema. Risk of inconsistent implementations across stories. Need: parameter names, allowed values, default sort order, pagination cursor/offset, max limit."
      affected_stories: [SETS-014]

    - issue: "Tags integration depends on availability of shared tag management"
      detail: "SETS-015 depends on tag system from 'shared tag management package' which may not exist. No fallback plan if package unavailable. Risk of story blocking if package incomplete."
      affected_stories: [SETS-015]

    - issue: "Gallery package integration untested"
      detail: "Multiple stories (SETS-005, SETS-014, SETS-017) depend on 'shared gallery package' for sorting, filtering, empty states. Package availability and API contract not confirmed. Risk of integration surprises."
      affected_stories: [SETS-005, SETS-014, SETS-017]

    - issue: "No pagination/virtualization strategy for large collections"
      detail: "PLAN mentions 'Pagination, virtualized list, proper indexing' as future work but doesn't specify limits. If queries default to 1000 records, 10k+ collections will timeout. Need upfront API limit (e.g., max 100 per page) and lazy-loading implementation."
      affected_stories: [SETS-014]

    - issue: "Cross-epic dependency on Wishlist (SETS-008) not validated"
      detail: "Transaction pattern for 'Got it' flow depends on Wishlist API contract. No spec for: Wishlist DELETE endpoint behavior, error handling, audit trail. Risk of incompatible implementations."
      affected_stories: [SETS-008, SETS-021]

    - issue: "Cross-epic dependency on MOC Instructions (SETS-011) not validated"
      detail: "MOC linking requires GET /api/mocs endpoint from MOC epic. No spec for response schema, filtering, or how bidirectional updates work. Risk of interface mismatch."
      affected_stories: [SETS-011]

  low:
    - issue: "SETS-009 'celebration animation' is scope creep risk"
      detail: "Brief celebration animation (confetti, glow) is vague. Need: animation duration, accessibility implications (motion-reduce prefers-reduced-motion), performance impact. Risk of gold-plating."
      affected_stories: [SETS-009]

    - issue: "SETS-021 'scroll to new item' assumes single-view architecture"
      detail: "If Sets Gallery can be in grid or list layout (PLAN mentions both), scroll-to behavior differs. Spec needed: does grid scroll to row? What if item off-screen due to filters? What about mobile bottom sheet?"
      affected_stories: [SETS-021]

    - issue: "SETS-016 collection stats endpoint performance not scoped"
      detail: "Aggregation queries (total sets, unique sets, total pieces, total value) on large collections could be expensive. Consider: is this pre-computed on write? Cached? Or computed on-demand? Current spec is silent."
      affected_stories: [SETS-016]

    - issue: "Type safety across Zod schemas for cross-epic integration unclear"
      detail: "SETS depends on Wishlist (item data), MOC Instructions (MOC data), Scraper (product data). No shared Zod schema definitions for these cross-epic boundaries. Risk of runtime validation failures."
      affected_stories: [SETS-008, SETS-011, SETS-005]

missing_stories:
  - title: "Database Migration Story"
    description: "SETS-007 assumes Aurora PostgreSQL table 'sets' exists with schema and indexes. No migration story documented. Need: database migration authorship, testing, rollback procedure."
    impacts: [SETS-007]

  - title: "API Documentation Story"
    description: "No story for OpenAPI/Swagger generation or API documentation. Risk of unclear contract between frontend and backend teams."
    impacts: [SETS-007, SETS-009, SETS-010]

  - title: "Error Handling & Logging Story"
    description: "No story specifies error codes, logging strategy, monitoring, or alerting for API failures. Current specs mention 'handle scraper failures gracefully' and 'revert toggle visually' but lack formal error contract."
    impacts: [SETS-005, SETS-009, SETS-010, SETS-008]

  - title: "Performance & Load Testing Story"
    description: "No story for load testing query performance, pagination limits, or bulk operation handling. Risk of N+1 queries, slow detail views."
    impacts: [SETS-014, SETS-016]

  - title: "Image Processing & Optimization Story"
    description: "S3 image storage mentioned but no story for image resizing, format conversion, CDN setup, or cleanup. Risk of storage bloat."
    impacts: [SETS-005, SETS-013]

effort_assessment:
  understated:
    - story: "SETS-007"
      issue: "Marked 'Yes' for sizing warning but listed as High risk with atomic transaction requirement, proper indexing, and cross-epic integration complexity. Actually likely 8-13pts, not typical CRUD endpoint effort."
      confidence: high

    - story: "SETS-008"
      issue: "Wishlist 'Got it' integration flagged High risk but seems estimated as standard feature. Atomic transaction + rollback + undo + cross-epic coordination suggests 8-13pts minimum."
      confidence: high

    - story: "SETS-005"
      issue: "Add modal with URL scrape depends on shared scraper service reliability. If scraper shared implementation isn't solid, error handling and fallback flows add complexity. Likely 5-8pts vs. estimated ~3."
      confidence: medium

    - story: "SETS-019"
      issue: "Keyboard shortcuts for B, +/-, M, A, Delete with proper focus management across modals. Accessibility retrofitting typically 5-8pts if not architected in."
      confidence: medium

    - story: "SETS-011"
      issue: "MOC linking picker (searchable, multi-select) + bidirectional display + cross-epic dependency. UI complexity likely underestimated at ~3-5pts, probably 5-8pts."
      confidence: medium

  overstated:
    - story: "SETS-017"
      issue: "Empty states described as 'low risk, pure UI implementation' and seems appropriately scoped. 2-3pts is reasonable."
      confidence: high

    - story: "SETS-013"
      issue: "Manual entry form is straightforward HTML form. 2-3pts is reasonable if SETS-005 scaffolding exists."
      confidence: high

technical_risks:
  - risk: "Database transaction rollback on Wishlist â†’ Sets transfer could lose data if not implemented as atomic operation"
    likelihood: medium
    impact: high
    mitigation: "Specify transaction strategy upfront (database ACID vs. application-level saga pattern). Document rollback procedure and undo window. Add integration tests for failure scenarios (create succeeds, delete fails; create fails mid-transaction, etc.)."
    affected_stories: [SETS-008]

  - risk: "Shared scraper service (LEGO.com scraping) could fail, break, or have rate limiting issues affecting both Wishlist and Sets epics"
    likelihood: medium
    impact: medium
    mitigation: "Create shared error handling specification for scraper failures. Implement circuit breaker pattern. Document fallback (manual entry). Test against real LEGO.com to validate URL patterns."
    affected_stories: [SETS-005, SETS-013]

  - risk: "Optimistic UI updates (SETS-009, SETS-010) could leave user in inconsistent state if network fails and undo window expires"
    likelihood: medium
    impact: medium
    mitigation: "Specify undo window duration and recovery mechanism if user doesn't undo before window closes. Consider persisting pending operations to localStorage. Add telemetry to detect undo failures."
    affected_stories: [SETS-009, SETS-010]

  - risk: "Many-to-many MOC linking (set_moc_links) could have orphaned records if MOC Instructions deletes a MOC without notifying Sets"
    likelihood: low
    impact: high
    mitigation: "Define cascade delete rules in database schema. Document referential integrity constraints. Add integration test validating bidirectional deletion."
    affected_stories: [SETS-011]

  - risk: "Duplicate set detection (SETS-018) logic unclear with quantity stepper (SETS-010) - ambiguous data model for 'same set, different purchase'"
    likelihood: high
    impact: medium
    mitigation: "Clarify: should duplicate detection create new entry or increment quantity? Document decision and add validation to enforce consistency. Consider unique constraint on (userId, setNumber, purchaseDate) or allow quantity-only model."
    affected_stories: [SETS-018, SETS-010]

  - risk: "S3 image storage orphaning if Set with imageUrl deleted without cleanup"
    likelihood: medium
    impact: low
    mitigation: "Implement cascade delete in Sets DELETE endpoint to remove S3 objects. Add periodical cleanup job for orphaned images. Document S3 bucket retention policies."
    affected_stories: [SETS-005, SETS-006, SETS-012, SETS-013]

  - risk: "API query performance degradation as collection size grows without pagination or index strategy"
    likelihood: medium
    impact: medium
    mitigation: "Specify default pagination limit (e.g., 100 records). Create index on (userId, createdAt) and (userId, isBuilt). Add load test with 10k+ records. Monitor query execution plans."
    affected_stories: [SETS-007, SETS-014, SETS-016]

  - risk: "Cross-epic integration with Wishlist and MOC Instructions could be delayed, blocking downstream stories"
    likelihood: medium
    impact: high
    mitigation: "Validate Wishlist and MOC Instructions API contracts early. Create integration test mocks. Consider feature flags to decouple rollout."
    affected_stories: [SETS-008, SETS-011, SETS-021]

  - risk: "Shared gallery package (SETS-005, SETS-014, SETS-017) might not exist or have incompatible API"
    likelihood: medium
    impact: medium
    mitigation: "Verify gallery package exists and audit its API. Create adapter if needed. Add interface tests to catch breaking changes early."
    affected_stories: [SETS-005, SETS-014, SETS-017]

  - risk: "Accessibility (SETS-019) retrofitted late could require expensive component refactoring"
    likelihood: high
    impact: medium
    mitigation: "Move SETS-019 to Phase 2 (after SETS-007). Define accessible component patterns upfront. Add accessibility testing to component layer, not at feature layer."
    affected_stories: [SETS-019]

recommendations:
  - description: "Upfront: Create detailed OpenAPI specification for all SETS API endpoints (GET /api/sets, POST /api/sets, PATCH /api/sets/:id, DELETE /api/sets/:id, POST /api/sets/:id/build-status, etc.). Include error response codes, pagination parameters, and sorting/filtering contracts."
    priority: high
    affects_stories: [SETS-007, SETS-009, SETS-010, SETS-014]

  - description: "Create database migration story before SETS-007 implementation. Document: schema definition, indexes (userId, setNumber), (userId, createdAt), constraints, rollback procedure."
    priority: high
    affects_stories: [SETS-007]

  - description: "Validate cross-epic dependencies early: confirm Wishlist 'Got it' DELETE endpoint contract, MOC Instructions GET /api/mocs response schema, Scraper service error handling. Create integration contracts document."
    priority: high
    affects_stories: [SETS-005, SETS-008, SETS-011]

  - description: "Clarify duplicate set detection strategy: decide whether (1) increment quantity on duplicate, or (2) allow multiple entries with different purchase dates. Update SETS-018 and SETS-010 with consistent data model. Add database constraint to enforce choice."
    priority: high
    affects_stories: [SETS-018, SETS-010]

  - description: "Specify transaction pattern for SETS-008 (Wishlist 'Got it' flow): database ACID transaction vs. saga pattern vs. event sourcing? Document rollback scenarios, undo window duration, and idempotency guarantees."
    priority: high
    affects_stories: [SETS-008]

  - description: "Add explicit story for Image Processing: S3 image storage optimization, signed URLs, CDN setup, format conversion (WebP), cleanup on delete."
    priority: high
    affects_stories: [SETS-005, SETS-006, SETS-013]

  - description: "Reclassify SETS-019 (Accessibility) to Phase 2. Keyboard navigation and focus management need to be architected into components early, not retrofitted."
    priority: high
    affects_stories: [SETS-019]

  - description: "Create formal error handling specification: HTTP error codes, retry logic (exponential backoff), timeout values, circuit breaker thresholds. Apply to all stories touching external services (scraper, Wishlist, MOC)."
    priority: high
    affects_stories: [SETS-005, SETS-008, SETS-011, SETS-013]

  - description: "Define pagination strategy: default limit (recommend 100), cursor vs. offset, max page size, handling filters with pagination. Implement in SETS-007 API, not SETS-014."
    priority: high
    affects_stories: [SETS-007, SETS-014]

  - description: "Create performance baseline: load test SETS-007 and SETS-014 endpoints with 1k, 10k, 100k records. Ensure query < 200ms p99, API response < 500ms p99."
    priority: medium
    affects_stories: [SETS-007, SETS-014, SETS-016]

  - description: "Add integration tests for optimistic update failures (SETS-009, SETS-010, SETS-021): network timeout during save, server returns error, undo expires. Validate UI and state consistency."
    priority: medium
    affects_stories: [SETS-009, SETS-010, SETS-021]

  - description: "Verify shared gallery package API and create adapter if incompatible. Add interface tests to catch breaking changes."
    priority: medium
    affects_stories: [SETS-005, SETS-014, SETS-017]

  - description: "Document image optimization strategy: supported formats (JPEG, WebP), max dimensions, CDN cache headers, signed URL expiration. Implement in SETS-005 scraper flow and SETS-013 manual upload."
    priority: medium
    affects_stories: [SETS-005, SETS-013]

  - description: "Add database cascade delete rules for set_moc_links and referential integrity tests when MOC Instructions deletes records."
    priority: medium
    affects_stories: [SETS-011]

  - description: "Specify minimum touch target sizes (44px) and gesture recognition patterns for SETS-020 (mobile). Design component library variants for touch vs. desktop."
    priority: medium
    affects_stories: [SETS-020]

  - description: "Create Zod schema definitions for cross-epic data boundaries: WishlistItem shape, MOCInstruction shape, ProductScrapeResult shape. Share via workspace packages."
    priority: medium
    affects_stories: [SETS-005, SETS-008, SETS-011]

summary: |
  **Overall Assessment:**

  The SETS epic is well-structured with clear phasing and dependency management. Core functionality is sound: collection management, purchase tracking, build status, Wishlist integration, and MOC linking represent a cohesive feature set.

  **However, engineering readiness has CONCERNS:**

  1. **Database & Data Model:** Schema is incomplete. Missing indexes, constraints, and cascade delete rules. Duplicate detection (SETS-018) conflicts with quantity stepper (SETS-010) in data model design.

  2. **Cross-Epic Integration:** Three hard dependencies (Wishlist, MOC Instructions, Scraper) lack validated API contracts. Transaction pattern for atomic "Got it" flow (SETS-008) is high-risk without upfront specification.

  3. **Effort Underestimation:** SETS-007, SETS-008, SETS-005 likely underestimated by 30-50%. Transaction complexity, error handling, scraper integration add substantial scope.

  4. **Accessibility:** SETS-019 deferred to Phase 5 but requires Phase 1 architectural decisions. Retrofitting keyboard shortcuts and focus management is expensive.

  5. **Missing Stories:** Database migration, API documentation, error handling, performance testing, and image processing are undocumented.

  **Recommendation:** Proceed with Phase 1-2 (SETS-007, SETS-005) but invest in upfront specification work: OpenAPI contracts, database schema design, transaction patterns, and cross-epic validation. Reclassify accessibility to Phase 2. Create missing stories for migration and error handling.

