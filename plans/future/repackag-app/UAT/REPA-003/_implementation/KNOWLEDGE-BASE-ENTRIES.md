# Knowledge Base Entries - REPA-003
# Generated by elab-autonomous-decider: 2026-02-10

Non-blocking findings and enhancement opportunities logged for future reference.

---

## Non-Blocking Gaps

### Gap #4: useToast import path inconsistency
**Severity:** LOW
**Category:** code-quality
**Tags:** import-paths, standardization

**Finding:**
- main-app imports from `@repo/app-component-library/hooks/useToast`
- app-instructions-gallery imports from `@repo/app-component-library`

**Impact:** Low - inconsistent import paths but both work

**Recommendation:** Standardize to barrel export per CLAUDE.md: `import { useToast } from '@repo/app-component-library'`

**Related Stories:** REPA-003

---

### Gap #5: No TypeScript type-only imports
**Severity:** LOW
**Category:** performance, code-quality
**Tags:** typescript, bundle-size

**Finding:**
Story doesn't enforce `import type` for type-only imports. While not breaking, this could increase bundle size.

**Impact:** Low - minor bundle size increase

**Recommendation:** Add linting rule to enforce type-only imports in future package structure stories. Consider adding to ESLint config:
```json
{
  "@typescript-eslint/consistent-type-imports": ["error", {
    "prefer": "type-imports"
  }]
}
```

**Related Stories:** REPA-003

---

### Gap #6: No Zod schema migration for hook options
**Severity:** LOW
**Category:** code-quality, type-safety
**Tags:** zod, schemas, runtime-validation

**Finding:**
Story uses TypeScript interfaces for `UseUploadManagerOptions` and `UseUploaderSessionOptions`. Per CLAUDE.md, all types should use Zod schemas.

**Impact:** Low - no runtime validation of hook parameters

**Recommendation:** Create Zod schemas for hook options in future refactor:
```typescript
const UseUploaderSessionOptionsSchema = z.object({
  route: z.string().min(1),
  isAuthenticated: z.boolean().optional(),
  userId: z.string().uuid().optional(),
  onRestore: z.function().optional(),
})

export type UseUploaderSessionOptions = z.infer<typeof UseUploaderSessionOptionsSchema>
```

**Related Stories:** REPA-003

---

### Gap #7: Missing hook deprecation warnings
**Severity:** LOW
**Category:** developer-experience
**Tags:** migration, deprecation

**Finding:**
Story documents breaking changes in useUploaderSession API but doesn't include deprecation warnings in old hook locations before deletion.

**Impact:** Low - could help catch missed migration spots during gradual rollout

**Recommendation:** Add console.warn deprecation messages in app-local hooks before deletion:
```typescript
// In old hooks before deletion:
console.warn(
  'useUploaderSession is deprecated. Import from @repo/upload/hooks instead. ' +
  'See REPA-003 migration guide for breaking changes.'
)
```

**Related Stories:** REPA-003

---

### Gap #8: No performance benchmarks for debounced localStorage writes
**Severity:** LOW
**Category:** performance, testing
**Tags:** performance-testing, localStorage

**Finding:**
Story preserves 300ms debounce delay but doesn't validate this is optimal for consolidated hook.

**Impact:** Low - delay may not be optimal

**Recommendation:** Add performance tests to measure localStorage write impact on upload flow:
```typescript
// Performance test example
it('should debounce localStorage writes efficiently', async () => {
  const startTime = performance.now()
  // Trigger rapid session updates
  const endTime = performance.now()
  expect(endTime - startTime).toBeLessThan(500) // Example threshold
})
```

**Related Stories:** REPA-003

---

### Gap #9: File handle tracking uses Map without size limits
**Severity:** MEDIUM
**Category:** edge-case, memory-management
**Tags:** memory-leak, file-handles

**Finding:**
useUploadManager tracks File objects in a ref Map with no cleanup strategy. For long-running upload sessions, this could accumulate memory.

**Impact:** Medium - potential memory leak in long sessions

**Recommendation:** Add size limit or LRU eviction policy in future enhancement:
```typescript
// Example LRU implementation
const MAX_FILE_HANDLES = 100
if (fileHandlesRef.current.size >= MAX_FILE_HANDLES) {
  const firstKey = fileHandlesRef.current.keys().next().value
  fileHandlesRef.current.delete(firstKey)
}
```

**Related Stories:** REPA-003

---

### Gap #10: Session migration (anon â†’ auth) not covered by E2E tests
**Severity:** MEDIUM
**Category:** testing, edge-case
**Tags:** e2e-testing, session-migration

**Finding:**
AC-7 documents session migration scenario (user logs in mid-upload) but TEST-PLAN.md marks E2E tests as optional. This is a complex user flow that benefits from E2E coverage.

**Impact:** Medium - complex flow could have edge cases

**Recommendation:** Add dedicated E2E test in future iteration:
```typescript
// Playwright E2E test
test('should migrate session from anonymous to authenticated', async ({ page }) => {
  // 1. Start upload as anonymous
  // 2. Log in mid-upload
  // 3. Verify session data migrated
  // 4. Verify old anon key removed
  // 5. Verify upload continues seamlessly
})
```

**Related Stories:** REPA-003

---

### Gap #11: No instrumentation for upload analytics
**Severity:** LOW
**Category:** observability
**Tags:** analytics, telemetry, monitoring

**Finding:**
Hooks have no telemetry/analytics hooks (e.g., tracking upload success rates, retry counts, session restoration frequency).

**Impact:** Low - no visibility into upload behavior patterns

**Recommendation:** Add optional analytics callback in future story:
```typescript
export interface UseUploadManagerOptions {
  // ... existing options
  onAnalyticsEvent?: (event: {
    type: 'upload_start' | 'upload_success' | 'upload_fail' | 'retry' | 'cancel'
    fileId: string
    metadata?: Record<string, unknown>
  }) => void
}
```

**Related Stories:** REPA-003

---

## Enhancement Opportunities

### Enhancement #1: Hook composability - useUploadManager + useUploaderSession coupling
**Impact:** Medium
**Effort:** High
**Category:** developer-experience
**Tags:** api-design, composability

**Finding:**
Current architecture requires apps to wire useUploadManager and useUploaderSession separately.

**Recommendation:** Create composite `useUploadFlow` hook in future that combines both with sensible defaults (reduces boilerplate in consuming apps):
```typescript
export function useUploadFlow(options: {
  route: string
  isAuthenticated?: boolean
  userId?: string
  concurrency?: number
}) {
  const session = useUploaderSession({
    route: options.route,
    isAuthenticated: options.isAuthenticated,
    userId: options.userId,
  })

  const manager = useUploadManager({
    concurrency: options.concurrency,
    onSessionExpired: session.refreshSession,
  })

  return { session, manager }
}
```

**Related Stories:** REPA-003

---

### Enhancement #2: Progress tracking enhancements - estimated time remaining
**Impact:** Low
**Effort:** Medium
**Category:** ux-polish
**Tags:** progress-tracking, ux

**Finding:**
useUploadManager tracks progress (0-100%) but doesn't estimate time remaining.

**Recommendation:** Add ETA calculation based on upload speed (improves user experience for large file uploads):
```typescript
// Track upload speed
const [uploadSpeed, setUploadSpeed] = useState(0) // bytes per second
const [estimatedTimeRemaining, setEstimatedTimeRemaining] = useState(0) // seconds

// Calculate ETA based on remaining bytes and current speed
const eta = remainingBytes / uploadSpeed
```

**Related Stories:** REPA-003

---

### Enhancement #3: Retry strategy enhancements - exponential backoff
**Impact:** Medium
**Effort:** Medium
**Category:** performance, reliability
**Tags:** retry-logic, network-resilience

**Finding:**
Current retry logic re-queues failed files immediately.

**Recommendation:** Add exponential backoff for transient errors (reduces server load, improves success rate for flaky networks):
```typescript
const retryDelays = [1000, 2000, 4000, 8000] // 1s, 2s, 4s, 8s
const delay = retryDelays[Math.min(retryCount, retryDelays.length - 1)]
setTimeout(() => retryUpload(fileId), delay)
```

**Related Stories:** REPA-003

---

### Enhancement #4: Session restoration UX - preview before restore
**Impact:** Low
**Effort:** Medium
**Category:** ux-polish
**Tags:** session-restoration, ux

**Finding:**
Session restoration shows toast notification but doesn't give user option to reject restoration.

**Recommendation:** Add modal preview of restored session with "Resume" or "Start Fresh" options (better UX for stale sessions):
```typescript
<Dialog open={hasRestoredSession}>
  <DialogTitle>Restore Previous Upload Session?</DialogTitle>
  <DialogContent>
    Found {session.files.length} files from {formatDate(session.createdAt)}
  </DialogContent>
  <DialogActions>
    <Button onClick={handleStartFresh}>Start Fresh</Button>
    <Button onClick={handleResume}>Resume Upload</Button>
  </DialogActions>
</Dialog>
```

**Related Stories:** REPA-003

---

### Enhancement #5: Upload concurrency optimization - adaptive concurrency
**Impact:** High
**Effort:** High
**Category:** performance
**Tags:** concurrency, network-optimization

**Finding:**
Current concurrency is fixed at 3.

**Recommendation:** Adaptive concurrency based on network conditions (e.g., reduce to 1 on slow networks, increase to 5 on fast networks). Requires network speed detection:
```typescript
// Detect network speed using Navigator.connection API
const connection = (navigator as any).connection
const effectiveType = connection?.effectiveType // '4g', '3g', '2g', 'slow-2g'

const concurrencyMap = {
  '4g': 5,
  '3g': 3,
  '2g': 2,
  'slow-2g': 1,
}

const adaptiveConcurrency = concurrencyMap[effectiveType] || 3
```

**Related Stories:** REPA-003

---

### Enhancement #6: File handle recovery - prompt user to re-select lost files
**Impact:** Medium
**Effort:** Medium
**Category:** ux-polish
**Tags:** error-recovery, ux

**Finding:**
Current implementation logs error when file handle is lost but doesn't prompt user to re-select.

**Recommendation:** Add UI callback (onFileNeedsReselect) that triggers file input dialog (better recovery UX):
```typescript
export interface UseUploadManagerOptions {
  // ... existing options
  onFileNeedsReselect?: (fileId: string, fileName: string) => void
}

// In component:
const handleFileNeedsReselect = (fileId: string, fileName: string) => {
  toast.error(`File "${fileName}" is no longer available. Please re-select to retry.`)
  fileInputRef.current?.click()
}
```

**Related Stories:** REPA-003

---

### Enhancement #7: Session key migration - automatic cleanup of old anon keys
**Impact:** Low
**Effort:** Low
**Category:** performance
**Tags:** localStorage-cleanup, memory-management

**Finding:**
Session migration removes old anon key but doesn't clean up orphaned anon keys from users who never logged in.

**Recommendation:** Background cleanup task to remove expired anon session keys (reduces localStorage bloat):
```typescript
// Run on app init
const cleanupExpiredAnonSessions = () => {
  const allKeys = Object.keys(localStorage)
  const anonKeys = allKeys.filter(key => key.startsWith('uploader:') && key.includes(':anon:'))

  anonKeys.forEach(key => {
    const session = JSON.parse(localStorage.getItem(key) || '{}')
    const age = Date.now() - new Date(session.createdAt).getTime()
    if (age > 24 * 60 * 60 * 1000) { // 24 hours
      localStorage.removeItem(key)
    }
  })
}
```

**Related Stories:** REPA-003

---

### Enhancement #8: TypeScript strict mode alignment - enable noImplicitAny
**Impact:** Low
**Effort:** Low
**Category:** code-quality
**Tags:** typescript, type-safety

**Finding:**
CLAUDE.md notes `noImplicitAny: false` is allowed but discouraged.

**Recommendation:** Refactor hooks to eliminate any types in future strict mode enhancement (improves type safety):
```typescript
// Before:
const handleError = (error: any) => { ... }

// After:
const handleError = (error: unknown) => {
  if (error instanceof Error) {
    // Type-safe error handling
  }
}
```

**Related Stories:** REPA-003

---

### Enhancement #9: Bundle size optimization - code splitting
**Impact:** Low
**Effort:** High
**Category:** performance
**Tags:** bundle-size, tree-shaking

**Finding:**
Hooks import full @repo/upload-types package.

**Recommendation:** Split package into smaller modules (e.g., @repo/upload/types/session, @repo/upload/types/upload) to enable tree-shaking (reduces bundle size for apps that don't use all features):
```typescript
// Instead of:
import { UploaderSession, UploadBatchState, FileCategory } from '@repo/upload-types'

// Enable:
import { UploaderSession } from '@repo/upload/types/session'
import { UploadBatchState } from '@repo/upload/types/batch'
import { FileCategory } from '@repo/upload/types/file'
```

**Related Stories:** REPA-003, REPA-006

---

### Enhancement #10: Developer experience - Storybook documentation
**Impact:** Medium
**Effort:** Medium
**Category:** developer-experience
**Tags:** documentation, storybook

**Finding:**
Consolidated hooks will be shared across 6+ apps.

**Recommendation:** Add Storybook stories demonstrating hook usage patterns (authenticated vs anonymous, session restoration, retry flows). Improves discoverability and reduces integration friction:
```typescript
// useUploadManager.stories.tsx
export const AuthenticatedUpload: Story = {
  args: {
    route: '/instructions/new',
    isAuthenticated: true,
    userId: 'user-123',
  },
}

export const AnonymousUpload: Story = {
  args: {
    route: '/upload',
    isAuthenticated: false,
  },
}

export const SessionRestoration: Story = {
  // ... demonstration of session restoration flow
}
```

**Related Stories:** REPA-003

---

## Summary by Category

### Edge Cases (3 findings)
- File handle tracking memory limits (Gap #9)
- Session migration E2E testing (Gap #10)
- File handle recovery UX (Enhancement #6)

### UX Polish (3 findings)
- Session restoration preview modal (Enhancement #4)
- Estimated time remaining (Enhancement #2)
- File re-selection prompt (Enhancement #6)

### Performance (4 findings)
- Debounce delay validation (Gap #8)
- Adaptive concurrency (Enhancement #5)
- Bundle size optimization (Enhancement #9)
- Retry with exponential backoff (Enhancement #3)

### Observability (2 findings)
- Upload analytics instrumentation (Gap #11)
- Performance benchmarks (Gap #8)

### Code Quality (4 findings)
- Zod schema migration (Gap #6)
- TypeScript strict mode (Enhancement #8)
- Type-only imports (Gap #5)
- useToast import standardization (Gap #4)

### Developer Experience (3 findings)
- Storybook documentation (Enhancement #10)
- Hook composability (Enhancement #1)
- Hook deprecation warnings (Gap #7)

---

## Priority Recommendations

### High Impact, Low Effort (Quick Wins)
1. Add deprecation warnings to old hooks (Gap #7) - 1 hour
2. Automatic cleanup of orphaned anon session keys (Enhancement #7) - 2 hours
3. Type-only import enforcement (Gap #5) - 1 hour

### High Impact, Medium Effort (Next Iteration)
1. E2E test for session migration (Gap #10) - 4 hours
2. Retry with exponential backoff (Enhancement #3) - 3 hours
3. Storybook documentation (Enhancement #10) - 6 hours

### High Impact, High Effort (Future Stories)
1. Composite `useUploadFlow` hook (Enhancement #1) - 8 hours
2. Adaptive concurrency (Enhancement #5) - 12 hours
3. Bundle size optimization (Enhancement #9) - 10 hours

### Defer to Post-MVP
- Upload analytics (Gap #11)
- Session restoration preview modal (Enhancement #4)
- File handle memory limits (Gap #9)
- Estimated time remaining (Enhancement #2)

---

## Action Items for Future Stories

1. **REPA-006 (Migrate Upload Types):**
   - Implement missing `migrateSession(oldKey, newKey)` utility for localStorage key migration
   - Consider bundle size optimization via code splitting

2. **Future Enhancement Story: Upload Flow Composability:**
   - Create composite `useUploadFlow` hook
   - Add Storybook documentation for all upload hooks
   - Add upload analytics instrumentation

3. **Future Enhancement Story: Upload Reliability:**
   - Implement adaptive concurrency based on network conditions
   - Add exponential backoff retry strategy
   - Add E2E test for session migration scenario

4. **Future Enhancement Story: Upload UX Polish:**
   - Session restoration preview modal
   - Estimated time remaining calculation
   - File re-selection prompt for lost handles

5. **Linting & Code Quality:**
   - Enable type-only imports enforcement
   - Migrate hook options to Zod schemas
   - Add performance benchmarks for localStorage operations
