---
id: REPA-0520
title: "Migrate SessionProvider to @repo/upload"
status: ready-to-work
split_from: REPA-005
split_part: 2 of 2
priority: P2
experiment_variant: control
epic: repackag-app
depends_on: [REPA-003, REPA-0510]
story_points: 3
created_at: "2026-02-11"
updated_at: "2026-02-11"
elaborated_at: "2026-02-11"
elaboration_completed_at: "2026-02-11"
---

# REPA-0520: Migrate SessionProvider to @repo/upload

## Split Context

This story is part of a split from REPA-005.
- **Original Story:** REPA-005 (Migrate Upload Components)
- **Split Reason:** Story exceeded multiple "too large" indicators (16 ACs, 9 components, 8 SP, REPA-003 blocking dependency). Audit Check #8 (Story Sizing) failed with High severity. SessionProvider was isolated due to its BLOCKING dependency on REPA-003 (useUploaderSession hook).
- **This Part:** 2 of 2 (Split 2)
- **Dependencies:**
  - REPA-003 (BLOCKING - useUploaderSession hook) - currently in-qa, must be completed before starting
  - REPA-0510 (completed - provides other upload components)
- **Sibling Story:** REPA-0510 (Core upload components, no REPA-003 dependency)

This split isolates SessionProvider migration, which has a BLOCKING dependency on REPA-003's useUploaderSession hook. This allows REPA-0510 to proceed immediately while waiting for REPA-003 completion.

---

## Context

The monorepo currently has **divergent SessionProvider implementations** split across `main-app` (89 lines) and `app-instructions-gallery` (82 lines):

### Current State

**SessionProvider in main-app (89 lines)**:
- Uses Redux for auth state (`useSelector` from `@reduxjs/toolkit`)
- Passes authenticated user ID to useUploaderSession hook
- Integrates with useUnsavedChangesPrompt for navigation protection

**SessionProvider in app-instructions-gallery (82 lines)**:
- No auth integration (anonymous upload mode)
- No Redux dependency
- Uses useUploaderSession in anonymous mode

Both implementations:
- Depend on useUploaderSession hook (REPA-003)
- Use useUnsavedChangesPrompt from @repo/hooks (REPA-014)
- Follow monorepo conventions (Zod types, accessibility-first design)

### Problems

1. **Divergent Implementations**: Redux vs non-Redux auth implementations have diverged
2. **Code Duplication**: Similar upload session logic maintained in two locations
3. **Fragile Auth Patterns**: Direct Redux imports violate package boundary rules

### Solution

Extract SessionProvider into `@repo/upload/components/SessionProvider/` with:
- Dependency injection pattern for auth state (no direct Redux imports)
- Support for both authenticated and anonymous modes
- Preserved test coverage for both modes
- Clear migration path for both apps

---

## Goal

SessionProvider consolidated in @repo/upload with:
- Single source of truth for upload session management
- No duplicate implementations in apps
- Dependency injection pattern for auth state
- Support for both authenticated (Redux) and anonymous modes
- Preserved test coverage for both auth scenarios
- main-app and app-instructions-gallery successfully migrated

---

## Non-Goals

- **Other upload components migration**: Already handled by REPA-0510
- **Upload hook migration**: useUploadManager and useUploaderSession already migrated in REPA-003 (dependency)
- **Upload types migration**: Deferred to REPA-006
- **Backend upload API changes**: No changes to presigned URLs or upload session endpoints
- **New component features**: Only consolidate existing functionality, no new features
- **Storybook documentation**: Deferred to follow-up work
- **Other apps adoption**: Only migrate main-app and app-instructions-gallery consumers in this story

---

## Scope

### Packages Modified

- `packages/core/upload/src/components/SessionProvider/` - Add SessionProvider component
- `packages/core/upload/src/components/index.ts` - Export SessionProvider (explicit export, NOT barrel file)
- `apps/web/main-app/` - Update imports, pass auth props to SessionProvider
- `apps/web/app-instructions-gallery/` - Update imports, anonymous SessionProvider mode

### Components Migrated

**Upload Session Component** (1):
- SessionProvider (with auth injection pattern)

### Endpoints Touched

None - This is a pure frontend component migration.

---

## Acceptance Criteria

### Session Provider (Special Handling)

- [ ] **AC-7**: Migrate SessionProvider to `@repo/upload/components/SessionProvider/`
  - **BLOCKING DEPENDENCY**: MUST verify REPA-003 completion before starting this AC
  - Use dependency injection for auth state:
    ```tsx
    type SessionProviderProps = {
      children: React.ReactNode
      isAuthenticated?: boolean  // Optional, for auth mode
      userId?: string            // Optional, for auth mode
    }
    ```
  - Do NOT import Redux directly
  - Support both authenticated and anonymous flows:
    - **Authenticated mode**: When `isAuthenticated={true}` and `userId` props are provided, pass userId to useUploaderSession
    - **Anonymous mode**: When no auth props provided, call useUploaderSession without userId
  - Combine with useUnsavedChangesPrompt from @repo/hooks
  - Update main-app to pass Redux auth state as props:
    ```tsx
    <SessionProvider isAuthenticated={user.isAuthenticated} userId={user.id}>
    ```
  - Update app-instructions-gallery to use anonymous mode (no auth props):
    ```tsx
    <SessionProvider>
    ```
  - Zod prop validation required
  - Unit tests for BOTH auth modes:
    - Test case 1: Authenticated with user ID (isAuthenticated=true, userId provided)
    - Test case 2: Anonymous without props (no auth props)
    - Test case 3: Auth state change (user logs in/out)
    - Test case 4: Expired session handling
  - Component directory structure: index.tsx, __tests__/, __types__/
  - Delete old SessionProvider directories from both apps after migration verified
  - Update tests to import from @repo/upload

---

## Reuse Plan

### UI Components (from @repo/app-component-library)

SessionProvider uses @repo/app-component-library primitives via barrel export:
```tsx
import { Dialog } from '@repo/app-component-library'
```

**Critical**: Do NOT import from individual paths like `@repo/app-component-library/primitives/dialog`.

### Hooks & Types (from @repo packages)

- **@repo/upload/hooks**: useUploaderSession (REPA-003 dependency - REQUIRED for this split)
- **@repo/hooks**: useUnsavedChangesPrompt (available from REPA-014)

### Patterns from Prior Stories

- **REPA-003 pattern**: Use dependency injection for auth state (not direct Redux imports)
- **REPA-004 pattern**: Migrate tests alongside components, maintain 80%+ coverage
- **REPA-0510 pattern**: Follow clear component structure with explicit exports

---

## Architecture Notes

### Component Directory Structure (REQUIRED)

SessionProvider MUST follow monorepo structure per CLAUDE.md:

```
SessionProvider/
  index.tsx              # Main component file (function declaration)
  __tests__/
    SessionProvider.test.tsx
  __types__/
    index.ts             # Zod schemas only (no TypeScript interfaces)
```

### Zod-First Types (REQUIRED)

SessionProvider props MUST be validated with Zod schemas per CLAUDE.md:

```tsx
import { z } from 'zod'

const SessionProviderPropsSchema = z.object({
  children: z.custom<React.ReactNode>(),
  isAuthenticated: z.boolean().optional(),
  userId: z.string().uuid().optional()
})

type SessionProviderProps = z.infer<typeof SessionProviderPropsSchema>

export function SessionProvider(props: SessionProviderProps) {
  const { isAuthenticated, userId } = props

  // Call useUploaderSession with or without userId based on auth state
  const session = useUploaderSession(isAuthenticated && userId ? { userId } : undefined)

  // implementation
}
```

**Do NOT use TypeScript interfaces** - violates CLAUDE.md requirements.

### SessionProvider Dependency Injection Pattern

SessionProvider has divergent implementations (Redux vs non-Redux). Solution: Accept auth state as props instead of importing Redux directly.

**Component API**:
```tsx
type SessionProviderProps = {
  children: React.ReactNode
  isAuthenticated?: boolean  // Optional, for auth mode
  userId?: string            // Optional, for auth mode
}
```

**App usage**:
- main-app: `<SessionProvider isAuthenticated={user.isAuthenticated} userId={user.id}>`
- app-instructions-gallery: `<SessionProvider>` (no props, anonymous mode)

### Package Boundary Rules

**@repo/upload package CANNOT import from**:
- ❌ `apps/web/main-app/*`
- ❌ `apps/web/app-instructions-gallery/*`
- ❌ `@reduxjs/toolkit` or `react-redux`
- ❌ App-specific API clients

**@repo/upload package CAN import from**:
- ✅ `@repo/app-component-library`
- ✅ `@repo/upload/hooks` (useUploaderSession from REPA-003)
- ✅ `@repo/hooks` (useUnsavedChangesPrompt from REPA-014)
- ✅ `react`, `react-dom`, `zod`

---

## Infrastructure Notes

### Package Publishing

- @repo/upload version bump (SessionProvider component added)
- No deprecated packages in this story

### Frontend Deployments

- main-app deploy (Vercel/Amplify) - Import path changes + auth prop injection
- app-instructions-gallery deploy (Vercel/Amplify) - Import path changes only

### No Backend Changes

This story does not touch backend APIs, presigned URLs, or upload session endpoints.

---

## HTTP Contract Plan

**N/A** - No backend endpoints modified in this story.

---

## Seed Requirements

### Implementation Prerequisites

Before starting migration:

1. **BLOCKING: Verify REPA-003 Completion**:
   - [ ] Check `plans/future/repackag-app/stories.index.md` for REPA-003 status
   - [ ] Status MUST be "completed" or "ready-for-qa" (merged to main)
   - [ ] Verify useUploaderSession hook is available in @repo/upload/hooks
   - [ ] If REPA-003 is not completed, BLOCK this story

2. **Verify REPA-0510 Completion**:
   - [ ] Check that core upload components migration is complete
   - [ ] Verify @repo/upload/components/index.ts exists with other component exports

3. **Verify Package Structure**: Ensure `packages/core/upload/src/components/` directory exists (from REPA-001)

### Protected Features (Do Not Modify)

From seed reality context:
- @repo/upload package structure (REPA-001) - Do not restructure
- Upload client functions (REPA-002) - Do not modify
- Upload hooks (REPA-003) - Do not modify (use as dependency)
- Other upload components (REPA-0510) - Do not modify

---

## Test Plan

### Scope Summary

- **Endpoints Touched**: None (frontend only)
- **UI Touched**: Yes (1 upload component)
- **Data/Storage Touched**: No (component uses existing hooks)

### Test Execution Order

1. **Phase 1**: Package tests in isolation
   - Migrate SessionProvider code to @repo/upload
   - Migrate tests to package
   - Test BOTH auth modes (with props, without props)
   - Run `pnpm test --filter=@repo/upload` until coverage target achieved

2. **Phase 2**: App integration tests
   - Update imports in main-app with auth prop injection
   - Run `pnpm test --filter=main-app` to catch regressions
   - Update imports in app-instructions-gallery (anonymous mode)
   - Run `pnpm test --filter=app-instructions-gallery` to catch regressions

3. **Phase 3**: E2E smoke tests
   - Run Playwright upload flows with authentication
   - Run Playwright upload flows without authentication
   - Verify session state persists across uploads

4. **Phase 4**: Full test suite
   - `pnpm test:all` (all changed files)
   - `pnpm check-types:all` (all changed files)
   - `pnpm lint:all` (all changed files)

### Key Test Cases

**Happy Paths**:
- SessionProvider provides context with auth (Redux) and without auth (anonymous)
- Authenticated mode: userId passed to useUploaderSession correctly
- Anonymous mode: useUploaderSession called without userId
- useUnsavedChangesPrompt integration works in both modes

**Error Cases**:
- SessionProvider handles useUploaderSession hook failure gracefully
- Invalid auth props (e.g., isAuthenticated=true but no userId) handled gracefully

**Edge Cases**:
- Auth state change mid-session (user logs out during upload)
- Session expired handling triggers correctly
- Multiple uploads in same session maintain state

### Blocking Conditions

Tests CANNOT proceed until:
1. ✅ REPA-003 (useUploaderSession hook) is completed and merged
2. ✅ REPA-0510 (core upload components) is completed
3. ✅ @repo/upload package structure exists (REPA-001, completed)

---

## UI/UX Notes

### Verdict

**PASS-WITH-NOTES**

This story is a pure consolidation/migration effort with NO new UI features. SessionProvider already exists in both apps. The migration should preserve existing behavior exactly as-is.

### MVP Accessibility (Blocking Only)

**No Direct UI (Provider Component)**:
- SessionProvider is a context provider with no rendered UI
- Accessibility handled by child components (UnsavedChangesDialog from REPA-0510)
- No additional accessibility requirements for this component

### MVP Design System Rules

**No Direct UI (Provider Component)**:
- SessionProvider has no rendered UI elements
- Design system rules enforced by child components

### Preservation Requirements

**DO**:
- Preserve all existing session management logic
- Preserve useUnsavedChangesPrompt integration
- Preserve auth mode behavior (Redux vs anonymous)
- Preserve all existing component props and APIs (backward compatibility)

**DO NOT**:
- Change session management behavior
- Add new features (out of scope)
- Remove existing functionality
- Simplify or "clean up" existing implementations (risk of regression)

---

## Risk Predictions

### Split Risk: 0.2 (Low)

**Interpretation**: 20% probability this story will need to be further split mid-implementation.

**Drivers**:
- Small scope (1 AC, 1 component)
- Clear dependency (REPA-003 completed before starting)
- Well-defined auth injection pattern

**Mitigation**:
- Wait for REPA-003 completion verification before starting
- Test both auth modes thoroughly

### Review Cycles: 1 (Low)

**Interpretation**: Expect 1 code review iteration before merge.

**Drivers**:
- Small file count (estimated 5-8 files touched)
- Single component scope
- Clear auth injection pattern

**Mitigation**:
- Document auth injection pattern clearly in PR description
- Include test cases for both auth modes in PR

### Token Estimate: 35,000

**Interpretation**: Expected total token cost for full implementation and review cycles.

**Confidence**: Medium (smaller scope, clearer pattern)

**Mitigation**:
- Track token usage in _implementation/TOKENS.md
- Compare actual vs estimate for future story calibration

---

## Dev Feasibility Notes

### Feasibility Summary

**Feasible for MVP**: Yes

**Confidence**: High

**Key Risks**:
1. **REPA-003 Not Complete**: SessionProvider blocked until useUploaderSession hook available
2. **Auth Injection Pattern Fragility**: SessionProvider must work for both Redux (main-app) and anonymous (app-instructions-gallery) modes

### Mitigation Strategies

1. **BLOCKING**: Verify REPA-003 completion BEFORE starting AC-7
2. Unit test SessionProvider in BOTH auth modes (with props, without props)
3. Include integration tests in both apps to verify auth prop injection

---

## Dependencies

**BLOCKING**:
- REPA-003 (useUploaderSession hook) MUST be completed before starting this story
- REPA-0510 (core upload components) should be completed

**NON-BLOCKING**:
- REPA-001 (package structure) - already completed
- REPA-002 (upload client) - already completed
- REPA-014 (useUnsavedChangesPrompt hook) - already completed

---

## Story Points Estimate

**3 SP** (Small-Medium)

**Justification**:
- 1 component to migrate
- 1 AC
- Auth injection pattern adds complexity
- Both apps need prop updates
- Low split risk (0.2)
- Single review cycle expected

---

## Experiment Variant

**control** (no active experiments)

This story was assigned to the control group because no active experiments were found in `.claude/config/experiments.yaml` at the time of story generation (2026-02-11).

---

## Completion Checklist

Before marking this story as complete:

- [ ] REPA-003 verified as completed (useUploaderSession hook available)
- [ ] REPA-0510 verified as completed (core upload components available)
- [ ] AC-7 verified and checked off
- [ ] Package builds in isolation: `pnpm build --filter=@repo/upload`
- [ ] Package tests pass: `pnpm test --filter=@repo/upload`
- [ ] SessionProvider tests cover BOTH auth modes (authenticated + anonymous)
- [ ] All app tests pass: `pnpm test:all`
- [ ] All TypeScript checks pass: `pnpm check-types:all`
- [ ] All ESLint checks pass: `pnpm lint:all`
- [ ] Playwright E2E tests pass for both auth scenarios
- [ ] No imports from old SessionProvider paths remain in main-app
- [ ] No imports from old SessionProvider paths remain in app-instructions-gallery
- [ ] Old SessionProvider directories deleted from both apps
- [ ] SessionProvider works in both auth modes (manual verification)
- [ ] No console errors in apps after migration (manual verification)

---

**Generated**: 2026-02-11
**Split From**: REPA-005
**Split Part**: 2 of 2

---

## QA Discovery Notes (Auto-Generated)

_Added by Autonomous Elaboration on 2026-02-11_

### MVP Gaps Resolved

No MVP-critical gaps identified. Story fully defines the SessionProvider migration with clear dependency injection pattern, both authenticated and anonymous mode support, and comprehensive test coverage requirements.

### Non-Blocking Items (Logged to KB)

| # | Finding | Category | Status |
|---|---------|----------|--------|
| 1 | TypeScript type exports for SessionProvider props | developer-experience | KB-logged |
| 2 | Invalid auth prop combinations validation (isAuthenticated=true but no userId) | validation | KB-logged |
| 3 | Logging for auth state changes (user logs in/out mid-session) | observability | KB-logged |
| 4 | Storybook documentation deferred | documentation | KB-logged |
| 5 | Session recovery UI polish (loading, error states) | ux-polish | KB-logged |
| 6 | Multi-route session coordination | edge-case | KB-logged |
| 7 | Session analytics tracking | observability | KB-logged |
| 8 | Session persistence configuration flexibility | enhancement | KB-logged |

### Implementation Guidance Notes

- **Import path consistency**: Use local imports for component dependencies. Story examples are illustrative; follow Architecture Notes section.
- **Zod-first types**: Story correctly documents Zod approach in Architecture Notes (lines 196-219). Follow that pattern for all prop schemas.

### Summary

- **ACs added**: 0
- **KB entries created**: 8
- **Implementation notes**: 2
- **Mode**: autonomous
- **Verdict**: PASS
