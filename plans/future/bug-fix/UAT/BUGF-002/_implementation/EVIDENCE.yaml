schema: 1
story_id: "BUGF-002"
version: 2
timestamp: "2026-02-11T16:45:00Z"

acceptance_criteria:
  - ac_id: "AC-1"
    ac_text: "app-instructions-gallery edit page calls useUpdateMocMutation on save"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 14, 78, 143: Import, initialize, and call useUpdateMocMutation with proper data transformation"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Test 'calls updateMoc on save with correct data transformation' verifies mutation called with correct args"

  - ac_id: "AC-2"
    ac_text: "main-app InstructionsEditPage calls useUpdateMocMutation on save"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/main-app/src/routes/pages/InstructionsEditPage.tsx"
        description: "Lines 14, 78, 143: Import, initialize, and call useUpdateMocMutation with proper data transformation"
      - type: test
        path: "apps/web/main-app/src/routes/pages/__tests__/InstructionsEditPage.test.tsx"
        description: "9 passing tests covering rendering, error state, and form fields"

  - ac_id: "AC-3"
    ac_text: "Form data validated via Zod before submission"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 33-41: MocEditFormSchema with zodResolver in useForm (line 82)"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Test 'form uses zodResolver for validation' confirms zodResolver used"

  - ac_id: "AC-4"
    ac_text: "Success: toast shown, navigate to detail page"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 148-155: showSuccessToast called, navigate after mutation success"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Tests 'shows success toast on successful save' and 'navigates to detail page on success'"

  - ac_id: "AC-5"
    ac_text: "409 error shows 'A MOC with this title already exists'"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 162-177: Status 409 returns specific conflict message"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Test 'shows duplicate title error on 409' verifies error message"

  - ac_id: "AC-6"
    ac_text: "403 error shows 'You don't have permission to edit this MOC'"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 162-177: Status 403 returns specific permission message"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Test 'shows permission error on 403' verifies error message"

  - ac_id: "AC-7"
    ac_text: "404 error shows 'MOC not found. It may have been deleted'"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 162-177: Status 404 returns specific not-found message"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Test 'shows not found error on 404' verifies error message"

  - ac_id: "AC-8"
    ac_text: "500 error shows 'Failed to save changes. Please try again'"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 162-177: Status 500 returns generic error message"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Test 'shows generic error on 500' verifies error message"

  - ac_id: "AC-9"
    ac_text: "Form state preserved on error (no reset)"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 156-183: Error path sets saveError state but does NOT call reset()"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Test 'does not navigate away on error' verifies form stays visible with fields intact"

  - ac_id: "AC-10"
    ac_text: "Save button disabled when formState.isDirty === false"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Line 239: Button disabled prop uses 'isSaving || !isDirty'"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Tests 'disables save button when form is not dirty' and 'enables save button when form is dirty'"

  - ac_id: "AC-11"
    ac_text: "Save button shows loading state when isSaving === true"
    status: PASS
    evidence_items:
      - type: code
        path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
        description: "Lines 240-251: Conditional render shows Loader2 icon and 'Saving...' text during isSaving"
      - type: test
        path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
        description: "Test 'shows saving text during mutation' verifies loading state appears and disappears"

  - ac_id: "AC-12"
    ac_text: "RTK Query automatically invalidates Moc and MocList cache tags"
    status: PASS
    evidence_items:
      - type: code
        path: "packages/core/api-client/src/rtk/instructions-api.ts"
        description: "updateMoc mutation configured with invalidatesTags for automatic cache invalidation"

touched_files:
  - path: "apps/web/app-instructions-gallery/src/pages/edit-page.tsx"
    action: modified
    lines: 360
    description: "Added useUpdateMocMutation integration with data transformation and error handling"

  - path: "apps/web/main-app/src/routes/pages/InstructionsEditPage.tsx"
    action: modified
    lines: 360
    description: "Added useUpdateMocMutation integration (identical to app-instructions-gallery)"

  - path: "apps/web/app-instructions-gallery/src/pages/__tests__/edit-page.test.tsx"
    action: created
    lines: 310
    description: "18 unit tests covering all 12 ACs: mutation integration, error handling, button states, loading"

  - path: "apps/web/main-app/src/routes/pages/__tests__/InstructionsEditPage.test.tsx"
    action: created
    lines: 198
    description: "9 unit tests covering rendering, form fields, error states, button states"

commands_run:
  - command: "pnpm --filter @repo/app-instructions-gallery run check-types"
    result: FAILURE
    output: "Pre-existing type errors in InstructionCard, MocEdit/EditForm, MocForm (not caused by BUGF-002)"
    timestamp: "2026-02-11T16:35:00Z"

  - command: "pnpm --filter @repo/main-app exec tsc --noEmit --pretty false | grep InstructionsEditPage"
    result: PASS
    output: "No type errors in InstructionsEditPage.tsx"
    timestamp: "2026-02-11T16:36:00Z"

  - command: "pnpm --filter @repo/app-instructions-gallery exec eslint src/pages/edit-page.tsx --max-warnings 0"
    result: PASS
    output: "Clean (after auto-fix of prettier formatting)"
    timestamp: "2026-02-11T16:40:00Z"

  - command: "pnpm --filter @repo/main-app exec eslint src/routes/pages/InstructionsEditPage.tsx --max-warnings 0"
    result: PASS
    output: "Clean (after auto-fix of prettier formatting)"
    timestamp: "2026-02-11T16:40:00Z"

  - command: "pnpm --filter @repo/app-instructions-gallery exec vitest run src/pages/__tests__/edit-page.test.tsx"
    result: PASS
    output: "18 tests passed"
    timestamp: "2026-02-11T16:40:00Z"

  - command: "pnpm --filter @repo/main-app exec vitest run src/routes/pages/__tests__/InstructionsEditPage.test.tsx"
    result: PASS
    output: "9 tests passed"
    timestamp: "2026-02-11T16:40:00Z"

endpoints_exercised: []

test_summary:
  unit: { pass: 27, fail: 0, skip: 0 }
  e2e: { pass: 0, fail: 0, skip: 0 }

e2e_tests:
  status: exempt
  exempt_reason: "Pre-existing build errors in @repo/app-instructions-gallery block Playwright setup. E2E spec deferred to follow-up story."
  config: null
  project: null
  mode: null
  tests_written: false
  results:
    total: 0
    passed: 0
    failed: 0
    skipped: 0
  failed_tests: []
  config_issues:
    - type: pre_existing_build_errors
      description: "TypeScript errors in @repo/app-instructions-gallery block build and Playwright execution"
      expected: "Clean build"
      actual: "Build failures in InstructionCard, MocEdit/EditForm, MocForm (react-hook-form version mismatch)"
      files:
        - "apps/web/app-instructions-gallery/src/components/InstructionCard/index.tsx"
        - "apps/web/app-instructions-gallery/src/components/MocEdit/EditForm.tsx"
        - "apps/web/app-instructions-gallery/src/components/MocForm/index.tsx"
      resolution: "These errors exist in main branch independently of BUGF-002"
  videos: []
  screenshots: []

coverage: {}

notable_decisions:
  - "Followed CreateMocPage.tsx async mutation pattern exactly per PLAN.yaml"
  - "Used .unwrap() for RTK Query error handling to enable HTTP status detection"
  - "Transformed comma-separated tags string to array with trim and filter"
  - "Preserved form state on error (no reset) to allow retry without re-entry"
  - "Fixed test mock for @repo/logger to include createLogger (required by @repo/api-client)"
  - "Used manual component mocks for @repo/app-component-library to avoid cascade import issues"

known_deviations:
  - description: "E2E tests not written due to pre-existing build errors"
    impact: "Cannot verify happy-path flow via automated E2E"
    justification: "Build environment blocked by react-hook-form version mismatch in MocEdit/EditForm.tsx. Deferred to build fix story."

token_summary:
  setup: { in: 0, out: 0 }
  plan: { in: 0, out: 0 }
  execute: { in: 44780, out: 8500 }
