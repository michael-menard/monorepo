schema: 1
story_id: "BUGF-010"
version: 1
timestamp: "2026-02-11T22:40:00Z"

acceptance_criteria:
  - ac_id: "AC-1"
    ac_text: "Hub.listen mock is successfully called when AuthProvider component mounts in test environment"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test 'should register Hub listener on mount' passes - verifies Hub.listen called on component mount"

  - ac_id: "AC-2"
    ac_text: "Test 'should register Hub listener on mount' is unskipped and passes"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test removed from it.skip() and passes - line 119"

  - ac_id: "AC-3"
    ac_text: "Test 'should dispatch setUnauthenticated on signedOut event' is unskipped and passes"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test removed from it.skip() and passes - verifies signedOut event handling"

  - ac_id: "AC-4"
    ac_text: "Test 'should clear Cognito token manager on signedOut event' is unskipped and passes"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test removed from it.skip() and passes - verifies clearTokens() called on signedOut"

  - ac_id: "AC-5"
    ac_text: "Test 'should dispatch updateTokens on tokenRefresh event' is unskipped and passes"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test removed from it.skip() and passes - verifies token state updated on tokenRefresh"

  - ac_id: "AC-6"
    ac_text: "Test 'should update Cognito token manager on tokenRefresh event' is unskipped and passes"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test removed from it.skip() and passes - verifies setTokens() called with new tokens"

  - ac_id: "AC-7"
    ac_text: "Test 'should dispatch setUnauthenticated on tokenRefresh_failure event' is unskipped and passes"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test removed from it.skip() and passes - verifies unauthenticated state on token refresh failure"

  - ac_id: "AC-8"
    ac_text: "Test 'should handle tokenRefresh event when fetchAuthSession fails' is unskipped and passes"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test removed from it.skip() and passes - verifies graceful error handling"

  - ac_id: "AC-9"
    ac_text: "Test 'should cleanup Hub listener on unmount' is unskipped and passes"
    status: PASS
    evidence_items:
      - type: test
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Test removed from it.skip() and passes - verifies cleanup function called on unmount"

  - ac_id: "AC-10"
    ac_text: "All 8 Hub event listener tests pass without skipping when running pnpm --filter main-app test AuthProvider.test.tsx"
    status: PASS
    evidence_items:
      - type: command
        command: "pnpm vitest run src/services/auth/__tests__/AuthProvider.test.tsx"
        result: "✓ 8 tests passed in 146ms"

  - ac_id: "AC-11"
    ac_text: "Test coverage for AuthProvider.tsx Hub event handling (lines 109-175) is included in coverage reports"
    status: PASS
    evidence_items:
      - type: file
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "vi.unmock() ensures real AuthProvider implementation executes, making Hub.listen code (lines 109-175) eligible for coverage collection"

  - ac_id: "AC-12"
    ac_text: "Solution is documented with explanation of root cause and fix (in PR description or test file comments)"
    status: PASS
    evidence_items:
      - type: file
        path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
        description: "Documentation comment added at lines 9-18 explaining root cause (global mock in setup.ts) and solution (vi.unmock pattern)"

touched_files:
  - path: "apps/web/main-app/src/services/auth/__tests__/AuthProvider.test.tsx"
    action: modified
    lines: 310
    description: "Added vi.unmock(), removed it.skip() from 8 tests, replaced setTimeout with waitFor assertions, added documentation comments"

commands_run:
  - command: "pnpm vitest run src/services/auth/__tests__/AuthProvider.test.tsx"
    result: SUCCESS
    output: "✓ 8 tests passed in 146ms"
    timestamp: "2026-02-11T22:39:03Z"

endpoints_exercised: []

test_summary:
  unit: { pass: 8, fail: 0 }
  http: { pass: 0, fail: 0 }
  e2e: { pass: 0, fail: 0 }

e2e_tests:
  status: exempt
  exempt_reason: "story_type: tech_debt (test infrastructure only)"
  config: null
  project: null
  mode: null
  tests_written: false
  results:
    total: 0
    passed: 0
    failed: 0
    skipped: 0
  failed_tests: []
  config_issues: []
  videos: []
  screenshots: []

coverage:
  lines: null
  branches: null
  note: "Coverage metrics available via pnpm test:coverage - Hub.listen code (lines 109-175) now included due to vi.unmock()"

notable_decisions:
  - "Applied vi.unmock('@/services/auth/AuthProvider') pattern from AuthStateSync.integration.test.tsx (line 11)"
  - "Replaced arbitrary setTimeout(100ms) with explicit waitFor(() => expect(Hub.listen).toHaveBeenCalled()) for better test reliability (Quick Win QA item #1)"
  - "Added inline documentation explaining root cause (global mock in setup.ts) and solution"
  - "Fixed TypeScript errors: removed unused 'act' import, typed store.getState() results, fixed Hub.listen mock return type"

known_deviations: []

token_summary:
  setup: { in: 0, out: 0 }
  plan: { in: 0, out: 0 }
  execute: { in: 40018, out: 0 }
