---
generated_at: "2026-02-11T00:00:00Z"
reason: "KB write deferred - no MCP connection available during story generation"
retry_status: pending
---

# Deferred KB Writes for BUGF-012

## Story Entry

```sql
INSERT INTO stories (
  story_id,
  feature,
  title,
  story_dir,
  story_file,
  story_type,
  points,
  priority,
  state,
  touches_backend,
  touches_frontend,
  touches_database,
  touches_infra
) VALUES (
  'BUGF-012',
  'bug-fix',
  'Add Test Coverage for Inspiration Gallery Components',
  'plans/future/bug-fix/backlog/BUGF-012',
  'plans/future/bug-fix/backlog/BUGF-012/BUGF-012.md',
  'tech_debt',
  5,
  'medium',
  'backlog',
  false,
  true,
  false,
  false
)
ON CONFLICT (story_id) DO UPDATE SET
  title = EXCLUDED.title,
  story_dir = EXCLUDED.story_dir,
  story_file = EXCLUDED.story_file,
  story_type = EXCLUDED.story_type,
  points = EXCLUDED.points,
  priority = EXCLUDED.priority,
  state = EXCLUDED.state,
  touches_backend = EXCLUDED.touches_backend,
  touches_frontend = EXCLUDED.touches_frontend,
  touches_database = EXCLUDED.touches_database,
  touches_infra = EXCLUDED.touches_infra,
  updated_at = CURRENT_TIMESTAMP;
```

## Retry Instructions

Run the following to retry KB persistence:

```bash
/kb-retry plans/future/bug-fix/backlog/BUGF-012
```

Or manually execute the SQL above against the postgres-knowledgebase MCP server.

---

# Additional Deferred KB Entries from Autonomous Elaboration
# Generated by elab-autonomous-decider during BUGF-012 elaboration

## Future Opportunities & Edge Cases

### High Priority Enhancements

#### 1. Reusable Modal Test Helper
**Category**: test-enhancement
**Impact**: High | **Effort**: Low
**Tags**: test-infrastructure, code-quality, inspiration-gallery, reuse

Create reusable modal test helper function to reduce duplication across 7 modal test files.

**Context**: BUGF-012 tests 7 modal components with similar patterns (open/close, validation, focus management, ARIA). Helper function would reduce ~200 lines of duplicate code per modal.

**Recommendation**: Create after 2-3 modals tested to identify common pattern.

**Status**: Already mentioned in AC-8 as optional enhancement - implementer has discretion.

---

#### 2. Coverage Threshold Enforcement
**Category**: quality-gate
**Impact**: High | **Effort**: Low
**Tags**: test-infrastructure, quality-gate, coverage, ci-cd

Add coverage thresholds to vitest.config.ts (70% line, 65% branch) to prevent regression.

**Context**: Without enforcement, future changes could reduce coverage without detection.

**Timing**: MUST be enabled AFTER tests written to establish baseline, not before.

**Status**: Already mentioned in story Infrastructure Notes.

---

#### 3. Automated Accessibility Audits with axe-core
**Category**: accessibility
**Impact**: High | **Effort**: Low
**Tags**: accessibility, test-enhancement, automation, a11y

Integrate @axe-core/react for automated accessibility scans beyond manual ARIA/keyboard tests.

**Context**: Catches color contrast, heading hierarchy, form labels, invalid ARIA, duplicate IDs.

**Limitation**: axe-core doesn't catch all a11y issues - keyboard nav and focus management still need manual tests.

---

### Medium Priority Enhancements

#### 4. Reusable Keyboard Navigation Test Helper
**Category**: test-enhancement
**Impact**: Medium | **Effort**: Low
**Tags**: test-infrastructure, keyboard-navigation, a11y

Create helper for testing keyboard shortcuts (8 in main-page) and context menu navigation (arrow keys, Enter, Escape).

**Status**: Already mentioned in AC-8 as optional.

---

#### 5. Test Data Factory Functions
**Category**: test-data
**Impact**: Medium | **Effort**: Medium
**Tags**: test-infrastructure, test-data, code-quality

Create `createMockInspiration()` and `createMockAlbum()` factory functions to reduce boilerplate.

**When**: Only if mock data becomes complex (>5 fields per object).

**Status**: Already mentioned in AC-8 and Architecture Notes as optional.

---

#### 6. RTK Query Cache Invalidation Tests
**Category**: api-testing
**Impact**: Medium | **Effort**: Medium
**Tags**: rtk-query, cache, api-testing, data-integrity

Add explicit tests verifying cache invalidation after DELETE/UPDATE mutations. Prevents stale data bugs.

**Context**: AC-6 mentions cache invalidation but doesn't specify explicit tests.

---

#### 7. Test Undo/Redo Flow in DraggableInspirationGallery
**Category**: drag-drop-testing
**Impact**: Medium | **Effort**: Medium
**Tags**: drag-drop, undo-redo, user-experience, regression

Test undo/redo functionality that exists in DraggableInspirationGallery (644 lines, includes rollback logic).

**Context**: Codebase analysis confirmed undo feature exists but AC-3 doesn't explicitly test it.

---

#### 8. End-to-End User Journey Test
**Category**: test-strategy
**Impact**: High | **Effort**: High
**Tags**: integration-testing, user-journey, regression

Add comprehensive journey test: Upload → Edit → Add to Album → Drag Sort → Delete in single test.

**Context**: AC-1 tests individual features but not complete workflow end-to-end.

**Benefit**: Catches integration issues, regression protection.

---

### Edge Cases (Non-Blocking)

#### 9. Drag Operation Interrupted by Network Error
**Impact**: Low | **Effort**: Medium
**Tags**: edge-case, error-handling, drag-drop, network

Test rollback to original order when API call to save drag order fails.

**Context**: AC-3 tests success path only. Rollback logic exists but not tested.

---

#### 10. Presigned URL Expiry in UploadModal
**Impact**: Low | **Effort**: Medium
**Tags**: edge-case, upload, presigned-url, BUGF-032

Test presigned URL expiry handling during upload flow.

**Timing**: Wait for BUGF-032 completion (in-progress).

**Related**: BUGF-032 (Frontend integration for presigned URL upload)

---

#### 11. Multi-Select + Drag Interaction
**Impact**: Low | **Effort**: Medium
**Tags**: edge-case, multi-select, drag-drop, interaction

Test behavior when dragging while items are selected in multi-select mode.

**Context**: AC-1 tests multi-select, AC-3 tests drag, but not combined. Interaction behavior unclear.

---

#### 12. Screen Reader Announcements During Drag
**Impact**: Medium | **Effort**: Medium
**Tags**: accessibility, screen-reader, drag-drop, a11y

Verify useAnnouncer calls for screen reader feedback during drag operations.

**Context**: DraggableInspirationGallery uses @repo/accessibility/useAnnouncer (verified) but AC-3 doesn't test announcements.

**Category**: A11y polish, not MVP-blocking.

---

#### 13. Keyboard Shortcuts Conflicting with Browser Shortcuts
**Impact**: Low | **Effort**: High
**Tags**: edge-case, keyboard-shortcuts, browser-compatibility, e2e

Verify preventDefault is called to avoid browser dialogs (Cmd+N = New Tab, Cmd+U = View Source).

**Limitation**: Unit test can verify preventDefault called, but actual browser behavior needs E2E test.

---

### Additional Opportunities

#### 14. Research @dnd-kit Official Testing Utilities
**Impact**: Medium | **Effort**: High
**Tags**: research, drag-drop, test-infrastructure, dnd-kit

Investigate if @dnd-kit provides official test utilities instead of manual mocking.

**Timing**: During AC-3 implementation.

**Status**: Already noted in story Infrastructure Notes.

---

#### 15. MSW Handler Edge Cases (HTTP Error Codes)
**Impact**: Low | **Effort**: Medium
**Tags**: error-handling, msw, http-errors, api-testing

Add tests for 403 Forbidden, 404 Not Found, 500 Server Error, network timeout scenarios.

**Context**: AC-1 mentions "error states" but may not cover all HTTP codes.

---

#### 16. Multi-Select Limits (useMultiSelect Hook)
**Impact**: Low | **Effort**: Low
**Tags**: edge-case, multi-select, hooks, limits

Test maxSelection parameter in useMultiSelect hook (if it exists).

**Context**: AC-1 tests basic multi-select but not limits.

---

#### 17. Tag Input Interactions in Modals
**Impact**: Low | **Effort**: Medium
**Tags**: form-validation, tags, modals, user-input

Test tag add/remove interactions in EditInspirationModal, CreateAlbumModal, UploadModal.

**Context**: AC-2 tests form validation but may not test tag-specific behavior.

---

#### 18. Test @repo/gallery Package Separately
**Impact**: Medium | **Effort**: High
**Tags**: test-coverage, shared-packages, package-testing, gallery

Create separate story for @repo/gallery package unit tests (GalleryCard, GalleryFilterBar, hooks).

**Rationale**: Package is shared across multiple apps (inspiration, wishlist, sets). Isolate package bugs from app-level integration issues.

**Related**: Similar pattern needed for @repo/hooks, @repo/accessibility.

---

## Summary of Deferred Entries

Total: 18 findings
- High Priority: 3 (modal helper, coverage thresholds, axe-core)
- Medium Priority: 5 (keyboard helper, factories, cache tests, undo/redo, journey test)
- Low Priority: 10 (edge cases, research tasks, future stories)

All findings are non-blocking for MVP. Story is ready to move to ready-to-work.
