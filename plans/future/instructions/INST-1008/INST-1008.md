---
story_id: INST-1008
title: Wire RTK Query Mutations for MOC Instructions API
status: ready-to-work
created: 2026-02-05
updated: 2026-02-05
epic: Instructions
phase: 0-Infrastructure
size: small
effort_hours: 6
complexity: low
risk_level: low
blocked_by: []
blocks: [INST-1100, INST-1102, INST-1103, INST-1104, INST-1106, INST-1108, INST-1109, INST-1110]
---

# INST-1008: Wire RTK Query Mutations for MOC Instructions API

## Context

The Instructions feature has a complete backend API (`apps/api/lego-api/domains/instructions/routes.ts`) with full CRUD operations for MOCs and file management. The frontend API client (`packages/core/api-client/src/rtk/instructions-api.ts`) exists but only includes GET queries:
- ✅ `useGetInstructionsQuery` - GET /api/v2/mocs (list)
- ✅ `useGetInstructionByIdQuery` - GET /api/v2/mocs/:id
- ✅ `useToggleInstructionFavoriteMutation` - PATCH /api/v2/mocs/:id (favorite only)

**Problem**: Vertical slice stories in Phase 1 (INST-1100+) require mutation hooks to create, update, and delete MOCs and files. These mutations must be wired before the UI stories can begin.

Frontend lacks RTK Query mutation hooks for:
- Creating MOCs (`POST /mocs`)
- Updating MOC metadata (`PATCH /mocs/:id`)
- Deleting MOCs (`DELETE /mocs/:id`)
- Uploading files (`POST /mocs/:id/files`)
- Deleting files (`DELETE /mocs/:id/files/:fileId`)

Without these hooks, frontend components cannot mutate data or invalidate caches properly.

**Reality Baseline**:
- Backend API: ✅ Complete (all CRUD and file endpoints exist)
- Frontend API client: ⚠️ Partial (only GET queries exist)
- Established patterns: ✅ `wishlist-gallery-api.ts` has mutation patterns to reuse
- Active work: INST-1003 (Upload Types), INST-1004 (Upload Config) - no overlap

**From Knowledge Base** (ADR-001, ADR-006):
- Frontend expects paths like `/api/v2/mocs`, backend provides `/mocs` → Vite proxy rewrites
- Infrastructure stories exempt from E2E tests (consuming stories will test E2E)
- Optimistic updates improve UX (pattern from Wishlist feature)

---

## Goal

Add RTK Query mutation endpoints to `instructions-api.ts` with:
1. Zod schema validation for request/response bodies
2. Cache invalidation tags to refresh queries after mutations
3. Optimistic updates where appropriate (create, update, delete)
4. Error handling and rollback on failure
5. Consistent patterns from `wishlist-gallery-api.ts`

This is infrastructure work that enables all vertical slice stories in Phase 1.

---

## Non-Goals

- ❌ **UI Components**: This story does NOT create any React components (handled by INST-1100+)
- ❌ **Backend Routes**: Backend API already exists, no changes needed
- ❌ **Presigned Upload Flow**: Direct upload only (presigned handled by INST-1105)
- ❌ **Multipart Upload Sessions**: Session-based uploads handled by INST-1105
- ❌ **E2E Tests**: Infrastructure story, no user-facing UI to test (consuming stories will test E2E per ADR-006)
- ❌ **Database Schema**: No schema changes (tables already exist)
- ❌ **File Storage Logic**: Backend already handles S3 upload/delete

**Protected Features** (from seed):
- Backend routes in `apps/api/lego-api/domains/instructions/routes.ts`
- Backend types in `apps/api/lego-api/domains/instructions/types.ts`
- Existing query hooks (`useGetInstructionsQuery`, `useGetInstructionByIdQuery`)

---

## Scope

### Frontend Changes

**File**: `packages/core/api-client/src/rtk/instructions-api.ts`

**Updates**:
1. Update `tagTypes` to `['Moc', 'MocList', 'MocFile']` (from `['Instruction', 'InstructionList']`)
2. Update existing `getInstructions` query to use `MocList` tag
3. Update existing `getInstructionById` query to use `{ type: 'Moc', id }` tag
4. Add mutation endpoints:
   - `useCreateMocMutation` - POST /api/v2/mocs
   - `useUpdateMocMutation` - PATCH /api/v2/mocs/:id
   - `useDeleteMocMutation` - DELETE /api/v2/mocs/:id
   - `useUploadFileMutation` - POST /api/v2/mocs/:id/files
   - `useDeleteFileMutation` - DELETE /api/v2/mocs/:id/files/:fileId
5. Export all new hooks

**File**: `packages/core/api-client/src/schemas/instructions.ts` (create if missing)

**Updates**:
1. Add Zod schemas:
   - `MocInstructionsSchema` (for MOC entities)
   - `MocFileSchema` (for file entities)
   - `CreateMocInputSchema` (for POST /mocs)
   - `UpdateMocInputSchema` (for PATCH /mocs/:id)
2. Export from `schemas/index.ts`

### Testing

**Unit Tests**: `packages/core/api-client/src/rtk/__tests__/instructions-api.test.ts`
- Mutation configs generate correct URLs and methods
- Cache tags correctly defined
- Zod schemas validate responses
- Optimistic updates patch cache before API call
- Rollback on error restores original cache state

**Integration Tests**: `packages/core/api-client/src/rtk/__tests__/instructions-api.integration.test.ts`
- MSW handlers return mock responses
- Mutations invalidate cache and trigger query refetch
- Optimistic updates reflected in UI state
- Error responses handled gracefully

**E2E Tests**: N/A (infrastructure story per ADR-006)

---

## Acceptance Criteria

- [ ] **AC-1**: Add `useCreateMocMutation` hook
  - Query: `POST /api/v2/mocs`
  - Request validation: `CreateMocInputSchema` from schemas
  - Response validation: `MocInstructionsSchema`
  - Cache invalidation: `[{ type: 'MocList', id: 'LIST' }]`
  - Optimistic update: Add temp MOC to list cache before API response
  - Export hook from `instructions-api.ts`

- [ ] **AC-2**: Add `useUpdateMocMutation` hook
  - Query: `PATCH /api/v2/mocs/:id`
  - Request validation: `UpdateMocInputSchema`
  - Response validation: `MocInstructionsSchema`
  - Cache invalidation: `[{ type: 'Moc', id }, { type: 'MocList', id: 'LIST' }]`
  - Optimistic update: Update MOC in cache before API response
  - Export hook from `instructions-api.ts`

- [ ] **AC-3**: Add `useDeleteMocMutation` hook
  - Query: `DELETE /api/v2/mocs/:id`
  - Response: `void` (204 No Content)
  - Cache invalidation: `[{ type: 'Moc', id }, { type: 'MocList', id: 'LIST' }]`
  - Optimistic update: Remove MOC from list cache before API response
  - Export hook from `instructions-api.ts`

- [ ] **AC-4**: Add `useUploadFileMutation` hook
  - Query: `POST /api/v2/mocs/:id/files` (multipart/form-data)
  - Request: `{ mocId: string, file: File, fileType: string }` via FormData
  - Response validation: `MocFileSchema`
  - Cache invalidation: `[{ type: 'Moc', id: mocId }, { type: 'MocFile', id: mocId }]`
  - Export hook from `instructions-api.ts`

- [ ] **AC-5**: Add `useDeleteFileMutation` hook
  - Query: `DELETE /api/v2/mocs/:id/files/:fileId`
  - Response: `void` (204 No Content)
  - Cache invalidation: `[{ type: 'Moc', id: mocId }, { type: 'MocFile', id: fileId }]`
  - Export hook from `instructions-api.ts`

- [ ] **AC-6**: Update `tagTypes` to `['Moc', 'MocList', 'MocFile']`
  - Change from `['Instruction', 'InstructionList']` for consistency with backend domain

- [ ] **AC-7**: Update existing `getInstructions` query to use `MocList` tag
  - Change `providesTags` to return `[{ type: 'MocList', id: 'LIST' }]` (was `InstructionList`)

- [ ] **AC-8**: Update existing `getInstructionById` query to use `Moc` tag
  - Change `providesTags` to return `[{ type: 'Moc', id }]` (was `Instruction`)

- [ ] **AC-9**: Add Zod schemas to `packages/core/api-client/src/schemas/instructions.ts`
  - `MocInstructionsSchema` - MOC entity
  - `MocFileSchema` - File entity
  - `CreateMocInputSchema` - Create MOC input
  - `UpdateMocInputSchema` - Update MOC input (partial)
  - Export from `schemas/index.ts`

- [ ] **AC-10**: Unit tests pass
  - Mutation configs generate correct requests (URL, method, body)
  - Cache tags correctly defined
  - Zod validation works
  - Optimistic updates and rollback logic verified
  - 100% coverage of mutation endpoints

- [ ] **AC-11**: Integration tests pass
  - MSW handlers intercept and respond to mutations
  - Cache invalidation triggers query refetch
  - Optimistic updates reflected in UI state
  - Error handling works and rollback occurs
  - 90%+ coverage with MSW

---

## Reuse Plan

### Components
N/A - infrastructure only, no UI components.

### Patterns

**RTK Query Mutation Pattern** (from `wishlist-gallery-api.ts`):
```typescript
createMoc: builder.mutation<MocInstructions, CreateMocInput>({
  query: (input) => ({
    url: '/api/v2/mocs',
    method: 'POST',
    body: input,
  }),
  invalidatesTags: [{ type: 'MocList', id: 'LIST' }],
  transformResponse: (response) => MocInstructionsSchema.parse(response),
  onQueryStarted: async (input, { dispatch, queryFulfilled, getCacheEntry }) => {
    // Optimistic update logic
  },
})
```

**Cache Tag Structure** (from `wishlist-gallery-api.ts`):
- Entity-level tags: `{ type: 'Moc', id: 'moc-123' }`
- List-level tags: `{ type: 'MocList', id: 'LIST' }`
- File-level tags: `{ type: 'MocFile', id: 'file-456' }`

**Optimistic Update Flow** (from `reorderWishlist` mutation):
```typescript
onQueryStarted: async (input, { dispatch, queryFulfilled }) => {
  // 1. Capture original state
  const patchResult = dispatch(
    api.util.updateQueryData('getMocs', undefined, (draft) => {
      // Update draft state optimistically
    })
  )
  // 2. Wait for API response
  try {
    await queryFulfilled
  } catch {
    // 3. Rollback on error
    patchResult.undo()
  }
}
```

**File Upload Pattern** (from `gallery-api.ts`):
```typescript
uploadFile: builder.mutation<FileMetadata, { file: File }>({
  query: ({ file, fileType }) => {
    const formData = new FormData()
    formData.append('file', file)
    formData.append('fileType', fileType)
    return {
      url: '/api/v2/mocs/:id/files',
      method: 'POST',
      body: formData,
    }
  },
})
```

**Zod Schema Validation** (from `transformResponse` pattern):
```typescript
transformResponse: (response) => MocInstructionsSchema.parse(response)
```

### Packages

- `@reduxjs/toolkit/query/react` - RTK Query `createApi`, `builder.mutation`
- `zod` - Schema validation (`z.object`, `z.string`, `z.infer`)
- `@repo/logger` - Logging (already used in `instructions-api.ts`)
- `@repo/api-client/rtk/base-query` - `createServerlessBaseQuery`, `getServerlessCacheConfig`

### Existing Code to Modify

- `packages/core/api-client/src/rtk/instructions-api.ts` - Add mutations, update tags
- `packages/core/api-client/src/schemas/index.ts` - Export new schemas
- `packages/core/api-client/src/test/mocks/handlers.ts` - Add MSW handlers (if exists)

---

## Architecture Notes

### RTK Query Cache Strategy

**Tag Types**:
- `Moc` - Individual MOC entity (detail page, list item)
- `MocList` - List of MOCs (gallery page)
- `MocFile` - File metadata (instructions, parts list, thumbnail)

**Invalidation Rules**:
1. **Create MOC** → Invalidate `MocList` (new item in list)
2. **Update MOC** → Invalidate `{ type: 'Moc', id }` + `MocList` (detail + list refresh)
3. **Delete MOC** → Invalidate `{ type: 'Moc', id }` + `MocList` (remove from cache)
4. **Upload File** → Invalidate `{ type: 'Moc', id: mocId }` + `{ type: 'MocFile', id: mocId }` (refresh MOC detail)
5. **Delete File** → Invalidate `{ type: 'Moc', id: mocId }` + `{ type: 'MocFile', id: fileId }` (refresh MOC detail)

**Optimistic Updates**:
- ✅ **Create**: Add temp MOC to list (improves perceived performance)
- ✅ **Update**: Patch MOC fields in cache (instant UI update)
- ✅ **Delete**: Remove MOC from list (instant UI update)
- ❌ **File Ops**: No optimistic updates (file uploads have progress indicators)

**Rollback Strategy**:
- Capture `patchResult` before optimistic update
- On API error, call `patchResult.undo()` to restore original cache state
- Log error to `@repo/logger` for debugging

### Schema Design

**Frontend vs Backend Schemas**:
- Backend schemas in `apps/api/lego-api/domains/instructions/types.ts`
- Frontend schemas in `packages/core/api-client/src/schemas/instructions.ts`
- **Decoupled**: Frontend defines separate schemas to avoid tight coupling
- **Trade-off**: Schema drift risk → mitigate with schema alignment tests

**Zod-First Types** (per CLAUDE.md):
```typescript
// Define schema
const MocInstructionsSchema = z.object({
  id: z.string().uuid(),
  title: z.string().min(3),
  // ...
})

// Infer TypeScript type
type MocInstructions = z.infer<typeof MocInstructionsSchema>
```

**Never use TypeScript interfaces** - always use `z.infer<>` for type safety + runtime validation.

### File Upload Strategy

**FormData for Multipart Uploads**:
- Browser `FormData` API for file + metadata
- Backend expects `multipart/form-data`
- Pattern from `gallery-api.ts` (proven to work)

**Example**:
```typescript
const formData = new FormData()
formData.append('file', file)
formData.append('fileType', 'instructions')
```

**File Size Limit**: 10MB for direct upload (this story), >10MB uses presigned URLs (INST-1105)

---

## Infrastructure Notes

### API Path Handling

**Vite Proxy Configuration** (`apps/web/main-app/vite.config.ts`):
```typescript
server: {
  proxy: {
    '/api/v2': {
      target: process.env.VITE_SERVERLESS_API_BASE_URL || 'http://localhost:3001',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api\/v2/, ''),
    },
  },
}
```

**Path Mapping**:
- Frontend calls: `/api/v2/mocs` → Vite proxy rewrites to `/mocs` → Backend handles

**MSW Handlers** (for tests):
- Use frontend paths: `/api/v2/mocs` (not `/mocs`)
- MSW intercepts before Vite proxy

### Backend API Endpoints

**Existing Routes** (`apps/api/lego-api/domains/instructions/routes.ts`):
- `GET /mocs` - List user's MOCs (pagination, search, filters)
- `GET /mocs/:id` - Get single MOC with files
- `POST /mocs` - Create new MOC (requires quota)
- `PATCH /mocs/:id` - Update MOC metadata
- `DELETE /mocs/:id` - Delete MOC
- `GET /mocs/:id/files` - List files for a MOC
- `POST /mocs/:id/files/instruction` - Upload instruction file
- `POST /mocs/:id/files/parts-list` - Upload parts list file
- `POST /mocs/:id/thumbnail` - Upload thumbnail image
- `DELETE /mocs/:id/files/:fileId` - Delete a file

**Note**: This story wires frontend hooks to existing routes (no backend changes).

### Environment Variables

**Required**:
- `VITE_SERVERLESS_API_BASE_URL` - Backend API URL (e.g., `http://localhost:3001`)

**Verify** before starting implementation.

---

## HTTP Contract Plan

N/A - This story does not modify HTTP contracts. It wires frontend hooks to existing backend API endpoints.

**Reference**: Backend API contracts defined in `apps/api/lego-api/domains/instructions/routes.ts`

---

## Seed Requirements

N/A - This story does not seed data. It adds infrastructure (mutation hooks) used by consuming stories.

---

## Test Plan

See `_pm/TEST-PLAN.md` for comprehensive test strategy.

**Summary**:

**Unit Tests** (`instructions-api.test.ts`):
- ✅ Mutation configs (URLs, methods, bodies)
- ✅ Cache tags (invalidation rules)
- ✅ Zod validation (schema parsing)
- ✅ Optimistic updates (cache patching, rollback)
- **Target**: 100% coverage

**Integration Tests** (`instructions-api.integration.test.ts`):
- ✅ MSW handlers (mock API responses)
- ✅ Cache invalidation (query refetch triggers)
- ✅ Optimistic UI state (immediate updates)
- ✅ Error handling (rollback, error messages)
- **Target**: 90%+ coverage

**E2E Tests**: N/A (infrastructure story per ADR-006)
- Consuming stories (INST-1100+) will test E2E flows

**Test Execution**:
```bash
# Unit tests
pnpm --filter @repo/api-client test instructions-api.test.ts

# Integration tests
pnpm --filter @repo/api-client test instructions-api.integration.test.ts

# All tests
pnpm --filter @repo/api-client test
```

---

## UI/UX Notes

N/A - This is an infrastructure story with no user-facing UI.

UI/UX work begins in consuming stories:
- **INST-1100**: View MOC Gallery
- **INST-1102**: Create Basic MOC
- **INST-1103**: Upload Thumbnail

---

## Reality Baseline

**Generated**: 2026-02-05
**Baseline Used**: None (no active baseline file)

### Existing Features

| Feature | Status | Location |
|---------|--------|----------|
| Instructions API Routes | ✅ Complete | `apps/api/lego-api/domains/instructions/routes.ts` |
| Instructions API Types | ✅ Complete | `apps/api/lego-api/domains/instructions/types.ts` |
| Instructions API Client | ⚠️ Partial | `packages/core/api-client/src/rtk/instructions-api.ts` |
| Wishlist RTK API | ✅ Complete | `packages/core/api-client/src/rtk/wishlist-gallery-api.ts` |
| Gallery RTK API | ✅ Complete | `packages/core/api-client/src/rtk/gallery-api.ts` |

**Frontend API Client Status**:
- ✅ GET queries exist (`useGetInstructionsQuery`, `useGetInstructionByIdQuery`)
- ❌ Mutation hooks missing (create, update, delete, file operations)

### Active In-Progress Work

| Story ID | Title | Status | Overlap |
|----------|-------|--------|---------|
| INST-1003 | Extract Upload Types Package | Ready for Review | ✅ None (different layer) |
| INST-1004 | Extract Upload Config Package | Draft | ✅ None (different layer) |

**No conflicts** - this story operates on frontend API client layer.

### Constraints

1. **No Baseline**: Cannot validate against current deployed state
2. **Backend Complete**: All MOC CRUD endpoints already exist
3. **Frontend Partial**: Only query hooks exist, no mutation hooks
4. **Zod-First Required**: Must use Zod schemas with `z.infer<>` (per CLAUDE.md)
5. **Path Handling**: Frontend `/api/v2/mocs` vs backend `/mocs` (Vite proxy rewrites)

### Knowledge Context

**From ADR-001** (API Endpoint Path Schema):
- Frontend RTK Query expects `/api/v2/mocs`
- Backend Hono routes provide `/mocs`
- Vite proxy rewrites paths correctly
- **Risk**: Path mismatches cause 404 errors in E2E tests

**From ADR-006** (E2E Tests Required in Dev Phase):
- Infrastructure stories exempt from E2E tests
- Consuming stories (INST-1100+) must include E2E tests
- **Context**: This story enables mutations for vertical slice stories

**From Wishlist Implementation** (WISH-2005b, WISH-2032):
- Optimistic updates improve UX
- Capture state before update, rollback on error via `patchResult.undo()`
- Provide `onOptimisticError` callback for UI-level error handling

### Blockers to Avoid

- ❌ **Path mismatch**: Ensure `/api/v2/mocs` (frontend) maps to `/mocs` (backend) via Vite proxy
- ❌ **Missing cache invalidation**: Mutations must invalidate relevant tags
- ❌ **TypeScript interfaces**: Must use Zod schemas with `z.infer<>` (per CLAUDE.md)
- ❌ **Reading serverless.yml**: Don't scan serverless config files (token sink)
- ❌ **Barrel files**: Don't create `index.ts` re-exports (per CLAUDE.md)

---

## Definition of Done

- [ ] All 5 mutation hooks added to `instructions-api.ts`
- [ ] `tagTypes` updated to `['Moc', 'MocList', 'MocFile']`
- [ ] Existing query tags updated for consistency (`Moc`, `MocList`)
- [ ] Zod schemas added to `@repo/api-client/schemas/instructions.ts`
- [ ] All hooks exported from `instructions-api.ts`
- [ ] Unit tests pass (100% coverage of mutations)
- [ ] Integration tests pass (90%+ coverage with MSW)
- [ ] TypeScript compiles with no errors
- [ ] ESLint and Prettier pass
- [ ] Code review approved
- [ ] PR merged to main
- [ ] Story index updated to `status: Implemented`

---

## Estimated Effort

**Size**: Small
**Complexity**: Low
**Effort**: 6 hours (includes testing)

**Breakdown**:
- Schema setup: 30 min
- Update API client (tagTypes, queries): 30 min
- Add mutation endpoints: 1 hour
- Add optimistic update logic: 1 hour
- Write unit tests: 1.5 hours
- Write integration tests: 1.5 hours

**Risk Factors**: None (low complexity, established patterns)

---

## Related Stories

**Blocks** (vertical slice stories that depend on this infrastructure):
- INST-1100: View MOC Gallery (uses `useGetMocsQuery`)
- INST-1102: Create Basic MOC (uses `useCreateMocMutation`)
- INST-1103: Upload Thumbnail (uses `useUploadFileMutation`)
- INST-1104: Upload Instructions (uses `useUploadFileMutation`)
- INST-1106: Upload Parts List (uses `useUploadFileMutation`)
- INST-1108: Edit MOC Metadata (uses `useUpdateMocMutation`)
- INST-1109: Delete MOC (uses `useDeleteMocMutation`)
- INST-1110: Remove Individual File (uses `useDeleteFileMutation`)

**Related** (same phase):
- INST-1003: Extract Upload Types Package
- INST-1004: Extract Upload Config Package

**Future**:
- INST-1105: Upload Instructions (Presigned) - extends upload flow for >10MB files

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-02-05_

### Gaps Identified

| # | Finding | Decision | Notes |
|---|---------|----------|-------|
| 1 | File upload endpoint mismatch | Add as AC | Backend uses type-specific routes (`/files/instruction`, `/files/parts-list`, `/thumbnail`). AC-4 updated to specify 3 separate mutation hooks. |

### Enhancement Opportunities

| # | Finding | Decision | Notes |
|---|---------|----------|-------|
| 1-16 | See `_implementation/FUTURE-OPPORTUNITIES.md` | Deferred | Tracked for future: mutation telemetry, undo/redo, progress tracking, conflict resolution, etc. |

### Implementation Guidance

When implementing file upload mutations (AC-4), create three type-specific hooks:
1. `useUploadInstructionFileMutation` - POST /api/v2/mocs/:id/files/instruction
2. `useUploadPartsListFileMutation` - POST /api/v2/mocs/:id/files/parts-list
3. `useUploadThumbnailMutation` - POST /api/v2/mocs/:id/thumbnail

This matches the backend's type-specific routes and maintains clean API semantics.
