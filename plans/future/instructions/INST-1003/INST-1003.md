---
status: ready-to-work
created: 2026-02-05
implementation_date: 2024-12-26
elaboration_complete: 2026-02-05
story_type: infrastructure
domain: instructions
epic: inst
story_id: INST-1003
title: Extract Upload Types Package
size: small
verification_status: verified
---

# INST-1003: Extract Upload Types Package

**Status**: COMPLETED (Retrospective Documentation)

**Implementation Date**: December 26, 2024 (based on package file timestamps)

**Verification Date**: February 5, 2026

---

## Context

The upload functionality for MOC instructions requires shared type definitions between frontend apps (main-app, app-instructions-gallery) and backend (API). Type duplication was leading to schema drift, validation inconsistencies, and maintenance overhead.

**Historical Problem**: Types were duplicated across apps, causing:
- Schema drift between frontend and backend
- Inconsistent validation logic
- Maintenance overhead when updating types
- Risk of type mismatches in request/response contracts

**Current Reality**: This problem has been **fully resolved**. The `@repo/upload-types` package was created and is actively being used by both web apps. The package provides:
- Session management types (UploaderSession, FileMetadata, UploaderStep)
- Upload state types (UploadStatus, UploaderFileItem, UploadBatchState)
- Slug utilities (slugify, findAvailableSlug)
- Edit MOC types (EditMocFormInput, MocFileCategory)
- Error mapping utilities (mapHttpErrorToUploadError, ERROR_MESSAGE_MAP)

**Architecture Decision**: Created a dedicated `@repo/upload-types` package following the established pattern from `@repo/moc-parts-lists-core` (STORY-010). This enables:
- Single source of truth for upload-related types
- Runtime validation with Zod schemas
- Type safety across frontend and backend
- Easy consumption via workspace protocol
- Backward compatibility via deprecated wrappers

---

## Goal

Extract shared upload types into a reusable monorepo package (`@repo/upload-types`) to eliminate duplication, ensure type consistency, and enable runtime validation.

**ACHIEVED**: Package is fully implemented, tested, and deployed to production.

---

## Non-Goals

- Removing deprecated wrapper files (separate cleanup story)
- Moving API-side validation schemas (those belong in backend packages)
- Creating runtime validation middleware (separate concern)
- Supporting file upload logic (only types/schemas)
- Backend-specific configuration (covered by INST-1004)

---

## Scope

### Package Structure
✅ **COMPLETE** - `packages/core/upload-types/`

**Files Implemented**:
- `package.json` - Package configuration with proper exports
- `tsconfig.json` - TypeScript configuration inheriting from workspace
- `vitest.config.ts` - Unit test configuration
- `src/index.ts` - Barrel export of all schemas and utilities
- `src/session.ts` - Session management types (276 lines)
- `src/upload.ts` - Upload state types (280 lines)
- `src/slug.ts` - Slug generation and validation utilities
- `src/edit.ts` - Edit MOC form types
- `src/__tests__/session.test.ts` - Session schema tests (75+ tests)
- `src/__tests__/upload.test.ts` - Upload schema tests (100+ tests)
- `src/__tests__/slug.test.ts` - Slug utility tests

### Type Schemas (All Zod-based)

**Session Types** (`src/session.ts`):
- `UploaderSession` - Session state management
- `FileMetadata` - File upload metadata
- `UploaderStep` - Multi-step upload workflow states
- Helper functions: `createSession`, `isSessionExpired`, `updateSessionFiles`

**Upload Types** (`src/upload.ts`):
- `UploadStatus` - Upload lifecycle states (idle, uploading, success, error)
- `UploaderFileItem` - Individual file tracking
- `UploadBatchState` - Batch upload management
- `UploadErrorCode` - Standardized error codes
- Helper functions: `createFileItem`, `calculateBatchState`, `mapHttpErrorToUploadError`

**Slug Types** (`src/slug.ts`):
- `slugify` - Convert strings to URL-safe slugs
- `slugWithSuffix` - Add numeric suffix to slugs
- `findAvailableSlug` - Find unique slug with conflict resolution

**Edit MOC Types** (`src/edit.ts`):
- `EditMocFormInput` - Form data structure
- `MocFileCategory` - File categorization (instructions, parts-list, gallery)
- Validation schemas for edit operations

### Consuming Applications

✅ **main-app** - Via deprecated wrappers at `src/types/uploader-*.ts`
✅ **app-instructions-gallery** - Via deprecated wrappers

**Integration Pattern**: Apps use backward-compatible re-export wrappers:
```typescript
// apps/web/main-app/src/types/uploader-session.ts
export * from '@repo/upload-types'
```

This allows gradual migration without breaking existing imports.

---

## Acceptance Criteria

**All Original ACs: COMPLETE**

- [x] **AC-1**: Create `@repo/upload-types` package in `packages/core/upload-types/`
  - **Verified**: Package exists with proper structure
  - **Evidence**: `packages/core/upload-types/package.json` version 0.0.1

- [x] **AC-2**: Move UploadSession schema from main-app to package
  - **Verified**: `src/session.ts` contains complete UploaderSession schema
  - **Evidence**: 276-line implementation with Zod validation

- [x] **AC-3**: Move FileMetadata schema from main-app to package
  - **Verified**: FileMetadata exported from `src/session.ts`
  - **Evidence**: Schema includes filename, size, type, lastModified, uploadedUrl

- [x] **AC-4**: Move UploadStatus schema from main-app to package
  - **Verified**: UploadStatus enum exported from `src/upload.ts`
  - **Evidence**: Supports 'idle' | 'uploading' | 'success' | 'error' | 'cancelled'

- [x] **AC-5**: All schemas use Zod with TypeScript inference (`z.infer<typeof Schema>`)
  - **Verified**: Every type uses `z.object()`, `z.enum()`, etc. with `z.infer<>`
  - **Evidence**: Follows CLAUDE.md Zod-first type requirements

- [x] **AC-6**: Package exports all types from `src/index.ts`
  - **Verified**: Barrel export re-exports all schemas and utilities
  - **Evidence**: `export * from './session'`, `export * from './upload'`, etc.

- [x] **AC-7**: Unit tests for all schemas in `__tests__/` directory
  - **Verified**: 175+ total tests across three test files
  - **Evidence**:
    - `session.test.ts`: 75+ tests
    - `upload.test.ts`: 100+ tests
    - `slug.test.ts`: Edge case coverage

- [x] **AC-8**: main-app imports from `@repo/upload-types`
  - **Verified**: Deprecated wrappers re-export from package
  - **Evidence**: `apps/web/main-app/src/types/uploader-session.ts`

- [x] **AC-9**: app-instructions-gallery imports from `@repo/upload-types`
  - **Verified**: Same deprecated wrapper pattern
  - **Evidence**: Components import via wrappers

- [x] **AC-10**: TypeScript compilation passes for all consumers
  - **Verified**: No type errors in main-app or app-instructions-gallery
  - **Evidence**: `pnpm check-types` passes

- [x] **AC-11**: All unit tests pass
  - **Verified**: Test suite passing
  - **Evidence**: `pnpm test --filter @repo/upload-types` exits 0

**Additional Scope Delivered Beyond Original Story**:

- [x] Slug utilities (slugify, slugWithSuffix, findAvailableSlug)
- [x] Edit MOC types (EditMocFormInput, MocFileCategory, etc.)
- [x] Upload helper functions (createFileItem, calculateBatchState)
- [x] Error mapping utilities (mapHttpErrorToUploadError, ERROR_MESSAGE_MAP)
- [x] Comprehensive edge case test coverage
- [x] Session expiry handling
- [x] Failed upload state management

---

## Reuse Plan

**Package Consumers** (Current):
- `apps/web/main-app` - Session management, upload flows
- `apps/web/app-instructions-gallery` - Parallel upload functionality

**Future Reuse Opportunities**:
- Backend API packages for request/response validation
- Additional web apps (user-settings, reset-password) if they add upload features
- Playwright E2E tests for type-safe test data generation
- Shared utilities for slug generation across domains

**Reuse Pattern**: Workspace protocol dependency
```json
{
  "dependencies": {
    "@repo/upload-types": "workspace:*"
  }
}
```

---

## Architecture Notes

### Package Structure
Follows established `*-core` package template from STORY-010:
- Private package (`"private": true`)
- Version 0.0.1
- TypeScript-only (no runtime dependencies except Zod)
- Simple tsc build (no bundling)
- Vitest for unit tests

### Type System
- **Zod-first**: All types defined as Zod schemas, TypeScript types inferred
- **Runtime validation**: Zod schemas enable runtime validation at boundaries
- **Composability**: Schemas compose via `z.object().extend()` and `z.union()`
- **Strict mode**: TypeScript strict mode enabled for maximum safety

### Migration Strategy
- **Backward compatibility**: Deprecated wrappers prevent breaking changes
- **Gradual migration**: Apps can migrate imports incrementally
- **No runtime changes**: Type extraction doesn't change behavior

### Design Decisions
1. **Separate package vs. shared types folder**: Package enables versioning and explicit dependencies
2. **Zod vs. pure TypeScript**: Zod provides runtime validation and self-documenting constraints
3. **Deprecated wrappers vs. direct migration**: Wrappers reduce risk and allow incremental adoption
4. **Test coverage**: Comprehensive tests ensure schema changes don't break consumers

---

## Infrastructure Notes

### Build System
- **Compiler**: TypeScript 5.8.3
- **Build command**: `tsc` (no bundling)
- **Output**: `dist/` directory with `.js` and `.d.ts` files
- **Cache**: Turborepo caching enabled

### Testing
- **Framework**: Vitest 3.0.5
- **Coverage**: Schema validation, type inference, utility functions, edge cases
- **CI/CD**: Tests run in pre-push hook and CI pipeline

### Dependencies
```json
{
  "dependencies": {
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "typescript": "^5.8.3",
    "vitest": "^3.0.5"
  }
}
```

### Package Exports
```json
{
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "default": "./dist/index.js"
    }
  }
}
```

---

## HTTP Contract Plan

**Not Applicable** - This is an infrastructure package with no API endpoints.

The types defined here MAY be used for API request/response validation in future stories (e.g., INST-1104, INST-1105), but that integration is outside this story's scope.

---

## Seed Requirements

**Not Applicable** - No database seeding required for type definitions.

---

## Test Plan

### Unit Tests ✅ **COMPLETE**

**Location**: `packages/core/upload-types/src/__tests__/`

**Coverage**:

#### Session Tests (`session.test.ts`)
- Schema validation
  - Valid UploaderSession objects accepted
  - Invalid schemas rejected with clear errors
  - Optional fields handled correctly
- Type inference
  - Inferred types match expected structure
  - Nested types infer correctly
- Utility functions
  - `createSession` generates valid sessions
  - `isSessionExpired` correctly detects expiry
  - `updateSessionFiles` merges file metadata
- Edge cases
  - Expired sessions handled
  - Missing optional fields defaulted
  - Invalid timestamps rejected

#### Upload Tests (`upload.test.ts`)
- Schema validation
  - UploadStatus enum values validated
  - UploaderFileItem structure enforced
  - UploadBatchState calculations correct
- Helper functions
  - `createFileItem` produces valid items
  - `calculateBatchState` aggregates correctly
  - `mapHttpErrorToUploadError` maps codes properly
- State transitions
  - Idle → Uploading → Success
  - Idle → Uploading → Error → Retry
  - Cancel during upload
- Error handling
  - HTTP error codes mapped to UploadErrorCode
  - User-friendly error messages generated
  - Unknown errors handled gracefully

#### Slug Tests (`slug.test.ts`)
- `slugify` function
  - Converts strings to lowercase kebab-case
  - Removes special characters
  - Handles Unicode characters
- `slugWithSuffix` function
  - Appends numeric suffix
  - Zero-pads numbers
- `findAvailableSlug` function
  - Finds first available slug
  - Handles conflicts with incremented suffix

**Test Execution**:
```bash
pnpm test --filter @repo/upload-types
# Result: All tests passing (175+ tests)
```

### Integration Tests ✅ **COMPLETE**

**Approach**: Consumer apps (main-app, app-instructions-gallery) serve as integration tests.

**Validation**:
- Apps build successfully with `@repo/upload-types` dependency
- TypeScript compilation passes
- No type mismatches in imports
- Runtime validation works (Zod schemas used at boundaries)

**Evidence**:
```bash
pnpm build --filter @repo/main-app
pnpm build --filter @repo/app-instructions-gallery
# Both succeed without type errors
```

### E2E Tests

**Not Applicable** - Infrastructure package has no user-facing behavior to test end-to-end.

E2E tests for upload flows (using these types) are covered in stories INST-1103, INST-1104, INST-1105.

---

## UI/UX Notes

**Not Applicable** - Infrastructure package has no UI.

However, the types defined here enable UX features in consuming apps:
- **Upload progress tracking**: `UploaderFileItem.progress` field
- **Error messaging**: `UploadErrorCode` and `ERROR_MESSAGE_MAP` provide user-friendly messages
- **Session persistence**: `UploaderSession` supports localStorage-based recovery
- **Multi-step flows**: `UploaderStep` enum enables wizard-style uploads

---

## Reality Baseline

### Existing Features (Baseline)

**Package Status**: ✅ **FULLY IMPLEMENTED**

| Feature | Status | Location |
|---------|--------|----------|
| @repo/upload-types package | ✅ Complete | `packages/core/upload-types/` |
| Session schemas | ✅ Complete | `src/session.ts` (276 lines) |
| Upload schemas | ✅ Complete | `src/upload.ts` (280 lines) |
| Slug utilities | ✅ Complete | `src/slug.ts` |
| Edit MOC types | ✅ Complete | `src/edit.ts` |
| Unit tests | ✅ Complete | `src/__tests__/` (175+ tests) |
| Deprecated wrappers (main-app) | ✅ Complete | `src/types/uploader-*.ts` |
| Deprecated wrappers (app-instructions-gallery) | ✅ Complete | Re-exports from package |
| Package built and distributed | ✅ Complete | `dist/` with .d.ts files |

### Implementation Evidence

**File Timestamps**: December 26, 2024 (based on `ls -la` output)

**Package Version**: 0.0.1

**Build Verification**:
```bash
pnpm build --filter @repo/upload-types
# Succeeds, generates dist/ directory
```

**Test Verification**:
```bash
pnpm test --filter @repo/upload-types
# All 175+ tests pass
```

**Type Check Verification**:
```bash
pnpm check-types --filter @repo/upload-types
pnpm check-types --filter @repo/main-app
pnpm check-types --filter @repo/app-instructions-gallery
# All pass without errors
```

**Lint Verification**:
```bash
pnpm lint --filter @repo/upload-types
# No errors
```

### Protected Features

**Do not modify**:
- Existing schema structure (breaking change for consumers)
- Deprecated wrapper exports (needed for backward compatibility)
- Zod schema definitions (apps depend on validation logic)

**Safe to extend**:
- Add new optional fields to schemas
- Add new utility functions
- Add new test cases
- Improve JSDoc comments

### Known Gaps

**Future Cleanup Opportunities** (Not in scope for this story):
1. Remove deprecated wrappers once direct imports migrate
2. Add API-side validation using these schemas
3. Generate TypeDoc documentation
4. Add more comprehensive JSDoc comments
5. Consider schema versioning strategy for breaking changes

---

## Retrospective: Why This Story Was Already Complete

### Timeline Reconstruction

Based on file timestamps and git history, `@repo/upload-types` was implemented during December 2024 sprint work. The package was likely created proactively to support upload functionality in main-app and app-instructions-gallery.

### Deviation from Process

This story was marked "Ready for Review" in the index, suggesting it was intended as a future task. However, the implementation happened before formal story creation, likely due to:
1. Urgent need for shared types during upload feature development
2. Recognition that type extraction was a prerequisite for other stories
3. Developer initiative to reduce technical debt proactively

### Lessons Learned

**For Future Stories**:
- Check codebase reality before starting PM generation
- Update story status immediately when implementation happens outside story flow
- Consider "retrospective documentation" stories for already-completed work
- Use story seeds to detect completion status early

**Process Improvement**:
- Seed generation caught the completion status correctly
- Workers should handle "already complete" scenarios
- Story generation can pivot to documentation mode when needed

---

## Related Stories

**Blocked Stories (Now Unblocked)**:
- INST-1004: Extract Upload Config Package
- INST-1105: Upload Instructions (Presigned >10MB)

**Future Cleanup Stories**:
- INST-1003b: Remove deprecated wrapper files from main-app and app-instructions-gallery
- INST-1003c: Add API-side validation using @repo/upload-types schemas
- INST-1003d: Generate TypeDoc documentation for the package

**Depends On**: None

---

## Completion Summary

**Story Status**: ✅ **VERIFIED COMPLETE**

**Completion Date**: December 26, 2024 (implementation) / February 5, 2026 (verification)

**All Acceptance Criteria Met**: Yes (11/11)

**Quality Gates Passed**:
- [x] Package structure follows established template
- [x] All schemas use Zod with type inference
- [x] Comprehensive unit test coverage (175+ tests)
- [x] TypeScript compilation passes
- [x] Consuming apps integrate successfully
- [x] No lint or type errors
- [x] Build produces clean dist/ output
- [x] Backward compatibility maintained via deprecated wrappers

**Artifacts**:
- Package: `packages/core/upload-types/`
- Tests: `src/__tests__/` (3 test files, 175+ tests)
- Documentation: This story file

**Impact**:
- Eliminated type duplication across 2 apps
- Enabled runtime validation with Zod
- Established pattern for future `*-types` packages
- Unblocked INST-1004 and INST-1105

---

## Token Tracking

**Story Generation**: PM leader phase only (workers not spawned due to completion status detected)

Tokens will be logged separately via `/token-log` command.

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-02-05_

### Gaps Identified

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| — | No gaps identified | N/A | Package is complete with all required functionality |

### Enhancement Opportunities

| # | Finding | User Decision | Notes |
|---|---------|---------------|-------|
| 1 | Add comprehensive JSDoc comments to exported functions | Consider for future enhancement | Low priority, affects documentation generation |
| 2 | API-side validation integration | Create separate story | Belongs in backend package, not type package |
| 3 | TypeDoc documentation generation | Create separate story | Future documentation enhancement |
| 4 | Remove deprecated wrappers from consuming apps | Create separate story | INST-1003b - incremental migration strategy |

### Follow-up Stories Suggested

- [ ] **INST-1003b**: Remove deprecated wrapper files and migrate apps to direct imports
- [ ] **INST-1003c**: Add API-side validation using @repo/upload-types schemas
- [ ] **INST-1003d**: Generate TypeDoc documentation for the package

### Items Marked Out-of-Scope

- **Backward compatibility breaking changes**: Deprecated wrappers prevent breaking changes for consuming apps
- **API validation integration**: Separate concern, belongs in backend infrastructure
- **Runtime middleware**: Beyond scope of type-only package
- **File upload logic**: Package provides types only, not upload implementation
- **Backend configuration**: Covered separately by INST-1004

---

**End of Story Document**
