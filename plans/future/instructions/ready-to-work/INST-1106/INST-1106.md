---
story_id: INST-1106
title: Upload Parts List
feature: instructions
status: ready-to-work
story_type: feature
priority: high
points: 3
created_at: 2026-02-08
updated_at: 2026-02-08
touches_frontend: true
touches_backend: true
touches_database: true
touches_infra: false
blocked_by: []
---

# INST-1106: Upload Parts List

## Context

The MOC Instructions feature allows users to manage their custom LEGO builds. After creating a MOC (INST-1102), uploading a thumbnail (INST-1103), and uploading instruction PDFs (INST-1104), users need to upload parts lists to track which LEGO pieces are required to build their MOC. The `moc_files` database table supports `type='parts-list'` for storing file metadata.

### Existing Infrastructure

The backend has proven patterns from completed stories:
- **POST /mocs/:id/thumbnail**: Direct upload pattern (≤10MB) with multipart/form-data (INST-1103)
- **RTK Query mutations**: `uploadInstructionFile` mutation exists in instructions-api.ts (INST-1008)
- **File validation utilities**: `validateFileSize()`, `logSecurityEvent()` from file-validation.ts
- **S3 + CloudFront**: Storage infrastructure with CDN integration

### Problem

Users need to upload parts lists (CSV, XML, or PDF format) to track LEGO piece requirements for their MOCs. Without this capability, users must manually track parts elsewhere. The MOC detail page has a placeholder for parts list but no way to upload the file.

### Solution

Implement parts list upload functionality as a vertical slice:
- **Frontend**: File picker component for CSV, XML, or PDF selection with validation (single file only)
- **Backend**: POST `/mocs/:id/files` with `type=parts-list` (or dedicated endpoint `/mocs/:id/files/parts-list`)
- **Storage**: Upload to S3 with key `mocs/{userId}/{mocId}/parts-list/{sanitized-filename}`
- **Database**: Insert/replace `moc_files` record with `type='parts-list'`
- **Validation**: Server-side MIME type validation (CSV, XML, PDF), file size (≤10MB)
- **Single file enforcement**: If parts list already exists, replace it (delete old S3 object, update DB record)

---

## Goal

Enable users to upload parts list files (CSV, XML, or PDF, ≤10MB) for their MOCs, with single file enforcement (replace on new upload).

---

## Non-Goals

- Parsing parts list contents (just upload the file, parsing is INST-3040)
- Parts inventory integration (covered by INST-2041)
- Multiple parts lists per MOC (single file only - replace if exists)
- Presigned URL upload for >10MB (use direct upload, defer large files)
- Drag-and-drop upload zone (covered by INST-2035)
- File preview/thumbnails (covered by INST-2032)
- Progress bar with percentage (simple loading spinner sufficient for MVP)
- Automatic parts counting from file contents (future enhancement)
- Batch upload with single request (single file only)
- Gallery image uploads (covered by INST-2030)

---

## Scope

### Frontend Components
- `PartsListUpload` component (new - file picker for CSV/XML/PDF)
- `PartsListCard` component (display uploaded file)
- Integration in MOC detail page (`/mocs/:id`)

### Backend Endpoints
- POST `/mocs/:id/files` with `type=parts-list` OR dedicated `/mocs/:id/files/parts-list`
- Add parts list validation to file validation utilities

### Database
- Insert/replace records in `moc_files` table with `type='parts-list'`
- Single file enforcement via upsert pattern

### Infrastructure
- S3 storage for parts list files
- CloudFront URL conversion

---

## Acceptance Criteria

### Frontend (apps/web/app-instructions-gallery)

#### Upload Component
- [ ] **AC1**: Parts list upload component renders on MOC detail page (`/mocs/:id`) in "Parts List" card
- [ ] **AC2**: "Add Parts List" button visible when no file exists
- [ ] **AC3**: "Replace Parts List" button visible when file exists
- [ ] **AC4**: File picker accepts CSV, XML, or PDF files (`accept=".csv,.xml,.pdf,application/pdf,text/csv,text/xml,application/xml"`)
- [ ] **AC5**: File picker does NOT support multiple file selection (single file only)
- [ ] **AC6**: Click "Add Parts List" or "Replace Parts List" opens file picker

#### Client-Side Validation
- [ ] **AC7**: Client-side validation rejects non-CSV/XML/PDF files (alert: "Only CSV, XML, and PDF files are allowed")
- [ ] **AC8**: Client-side validation rejects files >10MB (alert: "File too large. Maximum size is 10MB")
- [ ] **AC9**: Client-side validation rejects empty files (0 bytes)

#### File Selection Display
- [ ] **AC10**: Selected file displays with filename and size
- [ ] **AC11**: File size formatted as "2 MB", "5.3 MB", etc.
- [ ] **AC12**: "Cancel" button clears selected file before upload

#### Upload Flow
- [ ] **AC13**: "Upload" button triggers `useUploadPartsListFileMutation` RTK Query mutation
- [ ] **AC14**: Upload progress shows (loading spinner)
- [ ] **AC15**: Upload button disabled during upload
- [ ] **AC16**: Upload button text changes to "Uploading..." during upload

#### Success & Error Handling
- [ ] **AC17**: Success shows toast "Parts list uploaded!" and updates UI
- [ ] **AC18**: Uploaded file displays in parts list card immediately (no page reload)
- [ ] **AC19**: Download button appears for uploaded file
- [ ] **AC20**: If existing file, new upload replaces old (no multiple files)
- [ ] **AC21**: Errors from API display as toast notifications with specific error message
- [ ] **AC22**: Network errors display as toast: "Network error. Check your connection and try again."

### Backend (apps/api/lego-api/domains/mocs)

#### Endpoint & Security
- [ ] **AC23**: Endpoint `POST /mocs/:id/files` with `type=parts-list` query param OR dedicated `/mocs/:id/files/parts-list`
- [ ] **AC24**: Endpoint accepts multipart/form-data with `file` field
- [ ] **AC25**: Endpoint requires authentication (auth middleware)
- [ ] **AC26**: Endpoint requires feature gate `requireFeature('moc')`
- [ ] **AC27**: Authorization check: userId from auth context must match MOC owner
- [ ] **AC28**: Return 404 if MOC not found
- [ ] **AC29**: Return 403 if user does not own the MOC

#### File Validation
- [ ] **AC30**: Validate MIME type against whitelist: `['text/csv', 'application/csv', 'application/vnd.ms-excel', 'text/xml', 'application/xml', 'application/pdf']`
- [ ] **AC31**: Use `validatePartsListMimeType()` function from file-validation.ts (NEW function to implement)
- [ ] **AC32**: Return 400 with code `INVALID_MIME_TYPE` if validation fails
- [ ] **AC33**: Validate file size: 1 byte ≤ size ≤ 10MB
- [ ] **AC34**: Return 400 with code `FILE_TOO_LARGE` or `FILE_TOO_SMALL` if validation fails
- [ ] **AC35**: Validate file extension: `.csv`, `.xml`, or `.pdf` (case-insensitive)

#### Storage & Database (Single File Enforcement)
- [ ] **AC36**: Check if existing parts list exists for this MOC: `SELECT id, s3Key FROM moc_files WHERE mocId = $1 AND type = 'parts-list'`
- [ ] **AC37**: If existing file, delete old S3 object before uploading new (log failure, don't block)
- [ ] **AC38**: Upload new file to S3 with key pattern: `mocs/{userId}/{mocId}/parts-list/{sanitized-filename}` (no UUID prefix needed)
- [ ] **AC39**: Sanitize filename (remove special characters, lowercase, replace spaces with hyphens)
- [ ] **AC40**: Upsert `moc_files` record: `INSERT ... ON CONFLICT (mocId, type) DO UPDATE SET ...` (if DB supports) OR update existing record
- [ ] **AC41**: Return 200 or 201 with response: `{ id, mocId, type: 'parts-list', name, size, url, uploadedAt }`
- [ ] **AC42**: CloudFront URL returned in response (S3 URL converted via `toCloudFrontUrl()`)
- [ ] **AC43**: Transaction ensures DB update only if S3 upload succeeds (rollback on failure)

#### Logging & Error Handling
- [ ] **AC44**: Log security events for rejected uploads (invalid type, oversized, zero-byte) to CloudWatch
- [ ] **AC45**: Handle S3 upload failures gracefully with 500 error and structured logging
- [ ] **AC46**: Return specific error message: "Only CSV, XML, and PDF files are allowed" for MIME type failure
- [ ] **AC47**: Return specific error message: "File size exceeds maximum limit of 10MB" for size failure

### Database

#### Schema
- [ ] **AC48**: `moc_files` record inserted/updated with `type='parts-list'`
- [ ] **AC49**: File metadata stored: `mocId`, `name`, `size`, `s3Key`, `mimeType`, `uploadedAt`
- [ ] **AC50**: Single parts list per MOC enforced (upsert pattern in service layer, not DB constraint)

### Testing

#### Unit Tests (Frontend)
- [ ] **AC51**: Unit test: `PartsListUpload.test.tsx` - Component renders
- [ ] **AC52**: Unit test: Validates CSV, XML, PDF file types (accepts valid, rejects JPEG/PNG)
- [ ] **AC53**: Unit test: Validates file size (rejects >10MB, accepts ≤10MB)
- [ ] **AC54**: Unit test: Single file only (no multiple selection)
- [ ] **AC55**: Unit test: Cancel button clears file selection

#### Unit Tests (Backend)
- [ ] **AC56**: Unit test: `validatePartsListMimeType()` accepts all valid MIME types (CSV, XML, PDF)
- [ ] **AC57**: Unit test: Backend service validates file size (1 byte to 10MB)
- [ ] **AC58**: Unit test: Backend service validates file extension (.csv, .xml, .pdf)
- [ ] **AC59**: Unit test: Authorization check prevents unauthorized uploads

#### Integration Tests
- [ ] **AC60**: Integration test: `PartsListUpload.integration.test.tsx` - POST endpoint called correctly
- [ ] **AC61**: Integration test: MSW handler for endpoint returns success
- [ ] **AC62**: Integration test: MSW handler returns error for invalid file
- [ ] **AC63**: Integration test: File metadata returned matches schema
- [ ] **AC64**: Integration test: RTK Query cache invalidation triggers after successful upload

#### E2E Tests (Playwright + Cucumber)
- [ ] **AC65**: E2E test: `inst-1106-parts-list.feature` - Upload CSV file (2MB)
- [ ] **AC66**: E2E test: File uploads successfully, appears in parts list card
- [ ] **AC67**: E2E test: Upload XML file, verify success
- [ ] **AC68**: E2E test: Upload PDF file, verify success
- [ ] **AC69**: E2E test: Replace existing CSV with new XML file
- [ ] **AC70**: E2E test: Verify only one file displayed after replacement
- [ ] **AC71**: E2E test: Reject JPEG file with error "Only CSV, XML, and PDF files are allowed"
- [ ] **AC72**: E2E test: Reject 15MB file with error "File too large. Maximum size is 10MB"
- [ ] **AC73**: E2E test: Download button functional for uploaded file

#### RTK Query Configuration
- [ ] **AC74**: Update `UPLOAD_PARTS_LIST` endpoint in `packages/core/api-client/src/config/endpoints.ts` from `/instructions/mocs/{id}/files/{fileId}` to `/instructions/mocs/{id}/files/parts-list`
_Added by autonomous elaboration - fixes endpoint mismatch that would break upload flow (Gap 5 from ANALYSIS.md)_

---

## Reuse Plan

### Frontend Components

From `@repo/app-component-library/_primitives`:
- `Button` - "Add Parts List", "Replace Parts List", "Upload", "Cancel", "Download"
- `Card` - PartsListCard wrapper
- `Label` - File input label
- `Toast` - Success/error notifications
- `Spinner` - Loading state during upload
- `Badge` - File size indicator

### Backend Utilities

From `apps/api/lego-api/core/utils/file-validation.ts`:
- `validateFileSize()` - Direct reuse (1 byte to 10MB)
- `logSecurityEvent()`, `createSecurityEvent()` - Security logging for rejected uploads
- **NEW**: `validatePartsListMimeType()` - Parts list MIME type validation (CSV, XML, PDF)
- **NEW**: `validatePartsListFile()` - Combined validation (MIME + extension + size)

### Backend Implementation

Reuse patterns from INST-1103 (Upload Thumbnail):
- Multipart/form-data parsing: `c.req.parseBody()`
- S3 upload: `PutObjectCommand`
- CloudFront URL conversion: `toCloudFrontUrl()`
- Transaction safety: Rollback on S3 failure
- Single file replacement: Delete old S3 object before upload

### RTK Query Mutation

Pattern from `packages/core/api-client/src/rtk/instructions-api.ts`:
- `useUploadInstructionFileMutation` (lines 265-294) - Adapt for parts list
- Cache invalidation: `['Moc', 'MocFile']`
- FormData handling: `formData.append('file', file)`

---

## Architecture Notes

### Data Flow

#### Upload Flow (Happy Path)
1. User selects CSV/XML/PDF file (file picker)
2. Frontend validates (type: CSV/XML/PDF, size: ≤10MB)
3. User clicks "Upload"
4. POST `/api/v2/mocs/:id/files` (multipart/form-data)
5. Backend parses body with `c.req.parseBody()`
6. Validate MIME type with `validatePartsListMimeType()`
7. Validate file size (1 byte ≤ size ≤ 10MB)
8. Check authorization (user owns MOC)
9. Query for existing parts list: `SELECT id, s3Key FROM moc_files WHERE mocId = $1 AND type = 'parts-list'`
10. If exists: Delete old S3 object (log failure, don't block)
11. Generate S3 key: `mocs/{userId}/{mocId}/parts-list/{sanitized-filename}`
12. Upload to S3
13. Convert S3 URL to CloudFront URL
14. Upsert `moc_files` record in transaction
15. Return `{ id, mocId, type: 'parts-list', name, size, url, uploadedAt }`
16. Frontend invalidates RTK cache
17. MOC detail page refetches data
18. Parts list card updates
19. Success toast displays

#### Replace Parts List Flow
1. User uploads new file (XML) when CSV already exists
2. Backend checks if existing `type='parts-list'` record exists
3. If exists: Delete old S3 object at old key
4. Upload new XML to S3 at new key
5. Update database record with new file metadata
6. Return new CloudFront URL
7. Frontend displays only new file (old file removed from UI)

### Component Architecture

#### PartsListUpload Component
- **Location**: `apps/web/app-instructions-gallery/src/components/PartsListUpload/`
- **Structure**:
  ```
  PartsListUpload/
    index.tsx              # Main component
    __tests__/
      PartsListUpload.test.tsx
      PartsListUpload.integration.test.tsx
    __types__/
      index.ts              # Zod schemas for file validation
  ```
- **Props**:
  ```typescript
  interface PartsListUploadProps {
    mocId: string
    existingFile?: {
      id: string
      name: string
      size: number
      url: string
    }
    onSuccess?: (file: MocFile) => void
  }
  ```
- **States**: Empty, Selected, Uploading, Success, Error

### Backend Architecture

#### Service Layer
```typescript
// domains/mocs/application/services.ts
async uploadPartsListFile(
  userId: string,
  mocId: string,
  file: UploadedFile,
): Promise<Result<MocFile, MocError>> {
  // 1. Authorization check (user owns MOC)
  // 2. Validate parts list file (MIME type, extension, size)
  // 3. Query for existing parts list
  // 4. Delete old S3 object if exists (log failure, don't block)
  // 5. Generate S3 key
  // 6. Upload to S3
  // 7. Upsert moc_files record
  // 8. Return MocFile with CloudFront URL
}
```

#### Error Handling
- `NOT_FOUND`: MOC does not exist (404)
- `FORBIDDEN`: User does not own MOC (403)
- `INVALID_MIME_TYPE`: Validation failure (400)
- `FILE_TOO_LARGE`: File exceeds 10MB (400)
- `FILE_TOO_SMALL`: File is empty (400)
- `UPLOAD_FAILED`: S3 or database error (500)

#### Transaction Safety
```typescript
try {
  // Delete old S3 object (if exists)
  if (existingFile) {
    await imageStorage.deleteFile(existingFile.s3Key) // log failure, don't block
  }

  // Upload new file
  const s3Url = await imageStorage.uploadFile(buffer, s3Key, mimetype)

  // Upsert database record
  const fileRecord = await mocRepo.upsertFile({ mocId, type: 'parts-list', ... })

  return ok(fileRecord)
} catch (error) {
  // Rollback: Delete newly uploaded S3 object if DB update failed
  if (s3Url) {
    await imageStorage.deleteFile(s3Key)
  }
  return err('UPLOAD_FAILED')
}
```

### RTK Query Integration

Add to `@repo/api-client/src/rtk/instructions-api.ts`:
```typescript
uploadPartsListFile: builder.mutation<
  MocFile,
  { mocId: string; file: File }
>({
  query: ({ mocId, file }) => {
    logger.debug('Uploading parts list file', undefined, {
      mocId,
      fileName: file.name,
      fileSize: file.size,
    })

    const formData = new FormData()
    formData.append('file', file)

    return {
      url: buildEndpoint(SERVERLESS_ENDPOINTS.MOC.UPLOAD_PARTS_LIST, { id: mocId }),
      method: 'POST',
      body: formData,
    }
  },
  transformResponse: (response: unknown) => {
    const validated = MocFileSchema.parse(response)
    logger.info('Parts list file uploaded', undefined, {
      fileId: validated.id,
      mocId: validated.mocId,
    })
    return validated
  },
  invalidatesTags: (_result, _error, { mocId }) => [
    { type: 'Moc', id: mocId },
    { type: 'MocFile', id: mocId },
  ],
})
```

---

## Infrastructure Notes

### S3 Configuration

#### S3 Key Pattern
- Pattern: `mocs/{userId}/{mocId}/parts-list/{sanitized-filename}`
- Example: `mocs/user-123/moc-456/parts-list/parts-list.csv`
- Sanitization: Remove special characters, lowercase, replace spaces with hyphens
- No UUID prefix needed (single file per MOC, no collision risk)

#### S3 Bucket CORS Policy
Ensure S3 bucket allows multipart uploads from frontend origin (already configured from INST-1103):
```json
{
  "AllowedOrigins": ["http://localhost:5173", "https://app.example.com"],
  "AllowedMethods": ["GET", "POST", "PUT"],
  "AllowedHeaders": ["*"],
  "ExposeHeaders": ["ETag"]
}
```

### CloudFront Configuration
- CloudFront distribution already configured for S3 bucket (from INST-1103)
- Use `toCloudFrontUrl()` utility to convert S3 URLs to CloudFront URLs in responses

---

## HTTP Contract Plan

### POST /mocs/:id/files (with type=parts-list)

**Alternative**: POST /mocs/:id/files/parts-list

#### Request
```
POST /api/v2/mocs/{mocId}/files?type=parts-list
Content-Type: multipart/form-data
Authorization: Bearer {token}

Body:
  file: [Binary file data - CSV, XML, or PDF]
```

#### Success Response (200 or 201)
```json
{
  "id": "file-uuid",
  "mocId": "moc-uuid",
  "type": "parts-list",
  "name": "parts-list.csv",
  "size": 2048576,
  "url": "https://cdn.example.com/mocs/user-123/moc-456/parts-list/parts-list.csv",
  "uploadedAt": "2026-02-08T12:00:00Z"
}
```

#### Error Responses

**400 - Invalid MIME Type**
```json
{
  "error": "INVALID_MIME_TYPE",
  "message": "Only CSV, XML, and PDF files are allowed"
}
```

**400 - File Too Large**
```json
{
  "error": "FILE_TOO_LARGE",
  "message": "File size exceeds maximum limit of 10MB"
}
```

**400 - File Too Small**
```json
{
  "error": "FILE_TOO_SMALL",
  "message": "File cannot be empty"
}
```

**403 - Forbidden**
```json
{
  "error": "FORBIDDEN",
  "message": "You do not own this MOC"
}
```

**404 - Not Found**
```json
{
  "error": "NOT_FOUND",
  "message": "MOC not found"
}
```

**500 - Upload Failed**
```json
{
  "error": "UPLOAD_FAILED",
  "message": "Failed to upload file. Please try again"
}
```

---

## Test Plan

### Scope Summary
- **Endpoints**: POST /api/v2/mocs/:id/files (frontend), POST /mocs/:id/files (backend)
- **UI**: PartsListUpload component with file picker, validation, upload button
- **Storage**: S3 file storage, CloudFront URL conversion, database upsert

### Happy Path Tests

#### Test 1: Upload CSV Parts List
- Navigate to MOC detail page, click "Add Parts List", select CSV (2MB), click Upload
- Expected: Preview shows, loading spinner, success toast, file displays in parts list card
- Evidence: POST returns 200 with CloudFront URL, S3 object created, database record inserted

#### Test 2: Upload XML Parts List
- Upload XML file (5MB)
- Expected: XML uploads successfully, toast "Parts list uploaded!", file displays
- Evidence: POST request with XML file, MIME type validation passed: `application/xml` or `text/xml`

#### Test 3: Upload PDF Parts List
- Upload PDF file (8MB)
- Expected: PDF uploads successfully, download button appears
- Evidence: MIME type `application/pdf`, file size within 10MB limit

#### Test 4: Replace Existing Parts List
- MOC with existing CSV, upload new XML (3MB)
- Expected: Old CSV replaced with new XML, only one file displayed
- Evidence: Backend logs old S3 deletion, database record updated (not duplicated)

### Error Cases

#### Error 1: Invalid File Type (JPEG Rejected)
- Attempt to upload JPEG image
- Expected: Client-side validation blocks, error toast, no POST request
- Evidence: File input `accept` attribute filters file types

#### Error 2: File Too Large (15MB Rejected)
- Attempt to upload 15MB CSV file
- Expected: Client-side validation rejects, error toast
- Evidence: File size check runs before upload, no POST request

#### Error 3: Backend MIME Type Rejection
- Upload spoofed file (.csv extension but .exe content)
- Expected: Backend rejects, 400 error, security event logged
- Evidence: Response status 400, CloudWatch security log

### Edge Cases

#### Edge 1: Empty File (0 Bytes)
- Upload empty CSV file
- Expected: Backend validation rejects, 400 error
- Evidence: File size validation: 1 byte ≤ size ≤ 10MB

#### Edge 2: Exact 10MB File (Boundary)
- Upload exactly 10,485,760 bytes
- Expected: File uploads successfully (boundary inclusive)
- Evidence: Validation passes, upload succeeds

#### Edge 3: File with Special Characters in Filename
- Upload file: `parts-list (v2) [updated] @2024.csv`
- Expected: Filename sanitized, S3 key: `parts-list-v2-updated-2024.csv`
- Evidence: Original filename preserved in DB, S3 key sanitized

### Coverage Targets
- Frontend (PartsListUpload component): 80%
- Backend (route + service): 90%
- File validation utilities: 95%
- E2E (Playwright): 3 happy path tests, 2 error case tests minimum

---

## UI/UX Notes

### Verdict
**PASS-WITH-NOTES** - Core user journey is implementable with existing component patterns.

### Component Architecture
- **PartsListUpload**: Adapt from ThumbnailUpload (INST-1103)
- **Key Differences**: CSV/XML/PDF (not images), single file only, replace mode

### Visual Design

#### Upload Zone (Empty State)
- Border: 2px dashed `border-gray-300`
- Text: "Upload parts list" in `text-gray-700`
- Subtext: "CSV, XML, or PDF · Max 10MB" in `text-gray-500`
- Icon: Upload icon, 48x48px

#### Upload Zone (File Selected)
- Border: 2px solid `border-sky-500`
- File info: Filename + size
- Buttons: "Upload" (primary), "Cancel" (secondary)

### Accessibility (MVP-Critical)
- **Keyboard Navigation**: Tab to focus, Enter to activate, Escape to cancel
- **Screen Reader**: `aria-label="Upload parts list file (CSV, XML, or PDF)"`
- **Focus Management**: After upload success, focus returns to Parts List card header

### Error Messaging
Use Toast notifications (not inline errors):
- Invalid file type: "Only CSV, XML, and PDF files are allowed"
- File too large: "File too large. Maximum size is 10MB"
- Upload failed: "Upload failed. Please try again."
- Success: "Parts list uploaded!"

---

## Dev Feasibility

### Feasibility Summary
- **Feasible for MVP**: Yes
- **Confidence**: High
- **Why**: Strong pattern reuse from INST-1103/1104. Proven direct upload pattern, existing file validation utilities, S3 storage adapter in place. Only new work is parts list validation function and single-file replacement logic.

### Effort Estimate
- **Backend**: 6.5 hours (validation, service, route, tests)
- **Frontend**: 9 hours (component, RTK mutation, integration, tests)
- **E2E Tests**: 2 hours
- **Total**: 17.5 hours (rounded to **2-3 days**)

### MVP-Critical Risks

#### Risk 1: Backend Endpoint Structure Ambiguity (MEDIUM)
- **Mitigation**: Inspect routes.ts to confirm endpoint structure. Recommend dedicated `/mocs/:id/files/parts-list` endpoint for consistency.

#### Risk 2: Single File Replacement Logic Complexity (MEDIUM)
- **Mitigation**: Use transaction (delete old S3 → upload new S3 → upsert DB), upsert pattern in database, frontend button disabled during upload.

#### Risk 3: MIME Type Validation for CSV/XML Diversity (MEDIUM)
- **Mitigation**: Add comprehensive MIME type whitelist including `application/vnd.ms-excel` for Excel CSV.

### Recommendation
**Proceed with story implementation.** High reuse potential, low technical complexity, clear requirements, reasonable effort estimate (2-3 days).

---

## Reality Baseline

### Existing Features Referenced
- **POST /mocs/:id/thumbnail** (INST-1103): Production endpoint with direct upload pattern (≤10MB)
- **RTK Query mutations** (INST-1008): `uploadInstructionFile` mutation exists for instruction uploads
- **File validation utilities**: Production utilities in `file-validation.ts`
- **S3 storage**: Established in INST-1103 with CloudFront integration

### Active In-Progress Work
- **INST-1102 (Create Basic MOC)**: In QA - No overlap (MOC creation separate from file upload)
- **INST-1103 (Upload Thumbnail)**: Completed (2026-02-08) - No overlap (different file type)
- **INST-1104 (Upload Instructions)**: UAT (2026-02-07) - STRONG PATTERN REUSE (same endpoint pattern)
- **INST-1107 (Download Files)**: Ready to Work - No overlap (download vs upload)

### Constraints Applied
- **ADR-001**: Frontend uses `/api/v2/mocs/:id/files`, Backend uses `/mocs/:id/files`
- **ADR-005**: UAT must use real services, not mocks
- **ADR-006**: At least one happy-path E2E test required
- **CLAUDE.md**: All types use Zod schemas with `z.infer<>`, no TypeScript interfaces
- **CLAUDE.md**: Use `@repo/app-component-library` for all UI components
- **CLAUDE.md**: NO barrel files - import directly from source files

### Protected Features
None - This is a new feature with no conflicts.

---

## Seed Requirements

This story was generated from STORY-SEED.md with the following context:
- **Baseline Status**: No active baseline file (generated from codebase scanning)
- **Conflicts Found**: 0 blocking conflicts
- **Lessons Loaded**: No (knowledge base unavailable)
- **ADRs Loaded**: Yes (3 ADRs applied: ADR-001, ADR-005, ADR-006)

---

## Success Criteria

- [ ] All 73 acceptance criteria met
- [ ] Test coverage targets met (80% frontend, 90% backend, 95% validation utilities)
- [ ] At least one E2E happy path test passes
- [ ] No security validation bypasses
- [ ] Single file enforcement verified (old file replaced, not duplicated)
- [ ] CSV, XML, and PDF file types all supported
- [ ] Mobile upload works
- [ ] Keyboard navigation functional
- [ ] Integration with MOC detail page confirmed

---

## QA Discovery Notes (Auto-Generated)

_Added by Autonomous Elaboration on 2026-02-08_

### MVP Gaps Resolved

| # | Finding | Resolution | AC Added |
|---|---------|------------|----------|
| 1 | Backend endpoint missing | Already covered by existing ACs (AC23-AC47) | N/A |
| 2 | Parts list validation missing | Already covered by existing ACs (AC30-AC35, AC56-AC58) | N/A |
| 3 | Frontend component missing | Already covered by existing ACs (AC1-AC22) | N/A |
| 4 | Endpoint path ambiguity | Developer discretion; recommend dedicated endpoint | N/A |
| 5 | RTK mutation endpoint mismatch (CRITICAL) | Data integrity issue - frontend mutation points to wrong URL | AC74 |
| 6 | S3 key sanitization not explicit | Implementation detail; analysis provides clear pattern | N/A |

### Non-Blocking Items (Logged to KB)

| # | Finding | Category | Status |
|---|---------|----------|--------|
| 1 | Drag-and-drop upload zone | UX Polish | KB-logged |
| 2 | File preview/thumbnail generation | UX Enhancement | KB-logged |
| 3 | Progress bar with percentage | UX Polish | KB-logged |
| 4 | Multiple file type support | Feature Enhancement | KB-logged |
| 5 | Parts list parsing and validation | Future Integration | KB-logged |
| 6 | Automatic parts counting | Enhancement | KB-logged |
| 7 | Parts list format conversion | Feature Enhancement | KB-logged |
| 8 | Presigned URL upload for large files | Performance Optimization | KB-logged |
| 9 | Client-side compression | Performance Optimization | KB-logged |
| 10 | Background upload with service worker | Advanced Feature | KB-logged |
| 11 | Shared file upload component library | Developer Experience | KB-logged |
| 12 | End-to-end type safety | Developer Experience | KB-logged |
| 13 | Filename sanitization utility | Developer Experience | KB-logged |
| 14 | Parts inventory integration | Future Integration (epic-level) | KB-logged |
| 15 | BrickLink/Rebrickable API integration | Third-party Integration | KB-logged |
| 16 | Gallery image upload integration | UX Polish | KB-logged |
| 17 | Batch MOC upload | Enhancement | KB-logged |
| 18 | Keyboard navigation improvements | Accessibility | KB-logged |
| 19 | Screen reader enhancements | Accessibility | KB-logged |
| 20 | Mobile upload optimization | Feature Enhancement | KB-logged |
| 21 | Visual regression testing | Testing | KB-logged |
| 22 | Load testing for S3 upload | Testing | KB-logged |
| 23 | Error boundary for upload failures | UX Polish | KB-logged |

### Summary

- **ACs added**: 1 (AC74 - RTK endpoint URL fix)
- **MVP gaps resolved**: 6 (1 as new AC, 5 covered by existing ACs)
- **Enhancements logged**: 23 (non-blocking, for future reference)
- **Mode**: Autonomous
- **Verdict**: PASS - Story ready for implementation
