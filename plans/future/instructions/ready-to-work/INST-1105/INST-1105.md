---
id: INST-1105
title: "Upload Instructions (Presigned >10MB)"
status: ready-to-work
created: "2026-02-09"
updated: "2026-02-09"
story_type: feature
priority: high
points: 5
epic: instructions
phase: 1
blocked_by: []
blocks: []
touches_frontend: true
touches_backend: true
touches_database: true
touches_infra: false
assignee: null
labels: ["upload", "presigned-url", "s3", "progress-tracking"]
---

# INST-1105: Upload Instructions (Presigned >10MB)

## User Story

> As a user, I can upload large instruction PDFs up to 50MB using presigned URLs, so I can store comprehensive building guides without file size limitations.

---

## Context

MOC users need to upload instruction PDFs larger than 10MB (the direct upload limit from INST-1104). Files between 10MB and 50MB require a presigned URL flow to avoid Lambda payload size limits and enable client-side progress tracking.

The codebase already has strong infrastructure for presigned uploads:
- **@repo/upload-types** (INST-1003) provides UploadStatus, UploadErrorCode, UploaderFileItem schemas
- **@repo/upload-config** (INST-1004) provides pdfMaxBytes (50MB), presignTtlMinutes (15), sessionTtlMinutes (15)
- **moc-instructions-core** package provides editPresign/editFinalize pattern for two-phase uploads
- **useUploadManager hook** provides session expiry detection, progress tracking, cancel/retry logic
- **upload_sessions** table exists in database schema for tracking upload state

### Problem

Direct upload (INST-1104) is limited to 10MB due to Lambda payload size constraints. Users with larger instruction PDFs (10-50MB) need a presigned URL flow where:
1. Frontend requests presigned URL from backend (POST /mocs/:id/upload-sessions)
2. Frontend uploads directly to S3 using XHR for progress tracking
3. Frontend notifies backend to verify and finalize (POST /mocs/:id/upload-sessions/:sessionId/complete)

This flow avoids Lambda payload limits, enables progress bars, supports cancellation, and handles session expiry gracefully.

### Solution Direction

Implement presigned URL upload as a vertical slice reusing proven patterns:

**Frontend:**
- Detect files >10MB in InstructionsUpload component, route to presigned flow
- Call `useCreateUploadSession` mutation to get presigned URL + sessionId
- Use `useUploadManager` hook for concurrent uploads with progress, cancel, retry
- Upload directly to S3 via XHR with progress events (uploadToPresignedUrl from @repo/upload-client)
- Call `useCompleteUploadSession` mutation to finalize and create moc_files record
- Handle session expiry: detect via API error or local TTL, refresh URLs, resume uploads

**Backend:**
- POST /mocs/:id/upload-sessions - Create session, validate file metadata, generate presigned S3 URL
  - Reuse editPresign pattern: Authorization → Rate limit → File validation → Presigned URL generation
  - Insert upload_sessions record with status='pending', s3Key, expiresAt
  - Return { sessionId, presignedUrl, expiresAt }
- POST /mocs/:id/upload-sessions/:sessionId/complete - Verify S3 upload, create moc_files record
  - Reuse editFinalize pattern: Authorization → S3 verification (headObject) → Transaction → Update session status
  - Verify file exists in S3 via headObject
  - Insert moc_files record with type='instruction'
  - Update upload_sessions.status = 'completed'

**Database:**
- upload_sessions table (already exists): Track pending/completed uploads
- moc_files table (already exists): Store finalized file metadata

---

## Goal

Enable users to upload instruction PDFs between 10MB and 50MB using presigned S3 URLs with:
- Real-time progress tracking (percentage, upload speed)
- Cancellation support during upload
- Retry capability after failures
- Session expiry auto-refresh
- Concurrent upload limit (max 3 files)

---

## Non-Goals

- Multipart upload for >50MB files (deferred to INST-3010)
- Chunked upload with resume (deferred to INST-2036)
- Parallel presigned URL generation for batches (sequential acceptable for MVP)
- Server-side virus scanning (deferred to INST-2031)
- PDF thumbnail generation (deferred to INST-2032)
- Direct S3 upload without API involvement (backend session tracking required)
- WebSocket progress updates (XHR progress events sufficient)
- File encryption at rest (S3 bucket default encryption sufficient)

### Protected Features

Do not modify or extend:
- Direct upload flow (INST-1104) for files ≤10MB
- @repo/upload-types package schemas (reuse as-is)
- @repo/upload-config package values (reuse as-is)
- upload_sessions table schema (minor migration only)

---

## Scope

### Frontend

**Components** (`apps/web/app-instructions-gallery/src/components/`):
- `PresignedUpload.tsx` (new) - Presigned upload UI with progress bar, cancel, retry
- Extend `InstructionsUpload.tsx` - Add file size routing (≤10MB → direct, >10MB → presigned)

**Hooks** (`apps/web/app-instructions-gallery/src/hooks/`):
- Adapt `useUploadManager.ts` - Integrate with createUploadSession/completeUploadSession mutations

**RTK Query** (`packages/api-client/src/rtk/instructions-api.ts`):
- `useCreateUploadSessionMutation` - POST /api/v2/mocs/:id/upload-sessions
- `useCompleteUploadSessionMutation` - POST /api/v2/mocs/:id/upload-sessions/:sessionId/complete

**Utilities** (`apps/web/app-instructions-gallery/src/utils/`):
- `shouldUsePresignedUpload(fileSize)` - Returns true if fileSize > 10MB
- `validateFileSizeForPresigned(fileSize)` - Validates 10MB < fileSize ≤ 50MB

### Backend

**Endpoints** (`apps/api/lego-api/domains/mocs/routes.ts`):
- `POST /mocs/:id/upload-sessions` - Create presigned URL
  - Request: `{ filename: string, fileSize: number, fileType: string }`
  - Response: `{ sessionId: string, presignedUrl: string, expiresAt: string }`
- `POST /mocs/:id/upload-sessions/:sessionId/complete` - Verify and finalize
  - Request: `{ sessionId: string }`
  - Response: `{ id: string, mocId: string, fileType: string, fileUrl: string, ... }`

**Services** (create new file: `apps/api/lego-api/domains/mocs/application/services.ts`):
- `createUploadSession()` - Adapt editPresign pattern
- `completeUploadSession()` - Adapt editFinalize pattern
- `validatePresignedUploadRequest()` - Validate file metadata (size, type)

**Ports** (create new file: `apps/api/lego-api/domains/mocs/ports/index.ts`):
- `UploadSessionRepository` - Port interface for upload_sessions table operations
- `S3StoragePort` - Port interface for S3 operations (presigned URLs, headObject)

**Validation** (`apps/api/lego-api/domains/mocs/application/validation.ts`):
- `CreateUploadSessionRequestSchema` - Zod schema for session creation
- `CompleteUploadSessionRequestSchema` - Zod schema for completion

### Database

**Migration** (`packages/backend/database-schema/migrations/`):
- Add columns to `upload_sessions` table:
  - `originalFilename` varchar(255) - Store original filename for display
  - `originalFileSize` bigint - Store original file size for verification

**Tables** (existing, no schema changes):
- `upload_sessions` - Track upload sessions (id, userId, status, s3Key, expiresAt)
- `moc_files` - Store finalized file metadata (id, mocId, fileType, fileUrl, originalFilename)

### Infrastructure

**None** - Reuses existing S3 bucket, CloudFront distribution, and AWS SDK configuration.

---

## Acceptance Criteria

### Frontend - File Size Detection & Routing

- [ ] **AC1**: InstructionsUpload component detects files >10MB
- [ ] **AC2**: Files >10MB trigger presigned URL flow (not direct upload)
- [ ] **AC3**: Files ≤10MB trigger direct upload flow (INST-1104)
- [ ] **AC4**: Client validation rejects files >50MB with error "File too large. Max 50MB."

### Frontend - Upload Session Creation

- [ ] **AC5**: `useCreateUploadSessionMutation` hook calls POST /api/v2/mocs/:id/upload-sessions
- [ ] **AC6**: Request includes { filename, fileSize, fileType: "application/pdf" }
- [ ] **AC7**: Response includes { sessionId, presignedUrl, expiresAt }
- [ ] **AC8**: Session TTL displayed to user: "Upload session expires in 15 minutes"

### Frontend - Presigned Upload Flow

- [ ] **AC9**: useUploadManager hook tracks upload state (queued, uploading, success, failed)
- [ ] **AC10**: Direct S3 upload via uploadToPresignedUrl (from @repo/upload-client)
- [ ] **AC11**: Progress bar updates during upload: "Uploading... 45%"
- [ ] **AC12**: Multiple files upload concurrently (max 3 at a time)
- [ ] **AC13**: Upload speed displayed: "2.5 MB/s"
- [ ] **AC14**: Cancel button aborts active upload, removes file from queue

### Frontend - Upload Completion

- [ ] **AC15**: After S3 upload success, call `useCompleteUploadSessionMutation`
- [ ] **AC16**: Request includes { sessionId }
- [ ] **AC17**: Response includes created moc_files record
- [ ] **AC18**: Success toast: "Instructions uploaded!"
- [ ] **AC19**: File appears in instructions list immediately (cache invalidation)

### Frontend - Session Expiry Handling

- [ ] **AC20**: Local TTL check before upload starts (30-second buffer)
- [ ] **AC21**: If expired locally, show error: "Session expired. Refreshing..."
- [ ] **AC22**: API error EXPIRED_SESSION triggers auto-refresh flow
- [ ] **AC23**: Auto-refresh: Call POST /upload-sessions again, get new presigned URLs
- [ ] **AC24**: updateFileUrls() resets expired files to queued state
- [ ] **AC25**: Uploads resume automatically after refresh

### Frontend - Error Handling

- [ ] **AC26**: Network error during S3 upload: "Upload failed. Check your connection."
- [ ] **AC27**: Retry button re-attempts failed uploads
- [ ] **AC28**: File handle lost (after page reload): Prompt re-selection
- [ ] **AC29**: S3 upload succeeds but completion fails: Display specific error message
- [ ] **AC30**: Multiple errors handled gracefully (don't block other uploads)

### Backend - POST /mocs/:id/upload-sessions (Create Session)

- [ ] **AC31**: Endpoint accepts { filename, fileSize, fileType }
- [ ] **AC32**: Requires authentication (userId from auth context)
- [ ] **AC33**: Requires feature gate 'moc'
- [ ] **AC34**: Authorization: User must own MOC (return 403 if not owner)
- [ ] **AC35**: Return 404 if MOC not found
- [ ] **AC36**: Validate fileType: Must be 'application/pdf'
- [ ] **AC37**: Validate fileSize: Must be >10MB and ≤50MB
- [ ] **AC38**: Return 400 if fileSize ≤10MB: "Use direct upload for files ≤10MB"
- [ ] **AC39**: Return 400 if fileSize >50MB: "File too large. Max 50MB."
- [ ] **AC40**: Rate limit check (rateLimitPerDay = 100 per user)
- [ ] **AC41**: Return 429 if rate limit exceeded with retryAfterSeconds

### Backend - Presigned URL Generation

- [ ] **AC42**: Generate S3 key: mocs/{userId}/{mocId}/instructions/{sessionId}-{filename}
- [ ] **AC43**: Sanitize filename (remove special chars, preserve extension)
- [ ] **AC44**: Generate presigned PUT URL with TTL (presignTtlMinutes = 15)
- [ ] **AC45**: Set ContentType=application/pdf in presigned URL
- [ ] **AC46**: Insert upload_sessions record: id, userId, mocId, status='pending', s3Key, expiresAt
- [ ] **AC47**: Return 201 with { sessionId, presignedUrl, expiresAt }
- [ ] **AC48**: Security logging for session creation

### Backend - POST /mocs/:id/upload-sessions/:sessionId/complete (Complete Session)

- [ ] **AC49**: Requires authentication and authorization (user owns MOC)
- [ ] **AC50**: Return 404 if session not found
- [ ] **AC51**: Return 403 if user does not own session
- [ ] **AC52**: Return 400 if session already completed or expired
- [ ] **AC53**: Verify file exists in S3 via headObject
- [ ] **AC54**: Return 400 with code FILE_NOT_IN_S3 if file missing
- [ ] **AC55**: Verify file size matches original request (within 5% tolerance)
- [ ] **AC56**: Return 400 with code SIZE_MISMATCH if size doesn't match

### Backend - Database Transaction

- [ ] **AC57**: Transaction: Insert moc_files + Update upload_sessions.status
- [ ] **AC58**: Insert moc_files record: mocId, fileType='instruction', fileUrl, originalFilename, mimeType
- [ ] **AC59**: Update upload_sessions.status = 'completed', completedAt = NOW()
- [ ] **AC60**: Rollback on failure, return 500 with structured error
- [ ] **AC61**: Return 200 with created moc_files record (includes CloudFront URL)

### Backend - Error Handling

- [ ] **AC62**: Handle S3 errors gracefully (timeout, permission denied)
- [ ] **AC63**: Handle rate limit errors with structured response
- [ ] **AC64**: Handle concurrent completion attempts (idempotency)
- [ ] **AC65**: Security logging for suspicious activity (repeated failures, large files)

### Database

- [ ] **AC66**: upload_sessions table populated correctly
- [ ] **AC67**: upload_sessions.status transitions: pending → completed
- [ ] **AC68**: moc_files record created with correct fileType='instruction'
- [ ] **AC69**: Foreign keys valid: upload_sessions.mocInstructionId references moc_instructions.id

### Testing - Unit Tests

- [ ] **AC70**: Frontend: PresignedUpload component renders, detects >10MB files
- [ ] **AC71**: Frontend: useUploadManager progress tracking, cancel, retry
- [ ] **AC72**: Backend: validatePresignedUploadRequest() validates file metadata
- [ ] **AC73**: Backend: generatePresignedUrl() generates valid S3 URLs
- [ ] **AC74**: Backend: completeUploadSession() verifies S3 and creates file record

### Testing - Integration Tests

- [ ] **AC75**: Frontend: MSW handler for POST /api/v2/mocs/:id/upload-sessions
- [ ] **AC76**: Frontend: MSW handler for POST /api/v2/mocs/:id/upload-sessions/:sessionId/complete
- [ ] **AC77**: Frontend: Cache invalidation after successful upload
- [ ] **AC78**: Backend: createUploadSession service test with mocked S3 client
- [ ] **AC79**: Backend: completeUploadSession service test with mocked headObject

### Testing - E2E Tests (Playwright + Cucumber)

- [ ] **AC80**: E2E: Upload 30MB PDF via presigned URL (happy path)
- [ ] **AC81**: E2E: Progress bar updates during upload
- [ ] **AC82**: E2E: Upload completes, file appears in instructions list
- [ ] **AC83**: E2E: Reject 60MB PDF with error "File too large. Max 50MB."
- [ ] **AC84**: E2E: Cancel upload mid-progress, file removed from queue
- [ ] **AC85**: E2E: Network error during upload, retry succeeds

### Architecture - Port Interfaces

- [ ] **AC86**: Define `UploadSessionRepository` port interface in `apps/api/lego-api/domains/mocs/ports/index.ts`
- [ ] **AC87**: Define `S3StoragePort` port interface in `apps/api/lego-api/domains/mocs/ports/index.ts`
- [ ] **AC88**: Services (`createUploadSession`, `completeUploadSession`) depend on port interfaces, not concrete implementations
_Added by autonomous elaboration: High severity - Port interfaces required per api-layer.md architecture_

### Architecture - Service Layer

- [ ] **AC89**: Create service file at `apps/api/lego-api/domains/mocs/application/services.ts`
- [ ] **AC90**: Implement `createUploadSession()` service function (adapts editPresign pattern)
- [ ] **AC91**: Implement `completeUploadSession()` service function (adapts editFinalize pattern)
_Added by autonomous elaboration: Medium severity - Explicit service layer required for testability_

### Database - Migration Path

- [ ] **AC92**: Create migration file at `packages/backend/database-schema/migrations/{timestamp}_add_upload_session_metadata.sql`
- [ ] **AC93**: Migration adds `originalFilename` varchar(255) column to upload_sessions table
- [ ] **AC94**: Migration adds `originalFileSize` bigint column to upload_sessions table
_Added by autonomous elaboration: Medium severity - Migration file path required for implementation tracking_

---

## Reuse Plan

### Packages - Direct Reuse

**@repo/upload-types** (INST-1003) - 100% reuse:
- UploadStatus, UploadErrorCode, UploaderFileItem schemas
- calculateBatchState(), createFileItem(), mapHttpErrorToUploadError()

**@repo/upload-config** (INST-1004) - 95% reuse:
- pdfMaxBytes (50MB), presignTtlMinutes (15), sessionTtlMinutes (15)
- getFileSizeLimit(), getPresignTtlSeconds()
- **New**: Add pdfMinBytesForPresigned (10MB), shouldUsePresignedUpload() utility

**@repo/upload-client** - 100% reuse:
- uploadToPresignedUrl() with XHR progress tracking
- createUploadManager() for concurrent uploads

### Components - Adapt & Extend

**useUploadManager hook** (app-instructions-gallery) - 90% reuse:
- Reuse: Progress tracking, cancel, retry, session expiry detection
- Adapt: Integrate with createUploadSession/completeUploadSession mutations

**InstructionsUpload component** (INST-1104) - 60% reuse:
- Reuse: File picker UI, client validation, file list display
- Extend: Add file size check, route >10MB to presigned flow

### Backend - Pattern Reuse

**editPresign pattern** (moc-instructions-core) - 85% reuse:
- Authorization check → Rate limit → File validation → Presigned URL generation
- Error codes: NOT_FOUND, FORBIDDEN, FILE_TOO_LARGE, RATE_LIMIT_EXCEEDED

**editFinalize pattern** (moc-instructions-core) - 85% reuse:
- Authorization → S3 verification (headObject) → Transaction → Update status
- Idempotency handling for concurrent requests

### Utilities

**PDF validation** (from INST-1104) - 70% reuse:
- validatePdfFile(), validatePdfMimeType(), validatePdfExtension()
- **New**: Add shouldUsePresignedUpload(fileSize), validateFileSizeForPresigned()

**S3 client** (packages/api-core/src/s3.ts) - 100% reuse:
- generatePresignedUrl() with @aws-sdk/s3-request-presigner
- headObject() for file verification

---

## Architecture Notes

### Two-Phase Upload Flow

```
Phase 1: Session Creation
┌─────────────┐  POST /upload-sessions   ┌─────────────┐
│  Frontend   │ ──────────────────────> │   Backend   │
│             │                          │             │
│             │ <────────────────────── │             │
│             │  { sessionId,            │             │
│             │    presignedUrl,         │             │
│             │    expiresAt }           │             │
└─────────────┘                          └─────────────┘
                                                │
                                                │ INSERT upload_sessions
                                                ▼
                                         ┌─────────────┐
                                         │  Database   │
                                         └─────────────┘

Phase 2: Direct S3 Upload
┌─────────────┐  PUT (presignedUrl)      ┌─────────────┐
│  Frontend   │ ──────────────────────> │     S3      │
│             │                          │             │
│             │ <────────────────────── │             │
│             │  200 OK                  │             │
└─────────────┘                          └─────────────┘
      │
      │ XHR Progress Events
      ▼
   Progress Bar (0% → 100%)

Phase 3: Completion
┌─────────────┐  POST /complete          ┌─────────────┐
│  Frontend   │ ──────────────────────> │   Backend   │
│             │  { sessionId }           │             │
│             │                          │             │
│             │ <────────────────────── │             │
│             │  { moc_files record }    │             │
└─────────────┘                          └─────────────┘
                                                │
                                                │ headObject (verify S3)
                                                ▼
                                         ┌─────────────┐
                                         │     S3      │
                                         └─────────────┘
                                                │
                                                │ INSERT moc_files
                                                │ UPDATE upload_sessions
                                                ▼
                                         ┌─────────────┐
                                         │  Database   │
                                         └─────────────┘
```

### Session Expiry Handling

```
Local TTL Check (Before Upload):
┌─────────────┐
│  Frontend   │  Check: expiresAt < (now + 30s)
│             │  ────────────────────────────────┐
│             │                                   │
│             │  Expired?                         │
│             │  ────────────────────────────────┘
│             │         │
│             │         │ YES
│             │         ▼
│             │  markExpiredFiles()
│             │  onSessionExpired([fileIds])
│             │  ────────────────────────────────┐
│             │                                   │
│             │  Create new sessions              │
│             │  ────────────────────────────────┘
│             │         │
│             │         ▼
│             │  updateFileUrls(newPresignedUrls)
│             │  Resume upload
└─────────────┘

API Error Handling (During Upload/Completion):
┌─────────────┐  POST /complete          ┌─────────────┐
│  Frontend   │ ──────────────────────> │   Backend   │
│             │                          │             │
│             │ <────────────────────── │             │
│             │  400 EXPIRED_SESSION     │             │
└─────────────┘                          └─────────────┘
      │
      │ Detect error code
      ▼
  Auto-refresh flow (same as local TTL)
```

---

## Infrastructure Notes

### S3 Bucket Configuration

**Bucket**: Existing S3 bucket (from environment variables)

**CORS**: Must allow PUT from app domain
```json
{
  "CORSRules": [
    {
      "AllowedOrigins": ["https://app.example.com"],
      "AllowedMethods": ["PUT"],
      "AllowedHeaders": ["*"],
      "ExposeHeaders": ["ETag"],
      "MaxAgeSeconds": 3600
    }
  ]
}
```

**Action Required**: Verify CORS configuration before implementation

### CloudFront Distribution

**Distribution**: Existing CloudFront distribution (for download URLs)

**Origin**: S3 bucket with OAI/OAC

**Action Required**: Verify CloudFront URL format in environment variables

### Rate Limiting

**Implementation**: Existing rate limit middleware (from editPresign pattern)

**Limit**: 100 uploads/edits per user per day (rateLimitPerDay from @repo/upload-config)

**Response**: 429 with Retry-After header

---

## HTTP Contract Plan

### POST /mocs/:id/upload-sessions

**Request**:
```typescript
{
  filename: string       // "castle-instructions.pdf"
  fileSize: number       // 26214400 (25MB in bytes)
  fileType: string       // "application/pdf"
}
```

**Response (201 Created)**:
```typescript
{
  sessionId: string      // "550e8400-e29b-41d4-a716-446655440000"
  presignedUrl: string   // "https://bucket.s3.amazonaws.com/key?AWSAccessKeyId=...&Signature=..."
  expiresAt: string      // "2026-02-09T16:00:00.000Z" (ISO 8601)
}
```

**Error Responses**:
- 400 FILE_TOO_SMALL: `{ error: "FILE_TOO_SMALL", message: "Use direct upload for files ≤10MB" }`
- 400 FILE_TOO_LARGE: `{ error: "FILE_TOO_LARGE", message: "File too large. Max 50MB." }`
- 400 INVALID_MIME_TYPE: `{ error: "INVALID_MIME_TYPE", message: "Instructions must be PDF files" }`
- 401 Unauthorized: `{ error: "UNAUTHORIZED", message: "Authentication required" }`
- 403 FORBIDDEN: `{ error: "FORBIDDEN", message: "You don't have permission to upload to this MOC" }`
- 404 MOC_NOT_FOUND: `{ error: "MOC_NOT_FOUND", message: "MOC not found" }`
- 429 RATE_LIMIT_EXCEEDED: `{ error: "RATE_LIMIT_EXCEEDED", message: "Upload limit reached. Try again tomorrow.", retryAfterSeconds: 86400 }`

---

### POST /mocs/:id/upload-sessions/:sessionId/complete

**Request**:
```typescript
{
  sessionId: string      // "550e8400-e29b-41d4-a716-446655440000" (from URL path)
}
```

**Response (200 OK)**:
```typescript
{
  id: string             // "file-123"
  mocId: string          // "moc-456"
  fileType: string       // "instruction"
  fileUrl: string        // "https://cloudfront.net/mocs/user-789/moc-456/instructions/session-550e8400-castle.pdf"
  originalFilename: string // "castle-instructions.pdf"
  mimeType: string       // "application/pdf"
  fileSize: number       // 26214400
  createdAt: string      // "2026-02-09T15:30:00.000Z"
  uploadedBy: string     // "user-789"
}
```

**Error Responses**:
- 400 EXPIRED_SESSION: `{ error: "EXPIRED_SESSION", message: "Session expired" }`
- 400 FILE_NOT_IN_S3: `{ error: "FILE_NOT_IN_S3", message: "File not found in storage. Please retry upload." }`
- 400 SIZE_MISMATCH: `{ error: "SIZE_MISMATCH", message: "File size doesn't match. Please upload again." }`
- 400 SESSION_ALREADY_COMPLETED: `{ error: "SESSION_ALREADY_COMPLETED", message: "Session already completed", file: { ...existing moc_files record } }`
- 403 FORBIDDEN: `{ error: "FORBIDDEN", message: "You don't have permission to complete this session" }`
- 404 SESSION_NOT_FOUND: `{ error: "SESSION_NOT_FOUND", message: "Session not found" }`
- 500 DATABASE_ERROR: `{ error: "DATABASE_ERROR", message: "Failed to save file metadata" }`

---

## Test Plan

See: `_pm/TEST-PLAN.md`

**Coverage Targets**:
- Frontend: 80%
- Backend: 90%
- Upload session state machine: 95%

**Key Test Scenarios**:
1. Happy path: 30MB PDF upload with progress tracking
2. Session expiry: Local TTL check + API error handling
3. Multi-file upload: 5 files with max 3 concurrent
4. Error handling: Network errors, S3 errors, file not found
5. Cancellation: Mid-upload cancel, retry after failure
6. E2E: Real S3 presigned URL flow (ADR-006 requirement)

---

## UI/UX Notes

See: `_pm/UIUX-NOTES.md`

**MVP-Critical Components**:
- Progress bar with percentage during upload
- Upload speed display ("2.5 MB/s")
- Cancel button (aborts active upload)
- Retry button after failure
- Session expiry warning (<5 min remaining)
- Session expiry auto-refresh flow

**Accessibility**:
- Keyboard navigation (Tab, Enter, Escape)
- Screen reader announcements (progress, status, errors)
- ARIA attributes (aria-valuenow, aria-label, aria-live)
- Color contrast compliance (WCAG AA)

**Nice-to-Have** (Phase 2):
- Time remaining display
- Pause/resume button
- Batch actions (Start All, Cancel All)

---

## Reality Baseline

**Baseline Date**: 2026-02-09

**Related Existing Features**:
- **INST-1003**: Upload Types Package (Completed 2024-12-26)
  - Provides: UploadStatus, UploadErrorCode, UploaderFileItem schemas
- **INST-1004**: Upload Config Package (Completed 2025-12-09)
  - Provides: pdfMaxBytes, presignTtlMinutes, sessionTtlMinutes config
- **INST-1104**: Upload Instructions (Direct ≤10MB) (UAT 2026-02-08)
  - Provides: Direct upload pattern, PDF validation, InstructionsUpload component
- **INST-1103**: Upload Thumbnail (Completed 2026-02-08)
  - Provides: Image upload pattern, S3 storage patterns
- **INST-1008**: RTK Query Mutations (UAT 2026-02-05)
  - Provides: RTK Query framework for API calls
- **moc-instructions-core package** (Existing)
  - Provides: editPresign/editFinalize pattern for presigned URL flows

**Active In-Progress Work**:
- **INST-1104**: Upload Instructions (Direct ≤10MB) - UAT
  - Overlap Risk: Low (different size threshold, complementary features)
- **INST-1102**: Create Basic MOC - In QA
  - Overlap Risk: Low (prerequisite for testing only)

**Constraints**:
1. File size thresholds: Direct upload (≤10MB), presigned URL (>10MB)
2. Upload config values: pdfMaxBytes=50MB, presignTtlMinutes=15, sessionTtlMinutes=15
3. Database schema: upload_sessions table exists (minor migration required)
4. Presigned URL pattern: Two-phase flow (presign → S3 upload → complete)
5. Testing strategy: ADR-006 requires UAT with real services, not mocks

**Established Patterns**:
- Discriminated union result types: `{ success: true, data: T } | { success: false, error: ErrorCode }`
- Dependency injection: All infrastructure (DB, S3, rate limit) injected via deps parameter
- Transaction safety: Wrap DB operations in transaction, rollback on failure
- Session expiry handling: Local TTL check with 30-second buffer, auto-refresh flow

**Blockers to Avoid**:
1. Direct S3 upload without verification → Use headObject() in completion endpoint
2. Session expiry during multi-file upload → Local TTL check with buffer, auto-refresh
3. Lost file handles after page reload → hasFileHandle() check, prompt re-selection

---

## Seed Requirements

**Seed File**: `_pm/STORY-SEED.md`

**Key Insights from Seed**:
- 80-100% reuse potential across all layers (upload-types, upload-config, upload-client, useUploadManager)
- editPresign/editFinalize patterns proven in moc-instructions-core
- upload_sessions table exists, needs 2 column migration (originalFilename, originalFileSize)
- Session expiry handling pattern exists in useUploadManager with 30-second buffer
- ADR-006 requires E2E tests with real S3 presigned URLs (no mocks)

---

## Dependencies

**Blocked By**: None (INST-1003, INST-1004 completed)

**Blocks**: None

**Related Stories**:
- INST-1104: Upload Instructions (Direct ≤10MB) - Complementary feature
- INST-1111: E2E Tests for File Upload - Testing infrastructure
- INST-1204: S3 Cleanup for Failed Uploads - Orphaned file cleanup (Phase 2)

---

## Story Metadata

**Created**: 2026-02-09
**Updated**: 2026-02-09
**Synthesized By**: pm-story-generation-leader v4.1.0
**Seed File**: `_pm/STORY-SEED.md`
**Test Plan**: `_pm/TEST-PLAN.md`
**UI/UX Notes**: `_pm/UIUX-NOTES.md`
**Dev Feasibility**: `_pm/DEV-FEASIBILITY.md`

---

## Completion Checklist

- [ ] All 85 acceptance criteria verified
- [ ] Frontend coverage ≥80%
- [ ] Backend coverage ≥90%
- [ ] Upload session state machine coverage ≥95%
- [ ] All E2E tests passing (8/8 scenarios)
- [ ] Real S3 presigned URL flow tested (ADR-006)
- [ ] Session expiry handling verified
- [ ] Multi-file concurrent upload verified (max 3)
- [ ] Progress tracking verified in E2E
- [ ] Code review approved
- [ ] Documentation updated
- [ ] Merged to main branch

---

## QA Discovery Notes (Auto-Generated)

_Added by Autonomous Elaboration on 2026-02-09_

### MVP Gaps Resolved

No MVP-critical gaps found. Story covers complete two-phase upload flow:
1. User selects >10MB file → Presigned URL session created (AC31-48)
2. File uploads to S3 with progress tracking (AC9-14, AC80-81)
3. Completion endpoint verifies S3 and creates file record (AC49-61, AC82)
4. Session expiry handled via auto-refresh (AC20-25, AC86)

### Architectural Issues Fixed

| # | Finding | Resolution | AC Added |
|---|---------|------------|----------|
| 1 | Missing Port Interfaces | Add UploadSessionRepository, S3StoragePort per api-layer.md | AC86-88 |
| 2 | Service Layer Not Explicitly Called Out | Specify service file at apps/api/lego-api/domains/mocs/application/services.ts | AC89-91 |
| 3 | Database Migration Path Missing | Specify migration file path for explicit tracking | AC92-94 |

### Non-Blocking Items (Logged to KB)

| # | Finding | Category | Impact |
|---|---------|----------|--------|
| 1 | Time remaining display | ux-polish | Low |
| 2 | Pause/resume button | ux-polish | Low |
| 3 | Batch actions UI | ux-enhancement | Medium |
| 4 | Cancel All confirmation modal | ux-polish | Low |
| 5 | Session expiry countdown timer | ux-polish | Low |
| 6 | Upload speed units adaptation | edge-case | Low |
| 7 | Progress announcement frequency setting | accessibility | Low |
| 8 | Keyboard shortcuts modal | ux-enhancement | Low |
| 9 | High Contrast Mode support | accessibility | Low |
| 10 | Reduced motion support | accessibility | Medium |
| 11 | Upload history | feature-enhancement | Medium |
| 12 | Manual session refresh button | ux-enhancement | Low |
| 13 | S3 Transfer Acceleration | performance | Medium |
| 14 | Progress persistence (localStorage) | feature-enhancement | High |
| 15 | File size verification (exact match) | data-integrity | Medium |
| 16 | Unique constraint on moc_files | data-integrity | Medium |
| 17 | Session expiry E2E test with time mocking | testing | High |
| 18 | Orphaned file cleanup documentation | documentation | Low |
| 19 | Unsaved uploads page navigation guard | ux-enhancement | Medium |
| 20 | Analytics/monitoring for failures | observability | High |

### Summary

- ACs added: 9 (AC86-94 for architectural compliance)
- Original ACs: 85 (now 94 total)
- KB entries created: 20 (non-blocking findings)
- Mode: Autonomous elaboration
- Verdict: **PASS** - Story ready for implementation

All architectural gaps resolved. No MVP-critical blockers. Comprehensive test coverage plan includes 80% frontend, 90% backend, and 95% state machine coverage. Ready to move to ready-to-work stage.
