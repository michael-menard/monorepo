---
id: INST-1101
title: "View MOC Details"
type: story
status: ready-to-work
priority: high
created: 2026-02-05
updated: 2026-02-06
blocked_by:
  - INST-1100
story_points: 5
tags:
  - vertical-slice
  - phase-1
  - frontend
  - backend
  - database
---

# INST-1101: View MOC Details

## User Story

> As a user, I can view the details of a MOC so I can see all its information and files.

## Context

This is a core vertical slice in Phase 1 that delivers the MOC detail page - the primary view for interacting with a single MOC. The page displays comprehensive information including cover image, metadata, stats, and file listings (instructions, parts list, gallery images).

## Dependencies

- **INST-1100** (View MOC Gallery) - Must be completed first for navigation context

## Acceptance Criteria

### Frontend

1. **AC-1**: Detail page renders at `/mocs/:mocId` route
2. **AC-2**: Page uses 12-column grid layout with sticky sidebar (4 cols) and main area (8 cols)
3. **AC-3**: Sidebar displays Cover Image card with MOC thumbnail
4. **AC-4**: Sidebar displays Metadata card with title, description, theme, tags
5. **AC-5**: Main area displays Stats section (piece count, file count, creation date)
6. **AC-6**: Main area displays Parts Gauge visualization
7. **AC-7**: Main area displays draggable dashboard cards (Instructions, Parts List, Gallery)
8. **AC-8**: Card order is persisted to localStorage
9. **AC-9**: Mobile layout stacks all sections vertically
10. **AC-10**: Loading skeleton displays while fetching MOC data
11. **AC-11**: 404 page displays for invalid mocId

### Backend

12. **AC-12**: `GET /mocs/:id` endpoint returns MOC with all related data
13. **AC-13**: Response includes MOC metadata (title, description, theme, tags, createdAt, updatedAt)
14. **AC-14**: Response includes files array with metadata (name, size, type, uploadedAt, downloadUrl)
15. **AC-15**: Response includes stats (pieceCount, fileCount)
16. **AC-16**: Endpoint returns 404 for non-existent or unauthorized MOC

### Database

17. **AC-17**: Query `mocs` table by id with user authorization check
18. **AC-18**: Join `moc_files` for instructions, parts list, gallery images
19. **AC-19**: Include file metadata (name, size, type, s3Key, uploadedAt)

## Design Reference

- `__design__/v0-examples/moc-detail-page/`

## Technical Implementation

### Frontend Files

- `apps/web/app-instructions-gallery/src/pages/MocDetailPage.tsx`
- `apps/web/app-instructions-gallery/src/components/MocSidebar.tsx`
- `apps/web/app-instructions-gallery/src/components/MocDashboard.tsx`
- `apps/web/app-instructions-gallery/src/components/DraggableCard.tsx`

### Backend Files

- `apps/api/lego-api/domains/mocs/routes.ts`
- `apps/api/lego-api/domains/mocs/handlers/getMoc.ts`

### RTK Query Integration

Uses hooks from INST-1008:
- `useGetMocQuery(mocId)` - Fetch single MOC with files

## Testing Requirements

### Unit Tests

**Location**: `apps/web/app-instructions-gallery/src/pages/__tests__/MocDetailPage.test.tsx`

**Test Cases**:
- Page renders with correct layout
- Sidebar is sticky on desktop
- Dashboard cards render, collapse, and support drag-drop
- localStorage saves and restores card order
- Loading skeletons display during fetch
- Error state renders on API failure

### Integration Tests

**Location**: `apps/web/app-instructions-gallery/src/pages/__tests__/MocDetailPage.integration.test.tsx`

**Framework**: Vitest + MSW

**Test Cases**:
- MOC data fetched and displayed correctly
- Files listed with correct metadata
- 404 handling for invalid mocId
- Unauthorized access returns 404 (not 403)

### E2E Tests (Playwright + Cucumber)

**Feature File**: `apps/web/playwright/features/instructions/inst-1101-detail.feature`

```gherkin
Feature: View MOC Details

  Scenario: View MOC with files
    Given MOC "Castle MOC" exists with instructions and parts list
    When user navigates to /mocs/{mocId}
    Then cover image displays
    And metadata shows title, description, theme
    And instructions file listed with download button
    And parts list file listed with download button

  Scenario: Navigate from gallery
    Given gallery page with MOC cards
    When user clicks "Castle MOC" card
    Then detail page loads
    And URL is /mocs/{mocId}

  Scenario: Reorder dashboard cards
    Given MOC detail page
    When user drags Instructions card below Parts List card
    Then card order is updated
    And order persists after page reload

  Scenario: Mobile responsive layout
    Given viewport is mobile (375px)
    When user navigates to /mocs/{mocId}
    Then sidebar content stacks above main content
    And all sections are visible
```

## Out of Scope

- File download functionality (INST-1107)
- Edit MOC functionality (INST-1108)
- Delete MOC functionality (INST-1109)
- Remove file functionality (INST-1110)

## Technical Risks

### localStorage Limitations
- Quota: 5-10MB per origin (sufficient for card order metadata)
- User control: Browser "Clear Site Data" clears all localStorage
- No sync: Card order not synced across devices/tabs (deferred to future story)
- Fallback: Always provide default card order if localStorage unavailable

### Drag-Drop Complexity
- State management during reordering can conflict with API updates
- Mobile testing burden: swipe interactions vs. drag interactions
- Accessibility: Ensure keyboard navigation works for card reordering

### Mobile Responsive Layout
- CSS Grid fallback needed for older browsers
- Test thoroughly on iPad and mobile browsers
- Ensure touch targets are â‰¥48px

---

## QA Discovery Notes

### Summary of Gaps Addressed

The Phase 1 analysis identified 5 MVP-critical gaps in INST-1101. All have been resolved through acceptance criteria additions and architectural specifications:

| Gap | Type | Resolution |
|-----|------|-----------|
| Dashboard card composition undefined | Architecture | AC: Specify DraggableCard component reusing CardContainer from @repo/ui |
| Service layer for GET /mocs/:id | Architecture | AC: Define MocService with getMoc(userId, mocId) method |
| Missing ports/adapters pattern | Architecture | AC: Define MocRepository interface and Drizzle adapter implementation |
| localStorage strategy undefined | Technical Decision | AC: Schema `{ [mocId]: { version: 1, cardOrder: string[] } }` with fallback |
| Risk disclosure missing | Documentation | Added: Technical Risks section with localStorage, drag-drop, and mobile concerns |

### New Acceptance Criteria Added (from user decisions)

**MVP-Critical Fixes (5 ACs)**:
1. **AC-20**: DraggableCard component reuses CardContainer from @repo/ui or implements consistent drag-drop API using @dnd-kit
2. **AC-21**: Create MocService with getMoc(userId, mocId) returning complete MOC with stats and file metadata
3. **AC-22**: Define MocRepository port interface with getMocById() method, implement adapter using Drizzle ORM with proper table joins
4. **AC-23**: Card order persisted using schema `{ [mocId]: { version: 1, cardOrder: string[] } }` with fallback to default order
5. **AC-24**: localStorage unavailable gracefully - fallback to default card order

**Selected Enhancements (4 ACs)**:
6. **AC-25**: Handle missing or orphaned files with error states and empty state UI
7. **AC-26**: Visual feedback during card drag (highlight drop zones, drag preview)
8. **AC-27**: Page load performance metrics collected (DOM ready, first paint, data loaded)
9. **AC-28**: Empty state displayed when dashboard cards have no content

### Deferred to Follow-up Stories (3 items)

| Feature | Story | Phase |
|---------|-------|-------|
| Stale Data Handling | INST-1110+ | Reliability |
| Card Order Sync Across Devices | INST-1110+ | Persistence |
| Lazy Load Dashboard Cards | INST-1110+ | Performance |

### Discovery Validation

- **Scope**: Confirmed 19 ACs appropriate for 5-point vertical slice (no split needed)
- **Sizing**: 1 GET endpoint, 3 components, 4 test scenarios = correct estimate
- **Reuse**: Clear patterns identified from wishlist gallery, AddItemPage, existing detail pages
- **Testing**: Unit, integration, and E2E coverage achievable with MSW and Playwright

**Status**: CONDITIONAL PASS - All gaps resolved, story ready for implementation.

---

## Notes

- Design reference exists at `__design__/v0-examples/moc-detail-page/`
- Reuse patterns from existing detail pages in the codebase
- Card drag-drop should use @dnd-kit for consistency with wishlist
- Phase 1 analysis complete: See `ELAB-INST-1101.md` for full audit report
