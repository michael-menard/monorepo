---
story_id: INST-1103
title: Upload Thumbnail
feature: instructions
status: completed
story_type: feature
priority: high
points: 13
created_at: 2026-02-06
updated_at: 2026-02-08T05:00:00Z
touches_frontend: true
touches_backend: true
touches_database: true
touches_infra: false
blocked_by: []
completed_at: 2026-02-08T05:00:00Z
---

# INST-1103: Upload Thumbnail

## Context

The MOC Instructions feature allows users to manage their custom LEGO builds. MOCs are displayed in a gallery (INST-1100) and detail page (INST-1101) where thumbnails provide visual appeal and help users identify their builds at a glance. The `moc_instructions` database table has a `thumbnailUrl` field ready to store the image URL.

### Existing Patterns

The codebase has proven patterns for image upload from the wishlist domain:
- **ImageUploadZone component**: Full drag-drop upload with preview, validation, and file management
- **File validation utilities**: MIME type whitelist and size limits
- **S3 storage**: Direct upload pattern with CloudFront CDN integration
- **Security logging**: Structured logging for rejected uploads

### Problem

Users need to upload a cover image for their MOCs to make them visually identifiable in the gallery. Without thumbnails, MOCs appear as generic placeholders, reducing user engagement and making it harder to find specific MOCs at a glance.

### Solution

Implement thumbnail upload functionality as a vertical slice:
- **Frontend**: Adapt `ImageUploadZone` component for single-image thumbnail upload
- **Backend**: `POST /mocs/:id/thumbnail` endpoint for direct upload (≤10MB)
- **Storage**: Upload to S3 with key `mocs/{userId}/{mocId}/thumbnail/{filename}`
- **Database**: Update `moc_instructions.thumbnailUrl` with CloudFront URL
- **Validation**: Server-side MIME type, file size, and extension validation

---

## Goal

Enable users to upload a single thumbnail image for their MOC that displays in the gallery and detail pages.

---

## Non-Goals

- Multiple gallery images (covered by INST-2030)
- Image optimization/resize (optional for this story, can defer to INST-2033)
- Presigned URL upload for >10MB files (not needed for thumbnails - use direct upload)
- Virus scanning (covered by INST-2031)
- PDF thumbnail generation (covered by INST-2032)
- Drag-to-reorder images (only one thumbnail, no ordering needed)
- Automatic thumbnail generation from uploaded instructions (future enhancement)
- Image cropping or editing before upload (future enhancement)

---

## Scope

### Frontend Components
- `ThumbnailUpload` component (adapt from `ImageUploadZone`)
- Integration in MOC detail page (`/mocs/:id`)
- Integration in MOC create flow (after creation)

### Backend Endpoints
- `POST /mocs/:id/thumbnail` - Upload thumbnail image

### Database
- Update `moc_instructions.thumbnailUrl` field

### Infrastructure
- S3 storage for thumbnail images
- CloudFront URL conversion

---

## Acceptance Criteria

### Frontend (apps/web/app-instructions-gallery)

#### Upload Component
- [ ] **AC1**: Thumbnail upload component renders on create page (`/mocs/new`) after MOC creation
- [ ] **AC2**: Thumbnail upload component renders on detail page (`/mocs/:id`) with "Change Thumbnail" action
- [ ] **AC3**: Upload zone supports drag-and-drop for image files
- [ ] **AC4**: Upload zone supports file picker (click to select)
- [ ] **AC5**: Drag-over state shows visual feedback (border color change, opacity)

#### Client-Side Validation
- [ ] **AC6**: Client-side validation rejects non-image files (alert: "Only images allowed (JPEG, PNG, WebP)")
- [ ] **AC7**: Client-side validation rejects files >10MB (alert: "File too large. Max 10MB")
- [ ] **AC8**: File input has `accept="image/jpeg,image/png,image/webp"` attribute

#### Preview & Upload
- [ ] **AC9**: Image preview displays selected file before upload
- [ ] **AC10**: Preview shows filename and file size
- [ ] **AC11**: "Remove" button clears selected image before upload
- [ ] **AC12**: "Upload" button triggers multipart/form-data POST to `/api/v2/mocs/:id/thumbnail`
- [ ] **AC13**: Loading state shows during upload with disabled upload button and spinner

#### Success & Error Handling
- [ ] **AC14**: Success shows toast "Thumbnail uploaded!" and updates UI with new thumbnail
- [ ] **AC15**: Existing thumbnail is replaced (not appended) on new upload
- [ ] **AC16**: Errors from API (e.g., "File too large") display as toast notifications
- [ ] **AC17**: Network errors display as toast with retry option

### Backend (apps/api/lego-api/domains/mocs)

#### Endpoint & Security
- [ ] **AC18**: `POST /mocs/:id/thumbnail` endpoint accepts multipart/form-data
- [ ] **AC19**: Endpoint requires authentication (auth middleware)
- [ ] **AC20**: Endpoint requires feature gate `requireFeature('moc')`
- [ ] **AC21**: Authorization check: userId from auth context must match MOC owner
- [ ] **AC22**: Return 404 if MOC not found
- [ ] **AC23**: Return 403 if user does not own the MOC

#### File Validation
- [ ] **AC24**: Validate MIME type against whitelist: `['image/jpeg', 'image/png', 'image/webp']`
- [ ] **AC25**: Use `file-type` library to verify actual MIME type (don't trust client)
- [ ] **AC26**: Return 400 with code `INVALID_MIME_TYPE` if validation fails
- [ ] **AC27**: Validate file size: 1 byte ≤ size ≤ 10MB
- [ ] **AC28**: Return 400 with code `FILE_TOO_LARGE` or `FILE_TOO_SMALL` if validation fails

#### Storage & Database
- [ ] **AC29**: Upload file to S3 with key pattern: `mocs/{userId}/{mocId}/thumbnail/{uuid}-{filename}`
- [ ] **AC30**: Sanitize filename (remove special characters, add UUID prefix)
- [ ] **AC31**: Update `moc_instructions.thumbnailUrl` with CloudFront URL (via S3→CloudFront conversion)
- [ ] **AC32**: If existing thumbnail exists, delete old S3 object before uploading new one
- [ ] **AC33**: Return 200 with response: `{ thumbnailUrl: string }`
- [ ] **AC34**: Transaction ensures DB update only if S3 upload succeeds (rollback on failure)

#### Logging & Error Handling
- [ ] **AC35**: Log security events for rejected uploads (invalid type, oversized, etc.) to CloudWatch
- [ ] **AC36**: Handle S3 upload failures gracefully with 500 error and structured logging
- [ ] **AC37**: Log S3 deletion failures (for old thumbnails) without blocking upload

### Testing

#### Unit Tests
- [ ] **AC38**: Unit test: `ThumbnailUpload.test.tsx` - Component renders, validates file type/size, shows preview
- [ ] **AC39**: Unit test: Backend route validates MIME type with `file-type` library
- [ ] **AC40**: Unit test: Backend route validates file size (min/max)
- [ ] **AC41**: Unit test: Backend route checks authorization (user owns MOC)

#### Integration Tests
- [ ] **AC42**: Integration test: `ThumbnailUpload.integration.test.tsx` - POST endpoint called, success updates UI
- [ ] **AC43**: Integration test: MSW handler for `/api/v2/mocs/:id/thumbnail` returns success/error
- [ ] **AC44**: Integration test: RTK Query cache invalidated on success

#### E2E Tests (Per ADR-006)
- [ ] **AC45**: E2E test: `inst-1103-thumbnail.feature` - Upload JPEG, verify gallery/detail page shows thumbnail
- [ ] **AC46**: E2E test: Reject PDF file with error message
- [ ] **AC47**: E2E test: Replace existing thumbnail with new image
- [ ] **AC48**: E2E test: Upload via drag-and-drop (desktop only)

### Architecture (Service Layer)

#### Service Layer Implementation
- [ ] **AC49**: Service file created at `domains/mocs/application/services.ts` with `uploadThumbnail()` method
- [ ] **AC50**: Service method signature: `uploadThumbnail(userId, mocId, file: { buffer, filename, mimeType, size })` returns `Result<{ thumbnailUrl }, MocError>`
- [ ] **AC51**: Service layer handles all business logic: MOC ownership check, file validation, S3 upload orchestration, DB update
- [ ] **AC52**: Service method wraps S3 upload + DB update in transaction with rollback on failure (delete newly uploaded S3 object if DB update fails)
- [ ] **AC53**: Route handler is thin adapter (<50 lines) that parses request, calls service, maps Result to HTTP response

#### Ports & Adapters Pattern
- [ ] **AC54**: `MocImageStorage` port interface defined in `domains/mocs/ports/index.ts` with `uploadThumbnail()` and `deleteThumbnail()` methods
- [ ] **AC55**: Adapter implementation in `domains/mocs/adapters/storage.ts` as `createMocImageStorage()` function
- [ ] **AC56**: Route handler injects dependencies: `mocService = createMocService({ mocRepo, imageStorage })`

### Enhancements (User-Selected)

#### Performance Optimizations
- [ ] **AC57**: Convert uploaded images to WebP format for optimal compression and browser support
- [ ] **AC58**: Generate multiple thumbnail sizes: 200x200 (gallery card), 800x800 (detail page), 1600x1600 (fullscreen preview)
- [ ] **AC59**: Display progress indicator during upload (progress bar showing % complete for large files)
- [ ] **AC60**: Client-side image compression before upload (reduce file size by 30-50% using browser Canvas API)

#### Security & Observability
- [ ] **AC61**: Strip EXIF metadata (GPS, location, camera info) from uploaded photos before storage
- [ ] **AC62**: Rate limiting: Enforce 100 uploads per hour per user limit (return 429 Too Many Requests if exceeded)
- [ ] **AC63**: Upload analytics: Log CloudWatch metrics for success rate, average file size, upload duration, failure reasons

#### Edge Cases
- [ ] **AC64**: High-resolution image validation: Reject images exceeding 8000x8000 pixels to prevent browser crash on preview
- [ ] **AC65**: Concurrent upload handling: Queue or cancel previous upload when new upload starts (prevent race conditions)
- [ ] **AC66**: Session expiry handling: Detect 401 mid-upload and prompt user to re-authenticate with retry option

---

## Reuse Plan

### Components

#### From Existing Codebase
| Component | Source | Adaptation | Reuse Score |
|-----------|--------|------------|-------------|
| `ImageUploadZone` | `apps/web/app-sets-gallery/src/components/ImageUploadZone.tsx` | Set `maxImages={1}`, remove reorder button, adapt labels to "Thumbnail" | 95% |

#### From @repo/app-component-library
- `Button` - Upload button, Remove button, Change Thumbnail button
- `Card` - ThumbnailCoverCard wrapper for detail page sidebar
- `Label` - "Thumbnail" label for upload zone
- `Toast` - Success/error notifications
- `Spinner` - Loading state during upload

### Backend Utilities

#### File Validation
- `validateMimeType(file, allowedTypes)` from `core/utils/file-validation.ts`
- `validateFileSize(file, minSize, maxSize)` from `core/utils/file-validation.ts`
- `createSecurityEvent(userId, filename, reason)` from `core/utils/file-validation.ts`

#### S3 Storage
- S3 upload pattern from `domains/wishlist/adapters/storage.ts`
- `toCloudFrontUrl()` from `core/cdn/cloudfront.ts`
- S3 delete operation for old thumbnails

### Established Patterns

#### Upload Pattern (from wishlist domain)
- **Direct upload**: Multipart/form-data POST endpoint for files ≤10MB
- **Validation sequence**: MIME type → File size → Extension → Upload
- **Security logging**: Log rejected uploads with userId, filename, reason
- **Response format**: Return `{ thumbnailUrl: string }` on success
- **Error handling**: Return 400 with specific error code

#### Database Pattern
- Update query: `UPDATE moc_instructions SET thumbnailUrl = $1, updatedAt = NOW() WHERE id = $2`
- Transaction wrapper to rollback on S3 failure

---

## Architecture Notes

### Data Flow

#### Upload Flow (Happy Path)
1. User selects image file (drag-drop or file picker)
2. Frontend validates (type: image/*, size: ≤10MB)
3. Preview displays with filename and file size
4. User clicks "Upload"
5. POST `/api/v2/mocs/:id/thumbnail` (multipart/form-data)
6. Backend parses body with `c.req.parseBody()`
7. Validate MIME type with `file-type` library
8. Validate file size (1 byte ≤ size ≤ 10MB)
9. Check authorization (user owns MOC)
10. Generate S3 key: `mocs/{userId}/{mocId}/thumbnail/{uuid}-{sanitizedFilename}`
11. Upload to S3
12. Convert S3 URL to CloudFront URL
13. Update `moc_instructions.thumbnailUrl` in transaction
14. Return `{ thumbnailUrl: "https://cdn.example.com/..." }`
15. Frontend invalidates RTK cache
16. Detail page refetches MOC data
17. Gallery card updates thumbnail
18. Success toast displays

#### Replace Thumbnail Flow
1. User uploads new thumbnail
2. Backend checks if existing `thumbnailUrl` exists
3. If exists: Delete old S3 object (log failure, don't block)
4. Upload new thumbnail to S3
5. Update database with new URL
6. Return new CloudFront URL

### Component Architecture

#### ThumbnailUpload Component
- **Location**: `apps/web/app-instructions-gallery/src/components/ThumbnailUpload/`
- **Structure**:
  ```
  ThumbnailUpload/
    index.tsx              # Main component
    __tests__/
      ThumbnailUpload.test.tsx
      ThumbnailUpload.integration.test.tsx
  ```
- **Props**:
  ```typescript
  interface ThumbnailUploadProps {
    mocId: string
    existingThumbnailUrl?: string
    onSuccess?: (thumbnailUrl: string) => void
  }
  ```
- **States**: Empty, Drag-over, Preview, Uploading, Success, Error

#### ThumbnailCoverCard (Detail Page)
- **Location**: `apps/web/app-instructions-gallery/src/pages/MocDetailPage/components/`
- **Purpose**: Display thumbnail in sidebar with "Change Thumbnail" button
- **Layout**: Sticky sidebar card (4 cols on desktop), full width on mobile

### RTK Query Integration

Add to `@repo/api-client/rtk/mocs-api.ts`:
```typescript
uploadThumbnail: builder.mutation<
  { thumbnailUrl: string },
  { mocId: string; file: File }
>({
  query: ({ mocId, file }) => {
    const formData = new FormData()
    formData.append('file', file)
    return {
      url: `/mocs/${mocId}/thumbnail`,
      method: 'POST',
      body: formData,
    }
  },
  invalidatesTags: (result, error, { mocId }) => [
    { type: 'Moc', id: mocId },
    { type: 'Moc', id: 'LIST' },
  ],
})
```

---

## Infrastructure Notes

### S3 Configuration

#### Bucket CORS Policy
Ensure S3 bucket allows multipart uploads from frontend origin:
```json
{
  "AllowedOrigins": ["http://localhost:5173", "https://app.example.com"],
  "AllowedMethods": ["GET", "POST", "PUT"],
  "AllowedHeaders": ["*"],
  "ExposeHeaders": ["ETag"]
}
```

#### S3 Key Pattern
- Pattern: `mocs/{userId}/{mocId}/thumbnail/{uuid}-{sanitizedFilename}`
- Example: `mocs/user-123/moc-456/thumbnail/abc-def-ghi-castle-moc.jpg`
- Sanitization: Remove special characters, lowercase, replace spaces with hyphens

### CloudFront Configuration
- CloudFront distribution should already be configured for S3 bucket (from wishlist domain)
- Use `toCloudFrontUrl()` utility to convert S3 URLs to CloudFront URLs in responses

---

## HTTP Contract Plan

### POST /mocs/:id/thumbnail

#### Request
```
POST /api/v2/mocs/{mocId}/thumbnail
Content-Type: multipart/form-data
Authorization: Bearer {token}

Body:
  file: [Binary image data]
```

#### Success Response (200)
```json
{
  "thumbnailUrl": "https://cdn.example.com/mocs/user-123/moc-456/thumbnail/abc-def-ghi-castle.jpg"
}
```

#### Error Responses

**400 - Invalid MIME Type**
```json
{
  "code": "INVALID_MIME_TYPE",
  "message": "Only JPEG, PNG, and WebP images are allowed"
}
```

**400 - File Too Large**
```json
{
  "code": "FILE_TOO_LARGE",
  "message": "File size exceeds 10MB limit"
}
```

**400 - File Too Small**
```json
{
  "code": "FILE_TOO_SMALL",
  "message": "File is empty or corrupted"
}
```

**403 - Forbidden**
```json
{
  "code": "FORBIDDEN",
  "message": "You do not own this MOC"
}
```

**404 - Not Found**
```json
{
  "code": "NOT_FOUND",
  "message": "MOC not found"
}
```

**500 - Upload Failed**
```json
{
  "code": "UPLOAD_FAILED",
  "message": "Failed to upload thumbnail. Please try again"
}
```

---

## Test Plan

### Scope Summary
- **Endpoints**: POST /api/v2/mocs/:id/thumbnail (frontend), POST /mocs/:id/thumbnail (backend)
- **UI**: ThumbnailUpload component with drag-drop, file picker, preview, validation
- **Storage**: S3 image storage, CloudFront URL conversion, database update

### Happy Path Tests

#### Test 1: Upload JPEG thumbnail via file picker
- Navigate to MOC detail page, click upload area, select JPEG (2MB), click Upload
- Expected: Preview shows, loading spinner, success toast, thumbnail displays in UI
- Evidence: POST returns 200 with CloudFront URL, S3 object created, database updated

#### Test 2: Upload PNG thumbnail via drag-and-drop
- Drag PNG file (5MB) over upload zone, drop, confirm upload
- Expected: Drag-over visual feedback, preview, upload succeeds, thumbnail replaces existing
- Evidence: POST called, response contains CloudFront URL, old S3 object deleted

#### Test 3: Replace existing thumbnail
- Upload new WebP image (3MB) when thumbnail already exists
- Expected: Old thumbnail deleted from S3, new thumbnail uploaded, database updated, UI shows new image
- Evidence: Old S3 key logged for deletion, new S3 object created, single thumbnailUrl in database

### Error Cases

#### Error 1: Reject non-image file (PDF)
- Select PDF file in file picker or drag PDF to upload zone
- Expected: Client-side validation blocks, error toast: "Only images allowed (JPEG, PNG, WebP)", upload button disabled
- Evidence: File input accept="image/*" enforced, no POST request made

#### Error 2: Reject oversized file (>10MB)
- Select 15MB JPEG file
- Expected: Client-side validation warns: "File too large. Max 10MB", upload button disabled
- Evidence: File size validation runs, no POST request sent

#### Error 3: Backend rejects invalid MIME type
- Upload file with .jpg extension but actually .exe content
- Expected: POST returns 400 with code `INVALID_MIME_TYPE`, error toast displays, security log entry
- Evidence: `file-type` library verifies content, 400 response, CloudWatch log

#### Error 4: Unauthorized upload (wrong user)
- User A attempts to upload thumbnail to User B's MOC
- Expected: 403 Forbidden, error: "You do not own this MOC"
- Evidence: Auth middleware verifies userId, no S3 upload, no DB update

#### Error 5: S3 upload failure
- S3 service temporarily unavailable
- Expected: 500 Internal Server Error, database NOT updated (transaction rollback), CloudWatch error logged
- Evidence: S3 upload throws error, transaction rolled back, no thumbnailUrl in database

### Coverage Targets
- ThumbnailUpload.tsx: 80%
- Backend route handler: 90%
- File validation utilities: 95%

---

## UI/UX Notes

### Verdict
**PASS-WITH-NOTES** - Core user journey is implementable with existing components. Notes cover MVP-critical UX patterns and accessibility requirements.

### Component Architecture

#### ThumbnailUpload Component
- **Base**: Adapt `ImageUploadZone` from `app-sets-gallery`
- **Adaptations**: `maxImages={1}`, remove reorder button, label "Thumbnail", 16:9 or 1:1 aspect ratio
- **States**: Empty, Drag-over, Preview, Uploading, Success, Error

#### ThumbnailCoverCard (Detail Page)
- **Location**: Sidebar sticky card (4 cols on desktop)
- **Layout**: Image fills card width, maintains aspect ratio, "Change Thumbnail" button on hover
- **Fallback**: Placeholder icon if no thumbnail

### Visual Design

#### Upload Zone (Empty State)
- Border: 2px dashed gray-300
- Text: "Drop image or click to upload" (gray-600)
- Subtext: "JPEG, PNG, WebP · Max 10MB" (gray-500)
- Icon: Upload icon (gray-400, 48x48px)

#### Upload Zone (Drag-Over State)
- Border: 2px solid sky-500
- Background: sky-50 (5% opacity)
- Text: "Drop to upload thumbnail" (sky-700)
- Icon: sky-500

#### Upload Zone (Preview State)
- Image preview (object-fit cover, max-height 300px)
- Filename: gray-700 (truncate if long)
- File size: gray-500
- Remove button: secondary (gray)
- Upload button: primary (sky-600)

### Accessibility (MVP-Critical)

#### Keyboard Navigation
- Tab to focus upload zone
- Enter/Space to open file picker
- Tab to focus Upload/Remove buttons
- Escape to cancel drag-over state

#### Screen Reader Support
- Upload zone: `aria-label="Upload thumbnail image"`
- File input: `aria-describedby="thumbnail-constraints"`
- Upload button: `aria-label="Upload thumbnail"`, `aria-busy="true"` during upload
- Cover card image: `alt="[MOC Title] thumbnail"`

#### Color Contrast (WCAG AA)
- Text on upload zone: gray-600 on white (≥4.5:1)
- Drag-over text: sky-700 on sky-50 (≥4.5:1)
- Button text: white on sky-600 (≥4.5:1)

### Error Messaging
Use toast notifications for all errors (not inline):
- Invalid file type: "Only images allowed (JPEG, PNG, WebP)"
- File too large: "File too large. Max 10MB"
- Network error: "Network error. Please try again"
- Upload failed: "Upload failed. Please try again"

### Mobile Considerations
- Tap upload zone to open native file picker (no drag-drop)
- Large touch targets: 44x44px minimum
- Full-width upload zone on mobile
- Preview max-height 200px on mobile

---

## Dev Feasibility

### Feasibility Summary
- **Feasible for MVP**: Yes
- **Confidence**: High
- **Why**: Direct reuse of proven patterns from wishlist domain. ImageUploadZone component is production-ready. Direct upload pattern (≤10MB) is simpler than presigned URLs.

### Effort Estimate

#### Original Estimate (Base MVP)
- **Frontend**: 1 day (8-10 hours) - Adapt ImageUploadZone, RTK Query mutation
- **Backend**: 1 day (8-10 hours) - POST route, validation, S3 upload, DB update
- **Testing**: 1 day (8-10 hours) - Unit, integration, E2E tests
- **Subtotal**: 3-4 days (24-30 hours)

#### Additional Effort (User-Selected Enhancements)
- **WebP Conversion**: 2 days (16 hours) - Sharp library integration, format conversion pipeline
- **Multiple Thumbnail Sizes**: 2 days (16 hours) - Generate 3 variants, update DB schema for variant URLs
- **Progress Indicator**: 1 day (8 hours) - Frontend progress bar, chunked upload monitoring
- **Client-Side Compression**: 1.5 days (12 hours) - Canvas API compression, quality tuning
- **EXIF Stripping**: 1 day (8 hours) - ExifReader library integration, metadata removal
- **Rate Limiting**: 1.5 days (12 hours) - Redis counter, middleware, error handling
- **Upload Analytics**: 1 day (8 hours) - CloudWatch metrics integration, dashboard setup
- **High-Res Validation**: 0.5 days (4 hours) - Image dimension check, error messaging
- **Concurrent Upload Handling**: 1.5 days (12 hours) - Upload queue state management, cancellation logic
- **Session Expiry Handling**: 1 day (8 hours) - 401 detection, retry flow, auth refresh
- **Additional Testing**: 3 days (24 hours) - Unit, integration, E2E tests for all enhancements
- **Subtotal**: ~15-20 days (120-160 hours)

#### Updated Total Estimate
- **Total**: 18-24 days (144-190 hours)
- **Timeline**: ~4-5 weeks (assuming 1 developer)

**Note**: This represents a significant scope expansion from the original MVP estimate. The base functionality (ACs 1-56) remains at 3-4 days. Enhancements (ACs 57-66) add approximately 15-20 additional days.

### Risks (MVP-Critical)

#### Risk 1: INST-1102 Dependency (MEDIUM)
- This story requires MOC creation endpoint (POST /mocs) to be functional
- **Mitigation**: Can develop in parallel, mock MOC creation in tests, E2E tests depend on INST-1102
- **Blocking for MVP**: No (only E2E tests blocked)

#### Risk 2: S3 CORS Configuration (LOW)
- S3 bucket must allow multipart/form-data uploads
- **Mitigation**: Wishlist domain already has S3 CORS configured, reuse same policy
- **Blocking for MVP**: No (already solved)

### Architecture Assessment

#### Component Reuse (HIGH Confidence)
- **ImageUploadZone**: 95% reuse (minimal adaptation)
- **File Validation**: 100% reuse (direct import)
- **S3 Storage Adapter**: 80% reuse (adapt key pattern)

#### Backend Complexity (LOW)
- Direct upload pattern is simple (no presigned URLs or chunking)
- Proven pattern from wishlist domain
- Transaction safety ensures consistency

### Recommendation
**Proceed with story implementation.** High reuse potential, low technical complexity, clear requirements, proven patterns, reasonable effort estimate (3-4 days).

---

## Reality Baseline

### Existing Features Referenced
- **ImageUploadZone**: Production component in `app-sets-gallery` with drag-drop, validation, preview
- **Wishlist Upload**: Proven patterns in `wishlist/routes.ts` and `wishlist/adapters/storage.ts`
- **File Validation**: Production utilities in `core/utils/file-validation.ts`
- **S3 Storage**: Established in wishlist domain with CloudFront integration

### Active In-Progress Work
- **INST-1102 (Create Basic MOC)**: Ready to Work - Creates POST /mocs endpoint (dependency for E2E tests)
- **INST-1101 (View MOC Details)**: Ready to Work - Will display uploaded thumbnail
- **INST-1100 (View MOC Gallery)**: Ready to Work - Will display thumbnail in gallery cards

### Constraints Applied
- **ADR-001**: Frontend uses `/api/v2/mocs/:id/thumbnail`, Backend uses `/mocs/:id/thumbnail`
- **ADR-003**: Store in S3 with CloudFront URL conversion
- **ADR-005**: UAT must use real services, not mocks
- **ADR-006**: At least one happy-path E2E test required
- **CLAUDE.md**: All types use Zod schemas with `z.infer<>`, no TypeScript interfaces
- **CLAUDE.md**: Use `@repo/app-component-library` for all UI components
- **CLAUDE.md**: NO barrel files - import directly from source files

### Protected Features
None - This is a new feature with no conflicts.

---

## Seed Requirements

This story was generated from STORY-SEED.md with the following context:
- **Baseline Status**: No active baseline file (generated from codebase scanning)
- **Conflicts Found**: 1 blocking conflict (INST-1102 dependency - resolved as non-blocking for development)
- **Lessons Loaded**: No (knowledge base unavailable)
- **ADRs Loaded**: Yes (4 ADRs applied: ADR-001, ADR-003, ADR-005, ADR-006)

---

## Success Criteria

- [ ] All 66 acceptance criteria met (48 original + 8 architecture + 10 enhancements)
- [ ] Test coverage targets met (80% frontend, 90% backend)
- [ ] At least one E2E happy path test passes
- [ ] No security validation bypasses
- [ ] Mobile upload works
- [ ] Keyboard navigation functional
- [ ] Integration with gallery and detail pages confirmed
- [ ] Service layer architecture implemented per api-layer.md
- [ ] All performance, security, and edge case enhancements verified in UAT
