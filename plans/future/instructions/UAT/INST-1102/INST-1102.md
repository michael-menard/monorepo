---
story_id: INST-1102
title: Create Basic MOC
status: uat
size_estimate: 3
priority: high
created: 2026-02-05
updated: 2026-02-07
phase: 1
blocked_by: [INST-1008]
tags: [crud, create, form, vertical-slice]
---

# INST-1102: Create Basic MOC

## Context

The MOC Instructions feature allows users to manage their custom LEGO builds. The `moc_instructions` database table exists with all required fields (title, description, theme, tags). Users currently have no way to add MOCs to their collection. This story implements the first MOC create flow, establishing UX patterns for the entire Instructions feature domain.

The wishlist domain provides proven patterns for create pages with form validation, optimistic UI, and error recovery (WISH-2002, WISH-2032). This story follows those patterns while introducing MOC-specific fields (theme selection, MOC-specific tags).

---

## Goal

Enable users to create a new MOC with basic metadata (title, description, theme, tags) through a validated form, establishing the foundation for file uploads (INST-1103+) and detail viewing (INST-1101).

---

## Non-Goals

- File uploads (thumbnails, instructions, parts lists) - covered by INST-1103, INST-1104, INST-1106
- Edit functionality - covered by INST-1108
- Delete functionality - covered by INST-1109
- MOC detail page display - covered by INST-1101
- Gallery page implementation - covered by INST-1100
- Image optimization or variants - covered by Phase 4 stories
- Full-text search or filtering - covered by Phase 6 stories

---

## Scope

### Frontend

**Package**: `apps/web/app-instructions-gallery`

**New Files**:
- `src/pages/CreateMocPage.tsx` - Main create page component
- `src/pages/__tests__/CreateMocPage.test.tsx` - Unit tests
- `src/pages/__tests__/CreateMocPage.integration.test.tsx` - Integration tests
- `src/components/MocForm/index.tsx` - Reusable form component (optional)
- `src/components/MocForm/__tests__/MocForm.test.tsx` - Form tests

**Modified Files**:
- `src/routes.ts` - Add `/mocs/new` route

**Key Features**:
- Form with fields: title (required), description (optional), theme (select), tags (multi-select)
- Inline validation with error messages
- Submit button disabled until valid
- Auto-focus title on mount
- Optimistic UI with immediate navigation
- Error recovery with localStorage persistence
- Escape key to cancel

### Backend

**Package**: `apps/api/lego-api`

**New Files**:
- `domains/mocs/routes.ts` - Hono router with POST /mocs
- `domains/mocs/types.ts` - Zod schemas and types
- `domains/mocs/application/index.ts` - Service factory
- `domains/mocs/application/services.ts` - Business logic
- `domains/mocs/adapters/index.ts` - Adapter factory
- `domains/mocs/adapters/repositories.ts` - Database operations
- `domains/mocs/ports/index.ts` - Port interfaces
- `domains/mocs/__tests__/routes.test.ts` - Route tests
- `domains/mocs/__tests__/services.test.ts` - Service tests

**Modified Files**:
- `server.ts` - Mount `/mocs` routes

**Key Features**:
- `POST /mocs` endpoint with Zod validation
- Auth, permissions, and feature gate middleware
- Service/repository architecture
- Slug generation from title
- Error handling with structured responses

### Database

**Package**: `packages/backend/database-schema`

**No Changes Required**: Table `moc_instructions` exists with all required fields.

**Table**: `moc_instructions`
- `id` (uuid, PK) - Generated
- `user_id` (text) - From auth context
- `title` (text) - Required, min 3 chars
- `description` (text) - Optional
- `theme` (text) - Required
- `tags` (jsonb) - Array of strings
- `type` (text) - Set to "MOC"
- `created_at` (timestamp) - Auto
- `updated_at` (timestamp) - Auto

### Shared Packages

**RTK Query** (`@repo/api-client`):
- Depends on INST-1008 for `useCreateMocMutation`

---

## Acceptance Criteria

- [ ] **AC-1**: User can navigate to `/mocs/new` from gallery page "Create MOC" button (INST-1100)
- [ ] **AC-2**: Create page renders form with fields: title (required, min 3 chars), description (optional), theme (select dropdown), tags (multi-select)
- [ ] **AC-3**: Title field auto-focuses on page load
- [ ] **AC-4**: Form shows inline validation errors for invalid fields (title required, title min length)
- [ ] **AC-5**: Submit button is disabled until title meets minimum length requirement
- [ ] **AC-6**: Form submission triggers `useCreateMocMutation` from `@repo/api-client`
- [ ] **AC-7**: Success shows toast notification "MOC created!" and redirects to `/mocs/:id`
- [ ] **AC-8**: Backend `POST /mocs` endpoint validates request with Zod schema
- [ ] **AC-9**: Backend extracts `userId` from auth context middleware (`c.get('userId')`)
- [ ] **AC-10**: Backend generates URL-friendly slug from title for future use
- [ ] **AC-11**: Backend inserts record into `moc_instructions` table with all fields
- [ ] **AC-12**: Backend returns 201 with created MOC including `id`, `title`, `description`, `theme`, `tags`, `slug`, `createdAt`
- [ ] **AC-13**: Validation errors from API (e.g., duplicate title, invalid theme) display in form
- [ ] **AC-14**: Escape key cancels form and navigates back to gallery page
- [ ] **AC-15**: Form state persists to localStorage on submission failure for recovery

---

## Reuse Plan

### Components (from @repo/app-component-library)

- `Button` - Submit, cancel, back button
- `Input` - Title field
- `Textarea` - Description field (4 rows)
- `Label` - Field labels with required indicator
- `Select`, `SelectContent`, `SelectItem`, `SelectTrigger`, `SelectValue` - Theme dropdown

### Components (from app-wishlist-gallery)

- **TagInput** - Multi-select tags component (direct copy, 100% reuse)
- **AddItemPage.tsx** - Structure template (80% reuse)
- **WishlistForm** - Form validation pattern reference (70% reuse)

### Hooks

- `useNavigate` from `@tanstack/react-router` - Navigation
- `useLocalStorage` - Form recovery pattern (from wishlist)
- `useCreateMocMutation` from `@repo/api-client/rtk/mocs-api` - API mutation (INST-1008)

### Patterns

**Frontend**:
- Form validation with Zod schema
- Inline error display with field-level messages
- Submit button disabled state based on validation
- Optimistic UI with immediate navigation (WISH-2032 pattern)
- localStorage recovery on failure
- Focus management (auto-focus title)
- Keyboard shortcuts (Escape to cancel)

**Backend**:
- Hono route structure with middleware chain
- Service/repository architecture
- Zod validation schemas
- Discriminated union result types
- Structured error responses

---

## Architecture Notes

### Frontend Architecture

**Pattern**: Vertical slice with co-located tests

```
CreateMocPage
‚îú‚îÄ‚îÄ Form State Management (useState hooks)
‚îú‚îÄ‚îÄ Validation Logic (Zod schema)
‚îú‚îÄ‚îÄ Submission Handler (useCreateMocMutation)
‚îú‚îÄ‚îÄ Success Flow (toast + navigation)
‚îî‚îÄ‚îÄ Error Recovery (localStorage + retry)
```

**Data Flow**:
```
User Input ‚Üí Validation ‚Üí Enabled Submit
  ‚Üì
Submit Click ‚Üí Optimistic UI (toast + navigate)
  ‚Üì
API Call (useCreateMocMutation)
  ‚Üì
Success: Stay on detail page
Error: Navigate back + show error + persist form data
```

### Backend Architecture

**Pattern**: Clean architecture with ports/adapters

```
Route (HTTP) ‚Üí Service (Business Logic) ‚Üí Repository (Database)
```

**Middleware Chain**:
```
Request
  ‚Üì
auth (verify JWT)
  ‚Üì
loadPermissions (fetch user permissions)
  ‚Üì
requireFeature('instructions') (check feature access)
  ‚Üì
Route Handler (validation + service call)
  ‚Üì
Response
```

### API Contract

**Request**:
```typescript
POST /api/v2/mocs
Content-Type: application/json

{
  "title": "My Castle MOC",
  "description": "A medieval castle with drawbridge",
  "theme": "Castle",
  "tags": ["medieval", "castle", "architecture"]
}
```

**Response (201 Created)**:
```typescript
{
  "id": "abc123-def456-...",
  "userId": "user-789",
  "title": "My Castle MOC",
  "description": "A medieval castle with drawbridge",
  "theme": "Castle",
  "tags": ["medieval", "castle", "architecture"],
  "slug": "my-castle-moc",
  "createdAt": "2026-02-05T12:00:00Z",
  "updatedAt": "2026-02-05T12:00:00Z"
}
```

**Response (400 Validation Error)**:
```typescript
{
  "error": "VALIDATION_ERROR",
  "details": {
    "fieldErrors": {
      "title": ["Title must be at least 3 characters"]
    }
  }
}
```

---

## Infrastructure Notes

### Database Indexing

**Recommended Index** (for future list queries):
```sql
CREATE INDEX idx_moc_instructions_user_created
ON moc_instructions(user_id, created_at DESC);
```

**Rationale**: Optimizes query for listing user's MOCs sorted by creation date (INST-1100).

---

## HTTP Contract Plan

### Endpoint: POST /mocs

| Aspect | Specification |
|--------|---------------|
| **Path** | Frontend: `/api/v2/mocs`, Backend: `/mocs` |
| **Method** | POST |
| **Auth** | Required (JWT token) |
| **Content-Type** | `application/json` |
| **Response Type** | `application/json` |

### Request Body Schema

```typescript
{
  title: string (min 3 chars, required)
  description?: string (optional)
  theme: string (required, from dropdown)
  tags?: string[] (optional, default [])
}
```

### Response Codes

| Code | Meaning | Response Body |
|------|---------|---------------|
| 201 | Created | MocResponse object |
| 400 | Validation Error | `{ error, details }` |
| 401 | Unauthorized | `{ error: "UNAUTHORIZED" }` |
| 403 | Forbidden | `{ error: "FORBIDDEN" }` (feature gate) |
| 500 | Server Error | `{ error: "DB_ERROR" }` |

### ADR-001 Compliance

- Frontend uses `/api/v2/mocs` (production path)
- Backend uses `/mocs` (simple path)
- Vite proxy rewrites for local dev
- MSW handlers use `/api/v2/mocs` for E2E tests

---

## Test Plan

### Unit Tests (Frontend)

**Location**: `apps/web/app-instructions-gallery/src/pages/__tests__/CreateMocPage.test.tsx`

**Coverage**: 95%+

**Test Cases**:
- Form renders all required fields
- Title field auto-focuses on mount
- Validation: title required
- Validation: title minimum length (3 chars)
- Submit button disabled when invalid
- Loading state during submission
- Tag input: add and remove tags
- Escape key cancels form

### Integration Tests (Frontend)

**Location**: `apps/web/app-instructions-gallery/src/pages/__tests__/CreateMocPage.integration.test.tsx`

**Framework**: Vitest + MSW

**Test Cases**:
- Successful MOC creation with redirect
- POST request body validation
- API validation errors displayed in form
- Network error handling with retry
- Form state recovery in localStorage

### Unit Tests (Backend)

**Location**: `apps/api/lego-api/domains/mocs/__tests__/routes.test.ts`

**Coverage**: 90%+

**Test Cases**:
- Creates MOC with valid data (201 response)
- Validation: title required (400)
- Validation: title minimum length (400)
- Sets userId from auth context
- Generates slug from title
- Requires authentication (401)

### E2E Tests (Playwright - Live API)

**Location**: `apps/web/playwright/tests/instructions/inst-1102-create.spec.ts`

**Configuration**: `playwright.legacy.config.ts` (live API, no MSW)

**Test Cases** (ADR-006 Required):
- **Happy Path** (CRITICAL): User creates MOC from gallery ‚Üí form ‚Üí success ‚Üí detail page
- Validation prevents empty submission
- Escape key returns to gallery

### Coverage Matrix

| AC | Unit | Integration | E2E |
|----|------|-------------|-----|
| AC-1 to AC-15 | ‚úÖ | ‚úÖ | ‚úÖ |

All 15 acceptance criteria covered by at least one test level.

---

## UI/UX Notes

### Page Layout

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [< Back to Gallery]                         ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ # Add New MOC                               ‚îÇ
‚îÇ Create a new MOC to add to your collection. ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  Title *                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ  [_______________________________]       ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ  Description                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ  [_______________________________]       ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ  Theme *                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ  [Select a theme              ‚ñº]         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ  Tags                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ  [+ Add tags                  ]          ‚îÇ ‚îÇ
‚îÇ ‚îÇ  [medieval √ó] [castle √ó]                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ              [Cancel] [Create MOC ‚Üí]     ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Theme Options (Recommended)

- Castle
- Space
- City
- Technic
- Creator
- Star Wars
- Harry Potter
- Marvel
- DC
- Friends
- Other

**Note**: Final theme list to be confirmed in elaboration phase.

### Accessibility

- All fields have proper `<Label>` with `htmlFor`
- Required fields indicated visually (`*`) and with `required` attribute
- Error messages linked via `aria-describedby`
- `aria-invalid` set on fields with errors
- Keyboard navigation (Tab, Enter, Escape)
- Focus management on mount and after errors
- Color contrast meets WCAG AA (4.5:1)

### Responsive Behavior

- **Desktop** (‚â•1024px): Centered form with `max-w-2xl`
- **Tablet** (768px-1023px): Full width with padding
- **Mobile** (<768px): Full width, larger touch targets (44x44px)

---

## Reality Baseline

### What Exists

| Feature | Status | Location |
|---------|--------|----------|
| Database Table | ‚úÖ Exists | `packages/backend/database-schema/src/migrations/app/0000_productive_puppet_master.sql` |
| Wishlist Create Pattern | ‚úÖ Production | `apps/web/app-wishlist-gallery/src/pages/AddItemPage.tsx` |
| TagInput Component | ‚úÖ Production | `apps/web/app-wishlist-gallery/src/components/TagInput/` |
| Auth Middleware | ‚úÖ Production | `apps/api/lego-api/middleware/auth.ts` |
| Zod Validation | ‚úÖ Established | `packages/core/api-client/src/schemas/` |

### What Is In-Progress

- üöß **INST-1008**: Wire RTK Query Mutations (UAT - should be ready soon)
  - Blocks: `useCreateMocMutation` hook may not exist yet
  - Resolution: Wait for INST-1008 merge before starting frontend implementation

### What Is Assumed (But Needs Verification)

1. **Type Field Value**: Assuming `type = "MOC"` for created MOCs (needs confirmation)
2. **Slug Storage**: Assuming slug can be stored in `set_number` field (or needs new column?)
3. **Feature Gate**: Assuming route uses `requireFeature('instructions')` (or 'mocs'?)
4. **Theme List**: Assuming standard LEGO themes (needs definitive list from PM)

### Architecture Decisions (ADRs) Applied

| ADR | Title | Application |
|-----|-------|-------------|
| **ADR-001** | API Path Schema | Frontend: `/api/v2/mocs`, Backend: `/mocs` |
| **ADR-005** | UAT Must Use Real Services | E2E tests use live API, no MSW |
| **ADR-006** | E2E Required in Dev Phase | At least one happy-path E2E test required |

### Patterns Established

**From Wishlist Domain**:
- Form validation with inline errors
- Optimistic UI with immediate navigation
- Error recovery with localStorage
- Auto-focus on mount
- Keyboard shortcuts (Escape to cancel)

**From Project Standards** (CLAUDE.md):
- All types use Zod schemas (no TypeScript interfaces)
- No barrel files (direct imports)
- Use `@repo/app-component-library` for UI
- Use `@repo/logger` for logging (not console.log)

---

## Blocked By

- **INST-1008**: Wire RTK Query Mutations (UAT)
  - Status: In UAT as of 2026-02-05
  - Impact: Frontend needs `useCreateMocMutation` hook
  - Mitigation: Story is ready for implementation once INST-1008 merges

---

## Unblocks

- **INST-1101**: View MOC Details (redirect target)
- **INST-1103**: Upload Thumbnail (needs created MOC)
- **INST-1104**: Upload Instructions Direct (needs created MOC)
- **INST-1106**: Upload Parts List (needs created MOC)
- **INST-1108**: Edit MOC Metadata (needs MOC to edit)

---

## Dependencies

### Required Before Implementation

- ‚úÖ Database table `moc_instructions` (exists)
- ‚ö†Ô∏è INST-1008: RTK Query mutations (in UAT)

### Optional/Parallel

- INST-1100: View MOC Gallery (provides navigation source, can implement independently)
- INST-1101: View MOC Details (provides redirect target, can stub for now)

---

## Questions for Elaboration

1. **Type Field**: What value should `moc_instructions.type` be set to? (Likely "MOC")
2. **Slug Storage**: Should slug be stored in `set_number` field or new `slug` column?
3. **Slug Uniqueness**: How to handle duplicate slugs? (Recommend: append UUID)
4. **Theme List**: What are the definitive theme options for dropdown?
5. **Feature Gate**: Should route use `requireFeature('mocs')` or `requireFeature('instructions')`?
6. **Tag Limits**: Maximum tags per MOC? Maximum tag length?
7. **Title Uniqueness**: Should titles be unique per user?

---

## Size Estimate

**Points**: 3

**Breakdown**:
- Frontend: 1.75 days (14 hours)
- Backend: 1.5 days (12 hours)
- Testing: included in above
- Buffer: 0.75 days (coordination, review)
- **Total**: 3-4 days

**Rationale**:
- High reuse from wishlist domain (~50% time savings)
- Straightforward CRUD create operation
- Database schema exists
- Established testing patterns

---

## Related Stories

| Story ID | Relation | Notes |
|----------|----------|-------|
| INST-1008 | Blocks | RTK Query mutations |
| INST-1100 | Provides Context | Gallery page with create button |
| INST-1101 | Redirect Target | Detail page for success redirect |
| INST-1103 | Unblocked By | Thumbnail upload needs created MOC |
| INST-1104 | Unblocked By | Instructions upload needs created MOC |
| INST-1108 | Unblocked By | Edit needs MOC to edit |

---

## Agent Log

| Timestamp | Agent | Action |
|-----------|-------|--------|
| 2026-02-05 | Claude Sonnet 4.5 | Story seed generated from codebase scanning |
| 2026-02-05 | Claude Sonnet 4.5 | PM workers executed (Test Plan, UI/UX, Dev Feasibility) |
| 2026-02-05 | Claude Sonnet 4.5 | Story synthesized from worker outputs |
| 2026-02-05 | Claude Sonnet 4.5 | Story status: backlog (ready for elaboration) |
| 2026-02-05 | elab-analyst | Elaboration analysis complete |
| 2026-02-05 | elab-completion-leader | Story elaborated, moved to ready-to-work |

---

## QA Discovery Notes (for PM Review)

_Added by QA Elaboration on 2026-02-05_

### Elaboration Decisions

| # | Question | Decision | Notes |
|---|----------|----------|-------|
| 1 | Slug Uniqueness | UUID suffix | Append short UUID on collision: `my-castle-moc-a1b2` |
| 2 | Theme List | 11 themes confirmed | Castle, Space, City, Technic, Creator, Star Wars, Harry Potter, Marvel, DC, Friends, Other |
| 3 | TagInput Source | Use MocEdit/TagInput | Use existing `app-instructions-gallery/src/components/MocEdit/TagInput.tsx` |
| 4 | Feature Gate | `instructions` | Use `requireFeature('instructions')` for consistency with epic |

### Verified Discoveries

| Discovery | Finding |
|-----------|---------|
| RTK hooks | `useCreateMocMutation` already exported from `instructions-api.ts` |
| Slug column | `slug` column exists in `moc_instructions` table |
| Title uniqueness | `uniqueUserTitle` index on (userId, title) - backend must handle 409/400 |
| TagInput | `MocEdit/TagInput.tsx` exists in app-instructions-gallery |

### Follow-up Stories Suggested

- [ ] COMP-XXX: Extract TagInput to @repo/app-component-library
- [ ] HOOK-XXX: Extract useFormRecovery hook to shared package

### Out-of-Scope Items

- Auto-save draft mode (deferred - MVP uses error recovery only)
- Duplicate title pre-check (MVP handles via API error response AC-13)
- Rich text description (MVP uses simple textarea)
- Image upload on create (covered by INST-1103)
