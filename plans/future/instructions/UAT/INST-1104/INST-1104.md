---
story_id: INST-1104
title: Upload Instructions (Direct ≤10MB)
feature: instructions
status: uat
story_type: feature
priority: high
points: 3
created_at: 2026-02-06
updated_at: 2026-02-07T19:45:00Z
touches_frontend: true
touches_backend: true
touches_database: true
touches_infra: false
blocked_by: [INST-1102]
---

# INST-1104: Upload Instructions (Direct ≤10MB)

## Context

The MOC Instructions feature allows users to manage their custom LEGO builds. After creating a MOC (INST-1102), users need to upload PDF instruction files so others can build their designs. The `moc_files` database table is designed to store file metadata with `type='instruction'`.

### Existing Infrastructure

The backend already has core infrastructure in place:
- **POST /mocs/:id/files/instruction endpoint**: Implemented in `routes.ts` (lines 198-237)
- **InstructionsService.uploadInstructionFile()**: Business logic for file uploads
- **FileStorage.uploadFile()**: S3 upload adapter
- **RTK Query mutation**: `useUploadInstructionFileMutation` in `instructions-api.ts` (lines 258-291)
- **S3 + CloudFront**: Storage infrastructure with CDN integration

### Problem

Users need to upload PDF instruction files for their MOCs. Without this capability, the MOC Instructions gallery is incomplete - users can create MOCs and add thumbnails (INST-1103) but cannot share the actual building instructions. Limiting to 10MB for direct upload keeps the flow simple and avoids presigned URL complexity for most use cases.

### Solution

Implement instruction file upload functionality as a vertical slice:
- **Frontend**: File picker component for PDF selection with validation
- **Backend**: Verify existing POST `/mocs/:id/files/instruction` endpoint, add PDF validation
- **Storage**: Upload to S3 with key `mocs/{userId}/{mocId}/instructions/{uuid}-{filename}`
- **Database**: Insert `moc_files` record with `type='instruction'`
- **Validation**: Server-side PDF MIME type, file size (≤10MB), and extension validation
- **Multiple files**: Support uploading multiple instruction PDFs per MOC

---

## Goal

Enable users to upload PDF instruction files (≤10MB) for their MOCs using direct upload, with support for multiple files per MOC.

---

## Non-Goals

- Presigned URL upload for >10MB files (covered by INST-1105)
- Virus scanning (covered by INST-2031)
- PDF thumbnail generation/preview (covered by INST-2032)
- Drag-and-drop upload zone (covered by INST-2035)
- Progress bar with percentage (simple loading spinner sufficient for MVP)
- File reordering (covered by INST-3020)
- Batch upload with single request (sequential individual uploads acceptable)
- Gallery image uploads (covered by INST-2030)
- Parts list uploads (covered by INST-1106)
- Image instruction files (PDF only for MVP)

---

## Scope

### Frontend Components
- `InstructionsUpload` component (new - file picker for PDFs)
- Integration in MOC detail page (`/mocs/:id`)
- `InstructionsFileList` component (display uploaded files)

### Backend Endpoints
- Verify `POST /mocs/:id/files/instruction` - Upload instruction file
- Add PDF validation to file validation utilities

### Database
- Insert records into `moc_files` table with `type='instruction'`

### Infrastructure
- S3 storage for PDF files
- CloudFront URL conversion

---

## Acceptance Criteria

### Frontend (apps/web/app-instructions-gallery)

#### Upload Component
- [ ] **AC1**: Instructions upload component renders on MOC detail page (`/mocs/:id`)
- [ ] **AC2**: "Add Instructions" button visible in Instructions card
- [ ] **AC3**: File picker accepts PDF files only (`accept="application/pdf"`)
- [ ] **AC4**: File picker supports multiple file selection (`multiple` attribute)
- [ ] **AC5**: Click "Add Instructions" opens file picker

#### Client-Side Validation
- [ ] **AC6**: Client-side validation rejects non-PDF files (alert: "Only PDF files allowed")
- [ ] **AC7**: Client-side validation rejects files >10MB (alert: "File too large. Max 10MB per file")
- [ ] **AC8**: Client validation shows upgrade hint for >10MB: "Use presigned upload for larger files (coming soon)"

#### File Selection Display
- [ ] **AC9**: Selected files display in list with filename and size
- [ ] **AC10**: Each file shows "Remove" button before upload
- [ ] **AC11**: File size formatted as "5 MB", "2.3 MB", etc.
- [ ] **AC12**: File count displayed: "Selected Files (3)"

#### Upload Flow
- [ ] **AC13**: "Upload" button triggers `useUploadInstructionFileMutation` for each file
- [ ] **AC14**: Files upload sequentially (one at a time)
- [ ] **AC15**: Upload progress shows for each file (loading spinner)
- [ ] **AC16**: Current upload status displayed: "Uploading 2 of 5..."
- [ ] **AC17**: Upload button disabled during upload
- [ ] **AC18**: Cancel button aborts remaining uploads

#### Success & Error Handling
- [ ] **AC19**: Success shows toast "Instructions uploaded!" and updates file list
- [ ] **AC20**: Uploaded files appear in instructions list immediately (no page reload)
- [ ] **AC21**: Each uploaded file shows download button
- [ ] **AC22**: Errors from API display as toast notifications with specific error message
- [ ] **AC23**: Network errors display as toast: "Upload failed. Please try again."

### Backend (apps/api/lego-api/domains/instructions)

#### Endpoint Verification
- [ ] **AC24**: Verify `POST /mocs/:id/files/instruction` endpoint exists and is functional
- [ ] **AC25**: Endpoint accepts multipart/form-data with `file` field
- [ ] **AC26**: Endpoint requires authentication (auth middleware)
- [ ] **AC27**: Endpoint requires feature gate `requireFeature('moc')`

#### Authorization
- [ ] **AC28**: Authorization check: userId from auth context must match MOC owner
- [ ] **AC29**: Return 404 if MOC not found
- [ ] **AC30**: Return 403 if user does not own the MOC

#### PDF File Validation
- [ ] **AC31**: Validate MIME type: `application/pdf` only
- [ ] **AC32**: Return 400 with code `INVALID_FILE` if MIME type is not PDF
- [ ] **AC33**: Validate file size: 1 byte ≤ size ≤ 10MB
- [ ] **AC34**: Return 400 with code `INVALID_FILE` if file too large or too small
- [ ] **AC35**: Validate file extension: `.pdf` only (case-insensitive)
- [ ] **AC36**: Security logging for rejected uploads (invalid type, oversized, zero-byte)

#### Storage & Database
- [ ] **AC37**: Upload file to S3 with key pattern: `mocs/{userId}/{mocId}/instructions/{uuid}-{filename}`
- [ ] **AC38**: Sanitize filename (remove special characters, add UUID prefix to prevent collisions)
- [ ] **AC39**: Insert `moc_files` record with `type='instruction'`, filename, size, S3 key, uploadedAt
- [ ] **AC40**: Return 201 with response: `MocFile { id, mocId, type, name, size, url, uploadedAt }`
- [ ] **AC41**: CloudFront URL returned in response (S3 URL converted)
- [ ] **AC42**: Transaction ensures DB insert only if S3 upload succeeds (rollback on failure)

#### Multiple Files Support
- [ ] **AC43**: Support multiple instruction files per MOC (no replacement, append to list)
- [ ] **AC44**: No limit on number of instruction files per MOC (within storage quota)

#### Error Handling
- [ ] **AC45**: Handle S3 upload failures gracefully with 500 error and structured logging
- [ ] **AC46**: Return specific error message: "Only PDF files are allowed" for MIME type failure
- [ ] **AC47**: Return specific error message: "File size exceeds maximum limit of 10MB" for size failure

#### Validation Implementation (Added via elaboration analysis)
- [ ] **AC72**: Backend uses validatePdfFile() utility from file-validation.ts for all PDF validation
- [ ] **AC73**: Backend enforces MAX_FILE_SIZE constant of 10MB (not 100MB) for direct upload endpoint
- [ ] **AC74**: Backend validation returns structured error codes: 'INVALID_MIME_TYPE', 'INVALID_EXTENSION', 'FILE_TOO_LARGE'

### Database

#### Schema
- [ ] **AC48**: `moc_files` record inserted with `type='instruction'`
- [ ] **AC49**: File metadata stored: `mocId`, `name`, `size`, `s3Key`, `uploadedAt`
- [ ] **AC50**: Multiple instruction files per MOC supported (no unique constraint on type)

### Testing

#### Unit Tests (Frontend)
- [ ] **AC51**: Unit test: `InstructionsUpload.test.tsx` - Component renders
- [ ] **AC52**: Unit test: Validates PDF file type (rejects JPEG, TXT)
- [ ] **AC53**: Unit test: Validates file size (rejects >10MB, accepts ≤10MB)
- [ ] **AC54**: Unit test: Multiple files supported in selection list
- [ ] **AC55**: Unit test: Remove button removes file from selection

#### Unit Tests (Backend)
- [ ] **AC56**: Unit test: Backend service validates PDF MIME type
- [ ] **AC57**: Unit test: Backend service validates file size (1 byte to 10MB)
- [ ] **AC58**: Unit test: Backend service validates PDF file extension
- [ ] **AC59**: Unit test: Authorization check prevents unauthorized uploads

#### Integration Tests
- [ ] **AC60**: Integration test: `InstructionsUpload.integration.test.tsx` - POST endpoint called correctly
- [ ] **AC61**: Integration test: MSW handler for `/api/v2/mocs/:id/files/instruction` returns success
- [ ] **AC62**: Integration test: MSW handler returns error for invalid file
- [ ] **AC63**: Integration test: File metadata returned matches MocFile schema
- [ ] **AC64**: Integration test: Cache invalidation triggers after successful upload

#### E2E Tests (Playwright + Cucumber)
- [ ] **AC65**: E2E test: `inst-1104-upload-direct.feature` - Upload single 5MB PDF
- [ ] **AC66**: E2E test: File uploads successfully, appears in instructions list
- [ ] **AC67**: E2E test: Upload multiple PDFs (2-3 files) sequentially
- [ ] **AC68**: E2E test: All files appear in list after upload
- [ ] **AC69**: E2E test: Reject 15MB PDF with error message (presigned flow hint)
- [ ] **AC70**: E2E test: Reject JPEG file with error "Only PDF files allowed"
- [ ] **AC71**: E2E test: Download button functional for uploaded files

---

## Reuse Plan

### Frontend Components
- **From @repo/app-component-library/_primitives**:
  - `Button` - "Add Instructions", Upload button, Remove button, Download button
  - `Card` - InstructionsFileList wrapper
  - `Label` - Labels for file inputs
  - `Toast` - Success/error notifications
  - `Spinner` - Loading state during upload
  - `Badge` - File size badge, file count indicator

### Backend Utilities
- **From core/utils/file-validation.ts**:
  - `validateFileSize()` - Reuse existing size validation (1 byte to 10MB)
  - `createSecurityEvent()`, `logSecurityEvent()` - Security logging for rejected uploads
  - **NEW**: `validatePdfMimeType()` - PDF MIME type validation (`['application/pdf']`)
  - **NEW**: `validatePdfExtension()` - PDF extension validation (`['.pdf']`)
  - **NEW**: `validatePdfFile()` - Combined PDF validation (MIME + extension + size)

### Backend Implementation (Existing)
- **instructionsService.uploadInstructionFile()**: Business logic (already exists)
- **fileStorage.uploadFile()**: S3 upload adapter (already exists)
- **fileRepo.insert()**: Database insert (already exists)

### RTK Query Mutation (Existing)
- **useUploadInstructionFileMutation**: From `@repo/api-client/rtk/instructions-api.ts` (lines 258-291)
- Cache invalidation: `['Moc', 'MocFile']`
- FormData handling: `formData.append('file', file)`

### Database Patterns
- Insert query: `INSERT INTO moc_files (mocId, type, name, size, s3Key, uploadedAt) VALUES (...)`
- Transaction wrapper to rollback on S3 failure

---

## Architecture Notes

### Frontend Architecture

**Component Structure:**
```
InstructionsUpload/
  index.tsx               # Main component
  __tests__/
    InstructionsUpload.test.tsx
  __types__/
    index.ts              # Zod schemas for file validation
```

**Key Interactions:**
1. User clicks "Add Instructions" → opens file picker
2. User selects PDF files → client validates type/size
3. User clicks "Upload" → calls `useUploadInstructionFileMutation` for each file
4. Mutation success → invalidates cache, refetches MOC detail
5. File list updates without page reload

**State Management:**
- Selected files: Local component state
- Upload progress: RTK Query mutation loading state
- Uploaded files: RTK Query cache (from GET /mocs/:id)

### Backend Architecture

**Service Layer:**
```typescript
async uploadInstructionFile(
  userId: string,
  mocId: string,
  file: UploadedFile,
): Promise<Result<MocFile, InstructionsError>> {
  // 1. Authorization check (user owns MOC)
  // 2. Validate PDF file (MIME type, extension, size)
  // 3. Generate S3 key with UUID prefix
  // 4. Upload to S3
  // 5. Insert moc_files record
  // 6. Return MocFile with CloudFront URL
}
```

**Error Handling:**
- `NOT_FOUND`: MOC does not exist (404)
- `FORBIDDEN`: User does not own MOC (403)
- `INVALID_FILE`: Validation failure (400)
- `UPLOAD_FAILED`: S3 or database error (500)

**Transaction Safety:**
```typescript
try {
  const s3Url = await fileStorage.uploadFile(buffer, s3Key, mimetype)
  const fileRecord = await fileRepo.insert({ ... })
  return ok(fileRecord)
} catch (error) {
  // Rollback: S3 upload may succeed, but DB insert fails
  // Cleanup handled by orphaned file cleanup job (INST-1204)
  return err('UPLOAD_FAILED')
}
```

### Database Schema

**moc_files table:**
```sql
CREATE TABLE moc_files (
  id UUID PRIMARY KEY,
  moc_id UUID NOT NULL REFERENCES moc_instructions(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL, -- 'instruction' | 'parts-list' | 'thumbnail' | 'gallery-image'
  name VARCHAR(255) NOT NULL,
  size INTEGER NOT NULL,
  s3_key VARCHAR(500) NOT NULL,
  url VARCHAR(500) NOT NULL,
  uploaded_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_moc_files_moc_id ON moc_files(moc_id);
CREATE INDEX idx_moc_files_type ON moc_files(type);
```

**Multiple files per MOC:**
- No unique constraint on (moc_id, type) to allow multiple instruction files
- Each file has unique ID and S3 key
- Query: `SELECT * FROM moc_files WHERE moc_id = $1 AND type = 'instruction' ORDER BY uploaded_at DESC`

---

## Infrastructure Notes

### S3 Configuration

**Bucket**: Reuse existing MOC instructions bucket

**Key Pattern**: `mocs/{userId}/{mocId}/instructions/{uuid}-{filename}`
- `{userId}`: User's UUID (for organization)
- `{mocId}`: MOC's UUID
- `{uuid}`: Random UUID to prevent filename collisions
- `{filename}`: Sanitized original filename

**CORS Policy**:
```json
{
  "AllowedOrigins": ["http://localhost:5173", "https://app.example.com"],
  "AllowedMethods": ["GET", "POST", "PUT"],
  "AllowedHeaders": ["*"],
  "ExposeHeaders": ["ETag"]
}
```

**Lifecycle Policy**:
- No expiration for instruction files (long-term storage)
- Orphaned file cleanup handled by background job (INST-1204)

### CloudFront Configuration

**CDN**: CloudFront distribution already configured

**URL Conversion**: `toCloudFrontUrl(s3Url)` utility
- Input: `https://s3.amazonaws.com/bucket/mocs/.../file.pdf`
- Output: `https://cdn.example.com/mocs/.../file.pdf`

**Cache Behavior**:
- PDF files cached for 1 year (immutable content)
- Cache-Control: `max-age=31536000, immutable`

---

## Test Plan Summary

### Unit Tests

**Frontend (`InstructionsUpload.test.tsx`):**
- Component renders with "Add Instructions" button
- File picker accepts `.pdf` only
- Client validation rejects non-PDFs
- Client validation rejects >10MB files
- Selected files display with name and size
- Remove button removes file from selection
- Upload button triggers mutation

**Backend (service and validation tests):**
- `validatePdfMimeType()` accepts `application/pdf`, rejects others
- `validatePdfExtension()` accepts `.pdf`, rejects others
- `validateFileSize()` accepts 1 byte to 10MB, rejects outside range
- Authorization check prevents unauthorized uploads
- S3 upload failure triggers transaction rollback

### Integration Tests

**Frontend (`InstructionsUpload.integration.test.tsx`):**
- MSW handler for POST `/api/v2/mocs/:id/files/instruction`
- Success returns `MocFile` with 201 status
- Error returns 400/403/404 with error code
- Cache invalidation triggers after upload
- File list updates without page reload

### E2E Tests

**Playwright (`inst-1104-upload-direct.feature`):**
1. Upload single PDF (5MB) - Success path
2. Upload multiple PDFs (3 files) - Sequential uploads
3. Reject invalid file type (JPEG) - Error handling
4. Reject oversized file (15MB) - Upgrade hint
5. Download uploaded file - Verify download functionality

**Coverage Targets**:
- Frontend component: 80% line coverage
- Backend route: 90% line coverage
- E2E: 1 happy path (required by ADR-006), 3+ error cases

---

## UI/UX Notes Summary

### Component Placement
- Instructions upload appears on MOC detail page
- Located in Instructions card below thumbnail
- "Add Instructions" button above existing files list

### Visual Design
- File picker: Standard HTML `<input type="file" accept="application/pdf" multiple />`
- Selected files: List view with filename, size, remove button
- Upload button: Primary style (sky-600) with loading spinner
- Success toast: "Instructions uploaded!" (green, 3 seconds)
- Error toast: Specific error message (red, 5 seconds)

### Accessibility
- Keyboard navigation: Tab to focus, Enter/Space to activate
- Screen reader labels: "Add instructions", "Selected files list", "Remove file"
- Focus management: Focus returns to upload button after file picker closes
- Color contrast: WCAG AA compliance (4.5:1 minimum)

### Loading States
- Upload button disabled during upload
- Spinner on upload button
- Progress indicator: "Uploading 2 of 5..."
- Sequential upload with status for each file

---

## Reality Baseline

### Existing Codebase Patterns

**Backend Route** (`apps/api/lego-api/domains/instructions/routes.ts` lines 198-237):
- POST /mocs/:id/files/instruction already implemented
- Multipart parsing: `const formData = await c.req.formData(); const file = formData.get('file')`
- Service call: `await instructionsService.uploadInstructionFile(userId, mocId, { buffer, filename, mimetype, size })`
- Error handling: `NOT_FOUND | FORBIDDEN | INVALID_FILE | UPLOAD_FAILED`

**RTK Mutation** (`packages/core/api-client/src/rtk/instructions-api.ts` lines 258-291):
- `useUploadInstructionFileMutation` hook exists
- FormData handling: `formData.append('file', file)`
- Cache invalidation: `['Moc', 'MocFile']`
- Response validation with Zod schema

**File Validation** (`apps/api/lego-api/core/utils/file-validation.ts`):
- `validateMimeType()` - Image MIME types only (needs PDF extension)
- `validateFileSize()` - 1 byte to 10MB (reuse as-is)
- `createSecurityEvent()`, `logSecurityEvent()` - Security logging (reuse as-is)

### Integration Dependencies

**INST-1102: Create Basic MOC**
- Status: In QA
- Dependency: POST /mocs endpoint functional
- Action: E2E tests use MOC creation flow

**INST-1103: Upload Thumbnail**
- Status: Ready to Work
- Relation: Sister story for image uploads
- Reuse: Client validation pattern, S3 upload pattern

**INST-1101: View MOC Details**
- Status: Ready to Work
- Relation: Displays uploaded instruction files
- Action: InstructionsUpload mounts on MocDetailPage

**INST-1105: Upload Instructions (Presigned >10MB)**
- Status: Draft
- Relation: Upgrade path for large files
- Action: Show upgrade hint for >10MB files

### Protected Features
None - this is a new feature

---

## Effort Estimate

**Total: 3 story points (24 hours / 3 days)**

Breakdown:
- PDF validation utilities: 2 hours
- InstructionsUpload component: 6 hours
- Integration with MocDetailPage: 2 hours
- Unit tests (frontend): 3 hours
- Unit tests (backend): 1 hour
- Integration tests (MSW): 2 hours
- E2E tests (Playwright): 4 hours
- Bug fixes and polish: 4 hours

**Confidence**: Very High - Backend already implemented, frontend is standard file upload component

---

## Risk Mitigation

### Risk 1: PDF MIME Type Validation (LOW)
- **Issue**: Current validation only supports images
- **Mitigation**: Add `validatePdfMimeType()` function (2 hours)
- **Status**: Non-blocking, trivial implementation

### Risk 2: Sequential Upload UX (MEDIUM)
- **Issue**: Multiple files upload one at a time (may feel slow)
- **Mitigation**: Show progress for each file, allow cancellation
- **Future**: Parallel upload optimization (INST-2036)
- **Status**: Acceptable for MVP

### Risk 3: S3 Transaction Safety (LOW)
- **Issue**: S3 success but DB failure creates orphaned objects
- **Mitigation**: Transaction wrapper, cleanup job (INST-1204)
- **Status**: Handled by existing patterns

---

## Completion Criteria

Story is complete when:
- [ ] All 74 acceptance criteria passing
- [ ] Unit tests: 80% frontend coverage, 90% backend coverage
- [ ] Integration tests: MSW handlers for success/error cases
- [ ] E2E tests: 1 happy path + 3 error cases (ADR-006 compliance)
- [ ] Code review approved
- [ ] Security review: PDF validation, authorization checks
- [ ] Performance: Sequential upload acceptable for MVP
- [ ] Documentation: Component usage, API endpoint
- [ ] Deployed to staging environment
- [ ] QA verification complete

---

**Generated**: 2026-02-06
**PM Agent**: pm-story-generation-leader v4.1.0
**Seed**: /Users/michaelmenard/Development/Monorepo/plans/future/instructions/backlog/INST-1104/_pm/STORY-SEED.md
**Workers**: TEST-PLAN.md, UIUX-NOTES.md, DEV-FEASIBILITY.md

---

## QA Discovery Notes (Auto-Generated)

_Added by Autonomous Elaboration on 2026-02-06_

### MVP Gaps Resolved

| # | Finding | Resolution | AC Added |
|---|---------|------------|----------|
| 1 | PDF validation utilities missing from file-validation.ts | Add validatePdfFile() utility with MIME type, extension, and file validation | AC72 |
| 2 | File size limit mismatch (backend 100MB vs story 10MB) | Backend enforces MAX_FILE_SIZE constant of 10MB for direct upload endpoint | AC73 |
| 3 | Validation returns generic error codes instead of specific messages | Backend returns structured error codes: 'INVALID_MIME_TYPE', 'INVALID_EXTENSION', 'FILE_TOO_LARGE' | AC74 |

### Non-Blocking Items (Logged to KB)

| # | Finding | Category | Decision |
|---|---------|----------|----------|
| 1 | Drag-and-drop upload not included | ux_enhancement | Future story INST-2035 |
| 2 | PDF thumbnail preview not included | ux_enhancement | Future story INST-2032 |
| 3 | Sequential upload may feel slow | ux_enhancement | Future story INST-2036 |
| 4 | No virus scanning integration | security | Future story INST-2031 (production requirement) |
| 5 | No per-user file storage quota | feature | Future consideration |
| 6 | No file extension spoofing detection | security | Future enhancement (magic byte validation) |
| 7 | No mobile file picker optimization | mobile | Future story INST-3060 |

### Summary

- **ACs added**: 3 (AC72, AC73, AC74)
- **Total ACs now**: 74 (up from 71)
- **Mode**: autonomous
- **All blocking gaps**: Resolved
- **Verdict**: PASS - Ready for implementation
