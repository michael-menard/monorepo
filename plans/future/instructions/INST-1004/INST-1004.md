---
id: INST-1004
title: Extract Upload Config Package
status: completed
type: infrastructure
epic: instructions
phase: 0
created: 2026-02-05
completed: 2025-12-09
implementation_story: Story 3.1.30
commit: 6ce460fe
story_type: retrospective
blocking: []
blocked_by: []
related_stories: [INST-1003]
packages: ["@repo/upload-config", "@repo/upload-config-core"]
---

# INST-1004: Extract Upload Config Package (RETROSPECTIVE)

## Story Type

**RETROSPECTIVE / DOCUMENTATION ONLY**

This story documents the `@repo/upload-config` package that was **already implemented** on December 9, 2025 as part of Story 3.1.30. No new development work is required.

---

## Context

### Reality Baseline

**Package Status**: ✅ COMPLETE (December 9, 2025)

Upload configuration (file size limits, MIME types, TTL, rate limits, count limits) was previously scattered across multiple files and hardcoded in various locations throughout the codebase. This created maintenance challenges and inconsistencies.

On December 9, 2025, the upload configuration was extracted into two dedicated packages:
1. `@repo/upload-config` - Pure config types, schemas, and accessor functions
2. `@repo/upload-config-core` - Platform-agnostic environment loader

**Implementation Details**:
- Commit: `6ce460fe` (Story 3.1.30)
- Files changed: 16 files
- Lines added: 1,307
- Tests: 285 passing (>80% coverage)
- Integration: API endpoint `GET /api/config/upload`

### Current Usage

**Packages Created**:
- `packages/tools/upload-config/` - Shared config types and functions
- `packages/backend/upload-config-core/` - Server-side environment loader

**Integration Points**:
- `apps/api/core/config/env-loader.ts` - Server-side environment bridge
- `apps/api/endpoints/config/upload/handler.ts` - Public config API endpoint
- `apps/api/core/config/upload.ts` - Updated to use package internally

**Deprecated**:
- Hardcoded config in `apps/api/core/config/upload.ts` (replaced)
- Hardcoded constants in `apps/api/lego-api/core/utils/file-validation.ts` (migration pending)

---

## Goal

Document the existing `@repo/upload-config` package for the INST epic index and provide knowledge base entry for future stories that depend on upload configuration.

**Key Capabilities Documented**:
1. Centralized upload configuration with Zod validation
2. File size limits by category (instruction, parts-list, thumbnail, image)
3. MIME type validation per category
4. TTL configuration for presigned URLs and upload sessions
5. Rate limiting and count limits
6. Environment variable mapping
7. Public/private config split for API exposure
8. Pure function design (browser + server compatible)

---

## Non-Goals

- ❌ Re-implementing the package (already complete)
- ❌ Changing the package structure (working well)
- ❌ Adding new config fields (out of scope for documentation)
- ❌ Migrating all consumers (gradual migration acceptable)
- ❌ Runtime config updates (env vars sufficient for MVP)
- ❌ Browser-specific validation helpers (can import package directly)

### Protected Features

- ✅ Existing package structure and exports
- ✅ Zod schema validation approach
- ✅ Config injection pattern (pure functions)
- ✅ Public/private config split
- ✅ Environment variable naming

---

## Scope

### Packages

**`@repo/upload-config`** (`packages/tools/upload-config/`)
- Zod schemas: `UploadConfigSchema`, `FileCategorySchema`, `AllowedMimeTypesSchema`
- TypeScript types: `UploadConfig`, `FileCategory`, `AllowedMimeTypes`
- Config functions: `getFileSizeLimit`, `getFileCountLimit`, `isMimeTypeAllowed`, `getAllowedMimeTypes`
- TTL functions: `getPresignTtlSeconds`, `getSessionTtlSeconds`
- Utility functions: `mbToBytes`, `bytesToMb`, `formatBytes`
- Default values: `DEFAULT_UPLOAD_CONFIG`, `DEFAULT_ALLOWED_MIME_TYPES`

**`@repo/upload-config-core`** (`packages/backend/upload-config-core/`)
- Environment loader: `loadUploadConfigFromEnv(env)`
- Public filter: `getPublicUploadConfig(config)`
- Type exports: `EnvVars`, `PublicUploadConfig`

### Endpoints

**`GET /api/config/upload`** (Public)
- Handler: `apps/api/endpoints/config/upload/handler.ts`
- Returns: Public upload configuration (filtered, no rate limits or internal TTLs)
- Auth: Not required (public config)

### Configuration

**Environment Variables** (Server-Side):
```bash
PDF_MAX_BYTES=52428800              # 50 MB
IMAGE_MAX_BYTES=20971520            # 20 MB
PARTS_LIST_MAX_BYTES=10485760       # 10 MB
THUMBNAIL_MAX_BYTES=20971520        # 20 MB
MAX_IMAGES_PER_MOC=10
MAX_PARTS_LISTS_PER_MOC=5
ALLOWED_PDF_MIME_TYPES="application/pdf"
ALLOWED_IMAGE_MIME_TYPES="image/jpeg,image/png,image/webp,image/heic,image/heif"
ALLOWED_PARTS_LIST_MIME_TYPES="text/csv,application/csv,text/plain,application/json,text/json,application/xml,text/xml"
PRESIGN_TTL_MINUTES=15
SESSION_TTL_MINUTES=15
```

**Default Values** (Hardcoded):
- `rateLimitPerDay`: 100
- `finalizeLockTtlMinutes`: 5

---

## Acceptance Criteria

**Note**: All criteria already satisfied by existing implementation.

- [x] **AC-1**: Package `@repo/upload-config` exists at `packages/tools/upload-config/`
- [x] **AC-2**: Zod schema `UploadConfigSchema` defines all config fields
- [x] **AC-3**: File size limits configurable per category (instruction, parts-list, thumbnail, gallery-image)
- [x] **AC-4**: MIME type validation by category via `isMimeTypeAllowed()`
- [x] **AC-5**: TTL configuration for presigned URLs and sessions
- [x] **AC-6**: Rate limiting configuration field exists
- [x] **AC-7**: Default values defined in `DEFAULT_UPLOAD_CONFIG`
- [x] **AC-8**: Pure functions export (no process.env in package)
- [x] **AC-9**: Environment variable loader in `@repo/upload-config-core`
- [x] **AC-10**: `loadUploadConfigFromEnv()` parses all required env vars
- [x] **AC-11**: `getPublicUploadConfig()` filters sensitive fields
- [x] **AC-12**: Public config endpoint at `GET /api/config/upload`
- [x] **AC-13**: Unit tests with >80% coverage (285 tests passing)
- [x] **AC-14**: TypeScript types exported from Zod schemas
- [x] **AC-15**: Package consumed by API server via `apps/api/core/config/env-loader.ts`

---

## Reuse Plan

### Existing Packages to Reuse

| Package | What It Provides | Status |
|---------|------------------|--------|
| `@repo/upload-config` | Config types, schemas, accessor functions | ✅ Complete |
| `@repo/upload-config-core` | Environment loader, public config filter | ✅ Complete |
| `@repo/upload-types` | Upload types (UploadSession, FileMetadata) | ✅ Complete (INST-1003) |

### Key Functions to Reuse

| Function | Use Case | Signature |
|----------|----------|-----------|
| `getFileSizeLimit` | Get max file size for category | `(config, category) => number` |
| `isMimeTypeAllowed` | Validate file MIME type | `(config, category, mimeType) => boolean` |
| `getFileCountLimit` | Get max file count for category | `(config, category) => number` |
| `getPresignTtlSeconds` | Get presigned URL expiry | `(config) => number` |
| `getSessionTtlSeconds` | Get session TTL | `(config) => number` |
| `formatBytes` | Display file sizes in UI | `(bytes) => string` |

### Stories That Depend on This Package

- **INST-1103** (Upload Thumbnail) - MIME validation, size limits for images
- **INST-1104** (Upload Instructions Direct) - PDF size/MIME limits
- **INST-1105** (Upload Instructions Presigned) - Presign TTL, session TTL
- **INST-1106** (Upload Parts List) - Parts list size/MIME limits
- **INST-2030** (Gallery Image Uploads) - Image size/MIME limits, count limits

---

## Architecture Notes

### Package Design

**Two-Package Pattern**:

1. **`@repo/upload-config`** (Pure)
   - Platform: Universal (browser + server)
   - Dependencies: `zod` only
   - Pattern: Pure functions that accept config objects
   - No side effects: No `process.env` access, no I/O

2. **`@repo/upload-config-core`** (Loader)
   - Platform: Server-only (Node.js)
   - Dependencies: `@repo/upload-config`, `zod`
   - Pattern: Platform-agnostic loader (no AWS/Vercel deps)
   - Side effects: Reads `process.env` via parameter

**Config Injection Pattern**:
```typescript
// CORRECT - Pure function
import { getFileSizeLimit, type UploadConfig } from '@repo/upload-config'

const maxSize = getFileSizeLimit(config, 'instruction')

// WRONG - Global access (not used)
const maxSize = process.env.PDF_MAX_BYTES // ❌
```

**Zod-First Validation**:
```typescript
// Schema defines validation rules
export const UploadConfigSchema = z.object({
  pdfMaxBytes: z.number().int().positive(),
  // ...
})

// TypeScript type inferred from schema
export type UploadConfig = z.infer<typeof UploadConfigSchema>

// Runtime validation
const config = UploadConfigSchema.parse(rawConfig)
```

**Public/Private Split**:
```typescript
// Full config (server-side)
const config = loadUploadConfigFromEnv(process.env)
// Has: pdfMaxBytes, rateLimitPerDay, finalizeLockTtlMinutes

// Public config (API response)
const publicConfig = getPublicUploadConfig(config)
// Has: pdfMaxBytes
// Missing: rateLimitPerDay, finalizeLockTtlMinutes
```

### Integration Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Frontend (Browser)                      │
│  Fetch config → GET /api/config/upload                      │
│  Use functions → getFileSizeLimit(config, 'instruction')    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     API Endpoint                             │
│  Handler: apps/api/endpoints/config/upload/handler.ts       │
│  Returns: getPublicUploadConfig(uploadConfig)               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     Server Config Loader                     │
│  File: apps/api/core/config/env-loader.ts                   │
│  Load: loadUploadConfigFromEnv(process.env)                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     @repo/upload-config-core                 │
│  loadUploadConfigFromEnv()                                   │
│  getPublicUploadConfig()                                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     @repo/upload-config                      │
│  UploadConfigSchema                                          │
│  getFileSizeLimit(), isMimeTypeAllowed(), etc.              │
└─────────────────────────────────────────────────────────────┘
```

---

## Infrastructure Notes

### Deployment

**Environment Variables Required**:
- Missing vars cause server startup failure (by design)
- Invalid values throw clear error messages
- Must be set in deployment environment (Vercel, Lambda, etc.)

**Build Process**:
```bash
# Build both packages
pnpm --filter @repo/upload-config build
pnpm --filter @repo/upload-config-core build
```

**Type Generation**:
- Types generated from Zod schemas at build time
- `.d.ts` files exported for TypeScript consumers

### Monitoring

**Error Scenarios**:
1. Missing env var → Server fails to start → Check deployment config
2. Invalid numeric value → Server fails to start → Check env var format
3. Empty MIME type list → Validation fails → Check comma-separated format

**Logging**:
- Config loaded at startup (info level)
- Validation errors logged with specific field names
- Public config endpoint logs successful requests (debug level)

---

## Test Plan

### Existing Test Coverage

**Unit Tests**: 285 tests passing (>80% coverage)

**Test Files**:
- `packages/tools/upload-config/src/__tests__/schema.test.ts` (127 tests)
  - Schema validation
  - Default values
  - Invalid config rejection

- `packages/tools/upload-config/src/__tests__/limits.test.ts` (158 tests)
  - Config accessor functions
  - MIME type validation
  - TTL conversions
  - Byte formatting
  - Edge cases (empty strings, whitespace, case sensitivity)

- `packages/backend/upload-config-core/src/__tests__/config-loader.test.ts`
  - Environment variable parsing
  - Missing var detection
  - Invalid value handling
  - Public config filtering

### Running Tests

```bash
# Run all upload-config tests
pnpm --filter @repo/upload-config test

# Run config-loader tests
pnpm --filter @repo/upload-config-core test

# Test coverage report
pnpm --filter @repo/upload-config test:coverage
```

### Manual Endpoint Test

```http
### Get public upload config
GET {{baseUrl}}/api/config/upload

### Expected Response
HTTP/1.1 200 OK
Content-Type: application/json

{
  "pdfMaxBytes": 52428800,
  "imageMaxBytes": 20971520,
  "partsListMaxBytes": 10485760,
  "thumbnailMaxBytes": 20971520,
  "maxImagesPerMoc": 10,
  "maxPartsListsPerMoc": 5,
  "allowedPdfMimeTypes": ["application/pdf"],
  "allowedImageMimeTypes": ["image/jpeg", "image/png", "image/webp", "image/heic", "image/heif"],
  "allowedPartsListMimeTypes": ["text/csv", "application/csv", "text/plain", "application/json", ...],
  "presignTtlMinutes": 15,
  "sessionTtlMinutes": 15
}
```

**Note**: Response should NOT include `rateLimitPerDay` or `finalizeLockTtlMinutes` (filtered by `getPublicUploadConfig`).

---

## Future Opportunities

### 1. Migrate Old Hardcoded Config

**Location**: `apps/api/lego-api/core/utils/file-validation.ts`

**Current**:
```typescript
export const ALLOWED_MIME_TYPES = ['image/jpeg', 'image/png', 'image/webp']
export const MAX_FILE_SIZE = 10 * 1024 * 1024
```

**Future**: Replace with `@repo/upload-config` functions

**Timeline**: When wishlist upload code is refactored

### 2. Runtime Config Updates

**Current**: Config loaded once at server startup from env vars

**Future**: Support runtime config updates via parameter store or config service

**Timeline**: Post-MVP if needed

### 3. Browser-Side Validation Helpers

**Current**: Package can be imported directly by frontend

**Future**: Create `@repo/upload-config/browser` export with fetch helper

**Timeline**: When frontend validation is implemented (INST-1103+)

---

## Success Metrics

**Package Health**:
- ✅ 285 tests passing
- ✅ >80% code coverage
- ✅ Zero ESLint errors
- ✅ Zero TypeScript errors
- ✅ Zero technical debt

**Integration Health**:
- ✅ API endpoint responding correctly
- ✅ Config loaded at server startup
- ✅ Public config filtered correctly
- ✅ Environment variables validated

**Reuse Readiness**:
- ✅ Package exports documented
- ✅ Function signatures clear
- ✅ Default values sensible
- ✅ Future stories identified

---

## Completion Checklist

- [x] Package created at `packages/tools/upload-config/`
- [x] Loader created at `packages/backend/upload-config-core/`
- [x] Zod schemas defined
- [x] Pure functions implemented
- [x] Environment variable mapping complete
- [x] Public config filtering implemented
- [x] Default values defined
- [x] Unit tests written (285 tests)
- [x] API endpoint created (`GET /api/config/upload`)
- [x] Server integration complete (`apps/api/core/config/env-loader.ts`)
- [x] TypeScript types exported
- [x] Documentation complete (this file)

---

## Story Summary

**Status**: ✅ COMPLETE (December 9, 2025)
**Type**: Retrospective / Documentation
**Quality**: HIGH (285 tests, >80% coverage, zero debt)
**Integration**: WORKING (API endpoint live, env loader functional)
**Reuse Potential**: HIGH (5+ future stories depend on this)

This story documents foundational infrastructure for the MOC Instructions upload flow. The package is production-ready and provides centralized, validated upload configuration for all future upload-related stories.

---

## Related Stories

- **INST-1003**: Extract Upload Types Package (completed 2024-12-26)
- **INST-1008**: Wire RTK Query Mutations (created, ready for implementation)
- **INST-1103**: Upload Thumbnail (draft, depends on this package)
- **INST-1104**: Upload Instructions Direct (draft, depends on this package)
- **INST-1105**: Upload Instructions Presigned (draft, depends on this package)
- **INST-1106**: Upload Parts List (draft, depends on this package)

---

**Story generated**: 2026-02-05
**Package implemented**: 2025-12-09
**Implementation commit**: `6ce460fe`
**Implementation story**: Story 3.1.30
