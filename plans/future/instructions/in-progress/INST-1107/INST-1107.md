---
story_id: INST-1107
title: Download Files
feature: instructions
status: ready-to-work
story_type: feature
priority: medium
points: 3
created_at: "2026-02-07"
updated_at: "2026-02-07"
blocked_by: ["INST-1101"]
touches_frontend: true
touches_backend: true
touches_database: true
touches_infra: false
---

# INST-1107: Download Files

> As a user, I can download my instruction PDFs and parts lists.

---

## Context

MOC detail page (INST-1101) displays a list of uploaded files (instructions PDFs, parts lists) but users cannot download them. The backend already stores file metadata in `moc_files` table including S3 keys, but no download endpoint exists to generate secure presigned URLs.

**Current State:**
- Files are uploaded and stored in S3 (INST-1104 completed)
- File metadata exists in `moc_files` table (id, mocId, s3Key, originalFilename, fileType)
- Detail page shows file list with basic info
- Existing PDF download button uses direct `<a href>` to `pdfUrl` field (limited pattern)

**Reality Baseline:**
- S3 presigned URL pattern exists in `apps/api/lego-api/domains/inspiration/adapters/storage.ts`
- MOC service authorization pattern established in `mocService.getMoc`
- RTK Query mutations framework in place (`instructionsApi`)
- No baseline reality file available (codebase scanning performed)

---

## Goal

Implement a secure download flow that allows users to download instruction PDFs and parts list files with proper authentication, correct filenames, and good UX (loading states, error handling).

---

## Non-Goals

- Multi-file zip downloads (single file only) - **DEFERRED** to INST-3080
- Download progress tracking (browser handles this) - **DEFERRED** to INST-3081
- Download history/analytics - **DEFERRED** to INST-3082
- Virus scanning before download (assumes files already scanned on upload per INST-2031)
- CDN delivery (files served from S3 via presigned URL) - S3 direct is sufficient for MVP
- Thumbnail downloads (covered by INST-1103)

---

## Scope

### Frontend
**Files to Create:**
- `apps/web/app-instructions-gallery/src/components/FileDownloadButton.tsx` - New component

**Files to Modify:**
- `apps/web/app-instructions-gallery/src/pages/detail-page.tsx` - Integrate FileDownloadButton into file list (lines 318-325 area)
- `packages/core/api-client/src/rtk/instructions-api.ts` - Add `getFileDownloadUrl` query
- `packages/core/api-client/src/schemas/instructions.ts` - Add download URL response schema
- `packages/core/api-client/src/index.ts` - Export `useGetFileDownloadUrlQuery` hook

### Backend
**Files to Modify:**
- `apps/api/lego-api/domains/mocs/routes.ts` - Add `GET /mocs/:id/files/:fileId/download` route (thin adapter only)
- `apps/api/lego-api/domains/mocs/application/services.ts` - Add `getFileDownloadUrl` method to MocService (business logic layer)
- `apps/api/lego-api/domains/mocs/types.ts` - Add `GetFileDownloadUrlResponseSchema`

**Service Layer Method:**
- `MocService.getFileDownloadUrl(userId, mocId, fileId)` - Queries file, verifies ownership, generates presigned S3 URL

**Files to Reference (Patterns):**
- `apps/api/lego-api/domains/inspiration/adapters/storage.ts` - Presigned URL generation pattern

### Database
**No Schema Changes Required**
- Uses existing `moc_files` table
- Query: `SELECT s3Key, originalFilename, mocId FROM moc_files WHERE id = ? AND mocId IN (SELECT id FROM mocs WHERE userId = ?)`

### Testing
**New Test Files:**
- `apps/api/lego-api/domains/mocs/__tests__/download.test.ts` - Unit tests for download service
- `apps/web/app-instructions-gallery/src/components/__tests__/FileDownloadButton.test.tsx` - Component tests
- `apps/web/playwright/features/instructions/inst-1107-download.feature` - E2E Cucumber feature
- `apps/web/playwright/step-definitions/instructions/inst-1107-download.steps.ts` - E2E step definitions

---

## Acceptance Criteria

### Backend (API Endpoint)
- [ ] **AC-1**: `GET /mocs/:id/files/:fileId/download` endpoint exists in `routes.ts` and delegates to `mocService.getFileDownloadUrl()`
- [ ] **AC-2**: Endpoint queries `moc_files` table for s3Key, originalFilename, mocId by fileId
- [ ] **AC-3**: Endpoint verifies file belongs to user's MOC (JOIN mocs.userId = authenticated userId)
- [ ] **AC-4**: Returns 404 if file not found or user doesn't own MOC (no info leakage)
- [ ] **AC-5**: Returns 401 if user not authenticated
- [ ] **AC-6**: Endpoint generates presigned S3 URL using `@aws-sdk/s3-request-presigner` + `GetObjectCommand`
- [ ] **AC-7**: Presigned URL includes `ResponseContentDisposition: attachment; filename="..."`
- [ ] **AC-8**: Presigned URL expires in 900 seconds (15 minutes)
- [ ] **AC-9**: Endpoint returns JSON: `{ downloadUrl: string, expiresAt: string }` (ISO8601 format)
- [ ] **AC-10**: Returns 500 with `{ error: "PRESIGN_FAILED" }` if S3 presigning fails
- [ ] **AC-11**: Logs successful download URL generation to CloudWatch (info level)
- [ ] **AC-12**: Logs authorization failures to CloudWatch (warn level)
- [ ] **AC-13**: Filename encoding uses RFC 5987 for special characters (UTF-8)
- [ ] **AC-14**: Endpoint validates mocId and fileId format (reject invalid UUIDs)
- [ ] **AC-15**: Response schema validated with Zod (`GetFileDownloadUrlResponseSchema`)

### Frontend (UI Component)
- [ ] **AC-16**: `FileDownloadButton` component created in `components/` directory
- [ ] **AC-17**: Component accepts props: `mocId: string`, `fileId: string`, `fileName: string`, `className?: string`
- [ ] **AC-18**: Button renders with Download icon (lucide-react) and "Download" text
- [ ] **AC-19**: Button shows loading spinner (Loader2 icon) during API call
- [ ] **AC-20**: Button disabled during loading state (`disabled={isLoading}`)
- [ ] **AC-21**: Button has `aria-label="Download {fileName}"` for screen readers
- [ ] **AC-22**: Button has `aria-busy="true"` during loading
- [ ] **AC-23**: Button has focus visible indicator (`focus:ring-2 focus:ring-primary`)
- [ ] **AC-24**: On click, calls RTK Query `useGetFileDownloadUrlQuery`
- [ ] **AC-25**: On successful API response, triggers browser download via `window.location.href = downloadUrl`
- [ ] **AC-26**: On API error, shows toast notification with user-friendly message ("Download failed. Please try again.")
- [ ] **AC-27**: Button returns to ready state after success or error
- [ ] **AC-28**: Button accessible via keyboard (Tab to focus, Enter to activate)
- [ ] **AC-29**: Touch target size ≥44x44px on mobile
- [ ] **AC-30**: Component uses `Button` from `@repo/app-component-library/_primitives/button`
- [ ] **AC-31**: Component uses design tokens only (no hardcoded colors)

### Frontend (Page Integration)
- [ ] **AC-32**: Download button appears on each file in MOC detail page file list
- [ ] **AC-33**: Button integrates into existing file list UI (lines 318-325 area of detail-page.tsx)
- [ ] **AC-34**: Multiple download buttons can coexist (one per file)
- [ ] **AC-35**: Each button operates independently (loading state per button, not global)

### RTK Query Integration
- [ ] **AC-36**: `getFileDownloadUrl` query added to `instructionsApi` in `rtk/instructions-api.ts`
- [ ] **AC-37**: Query endpoint: `/instructions/mocs/:mocId/files/:fileId/download` (frontend path per ADR-001)
- [ ] **AC-38**: Query accepts parameters: `{ mocId: string, fileId: string }`
- [ ] **AC-39**: Query returns `{ downloadUrl: string, expiresAt: string }`
- [ ] **AC-40**: Query validates response with Zod schema (`GetFileDownloadUrlResponseSchema`)
- [ ] **AC-41**: Query does NOT cache results (`keepUnusedDataFor: 0` - presigned URLs expire)
- [ ] **AC-42**: Query handles 401/404/500 errors gracefully
- [ ] **AC-43**: `useGetFileDownloadUrlQuery` hook exported in `packages/core/api-client/src/index.ts`

### Database
- [ ] **AC-44**: No schema migrations required (uses existing `moc_files` table)
- [ ] **AC-45**: Query uses JOIN to verify ownership: `moc_files.mocId = mocs.id AND mocs.userId = ?`
- [ ] **AC-46**: Query selects: `s3Key`, `originalFilename`, `mocId`, `fileType`
- [ ] **AC-47**: Query returns NULL if file not found (handled as 404)

### Security
- [ ] **AC-48**: Presigned URL cannot be generated without authentication (401 if no token)
- [ ] **AC-49**: User cannot download files from MOCs they don't own (404 response, no info leakage)
- [ ] **AC-50**: Presigned URLs expire after 15 minutes (cannot be reused indefinitely)
- [ ] **AC-51**: S3 bucket permissions verified (Lambda has `s3:GetObject` permission)
- [ ] **AC-52**: No file path traversal possible (fileId from database only, not user input)

### Error Handling
- [ ] **AC-53**: Missing authentication → 401 with `{ error: "UNAUTHORIZED" }`
- [ ] **AC-54**: File not found → 404 with `{ error: "NOT_FOUND" }`
- [ ] **AC-55**: User doesn't own MOC → 404 (same as not found, no info leakage)
- [ ] **AC-56**: S3 presigning fails → 500 with `{ error: "PRESIGN_FAILED" }`, logged to CloudWatch
- [ ] **AC-57**: Invalid mocId/fileId format → 400 with `{ error: "VALIDATION_ERROR" }`
- [ ] **AC-58**: Missing s3Key in database → 500 with `{ error: "DATA_INTEGRITY_ERROR" }`, logged

### Testing Requirements
See `_pm/TEST-PLAN.md` for comprehensive test cases.

**Unit Tests:**
- [ ] **AC-59**: Backend service unit tests ≥90% coverage (presigned URL generation, auth logic)
- [ ] **AC-60**: Frontend component unit tests ≥80% coverage (loading states, error states, success flow)
- [ ] **AC-61**: Test unauthorized access returns 404 (not 403 - avoid info leakage)
- [ ] **AC-62**: Test missing file returns 404
- [ ] **AC-63**: Test S3 presigning failure returns 500

**Integration Tests:**
- [ ] **AC-64**: Integration test: successful download URL generation (200 response)
- [ ] **AC-65**: Integration test: unauthorized user blocked (404 response)
- [ ] **AC-66**: Integration test: file not found handled (404 response)
- [ ] **AC-67**: Integration test: presigned URL contains required parameters (X-Amz-Signature, expires, response-content-disposition)

**E2E Tests (Playwright + Cucumber):**
- [ ] **AC-68**: E2E test: download instruction PDF file with correct filename
- [ ] **AC-69**: E2E test: download parts list CSV file
- [ ] **AC-70**: E2E test: verify downloaded file appears in browser downloads
- [ ] **AC-71**: E2E test: verify button shows loading state during download
- [ ] **AC-72**: E2E test: verify unauthorized user cannot download file (404)

### Service Layer Architecture (Added by autonomous elaboration)
- [ ] **AC-73**: Service method `getFileDownloadUrl` exists in MocService (`apps/api/lego-api/domains/mocs/application/services.ts`) with signature: `async getFileDownloadUrl(userId: string, mocId: string, fileId: string): Promise<Result<{downloadUrl: string, expiresAt: string}, ErrorCode>>`
- [ ] **AC-74**: Service layer performs ownership verification: queries file by fileId → verifies file.mocId belongs to MOC owned by userId → returns 'NOT_FOUND' error if unauthorized (no info leakage)
- [ ] **AC-75**: Route handler in routes.ts is thin adapter: parses params → calls mocService.getFileDownloadUrl() → maps service errors to HTTP status codes (per api-layer.md Ports & Adapters pattern)
- [ ] **AC-76**: Service layer handles all business logic: file query, ownership check, presigned URL generation, error handling (route handler contains NO business logic)

---

## Reuse Plan

### Existing Patterns to Reuse

| Pattern | Location | Usage |
|---------|----------|-------|
| Presigned URL generation | `apps/api/lego-api/domains/inspiration/adapters/storage.ts:89-90` | Adapt for GetObjectCommand (download) instead of PutObjectCommand (upload) |
| MOC service authorization | `apps/api/lego-api/domains/mocs/application/services.ts` | Verify user owns MOC before generating URL |
| RTK Query pattern | `packages/core/api-client/src/rtk/instructions-api.ts` | Add download query similar to upload mutations |
| Error mapping | `apps/api/lego-api/domains/mocs/routes.ts:309-343` | Map service errors to HTTP status codes |

### Packages to Reuse

| Package | Version | Usage |
|---------|---------|-------|
| `@aws-sdk/client-s3` | Latest | GetObjectCommand for presigned download URL |
| `@aws-sdk/s3-request-presigner` | Latest | getSignedUrl function |
| `@repo/logger` | Workspace | Backend logging |
| `@repo/app-component-library` | Workspace | Button primitive |
| `lucide-react` | Latest | Download and Loader2 icons |
| `@repo/api-core` | Workspace | Result type (ok/err pattern) |

---

## Architecture Notes

### Presigned URL Flow

```
User                Frontend           Backend API        AWS S3
 |                     |                   |               |
 |-- Click Download -->|                   |               |
 |                     |-- GET /download --|               |
 |                     |                   |-- Query DB -->|
 |                     |                   |<-- file data -|
 |                     |                   |               |
 |                     |                   |-- getSignedUrl (S3 SDK)
 |                     |                   |               |
 |                     |<-- presigned URL -|               |
 |                     |                   |               |
 |<- window.location --|                   |               |
 |-------------------- GET presigned URL ----------------->|
 |<------------------- file stream ------------------------|
 |                     |                   |               |
```

### Service Layer Architecture

```typescript
// apps/api/lego-api/domains/mocs/application/services.ts

async getFileDownloadUrl(
  userId: string,
  mocId: string,
  fileId: string
): Promise<Result<{ downloadUrl: string; expiresAt: string }, ErrorCode>> {
  // 1. Query file from repository
  const fileResult = await mocRepo.getFileByIdAndMocId(fileId, mocId)
  if (!fileResult.ok || !fileResult.data) {
    return err('FILE_NOT_FOUND')
  }

  // 2. Verify ownership (file's MOC belongs to user)
  const mocResult = await mocRepo.getMocById(mocId)
  if (!mocResult.ok || mocResult.data.userId !== userId) {
    return err('FILE_NOT_FOUND') // Don't reveal file exists
  }

  // 3. Generate presigned S3 URL
  const { s3Key, originalFilename } = fileResult.data
  const command = new GetObjectCommand({
    Bucket: process.env.S3_BUCKET,
    Key: s3Key,
    ResponseContentDisposition: `attachment; filename*=UTF-8''${encodeURIComponent(originalFilename)}`,
  })

  try {
    const downloadUrl = await getSignedUrl(s3Client, command, { expiresIn: 900 })
    const expiresAt = new Date(Date.now() + 900 * 1000).toISOString()

    logger.info('Download URL generated', undefined, { userId, mocId, fileId })
    return ok({ downloadUrl, expiresAt })
  } catch (error) {
    logger.error('Failed to generate presigned URL', error, { userId, mocId, fileId })
    return err('PRESIGN_FAILED')
  }
}
```

### Frontend Component Pattern

```typescript
// apps/web/app-instructions-gallery/src/components/FileDownloadButton.tsx

export function FileDownloadButton({ mocId, fileId, fileName, className }: Props) {
  const [getDownloadUrl, { isLoading, error }] = useLazyGetFileDownloadUrlQuery()

  const handleDownload = async () => {
    try {
      const { downloadUrl } = await getDownloadUrl({ mocId, fileId }).unwrap()
      window.location.href = downloadUrl // Trigger browser download
    } catch (err) {
      toast.error('Download failed. Please try again.')
    }
  }

  return (
    <Button
      variant="outline"
      size="sm"
      onClick={handleDownload}
      disabled={isLoading}
      aria-label={`Download ${fileName}`}
      aria-busy={isLoading}
      className={cn("w-full sm:w-auto", className)}
    >
      {isLoading ? (
        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
      ) : (
        <Download className="w-4 h-4 mr-2" />
      )}
      Download
    </Button>
  )
}
```

---

## Infrastructure Notes

**No New Infrastructure Required**

### Existing Resources
- S3 bucket (already used for file uploads)
- Lambda execution role (needs `s3:GetObject` permission - likely already granted)
- API Gateway (uses existing `/mocs` base path)

### IAM Permissions to Verify
Ensure Lambda execution role has:
```json
{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject",
    "s3:PutObject"  // Already granted for uploads
  ],
  "Resource": "arn:aws:s3:::${S3_BUCKET}/*"
}
```

### Environment Variables
No new env vars required:
- `S3_BUCKET` (already exists)
- `AWS_REGION` (already exists)

---

## HTTP Contract Plan

### Request

```http
GET /mocs/:mocId/files/:fileId/download HTTP/1.1
Host: api.lego-moc-instructions.com
Authorization: Bearer <JWT_TOKEN>
```

**Path Parameters:**
- `mocId` (string, UUID) - MOC identifier
- `fileId` (string, UUID) - File identifier

**Headers:**
- `Authorization` (required) - Bearer token with valid JWT

### Response (Success)

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "downloadUrl": "https://lego-moc-files.s3.amazonaws.com/instructions/user-abc/doc.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=...&X-Amz-Signature=...&response-content-disposition=attachment%3B%20filename%2A%3DUTF-8%27%27castle-instructions.pdf",
  "expiresAt": "2026-02-07T15:45:00.000Z"
}
```

**Response Schema (Zod):**
```typescript
const GetFileDownloadUrlResponseSchema = z.object({
  downloadUrl: z.string().url(),
  expiresAt: z.string().datetime(), // ISO8601
})
```

### Response (Errors)

| Status | Error Code | Condition |
|--------|-----------|-----------|
| 401 | `UNAUTHORIZED` | No auth token or invalid token |
| 404 | `NOT_FOUND` | File not found OR user doesn't own MOC |
| 500 | `PRESIGN_FAILED` | S3 presigning failed |
| 500 | `DATA_INTEGRITY_ERROR` | Missing s3Key in database |

**Error Response Format:**
```json
{
  "error": "NOT_FOUND"
}
```

---

## Seed Requirements

No additional seed data required beyond existing test data:
- INST-1102: Provides MOC creation
- INST-1104: Provides file upload (creates moc_files records with s3Keys)

Test seeds leverage existing patterns from `apps/api/lego-api/domains/mocs/__tests__/`.

---

## Test Plan

See `_pm/TEST-PLAN.md` for comprehensive testing strategy.

**Summary:**
- **Happy Path**: 3 tests (download PDF, download CSV, multiple downloads)
- **Error Cases**: 6 tests (unauthorized, not found, unauthenticated, S3 failure, wrong MOC, missing s3Key)
- **Edge Cases**: 6 tests (long filename, special characters, expiry, rapid clicks, large file, data integrity)
- **Coverage Targets**: 90% backend, 80% frontend, 100% integration ACs, 100% E2E MVP flow

---

## UI/UX Notes

See `_pm/UIUX-NOTES.md` for detailed design guidance.

**MVP-Critical Requirements:**
- Download button with icon + text
- Loading state with spinner
- Error toast on failure
- Keyboard accessible (Tab, Enter)
- Screen reader friendly (`aria-label`, `aria-busy`)
- Focus visible indicator
- Design tokens only (no hardcoded colors)
- Touch target ≥44x44px on mobile

**Component Hierarchy:**
```
DetailPage
  └─ Files Section
      └─ FileListItem (each file)
          ├─ File Icon
          ├─ File Name & Size
          └─ FileDownloadButton ← NEW
```

---

## Reality Baseline

**Codebase Scan Results:**
- ✅ S3 presigned URL pattern exists (inspiration domain)
- ✅ MOC service authorization pattern exists
- ✅ RTK Query framework exists (instructionsApi)
- ✅ Detail page exists with file list (INST-1101)
- ✅ File upload completed (INST-1104)
- ❌ No baseline reality file available (proceeded with codebase scanning)

**Active Work:**
- INST-1101 (View MOC Details) - **BLOCKING** for E2E tests (detail page dependency)
- INST-1102 (Create Basic MOC) - In QA (provides test data setup)
- INST-1104 (Upload Instructions) - Completed (provides files to download)

**ADRs Applied:**
- ADR-001: API path schema (frontend uses `/api/v2/mocs`, backend uses `/mocs`)
- ADR-004: Authentication (verify userId owns MOC)
- ADR-005: UAT must use real S3 (no mocking)
- ADR-006: E2E tests required in dev phase (at least one happy path test)

---

## Success Metrics

**Implementation Complete When:**
- All 72 acceptance criteria pass
- Unit test coverage ≥90% backend, ≥80% frontend
- Integration tests cover all error cases
- E2E test downloads real file from S3 with correct filename
- IAM permissions verified in dev environment

**User Impact:**
- Users can download instruction PDFs and parts lists with one click
- Files download with correct original filenames
- Loading states provide clear feedback
- Errors handled gracefully with user-friendly messages

**Technical Quality:**
- No hardcoded credentials or bucket names
- Presigned URLs expire appropriately (15 minutes)
- Authorization prevents unauthorized access
- Logging provides observability for debugging

---

## Story Points Estimate

**3 Points** (2-3 days)

**Breakdown:**
- Backend route + service: 3-4 hours
- RTK Query integration: 1-2 hours
- FileDownloadButton component: 2-3 hours
- Unit tests: 3-4 hours
- Integration tests: 2-3 hours
- E2E tests: 2-3 hours
- Documentation: 1 hour

**Confidence**: High - well-scoped, clear requirements, proven patterns

---

## Dependencies

**Blocking:**
- INST-1101 (View MOC Details) - **Required for E2E testing** (detail page with file list)

**Non-Blocking:**
- INST-1104 (Upload Instructions) - Helpful for test data (already completed)
- INST-1102 (Create Basic MOC) - Helpful for test data (in QA)

---

## Related Stories

**Prerequisite:**
- INST-1101: View MOC Details (provides detail page with file list)

**Follow-up:**
- INST-3080: Batch Download (download all files as ZIP)
- INST-3081: Download Progress Tracking
- INST-3082: Download History/Analytics
- INST-2031: File Virus Scanning (scan before download)

**Related:**
- INST-1104: Upload Instructions (provides files to download)
- INST-1103: Upload Thumbnail (different download pattern, not affected)
- INST-1110: Remove Individual File (manage files, complementary feature)

---

## Notes

- Presigned URL pattern reused from inspiration domain (tested and proven)
- Filename encoding uses RFC 5987 for Unicode support
- Short expiry (15 min) balances security and UX
- Authorization returns 404 (not 403) to avoid info leakage about file existence
- RTK Query does not cache download URLs (they expire)
- Frontend triggers download via `window.location.href` (simplest, browser-native)
- Lambda only generates URL, doesn't proxy file (avoids size limits and timeouts)

---

## QA Discovery Notes (Auto-Generated)

_Added by Autonomous Elaboration on 2026-02-07_

### MVP Gaps Resolved

| # | Finding | Resolution | AC Added |
|---|---------|------------|----------|
| 1 | Service layer method not specified - developers might add business logic to routes.ts (architecture violation per api-layer.md) | Add as AC | AC-73 (service method signature), AC-76 (business logic placement) |
| 2 | Unclear where authorization happens - ownership check might be skipped or placed in wrong layer | Add as AC | AC-74 (service layer ownership verification), AC-75 (thin route handler pattern) |
| 3 | Route handler scope ambiguity - AC-1 doesn't specify thin adapter pattern | Update AC-1 | AC-1 clarified to explicitly state route handler delegates to service layer |
| 4 | Service method not in Scope section - only routes.ts and types.ts listed | Update Scope | Scope section updated with service layer method signature and responsibilities |

### Non-Blocking Items (Logged to KB - Deferred)

| # | Finding | Category | KB Entry |
|---|---------|----------|----------|
| 1 | Presigned URL Caching Consideration | optimization | DEFERRED-KB-WRITES.yaml |
| 2 | Download Analytics Missing | observability | DEFERRED-KB-WRITES.yaml |
| 3 | Rate Limiting Not Specified | security | DEFERRED-KB-WRITES.yaml |
| 4 | CORS Edge Case | infrastructure | DEFERRED-KB-WRITES.yaml |
| 5 | Content-Type Handling | ux | DEFERRED-KB-WRITES.yaml |
| 6 | Download Link Expiry Warning | ux-polish | DEFERRED-KB-WRITES.yaml |
| 7 | Copy Download Link Feature | sharing | DEFERRED-KB-WRITES.yaml |
| 8 | QR Code for Mobile Downloads | mobile | DEFERRED-KB-WRITES.yaml |
| 9 | Batch Download (ZIP) | batch-operations | DEFERRED-KB-WRITES.yaml |
| 10 | Download Progress Tracking | ux-polish | DEFERRED-KB-WRITES.yaml |
| 11 | File Preview Before Download | ux-polish | DEFERRED-KB-WRITES.yaml |
| 12 | Download Speed Optimization | performance | DEFERRED-KB-WRITES.yaml |
| 13 | Download Notifications | notifications | DEFERRED-KB-WRITES.yaml |
| 14 | File Integrity Check | security | DEFERRED-KB-WRITES.yaml |
| 15 | Download History Tracking | analytics | DEFERRED-KB-WRITES.yaml |
| 16 | Partial Downloads / Resume Support | performance | DEFERRED-KB-WRITES.yaml |

### Summary

- **ACs added**: 4 (AC-73 through AC-76 - service layer specification)
- **ACs updated**: 1 (AC-1 clarified for thin adapter pattern)
- **Scope updated**: Yes (service layer method added)
- **KB entries created**: 0 (KB unavailable)
- **KB entries deferred**: 16 (all non-blocking findings)
- **Mode**: autonomous
- **Verdict**: CONDITIONAL PASS - Story can proceed to implementation with added service layer ACs

### Architect Review Notes

**Ports & Adapters Pattern (per api-layer.md):**
- ✅ **RESOLVED**: Route handler is now clearly defined as thin adapter
- ✅ **RESOLVED**: Business logic (file query, ownership check, presigned URL generation) moved to service layer
- ✅ **RESOLVED**: Error handling and HTTP status code mapping remains in route handler
- ✅ **RESOLVED**: Service layer returns Result type (ok/err) for clean error handling

**Security Implementation:**
- ✅ Service layer performs ownership verification via JOIN query
- ✅ Returns 404 for both "file not found" and "user doesn't own MOC" (no info leakage)
- ✅ Authentication required (401 if missing/invalid token)
- ✅ Presigned URLs expire in 15 minutes (no indefinite sharing)

**Code Reuse:**
- ✅ S3 presigned URL pattern from inspiration domain (proven, tested)
- ✅ MOC service authorization pattern applied
- ✅ RTK Query framework with existing instructionsApi
- ✅ Button primitive from @repo/app-component-library
- ✅ Estimated 80% code reuse from existing patterns
