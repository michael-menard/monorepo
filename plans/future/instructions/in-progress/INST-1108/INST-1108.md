# INST-1108: Edit MOC Metadata

---
story_id: INST-1108
title: Edit MOC Metadata
status: ready-for-code-review
story_type: feature
feature: instructions
priority: medium
points: 3
created: 2026-02-09
updated_at: "2026-02-10T18:45:00Z"
blocked_by: INST-1101
touches_backend: true
touches_frontend: true
touches_database: true
touches_infra: false
---

## Context

Users need the ability to update their MOC's metadata (title, description, theme, tags) after initial creation. Currently, once a MOC is created via INST-1102 (Create Basic MOC), there is no way to edit it—users would need to delete and recreate the MOC to change any information.

**Existing Infrastructure:**
- **MocForm Component**: Already implemented in INST-1102 (Create Basic MOC, currently in QA). This reusable form component handles title, description, theme, and tags fields with validation, keyboard shortcuts (Cmd+Enter to submit, Escape to cancel), and error handling. The component supports `initialValues` prop for pre-populating fields.
- **RTK Query Mutation**: `useUpdateMocMutation` already exists in `packages/core/api-client/src/rtk/instructions-api.ts` (lines 227-242), configured with cache invalidation for `Moc` (by id) and `MocList` tags.
- **Backend Gap**: The `PATCH /mocs/:id` endpoint does NOT exist in `apps/api/lego-api/domains/mocs/routes.ts`. Current routes are: GET /mocs, POST /mocs, GET /mocs/:id, POST /mocs/:id/thumbnail. The update endpoint must be implemented.

**Design Pattern:**
EditMocPage will follow the same structure as CreateMocPage:
- Page fetches MOC data using `useGetMocDetailQuery(mocId)`
- Displays loading skeleton while fetching
- Renders 404 error if MOC not found or user unauthorized
- Passes MOC data as `initialValues` to MocForm component
- On submit, calls `useUpdateMocMutation` with changed fields
- On success, shows toast "MOC updated!" and redirects to detail page
- On error, shows toast with retry button and saves draft to localStorage for recovery

**Dependency:**
INST-1101 (View MOC Details) is currently "Ready to Work" but not yet implemented. The edit button will be placed on the detail page. For E2E testing, we can test direct navigation to `/mocs/:id/edit` URL until INST-1101 completes.

---

## Goal

Enable users to edit and update their MOC's metadata (title, description, theme, tags) through a dedicated edit page that reuses the existing MocForm component, ensuring consistency with the create flow and providing a seamless user experience with proper validation, error handling, and form recovery.

---

## Non-Goals

- **Navigation guards for unsaved changes**: Deferred to INST-1200 (Unsaved Changes Guard). MVP will not warn users when navigating away from the edit page with unsaved changes.
- **Optimistic UI updates**: Optional enhancement, not required for MVP. Cache will be updated after backend confirms save.
- **Edit history/audit trail**: Not part of this story. No tracking of who changed what when.
- **Bulk edit multiple MOCs**: Single MOC edit only.
- **Edit files/thumbnails**: File management is handled by separate stories (INST-1103 Thumbnail, INST-1104 Instructions, INST-1106 Parts List, INST-1110 Remove File).
- **Edit slug**: Slug is auto-generated from title, not directly editable by users.
- **Edit visibility/status**: Only metadata fields (title, description, theme, tags) are editable. Visibility, status, and other future fields are out of scope.
- **OpenSearch re-indexing**: Deferred to Phase 6 (Search & Discovery). Index entry mentions re-indexing if title/description changed, but this is not MVP-critical since search features are not yet deployed.
- **Concurrent edit detection**: Out of scope. Last write wins. Future: Optimistic locking or conflict detection.

---

## Scope

### Frontend Surfaces

**New Page:**
- **EditMocPage** (`apps/web/app-instructions-gallery/src/pages/EditMocPage.tsx`)
  - Route: `/mocs/:mocId/edit`
  - Fetches MOC data on mount
  - Displays loading skeleton while fetching
  - Displays 404 error if MOC not found or unauthorized
  - Renders MocForm component with pre-populated values
  - Handles form submission (save), cancellation (back to detail), keyboard shortcuts
  - Implements form recovery from localStorage on error

**Modified Pages:**
- **MocDetailPage** (`apps/web/app-instructions-gallery/src/pages/MocDetailPage.tsx`)
  - Add: Edit button (links to `/mocs/:id/edit`)
  - Authorization: Edit button only visible to MOC owner
  - **Dependency**: INST-1101 (View MOC Details) must be implemented for full integration

**Reused Components (No Changes):**
- **MocForm** (`apps/web/app-instructions-gallery/src/components/MocForm/index.tsx`)
  - Already supports `initialValues` prop (from INST-1102)
  - Fields: title, description, theme, tags
  - Validation: title (min 3, max 500), description (max 5000), theme (required), tags (max 20)
  - Features: Auto-focus, validation, Cmd+Enter submit, Escape cancel

**Router:**
- **Add route**: `<Route path="/mocs/:id/edit" element={<EditMocPage />} />`

### Backend Endpoints

**New Endpoint:**
- **PATCH /mocs/:id** - Update MOC metadata
  - Request body (partial update): `{ title?: string, description?: string, theme?: string, tags?: string[] }`
  - Authorization: User must own the MOC (userId check)
  - Validation: Same rules as create (Zod schema: UpdateMocInputSchema)
  - Response: 200 with updated MOC object
  - Errors: 404 (not found or unauthorized), 400 (validation errors), 500 (server errors)
  - Files: `apps/api/lego-api/domains/mocs/routes.ts`

**Validation Schema:**
- **UpdateMocInputSchema** (`@repo/api-client/schemas/instructions`)
  - Reuses fields from CreateMocInputSchema (all optional for partial update)
  - Title: min 3, max 500 characters (if provided)
  - Description: max 5000 characters (if provided)
  - Theme: non-empty string (if provided)
  - Tags: array, max 20 tags (if provided)

### Database

**Tables Modified:**
- **mocs** table (UPDATE operation)
  - Fields updated: title, description, theme, tags, updatedAt
  - updatedAt: Auto-updated via database trigger (if exists) or manually set in backend

**No Schema Changes Required**: All fields already exist from INST-1102 (Create Basic MOC).

### RTK Query

**Existing Hooks (Reused):**
- **useGetMocDetailQuery(mocId)**: Fetch MOC data for pre-population
- **useUpdateMocMutation()**: Trigger update and cache invalidation
  - Cache tags invalidated: `Moc` (by id), `MocList`
  - Already implemented in `packages/core/api-client/src/rtk/instructions-api.ts`

### Packages Leveraged

- **@repo/app-component-library**: Button, Input, Textarea, Label, Select, Toast components
- **@repo/api-client/rtk/instructions-api**: RTK Query hooks
- **@repo/api-client/schemas/instructions**: UpdateMocInput, MocInstructions schemas
- **@repo/logger**: Structured logging for errors and user actions

---

## Acceptance Criteria

### Backend (PATCH Endpoint)

- [ ] **AC-1**: Service layer method `mocService.updateMoc(userId, mocId, input)` exists in `apps/api/lego-api/domains/mocs/application/services.ts`. Method handles business logic: authorization check (userId matches moc.userId), partial update logic, returns Result<Moc, 'NOT_FOUND' | 'FORBIDDEN' | 'VALIDATION_ERROR'>. Per Ports & Adapters architecture (`docs/architecture/api-layer.md`), business logic must NOT be in route handler.
- [ ] **AC-2**: PATCH /mocs/:id endpoint exists and accepts request body with partial update semantics: `{ title?: string, description?: string, theme?: string, tags?: string[] }`. Only provided fields are updated; omitted fields remain unchanged.
- [ ] **AC-3**: Endpoint is thin adapter: calls `mocService.updateMoc()`, maps Result to HTTP status codes (200 success, 404 not found/forbidden, 400 validation error, 500 server error). Route handler contains NO business logic.
- [ ] **AC-4**: Endpoint validates userId matches MOC owner (authorization) via service layer. If userId mismatch or MOC not found, return 404 (not 403, to avoid leaking existence).
- [ ] **AC-5**: Endpoint validates request body with UpdateMocInputSchema (Zod). Schema matches CreateMocInputSchema rules (all fields optional for partial update).
- [ ] **AC-6**: Title validation (if provided): min 3 characters, max 500 characters, non-empty string. Return 400 if invalid.
- [ ] **AC-7**: Description validation (if provided): max 5000 characters, can be empty or null (optional field). Return 400 if exceeds max.
- [ ] **AC-8**: Theme validation (if provided): non-empty string, required if included in request. Return 400 if empty string.
- [ ] **AC-9**: Tags validation (if provided): array of strings, max 20 tags. Return 400 if array length > 20.
- [ ] **AC-10**: Update mocs.updatedAt timestamp on successful update. Use database trigger if available; otherwise set manually in service layer.
- [ ] **AC-11**: Return 200 with updated MOC data on success. Response includes all MOC fields (id, title, description, theme, tags, userId, createdAt, updatedAt, thumbnailUrl, etc.).
- [ ] **AC-12**: Return 400 with validation errors on invalid input. Error response includes field-level error messages (e.g., `{ errors: { title: "Title must be at least 3 characters" } }`).
- [ ] **AC-13**: Return 404 if MOC not found by id or if user is not authorized (userId mismatch). Do not distinguish between "not found" and "unauthorized" in response to avoid leaking information.
- [ ] **AC-14**: Return 500 on database errors or unexpected server errors. Log error details for debugging.

### Frontend (EditMocPage)

- [ ] **AC-75**: EditMocPage component exists at route `/mocs/:id/edit` in `apps/web/app-instructions-gallery/src/pages/EditMocPage.tsx`.
- [ ] **AC-76**: Page fetches MOC data using `useGetMocDetailQuery(mocId)` on mount. Extract mocId from URL params.
- [ ] **AC-75**: Page shows loading skeleton while fetching MOC data (`isLoading` state). Skeleton matches MocForm layout (title input, description textarea, theme select, tags input).
- [ ] **AC-76**: Page shows 404 error state if MOC not found or user unauthorized. Display error message: "MOC not found" with subtext "This MOC doesn't exist or you don't have permission to edit it." Include "Go to My MOCs" button navigating to `/mocs`.
- [ ] **AC-75**: MocForm component is reused (imported from `apps/web/app-instructions-gallery/src/components/MocForm/`) with `initialValues` prop. Do NOT duplicate MocForm code.
- [ ] **AC-76**: Form fields pre-populate with current MOC values: title, description, theme, tags. Use data from `useGetMocDetailQuery` response.
- [ ] **AC-75**: Save button triggers `useUpdateMocMutation` with changed fields only (partial update). Mutation payload: `{ id: mocId, input: { ...changedFields } }`.
- [ ] **AC-76**: Cancel button navigates back to detail page (`/mocs/:id`). No PATCH request sent. Changes discarded.
- [ ] **AC-75**: Success shows toast "MOC updated!" and navigates to detail page (`/mocs/:id`). Toast auto-dismisses after 3 seconds.
- [ ] **AC-76**: Error shows toast with retry button (pattern from CreateMocPage). Toast message: "Failed to update MOC. [Error details]" with Retry and Dismiss buttons. Toast does not auto-dismiss (requires user action).
- [ ] **AC-75**: Form recovery: Save draft to localStorage on error (key: `moc-edit-draft-${mocId}`). On return to edit page, if draft exists, show recovery toast: "Unsaved changes found. Restore?" with Restore and Discard buttons. Clear localStorage draft on successful save.
- [ ] **AC-76**: Validation matches create page rules (client-side). Title min 3, max 500. Description max 5000. Theme required. Tags max 20. Same error messages as CreateMocPage.
- [ ] **AC-75**: Submit button disabled while submitting (`isSubmitting` state) or form invalid. Button shows loading spinner + "Saving..." text during submission.
- [ ] **AC-76**: Escape key cancels and returns to detail page. Keyboard listener: `keydown` event with `key === 'Escape'` triggers cancel action.
- [ ] **AC-75**: Cmd/Ctrl+Enter submits form (reused from MocForm). MocForm already implements this shortcut.

### Integration (Detail Page)

- [ ] **AC-76**: Edit button appears on MOC detail page (INST-1101 integration point). Button text: "Edit" or "Edit MOC". Style: Secondary button (outline variant).
- [ ] **AC-75**: Edit button navigates to `/mocs/:id/edit` when clicked. Use react-router Link or navigate function.
- [ ] **AC-76**: Edit button hidden if user is not MOC owner. Check: `currentUserId === moc.userId`. If false, do not render edit button.

### RTK Query Integration

- [ ] **AC-75**: `useUpdateMocMutation` called with `{ id: mocId, input: { ...changes } }` on form submit. Mutation endpoint: `PATCH /api/v2/mocs/:id`.
- [ ] **AC-76**: Cache invalidated for `Moc` tag (by id) on successful update. RTK Query automatically refetches `useGetMocDetailQuery` for the updated MOC.
- [ ] **AC-75**: Cache invalidated for `MocList` tag on successful update. RTK Query automatically refetches `useGetMocsQuery` (gallery list) to reflect title changes.
- [ ] **AC-76**: Optimistic update applied (optional enhancement, not required for MVP). If implemented: Update cache immediately before backend response, rollback on error.

### Testing (Backend)

- [ ] **AC-75**: Backend unit test: PATCH /mocs/:id with valid data returns 200 with updated MOC. Test partial update (only title changed).
- [ ] **AC-76**: Backend unit test: Authorization failure (userId mismatch) returns 404. User A cannot update User B's MOC.
- [ ] **AC-75**: Backend unit test: Validation error (title too short) returns 400 with error message. Title="AB" (2 chars) fails validation.
- [ ] **AC-76**: Backend unit test: Validation error (too many tags) returns 400. Tags array with 21 items fails validation.
- [ ] **AC-75**: Backend unit test: MOC not found returns 404. PATCH /mocs/non-existent-id returns 404.
- [ ] **AC-76**: Backend unit test: Partial update (only tags changed) succeeds. Only tags field updated, title/description/theme unchanged in database.
- [ ] **AC-75**: Backend unit test: updatedAt timestamp is updated on successful PATCH. Verify `moc.updatedAt` > original `updatedAt`.
- [ ] **AC-76**: Backend test coverage ≥90% for PATCH route handler. All branches (success, auth failure, validation errors) covered.

### Testing (Frontend Unit)

- [ ] **AC-75**: Frontend unit test: EditMocPage renders loading skeleton while fetching MOC. Mock `useGetMocDetailQuery` with `isLoading: true`. Assert: Loading skeleton visible, form not rendered.
- [ ] **AC-76**: Frontend unit test: EditMocPage renders form pre-populated with MOC data. Mock `useGetMocDetailQuery` with MOC data. Assert: Title input has value "Castle MOC", description has value, theme selected, tags displayed.
- [ ] **AC-75**: Frontend unit test: Save button disabled when form invalid. Change title to "AB" (too short). Assert: Save button has `disabled` attribute.
- [ ] **AC-76**: Frontend unit test: Cancel button navigates to detail page. Mock `useNavigate`. Click Cancel. Assert: `navigate('/mocs/test-moc-123')` called.
- [ ] **AC-75**: Frontend unit test: Save button triggers mutation. Mock `useUpdateMocMutation`. Change title to "New Title". Click Save. Assert: Mutation called with `{ id: 'test-moc-123', input: { title: 'New Title' } }`.
- [ ] **AC-76**: Frontend unit test: Success shows toast and navigates. Mock successful mutation. Submit form. Assert: Success toast displayed, `navigate('/mocs/test-moc-123')` called.
- [ ] **AC-75**: Frontend unit test: Error shows toast with retry. Mock mutation to return error. Submit form. Assert: Error toast visible with Retry button. Click Retry. Assert: Mutation called again.
- [ ] **AC-76**: Frontend unit test: Form recovery from localStorage. Set localStorage draft `{ title: "Draft Title" }`. Render EditMocPage. Assert: Recovery toast visible. Click Restore. Assert: Title input updated to "Draft Title".
- [ ] **AC-75**: Frontend unit test: 404 error state rendered when MOC not found. Mock `useGetMocDetailQuery` to return 404 error. Assert: 404 error page rendered (not form), "MOC not found" message visible.
- [ ] **AC-76**: Frontend test coverage ≥80% for EditMocPage component. All rendering paths, handlers, error states covered.

### Testing (Frontend Integration)

- [ ] **AC-75**: Frontend integration test: Fetches MOC data on mount. MSW handler: `GET /api/v2/mocs/test-moc-123` returns MOC data. Render EditMocPage. Assert: MSW handler called, form populated with data from response.
- [ ] **AC-76**: Frontend integration test: PATCH request sent on save. MSW handler: `PATCH /api/v2/mocs/test-moc-123` returns updated MOC. Change title. Click Save. Assert: MSW handler called with correct body, cache invalidated for `Moc` and `MocList` tags.
- [ ] **AC-75**: Frontend integration test: Handles validation error from backend. MSW handler: `PATCH /api/v2/mocs/test-moc-123` returns 400 validation error. Submit form. Assert: Error toast displayed, form still on edit page (no navigation).
- [ ] **AC-76**: Frontend integration test coverage ≥80% for RTK Query mutation flow and cache invalidation.

### Testing (E2E with Playwright)

- [ ] **AC-75**: E2E test: Navigate to edit page, change title, save, verify detail page shows new title. User navigates to `/mocs/test-moc-123/edit`, changes title to "Medieval Castle", clicks Save, verifies toast "MOC updated!" displayed, URL changed to `/mocs/test-moc-123`, detail page shows "Medieval Castle".
- [ ] **AC-76**: E2E test: Cancel returns to detail page without saving. User navigates to edit page, changes title to "New Title", clicks Cancel, verifies no PATCH request sent, URL changed to detail page, detail page shows original title "Castle MOC".
- [ ] **AC-75**: E2E test: Validation error prevents submission. User navigates to edit page, changes title to "AB" (too short), verifies validation error "Title must be at least 3 characters" displayed, Save button disabled, no PATCH request sent when form submitted.
- [ ] **AC-76**: E2E test: Form recovery restores unsaved changes. User navigates to edit page, changes title to "Draft Title", PATCH request fails with network error, user closes browser, returns to edit page, recovery toast "Unsaved changes found. Restore?" displayed, clicks Restore, title input shows "Draft Title".
- [ ] **AC-75**: E2E test: Edit button on detail page navigates to edit page (INST-1101 dependency). User on detail page for MOC "test-moc-123", clicks "Edit" button, verifies URL changed to `/mocs/test-moc-123/edit`, edit page loads with form pre-populated. **Note**: Deferred until INST-1101 (View MOC Details) is implemented. Alternative: Test direct navigation to edit URL.
- [ ] **AC-76**: E2E tests run against live backend API (per ADR-006). No MSW mocking in E2E tests. Tests use real PATCH endpoint and database.
- [ ] **AC-75**: E2E test coverage: At least 3 critical paths (edit + save, cancel, validation) pass with live API.

### Quality Gates

- [ ] **AC-76**: TypeScript compilation passes. No type errors in EditMocPage, backend route, schemas.
- [ ] **AC-75**: ESLint passes with no errors. Warnings addressed or documented. All new code follows project code style (no semicolons, single quotes, trailing commas, 2-space indent).
- [ ] **AC-76**: Prettier formatting applied. All new files formatted with project Prettier config.
- [ ] **AC-75**: No hardcoded colors. All colors use Tailwind theme tokens (e.g., `bg-sky-600`, `text-gray-900`). No hex, RGB, or inline style colors.
- [ ] **AC-76**: Imports from `@repo/app-component-library` (not `_primitives/` paths). Correct: `import { Button } from '@repo/app-component-library'`. Incorrect: `import { Button } from '@repo/app-component-library/_primitives/button'`.
- [ ] **AC-75**: MocForm component reused without duplication. No copy-paste of MocForm code. EditMocPage imports and renders MocForm component.
- [ ] **AC-76**: Zod schemas used for all types. No TypeScript interfaces without Zod. UpdateMocInputSchema defined with Zod, TypeScript type inferred via `z.infer<typeof UpdateMocInputSchema>`.
- [ ] **AC-75**: All interactive elements keyboard accessible. Tab order logical (title → description → theme → tags → buttons). Escape cancels, Cmd+Enter saves. Focus indicators visible on all inputs/buttons.
- [ ] **AC-76**: Screen reader support. All form labels use `htmlFor` attribute. ARIA live regions for toasts. Error messages linked to inputs via `aria-describedby`. Loading states announced via `aria-busy` and `aria-live`.
- [ ] **AC-75**: No console.log statements. Use `@repo/logger` for all logging. Correct: `logger.info('MOC updated', { mocId })`. Incorrect: `console.log('MOC updated', mocId)`.
- [ ] **AC-76**: Pre-commit hooks pass. Lint, type-check, and relevant tests run successfully before commit.

---

## Reuse Plan

### Components (95% Reuse)

1. **MocForm Component** (100% reuse from INST-1102):
   - Import: `apps/web/app-instructions-gallery/src/components/MocForm/`
   - Props: `{ initialValues, onSubmit, onCancel, isSubmitting, apiError }`
   - Usage: `<MocForm initialValues={mocData} onSubmit={handleSave} onCancel={handleCancel} isSubmitting={isUpdating} apiError={updateError} />`
   - No modifications needed—component already supports `initialValues` prop

2. **UI Primitives** from `@repo/app-component-library`:
   - Button (primary for Save, secondary for Cancel)
   - Input, Textarea, Label, Select (already used in MocForm)
   - Toast components for success/error feedback

3. **CreateMocPage Patterns** (structure reuse):
   - Page layout: Header with back link, form wrapper, max-width container
   - Error handling: `showErrorToastWithRetry` pattern
   - Form recovery: `useLocalStorage` hook for draft persistence
   - Navigation: Back button, cancel button, escape key handler

### Hooks (100% Reuse)

1. **RTK Query Hooks** from `@repo/api-client/rtk/instructions-api`:
   - `useGetMocDetailQuery(mocId)`: Fetch MOC data for pre-population
   - `useUpdateMocMutation()`: Trigger update and cache invalidation (already exists, lines 227-242)

2. **Utility Hooks**:
   - `useLocalStorage`: Form draft persistence (from CreateMocPage)
   - `useNavigate`: react-router navigation
   - `useParams`: Extract mocId from URL

### Backend Patterns (70% Reuse)

1. **Route Structure** from `POST /mocs` (INST-1102):
   - Request body extraction and parsing
   - Zod validation with error formatting
   - Authorization check (userId matches MOC owner)
   - Database operation (UPDATE instead of INSERT)
   - Response formatting

2. **Validation Schema** from `CreateMocInputSchema`:
   - Title: min 3, max 500 characters
   - Description: max 5000 characters
   - Theme: non-empty string
   - Tags: array, max 20 tags
   - **Adaptation**: `UpdateMocInputSchema = CreateMocInputSchema.partial()` - Derives from CreateMocInputSchema with all fields optional for partial update

### Testing Patterns (60-70% Reuse)

1. **Backend Tests**: Authorization, validation, error handling patterns from `POST /mocs` tests
2. **Frontend Unit Tests**: Form rendering, validation, navigation from `CreateMocPage` tests
3. **E2E Tests**: Form interaction, assertion patterns from INST-1102 E2E tests
4. **New Test Code**: Pre-population tests, cancel workflow tests, form recovery tests

### Packages (No New Packages)

- `@repo/app-component-library`: UI components (already used)
- `@repo/api-client`: RTK Query hooks and schemas (already used)
- `@repo/logger`: Structured logging (already used)
- No new package dependencies required

---

## Architecture Notes

### Frontend Architecture

**EditMocPage Component Structure:**
```tsx
// apps/web/app-instructions-gallery/src/pages/EditMocPage.tsx

import { useParams, useNavigate } from 'react-router-dom'
import { useGetMocDetailQuery, useUpdateMocMutation } from '@repo/api-client/rtk/instructions-api'
import { MocForm } from '../components/MocForm'
import { showSuccessToast, showErrorToastWithRetry } from '../utils/toast'
import { useLocalStorage } from '../hooks/useLocalStorage'

export function EditMocPage() {
  const { id: mocId } = useParams<{ id: string }>()
  const navigate = useNavigate()

  // Fetch MOC data
  const { data: moc, isLoading, isError } = useGetMocDetailQuery(mocId)

  // Update mutation
  const [updateMoc, { isLoading: isUpdating, error: updateError }] = useUpdateMocMutation()

  // Form recovery
  const [draft, setDraft, clearDraft] = useLocalStorage(`moc-edit-draft-${mocId}`, null)

  // Handlers
  const handleSave = async (formData) => {
    try {
      await updateMoc({ id: mocId, input: formData }).unwrap()
      clearDraft()
      showSuccessToast('MOC updated!')
      navigate(`/mocs/${mocId}`)
    } catch (error) {
      setDraft(formData) // Save draft on error
      showErrorToastWithRetry('Failed to update MOC', () => handleSave(formData))
    }
  }

  const handleCancel = () => {
    navigate(`/mocs/${mocId}`)
  }

  // Render loading skeleton
  if (isLoading) return <LoadingSkeleton />

  // Render 404 error
  if (isError || !moc) return <NotFoundError />

  // Form recovery prompt
  const initialValues = draft || {
    title: moc.title,
    description: moc.description,
    theme: moc.theme,
    tags: moc.tags,
  }

  return (
    <div>
      <h1>Editing: {moc.title}</h1>
      <MocForm
        initialValues={initialValues}
        onSubmit={handleSave}
        onCancel={handleCancel}
        isSubmitting={isUpdating}
        apiError={updateError}
      />
    </div>
  )
}
```

**Key Principles:**
1. **Separation of Concerns**: EditMocPage is a container (handles data fetching, state, navigation). MocForm is a presentational component (handles form UI, validation, user input).
2. **Reuse Over Duplication**: MocForm is imported and configured, not copied.
3. **Error Resilience**: Form draft saved to localStorage on error, recovered on return.
4. **User Feedback**: Toast notifications for success and error states.

### Backend Architecture

**Service Layer (REQUIRED per Ports & Adapters):**
```typescript
// apps/api/lego-api/domains/mocs/application/services.ts

import { UpdateMocInput } from '@repo/api-client/schemas/instructions'
import { Result } from '@repo/api-client/types'

export class MocService {
  async updateMoc(
    userId: string,
    mocId: string,
    input: UpdateMocInput
  ): Promise<Result<Moc, 'NOT_FOUND' | 'FORBIDDEN' | 'VALIDATION_ERROR'>> {
    // Authorization: Check userId matches moc owner
    const moc = await this.mocRepo.findById(mocId)
    if (!moc) {
      return Result.err('NOT_FOUND')
    }
    if (moc.userId !== userId) {
      return Result.err('FORBIDDEN')
    }

    // Partial update: Only update provided fields
    const updated = await this.mocRepo.update(mocId, {
      ...input,
      updatedAt: new Date(), // Set if no DB trigger
    })

    return Result.ok(updated)
  }
}
```

**PATCH Route Handler (Thin Adapter):**
```typescript
// apps/api/lego-api/domains/mocs/routes.ts

import { UpdateMocInputSchema } from '@repo/api-client/schemas/instructions'
import { mocService } from './application/services'

router.patch('/mocs/:id', async (req, res) => {
  try {
    // Validate request body
    const input = UpdateMocInputSchema.parse(req.body)

    // Call service layer
    const result = await mocService.updateMoc(req.user.id, req.params.id, input)

    // Map Result to HTTP status codes
    if (result.isErr()) {
      if (result.error === 'NOT_FOUND' || result.error === 'FORBIDDEN') {
        return res.status(404).json({ error: 'MOC not found' })
      }
      return res.status(400).json({ error: result.error })
    }

    return res.status(200).json(result.value)
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ errors: error.flatten() })
    }
    logger.error('PATCH /mocs/:id error', { error, mocId: req.params.id })
    return res.status(500).json({ error: 'Internal server error' })
  }
})
```

**Key Principles:**
1. **Ports & Adapters Compliance**: Business logic lives in service layer (`mocService.updateMoc()`), NOT in route handler. Route handler is thin adapter that validates input, calls service, maps Result to HTTP codes.
2. **Partial Update Semantics**: Only fields provided in request body are updated. Omitted fields remain unchanged.
3. **Authorization as 404**: Do not distinguish "not found" from "unauthorized" to avoid leaking information. Both return 404.
4. **Zod Validation**: Reuse UpdateMocInputSchema for consistent validation between frontend and backend.
5. **Error Handling**: Structured error responses (400 for validation, 404 for not found, 500 for server errors).

### Database Considerations

**updatedAt Timestamp:**
- **Option A (Recommended)**: Database trigger automatically sets `updatedAt = NOW()` on any UPDATE to `mocs` table. No manual code needed.
- **Option B**: Backend route explicitly sets `updatedAt: new Date()` in update query.
- **Decision**: Use database trigger if it exists (check INST-1102 implementation). Otherwise, set manually in backend.

**Partial Update Query:**
- Prisma/Drizzle: `db.mocs.update({ where: { id }, data: { ...input } })` only updates fields in `input` object.
- SQL: `UPDATE mocs SET title = COALESCE($1, title), description = COALESCE($2, description), ... WHERE id = $3`
- **Result**: Omitted fields are not touched, preserving existing values.

### RTK Query Cache Invalidation

**Cache Tags:**
- `Moc` (by id): Invalidated on update to refetch detail page data
- `MocList`: Invalidated on update to refetch gallery list (in case title changed)

**Implementation** (already exists in `instructions-api.ts`):
```typescript
updateMoc: builder.mutation<MocInstructions, { id: string; input: UpdateMocInput }>({
  query: ({ id, input }) => ({
    url: `/instructions/mocs/${id}`,
    method: 'PATCH',
    body: input,
  }),
  invalidatesTags: (result, error, { id }) => [
    { type: 'Moc', id },
    { type: 'MocList' },
  ],
}),
```

**Effect**: After successful PATCH, RTK Query automatically refetches:
- `useGetMocDetailQuery(id)` (detail page shows updated data)
- `useGetMocsQuery()` (gallery list shows updated title)

---

## Test Plan

### Backend Tests (apps/api/lego-api/domains/mocs/__tests__/routes.test.ts)

**Happy Path:**
1. PATCH /mocs/:id with valid data (only title changed) → 200 with updated MOC
2. PATCH /mocs/:id with multiple fields → 200 with all fields updated
3. PATCH /mocs/:id with no changes (same values) → 200 (no-op)

**Error Cases:**
1. Authorization failure (userId mismatch) → 404
2. Validation error (title too short: "AB") → 400 with error message
3. Validation error (title too long: 501 chars) → 400
4. Validation error (description too long: 5001 chars) → 400
5. Validation error (too many tags: 21 items) → 400
6. MOC not found (invalid id) → 404
7. Server error (database failure) → 500

**Coverage Target**: ≥90% for PATCH route handler

**Evidence**: `.http` requests for each scenario, assertions on status codes and response bodies

### Frontend Unit Tests (apps/web/app-instructions-gallery/src/pages/__tests__/EditMocPage.test.tsx)

**Rendering:**
1. Renders loading skeleton while fetching MOC (mock `isLoading: true`)
2. Renders 404 error state if MOC not found (mock error)
3. Renders form pre-populated with MOC data (mock successful fetch)

**Validation:**
1. Save button disabled when form invalid (title too short)
2. Save button enabled when form valid
3. Error message displayed for invalid title

**Navigation:**
1. Cancel button navigates to detail page (mock `useNavigate`)
2. Escape key navigates to detail page

**Submission:**
1. Save button triggers mutation with correct payload (mock `useUpdateMocMutation`)
2. Success shows toast and navigates to detail page
3. Error shows toast with retry button

**Form Recovery:**
1. localStorage draft restored on page load (mock localStorage with draft)
2. Recovery toast displayed if draft exists
3. Restore button loads draft into form
4. Discard button clears draft

**Coverage Target**: ≥80% for EditMocPage component

### Frontend Integration Tests (apps/web/app-instructions-gallery/src/pages/__tests__/EditMocPage.integration.test.tsx)

**MSW Handlers:**
1. GET /api/v2/mocs/:id returns MOC data → form populates
2. PATCH /api/v2/mocs/:id returns updated MOC → cache invalidated
3. PATCH /api/v2/mocs/:id returns 400 validation error → error toast displayed
4. PATCH /api/v2/mocs/:id returns 500 server error → error toast with retry

**Coverage Target**: ≥80% for RTK Query integration

### E2E Tests (apps/web/playwright/features/instructions/inst-1108-edit.feature)

**Scenario 1: Edit Title and Save**
```gherkin
Feature: Edit MOC Metadata
  Scenario: Edit title and description
    Given user owns MOC "Castle MOC" with id "test-moc-123"
    And user is authenticated
    When user navigates to "/mocs/test-moc-123/edit"
    Then edit page loads with form pre-populated
    And title input shows "Castle MOC"
    When user changes title to "Medieval Castle"
    And user clicks Save button
    Then PATCH request sent to backend
    And success toast "MOC updated!" displayed
    And user redirected to "/mocs/test-moc-123"
    And detail page shows title "Medieval Castle"
```

**Scenario 2: Cancel Edit**
```gherkin
  Scenario: Cancel edit without saving
    Given user on edit page for MOC "test-moc-123"
    And title is "Castle MOC"
    When user changes title to "New Title"
    And user clicks Cancel button
    Then no PATCH request sent
    And user redirected to "/mocs/test-moc-123"
    And detail page shows original title "Castle MOC"
```

**Scenario 3: Validation Error**
```gherkin
  Scenario: Validation prevents invalid submission
    Given user on edit page for MOC "test-moc-123"
    When user changes title to "AB"
    Then validation error "Title must be at least 3 characters" displayed
    And Save button is disabled
    When user attempts to submit form
    Then no PATCH request sent
```

**Scenario 4: Form Recovery**
```gherkin
  Scenario: Restore unsaved changes from localStorage
    Given user on edit page for MOC "test-moc-123"
    When user changes title to "Draft Title"
    And PATCH request fails with network error
    And user closes browser
    And user returns to "/mocs/test-moc-123/edit"
    Then recovery toast "Unsaved changes found. Restore?" displayed
    When user clicks Restore
    Then title input shows "Draft Title"
```

**Test Data Setup**: Use INST-1102 (Create MOC) flow to create test MOC before edit test. Capture created MOC ID, then navigate to edit URL.

**Coverage Target**: At least 3 critical paths (edit + save, cancel, validation) pass with live API (per ADR-006)

---

## UI/UX Notes

### Design Consistency

EditMocPage MUST match CreateMocPage in:
- Layout: Same max-width (`max-w-3xl`), padding (`px-4 py-8`), centered (`mx-auto`)
- Header: Same back link style (`text-sky-600 hover:text-sky-700`), page title format (`text-3xl font-bold`)
- Buttons: Same button styles (primary `bg-sky-600`, secondary `border-gray-300`)
- Toasts: Same toast styling, duration (success: 3s, error: 5s), position (top-right)
- Error handling: Same error toast with retry pattern

### Visual Layout

```
┌─────────────────────────────────────────┐
│ ← Back to [MOC Title]                   │
├─────────────────────────────────────────┤
│                                         │
│  Editing: [MOC Title]                   │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  MocForm Component                │ │
│  │  - Title input                    │ │
│  │  - Description textarea           │ │
│  │  - Theme select                   │ │
│  │  - Tags multi-select              │ │
│  │  - Cancel button | Save button    │ │
│  └───────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

### Loading States

**Initial Load (Fetching MOC Data):**
- Display loading skeleton matching form layout
- Skeleton components: title input, description textarea, theme select, tags input
- Duration: Until `useGetMocDetailQuery` resolves

**Submitting (Saving Changes):**
- Save button shows spinner + "Saving..." text
- Save button disabled (prevents double submit)
- Form inputs remain enabled

### Accessibility Requirements

**MVP-Critical:**
1. All form labels use `htmlFor` attribute linked to input `id`
2. Field-level errors announced via `aria-describedby`
3. Loading states announced via `aria-busy="true"` and `aria-live="polite"`
4. Save button: `aria-disabled="true"` when form invalid or submitting
5. Toast announcements: Success toast `role="status"`, error toast `role="alert"`
6. Keyboard navigation: Tab order (title → description → theme → tags → buttons)
7. Keyboard shortcuts: Escape cancels, Cmd+Enter saves
8. Focus indicators: All interactive elements have visible focus ring (`focus-visible:ring-2 focus-visible:ring-sky-500`)

**Screen Reader Support:**
- Page title announced: `<h1>Editing: {mocTitle}</h1>`
- Error messages linked to inputs: `<input aria-describedby="title-error" />`
- Loading announcement: "Loading MOC data"
- Button state announcement: "Saving, please wait"

### Edge Cases

1. **MOC Not Found or Unauthorized**: Display 404 error page (not form). Message: "MOC not found" with "Go to My MOCs" button.
2. **Slow Network (Form Data Load)**: Show loading skeleton for up to 10 seconds. After 10s, show "Taking longer than usual..." with Retry button.
3. **Browser Refresh During Edit**: If localStorage draft exists, show recovery toast. Otherwise, re-fetch MOC data.
4. **Special Characters in Title/Description**: Properly escaped/encoded in PATCH request. Backend stores and returns correctly. Detail page displays special chars correctly.

---

## Reality Baseline

### What Exists Today

1. **MocForm Component** (`apps/web/app-instructions-gallery/src/components/MocForm/index.tsx`):
   - Implemented in INST-1102 (Create Basic MOC), currently in QA
   - Supports `initialValues` prop for pre-populating fields
   - Validation: title (min 3, max 500), description (max 5000), theme (required), tags (max 20)
   - Features: Auto-focus, Cmd+Enter submit, Escape cancel, field-level errors

2. **RTK Query Mutation** (`packages/core/api-client/src/rtk/instructions-api.ts`, lines 227-242):
   - `useUpdateMocMutation` exists and configured
   - Endpoint: `PATCH /api/v2/mocs/:id`
   - Cache invalidation: `Moc` (by id), `MocList`

3. **CreateMocPage Pattern** (`apps/web/app-instructions-gallery/src/pages/CreateMocPage.tsx`):
   - Established patterns: Form recovery with localStorage, error toast with retry, navigation patterns, loading state management
   - Reusable for EditMocPage structure

4. **Backend Routes** (`apps/api/lego-api/domains/mocs/routes.ts`):
   - Existing routes: GET /mocs, POST /mocs, GET /mocs/:id, POST /mocs/:id/thumbnail
   - **Gap**: PATCH /mocs/:id does NOT exist (must implement)

5. **Database Schema**:
   - `mocs` table exists with fields: id, userId, title, description, theme, tags, createdAt, updatedAt, thumbnailUrl
   - No schema changes required for this story

### What's Missing

1. **PATCH /mocs/:id Backend Endpoint**: Does not exist. Must implement with authorization, validation, partial update semantics.
2. **UpdateMocInputSchema**: May need to be added to `@repo/api-client/schemas/instructions` (or reuse CreateMocInputSchema with all fields optional).
3. **EditMocPage Component**: New page component at `/mocs/:id/edit`.
4. **Edit Button on Detail Page**: Integration point in INST-1101 (View MOC Details), currently not implemented.
5. **Tests**: Backend tests, frontend unit/integration/E2E tests for edit functionality.

### Constraints from Reality

1. **ADR-001 (API Path Schema)**: Frontend calls `/api/v2/mocs/:id`, backend route is `/mocs/:id`. Vite proxy rewrites paths.
2. **ADR-006 (E2E Tests in Dev Phase)**: At least one happy-path E2E test required during dev, using live API (no MSW).
3. **Zod-First Types**: All schemas must be Zod with inferred TypeScript types. No plain TypeScript interfaces.
4. **Component Reuse**: MocForm MUST be reused, not duplicated. EditMocPage imports and configures MocForm.
5. **INST-1101 Dependency**: Edit button on detail page cannot be tested until INST-1101 (View MOC Details) is implemented. Workaround: Test direct navigation to `/mocs/:id/edit` URL.

---

## Risks

### Risk: Concurrent Edits (Last-Write-Wins)

**Description**: MVP uses last-write-wins semantics. No optimistic locking or conflict detection. If two users edit the same MOC simultaneously, the last save overwrites the previous changes without warning.

**Impact**: Medium. In personal use (single user per MOC), conflict risk is low. Risk increases if sharing/collaboration features are added in future.

**Mitigation (MVP)**: Accept risk for MVP. Document behavior in Non-Goals (line 59).

**Future Enhancement**: Add `version` field to mocs table + optimistic locking (compare-and-swap pattern). Service checks version match before update, returns 409 Conflict if stale. Frontend shows conflict resolution UI. Tracked in Future Opportunities (Gap #1).

---

## Dependencies

### Blocked By

- **INST-1101 (View MOC Details)**: Edit button will be placed on the detail page. E2E test for "click edit button to navigate to edit page" deferred until INST-1101 completes. Status: Ready to Work.
  - **Mitigation**: Test direct navigation to `/mocs/:id/edit` URL in E2E tests. Edit button integration is AC-30 to AC-32, marked as INST-1101 dependency.

### Blocks

None. This story is a leaf node in the dependency graph.

### Related Stories

- **INST-1102 (Create Basic MOC)**: Provides MocForm component for reuse. Status: In QA (2026-02-07).
- **INST-1103 (Upload Thumbnail)**: Separate file management flow. Not affected by metadata edit.
- **INST-1104 (Upload Instructions)**: Separate file management flow. Not affected by metadata edit.
- **INST-1106 (Upload Parts List)**: Separate file management flow. Not affected by metadata edit.
- **INST-1110 (Remove Individual File)**: Separate file management flow. Not affected by metadata edit.
- **INST-1200 (Unsaved Changes Guard)**: Future enhancement to warn users before navigating away with unsaved changes. Not part of MVP.

---

## Implementation Checklist

### Phase 1: Backend Implementation (2-3 hours)

- [ ] Define `UpdateMocInputSchema = CreateMocInputSchema.partial()` in `@repo/api-client/schemas/instructions` (derives from CreateMocInputSchema, all fields optional for partial update)
- [ ] Create service layer method `mocService.updateMoc(userId, mocId, input)` in `apps/api/lego-api/domains/mocs/application/services.ts` per Ports & Adapters architecture
- [ ] Service method implements: (1) Authorization check (userId matches moc.userId), (2) Partial update logic, (3) Returns Result<Moc, 'NOT_FOUND' | 'FORBIDDEN' | 'VALIDATION_ERROR'>
- [ ] Implement PATCH /mocs/:id route in `apps/api/lego-api/domains/mocs/routes.ts` as THIN ADAPTER (no business logic in route)
- [ ] Route handler validates request body with UpdateMocInputSchema (Zod)
- [ ] Route handler calls `mocService.updateMoc()` and maps Result to HTTP status codes (200/404/400/500)
- [ ] Set updatedAt timestamp in service layer (via trigger or manual)
- [ ] Write backend unit tests for service layer (authorization, validation, success, error cases)
- [ ] Write backend unit tests for route handler (thin adapter tests)
- [ ] Test with `.http` requests
- [ ] Verify 90% test coverage for PATCH route handler + service method

### Phase 2: Frontend Implementation (3-4 hours)

- [ ] Create EditMocPage component at `apps/web/app-instructions-gallery/src/pages/EditMocPage.tsx`
- [ ] Fetch MOC data with `useGetMocDetailQuery(mocId)` on mount
- [ ] Render loading skeleton while fetching
- [ ] Render 404 error state if MOC not found or unauthorized
- [ ] Import and render MocForm component with `initialValues` prop (MOC data)
- [ ] Wire up `useUpdateMocMutation` on form submit
- [ ] Implement handleSave (trigger mutation, show toast, navigate on success)
- [ ] Implement handleCancel (navigate to detail page)
- [ ] Implement form recovery (save draft to localStorage on error, restore on return)
- [ ] Implement Escape key handler for cancel
- [ ] Add route to router: `/mocs/:id/edit` → `<EditMocPage />`
- [ ] Write frontend unit tests (rendering, validation, navigation, submission, recovery)
- [ ] Write frontend integration tests (RTK Query mutation flow with MSW)
- [ ] Verify 80% test coverage for EditMocPage component

### Phase 3: Integration (INST-1101 Dependency)

- [ ] Add Edit button to MocDetailPage (INST-1101 integration point)
- [ ] Edit button navigates to `/mocs/:id/edit`
- [ ] Edit button hidden if user is not MOC owner (authorization check)
- [ ] **Note**: This phase deferred until INST-1101 (View MOC Details) is implemented

### Phase 4: E2E Testing (2-3 hours)

- [ ] Write E2E test: Edit title, save, verify detail page shows new title
- [ ] Write E2E test: Cancel edit without saving
- [ ] Write E2E test: Validation error prevents submission
- [ ] Write E2E test: Form recovery from localStorage
- [ ] Use INST-1102 Create MOC flow to set up test data
- [ ] Run E2E tests against live backend API (per ADR-006)
- [ ] Capture screenshots and traces on failure
- [ ] Verify at least 3 critical paths pass

### Phase 5: Code Review and Polish (1 hour)

- [ ] Address code review comments
- [ ] Verify TypeScript compilation passes (no type errors)
- [ ] Verify ESLint passes (no errors, warnings addressed)
- [ ] Verify Prettier formatting applied
- [ ] Verify no hardcoded colors (token-only)
- [ ] Verify imports from `@repo/app-component-library` (not `_primitives/` paths)
- [ ] Verify no console.log statements (use `@repo/logger`)
- [ ] Test keyboard navigation (Tab, Escape, Cmd+Enter)
- [ ] Test screen reader support (VoiceOver on Mac, NVDA on Windows)
- [ ] Verify all ACs (AC-1 to AC-76) satisfied
- [ ] Update documentation if needed
- [ ] Ready for QA handoff

---

## Lessons Applied

### From INST-1102 (Create Basic MOC)

1. **MocForm Component Design**: Reusable form component with `initialValues` prop. EditMocPage leverages this design for pre-population.
2. **Error Handling Pattern**: `showErrorToastWithRetry` pattern for failed mutations. EditMocPage uses the same pattern for consistency.
3. **Form Recovery Pattern**: localStorage draft persistence on error. EditMocPage implements the same pattern for resilience.
4. **Validation Consistency**: Client-side validation matches backend validation (Zod schemas). EditMocPage reuses validation rules from CreateMocPage.

### From ADR-006 (E2E Tests in Dev Phase)

1. **E2E with Live API**: E2E tests must use real backend, not MSW. EditMocPage E2E tests will call live PATCH endpoint.
2. **At Least One Happy Path**: Minimum one E2E scenario passing during dev. EditMocPage will have "edit title and save" E2E test.

### From ADR-001 (API Path Schema)

1. **Path Rewriting**: Frontend calls `/api/v2/mocs/:id`, backend route is `/mocs/:id`. Vite proxy handles rewriting. EditMocPage follows this pattern.

---

## Success Metrics

### Implementation Success

- [ ] PATCH /mocs/:id backend endpoint implemented with 90% test coverage
- [ ] EditMocPage frontend component implemented with 80% test coverage
- [ ] At least 3 E2E scenarios pass with live API
- [ ] All 76 acceptance criteria satisfied
- [ ] Implementation completed within 8-10 hour estimate (±20% variance acceptable)

### Quality Gates

- [ ] TypeScript compilation passes (no type errors)
- [ ] ESLint passes (no errors, warnings addressed)
- [ ] Prettier formatting applied
- [ ] Pre-commit hooks pass (lint, type-check, tests)
- [ ] No hardcoded colors (token-only enforcement)
- [ ] No console.log statements (use @repo/logger)
- [ ] MocForm component reused (no duplication)
- [ ] Keyboard navigation works (Tab, Escape, Cmd+Enter)
- [ ] Screen reader support verified

### User Experience Success

- [ ] Users can edit MOC metadata without errors
- [ ] Form pre-populates with current MOC data
- [ ] Validation prevents invalid submissions
- [ ] Success and error feedback is clear (toasts)
- [ ] Form recovery works after errors (localStorage)
- [ ] Cancel workflow discards changes correctly
- [ ] Edit button visible only to MOC owner (authorization)

---

## Story Points Estimate

**3 points** (Medium complexity)

**Justification:**
- Backend: Straightforward PATCH route (2-3 hours, reuses POST /mocs patterns)
- Frontend: EditMocPage with high reuse (3-4 hours, MocForm already exists)
- Testing: Backend, frontend, E2E tests (2-3 hours, reuses test patterns from INST-1102)
- Total: 8-10 hours = 1-1.5 days = 3 story points

**Confidence**: High. Estimate based on extensive code reuse (95% frontend, 70% backend) and clear patterns from INST-1102.

---

## Notes for QA

### Critical Test Scenarios

1. **Authorization**: Verify user can only edit their own MOCs. Attempting to edit another user's MOC should return 404 (not 403).
2. **Validation**: Test all validation rules (title min/max, description max, tags max). Both client-side (Save button disabled) and server-side (400 error) validation must work.
3. **Form Pre-Population**: Verify form loads with current MOC data. All fields (title, description, theme, tags) display correctly.
4. **Save Flow**: Change fields, click Save, verify toast "MOC updated!" displayed, redirected to detail page, detail page shows updated data.
5. **Cancel Flow**: Change fields, click Cancel, verify no PATCH request sent, redirected to detail page, detail page shows original data (changes discarded).
6. **Form Recovery**: Change fields, trigger error (e.g., network failure), close browser, return to edit page, verify recovery toast displayed, click Restore, verify form shows draft data.
7. **Keyboard Navigation**: Tab through all inputs, Escape cancels, Cmd+Enter saves.
8. **Screen Reader**: Test with VoiceOver (Mac) or NVDA (Windows). Verify labels, errors, and toast announcements.

### Edge Cases to Test

1. **Empty Description**: Clear description field (optional field), save, verify succeeds.
2. **Boundary Values**: Title exactly 3 chars (min), 500 chars (max). Description exactly 5000 chars (max). Tags exactly 20 items (max).
3. **Special Characters**: Title/description with quotes, ampersands, newlines. Verify properly stored and displayed.
4. **Concurrent Edits**: Edit MOC in two browser tabs. Verify last write wins (no conflict detection in MVP).
5. **MOC Deleted During Edit**: Another user deletes MOC while first user editing. On save, verify 404 error handled gracefully.

### QA Acceptance Criteria

- [ ] All 76 ACs verified (manual and automated tests)
- [ ] No regressions in existing features (CreateMocPage, MocForm, gallery, detail page)
- [ ] Authorization correctly prevents unauthorized edits
- [ ] All validation rules enforced (client and server)
- [ ] Form recovery works after errors
- [ ] Keyboard navigation and screen reader support verified
- [ ] E2E tests pass with live API (at least 3 scenarios)

---

**Generated**: 2026-02-09 by PM Story Generation Leader
**Seed File**: `/Users/michaelmenard/Development/Monorepo/plans/future/instructions/backlog/INST-1108/_pm/STORY-SEED.md`
**Worker Artifacts**:
- Test Plan: `_pm/TEST-PLAN.md`
- UI/UX Notes: `_pm/UIUX-NOTES.md`
- Dev Feasibility: `_pm/DEV-FEASIBILITY.md`

---

## QA Discovery Notes (Auto-Generated)

_Added by Autonomous Elaboration on 2026-02-09_

### MVP Gaps Resolved

| # | Finding | Resolution | AC Added |
|---|---------|------------|----------|
| 1 | Service layer not planned for PATCH endpoint - business logic in route handler violates Ports & Adapters architecture | Add as AC - MVP-critical. Blocks architecture compliance. Added AC-1 (service layer method) and AC-3 (thin adapter route). Updated Backend Architecture section with service layer example code. | AC-1, AC-3 |

### Non-Blocking Items (Logged to KB)

| # | Finding | Category | Impact | Effort | Resolution |
|---|---------|----------|--------|--------|------------|
| 1 | No validation on unchanged form submission | edge-case | Low | Low | Disable Save button when form values equal initialValues. Compare to initialValues on every change. |
| 2 | No rate limiting on PATCH endpoint | performance | Medium | Medium | Already planned in INST-1203 (Rate Limiting & Observability). Defer to that story. |
| 3 | No audit trail for metadata changes | observability | Low | High | Story excludes edit history (Non-Goals). Defer to post-MVP moderation features. |
| 4 | No partial failure handling for cache invalidation | performance | Low | Medium | Add refetch error handling. Show toast "Update saved, but failed to refresh. Please reload." |
| 5 | Form recovery overwrites manual edits on return | edge-case | Low | Low | Clear localStorage draft on Cancel action. Check if user explicitly cancelled. |
| 6 | No slug regeneration on title change | edge-case | Low | Medium | Requires product decision. Defer to future slug management story. |
| 7 | No field-level dirty tracking for form recovery | performance | Low | Medium | Use react-hook-form's `dirtyFields`. Reduces localStorage size. |
| 8 | Optimistic UI updates for instant feedback | ux-polish | High | Medium | Story defers optimistic updates (Non-Goals). Implement after MVP proven stable. |
| 9 | Unsaved changes navigation guard | ux-polish | High | Low | Already planned in INST-1200. React Router `beforeunload` + modal. |
| 10 | Auto-save drafts during editing | ux-polish | Medium | High | Proactive form recovery. Debounced localStorage save on form change. |
| 11 | Keyboard shortcut discoverability hints | accessibility | Medium | Low | Add button labels or help modal. Show Cmd+Enter (save), Escape (cancel). |
| 12 | Rich text editor for description field | integration | Medium | High | Requires schema change. Defer to post-MVP content editing. |
| 13 | Theme autocomplete with icons | ux-polish | Low | Medium | Upgrade Select to Combobox pattern with theme icons. |
| 14 | Tag suggestions from existing MOCs | integration | Medium | Medium | Backend endpoint GET /mocs/tags?userId=X with autocomplete. |
| 15 | Preview changes before saving | ux-polish | Medium | High | Read-only preview modal with form values. Users verify before commit. |
| 16 | Diff view for changes before saving | ux-polish | Low | High | Power user feature showing side-by-side diffs. |
| 17 | Bulk edit tags across multiple MOCs | integration | Low | High | Deferred (Non-Goals). Future multi-select + bulk PATCH endpoint. |
| 18 | Concurrent edit risk (last-write-wins) | architectural | Medium | N/A | Explicitly disclosed in Risks section. Future: Add `version` field + optimistic locking. |

### Summary

- **ACs added during elaboration**: 2 (AC-1: service layer method, AC-3: thin adapter route)
- **ACs renumbered**: Yes (AC-1 to AC-76, was AC-1 to AC-74)
- **KB entries created**: 18 findings logged for future refinement
- **Mode**: Autonomous
- **Story verdict**: CONDITIONAL PASS - ready for implementation with service layer and risk documentation
