# Auto-generated by elab-autonomous-decider
generated_at: "2026-02-09T19:30:00Z"
mode: autonomous
story_id: "INST-1108"

verdict: CONDITIONAL PASS

decisions:
  gaps:
    - id: 1
      finding: "Service layer not planned for PATCH endpoint - business logic in route handler violates Ports & Adapters architecture"
      decision: "Add as AC"
      notes: "MVP-critical. Blocks architecture compliance. Added AC-1 (service layer method) and AC-3 (thin adapter route). Updated Backend Architecture section with service layer example code."
      action: add_ac
      ac_added: [1, 3]

    - id: 2
      finding: "No validation on unchanged form submission - allows no-op saves"
      decision: "KB-logged"
      notes: "Non-blocking. Low impact edge case. Enhancement: Disable Save button when form values equal initialValues."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "edge-case"
        content: |
          - **Finding**: No validation on unchanged form submission in EditMocPage
          - **Impact**: Low | **Effort**: Low (1 hour)
          - **Recommendation**: Frontend currently allows saving form with no changes (AC-21 says "changed fields only" but doesn't enforce prevention of no-op saves). Enhancement: Disable Save button when form values equal initialValues. Compare form state to initialValues on every change. Show "No changes to save" tooltip on disabled button.
        additional_tags:
          - "non-blocking"
          - "frontend"
          - "validation"

    - id: 3
      finding: "No rate limiting on PATCH endpoint - user could spam updates"
      decision: "KB-logged"
      notes: "Non-blocking. Already planned in Phase 2 story INST-1203 (Rate Limiting & Observability). Defer to that story."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "performance"
        content: |
          - **Finding**: No rate limiting on PATCH /mocs/:id endpoint
          - **Impact**: Medium | **Effort**: Medium
          - **Recommendation**: Backend PATCH /mocs/:id has no rate limiting (story AC-14 only covers auth and validation errors). Risk: User could spam updates. Enhancement: Add rate limit middleware (e.g., 10 updates per minute per user). Already planned in Phase 2 story INST-1203 (Rate Limiting & Observability). Defer to that story.
        additional_tags:
          - "non-blocking"
          - "backend"
          - "rate-limiting"
          - "deferred-to-inst-1203"

    - id: 4
      finding: "No audit trail for metadata changes - no history tracking"
      decision: "KB-logged"
      notes: "Non-blocking. Story explicitly excludes edit history (Non-Goals line 53). Defer to post-MVP moderation features."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "observability"
        content: |
          - **Finding**: No audit trail for metadata changes in MOCs
          - **Impact**: Low | **Effort**: High (8-12 hours, 2-3 points)
          - **Recommendation**: Story explicitly excludes edit history (Non-Goals line 53). Enhancement: Add moc_edit_history table to track who changed what when. Requires schema change, history write on every update, admin UI to view history. Defer to post-MVP moderation features.
        additional_tags:
          - "non-blocking"
          - "database"
          - "audit-trail"
          - "future-work"

    - id: 5
      finding: "No partial failure handling for cache invalidation - refetch failures silent"
      decision: "KB-logged"
      notes: "Non-blocking. Low impact. RTK Query cache invalidation fails silently if refetch fails after successful PATCH."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "performance"
        content: |
          - **Finding**: No partial failure handling for RTK Query cache invalidation
          - **Impact**: Low | **Effort**: Medium (2 hours)
          - **Recommendation**: RTK Query cache invalidation (AC-34, AC-35) fails silently if refetch fails after successful PATCH. User sees stale data until manual refresh. Enhancement: Add refetch error handling in mutation callbacks. Show toast "Update saved, but failed to refresh. Please reload." with Reload button.
        additional_tags:
          - "non-blocking"
          - "frontend"
          - "rtk-query"
          - "error-handling"

    - id: 6
      finding: "Form recovery overwrites manual edits on return to page"
      decision: "KB-logged"
      notes: "Non-blocking. Low impact edge case. Form recovery always shows recovery toast if localStorage draft exists."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "edge-case"
        content: |
          - **Finding**: Form recovery overwrites manual edits on return to EditMocPage
          - **Impact**: Low | **Effort**: Low (1 hour)
          - **Recommendation**: Form recovery (AC-25) always shows recovery toast if localStorage draft exists, even if user intentionally discarded changes. Edge case: User edits, error occurs, user clicks Cancel (intending to discard), returns to edit page, recovery prompt appears. Enhancement: Clear localStorage draft on Cancel action. Add check: "If user explicitly cancelled, don't offer recovery."
        additional_tags:
          - "non-blocking"
          - "frontend"
          - "form-recovery"
          - "ux-polish"

    - id: 7
      finding: "No slug regeneration on title change - stale URLs"
      decision: "KB-logged"
      notes: "Non-blocking. Requires product decision on URL stability vs freshness. Defer to future slug management story."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "edge-case"
        content: |
          - **Finding**: Slug not regenerated when title changes in PATCH endpoint
          - **Impact**: Low | **Effort**: Medium (3-5 hours)
          - **Recommendation**: Story excludes slug editing (Non-Goals line 56: "Slug is auto-generated from title, not directly editable"). However, if user changes title from "Castle MOC" to "Medieval Castle", slug remains "castle-moc" (stale). Enhancement: Backend regenerates slug on title change OR frontend shows "New slug will be: medieval-castle" preview. Risk: URL change breaks external links. Consider slug redirect strategy. Defer to future slug management story.
        additional_tags:
          - "non-blocking"
          - "backend"
          - "slug"
          - "product-decision-required"

    - id: 8
      finding: "No field-level dirty tracking for form recovery - saves entire form state"
      decision: "KB-logged"
      notes: "Non-blocking. Low impact optimization. Form recovery saves entire form state to localStorage."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "performance"
        content: |
          - **Finding**: No field-level dirty tracking for form recovery in EditMocPage
          - **Impact**: Low | **Effort**: Medium (2 hours)
          - **Recommendation**: Form recovery (AC-25) saves entire form state to localStorage on error. Enhancement: Track dirty fields only. If user only changed title, only save title to draft. Reduces localStorage size and avoids restoring unchanged fields. Implementation: Use react-hook-form's `dirtyFields` metadata.
        additional_tags:
          - "non-blocking"
          - "frontend"
          - "form-recovery"
          - "optimization"

  enhancements:
    - id: 1
      finding: "Optimistic UI updates for instant feedback"
      decision: "KB-logged"
      notes: "High impact UX enhancement. Deferred to post-MVP per Non-Goals line 52."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "ux-polish"
        content: |
          - **Finding**: Optimistic UI updates could provide instant feedback in EditMocPage
          - **Impact**: High | **Effort**: Medium (3-4 hours)
          - **Recommendation**: Story explicitly defers optimistic updates (Non-Goals line 52). User experience enhancement: Immediately update cache on submit, rollback on error. Users see instant feedback instead of waiting for backend response. Implementation: RTK Query `optimisticUpdate` + rollback on mutation error. Risk: User sees success UI before backend validates (could show invalid state briefly). Recommendation: Implement after MVP proven stable.
        additional_tags:
          - "enhancement"
          - "frontend"
          - "optimistic-updates"
          - "ux-polish"

    - id: 2
      finding: "Unsaved changes navigation guard to prevent accidental loss"
      decision: "KB-logged"
      notes: "High impact UX enhancement. Already planned in INST-1200."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "ux-polish"
        content: |
          - **Finding**: Unsaved changes navigation guard would prevent accidental data loss
          - **Impact**: High | **Effort**: Low (2-3 hours, included in INST-1200)
          - **Recommendation**: Deferred to INST-1200 (Non-Goals line 51). User experience polish: Warn user before navigating away with unsaved changes. Implementation: React Router `beforeunload` listener + confirmation modal. Reuse DeleteConfirmationModal from INST-1023. Already planned in Phase 2.
        additional_tags:
          - "enhancement"
          - "frontend"
          - "navigation-guard"
          - "deferred-to-inst-1200"

    - id: 3
      finding: "Auto-save drafts during editing for proactive recovery"
      decision: "KB-logged"
      notes: "Medium impact UX enhancement. Proactive form recovery."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "ux-polish"
        content: |
          - **Finding**: Auto-save drafts during editing would provide proactive recovery
          - **Impact**: Medium | **Effort**: High (3-4 hours)
          - **Recommendation**: Proactive form recovery: Save form state to localStorage on every change (debounced 2s). Users never lose work, even without error. Enhancement over current error-triggered recovery (AC-25). Implementation: Add debounced effect on form state change. Clear on successful save. Show "Draft saved" indicator.
        additional_tags:
          - "enhancement"
          - "frontend"
          - "auto-save"
          - "form-recovery"

    - id: 4
      finding: "Keyboard shortcut discoverability hints in UI"
      decision: "KB-logged"
      notes: "Medium impact UX enhancement. Low effort."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "ux-polish"
        content: |
          - **Finding**: Keyboard shortcuts not discoverable in EditMocPage UI
          - **Impact**: Medium | **Effort**: Low (1-2 hours)
          - **Recommendation**: Story implements Cmd+Enter (save) and Escape (cancel) shortcuts (AC-28, AC-29) but doesn't show them in UI. Enhancement: Add subtle keyboard shortcut hints in button labels or tooltips. "Save (‚åò‚Üµ)" button text. Or add "Keyboard Shortcuts" help icon with modal listing all shortcuts. Aligns with Phase 8 story INST-2043 (Keyboard Shortcuts Modal).
        additional_tags:
          - "enhancement"
          - "frontend"
          - "keyboard-shortcuts"
          - "accessibility"

    - id: 5
      finding: "Rich text editor for description field"
      decision: "KB-logged"
      notes: "Medium impact enhancement. High effort. Requires schema change."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "integration"
        content: |
          - **Finding**: Rich text editor for description would support formatted content
          - **Impact**: Medium | **Effort**: High (12-16 hours, 3-4 points)
          - **Recommendation**: Current description field is plain textarea (AC-20). Enhancement: Replace with rich text editor (e.g., Tiptap, Lexical) for formatted descriptions. Users can add bold, italic, lists, links. Backend stores HTML or Markdown. Risk: Schema change (description type), XSS sanitization required, editor bundle size. Defer to post-MVP content editing features.
        additional_tags:
          - "enhancement"
          - "frontend"
          - "rich-text-editor"
          - "future-work"

    - id: 6
      finding: "Theme autocomplete with icons for better UX"
      decision: "KB-logged"
      notes: "Low impact enhancement. Medium effort."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "ux-polish"
        content: |
          - **Finding**: Theme select could use autocomplete with icons
          - **Impact**: Low | **Effort**: Medium (3-4 hours)
          - **Recommendation**: Current theme select is plain dropdown (AC-20). Enhancement: Add theme icons (üè∞ Castle, üöÄ Space, üèôÔ∏è City) and autocomplete search in select. Improve discoverability of 20+ themes. Implementation: Upgrade Select component to use Combobox pattern from shadcn/ui. Add theme icon mapping.
        additional_tags:
          - "enhancement"
          - "frontend"
          - "autocomplete"
          - "ux-polish"

    - id: 7
      finding: "Tag suggestions from existing MOCs"
      decision: "KB-logged"
      notes: "Medium impact enhancement. Medium effort."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "integration"
        content: |
          - **Finding**: Tag input could suggest tags from existing MOCs
          - **Impact**: Medium | **Effort**: Medium (4-5 hours)
          - **Recommendation**: Current tags input is free-form (AC-20). Enhancement: Autocomplete tag suggestions from user's existing tags + popular community tags. Improves tag consistency and discoverability. Implementation: Backend endpoint GET /mocs/tags?userId=X (returns user's tags + top 20 global tags). Frontend autocomplete on TagInput component.
        additional_tags:
          - "enhancement"
          - "frontend"
          - "backend"
          - "autocomplete"

    - id: 8
      finding: "Preview changes before saving"
      decision: "KB-logged"
      notes: "Medium impact enhancement. High effort."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "ux-polish"
        content: |
          - **Finding**: Preview button would let users verify changes before saving
          - **Impact**: Medium | **Effort**: High (6-8 hours, 1-2 points)
          - **Recommendation**: Enhancement: Add "Preview" button that shows read-only detail page with updated metadata before committing changes. Users can verify title/description/tags look correct in context. Implementation: New preview modal or route /mocs/:id/edit/preview. Render MocDetailPage with form values (not saved MOC data).
        additional_tags:
          - "enhancement"
          - "frontend"
          - "preview"
          - "ux-polish"

    - id: 9
      finding: "Diff view for changes before saving"
      decision: "KB-logged"
      notes: "Low impact enhancement. High effort. Power user feature."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "ux-polish"
        content: |
          - **Finding**: Diff view could show changes before saving
          - **Impact**: Low | **Effort**: High (5-6 hours)
          - **Recommendation**: Power user feature: Show side-by-side diff of original vs edited values before saving. "Title changed from 'Castle MOC' to 'Medieval Castle'". Useful for reviewing changes. Implementation: Create DiffView component, compare initialValues to current form state, highlight changed fields.
        additional_tags:
          - "enhancement"
          - "frontend"
          - "diff-view"
          - "power-user"

    - id: 10
      finding: "Bulk edit tags across multiple MOCs"
      decision: "KB-logged"
      notes: "Low impact enhancement. High effort. Deferred per Non-Goals."
      action: kb_write
      kb_entry_id: null
      kb_request:
        entry_type: finding
        source_stage: elab
        category: "integration"
        content: |
          - **Finding**: Bulk edit feature for tags across multiple MOCs
          - **Impact**: Low | **Effort**: High (10-12 hours, 2-3 points)
          - **Recommendation**: Deferred (Non-Goals line 54: "Bulk edit multiple MOCs"). Future enhancement: Select multiple MOCs in gallery, edit tags in batch. Useful for adding theme tags to 10+ MOCs at once. Implementation: Gallery multi-select + bulk PATCH endpoint.
        additional_tags:
          - "enhancement"
          - "frontend"
          - "backend"
          - "bulk-edit"
          - "future-work"

  audit_resolutions:
    - check: "Ports & Adapters"
      resolution: "Added service layer requirement as AC-1 (mocService.updateMoc method) and AC-3 (thin adapter route handler). Updated Backend Architecture section with service layer example code showing business logic in service, route as adapter."

    - check: "Risk Disclosure"
      resolution: "Added 'Risks' section after 'Constraints from Reality' with explicit documentation of concurrent edit risk (last-write-wins behavior), impact assessment, MVP mitigation strategy, and future enhancement path (optimistic locking)."

    - check: "Decision Completeness"
      resolution: "Clarified UpdateMocInputSchema definition as 'CreateMocInputSchema.partial()' in Backend Patterns section (line 291) and Phase 1 Implementation Checklist. No TBDs remain."

summary:
  acs_added: 2
  acs_renumbered: true
  ac_range_updated: "AC-1 to AC-76 (was AC-1 to AC-74)"
  kb_entries_requested: 18
  kb_entries_created: 0
  kb_status: "pending - KB writer not available in current toolset"
  audit_issues_resolved: 3
  audit_issues_flagged: 0

notes:
  - "Service layer architecture requirement added as MVP-critical AC"
  - "All non-blocking findings (8 gaps + 10 enhancements) documented for KB write"
  - "KB writes pending - agent does not have direct kb-writer access"
  - "Concurrent edit risk explicitly disclosed in new Risks section"
  - "UpdateMocInputSchema derivation clarified as .partial() of CreateMocInputSchema"
  - "Story verdict: CONDITIONAL PASS - ready for implementation with service layer fix"
