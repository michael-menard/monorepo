name: Deploy LEGO API (Serverless Framework)

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - 'packages/core/logger/**'
      - 'packages/tools/lambda-auth/**'
      - 'packages/tools/lambda-utils/**'
      - 'packages/tools/lambda-responses/**'
      - 'packages/tools/pii-sanitizer/**'
      - 'packages/tools/search/**'
      - 'packages/tools/image-processing/**'
      - 'packages/tools/file-validator/**'
      - 'packages/tools/cognito-client/**'
      - 'packages/tools/rate-limiter/**'
      - 'packages/tools/s3-client/**'
      - '.github/workflows/deploy-lego-api.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - 'packages/core/logger/**'
      - 'packages/tools/lambda-auth/**'
      - 'packages/tools/lambda-utils/**'
      - 'packages/tools/lambda-responses/**'
      - 'packages/tools/pii-sanitizer/**'
      - 'packages/tools/search/**'
      - 'packages/tools/image-processing/**'
      - 'packages/tools/file-validator/**'
      - 'packages/tools/cognito-client/**'
      - 'packages/tools/rate-limiter/**'
      - 'packages/tools/s3-client/**'
  workflow_dispatch:
    inputs:
      deploy-all:
        description: 'Deploy all functions (ignore change detection)'
        required: false
        type: boolean
        default: false
      skip-tests:
        description: 'Skip tests (use for hotfixes only)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  AWS_REGION: 'us-east-1'

jobs:
  # ========================================
  # Job 1: Detect Changes using Turbo
  # ========================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.changes.outputs.api-changed }}
      affected-endpoints: ${{ steps.changes.outputs.affected-endpoints }}
      shared-changed: ${{ steps.changes.outputs.shared-changed }}
      infra-changed: ${{ steps.changes.outputs.infra-changed }}
      should-deploy-all: ${{ steps.changes.outputs.should-deploy-all }}
      workflow-changed: ${{ steps.changes.outputs.workflow-changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for change detection

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect affected packages and endpoints
        id: changes
        run: |
          # Check if manual deploy-all was requested
          if [ "${{ github.event.inputs.deploy-all }}" == "true" ]; then
            echo "should-deploy-all=true" >> $GITHUB_OUTPUT
            echo "api-changed=true" >> $GITHUB_OUTPUT
            echo "affected-endpoints=all" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Use Turbo to detect what changed
          BASE_REF="${{ github.event.pull_request.base.sha || 'HEAD~1' }}"

          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_REF HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if the workflow file itself changed (should trigger full deploy to validate)
          WORKFLOW_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^\.github/workflows/deploy-lego-api\.yml$" | head -1 || echo "")
          if [ -n "$WORKFLOW_CHANGED" ]; then
            echo "api-changed=true" >> $GITHUB_OUTPUT
            echo "workflow-changed=true" >> $GITHUB_OUTPUT
            echo "should-deploy-all=true" >> $GITHUB_OUTPUT
            echo "affected-endpoints=all" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Workflow file changed - triggering full validation and deploy"
            exit 0
          fi

          # Check if API code changed
          API_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^apps/api/" | grep -v "__tests__" | head -1 || echo "")
          if [ -n "$API_CHANGED" ]; then
            echo "api-changed=true" >> $GITHUB_OUTPUT
          else
            echo "api-changed=false" >> $GITHUB_OUTPUT
          fi

          # Check if shared packages changed (requires full deploy)
          SHARED_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^packages/(core|tools)/" | head -1 || echo "")
          if [ -n "$SHARED_CHANGED" ]; then
            echo "shared-changed=true" >> $GITHUB_OUTPUT
            echo "should-deploy-all=true" >> $GITHUB_OUTPUT
            echo "affected-endpoints=all" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "shared-changed=false" >> $GITHUB_OUTPUT
          fi

          # Check if infrastructure changed (serverless.yml, etc)
          INFRA_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^apps/api/(serverless\.yml|package\.json)" | head -1 || echo "")
          if [ -n "$INFRA_CHANGED" ]; then
            echo "infra-changed=true" >> $GITHUB_OUTPUT
            echo "should-deploy-all=true" >> $GITHUB_OUTPUT
            echo "affected-endpoints=all" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "infra-changed=false" >> $GITHUB_OUTPUT
          fi

          # Detect specific affected endpoints
          AFFECTED_ENDPOINTS=""

          # Gallery endpoints
          if echo "$CHANGED_FILES" | grep -qE "^apps/api/endpoints/gallery/"; then
            GALLERY_FUNCTIONS=$(echo "$CHANGED_FILES" | grep -E "^apps/api/endpoints/gallery/" | sed 's|apps/api/endpoints/gallery/||' | cut -d'/' -f1 | sort -u | grep -v "^__tests__$" | grep -v "^schemas$" || echo "")
            if [ -n "$GALLERY_FUNCTIONS" ]; then
              for func in $GALLERY_FUNCTIONS; do
                case $func in
                  upload-image) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryUploadImage" ;;
                  list-images) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryListImages" ;;
                  search-images) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS gallerySearchImages" ;;
                  get-image) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryGetImage" ;;
                  update-image) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryUpdateImage" ;;
                  delete-image) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryDeleteImage" ;;
                  flag-image) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryFlagImage" ;;
                  create-album) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryCreateAlbum" ;;
                  list-albums) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryListAlbums" ;;
                  get-album) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryGetAlbum" ;;
                  update-album) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryUpdateAlbum" ;;
                  delete-album) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS galleryDeleteAlbum" ;;
                esac
              done
            fi
          fi

          # MOC Instructions endpoints
          if echo "$CHANGED_FILES" | grep -qE "^apps/api/endpoints/moc-instructions/"; then
            MOC_FUNCTIONS=$(echo "$CHANGED_FILES" | grep -E "^apps/api/endpoints/moc-instructions/" | sed 's|apps/api/endpoints/moc-instructions/||' | cut -d'/' -f1 | sort -u | grep -v "^__tests__$" | grep -v "^_shared$" || echo "")
            if [ -n "$MOC_FUNCTIONS" ]; then
              for func in $MOC_FUNCTIONS; do
                case $func in
                  list) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocList" ;;
                  initialize-with-files) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocInitializeWithFiles" ;;
                  finalize-with-files) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocFinalizeWithFiles" ;;
                  upload-file) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocUploadFile" ;;
                  download-file) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocDownloadFile" ;;
                  delete-file) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocDeleteFile" ;;
                  get-stats) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocGetStats" ;;
                  get-uploads-over-time) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocGetUploadsOverTime" ;;
                  get-gallery-images) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocGetGalleryImages" ;;
                  link-gallery-image) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocLinkGalleryImage" ;;
                  unlink-gallery-image) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocUnlinkGalleryImage" ;;
                  upload-parts-list) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS mocUploadPartsList" ;;
                esac
              done
            fi
          fi

          # Wishlist endpoints
          if echo "$CHANGED_FILES" | grep -qE "^apps/api/endpoints/wishlist/"; then
            WISHLIST_FUNCTIONS=$(echo "$CHANGED_FILES" | grep -E "^apps/api/endpoints/wishlist/" | sed 's|apps/api/endpoints/wishlist/||' | cut -d'/' -f1 | sort -u | grep -v "^__tests__$" || echo "")
            if [ -n "$WISHLIST_FUNCTIONS" ]; then
              for func in $WISHLIST_FUNCTIONS; do
                case $func in
                  list) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS wishlistList" ;;
                  create) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS wishlistCreateItem" ;;
                  get) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS wishlistGetItem" ;;
                  update) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS wishlistUpdateItem" ;;
                  delete) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS wishlistDeleteItem" ;;
                  reorder) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS wishlistReorder" ;;
                  search) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS wishlistSearch" ;;
                  upload-image) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS wishlistUploadImage" ;;
                esac
              done
            fi
          fi

          # Parts List endpoints
          if echo "$CHANGED_FILES" | grep -qE "^apps/api/endpoints/moc-parts-lists/"; then
            PARTS_FUNCTIONS=$(echo "$CHANGED_FILES" | grep -E "^apps/api/endpoints/moc-parts-lists/" | sed 's|apps/api/endpoints/moc-parts-lists/||' | cut -d'/' -f1 | sort -u | grep -v "^__tests__$" || echo "")
            if [ -n "$PARTS_FUNCTIONS" ]; then
              for func in $PARTS_FUNCTIONS; do
                case $func in
                  create) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS partsListCreate" ;;
                  get) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS partsListGet" ;;
                  update) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS partsListUpdate" ;;
                  delete) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS partsListDelete" ;;
                  parse) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS partsListParse" ;;
                  update-status) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS partsListUpdateStatus" ;;
                  get-user-summary) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS partsListGetUserSummary" ;;
                esac
              done
            fi
          fi

          # Health endpoint
          if echo "$CHANGED_FILES" | grep -qE "^apps/api/endpoints/health/"; then
            AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS healthCheck"
          fi

          # WebSocket endpoints
          if echo "$CHANGED_FILES" | grep -qE "^apps/api/endpoints/websocket/"; then
            WEBSOCKET_FUNCTIONS=$(echo "$CHANGED_FILES" | grep -E "^apps/api/endpoints/websocket/" | sed 's|apps/api/endpoints/websocket/||' | cut -d'/' -f1 | sort -u | grep -v "^__tests__$" | grep -v "^_shared$" || echo "")
            if [ -n "$WEBSOCKET_FUNCTIONS" ]; then
              for func in $WEBSOCKET_FUNCTIONS; do
                case $func in
                  connect) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS websocketConnect" ;;
                  disconnect) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS websocketDisconnect" ;;
                  default) AFFECTED_ENDPOINTS="$AFFECTED_ENDPOINTS websocketDefault" ;;
                esac
              done
            fi
          fi

          # Core/shared code changes require deploying all related functions
          if echo "$CHANGED_FILES" | grep -qE "^apps/api/core/"; then
            echo "should-deploy-all=true" >> $GITHUB_OUTPUT
            echo "affected-endpoints=all" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Trim and format affected endpoints
          AFFECTED_ENDPOINTS=$(echo "$AFFECTED_ENDPOINTS" | xargs)

          if [ -z "$AFFECTED_ENDPOINTS" ]; then
            echo "should-deploy-all=false" >> $GITHUB_OUTPUT
            echo "affected-endpoints=none" >> $GITHUB_OUTPUT
          else
            echo "should-deploy-all=false" >> $GITHUB_OUTPUT
            echo "affected-endpoints=$AFFECTED_ENDPOINTS" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## Change Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **API Changed:** ${{ steps.changes.outputs.api-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Shared Packages Changed:** ${{ steps.changes.outputs.shared-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure Changed:** ${{ steps.changes.outputs.infra-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Changed:** ${{ steps.changes.outputs.workflow-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy All:** ${{ steps.changes.outputs.should-deploy-all }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Affected Endpoints:** ${{ steps.changes.outputs.affected-endpoints }}" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Job 2: Lint and Type Check
  # ========================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API dependencies (using Turbo cache)
        run: pnpm turbo build --filter="lego-api-serverless^..."

      - name: Lint
        run: |
          cd apps/api
          pnpm lint

      - name: Type check
        run: |
          cd apps/api
          pnpm check-types

  # ========================================
  # Job 3: Run Tests
  # ========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.api-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.skip-tests != 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API dependencies (using Turbo cache)
        run: pnpm turbo build --filter="lego-api-serverless^..."

      - name: Run unit tests
        run: |
          cd apps/api
          pnpm test
        env:
          NODE_ENV: test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          directory: apps/api/coverage
          flags: api
          fail_ci_if_error: false

  # ========================================
  # Job 4: Package (Validate CloudFormation)
  # ========================================
  package:
    name: Package & Validate
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, test]
    if: |
      always() &&
      needs.detect-changes.outputs.affected-endpoints != 'none' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API dependencies (using Turbo cache)
        run: pnpm turbo build --filter="lego-api-serverless^..."

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine stage
        id: stage
        run: echo "stage=dev" >> $GITHUB_OUTPUT

      - name: Package (validate CloudFormation)
        run: |
          cd apps/api
          pnpm sls:package --stage ${{ steps.stage.outputs.stage }}

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: serverless-package-${{ steps.stage.outputs.stage }}
          path: apps/api/.serverless
          retention-days: 7

  # ========================================
  # Job 5: Deploy to Dev (on main branch push)
  # ========================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: [detect-changes, package]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.package.result == 'success' &&
      needs.detect-changes.outputs.affected-endpoints != 'none'
    environment:
      name: dev
      url: https://k05eswihw7.execute-api.us-east-1.amazonaws.com/health
    concurrency:
      group: deploy-dev
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API dependencies (using Turbo cache)
        run: pnpm turbo build --filter="lego-api-serverless^..."

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to dev
        id: deploy
        run: |
          cd apps/api
          AFFECTED="${{ needs.detect-changes.outputs.affected-endpoints }}"
          DEPLOY_ALL="${{ needs.detect-changes.outputs.should-deploy-all }}"

          echo "Affected endpoints: $AFFECTED"
          echo "Deploy all: $DEPLOY_ALL"

          if [ "$DEPLOY_ALL" == "true" ] || [ "$AFFECTED" == "all" ]; then
            echo "ðŸš€ Deploying all functions..."
            pnpm sls:deploy --stage dev 2>&1 | tee deploy-output.txt
          else
            echo "ðŸŽ¯ Deploying only changed functions: $AFFECTED"

            # First, ensure the stack is up to date with a quick deploy
            # This handles any CloudFormation changes
            pnpm sls:deploy --stage dev 2>&1 | tee deploy-output.txt

            # Then deploy individual functions for faster updates
            # (Serverless will skip unchanged functions automatically)
            for FUNC in $AFFECTED; do
              echo "ðŸ“¦ Deploying function: $FUNC"
              npx serverless deploy function --function $FUNC --stage dev || true
            done
          fi

          # Extract API URL from output
          API_URL=$(grep -oP 'https://[a-z0-9]+\.execute-api\.[a-z0-9-]+\.amazonaws\.com' deploy-output.txt | head -1 || echo "")
          echo "api-url=$API_URL" >> $GITHUB_OUTPUT

      - name: Run smoke tests
        run: |
          # Health check
          HEALTH_URL="${{ steps.deploy.outputs.api-url }}/health"
          echo "Testing health endpoint: $HEALTH_URL"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Health check failed with status $HTTP_STATUS"
            exit 1
          fi

          echo "âœ… Health check passed"

      - name: Create deployment summary
        if: always()
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** dev" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ steps.deploy.outputs.api-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Mode" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.detect-changes.outputs.should-deploy-all }}" == "true" ]; then
            echo "ðŸš€ **Full deployment** - Infrastructure or shared code changed" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŽ¯ **Targeted deployment** - Only affected functions:" >> $GITHUB_STEP_SUMMARY
            echo "\`${{ needs.detect-changes.outputs.affected-endpoints }}\`" >> $GITHUB_STEP_SUMMARY
          fi

